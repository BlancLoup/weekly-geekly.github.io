<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Precision timestamp</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="While there is a hot discussion about whether or not to be a jigsaw in java 9, and in what form it should be - you shouldn‚Äôt forget about the usefulne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Precision timestamp</h1><div class="post__text post__text-html js-mediator-article"><p>  While there is a hot discussion about whether or not to be a <strong>jigsaw</strong> in <strong>java 9,</strong> and in what form it should be - you shouldn‚Äôt forget about the usefulness that the nine carries with them - and one of them is to increase the accuracy of <strong>Clock.systemUTC ()</strong> - <a href="https://bugs.openjdk.java.net/browse/JDK-8068730">JDK-8068730</a> . </p><br><p>  What happened before? </p><br><p>  Before <strong>java 8</strong> was <strong>System.currentTimeMillis ()</strong> and <strong>System.nanoTime ()</strong> , and if the first gave <em>wall clock</em> time, but with a <strong>millisecond</strong> resolution, the second one gives time with resolution up to <strong>nanoseconds</strong> , but the scope is limited to measuring the time difference, and within one jvm - and about any use of such a timestamp between different machines and can not be. </p><br><p>  Therefore, they often cycle their <em>precise timestamps that</em> give <em>wall clock</em> time with <strong>a</strong> higher resolution than <em>currentTimeMillis</em> (using <em>jni</em> with all the consequences) - in more detail about the difference between <em>currentTimeMillis</em> and <em>nanoTime</em> , and you can read about the bike in <a href="http://dolzhenko.blogspot.com/2012/11/java-nanotime.html">my old post</a> . </p><br><p>  <strong>Java 8</strong> laid a very powerful foundation - the <strong>Java Time API</strong> .  With it you can say while <em>joda time</em> , and embed your bike in <strong>java.time.Clock</strong> , because  a regular <strong>SystemClock</strong> is essentially running on top of System.currentTimeMillis () and cannot provide resolution, better than a millisecond. </p><br><p>  And now <strong>java 9</strong> comes into play <a name="habracut"></a>  and breaking nothing (as regards time and its measurements) brings an improvement - you can throw away your jni bike, at least on <em>Linux</em> , <em>MacOSX</em> , <em>BSD</em> , <em>Solaris</em> and <em>Windows</em> - see the <a href="http://hg.openjdk.java.net/jdk9/jdk9/hotspot/rev/fca33371ff0b">openjdk commit</a> . </p><br><p>  From a practical point of view, microsecond timestamps, rather than nanosecond, make sense - the reason is that <strong>ntp</strong> within an <em>intranet</em> can give time with an accuracy of 1 ¬µs. </p><br><p>  Let's write down the provider of the exact time <strong>clock wall clock</strong> with microsecond resolution ( <a href="https://gist.github.com/vladimirdolzhenko/a46431907d31bbfda73305d876711f28">source code</a> including the native part): </p><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreciseTimestamp</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Clock clock = Clock.systemUTC(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { System.loadLibrary(<span class="hljs-string"><span class="hljs-string">"precisetimestamp"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Throwable e){ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e.getMessage(), e); } } <span class="hljs-comment"><span class="hljs-comment">// JNI microsecond timestamp provider public static native long getMicros(); // Critical JNI microsecond timestamp provider public static native long getCMicros(); public static long clockMicros(){ final Instant instant = clock.instant(); return instant.getEpochSecond() * 1_000_000L + (instant.getNano() / 1_000); } }</span></span></code> </pre> <br><p>  <strong>Java 8</strong> will give something like this. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">JNI</span></span> micros: <span class="hljs-number"><span class="hljs-number">1494398000506568</span></span> Critical JNI micros: <span class="hljs-number"><span class="hljs-number">1494398000506986</span></span> ClockUTC micros: <span class="hljs-number"><span class="hljs-number">1494398000507000</span></span> currentTimeMillis: <span class="hljs-number"><span class="hljs-number">1494398000507</span></span></code> </pre> <br><p>  No wonder - inside the good old <strong>System.currentTimeMillis ()</strong> </p><br><p>  And <strong>Java 9</strong> : </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">JNI</span></span> micros: <span class="hljs-number"><span class="hljs-number">1494398039238236</span></span> Critical JNI micros: <span class="hljs-number"><span class="hljs-number">1494398039238439</span></span> ClockUTC micros: <span class="hljs-number"><span class="hljs-number">1494398039238498</span></span> currentTimeMillis: <span class="hljs-number"><span class="hljs-number">1494398039239</span></span></code> </pre> <br><p>  <em>Added:</em> <br>  Those.  It looks like the standard <strong>SystemClock</strong> can be used as a replacement for <em>jni</em> bike - we believe that we can trust a podzelzheschogo implementation, with regard to the correctness of obtaining and monotony of increasing <strong>wall clock</strong> time, consider the granularity ( <a href="https://gist.github.com/vladimirdolzhenko/a46431907d31bbfda73305d876711f28">test for granularity and results</a> ) </p><br><pre> <code class="hljs pgsql">java <span class="hljs-number"><span class="hljs-number">9</span></span>: OS <span class="hljs-keyword"><span class="hljs-keyword">Value</span></span> Units MacOSX: <span class="hljs-number"><span class="hljs-number">1011.522</span></span> ns/op Windows: <span class="hljs-number"><span class="hljs-number">999916.218</span></span> ns/op Linux: <span class="hljs-number"><span class="hljs-number">1002.419</span></span> ns/op</code> </pre><br><p>  So  The reasonableness of the intuitive assumption about the use of microsecond accuracy is confirmed by the measurement, with the exception of <em>windows</em> , which has a known problem with the use of <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724397(v%3Dvs.85).aspx">GetSystemTimeAsFileTime</a> - the <a href="http://bugs.java.com/bugdatabase/view_bug.do%3Fbug_id%3DJDK-8180466">JDK-8180466</a> bug has been <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724397(v%3Dvs.85).aspx">reported</a> to this problem. </p><br><p>  <em>But what about performance?</em>  - the performers will shout - and they will be right - the <em>extra</em> creation of the Instant object on the face. </p><br><p>  We saw the <a href="https://gist.github.com/vladimirdolzhenko/a46431907d31bbfda73305d876711f28">benchmark</a> , which of course compares the <strong>jni-bike</strong> (both normal and critical), a <strong>clock-</strong> based method, and for estimating the scale of the disaster <strong>System.currentTimeMillis ()</strong> and <strong>System.nanoTime ()</strong> : </p><br><p><img src="https://vladimirdolzhenko.github.io/hashCodeLegend/images/rmd/PerfTiming.svg"></p><br><p>  <em>See the <a href="https://www.youtube.com/watch%3Fv%3DK6c3W6vhQOA">report on Escape Analysis and scalarization</a> , if you don‚Äôt understand why the <strong>clock.instant ()</strong> call is more expensive (though not by much) than the more complex <strong>clockMicros</strong> method:</em> </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clockMicros</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Instant instant = clock.instant(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instant.getEpochSecond() * <span class="hljs-number"><span class="hljs-number">1_000_000L</span></span> + (instant.getNano() / <span class="hljs-number"><span class="hljs-number">1_000</span></span>); }</code> </pre> <br><p>  <em>Added:</em> <br>  Make sure that the scalarization works by adding <em>-prof: gc</em> : </p><br><pre> <code class="hljs matlab">Benchmark Mode Cnt Score Error Units PerfTiming.clockMicros:¬∑gc.alloc.rate avgt <span class="hljs-number"><span class="hljs-number">5</span></span> ‚âà <span class="hljs-number"><span class="hljs-number">10</span></span>‚Åª‚Åµ MB/<span class="hljs-built_in"><span class="hljs-built_in">sec</span></span> PerfTiming.clockMicros:¬∑gc.alloc.rate.norm avgt <span class="hljs-number"><span class="hljs-number">5</span></span> ‚âà <span class="hljs-number"><span class="hljs-number">10</span></span>‚Åª‚Å∂ B/op PerfTiming.instant:¬∑gc.alloc.rate avgt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">327</span></span>,<span class="hljs-number"><span class="hljs-number">083</span></span> ¬± <span class="hljs-number"><span class="hljs-number">13</span></span>,<span class="hljs-number"><span class="hljs-number">098</span></span> MB/<span class="hljs-built_in"><span class="hljs-built_in">sec</span></span> PerfTiming.instant:¬∑gc.alloc.rate.norm avgt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span>,<span class="hljs-number"><span class="hljs-number">000</span></span> ¬± <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">001</span></span> B/op</code> </pre><br><p>  <strong>Conclusions</strong> : Using <strong>SystemClock</strong> in 9k can quite replace <em>jni</em> bike - the price is ~ 10% of the call, it‚Äôs a lot or a little - everyone decides for himself - I‚Äôm willing to sacrifice these 10% to forget the headache about the <em>jni</em> library build and not forget it. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/328334/">https://habr.com/ru/post/328334/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328324/index.html">Results of cyber activity in Q1 2017</a></li>
<li><a href="../328326/index.html">Android + Gradle + CI + CD or How to set up a cat feeder</a></li>
<li><a href="../328328/index.html">In Germany, hackers stole money from users' bank accounts using SS7 vulnerabilities</a></li>
<li><a href="../328330/index.html">Gameplay design: how it works in ‚Äúbig‚Äù games, and how to repeat it in indie terms</a></li>
<li><a href="../328332/index.html">Promotion of mobile games and applications in South Korea</a></li>
<li><a href="../328336/index.html">A caring look at IT jobs</a></li>
<li><a href="../328340/index.html">Realistic IT company strategies in crisis</a></li>
<li><a href="../328342/index.html">Researchers have learned to attack industrial robots. Thousands of them are available from the network.</a></li>
<li><a href="../328344/index.html">Startup of the day (April 2017)</a></li>
<li><a href="../328346/index.html">Bash scripts, part 10: practical examples</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>