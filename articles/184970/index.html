<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Driver for PostgreSQL on Node.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you know, the speed of any caravan is bounded above by the speed of the slowest camel. In the programming world, we now and then encounter this pri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Driver for PostgreSQL on Node.js</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/420/17f/b14/42017fb14494ee4c5414a24682c749db.jpg" alt="Quick Node.js"><br><br>  As you know, the speed of any caravan is bounded above by the speed of the slowest camel.  In the programming world, we now and then encounter this principle, developing a complex, multi-component system of interacting modules.  By optimizing our internal algorithms, we are faced with the limitations of camel drivers that provide us with an interface to third-party services: databases, message queue managers, etc. <br><br>  Unfortunately, in the node.js community, the current situation is such that the overwhelming majority of drivers for common services have a number of significant flaws that prevent applications from achieving well-deserved heights of efficiency and stability.  You have probably heard all these horrific stories about the fact that ‚Äúnode.js is flowing‚Äù, it is ‚Äútoy‚Äù, not intended for use in real high-loaded environment.  However, as we have seen from our own experience, wisely written software for the node brilliantly copes with all the ordeals of harsh combat realities.  And here we come to the main question: what interferes with the average node.js driver normal operation? <a name="habracut"></a>  A separate article can be devoted to a full-scale review of these obstacles, however, now we can single out the most typical signs of a problem product: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  sluggishness (lack of consideration of v8 features) </li><li>  incorrect processing of incoming chunks (lack of accounting for the effects of tcp segmentation) </li><li>  memory leaks (event handlers and their timely cleaning) </li><li>  lack of a faylover and other useful buns. </li></ol><br>  One of the first we needed was a driver for the PosgreSQL database.  Having experimented with the available solutions, we came to the conclusion that it would be wiser to write our own driver.  Later, faced with the need to interact more with a large number of services, we inevitably returned to the same solution. <br><br>  So, we wrote our multithreaded PosgreSQL driver on c +, which implemented the failover mechanism.  When the connection to the server breaks, we no longer think about whether requests will be lost.  Our driver stores them in RAM and resumes requests when the connection is restored. <br><br>  When designing the interface, we were guided by the principle ‚Äúnothing superfluous and only in business‚Äù. <br>  In order to execute the query, you must first initialize the connection pool.  This is done very simply using the pg.init function, to which you need to transfer the number of simultaneous connections and connection settings: <br><br><pre><code class="javascript hljs">pg.init(<span class="hljs-number"><span class="hljs-number">20</span></span>, { <span class="hljs-string"><span class="hljs-string">'user'</span></span>: <span class="hljs-string"><span class="hljs-string">'postgres'</span></span>, <span class="hljs-string"><span class="hljs-string">'dbname'</span></span>: <span class="hljs-string"><span class="hljs-string">'postgres'</span></span>, <span class="hljs-string"><span class="hljs-string">'hostaddr'</span></span>: <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>: <span class="hljs-string"><span class="hljs-string">'123'</span></span> });</code> </pre> <br>  Then you can execute a query and process the result: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = <span class="hljs-string"><span class="hljs-string">"SELECT 1 AS value"</span></span>; pg.exec(query, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">table</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Result table:'</span></span>, table); }, <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error);</code> </pre> <br>  You can also execute a pre-prepared query: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> preparedQuery = <span class="hljs-string"><span class="hljs-string">"SELECT $word1 AS word1, $word2 AS word2"</span></span>; pg.execPrepared(preparedQuery, { <span class="hljs-string"><span class="hljs-string">'word1'</span></span>: <span class="hljs-string"><span class="hljs-string">'hello'</span></span>, <span class="hljs-string"><span class="hljs-string">'word2'</span></span>: <span class="hljs-string"><span class="hljs-string">'world'</span></span> }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">table</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Result table:'</span></span>, table); }, <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error);</code> </pre> <br><br>  After all the necessary actions have been completed, you can break the connection using the driver by simply calling the pg.destroy () function; <br>  As you can see, everything is very simple and transparent.  You can, without spending a lot of time getting acquainted with the driver interface, to start developing. <br><br>  We also wrote speed comparison tests and compared our driver with one of the most popular ones, namely node-postgres.  We made requests for data packets of 1 byte and 1 KB and compared the elapsed time and memory.  The results below are presented on a semi-log scale: <br><img src="https://habrastorage.org/storage2/7b5/148/9d5/7b51489d58f0b4c33457ae2423221355.png"><br><br>  As can be seen from the graph, after 100,000 requests, the waiting time for the result is rapidly increasing.  500,000 queries have to wait more than 25 minutes!  Our driver processes such a number of requests in half a minute. <br><br>  As can be seen from the graph below, when the number of requests is 10,000 - 100,000, the difference in processing time is significant. <br><img src="https://habrastorage.org/storage2/a4d/755/956/a4d7559561cf058a4ad31dbc2fbd29a3.png"><br><br>  The situation is similar with a data packet of 1K.  The results below are presented on a semi-log scale. <br><img src="https://habrastorage.org/storage2/d81/619/f7c/d81619f7cf38f5351e8ef97c087f83b4.png"><br><br><img src="https://habrastorage.org/storage2/5bc/466/bb6/5bc466bb6eb607a5fc790bf53af51881.png"><br><br>  We also compared the memory consumption results.  As can be seen from the graphs, here our driver also wins.  Further, all graphs are presented on a semi-log scale. <br><img src="https://habrastorage.org/storage2/204/ec1/d93/204ec1d934569e621603628464001bfb.png"><br><br><img src="https://habrastorage.org/storage2/d4c/f4c/91b/d4cf4c91b0878d41f7b6d01130918756.png"><br><br>  As a result, we developed a simple, fast driver with the ability to failover. <br>  You can install it using npm by running the command in the console: <br><pre> <code class="hljs sql">npm <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> livetex-node-pg</code> </pre> <br>  and connecting it in your application: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pg = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'livetex-node-pg'</span></span>);</code> </pre> <br>  You can also create a project on github, play around, suggest your changes: <br>  <a href="https://github.com/LiveTex/Node-Pg">https://github.com/LiveTex/Node-Pg</a> <br><habracut></habracut></div><p>Source: <a href="https://habr.com/ru/post/184970/">https://habr.com/ru/post/184970/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../184960/index.html">Self build cURL for iOS and Android</a></li>
<li><a href="../184962/index.html">Travel book tester</a></li>
<li><a href="../184964/index.html">Setting up your own GIT / SVN / Mercurial server based on SCM Manager for Tomcat under Debian</a></li>
<li><a href="../184966/index.html">Home mini climate control do-it-yourself</a></li>
<li><a href="../184968/index.html">Rovnix bootkit update. Article translation</a></li>
<li><a href="../184972/index.html">Instead of passwords tattoo and ... pills</a></li>
<li><a href="../184974/index.html">Please support the symbol of domestic currency</a></li>
<li><a href="../184978/index.html">1C + offline maps on Android</a></li>
<li><a href="../184982/index.html">SamMobile presented Android 4.3 for the smartphone Galaxy S4 Google Play edition</a></li>
<li><a href="../184986/index.html">Analysis of the resources of the old quest Harvester '96</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>