<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Docker-compose: the perfect working environment</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 Recently, I have been increasingly thinking about the optimality of the workflow and would like to share my research on this issue. 


 In th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Docker-compose: the perfect working environment</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/ns/9o/xv/ns9oxvdh1wgc-_aqfjp3yj-pqji.png"></p><br><p>  Hello! <br>  Recently, I have been increasingly thinking about the optimality of the workflow and would like to share my research on this issue. </p><br><p>  In this post we will talk about <a href="https://docs.docker.com/compose/">docker-compose</a> , which in my opinion is a panacea in the organization and optimization of the developer's workflow. </p><br><p>  I will describe everything <u>almost</u> on my fingers, so if you have never heard of a docker before (which is strange), you have never worked with it and want to understand it, then I ask for the cat. </p><a name="habracut"></a><br><h2 id="predislovie">  Foreword </h2><br><p>  In the article I deliberately simplify some points, do not delve into the details and superficially touch on many issues. </p><br><p>  I do it with a full understanding of my actions, and I think that it is not necessary to climb under the hood, if everything works. </p><br><p>  Those who think otherwise is your full right, but you just don‚Äôt have to impose your point of view. <br>  Thank! </p><br><h2 id="docker">  Docker </h2><br><p>  A technology that makes it easy (in all senses) to deploy the necessary working environment. </p><br><p>  You can learn more from the links at the end of the article, but it‚Äôs better not to switch to it now, so as not to clog your brain. </p><br><h2 id="docker-compose">  Docker-compose </h2><br><p>  A package manager (similar to composer and npm, only docker has containers), which allows you to describe the necessary structure in one file (config). <br>  More details can also be found in the links at the end of the article. </p><br><h2 id="docker-hub">  Docker hub </h2><br><p>  Container repository (similar to packagist and npm). <br>  <strong>Important note</strong> : carefully read the description of the image, 70-80% of stupid questions are described there, do not waste time on google. </p><br><h2 id="ustanovka">  Installation </h2><br><p>  I will not begin to rewrite the docker documentation, so I‚Äôll just throw links: </p><br><ul><li>  <a href="https://docs.docker.com/docker-for-windows/install/">Windows</a> </li><li>  <a href="https://docs.docker.com/docker-for-mac/install/">Mac</a> </li><li>  <a href="https://docs.docker.com/engine/installation/">Other</a> </li></ul><br><p>  Installation of conventional software (software), problems should arise. <br>  If you do appear, then you can not read further, probably you stumbled upon this article and the development as a whole ... </p><br><blockquote>  If you installed a docker for Windows, then you need to work through the special <strong>Docker Quickstart Terminal</strong> console.  After installation, the corresponding shortcut should appear on the desktop. </blockquote><br><h2 id="struktura-proekta">  Project structure </h2><br><p>  To begin with, we will define the structure of projects: </p><br><ul><li>  project 1 </li><li>  project 2 </li><li>  project N <br><ul><li>  src </li><li>  container 1 </li><li>  container 2 </li><li>  container N </li><li>  docker-compose.yml </li></ul></li></ul><br><p>  Each project necessarily has a docker-compose.yml and src directory. <br>  Also for each container there must be its own directory (coinciding with the name of the container), where all the information necessary for the operation of the container (configs, data, ...) will be stored. </p><br><h2 id="cmd--terminal">  CMD / Terminal </h2><br><p>  To work with docker and compose, we will use only a few commands: </p><br><ul><li>  <strong>docker ps</strong> - view all containers ( <a href="https://docs.docker.com/compose/reference/ps/">more</a> ), </li><li>  <strong>docker-compose up</strong> - build - build the project.  The build parameter is used to force compose to re-create containers.  ( <a href="https://docs.docker.com/compose/reference/up/">more info</a> ). </li></ul><br><p>  Description of other teams can be found on the <a href="https://docs.docker.com/compose/reference/overview/">official website</a> . <br>  Let's get straight to the point. </p><br><h2 id="apache">  apache </h2><br><p>  <a href="httpd/">https://hub.docker.com/_/httpd/</a> </p><br><p>  Let's start with the most popular server - Apache. <br>  Create a project directory: </p><br><ul><li>  project <br><ul><li>  src </li><li>  docker-compose.yml </li></ul></li></ul><br><p>  The config will look like this: </p><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml</b> <div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'3'</span></span> services: apache: image: httpd:<span class="hljs-number"><span class="hljs-number">2.4</span></span> ports: - <span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> volumes: - ./src:/usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/apache2/htdocs</code> </pre> </div></div><br><p>  What's going on here: </p><br><ul><li>  <code>image: httpd:2.4</code> - we specify which image we need and its version (the list of available versions and modifications can be viewed in the corresponding docker-hub). </li><li>  <code>ports: 80:80</code> - we forward ports between the docker and our machine, i.e.  all requests that will go to port 80 of our machine will be transmitted to port 80 docker. </li><li>  <code>volumes: ./src:/usr/local/apache2/htdocs</code> - link the directory on our machine, from the working directory apache, i.e.  All files in the src directory will be accessible to apache, as if they were in the htdocs directory (the opposite also works, everything that is created in the docker is "copied" to the local machine). </li></ul><br><p>  Create a file <strong>src / index.html</strong> in the working directory with the contents: </p><br><pre> <code class="hljs scala"><span class="hljs-type"><span class="hljs-type">Hi</span></span>, <span class="hljs-type"><span class="hljs-type">I</span></span><span class="hljs-symbol"><span class="hljs-symbol">'am</span></span> <span class="hljs-type"><span class="hljs-type">Apache</span></span></code> </pre> <br><p>  We start our project: </p><br><pre> <code class="bash hljs">docker-compose up --build</code> </pre> <br><p>  Go to the browser at the PC address and watch our server greeting. <br>  To destroy the containers of our project, it is enough to execute Ctrl + C in the console. </p><br><blockquote>  If the docker is working through VirtualBox, then you need to go through the virtualka IP.  In any case, if you work through Docker Quickstart Terminal, the address will be displayed when the console starts. </blockquote><br><h3 id="rabota-v-fonovom-rezhime">  Work in the background </h3><br><p>  If you need to run docker and continue working in the console, then you can run the project in background mode: </p><br><pre> <code class="bash hljs">docker-compose up --build -d</code> </pre> <br><p>  After launch, the console will be available for operation. <br>  In this situation, to destroy the container, you need to stop and delete it, but first, you need to know its ID: </p><br><pre> <code class="bash hljs">docker ps</code> </pre> <br><p>  In my case, I got the following conclusion: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">CONTAINER</span></span> ID IMAGE ... 988e27da7bdf httpd:<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">4</span></span> ...</code> </pre> <br><p>  Now stop and delete our container: </p><br><pre> <code class="bash hljs">docker stop 988e27da7bdf docker rm 988e27da7bdf</code> </pre> <br><p>  Or you can do roughly and immediately delete: </p><br><pre> <code class="bash hljs">docker rm -f 988e27da7bdf</code> </pre> <br><h2 id="nginx">  nginx </h2><br><p>  <a href="https://hub.docker.com/_/nginx/">https://hub.docker.com/_/nginx/</a> </p><br><p>  The nginx config is built using the same scheme as apache: image, ports, working directory.  The file looks like this: </p><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'3'</span></span> services: nginx: image: nginx:<span class="hljs-number"><span class="hljs-number">1.13</span></span> ports: - <span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> volumes: - ./src:/usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nginx/html</code> </pre> </div></div><br><p>  Create the <strong>src / index.html</strong> file in the working directory with the contents: </p><br><pre> <code class="hljs scala"><span class="hljs-type"><span class="hljs-type">Hi</span></span>, <span class="hljs-type"><span class="hljs-type">I</span></span><span class="hljs-symbol"><span class="hljs-symbol">'am</span></span> <span class="hljs-type"><span class="hljs-type">Nginx</span></span></code> </pre> <br><p>  Go to the browser, and see the greeting of the next server. </p><br><h2 id="php--apache">  php + apache </h2><br><p>  <a href="https://hub.docker.com/_/php/">https://hub.docker.com/_/php/</a> </p><br><p>  If we talk about a bunch of PHP and Apache, then we already have a ready image for it, so we‚Äôll talk about linking containers later.  And now just a config: </p><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs cs">version: <span class="hljs-string"><span class="hljs-string">'3'</span></span> services: web: image: php:<span class="hljs-number"><span class="hljs-number">7.2</span></span>-apache ports: - <span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> volumes: - ./src:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/html</code> </pre> </div></div><br><p>  Create the <strong>src / index.php</strong> file in the working directory with the contents: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> phpinfo();</code> </pre> <br><p>  We check its work in the browser. </p><br><h2 id="php--nginx">  php + nginx </h2><br><p>  <a href="https://hub.docker.com/_/nginx/">https://hub.docker.com/_/nginx/</a> <br>  <a href="https://hub.docker.com/_/php/">https://hub.docker.com/_/php/</a> </p><br><p>  In this combination, php will be in fpm format.  Schematically, it looks like this: </p><br><p><img src="https://habrastorage.org/webt/hk/n4/k3/hkn4k3r4xtptstmfhffeze_xus8.png"></p><br><p>  Accordingly, we will need to rewrite the server config. <br>  To do this, in addition to the working directory, the server configuration file will also need to be linked: </p><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'3'</span></span> services: nginx: image: nginx:<span class="hljs-number"><span class="hljs-number">1.13</span></span> ports: - <span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> volumes: - ./src:/usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nginx/html - ./nginx/nginx.conf:/etc/nginx/nginx.conf depends_on: - php php: image: php:<span class="hljs-number"><span class="hljs-number">7.2</span></span>-fpm volumes: - ./src:/usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nginx/html</code> </pre> </div></div><br><p>  What changed: </p><br><ul><li>  <code>volumes: ./nginx/nginx.conf:/etc/nginx/nginx.conf</code> - link the nginx config file; </li><li>  <code>depends_on: php</code> - we specify nginx dependence on php, i.e.  in fact, this is a guarantee that the php container will start before nginx. </li></ul><br><p>  If we do not specify <strong>depends_on</strong> , then we can catch a similar error: </p><br><pre> <code class="hljs pgsql">nginx_1 | <span class="hljs-number"><span class="hljs-number">2018</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span> [emerg] <span class="hljs-number"><span class="hljs-number">1</span></span>#<span class="hljs-number"><span class="hljs-number">1</span></span>: host <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> upstream "php" <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /etc/nginx/nginx.conf:<span class="hljs-number"><span class="hljs-number">23</span></span> nginx_1 | nginx: [emerg] host <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> upstream "php" <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /etc/nginx/nginx.conf:<span class="hljs-number"><span class="hljs-number">23</span></span></code> </pre> <br><p>  Create the file /nginx/nginx.conf in the directory of our project.  The config itself looks like this: </p><br><div class="spoiler">  <b class="spoiler_title">nginx.conf</b> <div class="spoiler_text"><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">1024</span></span>; } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> mime.types; <span class="hljs-attribute"><span class="hljs-attribute">default_type</span></span> application/octet-stream; <span class="hljs-attribute"><span class="hljs-attribute">sendfile</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">keepalive_timeout</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span>; <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /usr/share/nginx/html; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> localhost; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">index</span></span> index.html index.htm; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ \.php$</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_pass</span></span> php:<span class="hljs-number"><span class="hljs-number">9000</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_index</span></span> index.php; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> fastcgi_params; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> SCRIPT_FILENAME <span class="hljs-variable"><span class="hljs-variable">$document_root</span></span><span class="hljs-variable"><span class="hljs-variable">$fastcgi_script_name</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> PATH_INFO <span class="hljs-variable"><span class="hljs-variable">$fastcgi_path_info</span></span>; } } }</code> </pre> </div></div><br><p>  Everything is standard, as long as the <strong>root</strong> directive matches docker-compose.yml. <br>  Looking at the config, I ask you to pay attention to the <strong>fastcgi_pass</strong> directive, namely the <code>php:9000</code> value <code>php:9000</code> . <br>  Usually, when a local server is configured, <code>localhost:9000</code> specified, BUT, because  php is located in another container, then we need to apply to it (docker itself "substitutes" the desired IP container, in fact, all the magic is hidden in the simple addition of the hosts file). <br>  To make this possible, we need to add the directive to our docker-compose (although in fact it is not necessary, <a href="https://docs.docker.com/compose/compose-file/">more</a> ). </p><br><p>  After all the actions, the directory of our project looks like this: </p><br><ul><li>  project <br><ul><li>  src <br><ul><li>  index.php </li></ul></li><li>  nginx <br><ul><li>  nginx.conf </li></ul></li><li>  docker-compose.yml </li></ul></li></ul><br><p>  We start, check, rejoice! </p><br><h2 id="php--apache--nginx">  php + apache + nginx </h2><br><p>  <a href="https://hub.docker.com/_/nginx/">https://hub.docker.com/_/nginx/</a> <br>  <a href="https://hub.docker.com/_/php/">https://hub.docker.com/_/php/</a> <br>  <a href="httpd/">https://hub.docker.com/_/httpd/</a> </p><br><p>  Probably the most popular bundle for web projects.  Schematically it looks like this: </p><br><p><img src="https://habrastorage.org/webt/oe/fb/_u/oefb_uipueudcz2vpedrkdva2eg.png"></p><br><p>  A couple of comments: </p><br><ul><li>  <strong>php is</strong> used as php-fpm because it is faster and more fashionable; </li><li>  <strong>apache is</strong> used because htaccess is also popular. </li></ul><br><p>  In order to configure everything, we will also need to link the apache config, and thus docker-compose will look like this: </p><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs javascript">version: <span class="hljs-string"><span class="hljs-string">'3'</span></span> services: apache: image: httpd:<span class="hljs-number"><span class="hljs-number">2.4</span></span> volumes: - ./src:<span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>www/html - ./httpd/httpd.conf:<span class="hljs-regexp"><span class="hljs-regexp">/usr/</span></span>local/apache2/conf/httpd.conf depends_on: - php nginx: image: nginx:<span class="hljs-number"><span class="hljs-number">1.13</span></span> ports: - <span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> volumes: - ./src:<span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>www/html - ./nginx/nginx.conf:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/nginx.conf depends_on: - apache php: image: php:<span class="hljs-number"><span class="hljs-number">7.2</span></span>-fpm volumes: - ./src:<span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>www/html</code> </pre> </div></div><br><p>  Since I didn‚Äôt find a normal config on the Internet (I didn‚Äôt just search for OC), and I‚Äôm having a docker at hand, it was decided to pull it out of the standard container. <br>  It all fit into 3 teams: </p><br><pre> <code class="bash hljs">docker run -d httpd:2.4 docker ps docker cp [ID ]:/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/apache2/conf/httpd.conf ./httpd.conf</code> </pre> <br><p>  After executing these commands, the httpd.conf file will appear in the current directory, which we will use as the basis. <br>  In essence, this is a simple copy from a running container. <br>  Create the file <strong>/httpd/httpd.conf</strong> in the working directory, which after editing looks like this: </p><br><div class="spoiler">  <b class="spoiler_title">httpd.conf</b> <div class="spoiler_text"><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">ServerRoot</span></span></span></span> <span class="hljs-string"><span class="hljs-string">"/usr/local/apache2"</span></span> Listen 80 LoadModule authn_file_module modules/mod_authn_file.so LoadModule authn_core_module modules/mod_authn_core.so LoadModule authz_host_module modules/mod_authz_host.so LoadModule authz_groupfile_module modules/mod_authz_groupfile.so LoadModule authz_user_module modules/mod_authz_user.so LoadModule authz_core_module modules/mod_authz_core.so LoadModule access_compat_module modules/mod_access_compat.so LoadModule auth_basic_module modules/mod_auth_basic.so LoadModule reqtimeout_module modules/mod_reqtimeout.so LoadModule filter_module modules/mod_filter.so LoadModule mime_module modules/mod_mime.so LoadModule log_config_module modules/mod_log_config.so LoadModule env_module modules/mod_env.so LoadModule headers_module modules/mod_headers.so LoadModule setenvif_module modules/mod_setenvif.so LoadModule version_module modules/mod_version.so LoadModule unixd_module modules/mod_unixd.so LoadModule status_module modules/mod_status.so LoadModule autoindex_module modules/mod_autoindex.so LoadModule dir_module modules/mod_dir.so LoadModule alias_module modules/mod_alias.so # additional LoadModule proxy_module modules/mod_proxy.so LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so ServerAdmin you@example.com &lt;Directory /&gt; AllowOverride none Require <span class="hljs-literal"><span class="hljs-literal">all</span></span> denied &lt;/Directory&gt; DocumentRoot <span class="hljs-string"><span class="hljs-string">"/var/www/html"</span></span> &lt;Directory <span class="hljs-string"><span class="hljs-string">"/var/www/html"</span></span>&gt; Options Indexes FollowSymLinks Includes ExecCGI AllowOverride <span class="hljs-literal"><span class="hljs-literal">All</span></span> Require <span class="hljs-literal"><span class="hljs-literal">all</span></span> granted &lt;/Directory&gt; &lt;IfModule unixd_module&gt; User daemon Group daemon &lt;/IfModule&gt; &lt;IfModule dir_module&gt; DirectoryIndex index.php index.pl index.cgi index.asp index.shtml index.html index.htm \ default.php default.pl default.cgi default.asp default.shtml default.html default.htm \ home.php home.pl home.cgi home.asp home.shtml home.html home.htm &lt;/IfModule&gt; &lt;Files <span class="hljs-string"><span class="hljs-string">".ht*"</span></span>&gt; Require <span class="hljs-literal"><span class="hljs-literal">all</span></span> denied &lt;/Files&gt; &lt;IfModule log_config_module&gt; LogFormat <span class="hljs-string"><span class="hljs-string">"%h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\""</span></span> combined LogFormat <span class="hljs-string"><span class="hljs-string">"%h %l %u %t \"%r\" %&gt;s %b"</span></span> common &lt;IfModule logio_module&gt; LogFormat <span class="hljs-string"><span class="hljs-string">"%h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O"</span></span> combinedio &lt;/IfModule&gt; &lt;/IfModule&gt; &lt;IfModule alias_module&gt; ScriptAlias /cgi-bin/ <span class="hljs-string"><span class="hljs-string">"/usr/local/apache2/cgi-bin/"</span></span> &lt;/IfModule&gt; &lt;Directory <span class="hljs-string"><span class="hljs-string">"/usr/local/apache2/cgi-bin"</span></span>&gt; AllowOverride <span class="hljs-literal"><span class="hljs-literal">All</span></span> Options None Require <span class="hljs-literal"><span class="hljs-literal">all</span></span> granted &lt;/Directory&gt; &lt;IfModule headers_module&gt; RequestHeader unset Proxy early &lt;/IfModule&gt; &lt;IfModule mime_module&gt; TypesConfig conf/mime.types AddType application/x-compress .Z AddType application/x-gzip .gz .tgz AddType text/html .shtml AddHandler cgi-script .cgi .pl .asp AddOutputFilter INCLUDES .shtml &lt;/IfModule&gt; # #  FPM # &lt;IfModule proxy_module&gt; &lt;FilesMatch <span class="hljs-string"><span class="hljs-string">"\.php$"</span></span>&gt; SetHandler <span class="hljs-string"><span class="hljs-string">"proxy:fcgi://php:9000"</span></span> &lt;/FilesMatch&gt; &lt;/IfModule&gt;</code> </pre> </div></div><br><p>  Create the file <strong>/nginx/nginx.conf</strong> in the working directory with the following contents: </p><br><div class="spoiler">  <b class="spoiler_title">nginx.conf</b> <div class="spoiler_text"><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">1024</span></span>; } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> mime.types; <span class="hljs-attribute"><span class="hljs-attribute">default_type</span></span> application/octet-stream; <span class="hljs-attribute"><span class="hljs-attribute">sendfile</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">keepalive_timeout</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span>; <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> localhost; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ \.(jpg|jpeg|gif|png|ico|css|zip|tgz|gz|rar|bz2|doc|xls|exe|pdf|ppt|txt|tar|mid|midi|wav|bmp|rtf|js)$</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/www/html; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ /\.ht</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://apache; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_connect_timeout</span></span> <span class="hljs-number"><span class="hljs-number">120</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_send_timeout</span></span> <span class="hljs-number"><span class="hljs-number">120</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_read_timeout</span></span> <span class="hljs-number"><span class="hljs-number">180</span></span>; } } }</code> </pre> </div></div><br><p>  In the <code>proxy_pass http://apache</code> we again indicate not the IP address, but the name of the container (recall the magic with the hosts). </p><br><p>  For testing, we will need to check if PHP is working and Apache is working. <br>  Let's form the following project structure: </p><br><ul><li>  nginx <br><ul><li>  nginx.conf </li></ul></li><li>  httpd <br><ul><li>  httpd.conf </li></ul></li><li>  src <br><ul><li>  protected <br><ul><li>  .htaccess </li><li>  index.html </li></ul></li><li>  index.php </li></ul></li><li>  docker-compose.yml </li></ul><br><p>  Content <strong>.htaccess</strong> : </p><br><pre> <code class="hljs pgsql">Deny <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span></code> </pre> <br><p>  Content <strong>index.php</strong> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> phpinfo();</code> </pre> <br><p>  Content <strong>index.html</strong> : </p><br><pre> <code class="html hljs xml">Apache not working :-(</code> </pre> <br><p>  If everything is set up correctly, the picture should be as follows: </p><br><ul><li>  <strong>/index.php</strong> - will open php information </li><li>  <strong>/protected/index.html</strong> - 403 apache error will open </li><li>  <strong>/protected/.htaccess</strong> - a 403 nginx error will open (visually they differ) </li></ul><br><h2 id="mariadb--phpmyadmin">  mariadb + phpmyadmin </h2><br><p>  <a href="https://hub.docker.com/_/mariadb/">https://hub.docker.com/_/mariadb/</a> <br>  <a href="https://hub.docker.com/r/phpmyadmin/phpmyadmin/">https://hub.docker.com/r/phpmyadmin/phpmyadmin/</a> </p><br><p>  Let's talk about the database. <br>  The config to connect is as follows: </p><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'3'</span></span> services: mariadb: image: mariadb:<span class="hljs-number"><span class="hljs-number">10.3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> volumes: - ./mariadb:/var/lib/mysql environment: MYSQL_ROOT_PASSWORD: qwerty phpmyadmin: image: phpmyadmin/phpmyadmin links: - mariadb:db ports: - <span class="hljs-number"><span class="hljs-number">8765</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> environment: MYSQL_ROOT_PASSWORD: qwerty depends_on: - mariadb</code> </pre> </div></div><br><p>  For mariadb and phpmyadmin, we specified an <strong>environment</strong> directive that contains container-specific variables (details can be found in the repositories of the containers themselves). <br>  In this case, this is the password for the root user. </p><br><p>  For phpmyadmin, we manually set the links directive: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">links</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mariadb</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:db</span></span></code> </pre> <br><p>  This is necessary so that phpmyadmin knows which database to connect to. <br>  If the mariadb container was called db, then this directory would not be necessary. </p><br><p>  For mariadb, we link the data directory: </p><br><pre> <code class="hljs swift">volumes: - ./mariadb:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/mysql</code> </pre> <br><p>  This is done to ensure that the data is stored in the directory of our project, and not inside the container. </p><br><blockquote>  If you are not working on a linux machine, then you will have problems locating the database data on the local machine. <br>  These insuperable circumstances, unfortunately, at the moment is not overcome. <br>  Who has a solution, please share. <br>  However, by default (even after the container is destroyed), the database data is saved and you can recreate the container as many times as you want - the data will be stored in the depths of the local machine. </blockquote><br><h2 id="php--apache--nginx--mariadb--phpmyadmin">  php + apache + nginx + mariadb + phpmyadmin </h2><br><p>  <a href="https://hub.docker.com/_/nginx/">https://hub.docker.com/_/nginx/</a> <br>  <a href="https://hub.docker.com/_/php/">https://hub.docker.com/_/php/</a> <br>  <a href="httpd/">https://hub.docker.com/_/httpd/</a> <br>  <a href="https://hub.docker.com/_/mariadb/">https://hub.docker.com/_/mariadb/</a> <br>  <a href="https://hub.docker.com/r/phpmyadmin/phpmyadmin/">https://hub.docker.com/r/phpmyadmin/phpmyadmin/</a> </p><br><p>  Well, now we combine our configs, and get a good web environment: </p><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs javascript">version: <span class="hljs-string"><span class="hljs-string">'3'</span></span> services: apache: image: httpd:<span class="hljs-number"><span class="hljs-number">2.4</span></span> volumes: - ./src:<span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>www/html - ./httpd/httpd.conf:<span class="hljs-regexp"><span class="hljs-regexp">/usr/</span></span>local/apache2/conf/httpd.conf depends_on: - php nginx: image: nginx:<span class="hljs-number"><span class="hljs-number">1.13</span></span> ports: - <span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> volumes: - ./src:<span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>www/html - ./nginx/nginx.conf:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/nginx.conf depends_on: - apache php: build: ./php volumes: - ./src:<span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>www/html - ./php/php.ini:<span class="hljs-regexp"><span class="hljs-regexp">/usr/</span></span>local/etc/php/php.ini depends_on: - mariadb mariadb: image: mariadb:<span class="hljs-number"><span class="hljs-number">10.3</span></span> volumes: - ./mariadb:<span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>lib/mysql environment: MYSQL_ROOT_PASSWORD: qwerty phpmyadmin: image: phpmyadmin/phpmyadmin links: - mariadb:db ports: - <span class="hljs-number"><span class="hljs-number">8765</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> environment: MYSQL_ROOT_PASSWORD: qwerty depends_on: - mariadb</code> </pre> </div></div><br><p>  For php, we added a <strong>build</strong> directive ( <a href="https://docs.docker.com/compose/compose-file/">more</a> info), in which we specified the php directory where the Dockerfile is stored with the following content: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> php:<span class="hljs-number"><span class="hljs-number">7.2</span></span>-apache RUN apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> RUN docker-php-ext-install pdo pdo_mysql mysqli</code> </pre> <br><p>  In this file, we update the repositories and install php modules ( <a href="https://github.com/docker-library/docs/tree/master/php">more about docker-php-ext-install</a> ). <br>  We also linked the php config so that we can configure it in the way we want. <br>  The contents of php.ini can be taken, for example, <a href="https://gist.github.com/irpsv/020acdbd992359c505f075d2512d8271">here</a> . </p><br><p>  We start, check, rejoice! <br>  If everything is done correctly, then <strong>index.php will</strong> work without errors, and the base files will appear in the <strong>project / mysql</strong> directory. </p><br><h2 id="docker-production">  Docker production </h2><br><p>  Regarding this issue, unfortunately I can not say anything, but <a href="https://docs.docker.com/compose/production/">official documentation</a> can say. <br>  If you have experience using docker on combat projects, then please share your experience in the comments: is it worth it, what difficulties and pitfalls do you have and other useful information for the young and inexperienced. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  That's all that I wanted to share. <br>  As you can see, it is not necessary to know how docker works in order to work successfully with it. <br>  Yes, of course, for fine tuning or complex tasks, it is necessary to delve into the wilds of the docker, but in the average statistical case this is not necessary. <br>  If you have something to add, or you noticed some kind of a jamb, or you disagree with something, then I ask you in the comment, we will discuss ;-) </p><br><h2 id="poleznye-ssylki-aka-spisok-ispolzuemoy-literatury">  Useful links (aka list of used literature) </h2><br><p>  <a href="https://docs.docker.com/">Official website documentation</a> <br>  <a href="https://docs.docker.com/compose/overview/">Overview of Docker Compose (official site)</a> <br>  <a href="https://habrahabr.ru/post/310460/">The Complete Docker Practical Guide: From Scratch to AWS Cluster</a> <br>  <a href="https://habrahabr.ru/post/277699/">Understanding Docker</a> <br>  <a href="https://habrahabr.ru/post/322440/">Full automation of the ‚Äúdevelopment‚Äù environment using docker-compose</a> </p><br><h2 id="ps">  PS </h2><br><p>  To be honest, I do not understand where so much negativity comes from. <br>  Judging by the comments, the main complaints about the wording and terminology, and this in view of the fact that in the preface I wrote that I intentionally simplify many points. <br>  The purpose of this article is to show how easy it is to work with docker-compose, how instead of deploying 100,500 environments and software for each of your projects, you can use docker-compose and be content. <br>  There is no talk about prodUction (one paragraph is enough), about deploy, about migration between dev and prod environment. <br>  No, the article is not about that. </p><br><h2 id="pps">  Pps </h2><br><p>  Many thanks to <a href="https://habrahabr.ru/users/krocos/" class="user_link">krocos</a> <a href="https://habrahabr.ru/users/caravus/" class="user_link">Caravus</a> <a href="https://habrahabr.ru/users/vershnik/" class="user_link">Vershnik</a> <a href="https://habrahabr.ru/users/fesor/" class="user_link">Fesor</a> for the efficient comments. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/346086/">https://habr.com/ru/post/346086/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346070/index.html">Who "leaves the clouds": Western IT startups who abandoned the virtual infrastructure</a></li>
<li><a href="../346072/index.html">DPC without GeForce and Titan: NVIDIA changed license agreement</a></li>
<li><a href="../346074/index.html">Technical details. Meltdown Vulnerability - CVE-2017-5754</a></li>
<li><a href="../346078/index.html">How exactly does Meltdown work?</a></li>
<li><a href="../346080/index.html">Alan Kay: How are things for all mankind, the view "from space"</a></li>
<li><a href="../346090/index.html">11 libraries (sets of components) for React, which are worth knowing in 2018</a></li>
<li><a href="../346098/index.html">Compile a DNS query manually</a></li>
<li><a href="../346102/index.html">Fresh utilities, plugins and productivity tools for the designer. Issue number 4</a></li>
<li><a href="../346106/index.html">Release Rust 1.23</a></li>
<li><a href="../346108/index.html">Weapon system through components in Unreal Engine 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>