<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OpenVZ, Quagga and LiveMigration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all! 
 I want to share a convenient way to use OpenVZ containers. This object is very light, you can raise an instance for each sneeze. 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OpenVZ, Quagga and LiveMigration</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/files/f9a/468/741/f9a4687416694e20a45c923a22d5a0fc.png">  Good day to all! <br>  I want to share a convenient way to use OpenVZ containers.  This object is very light, you can raise an instance for each sneeze. <br>  By default, the container uses the ‚Äúvenet‚Äù network interface.  For the administrator, it looks like it's easy to assign an address to a container, and this is convenient.  But in order for the container to be accessible from the network, you should use addresses from the same IP network to which the physical server (HN) is connected.  The server knows the list of containers running on it and responds with its MAC to ARP requests with the addresses of containers.  But you always want more convenience in the work, and dynamic routing will help us in this. <br>  How exactly we look at examples using Quagga and OSPF. <br><a name="habracut"></a><br>  In order for such a scheme to work, the Dynamic Routing Protocol (OSPF) must already work on the network.  However, if you have many networks connected by more than one router, then, most likely, you have already configured dynamic routing. <br><div class="spoiler">  <b class="spoiler_title">First, you need to install on the Quagga server:</b> <div class="spoiler_text">  everything is simple, Quagga is included in the standard delivery of almost all distributions, <br>  hereafter, the commands for debian based: <br><pre><code class="vhdl hljs">#sudo apt-get install quagga</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">second, make the minimum setting and run:</b> <div class="spoiler_text">  In the / etc / quagga / daemons file, correct the lines (from <i>"no"</i> to <i>"yes"</i> ): <br><pre> <code class="vala hljs">zebra=yes ospfd=yes</code> </pre><br>  create file /etc/quagga/zebra.conf <br><pre> <code class="vhdl hljs">ip forwarding <span class="hljs-literal"><span class="hljs-literal">line</span></span> vty</code> </pre><br>  create file /etc/quagga/ospfd.conf <br><pre> <code class="vhdl hljs">router ospf redistribute kernel network <span class="hljs-number"><span class="hljs-number">0.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> area <span class="hljs-number"><span class="hljs-number">0.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-literal"><span class="hljs-literal">line</span></span> vty</code> </pre><br>  restart: <br><pre> <code class="vhdl hljs">#sudo service quagga restart</code> </pre><br></div></div><br>  With these settings, HN will search for routers on all interfaces and tell them about all its running containers. <br><div class="spoiler">  <b class="spoiler_title">check, Quagga has connected to the network and the information about containers is distributed:</b> <div class="spoiler_text"><pre> <code class="vhdl hljs"># vtysh -e <span class="hljs-string"><span class="hljs-string">"show ip ospf nei"</span></span> Neighbor ID Pri State Dead <span class="hljs-built_in"><span class="hljs-built_in">Time</span></span> Address Interface RXmtL RqstL DBsmL <span class="hljs-number"><span class="hljs-number">198.51</span></span>.<span class="hljs-number"><span class="hljs-number">100.11</span></span> <span class="hljs-number"><span class="hljs-number">128</span></span> Full/DR <span class="hljs-number"><span class="hljs-number">2.548</span></span>s <span class="hljs-number"><span class="hljs-number">192.0</span></span>.<span class="hljs-number"><span class="hljs-number">2.25</span></span> vmbr0:<span class="hljs-number"><span class="hljs-number">192.0</span></span>.<span class="hljs-number"><span class="hljs-number">2.26</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">192.0</span></span>.<span class="hljs-number"><span class="hljs-number">2.27</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>-Way/DROther <span class="hljs-number"><span class="hljs-number">2.761</span></span>s <span class="hljs-number"><span class="hljs-number">192.0</span></span>.<span class="hljs-number"><span class="hljs-number">2.27</span></span> vmbr0:<span class="hljs-number"><span class="hljs-number">192.0</span></span>.<span class="hljs-number"><span class="hljs-number">2.26</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">192.0</span></span>.<span class="hljs-number"><span class="hljs-number">2.28</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> Full/Backup <span class="hljs-number"><span class="hljs-number">2.761</span></span>s <span class="hljs-number"><span class="hljs-number">192.0</span></span>.<span class="hljs-number"><span class="hljs-number">2.28</span></span> vmbr0:<span class="hljs-number"><span class="hljs-number">192.0</span></span>.<span class="hljs-number"><span class="hljs-number">2.26</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  if the list is not empty, then the session routers are found. <br>  Check that container information is distributed by quagga: <br><pre> <code class="vhdl hljs"># vzlist CTID NPROC STATUS IP_ADDR HOSTNAME <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">38</span></span> running - radius.local <span class="hljs-number"><span class="hljs-number">101</span></span> <span class="hljs-number"><span class="hljs-number">26</span></span> running <span class="hljs-number"><span class="hljs-number">198.51</span></span>.<span class="hljs-number"><span class="hljs-number">100.2</span></span> dns.local <span class="hljs-number"><span class="hljs-number">104</span></span> <span class="hljs-number"><span class="hljs-number">47</span></span> running <span class="hljs-number"><span class="hljs-number">203.0</span></span>.<span class="hljs-number"><span class="hljs-number">113.4</span></span> cacti.local <span class="hljs-number"><span class="hljs-number">105</span></span> <span class="hljs-number"><span class="hljs-number">56</span></span> running <span class="hljs-number"><span class="hljs-number">203.0</span></span>.<span class="hljs-number"><span class="hljs-number">113.5</span></span> host3.local <span class="hljs-number"><span class="hljs-number">152</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> running <span class="hljs-number"><span class="hljs-number">203.0</span></span>.<span class="hljs-number"><span class="hljs-number">113.52</span></span> host4.local <span class="hljs-number"><span class="hljs-number">249</span></span> <span class="hljs-number"><span class="hljs-number">96</span></span> running <span class="hljs-number"><span class="hljs-number">203.0</span></span>.<span class="hljs-number"><span class="hljs-number">113.149</span></span> zabbix.local # vtysh -e <span class="hljs-string"><span class="hljs-string">"show ip ospf database external self-originate"</span></span> | fgrep Link\ State\ ID Link State ID: <span class="hljs-number"><span class="hljs-number">198.51</span></span>.<span class="hljs-number"><span class="hljs-number">100.2</span></span> (External Network Number) Link State ID: <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">98.4</span></span> (External Network Number) Link State ID: <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">98.5</span></span> (External Network Number) Link State ID: <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">98.52</span></span> (External Network Number) Link State ID: <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">98.149</span></span> (External Network Number)</code> </pre><br>  we get two lists with IP addresses that should match. <br></div></div><br>  So you can create a container with any address, and it will be accessible from everywhere. <br><div class="spoiler">  <b class="spoiler_title">Now let's add some Quagga configuration:</b> <div class="spoiler_text">  Thanks to these lines, the information will be updated faster, but you also need to configure the interfaces on the router accordingly. <br>  file <i>/etc/quagga/ospfd.conf:</i> <br><pre> <code class="vhdl hljs">... interface vmbr0 ip ospf hello-interval <span class="hljs-number"><span class="hljs-number">1</span></span> ip ospf dead-interval <span class="hljs-number"><span class="hljs-number">3</span></span> ...</code> </pre><br>  Information about containers with addresses from the network in which the server is located will not be distributed.  Indeed, about this network, and so everyone knows, why clog the routing table with unnecessary entries. <br>  file <i>/etc/quagga/ospfd.conf:</i> <br><pre> <code class="vhdl hljs">... ip prefix-list ifvmbr0 seq <span class="hljs-number"><span class="hljs-number">100</span></span> permit <span class="hljs-number"><span class="hljs-number">192.0</span></span>.<span class="hljs-number"><span class="hljs-number">2.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> le <span class="hljs-number"><span class="hljs-number">32</span></span> router ospf redistribute kernel route-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span> openvz route-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span> openvz deny <span class="hljs-number"><span class="hljs-number">100</span></span> match ip address prefix-list ifvmbr0 route-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span> openvz permit <span class="hljs-number"><span class="hljs-number">200</span></span> ...</code> </pre><br></div></div><br><br>  What other bonuses can be obtained thanks to this scheme, except for the fact of using any addresses: <br><br><ol><li>  Live Migration, you can transfer containers between servers on different networks and at different sites without downtime and disconnection. </li><li>  You can implement a hot spare when a ‚Äúspare‚Äù container with the same address is on a different server and is announced with a larger metric. </li><li>  Anycast, similar to the previous paragraph, containers on different servers at different points of presence, containers have the same addresses that are advertised with metric-type 1. Then the traffic will go to the ‚Äúnearest‚Äù address (DHCP / RADIUS / IPTV / Proxy, etc.) </li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      PS <br><ul><li>  It also works great with Proxmox, only if you are building a cluster on the tunnels, then the tunnel interfaces must be removed from OSPF or metrics should be raised, and then there is a risk that user traffic will run through the tunnels. <br></li><li>  It may be asked what is new here, Quagga has been installed on servers for a long time, but the advantage is that the daemon does not need to be installed inside each container, but only on a host machine that many dozens of containers can work on. </li><li>  I do not recommend using OSPF NSSA area for these purposes, there are subtleties in how quagga generates LSA7 for such routes, so it most likely will not work. </li></ul><br><br>  PPS / upd It is unacceptable to use this scheme if different commands are involved in the network and servers.  Rather, it is some kind of very convenient "hack" for administrators who are engaged in both the first and second. </div><p>Source: <a href="https://habr.com/ru/post/244151/">https://habr.com/ru/post/244151/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244137/index.html">New optimizations for x86 in the expected GCC 5.0</a></li>
<li><a href="../244139/index.html">Keyboard Octodon: Throwing and Metamorphosis</a></li>
<li><a href="../244141/index.html">Media Player for Translators - feci quod potui</a></li>
<li><a href="../244143/index.html">Bypassing the protection of the iOS client Dropbox</a></li>
<li><a href="../244145/index.html">Interview with Moses Uretsky, co-founder and director of Digital Ocean</a></li>
<li><a href="../244153/index.html">Facebook launches data center with new network architecture</a></li>
<li><a href="../244155/index.html">Multitasking in the Linux kernel: workqueue</a></li>
<li><a href="../244159/index.html">ATM attack with Raspberry Pi</a></li>
<li><a href="../244161/index.html">Trader trader competitor?</a></li>
<li><a href="../244163/index.html">Recognize barcodes on images using Python and OpenCV</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>