<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Perfect" cluster. Part 3.1 Implementing MySQL Multi-Master Cluster</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In continuation of the series of articles on the ‚ÄúIdeal‚Äù cluster, I want to share my experience in deploying and configuring Multi-Master MySQL cluste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Perfect" cluster. Part 3.1 Implementing MySQL Multi-Master Cluster</h1><div class="post__text post__text-html js-mediator-article"><h4>  In continuation of the series of articles on the ‚ÄúIdeal‚Äù cluster, I want to share my experience in deploying and configuring Multi-Master MySQL clusters. </h4><br><br><img src="https://habrastorage.org/files/37c/7a9/c5c/37c7a9c5c5ed45a089429edb7259bb0a.jpg"><br><a name="habracut"></a><br>  <b>My other publications on the ‚ÄúIdeal‚Äù cluster</b> <br><ul><li>  <a href="http://habrahabr.ru/post/264487/">Acceleration and optimization of PHP-site.</a>  <a href="http://habrahabr.ru/post/264487/">What technologies should be chosen when setting up a server for PHP</a> </li><li>  <a href="http://habrahabr.ru/post/253869/">"Perfect" cluster.</a>  <a href="http://habrahabr.ru/post/253869/">Part 3.1 Implementing MySQL Multi-Master Cluster</a> </li><li>  <a href="http://habrahabr.ru/company/acronis/blog/209934/">"Perfect" cluster.</a>  <a href="http://habrahabr.ru/company/acronis/blog/209934/">Part 2.2: Highly available and scalable web server, the best technologies to guard your business</a> </li><li>  <a href="http://habrahabr.ru/company/acronis/blog/204190/">About virtual hetzner cluster</a> </li><li>  <a href="http://habrahabr.ru/company/acronis/blog/198934/">Frontend: NGINX + Keepalived (vrrp) on CentOS</a> </li><li>  <a href="http://habrahabr.ru/company/acronis/blog/198448/">HAPRoxy for Percona or Galera on CentOS.</a>  <a href="http://habrahabr.ru/company/acronis/blog/198448/">Its configuration and monitoring in Zabbix</a> </li><li>  <a href="http://habrahabr.ru/company/acronis/blog/198354/">Zabbix 2.2 riding on nginx + php-fpm and mariadb</a> </li></ul><br><br>  First of all, you should understand which of the MySQL Galera technology implementation you will use.  On the market there are implementations of Galera from Percona and MariaDB.  It is these two implementations that shared the lion's share of MySQL Galera implementations. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Both forks are used as an InnoDB plug-in, the Percona XtraDB Storage Engine.</b> <br><br><blockquote>  This engine is based on the InnoDB-plugin code and is fully compatible with it, but differs in markedly higher performance due to the integration of patches from Google and Percona. <br>  In particular, XtraDB improved the mechanism of working with memory, improved the operation of the I / O subsystem InnoDB, added support for multiple read and write threads, support for bandwidth control, <br>  implementation of data pre-fetch (read-ahead), adaptive checkpoint installation (adaptive checkpointing), scaling options for large projects expanded, locking system adapted <br>  to work on systems with a large number of CPUs, added additional features for the accumulation and analysis of statistics. </blockquote><br><br>  At the same time, <b>MariaDB Galera is distinguished by a number of other improvements and features</b> . <br><br><img src="https://habrastorage.org/files/f9b/503/ff6/f9b503ff69304740a8d73ee69345fea5.png"><br><br><ul><li>  <b>Aria (formerly Maria)</b> is a highly reliable repository based on MyISAM, characterized by increased stability and preservation of data integrity after a crash, with full compatibility with MyISAM.  Thanks to the logging of operations, in the event of a crash, the results of the current operation are rolled back.  It also supports the ability to restore the state from any point in the log of operations (including support for CREATE / DROP / RENAME / TRUNCATE). </li><li>  <b>PBXT (PrimeBase XT)</b> is a storage designed from scratch and supporting the MVCC multi-version data storage management method (multi-version concurrency control) that allows you to get rid of locks when performing read operations. <br>  PBXT supports ACID-compliant transactions, fast transaction rollback and recovery after server shutdowns.  There are tools for ensuring referential integrity of data, support for determining foreign keys (foreign key), cascading updates and deletions of data.  The possibility of direct stream input and output of binary data (BLOB) in the database is supported; </li><li>  <b>FederatedX</b> - is positioned as a replacement for <b>Federated</b> developed in Sun Microsystems and no longer supported storage.  FederatedX allows you to organize access to remote tables as local. <br>  There is support for transactions, simultaneous installation of several connections to a remote DBMS, use of operations ‚ÄúLIMIT‚Äù; </li><li>  <b>OQGRAPH</b> is a repository for organizing hierarchical (tree-like) structures and complex graphs (nodes with many connections); </li><li>  <b>Sphinx</b> is the repository for building search engines.  The built-in Sphinx client allows MariaDB to exchange data with searchd, execute search queries and receive search results; </li></ul><br><br>  In addition, <b>MariaDB Galera 10</b> has a number of improvements compared to version 5.5: <br><br><ul><li>  The new storage of <b>Connect</b> , allowing to organize access to arbitrary local or remote data, in the form as if they were stored in a table.  For example, you can associate the contents of a virtual table with data from a file in a specific format; </li><li>  New storage <b>Cassandra Storage Engine (SE)</b> , adds to MariaDB and MySQL support tools for accessing data stored in a distributed Apache Cassandra database.  Using Cassandra SE, developers can access data and add data to a Cassandra database using ordinary SQL queries.  At the same time, the data storage model used in Cassandra as a family of columns (ColumnFamily) is displayed in the form of MariaDB / MySQL-specific tables, for which standard SQL directives SELECT, INSERT, DELETE and UPDATE can be used, as well as perform joining operations (JOIN) with other tables. </li><li>  Integration of the <b>SPIDER</b> repository with the implementation of the sharding system, which allows spreading large tables to multiple servers  From the point of view of query generation, such tables do not differ from ordinary local tables, but in fact, when using SPIDER, different portions of data constituting one table are stored on different servers.  To ensure high availability of tables distributed across servers using SPIDER, new replication tools can be used. </li><li>  <b>Sequence</b> storage for generating virtual tables filled with increasing or decreasing sequences (for example, seq_1_to_5 or seq_5_to_1_step_2). </li><li>  Improved implementation of dynamic columns, allowing you to get a different set of "virtual columns" for each row in the table. </li><li>  Added support for queries in JSON format and the ability to integrate with the Cassandra database; </li><li>  Numerous performance optimizations that allow MariaDB 10 to achieve multiple acceleration of some operations compared to MySQL and past MariaDB branches.  Among the key optimizations there is support for <b>parallel replication</b> and the development of group commits.  Added additional optimizations for the execution of subqueries, for example, the conversion of NOT EXISTS expressions into IN blocks; </li><li>  Improved replication tools.  The operation of replicated slave servers is protected from problems in the event of a crash. </li><li>  <b>Added support for data replication from multiple master servers (multi-source replication)</b> .  From the examples of using multi-source replication, mention is made of solving problems of collecting data in one place, separated into different machines, in order to perform analytical queries or to create a backup copy; </li><li>  Support for global transaction identifiers; </li><li>  The ability to use the IF (NOT) EXIST test for ALTER TABLE expressions; </li><li>  Improved error reporting.  All numerical numbers of errors are now accompanied by explanatory texts. </li><li>  Support for the expression "SHOW EXPLAIN FOR thread_id" for analyzing a query executed in a given thread.  Since ‚ÄúSHOW EXPLAIN‚Äù takes into account the execution plan of the real query by the optimizer, it allows to obtain indicators that are closer to reality than the execution of the query within ‚ÄúEXPLAIN‚Äù; </li><li>  Additional optimizations have been added to InnoDB to significantly speed up the execution of transactions that do not perform a write operation and data modification operations.  A new TRANSACTION READ ONLY command has been added to perform read transactions; </li><li>  Optimized execution of the construction "LIMIT ... ORDER BY"; </li><li>  Support for automatic timestamp in DATETIME; </li><li>  In-memory tables with effective support for VARCHAR and BLOB types; </li><li>  A universal system of accumulating statistics on the activity and filling of tables for use by the query optimizer, implemented without reference to specific storage engines; </li><li>  Support for the analysis of memory consumption in relation to a separate thread; </li><li>  Significant acceleration of ALTER TABLE constructions for Aria and MyISAM storages in the presence of verification of unique keys; </li></ul><br><br>  <b>Improvements ported from MySQL 5.6:</b> <br><br><ul><li>  An updated version of the InnoDB repository. </li><li>  Support for the PERFORMANCE_SCHEMA engine and its associated performance_schema database, which provides low-level tools for monitoring the execution of queries and various events during the operation of the DBMS; </li><li>  The mode is read-only for transactions in InnoDB, the support of the expression "TRANSACTION READ ONLY"; </li><li>  Optimization of the speed of execution of queries of the form ‚ÄúORDER BY ... LIMIT‚Äù. </li><li>  Support for "--plugin-load-add"; </li><li>  Ability to perform "ALTER TABLE" on the fly; </li><li>  Setting privileges for temporary tables; </li><li>  Extensions related to encoding support; </li><li>  The expression "GET DIAGNOSTICS"; </li><li>  Temporary literals (for example, TIME'12: 34: 56 '). </li></ul><br>  From myself I want to add that both forks also support <b>HandlerSocket</b> and <b>Memcached plugin</b> <br><br>  A more detailed description of the stable release of MariaDB 10.0 DBMS can be found in the <a href="http://www.opennet.ru/opennews/art.shtml%3Fnum%3D39444"><b>source on opennet</b></a> <br><br><h4>  <b>Why did I choose MariaDB Galera 10?</b> </h4><br><img src="https://habrastorage.org/files/6ba/ce8/74b/6bace874b7404864a4b8a38b5263616b.png">  . <br><br>  MariaDB Galera 10 supports <b>MySQL Query Cache</b> out of the box.  Any instructions for installing any of the MySQL Galera implementations clearly indicate the need to disable Query Cache.  As a result, when switching from a single database server to a cluster option, the speed of reading complex queries drops significantly.  And the load on the server increases commensurately. <br>  Percona XtraDB Cluster in version 5.6 also came close to implementing full-fledged support for Query Cache, but here you need to enable it on the ‚Äúlive‚Äù one, after launching the node using queries: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GLOBAL</span></span> query_cache_size =<span class="hljs-number"><span class="hljs-number">128</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GLOBAL</span></span> query_cache_type = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><br>  When Query Cache is enabled, up to 95% of queries return the result from the cache instead of being executed again. <br><br>  <b>I want to immediately give a couple of their comments.</b> <br><br>  <b>Cache should not be much</b> .  The largest size, which is generally worth installing, is no more than <b>512MB</b> .  Even 512MB is a lot, really you need less.  And that's why: <br><br><blockquote>  <b>If any of the tables, the sample of which is in the cache, undergo changes (insert or change rows), then MySQL removes such samples from the cache</b> .  This approach speeds up the work of MySQL, but may be ineffective for systems with a large number of requests for changing tables.  This leads to the fact that the tables are simply locked in <b>Waiting</b> mode <b>for query cache lock</b> . </blockquote><br><br>  The query cache can be thought of as a hash, the keys of which are queries, and the values ‚Äã‚Äãare the results of queries. <br>  If query cache usage is enabled, then, upon receiving a query, MySQL determines whether the first three characters of the query are ‚ÄúSEL‚Äù.  If yes, then MySQL looks to see if there is an entry in the query cache with a key equal to the query. <br><br>  <b>From here follow two important rules:</b> <br><br><ul><li>  MySQL performs byte-by-byte comparison, so queries that have a difference in at least one character (for example, SELECT * FROM table and select * from table) will be treated as two different queries.  Therefore, it is necessary to write queries in the same style; </li><li>  In MySQL to version 5.0, queries that have a space at the beginning or a comment is written will never be taken from the cache. </li></ul><br><br>  In addition to the results, MySQL stores in cache the list of tables, a selection of which is cached. <br><br>  Read more about the cache of requests, you can read in the source on <a href="http://habrahabr.ru/post/41166/">habrahabr</a> <br><br><h4>  <b>From words to deeds</b> </h4><br><br>  I think that you use, you have already figured out.  Further in the text I describe the work with MariaDB Galera 10, but almost everything described above is also true for Percona XtraDB Cluster 5.6. <br><br>  <b>If we translate a single MySQL installation into cluster execution:</b> <br><br><ul><li>  Make sure that all our databases do not contain tables with the MyISAM engine. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table_schema, table_name <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> INFORMATION_SCHEMA.TABLES <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">engine</span></span> = <span class="hljs-string"><span class="hljs-string">'myisam'</span></span>;</code> </pre> </li><li>  Make sure that all the tables in our databases have primary keys: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table_catalog, table_schema, table_name, <span class="hljs-keyword"><span class="hljs-keyword">engine</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> information_schema.tables <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (table_catalog, table_schema, table_name) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table_catalog, table_schema, table_name <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> information_schema.table_constraints <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> constraint_type = <span class="hljs-string"><span class="hljs-string">'PRIMARY KEY'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> table_schema <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'information_schema'</span></span>, <span class="hljs-string"><span class="hljs-string">'pg_catalog'</span></span>);</code> </pre> </li></ul><br><br>  <b>To solve the first problem there are 2 ways:</b> <br><br>  <b># Option 1</b> <br><br><pre> <code class="bash hljs">mysql __ -e <span class="hljs-string"><span class="hljs-string">"show table status where Engine='MyISAM';"</span></span> | awk <span class="hljs-string"><span class="hljs-string">'NR&gt;1 {print "ALTER TABLE "$1" ENGINE = InnoDB;"}'</span></span> | mysql __</code> </pre> <br><br>  <b>Option 2</b> <br><br><pre> <code class="bash hljs">mysql __ -e <span class="hljs-string"><span class="hljs-string">"show table status where Engine='MyISAM';"</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span> | xargs -t -i pt-online-schema-change --alter-foreign-keys-method=auto --alter <span class="hljs-string"><span class="hljs-string">"ENGINE=InnoDB"</span></span> --execute --statistics --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-vars=<span class="hljs-string"><span class="hljs-string">"wait_timeout=10000,innodb_lock_wait_timeout=10,lock_wait_timeout=180"</span></span> --progress=time,1 D=__,t={}</code> </pre> <br><br>  For small tables, the first option works pretty quickly.  But with large tables there are problems.  Since the conversion will take a long time, the table will be blocked and all operations with it will become impossible, which will certainly affect the provision of services / services.  The <b>pt-online-schema-change</b> utility from the <b>percona-toolkit</b> kit will help us to solve this problem. <br><br>  <b>This utility is installed from the repository for CentOS</b> : <br><br><pre> <code class="bash hljs">rpm -Uhv http://www.percona.com/downloads/percona-release/percona-release-0.0-1.x86_64.rpm</code> </pre> <br><br>  <b>Important</b> It <b>is</b> necessary that the table being converted has either a primary (PRIMARY) or a unique (UNIQUE) key, otherwise it will generate an error, for example: <br><blockquote>  Cannot chunk the original table `database`.`NAMETABLE01_NOKEY`: There is no index and the table is oversized.  at / usr / bin / pt-online-schema-change line 5442. </blockquote><br><br>  <b>To solve the second problem, alas, there is only one way - to add the PRIMARY or UNIQUE key via ALTER.</b> <br><br><blockquote>  All tables should be a primary key (multi-column primary keys are supported).  DELETE operations are unsupported on tables without a primary key.  Also, it can be different ordering for different nodes. </blockquote><br><br>  Those.  possible loss of nodes, deadlocks and other problems.  Plus the order of lines gets off.  It needs to be repaired first. <br><br><h4>  If we have left these problems behind, then we will proceed to installing and configuring the database server itself. </h4><br><br><pre> <code class="bash hljs">cat &gt; /etc/yum.repos.d/MariaDB.repo &lt;&lt; EOL [mariadb] <span class="hljs-comment"><span class="hljs-comment"># MariaDB 10.0 CentOS repository list - created 2015-02-18 14:04 UTC # http://mariadb.org/mariadb/repositories/ [mariadb] name = MariaDB baseurl = http://yum.mariadb.org/10.0/centos6-amd64 gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB gpgcheck=1 EOL</span></span></code> </pre> <br><br><pre> <code class="bash hljs">yum install MariaDB-Galera-server MariaDB-client rsync galera ntp nscd</code> </pre> <br><br><pre> <code class="bash hljs">chkconfig nscd on $$ /etc/init.d/nscd start</code> </pre> <br><br>  <b># Need to disable selinux, this is the requirement of the developers MariaDB</b> <br><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">'s/SELINUX=enforcing/SELINUX=disabled/g'</span></span> /etc/selinux/config <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 0 &gt; /selinux/enforce</code> </pre> <br><br>  <b># On all nodes, the time must be set correctly, this is mandatory.</b>  <b>Otherwise, you will encounter the fact that, with the SST node from the donor, the synchronized node will just wait for something, without any sign of activity.</b> <br><br><pre> <code class="bash hljs">yum install ntp -y chkconfig ntpd on /etc/init.d/ntpd stop ntpdate 165.193.126.229 0.ru.pool.ntp.org 1.ru.pool.ntp.org 2.ru.pool.ntp.org 3.ru.pool.ntp.org /etc/init.d/ntpd start</code> </pre> <br><br>  To set up MariaDB servers and Galera clusters, I wrote a script, it creates a configuration file, individually for each server. <br><br>  <b>I want to say again, at the output we get a workpiece that requires subsequent editing.</b> <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # wget --no-check-certificate -q -O - 'https://cloud.sycraft.info/index.php/s/7bf49db6da59f6d48d61abcb2c4b4791/download' | bash -x - # fetch -o mysqld_config.sh 'https://cloud.sycraft.info/index.php/s/7bf49db6da59f6d48d61abcb2c4b4791/download' # sh mysqld_config.sh if [ "$(uname)" == 'Linux' ]; then IBS=innodb_buffer_pool_size\ \=\ $((`free -m | grep Mem | awk '{print $2}'`*60/100000))G; socket=socket=\/var\/lib\/mysql\/mysql.sock; DB=datadir=\/var\/lib\/mysql; conf=\/etc; cpu=$((`cat /proc/cpuinfo | grep -c processor`*2)) else IBS=innodb_buffer_pool_size\ \=\ $((`dmesg |grep real\ memory | awk '{print $5}' |cut -c 2- | tail -1`*60/100000))G; conf=\/var\/db\/mysql; cpu=$((`sysctl hw.ncpu | awk '{print $2}'`*2)) fi mkdir -p ~/backup/mysql &gt; /dev/null 2&gt;&amp;1 mkdir $conf/mysql.d &gt; /dev/null 2&gt;&amp;1 mkdir $conf/mysql.d/ssl &gt; /dev/null 2&gt;&amp;1 mkdir /var/log/mysql &gt; /dev/null 2&gt;&amp;1 chown mysql:mysql $conf/mysql.d chown mysql:mysql $conf/mysql.d/ssl chown -R mysql:mysql /var/log/mysql if [ -f $conf/my.cnf ]; then cp $conf/my.cnf ~/backup/mysql/my.cnf.`date +%Y-%m-%d_%H-%M` fi if [ -f $conf/mysql.d/000-galera.cnf ]; then cp $conf/mysql.d/000-galera.cnf ~/backup/mysql/000-galera.cnf.`date +%Y-%m-%d_%H-%M` fi if [ -f $conf/mysql.d/001-server.cnf ]; then cp $conf/mysql.d/001-server.cnf ~/backup/mysql/001-server.cnf.`date +%Y-%m-%d_%H-%M` fi if [ -f $conf/mysql.d/002-myisam.cnf ]; then cp $conf/mysql.d/002-myisam.cnf ~/backup/mysql/002-myisam.cnf.`date +%Y-%m-%d_%H-%M` fi if [ -f $conf/mysql.d/003-rep-master.cnf ]; then cp $conf/mysql.d/003-rep-master.cnf ~/backup/mysql/003-rep-master.cnf.`date +%Y-%m-%d_%H-%M` fi if [ -f $conf/mysql.d/004-rep-slave.cnf ]; then cp $conf/mysql.d/004-rep-slave.cnf ~/backup/mysql/004-rep-slave.cnf.`date +%Y-%m-%d_%H-%M` fi if [ -f $conf/mysql.d/005-mariadb-opt.cnf ]; then cp $conf/mysql.d/005-mariadb-opt.cnf ~/backup/mysql/005-mariadb-opt.cnf.`date +%Y-%m-%d_%H-%M` fi if [ -f $conf/mysql.d/006-ssl.cnf ]; then cp $conf/mysql.d/006-ssl.cnf ~/backup/mysql/006-ssl.cnf.`date +%Y-%m-%d_%H-%M` fi if [ -f $conf/mysql.d/007-handlersocket.cnf ]; then cp $conf/mysql.d/007-handlersocket.cnf ~/backup/mysql/007-handlersocket.cnf.`date +%Y-%m-%d_%H-%M` fi if [ -f $conf/mysql.d/008-threadpool.cnf ]; then cp $conf/mysql.d/008-threadpool.cnf ~/backup/mysql/008-threadpool.cnf.`date +%Y-%m-%d_%H-%M` fi cat &gt; $conf/my.cnf &lt;&lt; EOL !includedir $conf/mysql.d/ EOL # galera-only cat &gt; $conf/mysql.d/000-galera.cnf &lt;&lt; EOL [mysqld] wsrep_provider = /usr/lib64/galera/libgalera_smm.so wsrep_cluster_address = gcomm://192.168.0.30,192.168.0.40,192.168.0.41,192.168.0.74,192.168.0.75,192.168.0.76,192.168.0.161 # Node4 address wsrep_node_address = 192.168.0.161 # Cluser name wsrep_cluster_name = cluster wsrep_node_name = prod-db-new-04 #wsrep_slave_threads = $cpu innodb_autoinc_lock_mode = 2 # SST method wsrep_sst_method = xtrabackup wsrep_sst_auth = "sstuser:s3cretPass" ##wsrep_sst_method = rsync wsrep_retry_autocommit = 3 wsrep_provider_options = "gcache.size=5G; repl.commit_order=1; gmcast.segment=2" EOL cat &gt; $conf/mysql.d/001-server.cnf &lt;&lt; EOL [mysqld] symbolic-links=0 default_storage_engine = InnoDB innodb_file_per_table = 1 event_scheduler=on #character-set-server = utf8 $DB $socket # network connect_timeout = 600000 wait_timeout = 28800 max_connections = 600 max_allowed_packet = 512M max_connect_errors = 10000 net_read_timeout = 600000 connect_timeout = 600000 net_write_timeout = 600000 # innodb engine settings innodb_open_files = 512 $IBS innodb_buffer_pool_instances = 2 innodb_file_format = barracuda innodb_locks_unsafe_for_binlog = 1 innodb_flush_log_at_trx_commit = 2 innodb_flush_method = O_DIRECT transaction-isolation = READ-COMMITTED innodb-data-file-path = ibdata1:10M:autoextend innodb-log-file-size = 256M innodb_log_buffer_size = 8M # performance settings skip-name-resolve skip-external-locking skip-innodb_doublewrite query_cache_size = 128M query_cache_type = 1 query_cache_min_res_unit = 2K join_buffer_size = 8M read_rnd_buffer_size = 3M table_definition_cache = 2048 table_open_cache = 2048 thread_cache_size = 128 tmp_table_size = 2048M max_heap_table_size = 2048M log_error = /var/log/mysql/mysql-error.log #slow_query_log_file = /var/log/mysql/mysql-slow.log EOL # myisam cat &gt; $conf/mysql.d/002-myisam.cnf &lt;&lt; EOL [mysqld] key_buffer_size = 512M EOL # rep-master cat &gt; $conf/mysql.d/003-rep-master.cnf &lt;&lt; EOL [mysqld] #log-bin = /var/log/mysql/mysql-bin # cluster # binlog_format=ROW # single installation binlog_format=MIXED server_id = 226 sync-binlog = 0 expire-logs_days = 3 max-binlog-size = 1G log-slave-updates EOL # rep-slave cat &gt; $conf/mysql.d/004-rep-slave.cnf &lt;&lt; EOL [mysqld] slave-skip-errors = 1062 log_slave_updates = 1 slave_type_conversions=ALL_NON_LOSSY relay-log = /var/log/mysql/mysql-relay-bin relay-log-index = /var/log/mysql/mysql-relay-bin.index relay-log-info-file = /var/log/mysql/mysql-relay-log.info skip-slave-start # replicate-rewrite-db=from_name-&gt;to_name # replicate-ignore-table=db_name.table_name # replicate-wild-ignore-table=db_name.table_name EOL # mariadb-opt cat &gt; $conf/mysql.d/005-mariadb-opt.cnf &lt;&lt; EOL [mysqld] optimizer_switch='derived_merge=off,derived_with_keys=off' EOL # ssl cat &gt; $conf/mysql.d/006-ssl.cnf &lt;&lt; EOL #[mysqld] #ssl-ca = $conf/mysql.d/ssl/ca-cert.pem #ssl-cert = $conf/mysql.d/ssl/server-cert.pem #ssl-key = $conf/mysql.d/ssl/server-key.pem EOL # handlersocket cat &gt; $conf/mysql.d/007-handlersocket.cnf &lt;&lt; EOL [mysqld] #handlersocket_address=127.0.0.1 #handlersocket_port=9998 #handlersocket_port_wr=9999 EOL # threadpool cat &gt; $conf/mysql.d/008-threadpool.cnf &lt;&lt; EOL [mysqld] thread_handling = pool-of-threads thread_pool_size = $cpu EOL</span></span></code> </pre> <br><br>  <i>Life does not stand still and I, just like you, continue to evolve continuously, the latest version of the script, it is better to take immediately from its permanent <a href="https://cloud.sycraft.info/index.php/s/7bf49db6da59f6d48d61abcb2c4b4791">page</a> , probably from the moment of writing the article, a lot has changed in it.</i> <br><br><h4>  Explanations to the config and generation script </h4><br><br>  <b>wsrep_sst_method = xtrabackup</b> <br><br><blockquote>  If you use rsync mode, then at the time of synchronization of the node from the donor, the donor will be completely blocked for recording.  In xtrabackup mode, the lock will last only a few seconds while xtrabackup ‚Äúclings‚Äù to the base. <br>  If you use HAProxy as described here <a href="http://habrahabr.ru/company/acronis/blog/198448/">HAPRoxy for Percona or Galera on CentOS.</a>  <a href="http://habrahabr.ru/company/acronis/blog/198448/">Its configuration and monitoring in Zabbix</a> is to work with the server while it is in donor mode, we need to edit <a href="https://github.com/olafz/percona-clustercheck/blob/master/clustercheck">the</a> clustercheck <a href="https://github.com/olafz/percona-clustercheck/blob/master/clustercheck">script</a> on the nodes. </blockquote><br><br>  <b># Replacing string</b> <br><pre> <code class="bash hljs">AVAILABLE_WHEN_DONOR=<span class="hljs-variable"><span class="hljs-variable">${3:-0}</span></span></code> </pre> <br><br>  <b># per line</b> <br><pre> <code class="bash hljs">AVAILABLE_WHEN_DONOR=1</code> </pre> <br><br>  In this mode, in the case of a complete drop in all the nodes of the cluster, we can reduce the idle time to synchronization to the minimum. <br><br>  <b><a href="http://qoo.by/CR">transaction_isolation = REPEATABLE-READ</a></b> <br><br><blockquote>  It is worth trying to change to transaction-isolation = READ-COMMITTED  transition to snapshot transactions.  Each transaction becomes a kind of independent sandbox.  Snapshot of data. <br>  This is similar to the Oracle isolation level.  All SELECT ... FOR UPDATE and SELECT ... LOCK IN SHARE MODE statements block only index entries and do not block the interval in front of them.  Therefore, they allow you to freely add new entries after being blocked.  UPDATE and DELETE, which use a unique index and unique search conditions, block only the found index entry, and do not block the interval in front of it.  But in UPDATE and DELETE, a range type in InnoDB must set the next key lock or interval lock and block other users from adding to the interval covered by the range.  This is necessary because  "Phantom lines" must be blocked for successful replication and recovery in MySQL.  Consistent reading works just like Oracle: every consistent read, even within a single transaction, sets and reads its own snapshot. <br>  In most cases, the transition gives an increase in speed on a competitive record, but phantom reading effect is also possible.  In my practice, I have met only one application that was ill with phantom.  Those.  These are applications using DBMS, you need to check for the ability to work in this mode. </blockquote><br><br>  <b>innodb_flush_log_at_trx_commit = 2</b> <br><br><blockquote>  A value of ‚Äú1‚Äù means that any completed transaction will synchronously flush the log to disk.  This is the default option, it is the most reliable in terms of data integrity, but the slowest in terms of speed. <br>  The value ‚Äú2‚Äù does the same, only flushes the log not to the disk, but to the cache of the operating system (that is, it does not flush after each operation).  This value is suitable in most cases, because  does not perform expensive write operations after each transaction.  In this case, the log is written to the disk with a delay of several seconds, which is very safe from the point of view of data integrity. <br>  But we have a cluster and in the event of a crash, the data will still be transferred from the donor.  The main thing that the transaction zakomitilas on other nodes.  Then we get the data at SST </blockquote><br><br>  <b>innodb_buffer_pool_instances = 2</b> <br><br><blockquote>  By default, InnoDB uses one instance for the Buffer Pool. <br>  In this case, it is possible to select several blocks - and in some cases MySQL works with them in InnoDB much more efficiently.  This is associated with smaller cache locks when writing data. </blockquote><br><br>  <b>innodb_file_format = barracuda</b> <br><br><blockquote>  This format is the most "new" and supports compression.  This reduces the load on the IO (disks) by using compression.  Just as a recommendation, you can use a 16KB block size. </blockquote><br><br>  <b>Here is an example of alter:</b> <br><pre> <code class="bash hljs">ALTER TABLE `t1` ENGINE=InnoDB ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=16;</code> </pre> <br><br>  <a href="http://www.tocker.ca/2013/10/31/benchmarking-innodb-page-compression-performance.html">Here are the results of testing the</a> speed and size of data under compression. <br>  <b>But there are downsides to compression</b> .  On compressed tables, ALTERs will occur much longer, as you know, ALTER, like any DDL, locks the table and with it the entire cluster.  ALTER is not a transactional instruction, and therefore is not replicated by ROW binary diffs, but is transmitted in the form of requests.  And until this request is executed on all nodes of the cluster, all commits will be frozen. <br>  Those.  it makes sense to do compression either on large tables where DDL is not planned in principle, or on single mysql instances. <br><br>  <b>innodb_flush_method = O_DIRECT</b> <br><br><blockquote>  Data reset bypassing disk cache.  This is necessary to prevent double buffering of data in the innodb_buffer_pool cache and the file system cache.  Will allow more efficient use of RAM. </blockquote><br><br>  It is worth adding the <b>skip-innodb_doublewrite</b> parameter, which is <a href="http://www.percona.com/blog/2006/08/04/innodb-double-write/">important</a> in terms of performance <b>.</b> <br><br><blockquote>  Even though it doesn‚Äôt need to be written over twice.  Write to write buffer it is pretty cheap.  It can be used as a rule. .  However, it could not be implemented at the same time.  I would expect no more than 5-10% performance loss due to use of doublewrite. </blockquote><br><br>  <b>tmp_table_size = 2048M</b> <b><br></b>  <b>max_heap_table_size = 2048M</b> <br><br><blockquote>  Very interesting parameters, their values ‚Äã‚Äãneed to squeeze to the maximum.  This will reduce the number of temporary tables created on the disk.  As a rule, it is the creation of temporary tables on the disk that takes more time on sorts, groupings and other complex select. </blockquote><br><br>  <b>optimizer_switch = 'derived_merge = off, derived_with_keys = off'</b> <br><br><blockquote>  There are problems with the compatibility of the application with the base, after switching to percona 5.6 and galera 10. The most significant of them should be immediately warned with the parameter </blockquote><br><br>  <b>thread_handling = pool-of-threads</b> <b><br></b>  <b>thread_pool_size = number of cores</b> <br><br><blockquote>  You should also use <a href="http://www.percona.com/blog/2014/01/23/percona-server-improve-scalability-percona-thread-pool/">thread_pool</a> </blockquote><br><br>  <b>wsrep_retry_autocommit = 3</b> <br><br>  <b>Important!</b>  If the database is deadlock, the commits will be retarded, i.e.  The node will not fall out of the cluster at the first sneeze, but will continue to work and we do not lose commit. <br><br>  <b>wsrep_provider_options = ‚Äúgcache.size = 5G;</b>  <b>repl.commit_order = 1;</b>  <b>gmcast.segment = 2 "</b> <br><br>  <a href="http://www.percona.com/blog/2013/11/22/new-wsrep_provider_options-galera-3-x-percona-xtradb-cluster-5-6/">Here is a</a> detailed description, these parameters I usually put by default always. <br><br>  The parameter <b>wsrep_replicate_myisam = 1</b> is almost a 100% guarantee of the death of the cluster if at least one combat myisam table appears there. <br><br><blockquote>  This feature is still experimental and its inclusion adds to the ROW (based on binary diff snapshots) replication and the statement, as in the replication of DDL commands.  This means constant conflicts, locks and the collapse of the cluster after any of the myisam tables. </blockquote><br><br>  <b>If you have any questions, difficulties, or need advice:</b> <b><br></b>  <b>My <a href="http://habrahabr.ru/users/sycraft/">profile</a> contacts</b> </div><p>Source: <a href="https://habr.com/ru/post/253869/">https://habr.com/ru/post/253869/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253859/index.html">Deconvolutional Neural Network</a></li>
<li><a href="../253861/index.html">3CX updated software client for Mac</a></li>
<li><a href="../253863/index.html">Google Maps History</a></li>
<li><a href="../253865/index.html">The evolution of mobile applications</a></li>
<li><a href="../253867/index.html">How to become a test automation?</a></li>
<li><a href="../253873/index.html">Wolfram Data Drop - new service Wolfram Research</a></li>
<li><a href="../253875/index.html">I want a timer and a count of loaded lines on a web form</a></li>
<li><a href="../253877/index.html">Understanding the Docker</a></li>
<li><a href="../253879/index.html">The program for calculating the minimum price of radio components in real time</a></li>
<li><a href="../253883/index.html">And we have an SDK, and you?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>