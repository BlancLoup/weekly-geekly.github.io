<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Conditional indexing. Optimizing the full-text search process</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to talk about the integration of Apache Lucene and Hibernate Search. To be more precise, about one of the Hibernate Search mech...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Conditional indexing. Optimizing the full-text search process</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/61a/33e/4cf/61a33e4cf0f54da396353995d0e9541d.jpg"><br><br>  In this article I want to talk about the integration of Apache Lucene and Hibernate Search.  To be more precise, about one of the Hibernate Search mechanisms, which can greatly increase the performance of a full-text search project. <br><a name="habracut"></a><br>  For anyone who has worked with the above technologies, it is no secret that indexing is necessary for full-text search.  In other words, when adding and modifying records in the database, it is necessary to add / change indexes, which, in fact, will be used for full-text search.  Apache Lucene is responsible for this process.  But how do we notify Lutzen that this entity needs to be indexed: <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Indexed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Integer id; <span class="hljs-meta"><span class="hljs-meta">@Field</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String indexedField; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String unindexedField; <span class="hljs-comment"><span class="hljs-comment">//getters and setters }</span></span></code> </pre> <br>  In the class above, the <a href="https://habrahabr.ru/users/indexed/" class="user_link">Indexed</a> annotation says that the entity is indexed by Lutzen.  The <code>@Field</code> indicates which fields will be indexed.  Since  the <code>@Field</code> annotation <code>@Field</code> hung only over the indexedField field, which means that we can carry out full-text search only by this field. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Note.</b>  <i>For the normal operation of the Lucena, other settings besides the annotation data are necessary.</i>  <i>But since the article is not about setting up Lucena as a whole, but only optimizing the indexing process, we‚Äôll omit these details.</i> <br><br>  Now let's look at an example of indexing some entity.  Suppose we have an ad site.  And here is our essence: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ad</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Integer id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String text; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AdStatus status; <span class="hljs-comment"><span class="hljs-comment">//getters and setters }</span></span></code> </pre><br>  We want to provide our users with the possibility of full-text search on all site ads  To do this, add the appropriate annotations: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Indexed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ad</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Integer id; <span class="hljs-meta"><span class="hljs-meta">@Field</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String text; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AdStatus status; <span class="hljs-comment"><span class="hljs-comment">//getters and setters }</span></span></code> </pre><br>  Now it's time to mention that the ad can have one of the following statuses: DRAFT, ACTIVE, ARCHIVE.  After a brief reflection, we come to the decision that the users in the search results only need to display ads in the ACTIVE status.  Consider two options for solving this problem.  The first - in the forehead.  Add the @Field annotation over the status field.  And every time we search, we add predicate, which will indicate what this status should be.  The disadvantages of this solution are: a noticeable drop in performance with a large number of ads in ARCHIVE and DRAFT status, excessive indexing of entities that are no longer being searched. <br><br>  Another solution immediately comes to mind - do not index / delete existing indexes for ads in all statuses except ACTIVE.  This mechanism will help us and such as interceptors.  First, set the task.  We want the indexing to occur when the entity changes, depending on the new ad status.  Now we proceed to the implementation.  Create an AdIndexInterceptor class that implements the EntityIndexingInterceptor interface: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdIndexInterceptor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EntityIndexingInterceptor</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ad</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IndexingOverride </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAdd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ad entity)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entity.getStatus() == AdStatus.ACTIVE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IndexingOverride.APPLY_DEFAULT; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IndexingOverride.SKIP; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IndexingOverride </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ad entity)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entity.getStatus() == AdStatus.ACTIVE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IndexingOverride.UPDATE; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IndexingOverride.REMOVE; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IndexingOverride </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDelete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ad entity)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IndexingOverride.APPLY_DEFAULT; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IndexingOverride </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCollectionUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ad entity)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> onUpdate(entity); } }</code> </pre><br>  As seen above, the class must implement 4 methods that will be called when adding a record, editing a record, deleting and updating a collection of records, respectively.  Each of these methods must return one of the IndexingOverride values, which in turn is enum.  There are a total of four values ‚Äã‚Äãfor this enum.  I will sign for what happens when you return each of them: <br><br><ul><li>  <b>APPLY_DEFAULT</b> - the indexing process continues as if it were held in the absence of an interceptor. </li><li>  <b>SKIP</b> - indexing does not occur. </li><li>  <b>UPDATE</b> - the existing index is updated. </li><li>  <b>REMOVE</b> - the existing index is deleted, the new one is not created. </li></ul><br>  Now back to the entity class.  In order for Luzen to know that before indexing it is necessary to call the appropriate interceptor methods, we add the interceptor attribute to the <a href="https://habrahabr.ru/users/indexed/" class="user_link">Indexed</a> annotation above the entity: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Indexed</span></span>(interceptor = AdIndexingInterceptor.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ad</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Integer id; <span class="hljs-meta"><span class="hljs-meta">@Field</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String text; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AdStatus status; <span class="hljs-comment"><span class="hljs-comment">//getters and setters }</span></span></code> </pre><br>  It remains only to correctly document the use of this interceptor, so that the behavior of Lucena was expected for your teammates. <br><br>  <b>PS</b> In the official documentation, developers indicate that this feature is experimental and its functioning may change depending on user feedback. <br><br>  <a href="http://docs.jboss.org/hibernate/search/4.1/reference/en-US/html/search-mapping.html">Link</a> to official documentation. </div><p>Source: <a href="https://habr.com/ru/post/247897/">https://habr.com/ru/post/247897/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247883/index.html">Design and installation of antenna mast structures of the SV range</a></li>
<li><a href="../247885/index.html">MyBatis as a faster alternative to Hibernate</a></li>
<li><a href="../247889/index.html">Clojure - transducers, reducers and other dregs</a></li>
<li><a href="../247891/index.html">Wolves of Wall Street: A story about high-frequency trading from the expert Thomson Reuters</a></li>
<li><a href="../247893/index.html">List of YouTube channels for web development training</a></li>
<li><a href="../247901/index.html">Study under the MASA program in Israel</a></li>
<li><a href="../247903/index.html">Docker: interesting features of basic images</a></li>
<li><a href="../247905/index.html">DWDM lines between data centers: how does the approach change, if we are talking about banks and responsible objects</a></li>
<li><a href="../247907/index.html">Examples of using a real-time machine (MATLAB, Simulink, Software and hardware simulator)</a></li>
<li><a href="../247911/index.html">We construct a local cryptographic TLS proxy with an electronic signature HTTP API</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>