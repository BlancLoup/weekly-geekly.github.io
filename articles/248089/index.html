<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Vulnerability MS14-063 in the FastFat driver in Windows OS. Debriefing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this study, we will analyze the MS14-063 vulnerability associated with incorrect operation of the fastfat.sys driver and leading (at least accordin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Vulnerability MS14-063 in the FastFat driver in Windows OS. Debriefing</h1><div class="post__text post__text-html js-mediator-article">  In this study, we will analyze the MS14-063 vulnerability associated with incorrect operation of the fastfat.sys driver and leading (at least according to Microsoft) to unauthorized privilege escalation.  Until recently, Win Server 2003/2008 and Win Vista were affected by this vulnerability (in Win7, this hole was fixed a long time ago, by the way, but this is a completely different story - this is described in more detail in an <a href="https://xakep.ru/2014/10/21/fastfat/">article</a> on xakep.ru).  Immediately we will talk about what opportunities this vulnerability could actually provide to an attacker who decided to implement an attack using a USB flash drive with a ‚Äúbat‚Äù FS FAT. <br><a name="habracut"></a><br>  So, let's start with a brief description of the FAT file system device ‚Äî the operation with which the vulnerable fastfat.sys driver implements.  Detailed documentation can be seen in the specification ( <a href="http://bit.ly/1IwP3Lz">link</a> ).  We will only dwell on the provisions that interest us. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3bc/2fc/61f/3bc2fc61f87c619cbad8c9352841890d.png" alt="image"><br>  <i>Illustration of building a FAT file system taken from c-jump.com ( <a href="http://bit.ly/1DHY84k">link</a> )</i> <br><br>  At the beginning of the volume (at zero offset) is the so-called Boot Sector (in fact, Parameter Block BIOS, or, in abbreviated form, BPB).  This is a structure that describes the total volume device and is necessary for the volume to be properly handled by the driver.  There are many useful fields in this structure, and we will return to some of them.  The main thing that is worth noting now is that we are talking specifically about the Fat32 file system, since  in other implementations of FAT, the offsets in BPB will be different, and not only they. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, BPB is followed by the FAT structure itself (FAT Data Structure), which is essentially a single-linked list of file clusters (the entire disk is divided into clusters (and only one file can be in one cluster at a time)), the size of which is set during formatting disk - in turn, the clusters are divided into sectors) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f6a/455/d00/f6a455d00336211d24be04753188709d.gif" alt="image"><br>  <i>Illustration of the device storage area information (Data Area) on disk, taken from the resource technet.microsoft.com ( <a href="http://bit.ly/17KEB6i">link</a> )</i> <br><br>  At this stage, you need to remember about BPB, but rather to pay attention to the field NumFats.  According to the specification, this field sets the number of copies of the FAT structure for each file.  In the same specification it is stated that the standard value (which, respectively, guarantees compatibility of the FS with different drivers) for this field is 2, i.e.  For each file, there are 2 copies of the FAT structure - this is necessary to prevent the loss of the file in case of bad sectors.  It is in the processing of this field that the vulnerability lies.  In the case when numfat&gt; 2, a conditional transition to the code segment occurs that incorrectly allocates memory in the kernel pool (since the code is executed inside the driver). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/177/ac5/dd5/177ac5dd568850ca66c360a236904904.jpg" alt="image"><br>  <i>Illustration of the section of the vulnerable code of the FatCommonWrite function of the fastfat.sys driver, taken from the blog.beyondtrust.com resource - a blog from BeyondTrust experts who also investigated this vulnerability ( <a href="http://bit.ly/1KMYRTS">link</a> )</i> <br><br>  The vulnerability is in the FatCommonWrite function, or rather in the call to ExAllocatePoolWithTag, where the numfat value, the number of copies of the IoRuns structures not multiplied by their size, is passed as an argument to the required space.  In the code shown in the illustration, the ecx register contains a pointer to the BPB structure, and at offset 96h from it is the NumFats field, which, as can be seen from the illustration, falls on the stack as an argument to NumberOfBytes for the ExAllocatePoolWithTag function (by the way, as a patch , released from Microsoft, is just the addition of the missing multiplication in the block shown in the illustration). <br><br>  At this stage, it is worthwhile to talk more about the memory device of the drivers (a very good analysis of this class of vulnerabilities is on Habr√© - <a href="http://bit.ly/1AQt8LV">link</a> ).  Summarizing it, we have: the memory of the drivers is divided into Pool'y, each of which is a list of Chunk, in which, respectively, is the necessary information for the driver. <br><br>  Thus, there is a vulnerability of the type kernel pool overflow in the memory area, and, as a result, it is possible to exploit it by interrupting the memory chunk of another driver that is in memory immediately after the overflowing chunk. <br><br><img src="https://habrastorage.org/storage/habraeffect/d6/22/d622466a72142625bc7e736e1ca45e31.jpg" alt="image"><br>  <i>Illustration of the chunk overflow process, taken from the Habr√© article on Kernel Pool Overflow ( <a href="http://bit.ly/1AQt8LV">link</a> )</i> <br><br>  At this stage, we have already achieved some result - we correlate the memory of another driver, which leads to BSOD with the Bad Pool Header error.  But this is not enough, because  Memory Corruption is far from privilege escalation. <br><br>  Our goal is to change the header of the attacked (immediately after the overflowed) chunk to the correct, but not valid, but arbitrary (in order to capture the driver‚Äôs memory flow).  This will potentially lead to the fact that the attacker will be able to execute code on behalf of the driver, i.e.  with privilege escalation.  However, as the analysis of the data with which we overwhelm chunk has shown, there is no such possibility in this situation.  To justify this, consider the structure of IoRuns, for which just allocated memory in a vulnerable function.  Presumably (again, based on the Windows 2000 sources), the IoRuns structure serves as a tool used when writing FAT structures to the file system (since the FatCommonWrite function calls just when writing new files to disk, that is, creating / changing FAT -structures).  The point is that all copies (their number is regulated by the NumFats field in BPB) are recorded asynchronously, for this each copy is assigned its own copy of IoRuns, which indicates which offset to write (Vbo and Lbo fields) and how much to write ( ByteCount). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/519/810/4d2/5198104d27726a73f01bdd8a948d971d.png" alt="image"><br>  <i>Illustration of the initialization cycle of IoRuns structures (according to sources from WDK 8.0 Samples)</i> <br><br>  Thus, the values ‚Äã‚Äãin the fields of IoRuns structures are not so easy to replace, and all other structures will depend, or rather uniquely calculated, from the values ‚Äã‚Äãof the fields of the first structure.  What we have: the first field is the offset at which the recording of copies of FAT structures begins, the second field is the offset at which this copy is recorded (according to the writer's value), the third field is probably needed for processing an additional prolog to the FAT structure.  And the last field is set directly from BPB - it is equal to the BPB_BytsPerSec field, since  each copy of the FAT structure occupies one sector. <br><br>  It follows that to set such data that will overwrite the next chunk and leave it correct is simply impossible, since  we control only one ULONG field, which leads to the conclusion that it is impossible to implement privilege escalation. <br><br>  To summarize: this study leads to the question, are Microsoft experts right in saying that MS14-063 is really significant and can lead to escalation of privileges?  According to the analysis, the possibility of ‚Äúharming‚Äù this vulnerability is only available in the BSOD call, but there is no need to speak of any escalations. </div><p>Source: <a href="https://habr.com/ru/post/248089/">https://habr.com/ru/post/248089/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248079/index.html">Auto Balcony Lighting for Arduino</a></li>
<li><a href="../248081/index.html">Monkey Do - an unusual task manager</a></li>
<li><a href="../248083/index.html">How does the exchange test itself?</a></li>
<li><a href="../248085/index.html">The tenth Luxin LTS webinar: Nicholas Frenkel "How to improve your tests with the help of mutation testing"</a></li>
<li><a href="../248087/index.html">10 important lessons that I learned during my project A Year of Productivity (year of productivity)</a></li>
<li><a href="../248091/index.html">02 Links for UX-specialists</a></li>
<li><a href="../248093/index.html">How we build a message handling system</a></li>
<li><a href="../248095/index.html">Update Windows 8.1 Evaluation and Windows Server 2012 R2 Evaluation to full versions</a></li>
<li><a href="../248097/index.html">Ethernet over USB to STM32F4</a></li>
<li><a href="../248099/index.html">Pointer Checker: check our pointers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>