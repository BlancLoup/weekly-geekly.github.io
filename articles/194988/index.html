<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Font Filing and Translation Quest 1996 - I Have no Mouth, and I Must Scream</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All good! 
 Based on Harlan Ellison's eponymous novella (Harlan Ellison) , I Have No Mouth, and I Must Scream is one of the darkest quests of all time...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Font Filing and Translation Quest 1996 - I Have no Mouth, and I Must Scream</h1><div class="post__text post__text-html js-mediator-article"><h4>  All good! </h4><br>  Based on <a href="http://ru.wikipedia.org/wiki/%25D0%25AD%25D0%25BB%25D0%25BB%25D0%25B8%25D1%2581%25D0%25BE%25D0%25BD,_%25D0%25A5%25D0%25B0%25D1%2580%25D0%25BB%25D0%25B0%25D0%25BD">Harlan Ellison's</a> eponymous novella <a href="http://ru.wikipedia.org/wiki/%25D0%25AD%25D0%25BB%25D0%25BB%25D0%25B8%25D1%2581%25D0%25BE%25D0%25BD,_%25D0%25A5%25D0%25B0%25D1%2580%25D0%25BB%25D0%25B0%25D0%25BD">(Harlan Ellison)</a> , I Have No Mouth, and I Must Scream is one of the darkest quests of all time.  The pressing atmosphere does not let go until the very end. <br><br>  The near future.  Three superpowers, the United States, Russia and China, each trying to outperform their rivals, created supercomputers for waging war.  But they miscalculated.  Having united in a single whole, which calls itself AM, three supercomputers, using the power given to them by people, wiped humanity from the face of the earth.  In the living computer leaves only five who will serve him toys for endless torture. <br><br>  Last time I <a href="http://habrahabr.ru/post/184986/">described the 8-bit font</a> , but this time I managed to make out the 1-bit <a href="http://habrahabr.ru/post/184986/">font</a> . <br>  Both types of fonts are not encrypted or compressed, which greatly simplified the task. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Tools: IDA, <a href="http://ykhwong.x-y.net/">dosbox + debugger</a> , winhex, <a href="http://www.old-games.ru/forum/showthread.php%3Ft%3D44904">GBS</a> . <br><br>  KDPV <br><img src="https://habrastorage.org/getpro/habr/post_images/684/575/6c7/6845756c705e580ff9fa95955f55d2bd.png" alt="image"><br><a name="habracut"></a><br>  The problem is to find the font among the files. <br>  Obviously, such as FONTS, there are no files and folders, there is a 75.5 MB resource file scream.res. <br>  Using Process Monitor (ex FileMon) with a filter on dosbox, I compiled a table of file access orders, offsets and sizes. <br>  First I started watching the .res file with GBS and spoiling the blocks in scream.res in the order of their call, I found a place to store font images: <br><img src="https://habrastorage.org/getpro/habr/post_images/3f7/f8f/94d/3f7f8f94d150a44f954cb4e1f7bb0c61.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/88c/c03/0ec/88cc030ecc25fd04903822fa71c45b27.png"><br><br>  I sketched out my fonts, taken from Arial, did not fit the width and alignment, but there was confidence that the game could be translated, the codes of letters corresponded to cp1251. <br>  For drawing of characters, Excel will also fit: <br><img src="https://habrastorage.org/getpro/habr/post_images/5c8/47e/452/5c847e4523a617aaf93fefe8ba8ebb75.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/62e/182/d5b/62e182d5bef480d5b03b60699e34e306.png" alt="image"><br><br>  Later, a great link was suggested, comrades from SCUMMVM picked up the game, there is a <a href="http://wiki.scummvm.org/index.php/SAGA/Datafiles/Bitmap_Font">manual</a> . <br><br>  The font is 1-bit, that is, one pixel can be set to 8 pixels.  Several bytes form a row.  Several rows form a height, we get a block in memory (height * row length) bytes or a rectangle by resolution (height X (row * 8)). <br>  Visually in memory and in the game look like this (green and red bars indicate bytes): <br><img src="https://habrastorage.org/getpro/habr/post_images/207/141/a69/207141a691610495162d90504e4544cc.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/7ac/f8a/3ae/7acf8a3ae63763e894899f38745b0b3b.png" alt="image"><br><br>  The game uses a small R3 font and an interactive R1. <br><div class="spoiler">  <b class="spoiler_title">The structure of each font</b> <div class="spoiler_text">  The header is 1286 bytes and consists of <br>  ITE_FONTHEADER, 6 bytes <br>  INT16, c_height is the maximum character height, <br>  INT16 c_width is the maximum character width, the parameter is completely unnecessary, <br>  INT16 row_length - the length of the font image row (in bytes), <br><br>  Then I equated the 256 bytes, an array of indices, the indices themselves to cp1251 (AJay is the indices 192-255). <br>  INT16 index [256] - the number of the byte from which the symbol image begins. <br><br>  Then 256 bytes, array of widths of characters: <br>  BYTE width [256] - the width of the character in pixels, can be any reason, from 0 to infinity.  Well, up to 255 :) <br><br>  Then 256 bytes flag.  As I understand it from a series of experiments, it sets the left indent, in pixels. <br>  BYTE flag [256] Unknown character flag (either 0 or 1) <br><br>  Then 256 bytes - tracking, how many pixels of the character to draw.  Countdown from left to right from 0 to infinity.  Up to byte. <br>  BYTE tracking [256] - tracking <br><br>  Following the header, there is a block of data (row_length * c_height) bytes long. <br><br>  The formula for accessing any beginning of a series <br>  font_data + (row_length * y), <br>  where font_data is the pointer to the beginning of the font data, y is the row number. <br><br>  Each character occupies ((width [index] - 1) / 8) + 1 byte. <br></div></div><br><br>  After these data, the forum artist issued a beautiful, similar to the original dialogue font.  In the original it was reserved by any badges and umlauts enough bytes to fit the original and Russian font.  As a result, there was even 1 byte left in the stock, which I annulled.  I wrote a program for copying blocks from BMP, where a Russian font was drawn in a row, right in the game block. <br>  At the output, I received a cp1251 set of symbols, icons, numbers, English and Russian characters: <br><img src="https://habrastorage.org/getpro/habr/post_images/1bc/fdd/c26/1bcfddc26ebd4bd9455f8190395839ef.png"><br><br>  I proceeded to the second font: <br><img src="https://habrastorage.org/getpro/habr/post_images/476/dfe/9dd/476dfe9dd73aa696a6b3e7bc291095cf.png"><br><br>  Here there happened a joint.  In the original block there was very, very little space, that is, 14 stupid characters could be excluded from the proposed set, but this was clearly not enough for 66 Russian letters. <br><br>  First I tried to play the number of bytes in the row, thinking that the game initializes the buffers in height and row bytes.  I looked in winhex that the next block is the next font, but it is not used anywhere in the game.  Zeroed the block, increased the length of the row, but received the same set of characters, but with a shift.  It turned out that the size of the data buffer is registered somewhere else. <br>  I tried to leave the length of the row unchanged, but play with indices. <br>  I could not get anything out of all the ventures, climbed the garbage.  But it turned out, I forgot that at the end of the resource file there is a table of offsets and block sizes, it was necessary to play with it and everything would work out without patching.ehe file) <br><br>  Here I was confused as a dos header to throw out and remove the LE file, which can be inserted into IDA, that it happily recognizes as a 32-bit LE file.  I opened the file in winhex and found the line "*** NULL assignment detected", went up to MZ and started cutting to MZ. <br>  Thanks cracklab. <br><br>  Then another problem came out, how to match the address in the dosbox (looks like 180: 200c61) and the address in IDA (looks like cseg01: 0001AC1F) to see where the code is being executed and analyze it.  The site SCUMMVM offered a pretty stupid option, working, but extremely slow.  I'm waiting for IDADOS, when it will be possible to look at the code in IDA and immediately trace it with the power of dosbox.  But for now ... in IDA, we search for a sequence of about 10 bytes, what we see in the dosbox debuger. <br>  For this game, the formula is: <br>  the address in the dosbox is 1DFFFE h = the address in IDA. <br><br>  At this point, I knew the exact displacements of the beginnings of the font blocks and their sizes.  I began to look for these numbers in IDA with a simple search, but did not find anything. <br>  Then, in dosbox, the debuger set an interrupt to position the read pointer (int 21h, ah = 42h, LSEEK).  Before a call to CX: DX, there must be a value for how much to move the pointer: (CX * 65536) + DX. <br><br>  After a few jumps I found 2 consecutive calls to read 2 fonts from the game, just the ones that are used. <br>  The DX was the number I needed.  I rewound a little back and found a font initialization block that looks like this: <br>  mov eax, 6 (eventually patched on mov eax, 3) <br>  call InitFont <br>  mov eax, 8 <br>  call InitFont <br><br>  just in the block - it is 5 and 7 font.  After playing with different numbers, I looked at how unused fonts look in the game: <br><img src="https://habrastorage.org/getpro/habr/post_images/ff6/d15/61d/ff6d1561d29618d958c5ff081ceab519.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/240/0af/1b8/2400af1b825448101aa0b1423f14604f.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/fa1/c0a/93b/fa1c0a93bed37a3a0512bbfc15a8073b.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/64a/019/096/64a019096ff4be71ad8ece0831e607b7.png" alt="image"><br><br>  I looked at the sizes of the font blocks, chose the largest, transferred a small font block there, patched the executable file, made BMP import of Russian letters (for bmp 256 colors just one byte is equal to one pixel, casting a byte into bits is the second), corrected indices, tracking , width, row length, increased by one height, so that the letters above and below did not merge and finally got the final font. <br>  Retained the original characters, numbers, letters, added a number of Russian letters, including . <br><img src="https://habrastorage.org/getpro/habr/post_images/6d1/e0f/53b/6d1e0f53bcd380fe081d3360317a400f.png" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/194988/">https://habr.com/ru/post/194988/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../194974/index.html">Django doesn't work the way you think</a></li>
<li><a href="../194978/index.html">The State Duma opened the electronic Veche. A set of experts and the beginning of the discussion of bills</a></li>
<li><a href="../194980/index.html">We monitor CPU cores in Zabbix and create random counters in Low-level discovery</a></li>
<li><a href="../194982/index.html">Winners of Duke's Choice Awards 2013</a></li>
<li><a href="../194984/index.html">The Internet is always and everywhere. Lexand LXR-Mini Mini Review</a></li>
<li><a href="../194990/index.html">Quick invite friends to Facebook-a group</a></li>
<li><a href="../194992/index.html">Redesign Twitter apps for iOS7, but global changes are still ahead</a></li>
<li><a href="../194994/index.html">iMessage for Android</a></li>
<li><a href="../194998/index.html">Visiting the switch</a></li>
<li><a href="../195000/index.html">Minecraft shoved the whole UK</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>