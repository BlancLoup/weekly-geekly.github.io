<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring Private VLANs on Cisco</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article we will consider such an interesting, in my opinion, technology, as Private VLANs in theory and practice. 

 First, remember what VLAN...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring Private VLANs on Cisco</h1><div class="post__text post__text-html js-mediator-article">  In this article we will consider such an interesting, in my opinion, technology, as <b>Private VLANs</b> in theory and practice. <br><br>  First, remember what VLANs are.  <b>VLAN</b> is a separate subnet, a separate Broadcast domain, used for logical network segmentation, restriction of the broadcasting domain, security, etc. <br><br>  Typically, a network is divided into VLANs, then using a router-on-the-stick or multi-level switch (any device of level 3), routing is enabled (all traffic is allowed), and then, using access control lists, it is prescribed to whom, with whom and the protocol is allowed to communicate (or traffic control is applied based on the requirements of your organization‚Äôs security policy, as it would have been written in a Cisco tutorial). <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But what to do when, for example, the network is already divided, segmented, but it became necessary to isolate servers or groups of hosts from each other? <br><br>  Cisco, like other vendors, has additional tools to help limit the forwarding of traffic between hosts that are within the same subnet or control traffic within a VLAN.  For this, private VLANs (private VLANs), VLAN access list and protected ports are most often used. <br><br>  It should be noted that Private VLANs on Cisco are supported on Nexus models, as well as Catalyst <a href="http://www.cisco.com/en/US/products/hw/switches/ps708/products_tech_note09186a0080094830.shtml">starting at 3560 and up</a> . <br><br><h4>  First example. </h4><br>  On junior models switches there is such a thing as <b>private vlan edge</b> .  It is configured very simply - from the configuration mode of the interface we write the command (config-if) #switchport protected, as a result, the hosts connected to these ports will be isolated from each other at level 2 (that is, physically they will be connected to one switch, be on the same subnet, but will not ‚Äúsee‚Äù each other, while all other hosts will ‚Äúsee‚Äù.  One of the drawbacks of this mechanism is that it has a local value for the switch and does not scale (if we connect switch A and switch B with a trunk, for example, then the protected port of the switch A can ‚Äúsee‚Äù the protected port of the switch B). <br><br>  Let us dwell in more detail on private VLANs.  The main purpose of the article is to teach how to configure private VLANs, understand the terminology, as well as get a general idea of ‚Äã‚Äãwhere to use them. <br><br><h4>  The second example. </h4><br>  In the first example, the network is already divided into VLANs, but all of a sudden, host isolation was required, what should I do?  You will say that everything is very simple: we move the hosts that need to be isolated into separate VLANs, we enable routing, we isolate them from each other using access control lists.  To do this, simply create a few more subnets and that's it.  But, suddenly, you work in an organization where there is a very strict hierarchy of IP addressing and it is not so easy to get another private subnet or you do not have free VLANs? <br><br><table border="1"><tbody><tr><td colspan="3">  <strong>VLAN Support Matrix for Catalyst Swithes</strong> </td></tr><tr><td>  <strong>Type of Switch</strong> </td><td>  <strong>Maximum No.</strong>  <strong>of VLANs</strong> </td><td>  <strong>VLAN IDs Range</strong> </td></tr><tr><td>  Catalyst 2940 </td><td>  four </td><td>  1-1005 </td></tr><tr><td>  Catalyst 2960/2955 </td><td>  250 </td><td>  1-4094. </td></tr><tr><td>  Catalyst 2960 </td><td>  255 </td><td>  1-4094. </td></tr><tr><td>  Catalyst 2970/2550/3560/3750 </td><td>  1005 </td><td>  1-4094. </td></tr><tr><td>  Catalyst 2848G / 2980G / 4000/4500 </td><td>  4094 </td><td>  1-4094. </td></tr><tr><td>  Catalyst 6500 </td><td>  4094 </td><td>  1-4094. </td></tr></tbody></table><br>  <i>Fig.</i>  <i>- Isolation of servers in the DMZ.</i> <br><br><h4>  The third example. </h4><br>  You work in a provider and provide web hosting services for a large number of clients, you put web servers on the same network, and it turns out that there is no isolation, they can all ‚Äúhear‚Äù each other‚Äôs broadcasts, i.e.  pass traffic without filtering through the firewall.  If the hacker can get on one of the servers, he can deploy the attack on all servers, ‚Äúput‚Äù the entire server farm.  And, of course, customers want to isolate their servers from each other.  Especially PVLANs are relevant for providers providing layer 2 connections as a type of service, for client separation, client And of course, he doesn‚Äôt want his broadcast to reach client B, you know what security hole is opening here.  The traditional way out of the process of adding a new VLAN will not work here (method one VLAN per client), ‚Äúwe rest‚Äù on the scalability of the maximum number of VLANs 4094 minus the reserved ones.  The second problem is  VLAN is a separate subnet, you need to do subnetting and throw back another 2 addresses on each subnet (subnet and broadcast) pity, since these are ‚Äúwhite‚Äù addresses :). <br><br>  In these situations, <b>private VLANs</b> come to the <b>rescue</b> . <br><br>  A bit of terminology.  Private VLANs are divided into: <br><br><ul><li>  <strong>Primary</strong> - the main, main VLAN </li><li>  <strong>Secondary</strong> - secondary VLANs (there are 2 types of isolated and community), all of them must belong to the primary VLAN </li></ul><br><br>  Ports are divided into: <br><br><ul><li>  <strong>Promiscuous</strong> - this port ‚Äúsees‚Äù everything and it ‚Äúsees‚Äù everything, should be tied to the primary and all secondary VLANs. </li><li>  <strong>Private vlan host</strong> can belong to: </li><li><ul><li>  Isolated VLAN- ‚Äúsees‚Äù only a promiscuous port, does not ‚Äúsee‚Äù other ports even in its isolated vlan.  Must be bound to its isolated VLAN and primary VLAN </li><li>  Community VLAN- ‚Äúsees‚Äù only the ports in the given community vlan, to which it belongs, and the promiscuous port.  Must be tied to its community VLAN and primary VLAN. </li></ul></li></ul><br><h4>  General rules </h4><br>  Only one isolated vlan can be bound to one promiscuous port.  If you want a few isolated vlan, then each vlan should be associated with a separate promiscuous port. <br><br>  Usually, only one isolated vlan is created, no matter how many hosts there are, they will still not see each other. <br><br>  Unlike isolated VLAN, several VLAN communities can be tied to one promiscuous port. <br><br>  Consider the following topology: <br><br>  - All devices are on the same subnet 10.0.0.0/24 VLAN 10. <br>  - R4 and R5 must be isolated from each other and R2, R3 - i.e.  should have access only to the router interface. <br>  - R2 and R3 should be isolated from R4, R5, but see each other and the router. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/86b/1a8/607/86b1a86071231b8b693273d1e7bf63d7.jpg" alt="image"><br><br>  First we create 2 minor VLANs, 101 community VLANs and 102 isolated VLANs.  VLAN 10 we will make the main and we will tie to it minor (the order of entering commands does not matter). <br><br><pre><code class="bash hljs">SW1 (config)<span class="hljs-comment"><span class="hljs-comment"># vlan 101 private-vlan community ! vlan 102 private-vlan isolated ! vlan 10 private-vlan primary private-vlan association 101-102</span></span></code> </pre> <br><br>  Check: <br><br><pre> <code class="bash hljs">SW1<span class="hljs-comment"><span class="hljs-comment">#sh vlan private-vlan Primary Secondary Type Ports _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 10 101 community 10 102 isolated</span></span></code> </pre><br><br>  Next, we need to associate ports with VLANs. <br><br>  From the interface configuration mode, we first make it private vlan host (we tell it that it is an unusual port), with the second command we bind it to isolated and primary VLANs <br><br><pre> <code class="bash hljs">interface FastEthernet1/0/11 description SW1 &lt;-&gt; R2 switchport private-vlan host-association 10 101 switchport mode private-vlan host spanning-tree portfast end</code> </pre><br><br>  By analogy, we configure the fa1 / 0/4 interface <br><br><pre> <code class="bash hljs">interface FastEthernet1/0/4 description SW1 &lt;-&gt; R3 switchport private-vlan host-association 10 101 switchport mode private-vlan host spanning-tree portfast end</code> </pre><br><br>  We write the same thing on fa1 / 0/9 - first we tell him that he is a private vlan host and in order that he would understand that he belongs to the community vlan 102, we bind him to her, and also do not forget to tie him to the main Vlanu. <br><br><pre> <code class="bash hljs">interface FastEthernet2/0/2 description SW1 &lt;-&gt; R6 switchport private-vlan mapping 10 101-102 switchport mode private-vlan promiscuous</code> </pre><br><br>  Similarly, we configure fa1 / 0/9 <br><br><pre> <code class="bash hljs">interface FastEthernet2/0/11 description SW1 &lt;-&gt; R5 switchport private-vlan host-association 10 102 switchport mode private-vlan host spanning-tree portfast</code> </pre><br><br>  To the fa2 / 0/2 interface, since we want all the hosts to ‚Äúsee‚Äù and he ‚Äúsee‚Äù everyone, set the promiscuous mode and, according to the rule, assign it to the main and all secondary VLANs. <br><br><pre> <code class="bash hljs">interface FastEthernet2/0/2 description SW1 &lt;-&gt; R6 switchport private-vlan mapping 10 101-102 switchport mode private-vlan promiscuous</code> </pre><br><br>  Check the port association: <br><br><pre> <code class="bash hljs">SW1<span class="hljs-comment"><span class="hljs-comment">#sh vlan private-vlan Primary Secondary Type Ports _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 10 101 community Fa1/0/4, Fa1/0/11, Fa2/0/2 10 102 isolated Fa1/0/9, Fa2/0/2, Fa2/0/11</span></span></code> </pre><br><br>  The next step is optional, we create L3 SVI, to check that isolated and community hosts can ‚Äúsee‚Äù it in the same way as promiscuous port. <br><br><pre> <code class="bash hljs">SW<span class="hljs-comment"><span class="hljs-comment">#sh run int vlan 10 | beg int interface Vlan10 ip address 10.0.0.1 255.255.255.0 private-vlan mapping 101-102 end SW#sh int vlan 10 private-vlan mapping Interface Secondary VLANs _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ vlan 10 101,102 SW1#</span></span></code> </pre><br><br>  And now the most interesting thing is <b>how it all works</b> . <br><br>  Take a look at the table of MAC-addresses on the switch, it looks unusual.  It turns out that the MAC addresses of the hosts on the ports from which they were received are simultaneously associated with the primary and secondary VLANs! <br><br>  Why are hosts R4 and R5 in isolated vlan 102 not able to ‚Äúsee‚Äù anything except the router interface?  Please note that the MAC addresses of these hosts are within 102 isolated vlan switches, marked as BLOCKED, while the MAC address of the promiscuous router interface is within vlan 102, just like regular DYNAMIC. <br><br>  Now let's see why the router interface, labeled how promiscuous can ‚Äúcommunicate‚Äù with all interfaces, is that it can see them through the primary VLAN 10 (the first 5 lines in the table of MAC addresses). <br><br><pre> <code class="bash hljs"> SW<span class="hljs-comment"><span class="hljs-comment">#sh arp Protocol Address Age (min) Hardware Addr Type Interface Internet 10.0.0.2 8 0014.a925.72a0 ARPA Vlan10 pv 101 Internet 10.0.0.3 5 0014.a925.4cd8 ARPA Vlan10 pv 101 Internet 10.0.0.1 - 0014.a98c.87c1 ARPA Vlan10 Internet 10.0.0.6 70 0014.a909.78d1 ARPA Vlan10 Internet 10.0.0.4 4 0014.a909.7870 ARPA Vlan10 pv 102 Internet 10.0.0.5 4 0014.a925.6460 ARPA Vlan10 pv 102 SW#sh mac-address-table Mac Address Table _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ Vlan Mac Address Type Ports _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ All 0100.0ccc.cccc STATIC CPU .... 10 0014.a909.7870 DYNAMIC pv Fa1/0/9 10 0014.a909.78d1 DYNAMIC Fa2/0/2 10 0014.a925.4cd8 DYNAMIC pv Fa1/0/4 10 0014.a925.6460 DYNAMIC pv Fa2/0/11 10 0014.a925.72a0 DYNAMIC pv Fa1/0/11 101 0014.a909.78d1 DYNAMIC pv Fa2/0/2 101 0014.a925.4cd8 DYNAMIC Fa1/0/4 101 0014.a925.72a0 DYNAMIC Fa1/0/11 102 0014.a909.7870 BLOCKED Fa1/0/9 102 0014.a909.78d1 DYNAMIC pv Fa2/0/2 102 0014.a925.6460 BLOCKED Fa2/0/11 SW1#</span></span></code> </pre><br><br>  In the next article we will consider the subtleties of scalability of private VLANs, both between switches supporting this technology and on / through regular switches, which even do not know such a thing as a private VLAN (no, there is no double frame tagging) and types of special trunks . </div><p>Source: <a href="https://habr.com/ru/post/165195/">https://habr.com/ru/post/165195/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165181/index.html">Runetology (180): Victor Kozlov, co-founder of Reksoft, Ozon, ASSIST, CleverPumpkin</a></li>
<li><a href="../165185/index.html">Introduction to HDInsight</a></li>
<li><a href="../165189/index.html">Windows Messenger merges into Skype</a></li>
<li><a href="../165191/index.html">Dell PowerEdge PCI-E SSD</a></li>
<li><a href="../165193/index.html">How to participate in the open source project Chromium</a></li>
<li><a href="../165197/index.html">RegEx Selector for jQuery</a></li>
<li><a href="../165199/index.html">Corning introduced an optical USB cable</a></li>
<li><a href="../165201/index.html">Many reasons to be a manager</a></li>
<li><a href="../165203/index.html">Tao development of reference documentation for IT-product</a></li>
<li><a href="../165207/index.html">Static IP address lifetime in Windows Azure</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>