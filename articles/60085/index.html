<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manipulate System.Drawing.Bitmap</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The System.Drawing.Bitmap class is very useful in the .NET infrastructure, because Allows you to read and save files of various graphic formats. The o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Manipulate System.Drawing.Bitmap</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/af4/299/763/af4299763cb29305e085211e842d1328.jpg" align="right">  The <code>System.Drawing.Bitmap</code> class is very useful in the .NET infrastructure, because  Allows you to read and save files of various graphic formats.  The only problem is that it is not very useful for pixel-by-pixel processing ‚Äî for example, if you need to convert the bitmap to b / w.  Under the cut - a small sketch on this topic. <br><a name="habracut"></a><br>  Suppose we have two bitmaps, one of which is read from the file, and the other must contain a b / w conversion: <br><blockquote> <code><font color="black"><font color="#008000">//  </font> <br> sourceBitmap = (Bitmap) Image.FromFile( <font color="#800000">"Zap.png"</font> );&lt;br/&gt; <br> <font color="#008000">//      </font> <br> targetBitmap = <font color="#0000FF">new</font> Bitmap(sourceBitmap.Width, sourceBitmap.Height, sourceBitmap.PixelFormat);&lt;br/&gt; <br></font></code> </blockquote>  We want <code>targetBitmap</code> to be <code>sourceBitmap</code> , only black and white.  In fact, in C # this is done simply: <br><br><blockquote> <code><font color="black"><font color="#0000FF">void</font> Na√ØveBlackAndWhite()&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#0000FF">for</font> ( <font color="#0000FF">int</font> y = 0; y &lt; sourceBitmap.Height; ++y)&lt;br/&gt; <br> <font color="#0000FF">for</font> ( <font color="#0000FF">int</font> x = 0; x &lt; sourceBitmap.Width; ++x)&lt;br/&gt; <br> {&lt;br/&gt; <br> Color c = sourceBitmap.GetPixel(x, y);&lt;br/&gt; <br> <font color="#0000FF">byte</font> rgb = ( <font color="#0000FF">byte</font> )(0.3 * cR + 0.59 * cG + 0.11 * cB);&lt;br/&gt; <br> targetBitmap.SetPixel(x, y, Color.FromArgb(cA, rgb, rgb, rgb));&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote>  This solution is clear and simple, but unfortunately the horror as ineffective.  To get more "quick" code, you can try to write the whole thing in C ++.  First, create a structure to store the color values ‚Äã‚Äãof a pixel. <br><br><blockquote> <code><font color="black"><font color="#008000">//      32bpp RGBA</font> <br> <font color="#0000FF">struct</font> Pixel {&lt;br/&gt; <br> <font color="#0000FF">BYTE</font> Blue;&lt;br/&gt; <br> <font color="#0000FF">BYTE</font> Green;&lt;br/&gt; <br> <font color="#0000FF">BYTE</font> Red;&lt;br/&gt; <br> <font color="#0000FF">BYTE</font> Alpha;&lt;br/&gt; <br> };&lt;br/&gt; <br></font></code> </blockquote>  Now you can write a function that will make the pixel black and white: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote> <code><font color="black">Pixel MakeGrayscale(Pixel&amp; pixel)&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#0000FF">const</font> <font color="#0000FF">BYTE</font> scale = <font color="#0000FF">static_cast</font> &lt; <font color="#0000FF">BYTE</font> &gt;(0.3 * pixel.Red + 0.59 * pixel.Green + 0.11 * pixel.Blue);&lt;br/&gt; <br> Pixel p;&lt;br/&gt; <br> p.Red = p.Green = p.Blue = scale;&lt;br/&gt; <br> p.Alpha = pixel.Alpha;&lt;br/&gt; <br> <font color="#0000FF">return</font> p;&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote>  Now we actually write the bypass function itself: <br><br><blockquote> <code><font color="black">CPPSIMDLIBRARY_API <font color="#0000FF">void</font> AlterBitmap( <font color="#0000FF">BYTE</font> * src, <font color="#0000FF">BYTE</font> * dst, <font color="#0000FF">int</font> width, <font color="#0000FF">int</font> height, <font color="#0000FF">int</font> stride)&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#0000FF">for</font> ( <font color="#0000FF">int</font> y = 0; y &lt; height; ++y) {&lt;br/&gt; <br> <font color="#0000FF">for</font> ( <font color="#0000FF">int</font> x = 0; x &lt; width; ++x)&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#0000FF">int</font> offset = x * <font color="#0000FF">sizeof</font> (Pixel) + y * stride;&lt;br/&gt; <br> Pixel&amp; s = * <font color="#0000FF">reinterpret_cast</font> &lt;Pixel*&gt;(src + offset);&lt;br/&gt; <br> Pixel&amp; d = * <font color="#0000FF">reinterpret_cast</font> &lt;Pixel*&gt;(dst + offset);&lt;br/&gt; <br> <font color="#008000">//  d</font> <br> d = MakeGrayscale(s);&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote>  And then it remains only to use it from C #. <br><br><blockquote> <code><font color="black"><font color="#0000FF">void</font> UnmanagedBlackAndWhite()&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#008000">// ""   </font> <br> Rectangle rect = <font color="#0000FF">new</font> Rectangle(0, 0, sourceBitmap.Width, sourceBitmap.Height);&lt;br/&gt; <br> BitmapData srcData = sourceBitmap.LockBits(rect, ImageLockMode.ReadWrite, sourceBitmap.PixelFormat);&lt;br/&gt; <br> BitmapData dstData = targetBitmap.LockBits(rect, ImageLockMode.ReadWrite, sourceBitmap.PixelFormat);&lt;br/&gt; <br> <font color="#008000">//   unmanaged   </font> <br> AlterBitmap(srcData.Scan0, dstData.Scan0, srcData.Width, srcData.Height, srcData.Stride);&lt;br/&gt; <br> <font color="#008000">//  </font> <br> sourceBitmap.UnlockBits(srcData);&lt;br/&gt; <br> targetBitmap.UnlockBits(dstData);&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote>  This improved the speed, but I wanted more.  I added the OpenMP directive before the <code>y</code> cycle and received a predictable acceleration of 2 times.  Then I wanted to experiment and try to apply SIMD as well.  For this, I wrote this, not very readable, code: <br><br><blockquote> <code><font color="black">CPPSIMDLIBRARY_API <font color="#0000FF">void</font> AlterBitmap( <font color="#0000FF">BYTE</font> * src, <font color="#0000FF">BYTE</font> * dst, <font color="#0000FF">int</font> width, <font color="#0000FF">int</font> height, <font color="#0000FF">int</font> stride)&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#008000">//     /</font> <br> <font color="#0000FF">static</font> <font color="#0000FF">__m128</font> factor = _mm_set_ps(1.0f, 0.3f, 0.59f, 0.11f);&lt;br/&gt; <br> #pragma omp parallel <font color="#0000FF">for</font> &lt;br/&gt; <br> <font color="#0000FF">for</font> ( <font color="#0000FF">int</font> y = 0; y &lt; height; ++y)&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#0000FF">const</font> <font color="#0000FF">int</font> offset = y * stride;&lt;br/&gt; <br> <font color="#0000FF">__m128i</font> * s = ( <font color="#0000FF">__m128i</font> *)(src + offset);&lt;br/&gt; <br> <font color="#0000FF">__m128i</font> * d = ( <font color="#0000FF">__m128i</font> *)(dst + offset);&lt;br/&gt; <br> <font color="#0000FF">for</font> ( <font color="#0000FF">int</font> x = 0; x &lt; (width &gt;&gt; 2); ++x) {&lt;br/&gt; <br> <font color="#008000">//   4   </font> <br> <font color="#0000FF">for</font> ( <font color="#0000FF">int</font> p = 0; p &lt; 4; ++p)&lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#008000">//  </font> <br> <font color="#0000FF">__m128</font> pixel;&lt;br/&gt; <br> pixel.m128_f32[0] = s-&gt;m128i_u8[(p&lt;&lt;2)];&lt;br/&gt; <br> pixel.m128_f32[1] = s-&gt;m128i_u8[(p&lt;&lt;2)+1];&lt;br/&gt; <br> pixel.m128_f32[2] = s-&gt;m128i_u8[(p&lt;&lt;2)+2];&lt;br/&gt; <br> pixel.m128_f32[3] = s-&gt;m128i_u8[(p&lt;&lt;2)+3];&lt;br/&gt; <br> <font color="#008000">//    -  !</font> <br> pixel = _mm_mul_ps(pixel, factor);&lt;br/&gt; <br> <font color="#008000">//  </font> <br> <font color="#0000FF">const</font> <font color="#0000FF">BYTE</font> sum = ( <font color="#0000FF">BYTE</font> )(pixel.m128_f32[0] + pixel.m128_f32[1] + pixel.m128_f32[2]);&lt;br/&gt; <br> <font color="#008000">//    </font> <br> d-&gt;m128i_u8[p&lt;&lt;2] = d-&gt;m128i_u8[(p&lt;&lt;2)+1] = d-&gt;m128i_u8[(p&lt;&lt;2)+2] = sum;&lt;br/&gt; <br> d-&gt;m128i_u8[(p&lt;&lt;2)+3] = ( <font color="#0000FF">BYTE</font> )pixel.m128_f32[3];&lt;br/&gt; <br> }&lt;br/&gt; <br> s++;&lt;br/&gt; <br> d++;&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote>  Despite the fact that this code does 4 multiplication operations at a time ( <code>_mm_mul_ps</code> instruction), all these conversions yielded no gain compared to the usual operations - rather, on the contrary, the algorithm began to work slower.  Here are the results of the functions in the 360 ‚Äã‚Äã√ó 480 image.  A 2-core MacBook with 4GB of RAM was used, the results averaged. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a0d/42e/7ed/a0d42e7ed5f11564811066651ef3eec6.jpg"><br><br><br>  And here is the final result: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e33/929/8f0/e339298f02590ca4bbb89c778a404e50.jpg"><br><br><br>  Findings: <br><br><ul><li>  <code>SetPixel/GetPixel</code> is evil, you should not touch them. <br></li><li>  OpenMP continues to delight, giving linear scalability. <br></li><li>  Using SIMD does not guarantee improved performance.  But it gives a lot of trouble. <br></li></ul><br>  If any reader is ready to write an even more efficient algorithm, you are welcome!  I will test and publish it right here. <br><br> <a href="http://spbalt.net/"><img src="https://habrastorage.org/getpro/habr/post_images/bb8/08f/a66/bb808fa662a708110219e4efc02b1163.png"></a> </div><p>Source: <a href="https://habr.com/ru/post/60085/">https://habr.com/ru/post/60085/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../60078/index.html">MonIT + M \ MonIT = simple and free monitoring of several servers</a></li>
<li><a href="../60079/index.html">IronPython 2.6 CTP for .NET 4.0 Beta 1 released</a></li>
<li><a href="../60082/index.html">A little trick or background-repeat type in IE6</a></li>
<li><a href="../60083/index.html">Richard Stallman during a lecture picked out something from his foot and chewed</a></li>
<li><a href="../60084/index.html">How to kill a hung application in Windows with one keystroke</a></li>
<li><a href="../60086/index.html">Corruption, tenders and power</a></li>
<li><a href="../60090/index.html">Load on demand and jQuery</a></li>
<li><a href="../60092/index.html">The second day of SEF in Minsk</a></li>
<li><a href="../60094/index.html">HTC Iolite review - part 2 - software-battery</a></li>
<li><a href="../60095/index.html">Combing Traffic - Dynamic Shaper on Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>