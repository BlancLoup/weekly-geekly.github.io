<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Backup, part 4: zbackup, restic, borgbackup review and testing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will be considered software tools for backup, which by splitting the data stream into separate components (chunks), form a repository. 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Backup, part 4: zbackup, restic, borgbackup review and testing</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/pr/ob/cd/probcd0kvhmv8mspkq9espvxzsq.png"></p><br><p>  This article will be considered software tools for backup, which by splitting the data stream into separate components (chunks), form a repository. </p><br><p>  The components of the repository can be further compressed and encrypted, and most importantly, during repeated backup processes, they can be reused. </p><br><p>  A backup in a similar repository is a named chain of related components, for example, based on various hash functions. </p><br><p>  There are several similar solutions, I will focus on 3: zbackup, borgbackup and restic. </p><a name="habracut"></a><br><h3 id="ozhidaemye-rezultaty">  Expected results </h3><br><p>  Since all applicants in one way or another require the creation of a repository, one of the most important factors will be an estimate of the repository size.  In the ideal case, its size should be no more than 13 GB in accordance with the adopted method, or even less, subject to good optimization. </p><br><p>  It is also highly desirable to be able to create backup copies of files directly, without using tar archivers, as well as working with ssh / sftp without additional tools like rsync and sshfs. </p><br><p>  <strong>Behavior when creating backups:</strong> </p><br><ol><li>  The size of the repository will be equal to the size of the changes, or less. </li><li>  A large processor load is expected when using compression and / or encryption, and a sufficiently large load on the network and disk subsystem is likely if the backup and / or encryption process runs on the backup storage server. </li><li>  If the repository is damaged, a delayed error is likely both when creating new backups and when attempting to restore.  It is necessary to plan additional measures to ensure the integrity of the repository or use the built-in tools to check its integrity. </li></ol><br><p>  Working with tar is taken as a reference value, as was shown in one of the previous articles. </p><br><h3 id="testirovanie-zbackup">  Zbackup testing </h3><br><p>  The general mechanism of zbackup is that the program finds in the data stream supplied at the input areas containing the same data, then optionally compresses them, encrypts, saving each area only 1 time. </p><br><p>  For deduplication, a 64-bit ring hash function with a sliding window is used for byte-by-byte checking for coincidence with already existing data blocks (similar to how it is implemented in rsync). </p><br><p>  For compression, lzma and lzo are used in a multi-threaded version, and for encryption - aes.  In the latest versions there is an opportunity in the future to delete old data from the repository. <br>  The program is written in C ++ with minimal dependencies.  The author apparently was inspired by the unix-way, so the program takes data to stdin when creating backups, producing a similar data stream to stdout when restoring.  Thus, zbackup can be used as a very good "brick" when writing your own backup solutions.  For example, the author of the article, this program is the main backup tool for home machines from about 2014. </p><br><p>  Normal tar will be used as the data stream, unless stated otherwise. </p><br><div class="spoiler">  <b class="spoiler_title">Let's see what the results will be:</b> <div class="spoiler_text"><p>  Verification of the work was carried out in 2 versions: </p><br><ol><li>  a repository is created and zbackup is launched on the server with the original data, then the contents of the repository are transferred to the backup storage server. </li><li>  a repository is created on the backup storage server, zbackup is started via ssh on the backup storage server, and data is output to it via pipe. </li></ol><br><p>  The results of the first variant were as follows: 43m11s - when using an unencrypted repository and the lzma compressor, 19m13s - when replacing the compressor with lzo. </p><br><p>  The load on the server with the source data was as follows (an example with lzma is shown, with lzo there was about the same picture, but the rsync share was about a quarter of the time): </p><br><p> <a href=""><img src="https://habrastorage.org/webt/pp/d3/hs/ppd3hsaxn_kffamwcrwstrb_sds.png"></a> </p><br><p>  It is clearly seen that this backup process is only suitable for relatively rare and small changes.  It is also highly desirable to limit the work of zbackup to 1 stream, otherwise there will be a very high load on the processor, since  The program is very well able to work in multiple threads.  The load on the disk was small, which in general with the modern ssd-based disk subsystem will be imperceptible.  You can also clearly see the start of the process of synchronizing repository data to a remote server, the speed is comparable to normal rsync and depends on the performance of the disk subsystem of the backup storage server.  The downside is the storage of the local repository and, as a result, duplication of data. </p><br><p>  More interesting and applicable in practice is the second option with running zbackup immediately on the backup storage server. </p><br><p>  To begin, work without encryption with the lzma compressor will be tested: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wf/m4/g0/wfm4g0zjf3cktbvihsmmtbg-hcu.png"></a> </p><br><p>  The time of each test run: </p><br><div class="scrollable-table"><table><thead><tr><th>  Run 1 </th><th>  Run 2 </th><th>  Run 3 </th></tr></thead><tbody><tr><td>  39m45s </td><td>  40m20s </td><td>  40m3s </td></tr><tr><td>  7m36s </td><td>  8m3s </td><td>  7m48s </td></tr><tr><td>  15m35s </td><td>  15m48s </td><td>  15m38s </td></tr></tbody></table></div><br><p>  If you enable encryption using aes, the results are pretty close: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/mf/7p/yv/mf7pyvnly6bmjtxbno88mjtrtn4.png"></a> </p><br><p>  Operating time on the same data, with encryption: </p><br><div class="scrollable-table"><table><thead><tr><th>  Run 1 </th><th>  Run 2 </th><th>  Run 3 </th></tr></thead><tbody><tr><td>  43m40s </td><td>  44m12s </td><td>  44m3s </td></tr><tr><td>  8m3s </td><td>  8m15s </td><td>  8m12s </td></tr><tr><td>  15m0s </td><td>  15m40s </td><td>  15m25s </td></tr></tbody></table></div><br><p>  If you combine encryption with compression on lzo, it turns out like this: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/38/cz/tb/38cztb4tuzxtgsorc6uysied59k.png"></a> </p><br><p>  Working hours: </p><br><div class="scrollable-table"><table><thead><tr><th>  Run 1 </th><th>  Run 2 </th><th>  Run 3 </th></tr></thead><tbody><tr><td>  18m2s </td><td>  18m15s </td><td>  18m12s </td></tr><tr><td>  5m13s </td><td>  5m24s </td><td>  5m20s </td></tr><tr><td>  8m48s </td><td>  9m3s </td><td>  8m51s </td></tr></tbody></table></div></div></div><br><p>  The size of the resulting repository was relatively the same and was 13GB.  This means that deduplication works correctly.  Also on already compressed data, the use of lzo gives a tangible effect, with the total running time zbackup comes close to duplicity / duplicati, but lags 2-5 times behind the base librsync. </p><br><p>  The advantages are obvious - saving disk space on the backup storage server.  As for the repository verification tools - they are not provided by the zbackup, it is recommended to use a fail-safe disk array or a cloud provider. </p><br><p>  In general, a very good impression, despite the fact that the project is about 3 years in place (the last feature request was about a year ago, but without an answer). </p><br><h3 id="testirovanie-borgbackup">  Borgbackup testing </h3><br><p>  Borgbackup is a fork of attic, another similar to the zbackup system.  It is written in python, it has a list of features similar to zbackup, but it can additionally: </p><br><ul><li>  Mount backups through fuse </li><li>  Check repository contents </li><li>  Work in client-server mode </li><li>  Use different compressors for data, as well as a heuristic definition of the file type during its compression. </li><li>  2 encryption options, aes and blake </li><li>  Built-in tool for </li></ul><br><div class="spoiler">  <b class="spoiler_title">performance checks</b> <div class="spoiler_text"><p>  borgbackup benchmark crud ssh: // backup_server / repo / path local_dir </p><br><p>  The results were as follows: </p><br><p>  CZ-BIG 96.51 MB / s (10 <em>100.00 MB all-zero files: 10.36s)</em> <em><br></em>  <em>RZ-BIG 57.22 MB / s (10</em> 100.00 MB all-zero files: 17.48s) <br>  UZ-BIG 253.63 MB / s (10 <em>100.00 MB all-zero files: 3.94s)</em> <em><br></em>  <em>DZ-BIG 351.06 MB / s (10</em> 100.00 MB all-zero files: 2.85s) <br>  CR-BIG 34.30 MB / s (10 <em>100.00 MB random files: 29.15s)</em> <em><br></em>  <em>RR-BIG 60.69 MB / s (10</em> 100.00 MB random files: 16.48s) <br>  UR-BIG 311.06 MB / s (10 <em>100.00 MB random files: 3.21s)</em> <em><br></em>  <em>DR-BIG 72.63 MB / s (10</em> 100.00 MB random files: 13.77s) <br>  CZ-MEDIUM 108.59 MB / s (1000 <em>1.00 MB all-zero files: 9.21s)</em> <em><br></em>  <em>RZ-MEDIUM 76.16 MB / s (1000</em> 1.00 MB all-zero files: 13.13s) <br>  UZ-MEDIUM 331.27 MB / s (1000 <em>1.00 MB all-zero files: 3.02s)</em> <em><br></em>  <em>DZ-MEDIUM 387.36 MB / s (1000</em> 1.00 MB all-zero files: 2.58s) <br>  CR-MEDIUM 37.80 MB / s (1000 <em>1.00 MB random files: 26.45s)</em> <em><br></em>  <em>RR-MEDIUM 68.90 MB / s (1000</em> 1.00 MB random files: 14.51s) <br>  UR-MEDIUM 347.24 MB / s (1000 <em>1.00 MB random files: 2.88s)</em> <em><br></em>  <em>DR-MEDIUM 48.80 MB / s (1000</em> 1.00 MB random files: 20.49s) <br>  CZ-SMALL 11.72 MB / s (10,000 <em>10.00 kB all-zero files: 8.53s)</em> <em><br></em>  <em>RZ-SMALL 32.57 MB / s (10,000</em> 10.00 kB all-zero files: 3.07s) <br>  UZ-SMALL 19.37 MB / s (10000 <em>10.00 kB all-zero files: 5.16s)</em> <em><br></em>  <em>DZ-SMALL 33.71 MB / s (10000</em> 10.00 kB all-zero files: 2.97s) <br>  CR-SMALL 6.85 MB / s (10,000 <em>10.00 kB random files: 14.60s)</em> <em><br></em>  <em>RR-SMALL 31.27 MB / s (10,000</em> 10.00 kB random files: 3.20s) <br>  UR-SMALL 12.28 MB / s (10,000 <em>10.00 kB random files: 8.14s)</em> <em><br></em>  <em>DR-SMALL 18.78 MB / s (10,000</em> 10.00 kB random files: 5.32s) </p></div></div><br><p>  During testing, heuristics will be used for compression with file type definition (compression auto), and the results will be as follows: </p><br><div class="spoiler">  <b class="spoiler_title">First, let's check the work without encryption:</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/fe/ep/xm/feepxmsoyorprvvt5h00tuj2spg.png"></a> </p><br><p>  Working hours: </p><br><div class="scrollable-table"><table><thead><tr><th>  Run 1 </th><th>  Run 2 </th><th>  Run 3 </th></tr></thead><tbody><tr><td>  4m6s </td><td>  4m10s </td><td>  4m5s </td></tr><tr><td>  56s </td><td>  58s </td><td>  54s </td></tr><tr><td>  1m26s </td><td>  1m34s </td><td>  1m30s </td></tr></tbody></table></div><br><p>  If you enable repository authorization (authenticated mode), the results will be obtained by your friends: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/3c/qe/kx/3cqekxviy9rzhafckbi0tidjxn4.png"></a> </p><br><p>  Working hours: </p><br><div class="scrollable-table"><table><thead><tr><th>  Run 1 </th><th>  Run 2 </th><th>  Run 3 </th></tr></thead><tbody><tr><td>  4m11s </td><td>  4m20s </td><td>  4m12s </td></tr><tr><td>  1m0s </td><td>  1m3s </td><td>  1m2s </td></tr><tr><td>  1m30s </td><td>  1m34s </td><td>  1m31s </td></tr></tbody></table></div><br><p>  When activating aes encryption, the results did not deteriorate much: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/oa/yz/zl/oayzzliqw8zixlppy_idv2l8gzm.png"></a> </p><br><div class="scrollable-table"><table><thead><tr><th>  Run 1 </th><th>  Run 2 </th><th>  Run 3 </th></tr></thead><tbody><tr><td>  4m55s </td><td>  5m2s </td><td>  4m58s </td></tr><tr><td>  1m0s </td><td>  1m2s </td><td>  1m0s </td></tr><tr><td>  1m49s </td><td>  1m50s </td><td>  1m50s </td></tr></tbody></table></div><br><p>  And if you change aes to blake, the situation will improve: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/df/kh/ay/dfkhayqoecs9hw_c_aj2fmxjkbu.png"></a> </p><br><p>  Working hours: </p><br><div class="scrollable-table"><table><thead><tr><th>  Run 1 </th><th>  Run 2 </th><th>  Run 3 </th></tr></thead><tbody><tr><td>  4m33s </td><td>  4m43s </td><td>  4m40s </td></tr><tr><td>  59s </td><td>  1m0s </td><td>  1m0s </td></tr><tr><td>  1m38s </td><td>  1m43s </td><td>  1m40s </td></tr></tbody></table></div></div></div><br><p>  As in the case of zbackup, the size of the repository was 13 GB and even slightly smaller, which is generally expected.  Very pleased with the time of work, it is comparable to solutions based on librsync, providing much wider opportunities.  I was also pleased with the ability to set various parameters via environment variables, which gives a very serious advantage when using borgbackup in automatic mode.  Also pleased with the load when backing up: judging by the processor load - borgbackup works in 1 stream. </p><br><p>  Special disadvantages when using was not found. </p><br><h3 id="testirovanie-restic">  Restic testing </h3><br><p>  Despite the fact that restic is a fairly new solution (the first 2 candidates have been known since 2013 and older), it has quite good characteristics.  Written on Go. </p><br><p>  When compared with zbackup, it additionally gives: </p><br><ul><li>  Checking the integrity of the repository (including checking in parts). </li><li>  A huge list of supported protocols and backup storage providers, as well as rclone-rsync support for cloud solutions. </li><li>  Comparison of 2 backups between each other. </li><li>  Mounting the repository via fuse. </li></ul><br><p> In general, the list of opportunities is quite close to borgbackup, in some places more, in some places less.  Of the features - the inability to disable encryption, and therefore, backup copies will always be encrypted.  Let's take a practical look at what can be squeezed out of this software: </p><br><div class="spoiler">  <b class="spoiler_title">The results were as follows:</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/tq/k5/xn/tqk5xn1xknn33dydmslqofrjfvs.png"></a> </p><br><p>  Working hours: </p><br><div class="scrollable-table"><table><thead><tr><th>  Run 1 </th><th>  Run 2 </th><th>  Run 3 </th></tr></thead><tbody><tr><td>  5m25s </td><td>  5m50s </td><td>  5m38s </td></tr><tr><td>  35s </td><td>  38s </td><td>  36s </td></tr><tr><td>  1m54s </td><td>  2m2s </td><td>  1m58s </td></tr></tbody></table></div></div></div><br><p>  The results of the work are also comparable with rsync-based solutions and, in general, are very close to borgbackup, but the processor load is higher (several threads are running) and sawtooth. </p><br><p>  Most likely, the program rests on the performance of the disk subsystem on the data storage server, as it was with rsync.  The size of the repository was 13GB, like in zbackup or borgbackup, there were no obvious drawbacks with this solution. </p><br><h3 id="rezultaty">  results </h3><br><p>  In fact, all candidates obtained similar indicators, but at a different price.  The borgbackup proved to be the best of all, a bit slower - restic, zbackup, probably, you should not start applying, <br>  and if it is already in use, try changing to borgbackup or restic. </p><br><h3 id="vyvody">  findings </h3><br><p>  The most promising solution is restic, because  it is he who has the best ratio of performance to speed, but for now let's not rush to general conclusions. </p><br><p>  Borgbackup is in principle no worse, but zbackup is probably better to replace.  True, to ensure the operation of the rule 3-2-1 zbackup can still be used.  For example, in addition to backup tools based on (lib) rsync. </p><br><h3 id="anons">  Announcement </h3><br><p>  <a href="https://habr.com/ru/company/southbridge/blog/449282/">Backup, Part 1: Why do I need backup, review of methods, technologies</a> <br>  <a href="https://habr.com/ru/company/southbridge/blog/452630/">Backup, part 2: Review and test rsync-based backup tools</a> <br>  <a href="https://habr.com/ru/company/southbridge/blog/454420/">Backup, part 3: Review and testing duplicity, duplicati</a> <br>  <a href="https://habr.com/ru/company/southbridge/blog/454734/">Backup, part 4: zbackup, restic, borgbackup review and testing</a> <br>  Backup, Part 5: Bacula and veeam backup for linux testing <br>  Backup Part 6: Comparing Backup Tools <br>  Backup, Part 7: Conclusions </p><br><p>  <u>Publisher:</u> Pavel Demkovich </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/454734/">https://habr.com/ru/post/454734/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454716/index.html">Employees do not want a new software - go on about or bend your line?</a></li>
<li><a href="../454720/index.html">How to revive the documentation?</a></li>
<li><a href="../454728/index.html">Internet access is open: LUWRAIN technology helps blind users</a></li>
<li><a href="../45473/index.html">Multiplication table</a></li>
<li><a href="../454730/index.html">Allure Server meetup: video reports</a></li>
<li><a href="../454738/index.html">Visual Studio 2019 support in PVS-Studio</a></li>
<li><a href="../454742/index.html">At least one trick of Vim, about which you did not know</a></li>
<li><a href="../454744/index.html">Overview of Java track reports from the RigaDevDays conference</a></li>
<li><a href="../454748/index.html">MongoDB Survival Guide</a></li>
<li><a href="../45475/index.html">PostgreSQL horizontal scaling using PL / Proxy.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>