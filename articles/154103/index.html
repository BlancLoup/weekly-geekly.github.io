<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Jpg, transparency, canvas, animation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, friends! 

 I offer you a small lesson on the theme of animation of sprites with alpha channel on HTML5 canvas. 

 Preamble. 
 First draw somet...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Jpg, transparency, canvas, animation</h1><div class="post__text post__text-html js-mediator-article">  Hello, friends! <br><br>  I offer you a small lesson on the theme of animation of sprites with alpha channel on HTML5 canvas. <br><br><h4>  Preamble. </h4><br>  First draw something <br><img src="https://habrastorage.org/getpro/habr/post_images/eb6/1c3/de2/eb61c3de24ee6d5080411017783f8127.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Why round and yellow?  Because Douglas Adams in ‚ÄúThe Hitchhiker's Guide to the Galaxy‚Äù has this Slartibartfast - a very touching uncle, has a prize for the coastlines in the construction of the Earth.  Therefore, just in case, we will animate the yellow star. <br><br><a name="habracut"></a>  Next, we animate the star in a sequence of 256 frames with a frame size of 256x256 pixels. <br>  Those 256, these 256 and 256 are taken only for the sake of example.  Animation can be both shorter and smaller, however, as well as longer and larger - it all depends on your goals.  I assume that 256x256 pixels now is such a quite normal size for a sprite: not too big and not too small.  Of course, earlier, when the grass was greener, and the sprites were more modest than 16x16 or 32x32, but we will be experimenting as if for growth. <br>  256 frames is also not so much, but not so much: depending on the frame rate, you can get a 10-20-30 second sequence. <br><br>  Until now, all without surprises, until you multiply the dimensions of the sides of the frame, duration and depth: <br><br>  256 x 256 x 256 x 4 = 64 MB <br><br>  But!  64 megabytes without compression is a little bit fat for the sprite.  If you skip all 256 frames into a 16x16 matrix and save this fish to PNG with an alpha channel (everything happens in Adobe After Effects), you will get 18.6 MB at the output, which, although not 64, is still a lot.  For those who are interested to look at this PNG here is a <a href="">reference</a> . <br><br><h4>  Squeeze! </h4><br>  Does After Effect really carelessly about PNG compression?  To bring the resulting grid to a sane size, I tried to optimize the rendered PNG using the OptiPNG and PNGOut utilities.  Both utilities were run in with various options up to extreme, but as a result, in the best case, compression was optimized to an enchanting 1.5 percent, which clearly does not meet the expectations.  Therefore, this animation was converted into a couple of files without loss of quality (the same PNG) but separately RGB and Alpha, and then using Image Optimizer, they were converted into a pair of JPEGs.  To facilitate the work of the JPG compressor (is this the right word?), The background on the sequence that contains the RGB layers before rendering is forcibly filled with cosmic yellow instead of cosmic black. <br><br>  Depending on the degree of compression, we get pairs of JPEGs of different weights: <br><table><tbody><tr><th>  Compression </th><th>  ten% </th><th>  15% </th><th>  25% </th><th>  50% </th><th>  75% </th><th>  85% </th><th>  90% </th></tr><tr><td>  Rgb </td><td>  139KB </td><td>  198KB </td><td>  250KB </td><td>  425KB </td><td>  691KB </td><td>  992KB </td><td>  1337KB </td></tr><tr><td>  Alpha </td><td>  363KB </td><td>  459KB </td><td>  524KB </td><td>  689KB </td><td>  856KB </td><td>  1067KB </td><td>  1273KB </td></tr></tbody></table><br>  These dimensions are closer to what you want.  For me, it turned out to be a complete surprise that the file with transparency turns out to be heavier in all cases than the file with colors, probably the whole thing is in contrast.  Visually, all that is compressed is stronger than 50% similar to bricks and not to Kosomes.  Friends, if among you there is someone who can make a well compressed and at the same time well distinguishable JPEG - please share your experience, I will gladly update the article.  In the meantime, further experiments will be carried out with a pair of files compressed to 75% that pull in the amount of 1547KB which is significantly better (lighter) than 18.6MB for PNG and even more so 64MB for the uncompressed format. <br><br><h4>  Forward! </h4><br>  Now these separate JPEGs will be given to us by the server and on the client we will receive and glue them into one common image with transparency. <br><br>  The markup will be the most empty one: <br><div class="spoiler">  <b class="spoiler_title">Markup</b> <div class="spoiler_text"><pre><code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Canvas Example: Using canvas<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"css/main.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/main.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>)</span></span></span><span class="javascript">{ loadRGBA(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"jpeg_16x16/render_16_16_rgb_75.jpg"</span></span></span><span class="javascript">, </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"jpeg_16x16/render_16_16_aplha_75.jpg"</span></span></span><span class="javascript">); }); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"star1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"base64"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"star2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"base64"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></div></div><br>  As well, and styles: <br><div class="spoiler">  <b class="spoiler_title">Styles</b> <div class="spoiler_text"><pre> <code class="css hljs">* { <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">html</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background</span></span>: <span class="hljs-number"><span class="hljs-number">#888</span></span> <span class="hljs-built_in"><span class="hljs-built_in">url</span></span>(../backs/back64dark.png); <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">14px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">font-family</span></span>: <span class="hljs-string"><span class="hljs-string">'Helvetica'</span></span>, Helvetica, sans-serif; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">h1</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">1.5em</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">text-align</span></span>: center; <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">1em</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: <span class="hljs-number"><span class="hljs-number">#ddd</span></span>; } <span class="hljs-selector-id"><span class="hljs-selector-id">#base64</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">background</span></span>: transparent; <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: <span class="hljs-number"><span class="hljs-number">#bbb</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">256px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">265px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> auto; }</code> </pre><br></div></div><br>  In the script block at the end of the formation of the document call the function of loading images. <br>  It is very simple (it is in the js / main.js file): <br><div class="spoiler">  <b class="spoiler_title">function loadRGBA ()</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadRGBA</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url_rgb, url_alpha</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> img_rgb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> img_alpha = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> img_count = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> img_rgba = <span class="hljs-string"><span class="hljs-string">''</span></span>; img_rgb.src = url_rgb; img_alpha.src = url_alpha; img_rgb.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ ++img_count; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span> == img_count){ img_rgba = compileRGBA(img_rgb, img_alpha); } } img_alpha.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ ++img_count; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span> == img_count){ img_rgba = compileRGBA(img_rgb, img_alpha); } } }</code> </pre><br></div></div><br>  In a nutshell: let's declare two Image objects and wait for them to load (that is, when the number img_count is 2).  In my script this moment is made somewhat through one place - after loading any of the files it is checked and whether the ALREADY has loaded another one and, if so, the function of assembling two images into one is called.  I'm not so good at JavaScript I just feel like something is wrong, but despite my feelings, it works.  And since it is expected (in the example) always exactly 2 images, we‚Äôll leave the loading function alone and write the assembly functions. <br><br><h4>  Collect! </h4><br><div class="spoiler">  <b class="spoiler_title">compileRGBA ()</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileRGBA</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">raw_rgb, raw_alpha</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!raw_rgb.width || !raw_rgb.height || !raw_alpha.width || !raw_alpha.height){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (raw_rgb.width !== raw_alpha.width || raw_rgb.height !== raw_alpha.height){ alert(<span class="hljs-string"><span class="hljs-string">' RGB    '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> canvas_rgb = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"canvas"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> canvas_alpha = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"canvas"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> canvas_frame = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"canvas"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!canvas_rgb || !canvas_rgb.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>) || !canvas_alpha || !canvas_alpha.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>) || !canvas_frame || !canvas_frame.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>)){ alert(<span class="hljs-string"><span class="hljs-string">'----, ... ---, , '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } canvas_rgb.width = raw_rgb.width; canvas_rgb.height = raw_rgb.height; canvas_alpha.width = raw_alpha.width; canvas_alpha.height = raw_alpha.height; canvas_frame.width = <span class="hljs-number"><span class="hljs-number">256</span></span>; canvas_frame.height = <span class="hljs-number"><span class="hljs-number">256</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context_rgb = canvas_rgb.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context_alpha = canvas_alpha.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context_frame = canvas_frame.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>); context_rgb.drawImage(raw_rgb, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); context_alpha.drawImage(raw_alpha, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pix_rgb = context_rgb.getImageData(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, raw_rgb.width, raw_rgb.height); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pix_alpha = context_alpha.getImageData(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, raw_alpha.width, raw_alpha.height); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>, n = pix_rgb.width * pix_rgb.height * <span class="hljs-number"><span class="hljs-number">4</span></span>; i &lt; n; i += <span class="hljs-number"><span class="hljs-number">4</span></span>){ pix_rgb.data[i+<span class="hljs-number"><span class="hljs-number">3</span></span>] = pix_alpha.data[i]; } context_rgb.putImageData(pix_rgb, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> img_arr = []; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> frames = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;=<span class="hljs-number"><span class="hljs-number">15</span></span>; i++){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j=<span class="hljs-number"><span class="hljs-number">0</span></span>; j&lt;=<span class="hljs-number"><span class="hljs-number">15</span></span>; j++){ frames[j*<span class="hljs-number"><span class="hljs-number">16</span></span> + i] = context_rgb.getImageData(i*<span class="hljs-number"><span class="hljs-number">256</span></span>, j*<span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-number"><span class="hljs-number">256</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> frame = <span class="hljs-number"><span class="hljs-number">0</span></span>; $(<span class="hljs-string"><span class="hljs-string">"#base64"</span></span>).append(canvas_frame); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> intFPS = setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ ++frame; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (frame &gt; <span class="hljs-number"><span class="hljs-number">255</span></span>){ frame = <span class="hljs-number"><span class="hljs-number">0</span></span>; } context_frame.putImageData(frames[frame], <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) }, <span class="hljs-number"><span class="hljs-number">1000</span></span> / <span class="hljs-number"><span class="hljs-number">16</span></span>); }</code> </pre><br></div></div><br>  Here, too, there is nothing difficult - in the first condition the presence of dimensions is checked and in the second condition their conformity.  then we declare three canvas: for color, for transparency and for animation.  As it should be, we have the presence of support for the Canvas mechanism in the browser (I tested it in Mozilla Firefox and Google Chrome, everything is fine here and IE8 got hysterical and I left it alone. As <a href="http://habrahabr.ru/users/dasm32/" class="user_link">dasm32</a> suggests: <i>‚ÄúOpera works‚Äù</i> , and <a href="http://habrahabr.ru/users/sashagil/" class="user_link">sashagil</a> <i>‚Äúin IE 10 (which is only in Win8 at the moment), normally shows,‚Äù</i> but <a href="http://habrahabr.ru/users/krovosos/" class="user_link">Krovosos</a> <i>‚Äúdidn‚Äôt work Safari on iPad, even the background didn‚Äôt seem‚Äù</i> ) and generate contexts for them.  And then the magic begins: <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pix_rgb = context_rgb.getImageData(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, raw_rgb.width, raw_rgb.height); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pix_alpha = context_alpha.getImageData(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, raw_alpha.width, raw_alpha.height);</code> </pre><br>  these two lines pull out the RGBA layers from the contexts of the color file and the transparency file, each of which expands into a 64-megabyte array, despite the fact that in the case of a color file there is no component of transparency, and in the case of a Gray-Mode transparency file, one is enough bit layer, but such is selyavi - the canvas is always 4 bytes deep.  One byte on each of the three colors and one more for transparency.  Once on the outline, the monochrome transparency file ‚Äúturns into depth‚Äù by 32 bits in such a way that R = G = B and transparency = 255. <br><br>  loop through all the pixels of these arrays and <br><pre> <code class="javascript hljs">pix_rgb.data[i+<span class="hljs-number"><span class="hljs-number">3</span></span>] = pix_alpha.data[i]</code> </pre><br>  Copy the red byte value from the transparency canvas to the transparency layer (data [i] is red, data [i + 1] is green, data [i + 2] is blue, data [i + 3] is alpha) <br><br>  From this moment we have a huge (4096x4096) footcloth consisting of 256 individual frames, each of which is 256x256 pixels in size.  The frames are laid out in a 16x16 grid from top to bottom and from left to right.  Now it is the most logical to export this grid from the canvas to a document as a Base64 instance and feed it to the Background-Image property in a DIV of the appropriate size and shift the starting point of the timer by the frame size.  The experiment showed that this is a terrible option in terms of CPU usage, my DualCore 2.2GHz could not deliver above 5 FPS.  Therefore, we cut these 16x16 suns into frames and put them into an array. <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> frames = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;=<span class="hljs-number"><span class="hljs-number">15</span></span>; i++){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j=<span class="hljs-number"><span class="hljs-number">0</span></span>; j&lt;=<span class="hljs-number"><span class="hljs-number">15</span></span>; j++){ frames[j*<span class="hljs-number"><span class="hljs-number">16</span></span> + i] = context_rgb.getImageData(i*<span class="hljs-number"><span class="hljs-number">256</span></span>, j*<span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-number"><span class="hljs-number">256</span></span>); } }</code> </pre><br>  then we start the timer 16 times per second (it can be faster and slower) and <a href="http://sergej-hof.de/tutors/alpha1">see the animation</a> , or <a href="">download</a> and watch locally. <br><br>  <b>Attention!</b>  Chrome will not locally ‚Äúupload‚Äù files for reasons of ugliness, therefore, FF remains. <br>  <b>UPD</b> <a href="http://habrahabr.ru/users/shvv/" class="user_link">SHVV</a> : <i>"... so that Chrome can open local files, it must be run with the --disable-web-security key"</i> . <br><br>  If you are watching online, then I must say that the download (1.5MB) happens unnoticed, but the gluing freezes for about 5 seconds, but then freezes and the animation works.  Moreover, the processor is loaded at 1%, which gives reason to conduct a further experiment with a pair of such suns on the subject of "see how they intersect." <br><br><h4>  Cosmos 2.0 </h4><br>  for this we modify CSS <br><div class="spoiler">  <b class="spoiler_title">New styles</b> <div class="spoiler_text"><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.base64</span></span>{ <span class="hljs-attribute"><span class="hljs-attribute">background</span></span>: transparent; <span class="hljs-attribute"><span class="hljs-attribute">position</span></span>: absolute; <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">256px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">265px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br></div></div><br>  We do absolute positioning so that the block can fly. <br><br>  And also javascript.  First, we will make two stars, respectively, two DIVs, let's call two gluing functions - <br><div class="spoiler">  <b class="spoiler_title">modification loadRGBA ()</b> <div class="spoiler_text"><pre> <code class="javascript hljs"> img_rgb.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ ++img_count; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span> == img_count){ compileRGBA(img_rgb, img_alpha, <span class="hljs-string"><span class="hljs-string">"star1"</span></span>); compileGGAA(img_rgb, img_alpha, <span class="hljs-string"><span class="hljs-string">"star2"</span></span>); } } img_alpha.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ ++img_count; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span> == img_count){ compileRGBA(img_rgb, img_alpha, <span class="hljs-string"><span class="hljs-string">"star1"</span></span>); compileGGAA(img_rgb, img_alpha, <span class="hljs-string"><span class="hljs-string">"star2"</span></span>); } }</code> </pre><br></div></div><br>  one is the same as before (compileRGBA) and the second modified (compileGGAA) it differs from the first only in a slightly more free way of handling the color-transparency channels: <br><pre> <code class="javascript hljs"> pix_rgb.data[i] = pix_rgb.data[i+<span class="hljs-number"><span class="hljs-number">1</span></span>]; pix_rgb.data[i+<span class="hljs-number"><span class="hljs-number">2</span></span>] = pix_rgb.data[i+<span class="hljs-number"><span class="hljs-number">3</span></span>] = pix_alpha.data[i];</code> </pre><br>  as seen here in the loop, the value of the red channel is replaced with the value of green, and the blue and transparency are copied from the transparency of the second file.  The star is turning blue.  And also in the animation timer the starting frame value is shifted by a hundred.  This is to not get synchronized swimming. <br><br>  Second, let's set the timers to move these stars in an ellipse with a delta phase of 180 degrees: <br><div class="spoiler">  <b class="spoiler_title">timers</b> <div class="spoiler_text"><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> intRotate = setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ phase += <span class="hljs-number"><span class="hljs-number">.01</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (phase &gt;= <span class="hljs-number"><span class="hljs-number">6.28319</span></span>) { phase = <span class="hljs-number"><span class="hljs-number">.0</span></span>; } $(<span class="hljs-string"><span class="hljs-string">"#star1.base64"</span></span>).css(<span class="hljs-string"><span class="hljs-string">'top'</span></span>, (doc_h + <span class="hljs-number"><span class="hljs-number">50</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(phase)) + <span class="hljs-string"><span class="hljs-string">'px'</span></span> ); $(<span class="hljs-string"><span class="hljs-string">"#star2.base64"</span></span>).css(<span class="hljs-string"><span class="hljs-string">'top'</span></span>, (doc_h + <span class="hljs-number"><span class="hljs-number">50</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(phase + <span class="hljs-number"><span class="hljs-number">3.14159</span></span>)) + <span class="hljs-string"><span class="hljs-string">'px'</span></span> ); $(<span class="hljs-string"><span class="hljs-string">"#star1.base64"</span></span>).css(<span class="hljs-string"><span class="hljs-string">'left'</span></span>, (doc_w + <span class="hljs-number"><span class="hljs-number">100</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos(phase)) + <span class="hljs-string"><span class="hljs-string">'px'</span></span> ); $(<span class="hljs-string"><span class="hljs-string">"#star2.base64"</span></span>).css(<span class="hljs-string"><span class="hljs-string">'left'</span></span>, (doc_w + <span class="hljs-number"><span class="hljs-number">100</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos(phase + <span class="hljs-number"><span class="hljs-number">3.14159</span></span>)) + <span class="hljs-string"><span class="hljs-string">'px'</span></span> ); $(<span class="hljs-string"><span class="hljs-string">"#star1.base64"</span></span>).css(<span class="hljs-string"><span class="hljs-string">'z-index'</span></span>, (phase &lt; <span class="hljs-number"><span class="hljs-number">3.14159</span></span>) ? <span class="hljs-string"><span class="hljs-string">'1001'</span></span>:<span class="hljs-string"><span class="hljs-string">'1000'</span></span> ); $(<span class="hljs-string"><span class="hljs-string">"#star2.base64"</span></span>).css(<span class="hljs-string"><span class="hljs-string">'z-index'</span></span>, (phase &lt; <span class="hljs-number"><span class="hljs-number">3.14159</span></span>) ? <span class="hljs-string"><span class="hljs-string">'1000'</span></span>:<span class="hljs-string"><span class="hljs-string">'1001'</span></span> ); }, <span class="hljs-number"><span class="hljs-number">1000</span></span> / <span class="hljs-number"><span class="hljs-number">24</span></span>);</code> </pre><br></div></div><br>  third, we remove intermediate structures: <br><div class="spoiler">  <b class="spoiler_title">remove trash</b> <div class="spoiler_text"><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> pix_rgb; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> pix_alpha; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> context_rgb; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> canvas_rgb; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> context_alpha; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> canvas_alpha;</code> </pre><br></div></div><br>  It‚Äôs hard to say if there‚Äôs any sense from these deletions, at least the Task Manager didn‚Äôt notice any difference with the deletion without deletion. <br><br>  Thus it turns out two alternately eclipsed stars. <br><br>  - Can I see everyone? <br>  - Yes of course.  <a href="">Will you</a> download? <br><br><h4>  Summary </h4><br>  At this experiment / lesson is over.  The feeling is twofold: on the one hand, everything works fundamentally.  On the other - this wild brake at the time of gluing spoils the joy of victory.  And what to do with it is not yet clear.  If you have any suggestions, I will eagerly listen and make corrections. <br><br>  Thank you for your attention, friends! <br><br>  PS I smneyl for you background less merciless =) </div><p>Source: <a href="https://habr.com/ru/post/154103/">https://habr.com/ru/post/154103/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../154089/index.html">Systematization of garbage collectors in HotSpot, IBM J9, JRockit JVMs</a></li>
<li><a href="../154091/index.html">Optimization of lead collection for the site accompanying the project</a></li>
<li><a href="../154097/index.html">Features of uploading files to HTML5</a></li>
<li><a href="../154099/index.html">New for web designer in October 2012</a></li>
<li><a href="../154101/index.html">Apple, Facebook, Google, Microsoft Launch WebPlatform</a></li>
<li><a href="../154105/index.html">Functional Javascript Programming</a></li>
<li><a href="../154107/index.html">The new user authentication system uses the unique characteristics of video cards.</a></li>
<li><a href="../154109/index.html">Can neural networks help copy the brain?</a></li>
<li><a href="../154111/index.html">Ruby Codecademy Course</a></li>
<li><a href="../154117/index.html">Making an information widget for the Drupal site</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>