<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dirty stress test nginx vs apache</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 

 Recently, I became interested in the question on which technologies it is possible to build an information system that would respond to m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dirty stress test nginx vs apache</h1><div class="post__text post__text-html js-mediator-article">  Good day! <br><br>  Recently, I became interested in the question on which technologies it is possible to build an information system that would respond to more or less simple requests from customers, but as quickly and reliably as possible. <br>  Having rummaged a little on the Internet, I certainly could not find a definite answer, so I decided to do my own little test. <br><br><h5>  Task </h5>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I formulated the task as follows: <br><ul><li>  The client must send a request to the server with some parameters. </li><li>  The server must put parameters into the database. </li><li>  The server should spit out the record base ID </li><li>  The client must initiate a new TCP session, request the already created record. </li><li>  The server then marks that the transaction is complete. </li></ul><br><a name="habracut"></a><br><h5>  Tests </h5><br>  It was originally planned to test a large number of options, namely: <br>  self-written server on c ++ <br>  nginx + php <br>  nginx + self-written module <br>  apache + php <br>  apache + self-written module <br>  something samopisnoe on .NET <br><br>  however, like any self-respecting sysadmin, I was lazy and I limited myself to <b>nginx + php</b> and <b>apache + php</b> , in the hope that I will do the rest of the experiments later (well, or after your comments on this article they will not be needed) <br>  As a database, I used MySQL. <br><br><h5>  Base </h5><br>  In the table I made 3 control points: <br>  1. Time to create a record (up to milliseconds) <br>  2. The time the transaction ends (within milliseconds) <br>  3. Record creation time (accurate to seconds) <br><br>  3 checkpoint is needed in order to be able to understand how many records are created per second. <br>  Total base turned out like this: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> clients (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> auto_increment, amount <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">hash</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>), Primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> clients <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> cr_time <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> clients <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> ps_time <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> clients <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> sec_time <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>();</code> </pre> <br><br><h5>  Infrastructure </h5><br>  As a server, the only thing I had at hand was one of the last aspire one, with an Atom processor, 2 core, 4 flow, and installed on it 10 ubuntoi: <br><br><pre> <code class="bash hljs">root@aspire-1-laptop:/etc<span class="hljs-comment"><span class="hljs-comment"># cat /proc/version Linux version 2.6.32-41-generic (buildd@vernadsky) (gcc version 4.4.3 (Ubuntu 4.4.3-4ubuntu5.1) ) #89-Ubuntu SMP Fri Apr 27 22:22:09 UTC 2012</span></span></code> </pre><br><br>  It is connected to the home router (canyon, model for 40 bucks approximately, 2 years old), 100 megabit connection, wire. <br><br>  As bots for load creation I used the following machines: <br>  2 laptops with core duo (one old Dell, the other old fujitsu), sub-accessory wires to the same router <br>  1 beech laptop with i5 (new Dell) connected via wi-fi, also on the same router. <br><br>  All settings were made on the basis of instructions in the first links of <a href="http://www.google.com/">Google</a> , so that there is no specific optimization of speech. <br><br><h5>  Bot </h5><br>  On all the laptops, windows 7 was installed, and according to this, the simplest option seemed to me to navigate the bot to c #, which in the loop created the required number of threads and started figuring the ‚Äútransactions‚Äù. <br>  The main bot code is as follows: <br><br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beginTransaction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> response = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.createRecord(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> id = response.Substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, response.IndexOf(<span class="hljs-string"><span class="hljs-string">'|'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> final = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.updateRequest(id); StringReader strReader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringReader(response); StringReader strReader2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringReader(final); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.Parse(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.textBox1.Text); i++) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.richTextBox2.BeginInvoke((MethodInvoker)(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.richTextBox2.AppendText(<span class="hljs-string"><span class="hljs-string">"thread started \n"</span></span>))); Thread oThread = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThreadStart(beginTransaction)); oThread.Start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!oThread.IsAlive) ; } }</code> </pre><br><br><h5>  Web part </h5><br>  A small PHP script that actually does everything I need, I implemented as follows: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> error_reporting(E_ALL); ini_set(<span class="hljs-string"><span class="hljs-string">"display_errors"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); mysql_pconnect(<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>,<span class="hljs-string"><span class="hljs-string">'root'</span></span>,<span class="hljs-string"><span class="hljs-string">'qwerty'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(mysql_error()); mysql_select_db(<span class="hljs-string"><span class="hljs-string">'test'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(mysql_error()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_REQUEST[<span class="hljs-string"><span class="hljs-string">'id'</span></span>])){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (trim($_REQUEST[<span class="hljs-string"><span class="hljs-string">'id'</span></span>])!=<span class="hljs-string"><span class="hljs-string">''</span></span>){ <span class="hljs-comment"><span class="hljs-comment">// echo 'ktulhu fhtagn'; $result = mysql_query('select * from clients where id = "'.addslashes($_REQUEST['id']).'";') or die(mysql_error()); $time = microtime(); $query = sprintf("update clients set ps_time = '%s' where id = '%s'", mysql_real_escape_string($time), mysql_real_escape_string($_REQUEST['id'])); mysql_query($query) or die(mysql_error()); echo $time; } else{ $time = microtime(); $amount = $_REQUEST['amount']; $hash = $_REQUEST['hash']; $query = sprintf("INSERT INTO clients (amount,hash,cr_time) VALUES ('%s','%s','%s');", mysql_real_escape_string($_REQUEST['amount']), mysql_real_escape_string($_REQUEST['hash']), mysql_real_escape_string($time)); mysql_query($query) or die(mysql_error()); $id = mysql_insert_id(); echo $id." | ".$time; } } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  The subtleties of the script and the bot are not so interesting, so I think you shouldn‚Äôt focus on them, and especially inquisitive minds will understand everything themselves, without much difficulty. <br><br>  By this start immediately to the test results <br><br><h5>  results </h5><br>  Understanding that the test is absolutely not objective, starting from the fact that such things are not done on the desktop ubunt, ending with the need to use a normal switch, I still expected different results.  What I saw surprised me greatly.  Namely: <br><br><h6>  nginx </h6><br>  Request type: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> clients <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> sec_time <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> sec_time <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">20</span></span>;</code> </pre><br>  Showed that the average number of processed sessions: <b>205 pieces</b> , for an average time: 0.025 seconds. <br>  (Session here, and further, I call the time between the creation of a record from the first request and the update of the record at the second request from the stream). <br><pre> <code class="sql hljs">| 205 | | 200 | | 202 | | 208 |</code> </pre><br><br> <code>| 155930 | 0 | K | 0.36527600 1339369721 | 0.38711300 1339369721 | 2012-06-11 02:08:41 | <br> | 155929 | 0 | K | 0.36156500 1339369721 | 0.38884600 1339369721 | 2012-06-11 02:08:41 | <br></code> <br><br>  Ubunt showed that all the cores were loaded evenly, about 80%, the traffic on Ubunta went at a speed of 400 kb per second, and when one of the beeches was disconnected, the situation did not change at all, therefore, I had a hypothesis that slows down the router. <br><br><h6>  apache </h6><br>  With the same requests, I observed the following picture: <br><br> <code>| 255 | <br> | 247 | <br> | 257 | <br></code> <br> <code>| 190582 | 0.102561082738713 | G | 0.46013900 1339370133 | 0.48647400 1339370133 | 2012-06-11 02:15:33 | <br> | 190581 | 0.266181369901719 | W | 0.45496900 1339370133 | 0.47832300 1339370133 | 2012-06-11 02:15:33 | <br></code> <br><br>  This means that the number of processed requests per second was about <b>255</b> , which is more than by nginx, the processing time of one request did not increase, and it also remained equal to 0.025 seconds. <br>  All other characteristics remain the same. <br><br><h5>  Bare conclusions </h5><br><br>  Honestly, it's hard to draw any conclusions from this, because  I don‚Äôt want to believe that Apache is faster than nginx.  Perhaps nginx‚Äôs brakes are related to the need to use fastcgi, and there is a better way to configure it to work with php, but I didn‚Äôt find out how to do it right away, so, dear hacks, you may draw some conclusions (for example, my the experiment is of no value at all because of the subjective parameters), or accept its results as is. <br><br>  Anyway, thanks for the remote time :) <br><br>  PS Remembering the classics: nginx, come on, bye. </div><p>Source: <a href="https://habr.com/ru/post/145689/">https://habr.com/ru/post/145689/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145681/index.html">Exchange 2007/2010, sending letters to domain users who have external mailing addresses</a></li>
<li><a href="../145682/index.html">Algorithms of sorting. Gnome Sort on C</a></li>
<li><a href="../145683/index.html">Static analysis of PHP code using HipHop</a></li>
<li><a href="../145685/index.html">Weekly Digest # 7: Simple-Science - Simple Experiments</a></li>
<li><a href="../145688/index.html">Startup: what not to do or learn from the mistakes of others</a></li>
<li><a href="../145690/index.html">Twitter introduces trend personalization</a></li>
<li><a href="../145693/index.html">T (ether) allows you to edit virtual objects in the real world</a></li>
<li><a href="../145694/index.html">A simple implementation of the now playing section for Icecast2 using JSON</a></li>
<li><a href="../145695/index.html">Authorization on the site through the social networking API with integration into Spring Security</a></li>
<li><a href="../145697/index.html">The second practical task from unity3dstudent.com</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>