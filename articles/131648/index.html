<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP library for working with the Yandex.Money API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have long wanted to try something new, and now, when I was at work offered to write examples of using the Yandex.Money API in different languages, I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP library for working with the Yandex.Money API</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/55b/194/9e9/55b1949e9684e38f3e1b038a402bc6dd.png" alt="Yandex.Money API" align="right">  I have long wanted to try something new, and now, when I was at work offered to write examples of using the Yandex.Money API in different languages, I gladly accepted this challenge offer.  Since most of the same functionality is used in applications on various hosting systems, it was a volitional decision to try to write this in PHP first.  And before that I didn‚Äôt even see the API;  moreover, I had no experience with PHP, except as a laboratory at the university.  The thing promised to be interesting. <br><a name="habracut"></a><br><h4>  Choice of environment </h4><br>  The first thing I encountered was that it was not very convenient to develop and deploy to the hosting right there.  And I decided to download some gentleman's set for a web developer.  From his student days, the name Denwer loomed in his memory.  I tried, but quickly refused it.  He lives some kind of his life, and when I tried to set it up by rewriting something in the Apache conf-file, he overwritten it or not overwritten it on his own, not letting everything be adjusted by hand.  That is, it turned out that it was not I who set it up, but he did me.  He recalled "if I had a horse - it would be a number ...".  As a result, I won it, of course, but at the same time I decided to find a simpler WAMP-server.  I want to note that Denwer is a good product and I don‚Äôt have anything against it, but I didn‚Äôt want to read faky and manuals on it. <br><br>  I found a page with a <a href="http://en.wikipedia.org/wiki/Comparison_of_WAMPs">list of</a> WAMPs on the wiki and began sorting through them.  The main criteria for the selection were the project support, so that the build version was more or less fresh, and ease of installation / launch.  As a result, I can safely recommend <a href="http://www.uniformserver.com/">The Uniform Server</a> .  It does not require installation (only unpack the archive), when launched, it hangs in the tray and starts up with a light tap =).  I did not begin to act willfully, and I settled on it. <br><br><h4>  OAuth authentication </h4><br>  I read the <a href="http://api.yandex.ru/money/">instructions</a> , downloaded the <a href="http://api.yandex.ru/money/doc/dg/yandex-money-dg.pdf">documentation</a> , exposed the checker and rushed into battle.  But in combat, I was quickly defeated by OAuth authentication.  OAuth is a way to access any service / account of a user without entering and storing his username and password in his application.  It came to us from the creator of Twitter and looks like this: we make a request to the service (in our case, Yandex.Money), the user enters his login / password on the Yandex.Money server and gives our application permissions to use his account.  After that, the Yandex.Money server redirects to our application, and we get a temporary code, the lifetime of which is very short.  Then, by means of another request to Yandex. Money, we change this temporary code to a user's permanent token and then for us, as for demob, all roads are open. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, while I was passing through OAuth authentication, I came across a security issue.  I tried to contact the Yandex.Money server, but PHP began to swear dirty and say something about certificates.  I rummaged a little on the Internet and understood that it was necessary for our application to verify the server's SSL certificate.  I wanted to do well to ensure users safety, and I continued to search.  But there are almost no imputed examples of the implementation of checking the server certificate in RuNet.  I'll tell you in order. <br><br>  First, it was necessary to register the verification of certificates in the code when sending requests.  How to force cURL which I use to send requests with check of the certificate?  He began to search and was amazed that the most popular advice for certificate errors: DISABLE check.  And it is offered on a bunch of sites and forums (for example, <a href="http://www.sql.ru/forum/actualthread.aspx%3Fbid%3D18%26tid%3D873000%26hl%3D14090086">here</a> ).  Horror, in general.  Here is the code that is most often offered: <br><br> <code>curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);</code> <br> <br>  Remember it, children, and never write.  "And now, son, we will repeat all those bad words that you must forget."  Thank God, that in the English-language Internet is not so bad, and I found such a <a href="https-ssltls-protected-sites/">reference</a> , which explained everything.  I did what it says, and it all worked. <br><br>  Then it was necessary to keep the Yandex.Money public certificate in order to be compared with anything when sending requests.  I didn‚Äôt seem to be completely retarded, but nevertheless it seemed to me rather difficult.  Maybe you in the future will help when working with SSL.  We go to the desired site via https, poke into certificates and export.  But there are 3 of them, which one is needed?  ‚ÄúTake a pie from the shelf;  there are two of them, take the middle one. ‚Äù  It turns out that you need to export the certificate of the certification center (root) and intermediate (Yandex).  The final certificate changes once a year and, if we enter it into a chain and forget to change it when it is rotten, then everything in our application will break.  Therefore, we export only the specified 2 certificates and simply save them into one text file ( <a href="">screenshot</a> ).  In my library, it <i>appears</i> as <i>ym.crt</i> . <br><br>  After that, the requests I have earned.  Hooray!  Further was a matter of technique.  In the documentation, everything was clear;  Actually, that's why I actually copied it into the code documentation.  I also make a reservation that I wrote it as an object;  in my opinion, it is good and convenient to work with objects. <br><br><h4>  Encryption </h4><br>  There were still some difficulties with encryption.  At first, saving / restoring user tokens was implemented by the standard PHP library Mcrypt.  But as it turned out, there are problems with it.  For example, from the ejects taken in the manual, immediately earned only one deprecated-function.  The remaining functions spat on my desire to make them work, and only said something about the unsuccessful initialization of the module.  It was necessary to understand.  Then it turned out that hosters are not very fond of this library.  I asked the support of my <a href="http://www.diphost.ru/">hosting provider</a> why there is no Mcrypt module when creating a site for PHP 5.3.  I was told (verbatim): ‚ÄúIt buggy for years in 5.2 - it wasn‚Äôt automatically added to 5.3 as a module, which is remembered once every five years, and there were problems with it‚Äù.  I did not find other convenient standard libraries with the implementation of symmetric encryption in PHP (there is an OpenSSL library, but it is not quite for that).  After that, I decided to change the encryption library to <a href="http://phpseclib.sourceforge.net/">phpseclib</a> , which is open and supports the popular AES algorithm.  She earned immediately and without problems. <br><br><h4>  Functionality and examples of use </h4><br>  Also for ‚Äútraining on cats‚Äù, or rather testing and debugging, calls to library functions were written, which I subsequently refined with layout for a pleasant looking eye, filled with comments and called examples of using the library. <br><br>  As a result, calls to the following Yandex.Money API functions are implemented: account information, transaction history, detailed information on operations, money transfers to other users.  Pros and features: <br><ul><li>  OAuth user authentication; </li><li>  security of work (checking certificate chains is supported); </li><li>  usability (server responses are presented as objects) and quick start; </li><li>  relatively safe and easy solution for storing users tokens using encryption and without using a database.  You can easily rewrite the implementation of this solution to your storage. </li></ul><br>  The library itself is a file of certificate chain <i>ym.crt</i> and file <i>ym.php</i> , which contains: <br><ul><li>  IYandexMoney software interface; </li><li>  YandexMoney main class (interface implementation); </li><li>  class-enumeration with access rights (scope); </li><li>  helper classes (response objects displaying results of API queries). </li></ul>  The library contains 2 files that implement encryption: Rijndael.php and AES.php.  These files are taken from the <a href="http://phpseclib.sourceforge.net/">phpseclib</a> library.  They are needed in case you will use methods to save and restore tokens. <br>  Note: uses PHP version 5, as well as the standard cUrl library for http requests. <br><br>  For those who will not install and watch detailed examples, we will show a couple of calls. <br>  To perform operations with the account through the API, it is necessary to obtain the user's permission, that is, the token.  It can be received by the following calls (for example, with access to view account information and transaction history): <br><br><pre>  YandexMoney :: authorize (Consts :: CLIENT_ID, 'account-info operation-history', Consts :: REDIRECT_URL);

 // then on the redirect page initiate the creation of an object and the receipt of a token
 $ ym = new YandexMoney (Consts :: CLIENT_ID, Consts :: CERTIFICATE_CHAIN_PATH);	
 $ token = $ ym-&gt; receiveOAuthToken ($ _ GET ['code'], Consts :: REDIRECT_URL); </pre><br>  When you create an object $ ym, the application ID and the absolute path on the server to the certificate chain (the ym.crt file) are passed to it.  Both are usually written in constants in some module (consts.php in our examples). <br>  Well, show you how to get information about the user's account.  In the same way, create an object and then call the method, passing it the user token: <br><br><pre>  $ ym = new YandexMoney (Consts :: CLIENT_ID, Consts :: CERTIFICATE_CHAIN_PATH);
 $ accountInfoResponse = $ ym-&gt; accountInfo ($ token);			

 echo 'Account Number:'.  $ accountInfoResponse-&gt; getAccount ().  "\ n";
 echo 'Balance:'.  $ accountInfoResponse-&gt; getBalance ().  "\ n";
 echo 'Currency code:'.  $ accountInfoResponse-&gt; getCurrency ().  "\ n"; </pre><br>  Account information received. <br><br>  Approximately the same is with other challenges. <br><br>  As a result, the library decided to call the SDK a loud name and put it on <a href="https://github.com/melnikovdv/PHP-Yandex.Money-API-SDK">GitHub</a> . <br>  I will be glad to hear your comments and suggestions, as well as see forks and pull requests. </div><p>Source: <a href="https://habr.com/ru/post/131648/">https://habr.com/ru/post/131648/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../131643/index.html">Android 4.0 Ice Cream Sandwich video review on Google Nexus S</a></li>
<li><a href="../131644/index.html">Where did the PDA go?</a></li>
<li><a href="../131645/index.html">MemCache for iOS</a></li>
<li><a href="../131646/index.html">LiveKniga.Ru, or a story about a blog with stories about stories</a></li>
<li><a href="../131647/index.html">We make a macro flash from the built-in flash</a></li>
<li><a href="../131649/index.html">We write our auto-update service</a></li>
<li><a href="../131650/index.html">We write a math reference book for Android, we connect the Begun ad</a></li>
<li><a href="../131652/index.html">Design patterns for Android development. Part 3 - User Interface, Testing, AndroidMock</a></li>
<li><a href="../131653/index.html">Ino - working with Arduino from the command line</a></li>
<li><a href="../131654/index.html">Google Map API (custom labels and tooltips)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>