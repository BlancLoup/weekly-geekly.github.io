<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to save on spot EC2 instances with Scylla</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Spot instances can save you a lot of money. But what if you work with stateful services, such as NoSQL databases? The main problem is that in this cas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to save on spot EC2 instances with Scylla</h1><div class="post__text post__text-html js-mediator-article">  Spot instances can save you a lot of money.  But what if you work with stateful services, such as NoSQL databases?  The main problem is that in this case each node in the cluster must retain some parameters ‚Äî IP, data, and other configurations.  In this post, we will talk about Scylla's open source NoSQL database and how it can be used in the ES2 spot instances for continuous operation - using the predictive technology SpotInst, as well as enhanced state saving functionality. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c45/192/64f/c4519264f293bdf5d70addfdca34d4f0.png"><br><a name="habracut"></a><br><br><h2>  What is Scylla? </h2><br>  Scylla is a NoSQL database distributed through the opensource model.  It was designed to be compatible with Apache Cassandra, while providing much higher throughput and lower latency.  It supports the same protocols and file formats as Apache Cassandra.  However, Scylla is written entirely in C ++, not in Java, like Apache Cassandra.  In addition, Scylla was built using the Seastar framework, which is an asynchronous library that replaces execution threads, shared memory, mapped files, and other classic Linux programming techniques.  Scylla also has its own unique disk scheduler, which helps improve performance. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Tests conducted by both ScyllaDB engineers and third-party companies have demonstrated that Scylla is 10 times more than Apache Cassandra. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae6/de5/04a/ae6de504a64130e2dfc60015aa2e6f01.png"><br><br><h2>  How Scylla replicates its data between nodes. </h2><br>  Scylla provides accessibility in AlwaysOn mode.  Automatic transition to the backup system, replication between multiple nodes and data centers provide fault tolerance. <br><br>  Scylla, like Cassandra, uses the gossip protocol to exchange metadata to identify the nodes in the cluster and determine if they are active.  There is no single point of failure - there can be no single register of the status of the nodes, so they must exchange information with each other. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d9e/c31/472/d9ec31472eeba549be144afc1ff2a9f7.png"></div><br><h2>  How to run Scylla on Spotinst </h2><br>  When creating a new Scylla cluster, there is hardly a desire to immediately resort to spot instances because of their unstable behavior.  Not in their favor is the fact that these instances can be disabled within 2 minutes.  Therefore, Elastigroup is the standard choice for such an environment. <br><br>  Elastigroup with an indicator of 100% availability is the leader of the Spot Market.  Choosing the right rate for the right spot, analyzing the history of data in real time - all this helps to choose spot instances with the lowest price and the longest term of work.  Changes in the Spot Market are predicted to be 15 minutes ahead, which allows replacing the spot without interrupting work. <br><br>  Now about saving the state.  Elastigroup can save data volumes.  For any EBS volume that is connected to the instance, snapshots will be continuously executed during operation, and after replacement it will be used for block matching. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c58/3a6/7e3/c583a67e3eb3f712fa4dc302945f14d7.png"><br><br>  In order for your machine to continue working in the event of a failure, you need to remember a few things: <br><br><ol><li>  <b>Private IP address.</b>  - make sure that the new computer has the same IP address so that the gossip protocol can continue to interact with the machine. <br></li><li>  <b>Tom</b>  The node must be connected to the same repository and must have the same volume as before.  If not, the service will be unavailable. <br></li><li>  <b>The config file</b> - scylla.yaml is by default located at /etc/scylla/scylla.yaml.  It must be edited so that the nodes have information about their configuration.  Here are the key parameters you need to configure: <br></li></ol><br><ul><li>  <i>Cluster_name</i> is the name of the cluster.  This parameter separates nodes of different logical clusters.  For all nodes within the same cluster, the same value should be set; <br></li><li>  <i>Listen_interface</i> - the interface that Scylla assigns to connect to other nodes; <br></li><li>  <i>Seeds</i> - sid nodes are used during startup to boot the gossip process and join the cluster; <br></li><li>  <i>Rpc_address</i> - interface IP address for client connections (Thrift, CQL); <br></li><li>  <i>Broadcast_address</i> - the IP address of the interface for connections between nodes, how it will be visible inside the cluster. <br></li></ul><br><h2>  Selection of racks </h2><br>  To increase the availability of your data, it is recommended to distribute the nodes between AZ.  You can <code>Ec2Snitch</code> this using the <code>Ec2Snitch</code> value in the <code>scylla.yaml</code> and <code>cassandra-rackdc.properties</code> . <br><br>  Suppose you have a cluster created in the <code>us-east-1</code> .  If node 1 is in <code>us-east-1a</code> , and node 2 is in <code>us-east-1b</code> , Scylla will assume that they are in two different racks in the same data center.  Node 1 will be considered resistant 1a, and node 2 will be considered resistant 1b. <br><br>  Now we will show how to deploy a cluster of six nodes.  Each data center will consist of three ordinary nodes and two seeders.  IP addresses look like this: <br><br>  <b>US US-DC1</b> <br><br> <code>Node# Private IP <br> Node1 192.168.1.1 (seed) <br> Node2 192.168.1.2 (seed) <br> Node3 192.168.1.3 <br></code> <br>  <b>US US-DC2</b> <br><br> <code>Node# Private IP <br> Node4 192.168.1.4 (seed) <br> Node5 192.168.1.5 (seed) <br> Node6 192.168.1.6 <br></code> <br>  On each Scylla node, you need to edit the scylla.yaml file.  Here is another example for one node in each data center: <br><br>  <b>US Data center 1 - 192.168.1.1</b> <br><br> <code>cluster_name: 'ScyllaDB_Cluster' <br> seeds: "192.168.1.1,192.168.1.2,192.168.1.4,192.168.1.5" <br> endpoint_snitch: Ec2Snitch <br> rpc_address: "192.168.1.201" <br> listen_address: "192.168.1.201" <br></code> <br>  <b>US Data center 2 - 192.168.1.4</b> <br><br> <code>cluster_name: 'ScyllaDB_Cluster' <br> seeds: "192.168.1.1,192.168.1.2,192.168.1.4,192.168.1.5" <br> endpoint_snitch: Ec2Snitch <br> rpc_address: "192.168.1.4" <br> listen_address: "192.168.1.4" <br></code> <br>  On each Scylla node, you need to edit the cassandra-rackdc.properties file, specifying the appropriate information about the rack and data center: <br><br>  <b>Nodes 1-3</b> <br><br> <code>dc=us-east-1a <br> rack=RACK1 <br></code> <br>  <b>Nodes 4-6</b> <br><br> <code>dc=us-east-1b <br> rack=RACK2 <br></code> <br><h2>  Spotinst Console setup </h2><br>  When configuring the Elastigroup, it is important to enable the persistence function ‚Äî this is necessary in order to preserve the data and network configuration when replacing the instance due to the disconnection of the spot.  Open the Compute tab, go to the stateful function and check the options as shown in the screenshot below. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/528/33e/bca/52833ebcac9aa8799a083a18003b9514.png"><br><br>  We also recommend using the ‚Äúnodetool drain‚Äù shutdown script command to clear the commit log and stop accepting new connections.  Description is in the section <a href="https://help.spotinst.com/hc/en-us/articles/115003069869-Shutdown-Script">shutdown script</a> . <br><br><h2>  How does this work? </h2><br>  In the animation below, you see a cluster of Scylla with three instances.  All nodes work on spot instances, with configured state preservation. <br><br>  When one of the instances goes down, our state preservation function creates an instance with Private IP and Root / Data volumes.  And, as you can see below, the instances are returned to the cluster. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/340/ef0/1f0/340ef01f065ca2cadf361e2bdbbefa29.gif"><br><br>  So with Scylla and Spotinst, you can increase productivity while reducing costs. <br><br>  If you want to see and test the solution, you can contact us through the <a href="http://www.globaldots.com/speak-with-a-specialist%3Futm_source%3Dhabrahabr%26utm_medium%3Darticle%26utm_campaign%3Dspotinst">form on the website</a> , in the comments to the post, by mail to <a href="">ru@globaldots.com</a> or by phone + 7-495-762-45-85. </div><p>Source: <a href="https://habr.com/ru/post/345480/">https://habr.com/ru/post/345480/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345468/index.html">PCI DSS: what it is and how to get certified for it + our experience</a></li>
<li><a href="../345472/index.html">The future of Internet protocols</a></li>
<li><a href="../345474/index.html">Security in modern corporations</a></li>
<li><a href="../345476/index.html">Configuring VPN (PPTP) in Ubuntu 17.10 with authorization by JaCarta smart card</a></li>
<li><a href="../345478/index.html">All professions are important: why should a tester be valued as much as a programmer?</a></li>
<li><a href="../345482/index.html">Key-value for storing metadata in storage. We test the selected databases</a></li>
<li><a href="../345484/index.html">Linear Regression with Go</a></li>
<li><a href="../345486/index.html">20 hits of world cinema that translated from English otherwise</a></li>
<li><a href="../345488/index.html">What is the difference between React and Vue?</a></li>
<li><a href="../345490/index.html">We are launching a new online course ‚ÄúWeb Services Development on Go‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>