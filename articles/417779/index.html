<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Unity3D in a native iOS / Android application for modeling open space lighting</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Unity3D is a well-known platform for developing 3D and 2D games that has gained popularity all over the world. At the same time, its capabilities are ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Unity3D in a native iOS / Android application for modeling open space lighting</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ac/6n/is/ac6nistgzfsvyyhyj3wqngoiak4.png" alt="image"><br><br>  Unity3D is a well-known platform for developing 3D and 2D games that has gained popularity all over the world.  At the same time, its capabilities are not limited to the development of gaming applications only, but are suitable for use in any other areas that require the creation of cross-platform applications for working with graphics.  In this article we will talk about the experience of using Unity3D to develop a system for calculating the lighting of open spaces. <br><a name="habracut"></a><br>  The company with which we collaborated is the international lighting corporation <a href="http://www.bl-g.ru/">BOOS LIGHTING GROUP</a> .  In order to expand the attractiveness of its products and simplify interaction with customers, it was necessary to develop an application that allows you to visually simulate the location of lighting devices, as well as to calculate the illumination and display the necessary technical information in the report.  It was assumed that the application runs on an iPad or Android tablet as a potential client or sales representative and allows the client to immediately get an idea of ‚Äã‚Äãthe possibility of lighting installations. <br><br>  The work was carried out in stages based on the developed specification of requirements and consultation from <a href="http://www.bl-g.ru/">BOOS LIGHTING GROUP Corporation</a> on the subject of the project. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, the application is an editor that allows you to add and edit elements of lighting, roads, decorative elements, make lighting calculations of the scene, display the report in pdf.  Each element has its own set of parameters for editing and subtypes that affect its display and calculation. <br><br><ul><li>  There are several types of masts of lighting, with different types of fixing luminaires, angles of inclination of the lamps and length of removal.  For certain types of luminaires, individual adjustment is possible with indication of the direction of illumination. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2o/ci/da/2ocida45cxhpgpekhtfat_mc_6y.png" width="70%" alt="image"></div></li><li>  Roads can be linear sections, elements of the arc, area, ring.  For each element, dimensions, position, marking type, layer can be configured. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/s1/3s/lx/s13slxoinkzba4yyljw518pqw78.png" alt="image" width="70%"></div></li><li>  Decorative elements - cars, trees, bushes, road signs </li></ul><br>  All elements of the scene can be rotated and moved.  It also supports standard actions to revert or repeat the operation.  The general settings of the project allow you to set the texture of the surface, the surface of the earth, the display of additional parameters.  The scene is displayed in 2D / 3D modes.  And when calculating the illumination on the surface, the surface irradiance map is displayed in fictitious colors. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ac/6n/is/ac6nistgzfsvyyhyj3wqngoiak4.png" width="100%" alt="image"></div><br><br>  If possible, the entire UI was required to be made native by iOS / Android. <br>  The main technical requirement for the application is to be able to calculate the stage lighting according to the technical specification of the luminaires.  Also required the ability for each lamp to display and view its radiation pattern (light intensity curves) in 3D / 2D modes. <br><br><h4>  Platform Selection </h4><br>  For the project, we have chosen Unity as more convenient for us to implement the required functionality.  In general, our company had experience with other 3D engines and platforms (OpenSceneGraph, Ogre3D, LibGdx) and technically they can all cope with the required task, but this time the choice fell on Unity, which allows you to more easily manage the scene in progress. <br><br><h4>  Main difficulties </h4><br>  We will not go into the details of the development of the entire application, since technically the functionality for displaying and editing the scene is quite standard.  Naturally, there were difficulties with the mechanisms of specific editing of objects, adding and deleting them, as well as preserving the chain of commands for the possibility of repeating and canceling actions. <br>  We would like to dwell only on the features of the system associated with working with native UI, generating pdf reports and working with photometry and calculating lighting. <br><br><h4>  Work with native UI </h4><br>  In most cases, Unity interacts with the native functions of the system using the plugin system, which allows it to embed the necessary functionality in the application.  However, in our case, the situation is somewhat opposite.  We needed to have the full-fledged UI displayed over the Unity window. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4z/0s/41/4z0s41r48kbp8cuzxnc7naj6l3i.png" width="70%" alt="image"></div><br><br>  Fortunately, Unity can export a project that can be used as the basis for a native application.  The main difficulty in this case is how to integrate an additional UI into the resulting project.  Also, it is equally important that when assembling a Unity project, its format and location of files are formed by Unity and partially overwritten, which limits the possibility of modifying the project. <br><br>  When developing an iOS application, we used the mechanism proposed in the <a href="https://the-nerd.be/2014/08/06/add-unity3d-in-a-native-ios-application/">article</a> .  During development, Unity 5.5 was used and at the moment it is indicated that it may lose relevance.  When building the android project, there were no additional problems except for the fact that Unity each time overwrites the manifest file and resource files. <br>  An additional problem is that Unity can only work in one window.  At the same time, we needed to ensure the operation of Unity to display the entire scene, and also when opening the settings window, the 3D model of the photometric body of the lamp was to be displayed.  To accomplish this, I had to use the ‚Äúhack‚Äù and use the same UIView object in different windows. <br><br>  To send messages, we used the standard functionality offered by Unity.  That is, all messages were in json format and transmitted in simple lines.  This did not impose any restrictions on performance, since the size of messages reached a maximum of 100 characters, and their frequency was determined by the speed of work with the program.  At the same time, in more demanding applications, it makes sense to make your own message handler as represented in the Habr√© <a href="https://habr.com/company/pixonic/blog/353088/">here</a> and <a href="https://habr.com/company/pixonic/blog/353444/">here</a> . <br><br><h4>  Lighting calculation </h4><br>  All sources of lighting used in the application are supplied in a standard <a href="https://knowledge.autodesk.com/support/3ds-max/learn-explore/caas/CloudHelp/cloudhelp/2015/ENU/3DSMax/files/GUID-EA0E3DE0-275C-42F7-83EC-429A37B2D501-htm.html">IES</a> format that describes the distribution of light in a different direction ( <a href="http://lumen.iee.put.poznan.pl/kw/iesna.txt">specification</a> ).  This format is widely used in professional CAD systems and 3D editors.  It is a text file indicating the intensity of light in different directions and additional meta information indicating the type, total intensity of the source, axes and planes of symmetry.  Given the symmetry of the fixtures, the ies file can be very small.  For example, in the case of axial symmetry, it is sufficient to specify the light tracking only in one plane. <br><br><div class="spoiler">  <b class="spoiler_title">Simple IES file example</b> <div class="spoiler_text"><pre><code class="plaintext hljs">IESNA91[TEST] Simple demo intensity distribution [MANUFAC] Lightscape Technologies, Inc. TILT=NONE 1 -1 1 8 1 1 2 0.0 0.0 0.0 1.0 1.0 0.0 0.0 5.0 10.0 20.0 30.0 45.0 65.0 90.0 0.0 1000.0 1100.0 1300.0 1150.0 930.0 650.0 350.0 0.0</code> </pre> <br></div></div><br>  To display the pattern of light, two types of display were used: <br><br><ul><li>  Light intensity curves (CIL) is a two-dimensional graph which shows the light intensity in one of the main planes depending on the direction.  For convenience, this graph can be presented in both polar and Cartesian coordinate systems. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/df/89/xc/df89xcesta0qlw4jcyuxpbihmyi.png" width="100%" alt="image"></div></li><li>  Photometric body - a three-dimensional image of the intensity of light in different directions <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/su/1s/if/su1sifzigs4cwuy-jg6bhpni79o.png" width="100%" alt="image"></div></li></ul><br><h4>  Calculation Module </h4><br>  To calculate the lighting, the customer had its own C ++ module used in other company products, and therefore it was required to integrate it into the Unity project.  The module connection procedure was different from the platform used. <br><br><ul><li>  On the iOS platform, Unit can directly call the C function, therefore, it is enough to copy the source of the module directly into the project and add classes for its interaction with Unity.  It is possible to store classes both directly in the iOS project and in the plugins folder that are automatically copied when the project is exported to Xcode.  An example of calling C ++ functions is as follows: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">DllImport(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"__Internal"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculateLight</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[MarshalAs(UnmanagedType.LPArray, SizeParamIndex = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">)] Light[] lights, </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> size, </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ref</span></span></span><span class="hljs-function"> CalculationResult result)</span></span>;</code> </pre> </li><li>  On the Android C ++ platform, the module must be precompiled into a separate library.  This can be done directly by adding C ++ sources to the project and setting up gradle to build them into the so library. </li><li>  Also, for debugging and testing of the Unity part, development was carried out on a windows machine, so it was necessary to connect the source of the module to Windows.  This is done in the same way as an android project, only in this case the files downloaded are collected in the dll library and connected to the project. </li></ul><br><h4>  Display of the irradiance map </h4><br>  At the request of the customer, the results of the calculation of the illumination should be displayed on the scene surface.  On the road surface, it is necessary to use fictitious colors with the display of the color and light intensity matching scale, and on the rest of the surface it is sufficient to simply display its brightness. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/18/5q/k9/185qk9lbx4fsoq3ax0miaedzjkm.png" width="70%" alt="image"></div><br><br>  As previously mentioned, the entire calculation was performed by a C ++ plug-in that transmitted data about color sources.  The result of the calculation was a two-dimensional array of light intensity over the entire surface of the scene with a given detail. <br><br>  The resulting irradiance map was analyzed for the minimum, maximum value, on which the one-dimensional gradient texture was constructed (GradientRamp).  Using this texture, the light intensity was transformed into fictitious colors directly in the fragment shader.  At the same time, the same shader was used for different surfaces of roads and the surface of the earth, and switching the lighting mode was provided using the " <a href="https://docs.unity3d.com/Manual/SL-MultipleProgramVariants.html">multi-compile</a> " shader. <br><br><h4>  Pdf file generation </h4><br>  In accordance with the technical requirements, the user had to generate a report containing information about the overall scene (dimensions, its images, lighting parameters) and information about each type of luminaire used, indicating their position, direction of characteristics, as well as KCC diagrams and the photometric body display. <br>  Since the report had to be displayed both on iOS and Android, it was necessary to generate it directly in the Unity module, and then display it with standard native tools. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/aw/fo/je/awfojewyanvogdxu6sihv6zr-i8.png" alt="image"></div><br>  To build pdf, the library has chosen <a href="https://docs.unity3d.com/Manual/SL-MultipleProgramVariants.html">iTextSharp</a> , which meets our requirements.  Creating a report in it is not particularly difficult and consists in creating blocks of text, tables, images directly from the code.  However, in the course of development, we were faced with many nuances, the solution of which sometimes required considerable effort.  The main problem of which was the launch of the generation of the report in the background thread. <br><br>  If, when testing on a desktop machine, pdf generation was on the order of a few seconds, then when testing on iPad mini 3, this time easily reached 1-3 minutes.  Naturally, the creation of the report was required to be transferred to a separate thread, in order to avoid problems with interface hanging.  In general, this is not a problem, but this is not the case when using Unity, in which it is expressly prohibited to use the Unity API not from the main thread.  At the same time, for the report we needed, at a minimum, to render the CSS and an image of the scene, which needs to be done only from the main stream. <br><br>  Thus, to build a report, we need to run the tasks in a certain sequence and at the same time some of them can work in the background thread, and some of them must be run in the main one. <br><br>  At first glance, to solve this problem, you can try to use the standard mechanism and run each operation in a separate cororten.  However, this does not save us from the problem with braking the interface.  As you know, corutines work in the mainstream and are not suitable for slow operations.  At the same time, when generating a report, many operations take a substantial amount of time, and therefore corintins cannot help in solving our problem. <br><br><h4>  UniRx </h4><br>  Another solution is to divide the code into a part that needs to work in the main thread and a part that can be run in a separate thread.  In this case, for example, images can be constructed using the corutin mechanism, and then embedded in the report already in a separate stream.  However, in this case it will be necessary to save intermediate results somewhere, which imposes additional restrictions on the amount of used memory or free space on the device. <br><br>  In our application, we chose to go straight and run tasks consistently in the main, then in the background threads.  The problem was only how to organize such a launch of tasks so as not to get bogged down in this jumble and correctly synchronize operations. <br>  Substantial assistance in solving this problem was brought by the use of Rx as its embodiment in the form of a free UniRx <a href="https://github.com/neuecc/UniRx">asset</a> , which was already described in detail <a href="https://habr.com/post/342660/">here</a> and <a href="https://habr.com/company/nixsolutions/blog/268781/">here</a> . <br><br>  Its use has significantly simplified the interaction between threads and in the example below you can run several methods in a strict sequence, but in different threads <br><br><div class="spoiler">  <b class="spoiler_title">Code example</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> initializer = Observable.FromCoroutine(initMethod); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> heavyMethod1 = Observable.Start(() =&gt; doHardWork()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mainThread1 = Observable.FromCoroutine(renderImage); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> heavyMethod2 = Observable.Start(() =&gt; doHardWork2()); initializer.SelectMany(heavyMethod1) .SelectMany(mainThread1) .SelectMany(heavyMethod2) .ObserveOnMainThread() .Subscribe((x) =&gt; done()) .AddTo(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre><br>  In this example, the doHardWork () method will be run in the background thread.  After it is completed, the renderImage () in the main thread will start, and after that doHardWork2 () will be executed again in the background thread. <br></div></div><br>  It is also worth noting that in the course of analyzing the generation of a report on speed, it was found that the slowest part is the incorporation of images into the report.  An Internet search showed that we are not the only ones who are faced with this problem, but there was no suitable solution.  We had to slightly reduce the quality of images to an acceptable level, which gave an increase in speed by 20-40%. <br><br>  Thus, in the application created by us, it turned out to successfully implement the Unity graphics engine in the native iOS / Android application.  This is different from the traditional approach when Unity is the main part of the application and addresses specific system properties through the plugin system.  At the same time, our approach can be useful if you need to develop a complex native interface in which you want to embed non-trivial 3D graphics. </div><p>Source: <a href="https://habr.com/ru/post/417779/">https://habr.com/ru/post/417779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../417769/index.html">User Memory Design: How to Design Ages</a></li>
<li><a href="../417771/index.html">ICANN plan: the corporation proposed a new model for managing root DNS servers</a></li>
<li><a href="../417773/index.html">Homemade OpenPnP Component Installer</a></li>
<li><a href="../417775/index.html">The mechanism of commissions in Bitcoin and why be friends with miners</a></li>
<li><a href="../417777/index.html">"Reading for the weekend": 25 materials for beginners vinyl lovers</a></li>
<li><a href="../417781/index.html">NASA probe "touches" the sun - and will not melt</a></li>
<li><a href="../417783/index.html">Optimizations used in Python: list and tuple</a></li>
<li><a href="../417785/index.html">What sysadmin does not dream of his outsourcing company?</a></li>
<li><a href="../417787/index.html">My experience with being an Agile Coach in Europe, part one</a></li>
<li><a href="../417789/index.html">Arguments about the prospects in Telecom</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>