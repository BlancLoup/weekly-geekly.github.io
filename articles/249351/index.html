<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Features of creating NSString</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article is designed for beginners in Objective-C and talks about one way to shoot yourself in the foot. We will try to create two different NSStri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Features of creating NSString</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d26/51f/362/d2651f362c48481eb2df2606679ed0b2.png" alt="NSLog(123456789) != 123456789" title="NSLog (123456789)! = 123456789" align="left" width="380">  <i>The article is designed for beginners in Objective-C and talks about one way to shoot yourself in the foot.</i>  <i>We will try to create two different NSString objects with the same text, examine the reaction of different compilers to this, and also find out under what conditions NSLog (@ "% @", @ "123456789") will not produce "123456789" at all.</i> <br><br><h4>  NSString objects and pointers </h4><br>  What do you think will output the following code? <a name="habracut"></a><br><pre><code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Foundation/Foundation.h"</span></span></span><span class="hljs-meta"> int main(){ @autoreleasepool { NSString *a = @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"123456789"</span></span></span><span class="hljs-meta">; NSString *b = a; NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%p %p"</span></span></span><span class="hljs-meta">, a, b); } return 0; }</span></span></code> </pre> <br>  Naturally, the pointers will be equal (‚Äúobjects are assigned by reference‚Äù), so NSLog () will print two identical memory addresses.  No magic <br><br>  2015-01-30 14: 39: 27.662 1-nsstring [13574] <b>0x602ea0 0x602ea0</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>Hereinafter, the addresses of the objects are given as an example;</i>  <i>when you try to play back, the actual values ‚Äã‚Äãwill, of course, be different.</i> <br><br>  Let's try to ensure that we have two <b>different</b> NSStrings with the <b>same</b> text.  In the case of other standard classes, for example, NSArray, we could write this: <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Foundation/Foundation.h"</span></span></span><span class="hljs-meta"> int main(){ @autoreleasepool { NSArray *a = @[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"123456789"</span></span></span><span class="hljs-meta">]; NSArray *b = @[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"123456789"</span></span></span><span class="hljs-meta">]; NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%p %p"</span></span></span><span class="hljs-meta">, a, b); } return 0; }</span></span></code> </pre><br>  Since we initialized NSArray separately, they were placed in different memory areas and two different addresses will be highlighted in the console: <br><br>  2015-01-30 14: 40: 45.799 2-nsarray [ <b>13634</b> ] <b>0xa9e1b8 0xaa34e8</b> <br><br>  However, applying the same approach to NSString will not lead to the desired effect: <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Foundation/Foundation.h"</span></span></span><span class="hljs-meta"> int main(){ @autoreleasepool { NSString *a = @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"123456789"</span></span></span><span class="hljs-meta">; NSString *b = @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"123456789"</span></span></span><span class="hljs-meta">; NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%p %p"</span></span></span><span class="hljs-meta">, a, b); } return 0; }</span></span></code> </pre><br>  2015-01-30 14: 41: 41.898 3-nsstring [13678] <b>0x602ea0 0x602ea0</b> <br><br>  As you can see, despite the separate initialization, both pointers still refer to the same memory area. <br><br><h4>  Using stringWithString </h4><br>  Having a little rummaged in NSString, we find out the <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSString_Class/index.html">stringWithString</a> method, which "returns a string created".  So this is what we need!  Let's try the following code: <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Foundation/Foundation.h"</span></span></span><span class="hljs-meta"> int main(){ @autoreleasepool { NSString *a = @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"123456789"</span></span></span><span class="hljs-meta">; NSString *b = [NSString stringWithString:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"123456789"</span></span></span><span class="hljs-meta">]; NSString * = [NSString stringWithString:b]; NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%p %p %p"</span></span></span><span class="hljs-meta">, a, b, ); } return 0; }</span></span></code> </pre><br>  It turns out that the output of this program depends on the version of the compiler used.  So <abbr title="Ubuntu clang version 3.4-1ubuntu3 (tags / RELEASE_34 / final) (based on LLVM 3.4) Target: x86_64-pc-linux-gnu">clang under Ubuntu on LLVM 3.4</abbr> will actually create <b>three different objects</b> located in different memory cells.  But compiling the specified code in Xcode using <abbr title="Apple LLVM version 6.0 (clang-600.0.41.2) (based on LLVM 3.5svn) Target: x86_64-apple-darwin14.0.0">clang for Mac on LLVM 3.5 will</abbr> generate only <b>one object</b> and three pointers to it: <br><br>  2015-01-30 17: 59: 02.206 4-nsstring [670: 21855] <b>0x100001048 0x100001048 0x100001048</b> <br><br><h4>  Exposure magic session </h4><br>  The aforementioned oddities are explained by compiler attempts to optimize string resources.  Encountering string objects with the same content in the source code, it creates them only once for saving storage and comparison costs.  This optimization is also performed at the linking stage: even if strings with the same text are in different modules, they will most likely be created only once. <br><br>  Since the NSString type is immutable (NSMutableString is used for mutable strings), this optimization is safe.  As long as we manipulate with strings only methods of the NSString class. <br><br>  The compiler, however, is not all-powerful.  One of the easiest ways to confuse it and actually create two different NSStrings with the same text is this: <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Foundation/Foundation.h"</span></span></span><span class="hljs-meta"> int main(){ @autoreleasepool { NSString *a = @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"123456789"</span></span></span><span class="hljs-meta">; NSString *b = [NSString stringWithFormat:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%@"</span></span></span><span class="hljs-meta">, a]; NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%p %p"</span></span></span><span class="hljs-meta">, a, b); } return 0; }</span></span></code> </pre><br><h4>  Gcc </h4><br>  Gcc performs a similar optimization of string constants when compiling C code.  For example, <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; void main(){ char *a = "123456789"; char *b = "123456789"; printf("%p %p\n", a, b); }</span></span></span></span></code> </pre><br>  will output <b>0x4005f4 0x4005f4</b> . <br><br>  However, there is a significant difference with the clang: gcc allocates such string constants in the read-only segment ‚Äî attempts to change them in runtime (for example, a [0] = '0') will result in a segmentation fault.  To place lines on the stack where they can be changed, you need to replace char * a with char a [], however in that case gcc will not apply optimization.  The following code will create two different lines: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; void main(){ char a[] = "123456789"; char b[] = "123456789"; printf("%p %p\n", a, b); }</span></span></span></span></code> </pre><br>  <b>0x7fff17ed0020 0x7fff17ed0030</b> <br><br><h4>  Shooting in the leg </h4><br>  So, we know that meeting the same string objects in the source code, the compiler optimizes them and creates the NSString only once.  At the same time, he creates it in the heap, where it can be changed with the help of manual manipulations with the pointer.  (In plain C, as discussed above, this is impossible.) <br><br>  Guess what the following code prints? <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><span class="hljs-meta"> void bad(){ NSString* a = @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"123456789"</span></span></span><span class="hljs-meta">; char* aa = (__bridge void *)(a); aa[8] = 92; } int main(){ @autoreleasepool { bad(); NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%@"</span></span></span><span class="hljs-meta">, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"123456789"</span></span></span><span class="hljs-meta">); } return 0; }</span></span></code> </pre><br>  Depending on the compiler, the result can be different: my Xcode under the Mac prints the krakozyabr set "„à± „ê≥ „òµ „†∑ 9", and the clang in Ubuntu displays a fragment from the service information "red: pars".  In any case, this is not the expected "123456789".  Experiments with other values ‚Äã‚Äãof aa [8], as well as aa [16], I suggest the reader to do it yourself. <br><br>  Worst of all, the bad () function from the last example may be behind the header, for example, in the plug-in library of another author, who, according to his needs, changed his personal (as it seemed to him) NSString.  A smart compiler will still find the matching string constants and close them to one pointer, after which breaking the variable inside bad () will turn the string in the context of main () into hieroglyphs. </div><p>Source: <a href="https://habr.com/ru/post/249351/">https://habr.com/ru/post/249351/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249331/index.html">Microsoft certification</a></li>
<li><a href="../249333/index.html">Life in Belarus. Work in EPAM!</a></li>
<li><a href="../249335/index.html">We connect Ethernet ENC28J60 via SD card-reader for WEB-Servera to Arduino</a></li>
<li><a href="../249341/index.html">APEX: Why using HTML as part of SQL queries for Interactive Report can be dangerous?</a></li>
<li><a href="../249347/index.html">Invitation to FOSDEM 2015</a></li>
<li><a href="../249357/index.html">A compass pointing to the north, or how trigonometry came in handy to me</a></li>
<li><a href="../249359/index.html">Blowfish on guard ivi</a></li>
<li><a href="../249361/index.html">Using TypeScript (using the example of angularjs) in Visual Studio 2015</a></li>
<li><a href="../249363/index.html">Car Tutorial Guide (Unity3d): Exploring an Alternative Physical Model (part 1 of 3)</a></li>
<li><a href="../249367/index.html">Templater - template manager and tweaker for MantisBT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>