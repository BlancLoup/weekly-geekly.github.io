<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We are pumping a WebDriverAgent, or how to test iOS applications after a nuclear explosion. Decryption report</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When Apple with the release of Xcode 8 abandoned the UI Automator, we, like many, were left with nothing. Appium, which was used here, lost its releva...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We are pumping a WebDriverAgent, or how to test iOS applications after a nuclear explosion. Decryption report</h1><div class="post__text post__text-html js-mediator-article"><p>  When Apple with the release of Xcode 8 abandoned the UI Automator, we, like many, were left with nothing.  Appium, which was used here, lost its relevance, we began to look for alternatives and found the tool WebDriverAgent from Facebook.  Under the cut there is a text transcript of the report on what problems we encountered, how we solved them, and how this affected our testing infrastructure for iOS applications. </p><br><p><img src="https://habrastorage.org/webt/yy/rz/ws/yyrzwsx5l9ptjyuzbb8otqg_cnw.png"></p><a name="habracut"></a><br><p>  Avito is several web interfaces, APIs and applications for iOS and for Android.  All this needs to be tested, so we have our own test framework.  It looks like this: </p><br><p><img src="https://habrastorage.org/webt/j9/uw/en/j9uwenwt56bkctwkf9ybhwupi48.png"></p><br><p>  And consists of two main parts. </p><br><p>  The first is, of course, the tests themselves.  They are a set of high-level steps: log in, open a page, log out, and so on.  They work with Stages, where work with all specific elements is described: press the button, fill in the input field, and so on.  And (where could they be without them?) Under this all hides page objects, in which the elements themselves, their locators, descriptions are described. </p><br><p>  The second part of the framework is a large set of libraries that allow you to create an ad, find a ready one, delete it, do something with the user, something else, apply some services, and so on.  In short, everything you need to get a prestate test. </p><br><p>  All tests "communicate" with the tested applications, except for the API, via the WebDriver protocol.  For iOS, we used Appium.  Everything was cool: we had a test coverage, everything worked.  And then Apple announced the release of Xcode 8. Its key feature is that they completely abandoned UI Automation, which was in Apple tools.  And the whole scheme just stopped working. </p><br><p>  We had to make some decision.  Apple offers to write tests on Swift instead.  But we do not want: we have a large set of libraries, 200 thousand lines of code, 400 tests for different applications, and so on.  I do not want to lose all this.  As a replacement, we found a tool from Facebook - <a href="https://github.com/facebook/WebDriverAgent">WebDriverAgent</a> .  The system of its work is similar to Appium, it also raises the web server, however, immediately on the device or on the simulator, and transmits calls from test scripts via XCUITest to the application under test. </p><br><h3 id="plyusy-wda">  WDA Pros </h3><br><p>  What can WebDriverAgent?  Supports Json Wire protocol.  This means that we save our tests and the entire test framework.  Under the hood of his XCUITests.  This is cool because it is a technology supported by Apple, and there is a chance that it will last for another two or three years.  Written by WebDriverAgent on ObjC, thanks to this we don‚Äôt need to rewrite everything with each new Xcode release. <br>  Also from the pros: WDA supports various locator strategies, you can search by item type, by name, XPath - all as we love.  Of the additional advantages - allows you to work with the system outside the application.  We can go to the settings in Safari, drive DeepLink, open the application right away, where we need to, and so on.  In the settings, disable or allow geolocation and so on.  WDA also supports Touch ID technology, which is a separate plus of this tool. </p><br><h3 id="minusy-wda">  Cons WDA </h3><br><p>  There are downsides.  The first is the Inspector.  In any system of functional testing, it occupies a very important role, this is how the auto-tester sees the application, the page code on the screen, and so on.  With WebDriverAgent this is pretty bad.  More specifically, I will tell about it below. <br>  And the key problem is that it is slow in our infrastructure.  And so much so that they can not use.  But this is all we learned not immediately.  At first everything was cool, but about half of our auto testers did not work. </p><br><h1 id="hacking">  Hacking </h1><br><p><img src="https://habrastorage.org/webt/ux/un/2t/uxun2tqvyyydyb6-bct4mczplz0.png"></p><br><p>  The first edit we made to WebDriverAgent was this. </p><br><p><img src="https://habrastorage.org/webt/uz/hk/wt/uzhkwtwujvgkrqell8z9jgkb1hi.png"></p><br><p>  The guys from Facebook didn‚Äôt bother; after all, everyone knows that MacOS is a case-insensitive file system.  But in our department, we write code that runs mainly on Linux servers, so we immediately advise everyone to rearrange MacOS, and those who did so could not compile the WDA: they simply mixed up the letter. </p><br><p>  The next funny edit we made looked like this. </p><br><p><img src="https://habrastorage.org/webt/vh/ht/jm/vhhtjmur7ojbe3rfld1bz0v7364.png"></p><br><p>  This is a method of erasing text from a field.  Editing has sped up some of our tests by about 30 seconds.  Why?  The main problem is that the length of the array being iterated was calculated directly in the body of the loop.  Usually in compiled languages ‚Äã‚Äãyou don‚Äôt need to think about it: there is an optimizer there, it does everything for you.  But in functional testing systems this does not work.  Because we have an element on the screen that lies somewhere in the WDA cache, and which needs to be retrieved from there, found on the page, take its attributes, find the value among them, and erase one character.  Then go again, get the item from the cache again, find it on the page again, again calculate the length of the value field and erase one character again.  We have a description field, in my opinion, 1000 characters.  Minus 30 seconds. <br>  But this is not the worst.  The worst thing looked like this: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/nNJfmI_84BM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Here is the Refine page in the Avito iOS app.  It is implemented through XPath.  Two elements are sought: the minimum price and the maximum.  This video is accelerated 6.5 times.  The real travel time is a minute forty.  Of these, 20 seconds, I drive my hands across the screen, typing text, and so on.  For 40 seconds, each of the two search queries is performed.  At the same time, extra 16 MB of RAM is ‚Äúconsumed‚Äù.  We thought and realized that it was impossible to live with it: now it takes 40 seconds, and if half of the test passes, more memory is accumulated, requests will start to run even longer.  And either WebDriverAgent will fall when it uses too much memory, or our HTTP requests will fall off by timeout. </p><br><p>  We sat down, looked at what we could do about it, and found a solution: we invented our system of allocators.  They called it XUI: eXtended UI Interator.  It just well reflected our attitude towards this at that time.  Under its hood - binding on XCUI locators.  Here is the second demo: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/iWMSG9TaHxc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Exactly the same elements are searched for, but now through our new locators.  The video is doubled, its real time is 20 seconds, and these are the same 20 seconds that I drive with my hands on the screen, because each request is executed in less than one second.  And only 1.5 MB of memory is used. </p><br><p>  How did we do it?  If someone wrote tests on XCUI natively, then he knows that everything there begins with the fact that we have an application object, from which we then look for just elements, for example, text, a button with an inscription on, and so on.  If something more complicated - you can find an element by index, and so on. </p><br><p>  <strong>XCUI selectors:</strong> </p><br><ul><li>  let app = XCUIApplication () </li><li>  app.staticTexts ["Volley"] </li><li>  app.buttons ["On"] </li><li>  app.windows.element (boundBy: 0) </li></ul><br><p>  In real life, however, it looks more like this: </p><br><ul><li>  app.children (matching: .window) .element (boundBy: 0) .children (matching: .other) .element.children (matching: .other) .element.children (matching: .other) .element.children (matching : .other) .element.children (matching: .other) .element.children (matching: .other) .element.children (matching: .other) .element.children (matching: .other) .element (boundBy: 0 ) .children (matching: .other) .element (boundBy: 1) .children (matching: .other) .element.children (matching: .other) .element (boundBy: 0) .children (matching: .other). element.children (matching: .button) .element.tap () </li></ul><br><p>  But the essence remains the same: there is a parent, he has either a direct descendant of some type, or, if deep into a tree, then indirect. <br>  Therefore, we need to know the type of the element and have some sort of direct and indirect descendant.  We climbed into WebDriverAgent, started coding.  Took the item type.  If type is not important to us, simply *.  The dot indicates a direct or indirect descendant, children are looking for or descendants. </p><br><p><img src="https://habrastorage.org/webt/va/z6/z_/vaz6z_0qmpv7gx9ewo1bpkzukqq.png"></p><br><p>  Everything is cool, but it can all be invested, so we need some kind of separator.  We chose pipe (‚Äú|‚Äù), just to avoid confusing with XPath. </p><br><p><img src="https://habrastorage.org/webt/z8/uq/o0/z8uqo0awxqeb9kq35tlkiggd0gq.png"></p><br><p>  And everything that was higher is now executed in a loop. </p><br><p><img src="https://habrastorage.org/webt/xu/_n/ik/xu_nikh1g3dkunvbnfyrfmbtapw.png"></p><br><p>  With this sorted out.  Next you need a choice on the index of the element.  If an index arrived, if we detected that we need it, we simply select from the collection of found elements.  Here is the keyword last, to take immediately the last. </p><br><p><img src="https://habrastorage.org/webt/jh/bm/dk/jhbmdklfs46wwkp7ztysbjjrtmy.png"></p><br><p>  The most important thing is that we still need a choice on difficult conditions, because XPath has XPath access and a bunch of other functions.  And here we were greatly rescued by <a href="https://developer.apple.com/documentation/foundation/nspredicate">NSPredicate</a> , a class that comes in the Apple Foundation Framework and serves to filter and select items from the collection. </p><br><p><img src="https://habrastorage.org/webt/hm/al/bl/hmalblzqnrg4aancqhkein7a7bg.png"></p><br><p>  In fact, he can do a lot.  Here is the <a href="https://academy.realm.io/posts/nspredicate-cheatsheet/">link</a> , you can read. </p><br><p>  Who remembers, in Appium at the time of UI Automation there were BEGINSWITH, MATCH and so on, it is right there.  The syntax is somewhere between RegExr and the WHERE clause in SQL. <br>  We put it together and we got such locators.  In parentheses - NS predicates, in square - indices, pipes and points. </p><br><p>  <strong>XUI locators</strong> </p><br><ul><li>  xui = StaticText [1] | TextView [0] </li><li>  xui = Button (label == 'Stop') </li><li>  xui = NavigationBar [last] </li><li>  xui = Table [0] | Cell [3] | .StaticText (id = Address) </li><li>  xui = Table [0] | Cell [3] | .StaticText (id = Time) </li></ul><br><p>  They figured it out: it worked at an acceptable speed, they started to deal with the next problem.  Inspector.  The WebDriverAgent inspector is there, there is even a cool instruction on how to start it, you can execute a command, two, three, and ... It didn't start, in short: </p><br><p><img src="https://habrastorage.org/webt/al/dm/nj/aldmnjckbgr0y6p4mphsk5woumc.png"></p><br><p>  Even if wound up, there is also nothing useful.  So we had to write our own.  It is also simple, but quite functional. </p><br><p><img src="https://habrastorage.org/webt/ns/0m/6e/ns0m6essaev9sbei88zsllm05t0.png"></p><br><p> There is a tree of elements, green is marked with accessibilityID, if marked.  You can select an item and in the upper right corner you can see the information on it, in the left - in the screenshot to see exactly where it is located on the screen.  The key thing we needed was a search string to test whether we compiled locators correctly or not, whether an element is searched for on the page or not. </p><br><h1 id="itogi">  Results </h1><br><p>  What is the result?  There was a webdriver with its pluses and minuses.  We worked on them a bit - <br>  It became much better. <br>  In our scheme, Appium has changed to WebDriverAgent: </p><br><p><img src="https://habrastorage.org/webt/y8/rq/ys/y8rqys9lt8ylaajujxvdlpztzia.png"></p><br><p>  We left the tests as is: </p><br><p><img src="https://habrastorage.org/webt/an/fd/o0/anfdo03uvb1afr4by4osjvdpkgg.png"></p><br><p>  Stage left as is.  In page objects we changed the Appium locators to ours.  They have become even more readable. </p><br><p><img src="https://habrastorage.org/webt/tt/_7/lh/tt_7lhsp6s8k8rsiaffrsll5ike.png"></p><br><p>  It took about 2-3 weeks and saved us 200,000 lines in libraries and about 400 tests. <br>  On this we did not stop, of course. <br>  Appium besides the fact that he just allowed to test, he solved some other problems.  Now we had to deal with them ourselves.  For example: we want to parallel tests, we need to run several WebDriverAgent instances, run tests, specify an API in each, and so on. </p><br><p><img src="https://habrastorage.org/webt/3z/gv/bz/3zgvbz1gi8go2ykua06adm0snxi.png"></p><br><p>  But people invented the grid!  However, here is the problem: when you connect more than three nodes, it blows down the tower, it starts to eat memory, flow, stupid.  Some people are perverted like this.  Do not try to understand anything here: </p><br><p><img src="https://habrastorage.org/webt/cp/ht/76/cpht76nosnzmpnt_oei4a5qd6yy.png"></p><br><p>  There is a grid, followed by 4 more, followed by 4 more, and so on.  I considered: taking into account the peculiarities of our project, we would have to install one hundred such grids, allocate a whole server for this.  We did not bother with this.  We wrote our own.  It is simple, written in Go, uses approximately 10 MB of RAM and serves 300 nodes.  Registers the nodes, proxies all calls to these nodes and selects the appropriate session with regard to the requirements for the request.  And in the end you need to release it.  Either when the session was closed, or on time-out, if the test fell and could not report that he had finished.  All this is compatible with the Selenium grid so that you can work.  Now we have this scheme, it is working this time: </p><br><p><img src="https://habrastorage.org/webt/hn/4s/lg/hn4slgm8gtu84xls_ufjwzuw1oo.png"></p><br><p>  But our problems do not end there, because we are testing the application, we need to put it on the phone, do something with it, so we wrote a thing called <a href="https://github.com/qa-dev/jsonwire-grid-wda-agent">grid-wda-agent</a> : </p><br><p><img src="https://habrastorage.org/webt/_k/j9/yw/_kj9ywg4hpobwclkwgrfims7ees.png"></p><br><p>  It does several simple things: it is registered in the grid, because WebDriverAgent itself does not know how.  Proxies all calls to WDA, and at the start of the session, selects or launches the desired simulator that we requested in Capabilities, deletes the old version of the application, installs a new one, and restarts WDA, if necessary, because it still sometimes eats memory, it is better to restart it sometimes .  And in addition, he records the video of the test and sends it later to the storage via the <a href="https://aws.amazon.com/documentation/s3/">S3 protocol</a> . <br>  We put all this on the Github organization <a href="http://github.com/qa-dev/">qa-dev</a> , you can go, read, send pull requests, issues. </p><br><h1 id="vyvody">  findings </h1><br><p>  What to do now, if in 2018 we want to test iOS applications? <br>  Two ways.  If we can Swift / ObjC - we can write native tests, XCUI Tests, wait until it is compiled to test one test.  Or we can take WebDriverAgent.  There is more choice: there is either Appium, the developers of which, six months later, after the release of XCode 8, they nevertheless filed their implementation on top of the WDA Agent, having forked it and adding something.  There is an original version from Facebook.  And ours. </p><br><p>  What does Facebook have?  He is an official, everything is quietly contributing to him. <br>  There is an Appium.  First, I quote Dan, who Appium is developing. </p><br><blockquote>  "De-facto standard for automating mobile applications". </blockquote><p>  Secondly, Appium has support for the open-source community.  And the guys recently wrote down their inspector as an application for MacOS. </p><br><p>  There is our option.  We have fast locators, our inspector, grid, grid-agent.  The last three, in principle, work with any WebDriverAgent, you can take them separately and try to use them. </p><br><p>  What conclusions can we draw? <br>  First, choose what suits you.  Second - do not be afraid to make your tools.  In 2015, my life looked like this: </p><br><p><img src="https://habrastorage.org/webt/f1/4v/46/f14v46nh-y8nymhzqdz66za8ece.png"></p><br><p>  Then in 2016, all these events started to happen, we started writing our own ‚Äúcrutch‚Äù version of WDA.  It became so: </p><br><p><img src="https://habrastorage.org/webt/qo/1y/oe/qo1yoe_-sw4n5bqg2tencxoosgk.png"></p><br><p>  Now we have a Grid, Grid-agent ... Life is getting better! </p><br><p><img src="https://habrastorage.org/webt/sc/j3/tu/scj3tuajv4rcyoqrnqsrwjlbfwa.png"></p><br><p>  When you make your bikes, do what you need for the project.  And more importantly - do not do what is not needed.  Because when the whole story happened, we thought: ‚Äúcool, there is an XPath, we will now take it and make it normal, not like them, and it will work‚Äù.  But XPath has such a powerful syntax and so many functions that we probably would have written so far if we went this way.  We needed fast locators, not XPath. <br>  Perhaps that's all.  Ask your questions. </p><br><hr><br><div class="spoiler">  <b class="spoiler_title">‚Üí View report on video</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/QAydlNcOmAE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/347974/">https://habr.com/ru/post/347974/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347962/index.html">Partial wow effects: magic with simple words</a></li>
<li><a href="../347964/index.html">How does blocking access to pages that distribute prohibited content (now the RKN also checks the search engines)</a></li>
<li><a href="../347966/index.html">How we set up a search using Elasticsearch and Logstash using MSSQL data</a></li>
<li><a href="../347968/index.html">Efficient data conversion using transducers</a></li>
<li><a href="../347972/index.html">You went to three fun words! New geocoding and what3words.com</a></li>
<li><a href="../347976/index.html">Fire, water and copper pipes: how we created the new ATOL Opol POS-terminal</a></li>
<li><a href="../347978/index.html">HFT company fined $ 5.7 million accused its own traders of violations</a></li>
<li><a href="../347980/index.html">Is it possible to use C ++ instead of C for small projects in microcontrollers?</a></li>
<li><a href="../347982/index.html">Event digest for HR specialists in IT-field for February 2018</a></li>
<li><a href="../347984/index.html">From prototype to production on Kickstarter: $ 100,000 is not enough</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>