<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We collect Mikrotik firewall logs into the database</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 

 I want to tell you how easy and easy it is to configure the server for collecting network traffic metadata for Mikrotik routers. 

 Purpo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We collect Mikrotik firewall logs into the database</h1><div class="post__text post__text-html js-mediator-article">  Good day. <br><br>  I want to tell you how easy and easy it is to configure the server for collecting network traffic metadata for Mikrotik routers. <br><br>  <b>Purpose:</b> The goal will be to store the ‚Äúchewed‚Äù firewall logs in the database for further analysis. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Means:</b> Any fresh Linux distro with rsyslogd v8 and higher will be suitable for implementation, perhaps the proposed syntax will work on v7.  We also need a DBMS, I chose mariadb.  Database growth will vary depending on the number of journal rules, because the size of the drive is at your discretion, in my case 30-40 rules are logged, which is about 1,200 thousand lines per day.  For the month of using the database, including indexes, it has grown to 3.8 GB. <br><br>  <b>Mechanics: The</b> router sends a log to a remote server via UDP.  The rsyslog server, using regular expressions, cleans up lines from unnecessary information, generates an SQL insert and sends it to the DBMS.  The DBMS, with the help of a trigger before insertion, performs additional cleaning and partitioning of fields that could not be parsed in rsyslog. <br><a name="habracut"></a><br><h4>  <b>Customize the RSYSLOG</b> </h4><br>  Editing the /etc/rsyslog.conf file <br>  Add the following lines there: <br><br><pre><code class="hljs lisp">module(<span class="hljs-name"><span class="hljs-name">load=</span></span><span class="hljs-string"><span class="hljs-string">"ommysql"</span></span>) module(<span class="hljs-name"><span class="hljs-name">load=</span></span><span class="hljs-string"><span class="hljs-string">"imudp"</span></span>) input(<span class="hljs-name"><span class="hljs-name">type=</span></span><span class="hljs-string"><span class="hljs-string">"imudp"</span></span> port=<span class="hljs-string"><span class="hljs-string">"514"</span></span>)</code> </pre> <br>  Thereby we load the necessary modules and open 514 UDP port. <br><br>  The log line from Mikrotik looks like this: <br><br><pre> <code class="hljs css">20180927155341 <span class="hljs-selector-tag"><span class="hljs-selector-tag">BLOCKSMKNETS</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">forward</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:ether6</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">LocalTORF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">out</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:VLAN55</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RT_INET</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">src-mac</span></span> 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:15</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:17</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:31</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:b8</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:d7</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">proto</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TCP</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">SYN</span></span>), 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.234</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2457-</span></span>&gt;192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.14</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:65535</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">len</span></span> 60</code> </pre> <br>  As you can see, there is a lot of excess storage in the database and a coherent selection will be difficult. <br>  In theory, I need to add such data: <br><br><pre> <code class="hljs css">20180927155341 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ether6</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">VLAN5</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.234</span></span> 2457 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.14</span></span> 65535 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:15</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:17</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:31</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:b8</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:d7</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TCP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">forward</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BLOCKSMKNETS</span></span> 60</code> </pre> <br>  I could not get such a line using only one rsyslog.  Regular rsyslog use POSIX ERE / BRE, therefore there is no possibility to apply such features as lookahead or lookbehind. <br><br>  <a href="https://www.rsyslog.com/regex/">There</a> is a tool that allows you to debug regulars, try maybe you can separate the port from the address, as well as the interface name from in: and out :.  Just keep in mind that some sport and dport protocols are missing. <br><br>  In general, my output was: <br><br><pre> <code class="hljs css">20180927155341 <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:ether6</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">out</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:VLAN5</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.234</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2457</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.14</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:65535</span></span> 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:15</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:17</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:31</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:b8</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:d7</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TCP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">forward</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BLOCKSMKNETS</span></span> 60</code> </pre> <br>  <a href="https://www.rsyslog.com/doc/v8-stable/configuration/property_replacer.html">There</a> is documentation on how to prepare rsyslog regulars. <br><br>  In the final form, the log receive configuration file from Mikrotik /etc/rsyslog.d/20-remote.conf will look like this: <br><br><pre> <code class="hljs sql">$template tpl_traflog,"<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> traflog.traffic (datetime, inif, outif, src, dst, smac, proto, <span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>, logpref, <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'%timereported:::date-mysql%'</span></span>, <span class="hljs-string"><span class="hljs-string">'%msg:R,ERE,0,BLANK,0:in:[a-zA-Z]+[0-9]+|in:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%'</span></span>, <span class="hljs-string"><span class="hljs-string">'%msg:R,ERE,0,BLANK,0:out:[a-zA-Z]+[0-9]+|out:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%'</span></span>, <span class="hljs-string"><span class="hljs-string">'%msg:R,ERE,0,BLANK,0:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%'</span></span>, <span class="hljs-string"><span class="hljs-string">'%msg:R,ERE,0,BLANK,1:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%'</span></span>, <span class="hljs-string"><span class="hljs-string">'%msg:R,ERE,0,BLANK:([0-f]+:){5}[0-f]+--end%'</span></span>, <span class="hljs-string"><span class="hljs-string">'%msg:R,ERE,0,DFLT:\b[AX]{3,4}\b--end%'</span></span>, <span class="hljs-string"><span class="hljs-string">'%msg:R,ERE,0,BLANK:[ax]+--end%'</span></span>, <span class="hljs-string"><span class="hljs-string">'%msg:F,32:2%'</span></span>, <span class="hljs-string"><span class="hljs-string">'%msg:R,ERE,0,BLANK:[0-9]+$--end%'</span></span> )<span class="hljs-string"><span class="hljs-string">",SQL if ($fromhost-ip == '192.168.0.230') then {action(type="</span></span>ommysql<span class="hljs-string"><span class="hljs-string">" server="</span></span>localhost<span class="hljs-string"><span class="hljs-string">" serverport="</span></span><span class="hljs-number"><span class="hljs-number">3306</span></span><span class="hljs-string"><span class="hljs-string">" db="</span></span>traflog<span class="hljs-string"><span class="hljs-string">" uid="</span></span>rsyslogger<span class="hljs-string"><span class="hljs-string">" pwd="</span></span>...<span class="hljs-string"><span class="hljs-string">" template="</span></span>tpl_traflog<span class="hljs-string"><span class="hljs-string">") stop}</span></span></code> </pre><br>  In the first line of the description of the template (template) - a string of SQL code to transfer it to the database. <br>  The second line is the condition when the action will take place, that is, the record in the DBMS. <br>  The condition looks like this: if the source is log = 192.168.0.230 ( <code>if ($fromhost-ip == '192.168.0.230')</code> ), then use the ommysql module with connection parameters ( <code>then {action(type="ommysql" server="localhost" serverport="3306" db="traflog" uid="rsyslogger" pwd="..."</code> ) call the template tpl_traflog ( <code>template="tpl_traflog")</code> ), and then stop further processing of the line ( <code>stop}</code> ). <br><br>  It is possible that something will go wrong in your case, it may be due to interface names or log prefixes, maybe something else.  To debug, let's do the following, comment the second line, add a new template and two new conditions: <br><br><pre> <code class="hljs perl">$template tpl_traflog_test,<span class="hljs-string"><span class="hljs-string">"'%timereported:::date-mysql%', '%msg:R,ERE,0,BLANK,0:in:[a-zA-Z]+[0-9]+|in:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%', '%msg:R,ERE,0,BLANK,0:out:[a-zA-Z]+[0-9]+|out:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%', '%msg:R,ERE,0,BLANK,0:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%', '%msg:R,ERE,0,BLANK,1:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%', '%msg:R,ERE,0,BLANK:([0-f]+:){5}[0-f]+--end%', '%msg:R,ERE,0,BLANK:\b[AX]{3,4}\b--end%', '%msg:R,ERE,0,BLANK:[ax]+--end%', '%msg:F,32:2%', '%msg:R,ERE,0,BLANK:[0-9]+$--end%' "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($fromhost-ip == <span class="hljs-string"><span class="hljs-string">'192.168.0.230'</span></span>) then {action(type=<span class="hljs-string"><span class="hljs-string">"omfile"</span></span> file=<span class="hljs-string"><span class="hljs-string">"/var/log/remote/192.168.0.230.log"</span></span> )} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($fromhost-ip == <span class="hljs-string"><span class="hljs-string">'192.168.0.230'</span></span>) then {action(type=<span class="hljs-string"><span class="hljs-string">"omfile"</span></span> file=<span class="hljs-string"><span class="hljs-string">"/var/log/remote/192.168.0.230.log"</span></span> template=<span class="hljs-string"><span class="hljs-string">"tpl_traflog_test"</span></span> ) stop}</code> </pre> <br>  Restart the logger. <br><br>  The tpl_traflog_test template is similar to tpl_traflog but without SQL INSERT. <br><br>  The first condition adds the unprocessed line% msg% to the file /var/log/remote/192.168.0.230.log. <br><br>  The second condition adds the processed string to the same file.  So it will be more convenient to compare. <br>  Next, prepare the database. <br><br><h4>  <b>Preparing the database</b> </h4><br>  Setting the DBMS is omitted, everything is standard here. <br><br>  We start the mysql console and execute the following code: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   create database traflog character set utf8 collate utf8_bin; use traflog; --  create table traffic (id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY, datetime DATETIME, inif VARCHAR(20), outif VARCHAR(20), src VARCHAR(21), sport INT(5), dst VARCHAR(21), dport INT(5), smac VARCHAR(17), proto VARCHAR(4), chain VARCHAR(8), logpref VARCHAR(24), len INT(5)) ENGINE=MYISAM; --  create user rsyslogger@localhost identified by '...'; grant all privileges on traflog.* to rsyslogger@localhost;</span></span></code> </pre><br>  The table is ready, the user is. <br><br>  Now we add a trigger, it will do what the logger failed, it will separate the address from the port and the names of the interfaces: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--  DELIMITER // create TRIGGER delim_ip_port BEFORE insert ON traffic FOR EACH ROW begin set NEW.inif = REGEXP_REPLACE ((NEW.inif), 'in:', '' ); set NEW.outif = REGEXP_REPLACE ((NEW.outif), 'out:', '' ); set NEW.sport = REGEXP_REPLACE ((NEW.src), '([0-9]+\.){3}[0-9]+:|([0-9]+\.){3}[0-9]+', '' ); set NEW.src = REGEXP_REPLACE ((NEW.src), ':[0-9]+', '' ); set NEW.dport = REGEXP_REPLACE ((NEW.dst), '([0-9]+\.){3}[0-9]+:|([0-9]+\.){3}[0-9]+', '' ); set NEW.dst = REGEXP_REPLACE ((NEW.dst), ':[0-9]+', '' ); end // delimiter ;</span></span></code> </pre> <br>  REGEXP_REPLACE searches for the second after comma parameter (regular) and replaces it with the third parameter, in our case there is nothing in quotes, so it simply removes what it found. <br><br>  Let's make a test insert, in the same way as a logger will do: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   insert into traffic (datetime, inif, outif, src, dst, smac, proto, chain, logpref) values (20180730075437, 'in:ether6', 'out:VLAN55', '192.168.0.234:4997', '192.168.6.18:65535', '00:15:17:31:b8:d7', 'TCP', 'forward', 'BLOCKSMKNETS');</span></span></code> </pre> <br>  Let's see what happened: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tarffic;</code> </pre> <br>  If everything is correct, then go ahead.  If not, look for what is the error. <br><br>  Add at least one index.  I am not a wizard to create indexes, but as I understood, in mysql for different queries it is more correct to use indexes with different junction fields, since one query can use only one index (or am I wrong?).  If you understand, do at your discretion.  For example, that's enough: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--  create index traffic_index on traffic (src, dst, dport, datetime);</span></span></code> </pre> <br>  Is done. <br><br>  Now you need to start sending on the router, add the settings of the remote log server and the action to it, add the log option to one of the firewall rules, add the prefix no more than 24 characters. <br><br>  In the micro console, it looks like this: <br><br><pre> <code class="hljs sql">/system logging action <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> remote=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.94</span></span> src-address=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.230</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=remote2 remote=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.19</span></span> syslog-facility=local6 target=remote /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">logging</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>=remote topics=<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">account</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">critical</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>,info <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>=remote2 topics=firewall /ip firewall filter ... <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">action</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">chain</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>=<span class="hljs-string"><span class="hljs-string">"drop ssh brute forcers"</span></span> dst-port=<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">8291</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>=yes <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-prefix=DROP_SSH_BRUTE protocol=tcp src-address-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>=ssh_blacklist ...</code> </pre><br>  Where 192.168.0.230 is the address of the router, 192.168.0.19 is the address of the server log for the firewall logs, and 192.168.0.94 is another log server, my microtic system logs are falling there, we don't need it now.  Our setting is remote2. <br><br>  Further look that falls in the file: <br><br><pre> <code class="hljs pgsql">tail -f /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/remote/<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.230</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span></code> </pre> <br>  The file should be sprinkled with lines from the router, unless of course your rule works often enough. <br><br>  If there are not enough fields, that is, the datetime, inif, outif, src, dst, smac, proto, chain, logpref, len sequence is not observed, then you can try changing the parameter in the debugging templates of the logger, replacing BLANK with DLFT.  Then, instead of the emptiness of any field, some letters will appear, I don‚Äôt remember which ones already.  If this happens, then something is wrong with the regular season and it should be corrected. <br><br>  If everything went as it should, then disable the test conditions and the template. <br><br>  I still need the default config in /etc/rsyslog.d/ to lower it below, I renamed it to 50-default.conf, so that remote logs would not be added to the system log / var / log / message <br>  Restart the logger. <br><br>  Let's wait a bit until our database is full.  Then we can start the sample. <br><br>  <b>Some queries for example:</b> <br><br><div class="spoiler">  <b class="spoiler_title">To see the size of the database and the number of rows:</b> <div class="spoiler_text"><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> table_schema <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"database"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_length + index_length)/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"size Mb"</span></span>, TABLE_ROWS <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"count rows"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> information_schema.tables <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> table_schema; +<span class="hljs-comment"><span class="hljs-comment">--------------------+---------+------------+ | database | size Mb | count rows | +--------------------+---------+------------+ | information_schema | 0.17 | NULL | | traflog | 3793.39 | 21839553 | +--------------------+---------+------------+ 2 rows in set (0.48 sec)</span></span></code> </pre><br>  Over the month, almost 4GB has grown, but it depends on the number and properties of the logged firewall rules. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Number of logged prefixes</b> <div class="spoiler_text">  The number of logged prefixes is not equal to the number of rules, some rules work with one prefix, but still how many total prefixes?  and how many rules are worked out for them ?: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> logpref,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(logpref) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> logpref <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(logpref) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; +<span class="hljs-comment"><span class="hljs-comment">----------------------+----------------+ | logpref | count(logpref) | +----------------------+----------------+ | ACCEPT_TORF_INET | 14582602 | | ACCEPT_SMK_PPP | 1085791 | | DROP_FORWARD_INVALID | 982374 | | REJECT_BNK01 | 961503 | | ACCEPT_MMAX_TORF | 802455 | | ACCEPT_TORF_PPP | 736803 | | SMTP_DNAT | 689533 | | ACCEPT_SMK_INET | 451411 | | ACCEPT_INET_TORF | 389857 | | BLOCK_SMKNETS | 335424 | | DROP_SMTP_BRUTE | 285850 | | ACCEPT_ROZN_TORF | 154811 | | ACCEPT_TORF_MMAX | 148393 | | DROP_ETHALL_ETHALL | 80679 | | ACCEPT_SMTP | 48921 | | DROP_SMTP_DDOS | 32190 | | RDP_DNAT | 28757 | | ACCEPT_TORF_ROZN | 18456 | | SIP_DNAT | 15494 | | 1CWEB_DNAT | 6406 | | BLOCKSMKNETS | 5789 | | DROP_SSH_BRUTE | 3162 | | POP_DNAT | 1997 | | DROP_RDP_BRUTE | 442 | | DROP_BNK01 | 291 | | DROPALL | 138 | | ACCEPT_RTP_FORWARD | 90 | | REJECT_SMTP_BRUTE | 72 | | L2TP_INPUT_ACCEPT | 33 | +----------------------+----------------+ 29 rows in set (2 min 51.03 sec)</span></span></code> </pre> <br>  ACCEPT_TORF_INET is in the lead, by this prefix you can find everyone who went to the Internet from our local network, the protocols and ports are recorded, the time will come and access will be closed to some people.  There is reference data for future work on the bugs. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Smtp tyka leader</b> <div class="spoiler_text">  Let's see who was trying to get to the smtp server today: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'SMTP_DNAT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> datetime &gt; <span class="hljs-string"><span class="hljs-string">'2018101600000000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>; +<span class="hljs-comment"><span class="hljs-comment">----------------+--------------+ | src | count(dport) | +----------------+--------------+ | 191.96.249.92 | 12440 | | 191.96.249.24 | 4556 | | 191.96.249.61 | 4537 | | 185.255.31.122 | 3119 | | 178.57.79.250 | 226 | | 185.36.81.174 | 216 | | 185.234.219.32 | 211 | | 89.248.162.145 | 40 | | 45.125.66.157 | 32 | | 188.165.124.31 | 21 | +----------------+--------------+ 10 rows in set, 1 warning (21.36 sec)</span></span></code> </pre> <br>  Clearly, knot 191.96.249.92 is the winner today.  Let's look at what logged rules, he still figured: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,dport,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport),logpref <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> src=<span class="hljs-string"><span class="hljs-string">'191.96.249.92'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> logpref <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; +<span class="hljs-comment"><span class="hljs-comment">---------------+-------+--------------+-----------------+ | src | dport | count(dport) | logpref | +---------------+-------+--------------+-----------------+ | 191.96.249.92 | 25 | 226989 | SMTP_DNAT | | 191.96.249.92 | 25 | 170714 | DROP_SMTP_BRUTE | | 191.96.249.92 | 25 | 2907 | DROP_SMTP_DDOS | | 191.96.249.92 | 25 | 2061 | ACCEPT_SMTP | +---------------+-------+--------------+-----------------+ 4 rows in set (10 min 44.21 sec)</span></span></code> </pre><br>  This specializes only in smtp, ~ 1% of hits for trying to guess a password or trying to send some garbage, the rest went to the bathhouse. <br><br>  The request was formed 10 minutes is a lot, the current indexes are not suitable for him, or you can reformulate the request, but now we will not talk about it. <br></div></div><br>  In the future, it is planned to fasten a web interface with sample requests and forms. <br>  The vector is set, I hope that this article will be useful. <br><br>  Thanks to all! <br><br>  <b>Bibliography:</b> <br><br>  <a href="https://www.rsyslog.com/doc/v8-stable/">Rsyslog documentation</a> <br>  <a href="https://mariadb.com/kb/en/library/documentation/">Mysql documentation</a> <br>  <a href="https://wiki.mikrotik.com/wiki/Manual:System/Log">Mikrotik logging documentation</a> <br><br>  Thanks to the LOR community for the <a href="https://www.linux.org.ru/forum/general/14370252">tips.</a> </div><p>Source: <a href="https://habr.com/ru/post/427159/">https://habr.com/ru/post/427159/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../427147/index.html">‚ÄúBIAN Reference Model‚Äù for the banking industry or how to stop reinventing the wheel</a></li>
<li><a href="../427149/index.html">RADIOTEHNIKA S-30 speakers from old to new</a></li>
<li><a href="../427151/index.html">Educational process in IT: Olympiads, scholarships, support programs and ITMO University community</a></li>
<li><a href="../427153/index.html">DNA Mechanisms for storing and processing information. Part II</a></li>
<li><a href="../427155/index.html">Bus filter from Southampton - the first step to cleaner cities</a></li>
<li><a href="../427163/index.html">New material will help make thermal solar power plants more efficient.</a></li>
<li><a href="../427165/index.html">How to develop integration tests for Atlassian Jira Server (jira-func-test-plugin)</a></li>
<li><a href="../427167/index.html">What can DSS - or old songs about the main thing</a></li>
<li><a href="../427169/index.html">Tesla quietly removed the option of full autopilot</a></li>
<li><a href="../427171/index.html">Security leaving you</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>