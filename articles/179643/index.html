<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Django GeoIP - determining the location of the visitor by means of Django Framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The other day, in one of the projects, we had to screw up the functionality of determining the country of the user's location by IP address. In fact, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Django GeoIP - determining the location of the visitor by means of Django Framework</h1><div class="post__text post__text-html js-mediator-article">  The other day, in one of the projects, we had to screw up the functionality of determining the country of the user's location by IP address.  In fact, the task is not difficult if you know how to do it.  But the main problem was that the names of states were displayed in Russian and / or English.  I will briefly, without unnecessary water and chatter, describe in steps all the installation of the libraries and setting up the project. <br><br>  To add a Django GIS application to a project, in INSTALLED_APPS it is enough to type 'django.contrib.gis'.  So write <a href="https://docs.djangoproject.com/en/1.3/ref/contrib/gis/install/">here</a> .  But they do not warn that the entire project then collapses if the necessary libraries and bases are not installed.  The article used the materials of official documentation and its own development. <br><a name="habracut"></a><br><br>  Let's start by installing all the necessary libraries and databases.  What do we need? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Python 2.4+ </li><li>  Django </li><li>  PostgreSQL (with PostGIS), MySQL or Oracle (I use PostgreSQL) </li><li>  Geos </li><li>  PROJ.4 </li></ul><br><br>  The only unsolved problem is the error of the 'haystack' attached.  Therefore it was necessary to temporarily remove it from the project. <br><br>  All install from source <br><br><h4>  GEOS installation </h4><br><br><pre><code class="bash hljs">$ wget http://download.osgeo.org/geos/geos-3.2.2.tar.bz2 $ tar xjf geos-3.2.2.tar.bz2 $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> geos-3.2.2 $ ./configure $ make $ sudo make install $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ..</code> </pre> <br><br><h4>  Install PROJ.4 </h4><br><br>  This is a library that converts geospatial data in various coordinate systems. <br><br><pre> <code class="bash hljs">$ wget http://download.osgeo.org/proj/proj-4.7.0.tar.gz $ wget http://download.osgeo.org/proj/proj-datumgrid-1.5.zip $ tar xzf proj-4.7.0.tar.gz $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> proj-4.7.0/nad $ unzip ../../proj-datumgrid-1.5.zip $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .. $ ./configure $ make $ sudo make install $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ..</code> </pre><br><br><h4>  PostGIS installation </h4><br><br>  PostGIS adds support for the PostgreSQL geographical object, turning it into a database of map data.  GEOS and PROJ.4 must be installed before starting to build PostGIS. <br><br><pre> <code class="bash hljs">$ wget http://postgis.refractions.net/download/postgis-1.5.2.tar.gz $ tar xzf postgis-1.5.2.tar.gz $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> postgis-1.5.2 $ ./configure $ make $ sudo make install $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ..</code> </pre><br><br><h4>  Creating a spatial database template for PostGIS </h4><br><br><pre> <code class="bash hljs">$ sudo su - postgres</code> </pre><br><br>  Next <a href="https://docs.djangoproject.com/en/1.3/ref/contrib/gis/install/">on the documentation page,</a> download the appropriate script and run.  After this, you can create a spatial database by simply specifying template_postgis as a template to use (using the -T option): <br><br><pre> <code class="bash hljs">$ createdb -T template_postgis &lt;db name&gt;</code> </pre><br><br>  Libraries are installed.  Now we swing <a href="http://dev.maxmind.com/geoip/legacy/geolite">bases of the countries and cities</a> .  Unpack  For convenience, I place the files in the directory MEDIA_ROOT / geoip <br><br>  Now it's time to work with the project settings.py: <br><br><pre> <code class="python hljs">INSTALLED_APPS = ( <span class="hljs-comment"><span class="hljs-comment">#.................... 'django.contrib.gis', #.................... ) #.............................................. GEOIP_PATH = os.path.join(MEDIA_ROOT, 'geoip') GEOIP_COUNTRY = 'GeoIP.dat' GEOIP_CITY = 'GeoLiteCity.dat'</span></span></code> </pre><br><br>  Now you can test.  Code for testing, I will not copy-paste.  See here <a href="https://docs.djangoproject.com/en/1.3/ref/contrib/gis/geoip/">docs.djangoproject.com/en/1.3/ref/contrib/gis/geoip/#example</a> .  And the documentation, I think, is not worth translating.  The next question to pay attention to is Russification.  How to get the name of the country in Russian? <br><br>  For this, I created three models: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WorldPart</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> name_ru = models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">255</span></span>, verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Name RU'</span></span>), null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) name_en = models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">255</span></span>, verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Name EN'</span></span>), null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__unicode__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.name_ru <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Meta</span></span></span><span class="hljs-class">:</span></span> ordering = [<span class="hljs-string"><span class="hljs-string">'name_ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'name_en'</span></span>,] verbose_name = _(<span class="hljs-string"><span class="hljs-string">'Part of the World'</span></span>) verbose_name_plural = _(<span class="hljs-string"><span class="hljs-string">'Parts of the World'</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Country</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> name_ru = models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">255</span></span>, verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Name RU'</span></span>), null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) name_en = models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">255</span></span>, verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Name EN'</span></span>), null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) code = models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">2</span></span>, verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Code'</span></span>), null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) worldpart = models.ForeignKey(WorldPart, verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Part of the World'</span></span>), null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) flag = models.ImageField(upload_to=os.path.join(settings.STATIC_ROOT, <span class="hljs-string"><span class="hljs-string">'img'</span></span>, <span class="hljs-string"><span class="hljs-string">'flags'</span></span>), verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Flag'</span></span>), null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) is_active = models.BooleanField(verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Is active'</span></span>)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__unicode__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.name_ru <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Meta</span></span></span><span class="hljs-class">:</span></span> ordering = [<span class="hljs-string"><span class="hljs-string">'name_ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'name_en'</span></span>,] verbose_name = _(<span class="hljs-string"><span class="hljs-string">'Country'</span></span>) verbose_name_plural = _(<span class="hljs-string"><span class="hljs-string">'Countries'</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">City</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> country = models.ForeignKey(Country, verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Country'</span></span>)) name_ru = models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">255</span></span>, verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Name RU'</span></span>), null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) name_en = models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">255</span></span>, verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Name EN'</span></span>), null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) region = models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">100</span></span>, verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Region'</span></span>), null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) postal_code = models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">10</span></span>, verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Postal Code'</span></span>), null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) latitude = models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">255</span></span>, verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Lattitude'</span></span>), null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) longitude = models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">255</span></span>, verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Longitude'</span></span>), null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) is_active = models.BooleanField(verbose_name=_(<span class="hljs-string"><span class="hljs-string">'Is active'</span></span>)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__unicode__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.name_ru <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Meta</span></span></span><span class="hljs-class">:</span></span> ordering = [<span class="hljs-string"><span class="hljs-string">'name_ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'name_en'</span></span>,] verbose_name = _(<span class="hljs-string"><span class="hljs-string">'City'</span></span>) verbose_name_plural = _(<span class="hljs-string"><span class="hljs-string">'Cities'</span></span>)</code> </pre><br><br>  On the Internet, I found several beautiful bases of countries and cities, and compiled into one with all the fields I needed.  I will not post links to databases, knock on the PM. <br><br>  And this whole mechanism works as follows. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   &gt;&gt;&gt; from django.contrib.gis.utils import GeoIP &gt;&gt;&gt; from myapp.models import * &gt;&gt;&gt; g = GeoIP()    &gt;&gt;&gt; cn = g.country('google.com') &gt;&gt;&gt; cn {'country_code': 'US', 'country_name': 'United States'} &gt;&gt;&gt; try: &gt;&gt;&gt; cn_db = Country.objects.get(code=cn['country_code']) &gt;&gt;&gt; except Country.DoesNotExist: &gt;&gt;&gt; pass</span></span></code> </pre><br><br>  That's all.  Perhaps something superfluous, but I tried to point out the main points as concisely as possible.  Thank you all for your attention. </div><p>Source: <a href="https://habr.com/ru/post/179643/">https://habr.com/ru/post/179643/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179633/index.html">Kiev ITSM meetings</a></li>
<li><a href="../179635/index.html">Tracking the effectiveness of advertising campaigns in the online store</a></li>
<li><a href="../179637/index.html">Google+: content recommendations for your mobile site</a></li>
<li><a href="../179639/index.html">Vain attempts to win the lottery</a></li>
<li><a href="../179641/index.html">Cloud economy</a></li>
<li><a href="../179645/index.html">PHP Sandbox</a></li>
<li><a href="../179647/index.html">Logical processor cache organization</a></li>
<li><a href="../179649/index.html">3 OS on one Nokia N9</a></li>
<li><a href="../179651/index.html">What should be the standards (for example, medical data)</a></li>
<li><a href="../179653/index.html">New reports on PHDays III: from APCS safety to analysis of zero-day exploits in Java</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>