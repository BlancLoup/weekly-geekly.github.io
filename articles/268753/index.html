<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CoffeeScript array comprehensions - fashionable, stylish, slow</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In childhood I was often told that sugar is a white death. Later, I realized that calories are calories, and those who talk about the dangers of sugar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CoffeeScript array comprehensions - fashionable, stylish, slow</h1><div class="post__text post__text-html js-mediator-article">  In childhood I was often told that sugar is a white death.  Later, I realized that calories are calories, and those who talk about the dangers of sugar often simply do not own a materiel. <br><br>  And suddenly it turned out that everything that adults were scaring me with is pure truth.  Sugar is a terrible thing that kills the brain and slowly leads us to Alzheimer's.  It can not be eaten by anyone and never.  This topic is covered in detail in the book of Garry Taub Good Calories Bad Calories, as well as in the book of David Perlmutter Grain Brain. <br><br>  But the article is not about that.  I recently discovered that a group of my comrades are sitting tight on CoffeeScript.  They are not ashamed of this fact and even manage to experience some kind of unnatural pleasure in the process.  Moreover, they do not shy away from using the syntactic sugar contained in coffee, and even wanted to addict me to it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Fortunately, I am endowed with a rare gift.  I always recognize evil, and no matter what clothes it is dressed up this time. <br><a name="habracut"></a><br>  The first dose is carefully (and absolutely free) offered on the official website.  There, right on the start page, the code on the censcript and the javascript code are put into which the compiler will turn it. <br><br>  We must pay tribute to people - they are not trying to deceive you.  The code given on the start page is more than enough to permanently abandon syntactic sugar and, in general, think about it ten times before starting to use an overseas drink.  I will not give the code in its entirety, especially since everyone can look at it on their own.  I will give only a significant piece. <br><table><tbody><tr><td><h3>  CoffeeScript </h3><br></td><td><h3>  Javascript </h3><br></td></tr><tr><td><pre><code class="javascript hljs">cubes = (math.cube num <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> num <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> list)</code> </pre> <br></td><td><pre> <code class="javascript hljs">cubes = (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i, len, results; results = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>, len = list.length; i &lt; len; i++) { num = list[i]; results.push(math.cube(num)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> results; })();</code> </pre><br></td></tr></tbody></table><br>  list is an array, and math.cube, as you might guess, is a function that takes an input parameter to a cube. <br><br><h2>  Javascript code is nightmare </h2><br>  No one of course in his right mind and the bright memory of such a code would not have written itself.  Behind this multi-letter is a simple and well-known construction. <br><br>  cubes = list.map (math.cube); <br><br>  Which, by the way, is clearer and shorter than the Coffeeman version. <br><br><h2>  What is the actual problem </h2><br>  Yes, from an aesthetic point of view, Javascript code is just awful, but when I hinted at it to my comrades, I was reasonably objected that it was the exhaust of the compiler that normal people do not read.  On the contrary, you need to look at this code and be glad that you will never have to write it yourself. <br><br>  The point of view is not new, repeatedly confirmed in practice by such monsters as, for example, Bjarne Stroustrup.  If the compiler doesn‚Äôt mess up, then it‚Äôs really better to trust it, relax and have fun. <br><br>  However, one glance at the above code is enough to realize that the compiler loses its mind at the sight of sugar.  First of all, the post-crimped operator catches the eye, but of course it does not make the weather. <br><br>  The real problem is that the code generated by the compiler is about 3 times slower than <strong>cubes = list.map (math.cube);</strong>  .  Yes, quite right, having thoroughly thrown sugar, you can completely freeze a part of the code three times without getting anything in return. <br><br><h2>  How did that happen </h2><br>  The reason is simple and prosaic to ugliness.  What is called arrays in javascript is called hashes in other programming languages, and the access time by key to the hash element is not the same as the access time to the array element by index.  On the other hand, hash elements are linked into a list, so sequential enumeration of all elements can be done quickly and easily.  Not as fast and not as simple as the elements of this array, but many times faster than the code generated by the CoffeeScript compiler does. <br><br><h2>  Maybe we actually measure different things. </h2><br>  As some probably already noticed - <strong>cubes = list.map (math.cube);</strong>  does the same thing as the code on a coffee script, but in fact is not its direct mapping.  You can accurately display this code like this: <br><br><pre> <code class="javascript hljs">cubes = list.reduce(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">prev, curr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prev.concat(math.cube(curr)); }, []);</code> </pre><br>  Maybe the fact is that a new array is returned to us every time?  Maybe the whole thing is in <strong>.push</strong> and that the array has to be grown?  Well, that is, it is clear that this is impossible, but suddenly?  Maybe so? <br><br><pre> <code class="javascript hljs">list.reduce(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result, curr</span></span></span><span class="hljs-function">) </span></span>{ result.push(math.cube(curr)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }, []);</code> </pre><br>  This is generally a one-to-one mapping, all with the exception of busting taken from the original.  But even such code is still 3 times faster than the code from the main page of CoffeeScript. <br><br><h2>  But you can be more truthful </h2><br>  Or maybe it‚Äôs not just access to the elements?  Let's try to just sum up the values ‚Äã‚Äãof the elements of the array, rather than shift them to a new array. <br><br>  Compare this code: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sum = (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">list</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i, len, sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>, len = list.length; i &lt; len; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> num = list[i]; sum += num; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum; }(list));</code> </pre><br>  Here with this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sum = list.reduce(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">prev, curr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> curr + prev; }, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br>  The results are not so straightforward.  But the difference is still one and a half times in favor of javascript. <br><br><h2>  So it goes </h2><br>  From my point of view, if the technology <s>breaks from the foot</s> right from the door <s>with</s> such applications, this is a reason to think seriously before you start using it.  Of course, if you indulge in CoffeeScript for a long time, and it pleases you - continue to indulge - coffee itself has not killed anyone yet.  Especially considering that lambdas can be used in CoffeeScript without any difficulties and the compiler translates them into lambdas, which, as we have just found out, have no speed problems. <br><br>  But with sugar, at least with some of its types, it is better to bind it - sugar is bad for ya. <br><br><h2>  PS </h2><br>  You can see the test code <a href="https://github.com/poxu/coffeescript_sugar_performance">here</a> . <br><br><h2>  Update </h2><br>  The information presented in the article is valid for the node version v0.10.40.  In the latest version of node and in the latest versions of browsers, the picture is <a href="http://jsperf.com/coffeescript-array-comprehensions">different</a> .  In Chrome version 45, the code generated by CoffeeScript is slower, it seems to be faster in fayfox.  Although it is necessary to collect more statistics. </div><p>Source: <a href="https://habr.com/ru/post/268753/">https://habr.com/ru/post/268753/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268743/index.html">How we buy used server</a></li>
<li><a href="../268745/index.html">Moscow Atlassian Meetup October 20</a></li>
<li><a href="../268747/index.html">Hibernate Developer Documentation - Chapter VI. Caching</a></li>
<li><a href="../268749/index.html">Benefits of Managed Security Service</a></li>
<li><a href="../268751/index.html">Alibaba vs. Facebook is where the West converges with the East</a></li>
<li><a href="../268757/index.html">C ++ Russia in St. Petersburg</a></li>
<li><a href="../268759/index.html">13 basic principles of game design: progression, environment, method and basics</a></li>
<li><a href="../268763/index.html">Parallel execution of dependent tasks and synchronization with conditional variables in the shell</a></li>
<li><a href="../268765/index.html">Back to the Code - Contest Report</a></li>
<li><a href="../268767/index.html">Deploying Applications in InterSystems Cach√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>