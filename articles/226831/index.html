<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Backup Backup Comparison</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Preparing a new server for work should begin with setting up a backup. All, it would seem, know about it - but sometimes even experienced system admin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Backup Backup Comparison</h1><div class="post__text post__text-html js-mediator-article"> <a href="http/blog.selectel.ru/sravnenie-sposobov-rezervnogo-kopirovaniya/"><img src="https://habrastorage.org/getpro/habr/post_images/e66/baa/afa/e66baaafa8673bcb994e9986dc04ab0f.jpg" alt="Backup Backup Comparison" width="100%" height="100%"></a> <br><br>  Preparing a new server for work should begin with setting up a backup.  All, it would seem, know about it - but sometimes even experienced system administrators make unforgivable mistakes.  And the point here is not only that the task of setting up a new server should be solved very quickly, but also that it is not always clear what backup method should be used. <br><a name="habracut"></a><br><br>  Of course, it‚Äôs impossible to create an ideal way that would suit everyone, there are pros and cons everywhere.  But at the same time, it seems quite realistic to choose a method that is most suitable for the specifics of a particular project. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When choosing a backup method, you must first pay attention to the following criteria: <br><ol><li>  The speed (time) of backup in storage; </li><li>  The speed (time) of recovery from backup; </li><li>  How many copies can be kept with a limited amount of storage (backup storage server); </li><li>  The amount of risk due to inconsistency of backups, the lack of smoothness of the method for performing backups, the complete or partial loss of backups; </li><li>  Overhead: the level of load created on the server when copying, reducing the speed of service response, etc. </li><li>  The cost of renting all used services. </li></ol><br><br>  In this article, we will discuss the basic ways of backing up servers running Linux systems and the most common problems that new users may encounter in this very important area of ‚Äã‚Äãsystem administration. <br><br><h2>  The scheme of the organization of storage and recovery from backup </h2><br>  When choosing a scheme for organizing a backup method, you should pay attention to the following basic points: <br><ol><li>  Backups cannot be stored in the same place as the backed up data.  If you store a backup on one disk array with your data, then you will lose it in case of damage to the main disk array. </li><li>  Mirroring (RAID1) cannot be compared with backup.  The raid only protects you from a hardware problem with one of the disks (and sooner or later there will be such a problem, since the disk subsystem is almost always a server bottleneck).  In addition, when using hardware raids there is a risk of a controller breaking, i.e.  it is necessary to keep its spare model. </li><li>  If you keep backups in the same rack in the DC or just in the same DC, then in this situation there are also certain risks (you can read about it, for example, <a rel="nofollow" href="http://habrahabr.ru/company/bitrix/blog/125932/">here</a> . </li><li>  If you keep backups in different DCs, then the network costs and the speed of recovery from a deleted copy dramatically increase. </li></ol><br><br>  Often the cause of data recovery is file system or disk corruption.  Those.  backups need to be stored somewhere on a separate server storage.  In this case, the problem may be the ‚Äúwidth‚Äù of the data transmission channel.  If you have a dedicated server, it is highly desirable to perform backups on a separate network interface, and not on the same one that exchanges data with clients.  Otherwise, your client's requests may not fit into a limited communication channel.  Or, due to client traffic, backups will not be made on time. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c2b/04d/a3f/c2b04da3f3abf7fbe851c0eff870554f.png" alt="Data transfer" width="100%" height="100%"><br><br>  Next, you need to think about the scheme and data recovery time in terms of storing backups.  It may be quite satisfactory for you that backup is performed in 6 hours at night on a storage with limited access speed, but recovery is not enough for 6 hours.  So access to backups should be convenient and data should be copied quickly enough.  For example, the recovery of 1TB of data with a 1Gb / s band will take almost 3 hours, and this is if you do not ‚Äúresist‚Äù the performance of the disk subsystem in the storage and server.  And do not forget to add to this the time of detection of the problem, the time to decide on rollback, the time to check the integrity of the recovered data and the amount of subsequent dissatisfaction of customers / colleagues. <br><br><h2>  Incremental backup </h2><br><blockquote>  In <b>incremental</b> backups, only files that have been modified since the previous backup are copied.  The subsequent incremental backup adds only files that have changed since the previous one.  On average, incremental backups take less time because fewer files are copied.  However, the data recovery process takes more time, since the data of the last full backup should be restored, plus the data of all subsequent incremental backups.  At the same time, unlike differential copying, changed or new files do not replace old ones, but are added to the media independently. </blockquote><br><br>  Incremental backups are most often done using the rsync utility.  With its help, you can save space in the storage if the number of changes per day is not very large.  If the modified files are large, they will be copied completely without replacing previous versions. <br><br>  The backup process using rsync can be divided into the following steps: <br><ol><li>  A list of files on the server being reserved and in the storage is compiled; for each file, metadata (rights, modification time, etc.) or checksum (when using the ‚Äîchecksum key) is read. </li><li>  If the file metadata differs, the file is beaten into blocks and a checksum is considered for each block.  Different blocks are pumped into the repository. </li><li>  If during the calculation of checksums or file transfer a change was made to it, its reservation is repeated from the beginning. </li><li>  By default, rsync transfers data via SSH, which means that each data block is additionally encrypted.  Rsync can also be run as a daemon and transmit data without encryption over its protocol. </li></ol><br><br>  For more information on how rsync works, see the <a rel="nofollow" href="http://rsync.samba.org/how-rsync-works.html">official site</a> . <br><br>  For each rsync file performs a very large number of operations.  If there are many files on the server or if the processor is heavily loaded, the backup speed will be significantly reduced. <br><br>  From experience we can say that problems on SATA disks (RAID1) begin after approximately 200G of data on the server.  In fact, everything, the final one, depends on the number of inodes.  And in each case, this value may shift in one way or the other. <br><br>  After a certain point, the backup time will be very long or simply will not work for a day. <br><br>  In order not to compare all files, there is lsyncd.  This daemon collects information about changed files, i.e.  we will already have a list ready for rsync in advance.  However, it should be noted that it gives an additional load to the disk subsystem. <br><br><h2>  Differential backups </h2><br><blockquote>  With <b>differential</b> backup, every file that has been modified since the last full backup is backed up every time.  Differential copying speeds up the recovery process.  All you need is the last full and last differential backup.  The popularity of differential backup is growing, since all copies of files are made at certain points in time, which, for example, is very important when infected with viruses. </blockquote><br><br>  Differential backups are done, for example, with a utility like rdiff-backup.  When working with this utility, the same problems arise as with incremental backup. <br><br>  In general, if a full file search is performed when searching for data differences, problems of this kind of backup are similar to problems with rsync. <br><br>  We would like to separately note that if in your backup scheme each file is copied separately, then you should delete / exclude files you do not need.  For example, it can be CMS caches.  In such caches, there are usually a lot of small files, the loss of which will not affect the correct operation of the server. <br><br><h2>  Full backup </h2><br><blockquote>  Full backup usually affects your entire system and all files.  Weekly, monthly and quarterly backups imply the creation of a full copy of all data.  It is usually done on Fridays or during weekends, when copying a large amount of data does not affect the operation of the organization.  Subsequent backups, running Monday through Thursday until the next full backup, may be differential or incremental, mainly to save time and space on the media.  Full backups should be done at least weekly. </blockquote><br><br>  In most publications on the relevant topics it is recommended to perform a full backup once or twice a week, and the rest of the time - to use incremental and differential.  In such councils there is a reason.  In most cases, a full backup once a week is enough.  It makes sense to re-execute it if you don‚Äôt have the opportunity on the storage side to update the full backup and to guarantee the correctness of the backup (this may be necessary, for example, in cases where you don‚Äôt trust your existing scripts for one reason or another or software for backup. <br><br>  In fact, a full backup can be divided into 2 parts: <br><ol><li>  Full backup at the file system level; </li><li>  Full device level backup. </li></ol><br><br>  Consider their characteristic features on the example: <br><pre> root @ komarov: ~ # df -h
 Filesystem Size Used Avail Use% Mounted on
 / dev / mapper / komarov_system-root 3.4G 808M 2.4G 25% /
 / dev / mapper / komarov_system-home 931G 439G 493G 48% / home
 udev 383M 4.0K 383M 1% / dev
 tmpfs 107M 104K 107M 1% / run
 tmpfs 531M 0 531M 0% / tmp
 none 5.0M 0 5.0M 0% / run / lock
 none 531M 0 531M 0% / run / shm
 / dev / xvda1 138M 22M 109M 17% / boot
</pre><br><br>  We will only reserve / home.  Everything else can be quickly restored manually.  You can also deploy the server by the configuration management system and connect our / home to it. <br><br><h2>  Full file system level backup </h2><br>  Typical representative: dump. <br><br>  The utility creates a "dump" of the file system.  You can create not only a full, but an incremental backup.  dump works with the inode table and "understands" the file structure (so, sparse files are compressed). <br>  Creating a dump of a working file system is ‚Äústupid and dangerous,‚Äù because the file system can change during the creation of a dump.  It should be created from snapshot (a bit later we will discuss the features of working with snapshots in more detail), unmounted or frozen filesystem. <br><br>  Such a scheme also depends on the number of files, and its execution time will increase with increasing amount of data on the disk.  At the same time, dump speed is higher than rsync. <br>  In case you need to renew not the backup copy as a whole, but, for example, only a couple of accidentally damaged files), the restore utility can take too long to extract these files <br><br><h2>  Full device level backup </h2><br><ol><li>  mdraid and DRBD <br>  In fact, RAID1 is configured with a disk / raid on the server and a network drive, and from time to time (in terms of the frequency of backups), the additional disk is synchronized with the main disk / raid on the server. <br><br>  The biggest plus is speed.  The duration of synchronization depends only on the number of changes made on the last day. <br>  Such a backup system is used quite often, but few people are aware that the backups obtained with its help may be incapable, and here's why.  When disk synchronization is complete, the backup disk is disabled.  If we have, for example, running a DBMS that writes data to the local disk in batches, storing intermediate data in the cache, there is no guarantee that they will fall onto the backup drive at all.  At best, we will lose some of the variable data.  Therefore, such backups can hardly be considered reliable. </li><li>  LVM + dd <br>  Snapshots are a great tool for creating consistent backups.  Before creating a snapshot, you need to reset the cache of the file system and your software to the disk subsystem. </li></ol><br><br>  For example, with one MySQL it will look like this: <br><pre> $ sudo mysql -e 'FLUSH TABLES WITH READ LOCK;'
 $ sudo mysql -e 'FLUSH LOGS;'
 $ sudo sync
 $ sudo lvcreate -s -pr -l100% free -n% s_backup / dev / vg /% s
 $ sudo mysql -e 'UNLOCK TABLES;'
</pre><br><br>  * Colleagues tell stories how someone ‚Äúread lock‚Äù sometimes led to deadlocks, but in my memory, this has never happened before. <br><br>  Then you can copy snapshot in storage.  The main thing is to ensure that during copying the snapshot does not self-destruct and not to forget that when creating snapshots, the recording speed will drop significantly. <br><br>  Backups of the DBMS can be created separately (for example, using binary logs), thereby eliminating the idle time for the cache reset time.  And you can create dumps in the repository by running the instance DBMS there.  Backup of different DBMS is a subject for separate publications. <br><br>  You can copy snapshots using a resume (for example, rsync with a patch to copy block devices <a href="https://bugzilla.redhat.com/show_bug.cgi%3Fid%3D494313">bugzilla.redhat.com/show_bug.cgi?id=494313</a> ), by blocks and without encryption (netcat, ftp).  You can transfer blocks in compressed form and mount them in storage using AVFS, and mount a server partition with SMB backups. <br><br>  Compression eliminates the problems of transmission speed, channel clogging and storage space.  But, however, if you do not use AVFS in the storage, then it will take a long time to restore only a portion of the data.  If you use AVFS, you will come across its ‚Äúdampness‚Äù. <br>  An alternative to block compression is squashfs: you can mount, for example, a Samba partition to the server and execute mksquashfs, but this utility also works with files, i.e.  depends on their quantity. <br><br>  In addition, when creating a squashfs, a lot of RAM is spent, which can easily lead to a call to the oom-killer. <br><br><h2>  Security </h2><br>  You need to protect yourself from the situation when the storage or your server will be hacked.  If a server is hacked, then it is better that the user who writes data there has no right to delete / change files in the repository. <br>  If the storage is hacked, then the backup user rights on the server should also be limited to the maximum. <br><br>  If the backup channel can be heard, then encryption is needed. <br><br><h2>  Conclusion </h2><br>  Each backup system has its own disadvantages and advantages.  In this article we tried to highlight some of the nuances when choosing a backup system.  We hope that they will help our readers. <br><br>  As a result, when choosing a backup system for your project, you need to conduct tests of the selected backup type and pay attention to: <br><ul><li>  backup time at the current stage of the project; </li><li>  backup time in case the data will be many times longer; </li><li>  channel load; </li><li>  load on the disk subsystem on the server and in the storage; </li><li>  recovery time of all data; </li><li>  recovery time of a pair of files; </li><li>  the need for data consistency, especially database; </li><li>  memory usage and availability of oom-killer calls; </li></ul><br><br>  As backup solutions, you can use supload and our <a href="http://storage.selectel.ru/">cloud storage</a> . <br>  Readers who can not leave comments here are invited to our <a href="http://blog.selectel.ru/sravnenie-sposobov-rezervnogo-kopirovaniya/">blog</a> . </div><p>Source: <a href="https://habr.com/ru/post/226831/">https://habr.com/ru/post/226831/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../226817/index.html">Yandex and security. As we studied and neutralized wrappers (aggressive adware)</a></li>
<li><a href="../226823/index.html">Creating audio plug-ins, part 8</a></li>
<li><a href="../226825/index.html">Cross selling: we increase the average amount of goods in the basket</a></li>
<li><a href="../226827/index.html">Mobile software development: integration issues</a></li>
<li><a href="../226829/index.html">Stock Market Toolkit: What are Options and How Do They Work?</a></li>
<li><a href="../226835/index.html">Gadgets that you wanted to take on vacation</a></li>
<li><a href="../226839/index.html">SSO using Jasig CAS Server 4.0.0. Part 2</a></li>
<li><a href="../226843/index.html">MVbind - Backbone extension for data binding between Model and View</a></li>
<li><a href="../226847/index.html">New encryption options for Android found</a></li>
<li><a href="../226853/index.html">What should be a good map - guidelines on Yandex.Maps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>