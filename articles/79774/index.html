<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New Year's gift to hosters: How to place on the server 10,000 clients or even more</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today I want to make a New Year's gift, and since the most valuable thing in the world is experience, knowledge and technology, I want to share it all...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New Year's gift to hosters: How to place on the server 10,000 clients or even more</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/694/fa1/008/694fa10089d7dd73e3713c4da9f6b5bd.jpg" alt="image"><br><br>  Today I want to make a New Year's gift, and since the most valuable thing in the world is experience, knowledge and technology, I want to share it all with you.  I hope that my three-year experience as a system engineer / architect will help some hosters to discover new horizons for themselves. <br><br>  It should be noted that, under the client, a normal LAMP account (Linux + Apache + Mysql + PHP) is perceived, with one or two virtual hosts and the default php.ini working with all options.  The main one is 16MB RAM and 30 seconds of execution.  Quite enough for most engines - Wordpress, Drupal and Joomla. <br><a name="habracut"></a><br><h4>  Iron </h4><br>  Of course, the most important thing is to choose the server correctly.  Experimentally, the optimal combination was found - Dell 905 + MD 1000 basket. A little more about the configuration.  Of course, the server will work with two 6-nuclear Opteron.  The memory for ~ 15k clients, namely, I worked so much on my server, 128G was enough, but you can try 64G + swap, if of course you don‚Äôt feel sorry for your clients;) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There is nothing to say about the basket - everyone needs a place for the site.  The only thing - you need to competently break the stack, but more on that later.  You can use SAS, but you can - cheaper SATA.  In my case, SATA was enough for 15k, but if you plan more, you will have to take SAS. <br><br><h4>  Soft </h4><br>  Of course, only the web should work on the server.  MySQL is only on a separate server.  Mail is the same, and sending is something easy, like ssmtp, and not monsters like exim / sendmail.  But in general, it is not important.  There are more important things to consider. <br><br>  First of all, this is the ratio of the use of RAM and bit depth.  I am sure that everyone knows why 64-bit binaries take up more RAM when working.  But who knows what the bottleneck is when working with many sites?  The correct answer is their logs. It is the logs that take up most of the server's resources, since working with a write disk is the slowest part of the system.  The conclusion is simple - you need to do something with the logs and use 32-bit software instead of 64-bit software. <br><br>  With logs, at first there was an idea to make mod_log_spread under the second Apache.  Or even use the first one only for logs.  But a static survey helped - most clients did not use web server logs and simply turned them off by default.  Those who requested - included on request.  And for recording logs naturally used a separate disk. <br><br><h4>  Most delicious </h4><br>  But what about 32-bit software?  And with the fact that with more than 1000 virtual hosts Apache behaves worse and worse?  And here OpenVZ will help us!  Yes, yes, that is how we break the server into 32-bit virtual machines, let us have our own Apache in each one - and voila, it all works fine, since the same virtual players are good at sharing memory with each other, thanks to OpenVZ.  And given that you can connect a separate disk as an arbitrary directory for each virtual machine - the problem with the logs has already been solved only because of this! <br>  Well, now a little about how it all worked from a technical point of view.  I‚Äôll say right away that I reassembled the Apache, throwing out a lot of unnecessary, including ssl, and choosing MPM Worker - the thread apache.  Naturally, each virtual machine used all 12 cores, and the number of processes for Apache was also 12. Like the workers for Nginx. <br><br>  Speaking of Nginx - did I say that there you need to give all the static directly, without touching the Apache?  Probably not, since it goes without saying.  But how to work PHP - it is worth talking in more detail. <br>  Of course, in MPMWorker, mod_php cannot be run on production - whatever the homegrown "administrators" would say, it falls and will fall because many of its extensions do not know how to work in threads, which has already been discussed a lot.  So the only option left is mod_fastcgi + PHP-FPM.  And it is natural that in each virtualka twisted 12 PHP processes. <br><br>  Thus, each virtual machine was a bundle of 32-bit applications: nginx + apache-worker + php-fpm.  Raid-1 was created for each virtual machine in the basket, a separate shared disk was made for logs, which was connected to the logs directory.  Then I looked at it all and thought - and if we have a common disk under the logs, why not make one common nginx for all virtuals?  After all, OpenVZ works with virtual machines at the file system level, rather than block devices, and accordingly all files are accessible from the hardware node, you only need to substitute the path to the virtual directory. <br>  No sooner said than done.  Production server on 10k virtualok should consist of: <br><ul><li>  32-bit virtual machines with 1k hosts on each </li><li>  A dedicated disk for each virtual machine </li><li>  Apache in the thread mode + PHP-FPM, taking into account the processes by the number of cores </li><li>  Single nginx on all virtuals for the return of statics and acceleration </li><li>  Dedicated disk for recording logs + minimizing them </li></ul><br>  Well, in the end - a bonus about the filer.  If you fill the rack with such iron + give 1 server more than the baskets, then a very fault-tolerant system comes out.  All data lies in the basket, and on the server - a regular script that runs each found disk as an OpenVZ + container connects the dedicated disk to each virtual machine for logs.  If one of the servers fails, then we simply connect the backup to the basket, and the broken one is quietly returned for repair. <br><br>  PS The cost of iron for the placement of ~ 500k customers with discounts (purchased through the Data Center in the US) was ~ 90k $.  Or in other words - the cost of half a hundred customers - just nine bucks without taking into account rack, food and traffic. </div><p>Source: <a href="https://habr.com/ru/post/79774/">https://habr.com/ru/post/79774/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../79765/index.html">Communications in 2020</a></li>
<li><a href="../79769/index.html">Voxelstein 3D / Voxelstein 3D, Happy New Year</a></li>
<li><a href="../79770/index.html">ExtJS. Presentations in the examples</a></li>
<li><a href="../79772/index.html">Proverbs, expelled from Earth - do not let shelter on other planets!</a></li>
<li><a href="../79773/index.html">Finally we can say: ‚ÄúThere are millions of us!‚Äù</a></li>
<li><a href="../79779/index.html">Is Habrapoisk useful to you?</a></li>
<li><a href="../79781/index.html">Overview of RSS aggregators for Linux</a></li>
<li><a href="../79782/index.html">[Ukraine] Rate Your family from U'tel</a></li>
<li><a href="../79786/index.html">Thanks for the link, zero years!</a></li>
<li><a href="../79789/index.html">Screencasts of Realaxy Actionscript Editor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>