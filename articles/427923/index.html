<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I added a new device to SmartThings Hub, part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to tell you about my experience in developing the so-called Device Handler for the smart home SmartThings. The task was to add ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I added a new device to SmartThings Hub, part 1</h1><div class="post__text post__text-html js-mediator-article">  In this article I want to tell you about my experience in developing the so-called Device Handler for the smart home SmartThings.  The task was to add a universal device based on the Z-Wave protocol - <a href="https://z-uno.z-wave.me/technical/">Z-Uno</a> , as well as the processing of child devices connected to it. <br><br><img src="https://habrastorage.org/webt/z7/oy/id/z7oyidfngexle4mupi8hhkxjmbg.png"><br><a name="habracut"></a><br>  Introduction to development took me quite a lot of time, but after <s>enlightening a</s> careful study of most of the documentation, further development did not require much effort.  In consequence of this, it was decided to write this article in order to facilitate the work of the Russian-speaking user. <br><br>  The entire development process takes place in the Groovy SmartThings IDE web application.  Testing is more convenient from a mobile device, but it is possible to create device simulators in the same development environment.  In the case of testing the graphical shell, it is already necessary to use the SmartThings Classic mobile application ( <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.smartthings..">Android</a> , <a href="https://itunes.apple.com/app/samsung-connect/id1222822904%3Fmt%3D8">iOS</a> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A connected device is a board that allows you to add control to almost any device in Z-Wave.  And the connected devices can be a different number (up to 32 pieces).  Accordingly, at the software level, all types of connected devices must also be processed and transferred to the application. <br><br>  The list of processed types: <br><br><ul><li>  Switch Binary - devices having only two positions: on / off </li><li>  Switch Multilevel - devices that can be turned off or on with a different value.  For example dimer. </li><li>  Sensor Multilevel - sensors sending non-binary values.  For example, a temperature sensor. </li><li>  Meter - devices like counter </li><li>  Notification - binary sensors will refer to this type.  For example, a reed sensor. </li><li>  Thermostat - a separate class of teams that is responsible for working with the thermostat </li></ul><br><br><h3>  Document structure </h3><br>  There are two logical blocks: <br><br><ul><li> Description and meta-information about the handler.  This includes information about the device, how the UI and other information should be drawn.  It is allocated by the <code>metadata()</code> method. <br><br><img width="300" src="https://habrastorage.org/webt/pv/lc/wr/pvlcwrzmhfhltg1s2vvhp5zdx64.jpeg"><br></li><li>  Handler methods are handler logic.  They are responsible for ‚Äúcommunicating‚Äù with the device. <br><br>  Separately, you can select the method parse (), which is engaged in the interpretation of commands received from the device. </li></ul><br>  I will describe in more detail the purpose and content of each block during the cycle of articles. <br><br><h2>  Metadata </h2><br>  As you can see from the name of the method - it contains meta information. <br><br>  Consider in order what is included in this block: <br><br><h3>  Definition () </h3><br>  In this method, arguments specify three things, respectively: the name of the processor, the namespace, and the name of the author. <br><br><ul><li>  The name of the handler will be used in the future when publishing and creating child devices. </li><li>  The namespace is used when searching for handlers by name to make sure that the correct one is found, for example, among handlers with the same name.  SmartThings recommends using your nickname on github. </li><li>  The name of the author is filled with your name. </li></ul><br><pre> <code class="hljs pgsql"> definition(<span class="hljs-type"><span class="hljs-type">name</span></span>: "Your device", namespace: "yournamespace", author: "your name") {}</code> </pre><br>  The following variables can be declared in the method body: <code>attribute, capability, command, fingerprint</code> .  Next, we take a closer look at what it is and when it is applied. <br><br><h3>  Connect and fingerprinting </h3><br>  We connect our device.  In our case, SmartThings V2 Hub and <a href="https://z-uno.z-wave.me/technical/">Z-Uno</a> will be used. <br><br>  At the time of adding a new Z-Wave or ZigBee device, the hub will try to recognize which type of device they are trying to connect to it and will start looking for the most relevant handler.  He will choose it by ‚ÄúFingerprints‚Äù.  If the hub does not find matches in the custom handlers, it will try to use one of the closest standard templates. <br><br>  ‚ÄúFingerprints‚Äù are set in the handler itself to indicate which types of devices it supports.  The official documentation states that they will be different for Z-Wave devices and ZigBee devices; we will consider implementation for Z-Wave. <br><br>  Z-Wave protocol devices store information about their manufacturer, device type, its capabilities, etc.  During the so-called ‚Äúinterview‚Äù with the device, ST collects this information in a Z-Wave raw description.  An example of such a line: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">zw</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ss</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2101</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mfr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0086</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">prod</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0102</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">model</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0064</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ver</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1.04</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">zwv</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:4.05</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lib</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:03</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cc</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:5E</span></span>,86,72,98,84 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ccOut</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:5A</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sec</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:59</span></span>,85,73,71,80,30,31,70,7<span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">role</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:06</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ff</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8C07</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ui</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8C07</span></span></code> </pre><br>  The value of each key is used to fill in the ‚ÄúFingerprint‚Äù.  A detailed description of each item can be found <a href="https://docs.smartthings.com/en/latest/device-type-developers-guide/definition-metadata.html">here</a> .  We will look at those that will be used in our handler. <br><br>  In order to find this line with information, you need to go to the 'My Devices' tab and click on the device of interest to us (before this, the device must be added to the network). <br><br><img src="https://habrastorage.org/webt/ix/uc/yg/ixucyg3owvrk2usf5brdg-zriyw.png"><br><br>  <b>mfr</b> is a 16-bit value containing the manufacturer ID (Manufacturer ID).  A list of manufacturers and their IDs can be found <a href="https://www.silabs.com/documents/login/miscellaneous/SDS13425-Z-Wave-Plus-Assigned-Manufacturer-IDs.xlsx">here</a> . <br><br>  <b>prod</b> - 16-bit value containing Product Type ID - unique ID of the device type. <br><br>  <b>model</b> - a 16-bit value containing the Product ID. <br><br>  <b>inClusters</b> is an 8-bit value that establishes the need for a particular Command Class.  For example, if we need to specify that our handler will work with MultiChannel CC, we need to write its code 0x60.  A list of available for SmartThings <abbr title="Command class">CC</abbr> can be found <a href="https://graph.api.smartthings.com/ide/doc/zwave-utils.html">here</a> . <br><br>  These four keys are enough for the hub to understand exactly which device this handler belongs to.  An example of how they are used by me: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">fingerprint</span></span> mfr: <span class="hljs-string"><span class="hljs-string">"0115"</span></span>, prod: <span class="hljs-string"><span class="hljs-string">"0110"</span></span>, model: <span class="hljs-string"><span class="hljs-string">"0001"</span></span>, inClusters: <span class="hljs-string"><span class="hljs-string">"0x60"</span></span> fingerprint mfr: <span class="hljs-string"><span class="hljs-string">"0115"</span></span>, prod: <span class="hljs-string"><span class="hljs-string">"0111"</span></span>, inClusters: <span class="hljs-string"><span class="hljs-string">"0x60"</span></span></code> </pre><br>  A device may have more parameters, in which case it may successfully connect with this handler, however, if at least one of them does not match the declared fingerprint, the device will ignore this handler. <br><br>  Smartthings recommends adding manufacturer information (mfr) and model (prod, model) to fingerprint to rule out cases where the choice of handler is not obvious.  For example, when the fingerprints of one of the templates or examples used by default will match yours. <br><br>  Location in code <br><pre> <code class="hljs objectivec">metadata { definition(...) { ... fingerprint mfr: <span class="hljs-string"><span class="hljs-string">"0115"</span></span>, prod: <span class="hljs-string"><span class="hljs-string">"0110"</span></span>, model: <span class="hljs-string"><span class="hljs-string">"0001"</span></span>, inClusters: <span class="hljs-string"><span class="hljs-string">"0x60"</span></span> fingerprint mfr: <span class="hljs-string"><span class="hljs-string">"0115"</span></span>, prod: <span class="hljs-string"><span class="hljs-string">"0111"</span></span>, inClusters: <span class="hljs-string"><span class="hljs-string">"0x60"</span></span> } ... }</code> </pre><br><br>  A full cycle of articles is planned, up to release.  I hope this information will help you in the development. </div><p>Source: <a href="https://habr.com/ru/post/427923/">https://habr.com/ru/post/427923/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../427913/index.html">Entertaining prologue # 2</a></li>
<li><a href="../427915/index.html">Presumption of stupidity</a></li>
<li><a href="../427917/index.html">The answer to the post "Presumption of the mind"</a></li>
<li><a href="../427919/index.html">Porting COM to Linux</a></li>
<li><a href="../427921/index.html">4 videos about procrastination</a></li>
<li><a href="../427925/index.html">Migration without victims: technical checklist for moving the site to a new domain</a></li>
<li><a href="../427927/index.html">B - Brutality. Official website of the Table Tennis Federation of the Republic of Bashkortostan (FNT RB)</a></li>
<li><a href="../427929/index.html">Ministry of Labor: test task is an employment relationship</a></li>
<li><a href="../427931/index.html">Information architecture on the Internet, part 4</a></li>
<li><a href="../427933/index.html">Developers' opinion about Steam: maximum revenue and minimum responsibility for Valve</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>