<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We assemble a wi-fi device for controlling electrical appliances with a web server and a JS frontend</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear habrovchane. In this article I‚Äôll somewhat deviate from my traditional approach to DIY - our main goal will be to get results qui...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We assemble a wi-fi device for controlling electrical appliances with a web server and a JS frontend</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear habrovchane.  In this article I‚Äôll somewhat deviate from my traditional approach to DIY - our main goal will be to get results quickly and efficiently, rather than inventing bicycles for the purpose of self-study, so even people holding a soldering iron for the first time can repeat all this and get a ready device for ~ 1000 rubles and one day. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  They say laziness is the engine of progress.  This is, in principle, the correct statement - I personally was always strained by the need to get up and go out to turn off the light when I was almost asleep.  Therefore, even at the second year of university, I assembled a simple AVR device that allows you to turn the chandelier on and off using any remote control.  It still hangs in the same room and has been operating 24/5 for 5 years. <br>  After there was an attempt to get rid of the console - the voice command recognition system, on the same AVR, which I also passed as coursework at the university - she even earned, but not as satisfactory as I would like, so I did not change the awl for soap. <br>  After some time, an understanding was formed that in the vast majority of cases, when I need to turn on or turn off the light, I have either a PC, a tablet, or a communicator within reach and close proximity - therefore, the most convenient way would be to control through them. <br>  I sketched the implementation version on special radio modules, the <a href="http://www.ebay.com/itm/2pcs-x-NRF24L01-SMT-1-27MM-wireless-module-Small-Size-Free-shipping-/160882335785">NRF24L01P</a> is really amazing, for example, the size of the SMD version of this module is only 10x15 mm!  At the same time, they are conveniently managed, they have their own protocol, which handles the addressing, multi-reception, auto-confirmation of reception, etc. <br>  Accordingly, in my estimation, there should have been some kind of USB dongle with this module, in the future - connected to a computer with a web server to allow control from mobile devices, and executive devices with response transceivers. <br>  For a very long time, my hands did not reach all of these systems - for a year now I had wires sticking out of the wall, which I closed every time with my hands, including the chandelier, and saying to myself, ‚ÄúWell, I‚Äôll rake up things at work and sit down and scout the boards. <br>  Fortunately, recent projects at work were related to mobile devices, which should have been able to do a little more than the STM32 and any other Cortex M3 can give, and I spent a lot of time working with OpenWRT and devices like the well-loved TL-MR3020 and TL- WR703, about which I recently wrote <a href="http://habrahabr.ru/post/158127/">an article</a> .  Together with this experience, it came to the realization that such problems are solved incredibly quickly and very effectively with the help of devices with linux and wi-fi on board.  If only because Wi-Fi provides much more convenient (and in the case of the need to transfer video / audio - practically the only available) wireless communication devices supported by all modern devices. <br>  Of course, if there are dozens of management objects, it makes sense to make more stupid actuators on custom modules, and leave servers with Linux to act as nodes.  But in the case when we make a product for real use at home, and not based on hypothetical objects, this approach will only lead to a terrible loss of time and money. <br>  So, let's put together a device in a day that will enable turning on and off a household appliance (up to 1.6 kW of consumption) via Wi-Fi, with a beautiful frontend and without a lot of fuss with boards, firmware and drivers. <br><br><h4>  Software part </h4><br>  Let's start, contrary to tradition, not with hardware, but with the software part, because it is simple enough and you can check it immediately after purchasing the router, even without disassembling it. <br>  I hope that by this time you have already bought the TL-MR3020 and, perhaps, even read my article on rebuilding the kernel.  In fact, you can do without even rebuilding, just flip it with the firmware from the official OpenWRT project wiki - if you later have a desire, you can easily create your firmware by embedding the necessary scripts into it. <br>  So, how will our device be arranged? <br><br><ol><li>  Since it is important for us to keep the minimum number of parts, we will not use any external flash drives and hubs, so the size of the available memory is limited to 4 MB, of which, usually, about 1-1.5 MB is free. </li><li>  Taking into account point 1, we‚Äôll choose the most lightweight web server that supports CGI - the ideal choice was a 20-kilobyte mini-httpd without any add-ons. </li><li>  As a cgi-script, we will use the usual Bashiv scripts.  In principle, the place allows you to put a minimum python assembly.  True, I'm afraid, without rebuilding the kernel, you will not do it - because  Everything that you install after the firmware is installed in JFFS, then it takes much more than if it was built initially in SquashFS.  As an experiment, I built both python-mini and mini-httpd directly into the image, throwing out all unnecessary - with the JFFS image build, the system threw the size overruns, leaving incomplete pieces as a memory, but the SquashFS-image was assembled normally, leaving me ~ 250 KB of free space is enough for our needs.  Another note is that starting python from an internal flash drive is much slower than starting a bash interpreter (and obviously a slower than from an external USB flash drive, the SPI interface affects), so when using Python scripts for CGI, the response will be about 1 second - not very critical, but slightly annoying.  However, if I were writing something more complicated than jerking with one GPIO, I would be much more annoyed by the huge and nasty bash script, and I would prefer to come to terms with the second start of the python interpreter </li><li>  A bash script will pull one of the available GPIOs on which the LED hangs.  After that we‚Äôll unsolder the LED and add a solid-state relay to it, the control circuit of which is essentially the same LED. </li><li>  Index.html will contain a small js-code to display a beautiful image with a light bulb that will light up / go out when pressed, performing an asynchronous query to the CGI script, and will also pull it every N seconds, in case someone has already lit the light bulb from another computer - to update the image in accordance with the status. </li><li>  We power it all on the power supply unit that comes with it, having first disassembled it, removing the module itself from the case to reduce the size of the final device.  This step is optional, if you want - you can feed as you like. </li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's start.  At this point, you should already change the router to OpenWRT and connect to it via an Ethernet cable. <br>  Go through SSH / WinSCP to the router and go to <b>/ etc</b> <br><br><h6>  We configure wi-fi </h6><br>  for this we go to <b>/ etc / config / network</b> and write there <br><br><pre><code class="bash hljs">config interface <span class="hljs-string"><span class="hljs-string">'wlan'</span></span> option proto <span class="hljs-string"><span class="hljs-string">'dhcp'</span></span></code> </pre> <br>  This will ensure that the wi-fi controller of the IP router receives DHCP from our home Wi-Fi distributor in the face of another router. <br>  In <b>/ etc / config / wireless,</b> caring first-start scripts have already generated the radio settings, it remains to comment out the line <b>#option disabled 1</b> including the wi-fi module and in the section below, the interface descriptor, write something like <br><br><pre> <code class="bash hljs">config wifi-iface option device radio0 option network wlan option mode sta option ssid --- option encryption psk2 option key --</code> </pre><br>  These settings are for WPA2-PSK.  For WPA-PSK encryption will be psk, for the open point of none, for WEP, respectively, wep - it is better to read in more detail on the official wiki <a href="http://wiki.openwrt.org/doc/uci/wireless">here</a> and <a href="http://wiki.openwrt.org/doc/uci/wireless/encryption">here</a> . <br>  We check that everything is good with the help <br><br><pre> <code class="bash hljs">wifi down wifi iwconfig wlan0</code> </pre><br>  If everything is OK, <b>iwconfig</b> will tell you that you are connected to your access point, after which it should be cut off from the e-mail and continue wi-fi setup. <br><br><h6>  Configuring GPIO </h6><br>  Now we need to give access to GPIO pins from user space.  The kernel can do this by itself, there is no need to do anything for this, but the GPIO is already captured by the flashing driver by LEDs.  If you wish, you can not touch the LEDs and their driver, because, according to the <a href="http://wiki.openwrt.org/toh/tp-link/tl-mr3020">wiki</a> , there are several unused GPIOs pulled up to the ground, the pull-up of which can be unsoldered, and then used for their own purposes.  In this case, you do not need to unload the driver; you only need to export the GPIO (shown below).  But we will use pins with LEDs to immediately see the result of the works: <br>  Writing to <b>/etc/rc.local</b> <br><br><pre> <code class="bash hljs">rmmod leds_gpio <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 0 &gt; /sys/class/gpio/<span class="hljs-built_in"><span class="hljs-built_in">export</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> out &gt; /sys/class/gpio/gpio0/direction <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 0 &gt; /sys/class/gpio/gpio0/value</code> </pre><br>  With this we unload the driver that captures the resources, then we say that we want to use a pin 0 in the user space, set it up for output and output 0 there, turning off the LED.  Now you can ignite it with a command <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 1 &gt; /sys/class/gpio/gpio0/value</code> </pre><br>  And pay off - this one: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 0 &gt; /sys/class/gpio/gpio0/value</code> </pre><br>  Just do not forget that our creaking has not yet been completed, so we first reboot the router with the reboot command, checking at the same time how wi-fi rises after a reboot. <br><br><h6>  We configure mini-httpd </h6><br>  If you rebuilt the kernel and embedded mini-httpd into it, then go straight to the configuration, if not, install it from the repository <br><br><pre> <code class="bash hljs">opkg update opkg install mini-httpd</code> </pre><br>  Now we make some minor changes to <b>/etc/mini-httpd.conf</b> , so that its first line looks like <br><br><pre> <code class="bash hljs">cgipat=cgi-bin/**.sh</code> </pre><br>  Now the server will kick everything in <b>/ www / cgi-bin /</b> and whose name ends in <b>.sh</b> as a command, translating its response to the browser. <br><br><h6>  Customize hardware button </h6><br>  In case we don‚Äôt want to reach out to wi-fi, we‚Äôll hang a duplicate action on a single button: in <b>/etc/hotplug2.rules,</b> uncheck the word ‚Äú <b>buttons‚Äù</b> so that pressing the buttons calls up scripts from the corresponding folder, the line should now look like this: <br><br><pre> <code class="bash hljs">SUBSYSTEM ~~ (^net$|^input$|button$|^usb$|^ieee1394$|^block$|^atm$|^zaptel$|^tty$) {</code> </pre><br>  After that, go to <b>/etc/hotplug.d/</b> , create the <b>button</b> folder there, and in it the <b>buttons</b> script (not forgetting to set it to execute with the command <b>chmod + x buttons</b> !) With the following contents: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh if [ "$BUTTON" = "wps" ]; then if [ "$ACTION" = "released" ]; then state=`cat /sys/class/gpio/gpio0/value` if [ "$state" = "0" ]; then echo 1 &gt; /sys/class/gpio/gpio0/value else echo 0 &gt; /sys/class/gpio/gpio0/value fi fi fi</span></span></code> </pre><br>  Now pressing the button will toggle the status of the LED.  If desired, you can make the LED under this button glow in antiphase with the manager, that is, with the chandelier extinguished, the hardware enable button is lit to simplify its search in the dark - for this simply export pin 26 to <b>rc.local</b> as well as pin 0 exported and add similar output lines 1/0 to its value next to the zero pin in <b>value</b> . <br><br>  This can be checked right away - if you did everything correctly, then pressing the button will cause a change in the state of the LED. <br><br><h6>  Writing a CGI script </h6><br>  Now we leave <b>/ etc</b> and go to <b>/ www</b> , where we create the <b>cgi-bin directory</b> , and in it is the <b>light-control.sh</b> script, which we do <b>chmod + x</b> with the following contents: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh echo "content-type: text/html" echo "" input=$(echo $QUERY_STRING | tr "&amp;" "\n") for param in $input do name=`echo $param | cut -f 1 -d "="` value=`echo $param | cut -f 2 -d "="` if [ "$name" = "action" ]; then if [ "$value" = "on" ]; then echo 1 &gt; /sys/class/gpio/gpio0/value elif [ "$value" = "off" ]; then echo 0 &gt; /sys/class/gpio/gpio0/value fi fi done cat /sys/class/gpio/gpio0/value</span></span></code> </pre><br>  The first two lines after <i>#! / Bin / sh are</i> required for a CGI script - we tell the browser that everything is ok and we will now issue a html, after which we‚Äôll send two helms in accordance with the requirements of the standard. <br>  Then we take the parameters from the <b>$ QUERRY_STRING</b> variable, where the careful mini-httpd put them, and parse each into <b>name</b> and <b>value</b> .  In general, only one parameter will be used here, but let the code be in a more general form, in case we decide to expand. <br>  Next, we check - if they give us the <b>action = on</b> , then we light the diode, if <b>action = off</b> - we extinguish. <br>  And after that we always return what we read from <b>value</b> - 1 if the diode is on, 0 - if not.  Thus, if we pull our script from the outside with any parameter except <b>action = on / off</b> or no parameter at all, we will get the current status of the LED from it. <br><br><h6>  We write frontend </h6><br>  We throw in the directory <b>/ www</b> downloaded from off.  <a href="">jquery</a> site - it‚Äôs really convenient to do Ajax requests - I saw all these java-scripts for the first time in my life (because this is the area farthest from my studies and interests), but in 5 minutes I‚Äôve mastered the actions I‚Äôve been using Google .  Save jquery as <b>jquery.js</b> <br>  We also keep the pictures below under the names of <b>lamp_on.jpg</b> and <b>lamp_off.jpg</b> , which symbolize our chandelier - made them from a picture taken from Google by cutting it into two parts and easily fitting to each other.  If desired, you can use any pictures. <br><br><img src="https://habrastorage.org/storage2/b2e/6e2/3c2/b2e6e23c2a86ce31b3ba1a0d0e553710.jpg"><br><br><img src="https://habrastorage.org/storage2/256/f94/fe0/256f94fe057013b39e66a9e9dd22219f.jpg"><br><br>  In the same place we create <b>index.html</b> in which we write <br><br><pre> <code class="javascript hljs">&lt;html&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">head</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"jquery.js"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="undefined"></span><span class="hljs-tag"><span class="xml"><span class="undefined"></span><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="javascript"><span class="xml"><span class="javascript"> </span></span><span class="hljs-function"><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span></span><span class="xml"><span class="javascript"><span class="hljs-function"> </span></span></span><span class="hljs-title"><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-title">LampImgOn</span></span></span></span></span><span class="xml"><span class="javascript"><span class="hljs-function">(</span></span></span><span class="hljs-params"></span><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span></span><span class="xml"><span class="javascript">{ $(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'#lamp_off'</span></span></span></span><span class="xml"><span class="javascript">).hide(); $(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'#lamp_on'</span></span></span></span><span class="xml"><span class="javascript">).show(); } </span></span><span class="hljs-function"><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span></span><span class="xml"><span class="javascript"><span class="hljs-function"> </span></span></span><span class="hljs-title"><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-title">LampImgOff</span></span></span></span></span><span class="xml"><span class="javascript"><span class="hljs-function">(</span></span></span><span class="hljs-params"></span><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span></span><span class="xml"><span class="javascript">{ $(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'#lamp_on'</span></span></span></span><span class="xml"><span class="javascript">).hide(); $(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'#lamp_off'</span></span></span></span><span class="xml"><span class="javascript">).show(); } </span></span><span class="hljs-function"><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span></span><span class="xml"><span class="javascript"><span class="hljs-function"> </span></span></span><span class="hljs-title"><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-title">ProcessResult</span></span></span></span></span><span class="xml"><span class="javascript"><span class="hljs-function">(</span></span></span><span class="hljs-params"><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-params">data</span></span></span></span></span><span class="xml"><span class="javascript"><span class="hljs-function">) </span></span></span></span><span class="xml"><span class="javascript">{ </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">if</span></span></span></span><span class="xml"><span class="javascript">(data==</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">"1\n"</span></span></span></span><span class="xml"><span class="javascript">) LampImgOn(); </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">else</span></span></span></span><span class="xml"><span class="javascript"> LampImgOff(); } $(</span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">document</span></span></span></span><span class="xml"><span class="javascript">).ready(</span></span><span class="hljs-function"><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span></span><span class="xml"><span class="javascript"><span class="hljs-function">(</span></span></span><span class="hljs-params"></span><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span></span><span class="xml"><span class="javascript">{ $.ajaxSetup({ </span></span><span class="hljs-attr"><span class="xml"><span class="javascript"><span class="hljs-attr">cache</span></span></span></span><span class="xml"><span class="javascript">: </span></span><span class="hljs-literal"><span class="xml"><span class="javascript"><span class="hljs-literal">false</span></span></span></span><span class="xml"><span class="javascript"> }); $(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'#lamp_on'</span></span></span></span><span class="xml"><span class="javascript">).hide(); jQuery.get(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'/cgi-bin/light-control.sh'</span></span></span></span><span class="xml"><span class="javascript">, {</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'action'</span></span></span></span><span class="xml"><span class="javascript">: </span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'none'</span></span></span></span><span class="xml"><span class="javascript">}, ProcessResult); $(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'#lamp_on'</span></span></span></span><span class="xml"><span class="javascript">).click(</span></span><span class="hljs-function"><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span></span><span class="xml"><span class="javascript"><span class="hljs-function">(</span></span></span><span class="hljs-params"></span><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span></span><span class="xml"><span class="javascript">{ jQuery.get(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'/cgi-bin/light-control.sh'</span></span></span></span><span class="xml"><span class="javascript">, {</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'action'</span></span></span></span><span class="xml"><span class="javascript">: </span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'off'</span></span></span></span><span class="xml"><span class="javascript">}); LampImgOff(); }) $(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'#lamp_off'</span></span></span></span><span class="xml"><span class="javascript">).click(</span></span><span class="hljs-function"><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span></span><span class="xml"><span class="javascript"><span class="hljs-function">(</span></span></span><span class="hljs-params"></span><span class="xml"><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span></span><span class="xml"><span class="javascript">{ jQuery.get(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'/cgi-bin/light-control.sh'</span></span></span></span><span class="xml"><span class="javascript">, {</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'action'</span></span></span></span><span class="xml"><span class="javascript">: </span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'on'</span></span></span></span><span class="xml"><span class="javascript">}); LampImgOn(); }) </span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">window</span></span></span></span><span class="xml"><span class="javascript">.setInterval(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">"jQuery.get('/cgi-bin/light-control.sh', {'action': 'none'}, ProcessResult)"</span></span></span></span><span class="xml"><span class="javascript">,</span></span><span class="hljs-number"><span class="xml"><span class="javascript"><span class="hljs-number">2000</span></span></span></span><span class="xml"><span class="javascript">); }); </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">head</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;body bgcolor=<span class="hljs-string"><span class="hljs-string">"#000000"</span></span>&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">img</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'lamp_off'</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'lamp_off.jpg'</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'40%'</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'display:none'</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">img</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'lamp_on'</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'lamp_on.jpg'</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'40%'</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'display:none'</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br><br>  Here we post on the page two initially invisible pictures with a lit and extinguished lamp, and the Java script after the start requests the CXI (using the <b>action = none</b> parameter) the current status, and transfer the result to the <b>ProcessResult</b> , which activates a particular picture.  The same function is called after asynchronous status switch requests (which are executed in the event handlers for the click on pictures), and a timer is set, which every 2000 ms the script pulls about the status to display the actual data when someone changes them from another page or a hardware button. <br><br>  That's all - now you can go to the browser on our router's IP and enjoy the beautiful page that controls the LED.  If you click on the button of the router when the page is open and wait for 2 seconds, the picture itself will change due to a request made by the timer. <br>  At this point, the software is completed, go to the piece of iron. <br><br><h4>  Iron </h4><br>  As for the hardware, the situation is twofold.  Actually, we have the simplest circuit - the control circuit of a solid-state relay is essentially the same LED, and all that is needed is to ensure that enough current flows through it.  In S202S02, this is at least 8 mA. <br>  Unfortunately, it‚Äôs impossible to get it directly from GPIO - the voltage on the GPIO is 2.6V, after which there is a resistor in a very small case of 260 Ohms and an LED with a voltage drop of about 1.5V.  Thus, about 4-5 mA flows through it.  The drop in S202S02 is from 1.2 to 1.4V, so something will be about the same there.  You can, of course, search for a resistor in the same package, but of a smaller nominal, solder it, and load the unfortunate GPIO at 10 mA, but it‚Äôs better to go in a simpler way - the base-emitter of the NPN transistor will perform the LED role, through which at 0.75V a current of 0.7 mA will flow and in the collector we will turn on the control relay circuit. <br>  The problems are different.  There are actually two of them: <br><br><ol><li>  You need to unsolder the LED (we have a LED4 LED) and solder our transistor instead </li><li>  It is necessary to pack something up into the case of the relay (well, it is not difficult, it is shallow) and the inside of the power supply. </li></ol><br>  With regard to paragraph 1. Textolite, which performed the scheme, quite simply shitty. <br>  The tracks and pads breaks instantly, the solder - to match the PCB - begins to melt when this very PCB is starting to burn. <br>  With regard to paragraph 2. If the case is 5 mm higher - there would be no problems.  But alas, the power supply capacitors and the pulse transformer are too high for the case to close. <br>  Unfortunately, I did not find any perfect magical solution that allows you to cram nevpihuemoe beautifully and quickly into the body.  There are a lot of kostylny options - from buying a plastic case into which it all fits (normal, in general, an option), and ending with blue electrical tape and rubber bands to keep the original case intact. <br>  I chose something in between - because  I still had polymorph-plastic, I laid a narrow strip of it around the perimeter of the original case and pressed the lid into it. <br>  So in this matter, I recommend everyone to find a solution that suits him.  Of course, if you use a large case, or attach a power supply outside of this small one, you don‚Äôt have to completely unplug the connectors, I‚Äôll just tell you what I did. <br>  So that the board could fit into the case along with the power supply, I soldered all the connectors (Ethernet, USB-Host, micro-USB-Power) from it, as well as the isolation from the power supply.  The board has become sharply flat.  If you do this - be very, very attentive.  I paid for my carelessness by setting the flow from the hairdryer too strong, as a result of which the critical U5 converter giving 3.3 in the system was repaired.  Moreover, he was blown to the floor and had to look for him for a long time - but, fortunately, he managed to solder him back. <br><br><img src="https://habrastorage.org/storage2/1f1/11d/c9d/1f111dc9d93a8da1d6136fd864233083.jpg"><br><br>  Pay attention to the jumper <b>R113</b> (circled in red) - by default it is open.  Having closed it, we will be able to supply power to the router via the USB-Host connector - and there it‚Äôs easier and more reliable to solder there.  he is not SMD.  Therefore, we close the <b>R113</b> and calmly solder two wires for power supply to the holes from under the connector. <br>  Noticed how hard it is to solder the wire in the "earthen" hole?  It is connected to the polygons of the earth on all layers where they are - the heat sink is crazy, my soldering iron barely coped. <br>  And this is how the inside of the power supply looks like (next to the router board for scale) <br><br><img src="https://habrastorage.org/storage2/665/e7c/24f/665e7c24fef1f377eae6ef33a4ebd82a.jpg"><br><br>  We unsolder two sickly wires, which previously went to the plug, and solder there something more reliable, which we will then connect to the 220V network.  At the same time, we unsolder its USB connector, as we connect it directly to our router power wires. <br>  We prepare the relay by soldering so that later the power wires do not touch anything.  I soldered like this: <br><br><img src="https://habrastorage.org/storage2/ae7/5e9/b09/ae75e9b098a32344a2f25bdecd3843a8.jpg"><br><br>  After soldering we push in heat shrinkage, or we wrap it up with tape, or cover it with some kind of sealant or something similar (by the way, this very sealant can be seen on the photo of the power supply unit - it was originally, the Chinese also care about TB). <br>  Then we solder the transistor - I took the first 2N6517 under my arm and soldered it with the base to the site where <b>LED4</b> had written <b>+</b> , with the emitter - to the second. <br><br><img src="https://habrastorage.org/storage2/f16/fe4/3f2/f16fe43f276360e8de9e161f83425b2a.jpg"><br><br>  So here.  So do not.  Because one wrong movement is enough and you will break both platforms, then you will have to be soldered to the resistor.  It is better to solder thin wiring to both sites, fasten them on the board and bring to a safe place.  And - yes - if you solder inaccurately, then you risk, like me, touching the conclusions of the memory chip with a soldering iron and shorting them.  After that, you will curse your crooked hands and try to clean them with tin extractors, braids for brazing, needles - it is checked on yourself for an hour.  Fortunately, it was possible to clear it, but it was incredibly tense. <br>  It remains quite a bit - now we have an ‚Äúopen collector‚Äù type output (the remaining output of the transistor), to which we solder the resistor at the rate of dropping 1.3 volts on the optocoupler - that is, when powered from 3.3V (they are easiest to take, on the non-soldered <b>P1</b> connector on the right in the picture above is the fourth pin), we have to provide a current somewhere in 10 mA, which means exactly 200 ohms. <br>  Now we gently place the power supply unit with the conder down onto the router's board, not forgetting to lay a piece of paper - the metal top of the feeder should not be energized, but it can bridge something, so let it be a piece of paper.  The power wires of the router are soldered to the holes from the USB connector on the unit, the positive pin of the relay is soldered to 3.3V (hole 4 on <b>P1</b> ), the negative pin through a 200 ohm resistor to the collector of the transistor. <br>  We cut one of the lids of the lid so that it does not rest on the power supply, the protrusion intended for pressing the button is increased by cutting the rod from the handle or the same polymorph. <br>  Well, we press it all with a lid, fixing it as you like - with polymorph, electrical tape, rubber bands - which is enough for imagination and materials. <br>  It remains to bring 220V to the power wires of the router, and switch the switched relay wires instead of the chandelier switch or any other household appliance. <br><br>  Happened?  Congratulations, now in your chandelier there is a web server with CGI running Linux, giving users a web frontend in JavaScript, and all of this is about 1000 rubles and one day of fuss. </div><p>Source: <a href="https://habr.com/ru/post/159745/">https://habr.com/ru/post/159745/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../159727/index.html">Blurring the boundaries</a></li>
<li><a href="../159729/index.html">How mobile tv works</a></li>
<li><a href="../159733/index.html">New jQuery adaptive gallery plugin with automatic grouping</a></li>
<li><a href="../159739/index.html">Linux Mint 14 Nadia</a></li>
<li><a href="../159743/index.html">A selection of news about the Windows Azure platform for November</a></li>
<li><a href="../159747/index.html">BitTorrent seeks volunteers to test peer-to-peer broadcasts.</a></li>
<li><a href="../159751/index.html">Overview of useful content services to combat information overload</a></li>
<li><a href="../159753/index.html">Telecom Veteran</a></li>
<li><a href="../159755/index.html">AWS: SNS + SQS Integration</a></li>
<li><a href="../159757/index.html">New rootkit against servers on Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>