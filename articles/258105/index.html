<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Social network on Android for a few days off - part I (client)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Despite the abundance of social networks, over the past few years, a number of new, original and unusual social applications have appea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Social network on Android for a few days off - part I (client)</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  Despite the abundance of social networks, over the past few years, a number of new, original and unusual social applications have appeared, such as <b><a href="https://www.justyo.co/">just yo</a></b> , <b><a href="http://en.wikipedia.org/wiki/Snapchat">snapchat</a></b> , <b>secret</b> , etc. The success of the <b>just yo</b> application, limited to a single function - sending a fixed content message My friends and I also decided to try to write another social network on Android.  Our goal was to outline the range of tasks common to most similar applications, to propose solutions and prepare a skeleton from which everyone can make something original and original without wasting time on resolving routine issues.  The results of the work can be immediately found on <b>github</b> - <a href="https://github.com/aboev/photobook-client">android client</a> and <a href="https://github.com/aboev/photobook-server">server on ruby ‚Äã‚Äãon rails</a> . <br><a name="habracut"></a><br><h3>  Content </h3><br>  <a href="https://habr.com/ru/post/258105/">Concept and functionality</a> <br>  <a href="https://habr.com/ru/post/258105/">Interface</a> <br>  <a href="https://habr.com/ru/post/258105/">Accelerate Photo Upload</a> <br>  <a href="https://habr.com/ru/post/258105/">Count of friends</a> <br>  <a href="https://habr.com/ru/post/258105/">Network requests</a> <br>  <a href="https://habr.com/ru/post/258105/">Authorization</a> <br>  <a href="https://habr.com/ru/post/258105/">SQLite for database contacts, images</a> <br>  <a href="https://habr.com/ru/post/258105/">To be continued</a> <br><br><a name="p1"></a><br><h3>  Concept and functionality </h3><br>  To begin with, we decided on the concept of a new service and chose a model - an <b>instagram</b> and <b>whatsapp hybrid</b> .  From instagram we took the main usage scenario - uploading photos to the friends feed with comments and likes.  And from the principle of organizing the graph of friends, through a notebook on the phone numbers of friends in automatic mode. <br><div class="spoiler">  <b class="spoiler_title">Features of the selected model</b> <div class="spoiler_text">  The selected graph model implies an average network growth rate, since  Each new user can involve a maximum of a few dozen / hundreds of people from the address book.  On the other hand, this approach eliminates the need for moderation and content filtering at the initial stage of development, since  availability of content is determined by the user's personal contacts and prevents mass spamming and other harmful phenomena.  As a result, we have a simple service that is ready to be used among friends and does not require large expenses for operational support from a technical and organizational point of view. </div></div><br>  Next, we outlined the functional minimum of our application: <br><ul><li>  Upload photos and view them in the gallery </li><li>  Manage your list of friends based on a notebook </li><li>  Tape of photos uploaded by friends </li></ul><br><a name="p2"></a><br><h3>  Interface </h3><br>  Having outlined a range of basic functions, we moved on to the interface design.  Each function fits well on a separate fragment and the equiprobability of their use prompts the use of a horizontal <b>swipe</b> transition using the <b>ViewPager</b> (Tutorials on swipe and ViewPager <a href="http://developer.android.com/training/implementing-navigation/lateral.html">tutorial 1</a> <a href="http://www.101apps.co.za/articles/swipe-view-tutorial.html">tutorial 2</a> ).  At the first stage, we got the following transition diagram: <br><div class="spoiler">  <b class="spoiler_title">Fig.</b>  <b class="spoiler_title">1. Transition Chart</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e47/b8e/da7/e47b8eda7adb4f42a01b8b5a8780c540.png" alt="image"></div></div><br>  Consider each of the fragments in more detail. <br><br><h5>  Contact sheet </h5><br><div class="spoiler">  <b class="spoiler_title">Fig.</b>  <b class="spoiler_title">2. Contact list - wireframe and screenshot</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/ad6/d3c/c6c/ad6d3cc6ca7748dc99292fc8a824247e.png" alt="image"></div></div><br>  The contact list displays a list of friends in the address book registered in the service, allows you to subscribe, and also opens a detailed user profile when clicked.  It is implemented by the usual <b>ListView</b> ( <a href="http://www.vogella.com/tutorials/AndroidListView/article.html">tutorial</a> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Gallery </h5><br><div class="spoiler">  <b class="spoiler_title">Fig.</b>  <b class="spoiler_title">3. Gallery - wireframe and screenshot</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/147/3b9/fd8/1473b9fd8b284717aee952ce933316ef.png" alt="image"></div></div><br>  The gallery displays local and uploaded photos of the user with a brief description in the title. <br>  Since  the size of the photos, taking into account the title and the aspect ratio may vary, we decided to use the asymmetric <b>GridView</b> from <a href="https://github.com/etsy/AndroidStaggeredGrid">Etsy AndroidStaggeredGrid</a> .  The algorithm for positioning mappings in this case requires a special approach, in particular, in <b>AndroidStaggeredGrid</b> , a <b>DynamicHeightImageView</b> with a predetermined ratio is used instead of an <b>ImageView</b> .  The result is a rather beautiful and smoothly scrolling tiled gallery. <br><br><h5>  Tape </h5><br>  The feed displays photos uploaded by friends that the user has subscribed to.  Here we also applied the usual <b>ListView</b> , since  each photo can occupy a large part of the screen for easy viewing and zooming can take place across the width of the screen.  Clicking on the image opens a detailed description of the photo with comments. <br><br><div class="spoiler">  <b class="spoiler_title">Fig.</b>  <b class="spoiler_title">4. Ribbon - wireframe and screenshot</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/dbf/57e/4e9/dbf57e4e9256499ba4316cd7a48b3688.png" alt="image"></div></div><br><h5>  Detailed description of the photo </h5><br>  A detailed description of the photo contains the metadata of the selected image (author's name, description, number of likes, etc.), as well as a list of comments. <br><div class="spoiler">  <b class="spoiler_title">Fig.</b>  <b class="spoiler_title">5. Photo description - wireframe and screenshot</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/fd0/1f0/de6/fd01f0de69fa4aa1994100de3f6c6964.png" alt="image"></div></div><br><h5>  User Profile </h5><br>  A user profile contains user metadata and a gallery of user uploaded photos. <br><div class="spoiler">  <b class="spoiler_title">Fig.</b>  <b class="spoiler_title">6. User profile - wireframe and screenshot</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/9e9/22e/39b/9e922e39b44f4b49b317692345c8a3fb.png" alt="image"></div></div><br><a name="p3"></a><br><h3>  Accelerate Photo Upload </h3><br><h5>  L1 / L2 cache </h5><br>  Uploading photos is a key and fairly resource-intensive process.  Photos are downloaded both from the local gallery on the device and from the remote storage.  The loading speed affects the smoothness of the gallery scrolling and the overall convenience of the interface, so we decided to use a two-level cache - L1 cache in RAM and L2 cache on the disk storage device. <br>  We chose the popular <a href="https://github.com/JakeWharton/DiskLruCache">Jake Wharton</a> plugin as a disk L2 cache, it supports logging and provides a convenient wrapper over the standard <b>DiskLruCache</b> from the <b>Android SDK</b> .  L1 cache is implemented by the standard Androids <b>LruCache</b> (see <i>com.freecoders.photobook.utils.DiskLruBitmapCache</i> and <i>com.freecoders.photobook.utils.MemoryLruCache</i> ). <br><br><h5>  Proactive scaling </h5><br>  In the case of news feeds, there is an option when the feed is already loaded and the photos continue to be downloaded from the remote storage.  Then, while scrolling, a <i>hopping effect</i> is possible at the completion of loading, if the user has already scrolled the list down.  To avoid it, we applied <i>proactive scaling of</i> mappings in the tape ‚Äî i.e.  The size of the frame for the photo is calculated based on the aspect ratio and is set before the photo is downloaded from the server.  Thus, the position of the items in the ListView does not change after loading new photos. <br><div class="spoiler">  <b class="spoiler_title">Code 1. An example of proactive scaling in DynamicHeightImageView</b> <div class="spoiler_text">  class FeedAdapter <br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> View </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> position, View convertView, ViewGroup parent)</span></span></span><span class="hljs-function"> </span></span>{ ... holder.imgView.setHeightRatio(feedEntry.image.ratio); holder.imgView.setTag(pos); mImageLoader.get(feedEntry.image.url_medium, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImageListener(pos, holder.imgView, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)); ... }</code> </pre> <br></div></div><br><h5>  Downsampling </h5><br>  In addition, in Android there are restrictions on the maximum size and resolution of the photo displayed on the screen.  This is designed to prevent memory overflow.  Therefore, before downloading a bitmap, you must perform <i>downsampling</i> . <br><div class="spoiler">  <b class="spoiler_title">Code 2. Example of downsampling images</b> <div class="spoiler_text">  class ImageUtils <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculateInSampleSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BitmapFactory.Options options, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reqWidth, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reqHeight)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> height = options.outHeight; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> width = options.outWidth; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> inSampleSize = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (height &gt; reqHeight || width &gt; reqWidth) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> halfHeight = height / <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> halfWidth = width / <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (((halfHeight / inSampleSize) &gt; reqHeight) || ((halfWidth / inSampleSize) &gt; reqWidth)) { inSampleSize *= <span class="hljs-number"><span class="hljs-number">2</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> inSampleSize; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decodeSampledBitmap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String imgPath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reqWidth, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reqHeight)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BitmapFactory.Options options = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapFactory.Options(); options.inJustDecodeBounds = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; BitmapFactory.decodeFile(imgPath, options); options.inSampleSize = calculateInSampleSize(options, reqWidth, reqHeight); options.inJustDecodeBounds = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BitmapFactory.decodeFile(imgPath, options); }</code> </pre><br></div></div><br><h5>  Thumbnails </h5><br>  Also, if the media scanner managed to process all the photos, then thumbnails in the device‚Äôs memory can already be created for them.  This rule is not always fulfilled, but if there is a thumbnail, it greatly speeds up the loading process and avoids downsampling. <br><div class="spoiler">  <b class="spoiler_title">Code 3. Example of downloading thumbnails from MediaStore</b> <div class="spoiler_text">  class ImagesDataSource <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getThumbURI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String strMediaStoreID)</span></span></span><span class="hljs-function"> </span></span>{ ContentResolver cr = mContext.getContentResolver(); String strThumbUri = <span class="hljs-string"><span class="hljs-string">""</span></span>; Cursor cursorThumb = cr.query(MediaStore.Images.Thumbnails.EXTERNAL_CONTENT_URI, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{MediaStore.Images.Thumbnails.DATA}, MediaStore.Images.Thumbnails.IMAGE_ID + <span class="hljs-string"><span class="hljs-string">"= ?"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{strMediaStoreID}, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( cursorThumb != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; cursorThumb.getCount() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ) { cursorThumb.moveToFirst(); strThumbUri = cursorThumb.getString( cursorThumb.getColumnIndex( MediaStore.Images.Thumbnails.DATA )); } cursorThumb.close(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> strThumbUri; }</code> </pre><br></div></div><br><a name="p4"></a><br><h3>  Count of friends </h3><br>  The next step, defining the interface and the logic of the service, was the specification of the friends graph.  We considered two approaches - the principle of friends (like VKontakte) and the principle of subscribers (like on Twitter).  The principle of friends implies mutual consent to access to the gallery and personal profile, and also requires confirmation of acquaintance from the opposite side.  In the case of subscribers, it is not necessary to request confirmation from the opposite side and allows each of the parties to independently determine the sources of filling their photo tape. <br>  This choice implies a directed graph, which will be implemented as strings (subscriber ID, author ID) of the relational database on the server. <br><img src="https://habrastorage.org/files/29f/da7/daf/29fda7dafb95402e925c47f0edba389d.png" alt="image"><br><br><a name="p5"></a><br><h3>  Network requests </h3><br>  All network requests are executed asynchronously, and the result of the operation using the <i>callback</i> interface is transmitted to the requesting module.  In 2013, Google introduced its own <b><a href="http://www.androidhive.info/2014/05/android-working-with-volley-library-1/">Volley</a></b> plugin as a replacement for <b>Apache HTTPClient</b> .  Its advantages are support for the <i>request queue</i> , <i>prioritization</i> , standard <i>wrappers for string and json</i> requests, <i>keepalive</i> , <i>resubmit</i> on failure, etc. We decided to use it as the basis for most network requests. <br><div class="spoiler">  <b class="spoiler_title">What did not like in Volley</b> <div class="spoiler_text">  Looking ahead, Volley does simplify the development of network interfaces compared to HTTPClient, but at the time of development, standard wrappers for String and Json requests from Volley were still quite raw, for example, they did not allow to configure ContentType or HttpHeaders, there was no support for MultiPart requests, so we had to rewrite them a bit (see com.freecoders.photobook.network.MultiPartRequest and com.freecoders.photobook.network.StringRequest) <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Code 4. Sample network request (User profile request)</b> <div class="spoiler_text">  class ServerInterface <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserProfileRequest</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, String[] userIds, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Response.Listener&lt;HashMap&lt;String, UserProfile&gt;&gt; responseListener, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Response.ErrorListener errorListener)</span></span></span><span class="hljs-function"> </span></span>{ HashMap&lt;String, String&gt; headers = makeHTTPHeaders(); String strIdHeader = userIds.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? userIds[<span class="hljs-number"><span class="hljs-number">0</span></span>] : <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; userIds.length; i++) strIdHeader = strIdHeader + <span class="hljs-string"><span class="hljs-string">","</span></span> + userIds[i]; headers.put(Constants.KEY_ID, strIdHeader); Log.d(LOG_TAG, <span class="hljs-string"><span class="hljs-string">"Get user profile request"</span></span>); StringRequest request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringRequest(Request.Method.GET, Constants.SERVER_URL + Constants.SERVER_PATH_USER, <span class="hljs-string"><span class="hljs-string">""</span></span>, headers, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response.Listener&lt;String&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String response)</span></span></span><span class="hljs-function"> </span></span>{ Log.d(LOG_TAG, response); Type type = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypeToken&lt;ServerResponse &lt;HashMap&lt;String, UserProfile&gt;&gt;&gt;(){}.getType(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ServerResponse&lt;HashMap&lt;String, UserProfile&gt;&gt; res = gson.fromJson(response, type); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; res.isSuccess() &amp;&amp; res.data != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; responseListener != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) responseListener.onResponse(res.data); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (responseListener != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) responseListener.onResponse(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;String, UserProfile&gt;()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (responseListener != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) responseListener.onResponse(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;String, UserProfile&gt;()); } } }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response.ErrorListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onErrorResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(VolleyError error)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((error != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) &amp;&amp; (error.networkResponse != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) &amp;&amp; (error.networkResponse.data != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)) Log.d(LOG_TAG, <span class="hljs-string"><span class="hljs-string">"Error: "</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String(error.networkResponse.data)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorListener != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) errorListener.onErrorResponse(error); } } ); VolleySingleton.getInstance(context).addToRequestQueue(request); }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Code 5. VolleySingleton</b> <div class="spoiler_text">  class VolleySingleton <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VolleySingleton</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addToRequestQueue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request&lt;T&gt; req)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> socketTimeout = <span class="hljs-number"><span class="hljs-number">90000</span></span>; RetryPolicy policy = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultRetryPolicy(socketTimeout, DefaultRetryPolicy.DEFAULT_MAX_RETRIES, DefaultRetryPolicy.DEFAULT_BACKOFF_MULT); req.setRetryPolicy(policy); getRequestQueue().add(req); } ... }</code> </pre><br></div></div><br><a name="p6"></a><br><h3>  Authorization </h3><br>  For authorization, we decided to use a pair of <b>public / private id</b> .  Upon registration, this pair is sent to the client, and the private id is available only to this user and is sent in the HTTP header with each request to the server.  A public id is available to all users and is used by other clients when they request to add friends or view a profile. <br><br><a name="p7"></a><br><h3>  SQLite for database contacts, images </h3><br>  The local client database contains the necessary minimum information to ease the load on the server: <br><ul><li>  Friend list </li><li>  List of uploaded photos </li></ul><br>  The list of friends from the address book registered in the service, their metadata (avatar, name, etc.) is requested on the server each time the application is launched and stored in the local database to fill the first fragment (contact list).  The list of downloaded photos contains metadata of photos uploaded to the server.  Both lists are synchronized with the server in case of reinstalling the application. <br><div class="spoiler">  <b class="spoiler_title">Code 6. Example of working in SQLite</b> <div class="spoiler_text">  class FriendsDataSource <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FriendsDataSource</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SQLiteDatabase database; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SQLiteHelper dbHelper; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String[] allColumns = { SQLiteHelper.COLUMN_ID,SQLiteHelper.COLUMN_NAME, SQLiteHelper.COLUMN_CONTACT_KEY, SQLiteHelper.COLUMN_USER_ID, SQLiteHelper.COLUMN_AVATAR, SQLiteHelper.COLUMN_STATUS}; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> FriendEntry </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createFriend</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String Name, String ContactKey, String UserId, String Avatar, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Status)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//Add new FriendEntry ContentValues cv = new ContentValues(); cv.put(dbHelper.COLUMN_CONTACT_KEY,ContactKey); cv.put(dbHelper.COLUMN_NAME,Name); cv.put(dbHelper.COLUMN_USER_ID,UserId); cv.put(dbHelper.COLUMN_AVATAR,Avatar); cv.put(dbHelper.COLUMN_STATUS,Status); cv.put(dbHelper.COLUMN_TYPE,FriendEntry.INT_TYPE_PERSON); database.insert(dbHelper.TABLE_FRIENDS, null, cv); return null; } public ArrayList&lt;FriendEntry&gt; getFriendsByStatus(int StatusSet[]) { String selection = dbHelper.COLUMN_STATUS + " IN (?"; String values[] = new String[StatusSet.length]; values[0] = String.valueOf(StatusSet[0]); for (int i = 1; i &lt; StatusSet.length; i++) { selection = selection + ",?"; values[i] = String.valueOf(StatusSet[i]); } selection = selection + ") "; selection = selection + " AND " + SQLiteHelper.COLUMN_TYPE + " = " + FriendEntry.INT_TYPE_PERSON; String orderBy = SQLiteHelper.COLUMN_NAME + " ASC"; Cursor cursor = database.query(dbHelper.TABLE_FRIENDS, null, selection, values, null, null, orderBy); ArrayList&lt;FriendEntry&gt; listFriends = new ArrayList&lt;FriendEntry&gt;(); if (cursor == null) { return listFriends; } else if (!cursor.moveToFirst()) { cursor.close(); return listFriends; } do{ listFriends.add(cursorToFriendEntry(cursor)); }while (cursor.moveToNext()); cursor.close(); return listFriends; } private FriendEntry cursorToFriendEntry(Cursor cursor) { FriendEntry friend = new FriendEntry(); friend.setId(cursor.getInt(idColIndex)); friend.setName(cursor.getString(nameColIndex)); friend.setUserId(cursor.getString(userIdColIndex)); friend.setAvatar(cursor.getString(avatarColIndex)); friend.setStatus(cursor.getInt(statusColIndex)); friend.setType(cursor.getInt(typeColIndex)); friend.setContactKey(cursor.getString(ContactKeyColIndex)); return friend; } ... }</span></span></code> </pre><br></div></div><br><a name="p8"></a><br><h3>  To be continued </h3><br>  In this part of the article, we tried to consider only the main issues and problems that we encountered when developing an Android client.  The project was developed in the style of the weekend hackathon and without any commercial purposes, so we do not pretend to the originality of the approaches, we can not boast of a coherent style of the code.  If you have other tips, solutions or ideas for developing mobile social applications, then we will be glad to hear them in the comments.  Also, if you liked or benefited our manual, you can freely use it in your projects, improve or even send pull-requests, for which we will be especially grateful. <br>  In the <b><a href="http://habrahabr.ru/post/258111/">second part,</a></b> we will take a closer look at the server part of the service, features of uploading images to the AWS S3 cloud storage, post-processing of images, delivery of push notifications, etc. <br><br>  Have a great weekend and see you soon! <br><br>  <a href="http://habrahabr.ru/post/258111/">Continued - Part II (Server)</a> </div><p>Source: <a href="https://habr.com/ru/post/258105/">https://habr.com/ru/post/258105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258079/index.html">Moscow Python Meetup "Async: Why and When"</a></li>
<li><a href="../258081/index.html">Macros in InterSystems Cach√©</a></li>
<li><a href="../258083/index.html">Crystal Programming Language</a></li>
<li><a href="../258085/index.html">Canceled the decision of the Nevyansk court to block Bitcoin sites</a></li>
<li><a href="../258101/index.html">CloudFlare ScrapeShield bypass in Java (Android)</a></li>
<li><a href="../258107/index.html">Transitions with CoreAnimation: animating the appearance of the image</a></li>
<li><a href="../258109/index.html">Mexico and Russia: similar problems in learning to develop electronics</a></li>
<li><a href="../258111/index.html">Social network on Android for a few days off - part II (server)</a></li>
<li><a href="../258113/index.html">HL7v3 vs. HL7 FHIR comparison</a></li>
<li><a href="../258115/index.html">Bluetooth heart rate monitor or photoplethysmograph device. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>