<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Methods for determining the location of the user</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 Anyone who has ever been involved in writing user authorization / registration systems probably had to ask the question: ‚ÄúHow do you know m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Methods for determining the location of the user</h1><div class="post__text post__text-html js-mediator-article"><h4>  <b>Foreword</b> </h4><br>  Anyone who has ever been involved in writing user authorization / registration systems probably had to ask the question: ‚ÄúHow do you know more information about a user?‚Äù.  What is it for?  In most cases, to identify <u>this particular</u> user.  Sometimes - to provide any additional features and information, depending on various social parameters, or, perhaps, the user's location or region of residence.  Sometimes, for example, to conduct any scoring.  This article will focus on determining the geographic location of the user. <br><br><h4>  <b>Effective methods for determining</b> </h4><br>  You can think of a lot of methods for obtaining the geographic position of the Internet user.  And all these methods will have their own set of pros and cons, will be more or less effective, depending on the application.  Now I will describe only those methods that are currently used by the project in which I am participating, i.e.  the ones I use directly.  During the existence of the project, enough statistics have already been gathered on them, from which some conclusions can be drawn. <br><a name="habracut"></a><br><br><h5>  1. <b>Data from the soc.</b>  <b>nets</b> </h5><br>  To date, it has become extremely popular to use for authorization (or as additional information) accounts of various social networks and blogs, which allows you to use data from them.  By authorizing a user in this way, you can get a lot of information about him.  The truth here is about the reliability of its not speak, because many indicate in the social.  networks are not ‚Äúreal‚Äù, but ‚Äúdesired‚Äù, or the first thing that came to mind.  Weeding out such things is usually the main task for the developer.  To do this, you need to get information about all the friends of the user and verify the general data.  You can, for example, find the most common place of residence with colleagues / classmates / classmates / friends of the user (in the blue social network, for example, it is very convenient), and, on the basis of these data, find out the real region, region, city and even area of ‚Äã‚Äãthe city where the user lives / works / learns. <br>  Also, in some soc.  networks, it is possible to obtain the user's immediate coordinates, if he is online.  The accuracy of this data, in some cases, leaves much to be desired, but, at a minimum, the area of ‚Äã‚Äãthe city where the user is located can be determined quite reliably. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b><i>Pros:</i></b> <br><ul><li>  Relatively high accuracy when using scoring models based on friends </li><li>  Most users have accounts in the social.  networks </li><li>  You can check the received data for accuracy using data from friends. </li></ul><br><br>  <b><i>Minuses:</i></b> <br><ul><li>  The complexity of implementation, since  It is necessary to study the API of several social services.  networks, compose and implement models for analyzing the data </li><li>  The need for a valid account in the social.  network user (I believe that, despite the prevalence, to demand such data from the user, though, is impossible) </li><li>  Low speed, if you consider the analysis using data from friends </li></ul><br><br>  Implementation, unfortunately, I can not provide for the "secret of the company." <br><br><h5>  2. <b>GeoIP data</b> </h5><br>  Probably the easiest and most accessible way for everyone, however, for the Russian Federation today, often inaccurate. <br><div class="spoiler">  <b class="spoiler_title">Why?</b> <div class="spoiler_text">  The fact is that at the moment most of the existing providers of the regional level were bought up and absorbed by the operators of the federal level.  And why is it bad?  And here is what.  Imagine a situation - in the city of "H" there were 5 small providers.  Everyone worked in their own neighborhood of the city, and, accordingly, had their own pool of IPv4 addresses.  And even a dynamically issued ‚Äúwhite‚Äù IP could be roughly tied to a specific area of ‚Äã‚Äãthe city.  Now the provider of the federal level comes and buys all 5 small providers with their pools of addresses.  Then he brings their network to a certain general form of all the networks of this federal provider.  What do we have in the end?  This federal provider has a huge number of clients and a huge number of IP pools used, depending on the needs, in a particular region.  Ie now the address that previously belonged to the pool of a small local provider can be issued to a client from a completely different city, simply because this address pool is now used for all clients of this provider.  But no one, naturally, will tell anyone and from which area this IP is issued.  Moreover, tomorrow it may be issued to someone else. <br><br>  Also, no one will prevent the user from using, for example, a proxy or VPN to access the Internet on behalf of another IP.  In this case, GeoIP becomes absolutely useless, because it will receive information about this particular proxy or VPN server.  The same happens if the provider provides its customers access to the Internet via NAT (and in the light of problems with the number of free IPv4 addresses, this is becoming more and more common), although in this case, usually, at least you can get a district, region or city. <br></div></div><br><br>  So, it‚Äôs not always possible to rely entirely on GeoIP data, although this method is very convenient - after all, we receive information almost instantly.  For this, usually, a previously downloaded local database is used. <br><br>  <b><i>Pros:</i></b> <br><ul><li>  Easy to use, there are many implementations in different languages. </li><li>  High accuracy (with some exceptions, see above) </li><li>  Speed ‚Äã‚Äãof work (almost instantly getting the result - this is just 1 request to the database) </li></ul><br><br>  <b><i>Minuses:</i></b> <br><ul><li>  The need to keep the IP base up to date </li><li>  The inability to verify the accuracy of the data (only by requests to several databases) </li><li>  A rather large percentage of erroneous data for the Russian Federation at the moment (see above) </li></ul><br><br>  I don‚Äôt see much about ‚Äúhow to do it‚Äù, because on the net, and including.  on Habr√©, full of detailed descriptions.  There are many free libraries and tools available for obtaining GeoIP data.  For example, for PHP you can use <a href="http://www.php.net/manual/ru/geoip.setup.php">the geoip extension</a> . <br><br><h5>  3. <b>Using the JavaScript Geolocation API</b> </h5><br>  Rather useful and effective method, but only for mobile devices.  In the case of a stationary computer, no more than GeoIP is useful.  The fact is that in the case of a mobile device (modern smartphone, tablet, etc.), all the available location tools and devices allowed by the user, including GPS, Wi-Fi and data from cell towers, will be used.  But in the case of a home PC, which, in most cases, does not have a mobile network (in the case of a GSM / 3G modem, data from it is not used), or GPS, we can only find out the GeoIP data, which we will happily report to JS .  And about their accuracy, I already wrote above.  Although, I would not neglect this method - after all, an increasing number of people use tablets and phones to access the Internet. <br><br>  As a result, this method has a fairly narrow range of applications - mobile devices.  Or if enough approximate data on GeoIP. <br><br>  <b><i>Pros:</i></b> <br><ul><li>  Easy to implement, lots of documentation and examples on the Internet. </li><li>  Exact, because  can be used as positioning on cell towers, Wi-Fi, GPS </li><li>  Fast, because  <acronym>software is</acronym> used to determine the position of the client </li></ul><br>  <b><i>Minuses:</i></b> <br><ul><li>  Not supported on home PCs in all browsers. </li><li>  Requires user permissions </li><li>  In fact, only applicable to mobile devices. </li><li>  Relatively easy to fake data </li></ul><br><br>  Examples of implementation can be found <a href="http://www.beloll.ru/example/example10.html">here</a> or <a href="http://y3x.ru/sandbox/js/geolocation/">here</a> . <br><br><h5>  4. <b>Definition through the services of the ‚Äúlocator‚Äù type from mobile operators</b> </h5><br>  I think some of the readers have heard about these services, some even use them, and some have to use them in a corporate environment.  I‚Äôm talking about services similar to Locator‚Äôs from the egg company and Yellow-striped Coordinates.  Yes, these services were originally intended for end users, but ... What prevents them from using us?  There are few positive moments when using this method, but what is the high accuracy and almost 100% accuracy of the data.  But there are unpleasant moments.  First, these services are paid.  Secondly, the need to use a mobile phone number during registration and the requirement to send a free SMS to a short number ... This behavior can scare many people away.  Yes, and time to receive information on SMS is considerable (within the framework of a web application).  But, in some cases, information of this kind, and yes even reliable, is simply necessary.  Moreover, this method can be used as a substitute for confirmation by a code from an SMS of any action.  Yes, and fake information obtained in this way is almost impossible. <br><br>  I will not give an example of a working implementation for the same reasons as in the first case, but I will briefly describe how this is done <a href="https://habr.com/ru/post/193372/">just below</a> . <br><br>  <b><i>Pros:</i></b> <br><ul><li>  <b>Highly reliable data, almost 100%</b> </li><li>  High accuracy, regardless of the device used and the method of Internet access </li><li>  Automatically confirms mobile number </li></ul><br>  <b><i>Minuses:</i></b> <br><ul><li>  Difficulty in implementation and support </li><li>  Low speed  it takes time to send / receive SMS and reply from the user </li><li>  Not free (operators' tariffs for this service are very ‚Äúvoracious‚Äù) </li><li>  User consent is required </li></ul><br><br><a name="HowTo_SMS"></a><br><h5>  <b>How to make</b> </h5><br>  We will need: <br><ol><li>  Old mob  telephone with cable or 3G / GSM modem, one for each operator </li><li>  Sim cards of these operators </li><li>  Some PC, preferably with * nix on board (Windows with cygwin is also possible), which will function as a ‚Äúgeo-gateway‚Äù </li><li>  A little patience and time </li><li>  smstools3 </li></ol><br><br><h6>  1) <b>Depending on the <acronym>OS</acronym> , the instructions may differ, but the general meaning is unchanged - you need to download and install the SMSTools package from the <acronym>software</acronym> repository</b> </h6><br><br>  <b>On Gentoo, it looks like this:</b> <br><hr><br>  If you need statistics of sent / received SMS, then: <br><pre><code class="bash hljs">nogood-work ~ <span class="hljs-comment"><span class="hljs-comment"># echo "app-mobilephone/smstools stats" &gt; /etc/portage/package.use/smstools.use</span></span></code> </pre> <br>  or (if you have all USE flags in one file): <br><pre> <code class="bash hljs">nogood-work ~ <span class="hljs-comment"><span class="hljs-comment"># echo "app-mobilephone/smstools stats" &gt;&gt; /etc/portage/package.use</span></span></code> </pre><br><br>  Then we install smstools from the port itself: <br><pre> <code class="bash hljs">nogood-work ~ <span class="hljs-comment"><span class="hljs-comment"># emerge -v smstools These are the packages that would be merged, in order: Calculating dependencies... done! [ebuild N ~] app-mobilephone/smstools-3.1.15 USE="-stats" 0 kB ... nogood-work ~ #</span></span></code> </pre><br><hr><br><br>  <b>On FreeBSD:</b> <br><hr><br><pre> <code class="bash hljs">root@kenny:/usr/ports <span class="hljs-comment"><span class="hljs-comment"># cd /usr/ports/comms/smstools3 root@kenny:/usr/ports/comms/smstools3 # make install clean</span></span></code> </pre><br><br>  For statistics in the options just select "STATS" <br><hr><br><br>  <b>You can build from source if there is no ready-made package for your system:</b> <br><hr><br><pre> <code class="bash hljs">nogood-work ~ <span class="hljs-comment"><span class="hljs-comment"># wget http://smstools3.kekekasvi.com/packages/smstools3-3.1.15.tar.gz nogood-work ~ # tar -zxvf smstools3-3.1.15.tar.gz -C /usr/local/src nogood-work ~ # cd /usr/local/src/smstools3 nogood-work ~ # make nogood-work ~ # make install</span></span></code> </pre><br><hr><br><br><h6>  2) We <b>connect the modem (s) and check whether the devices of the serial port appeared in / dev</b> </h6><br><br>  <b>For Gentoo:</b> <br><hr><br><pre> <code class="bash hljs">nogood-work ~ <span class="hljs-comment"><span class="hljs-comment"># ls /dev |grep ttyUSB ttyUSB0 ttyUSB1 ttyUSB2 nogood-work ~ #</span></span></code> </pre><br><br>  Multiple ports may appear.  Usually we are interested in ttyUSB0, if modem 1. If more - then connect in turn.  And here is the first of our ports that have appeared. <br><hr><br><br>  For FreeBSD: <br><hr><br><pre> <code class="bash hljs">root@kenny:~ <span class="hljs-comment"><span class="hljs-comment"># ls /dev |grep cuau cuau0 cuau0.init cuau0.lock cuau1 cuau1.init cuau1.lock root@kenny:~ #</span></span></code> </pre><br><br>  The meaning is the same - the first of several appearing is ours. <br><hr><br><br><h6>  3) <b>Customize SMSTools</b> </h6><br>  smsd.conf may be located in / etc / or in / usr / local / etc / depending on your distribution.  We bring it to a similar look: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  "".     # , , ,   #   ,      devices = GSM1 #  .    - #  syslog.        #  ,  smart_logging. logfile = /var/log/smsd/smsd.log # . loglevel = notice #   UTF-8.     ,    incoming_utf8 = yes #    .    . log_charconv = yes #    .    , #         date_filename = 1 #     receive_before_send = yes # ,   , .   ,    #-    ,  . #          # logfile  &lt;name&gt;_trouble.log       debug smart_logging = yes #     failed = /var/spool/sms/failed sent = /var/spool/sms/sent phonecalls = /var/spool/sms/calls stats = /var/spool/sms/stats #    .     . [GSM1] # COM- device = /dev/ttyUSB0 #     incoming = yes #   .     . . check_memory_method = 2 # , ..       #decode_unicode_text = yes #    .    . #init = AT+CSCS="UCS2" #init2 = AT+CSCS="UCS2" #     .  . internal_combine = yes #  .    ? hangup_incoming_call = yes #   .   . eventhandler = /etc/smsd/trsms.sh #   USSD .   ,   #     . #eventhandler_ussd = #.       . #       . number = 79185568942 #     -  . . phonecalls = clip #  .   . #report = yes #     ,     . signal_quality_ber_ignore = yes</span></span></code> </pre><br><br><h6>  4) <b>Create a trsms.sh file (event handler)</b> </h6><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash status="$1" file="$2" case "$1" in RECEIVED) header=`head -12 $file | grep -e "^From: " -e "^Sent: " -e "^Received: "` from=`head -12 $file | grep -e "^From: " | awk '{print $2}'` if grep "Alphabet: UCS2" $file &gt; /dev/null &gt; /dev/null; then message=`tail -n +14 $file | iconv -f UCS-2BE -t UTF-8` else message=`tail -n +14 $file` fi #echo -e "$message" | mail -s "Incoming SMS from +$from" admin@yourhost.ru echo -e "$header\n$message\n" &gt;&gt; /var/log/smsd/sms.log if echo $message | grep "    " &gt; /dev/null &gt; /dev/null; then abon=`echo $message | awk 'BEGIN{ FS = " " } $2 { print substr($2, 2, 11) }'` echo -e "\n&gt; \t$abon" &gt;&gt; /var/log/smsd/location.log fi if echo $message | grep "    " &gt; /dev/null &gt; /dev/null; then abon=`echo $message | awk 'BEGIN{ FS = " " } $2 { print substr($2, 2, 11) }'` adres=`echo $message | awk 'BEGIN{ FS = " " } $2 { print substr($2,0,index($2, "  ")) }'` region=`echo $adres | awk 'BEGIN{ FS = ", " } $1 {print $1}'` echo -e "\n&gt; \t$abon\t$adres\t: $region" &gt;&gt; /var/log/smsd/location.log fi ;; esac</span></span></code> </pre><br><br>  This is an example with minimal functionality.  Writes to the log requests and responses received for the "egg" operator.  In a good way, you also need to add a condition to the number from which the message came, based on the from variable.  It will also be possible to determine the operator.  The numbers of different operators, as a rule, are different. <br>  We do not forget to give launch rights to the user, from under which smsd will work. <br><br><h6>  5) <b>Start the smsd daemon and add it to autoload</b> </h6><br><br>  For Gentoo: <br><hr><br><pre> <code class="bash hljs">nogood-work ~ <span class="hljs-comment"><span class="hljs-comment"># /etc/init.d/smsd start nogood-work ~ # rc-update add smsd default</span></span></code> </pre><br><hr><br><br>  For FreeBSD: <br><hr><br><pre> <code class="bash hljs">root@kenny:~ <span class="hljs-comment"><span class="hljs-comment"># echo "smsd_enable=\"YES\"" &gt;&gt; rc.conf root@kenny:~ # service smsd start</span></span></code> </pre><br><hr><br><br>  Look logs.  If everything is good and there are no error messages, then go to the next step. <br><br><h6>  6) <b>Try to send SMS to your phone</b> </h6><br><br><pre> <code class="bash hljs">nogood-work ~ <span class="hljs-comment"><span class="hljs-comment"># sendsms 79xxxxxxxxx ''</span></span></code> </pre><br><br>  If the SMS was successful - you can try to send an SMS to the coveted service number with the appropriate text, and then check the logs. <br>  Then you can simply call the command <code>sendsms &lt;&gt; "&lt;&gt;"</code> from your script <code>sendsms &lt;&gt; "&lt;&gt;"</code> and check, for example, on cron the presence of a response to the desired number in the sms log file. <br><br><h4>  <b>Conclusion</b> </h4><br>  Each of these methods is suitable for some specific purposes and conditions, and you decide what to use.  Of course, not all location methods are considered here.  I described only those that I tried myself and I consider as the most effective.  Also, to achieve greater efficiency, I would recommend combining them.  So this is done in our project.  That's all.  I hope someone this information will be useful. </div><p>Source: <a href="https://habr.com/ru/post/193372/">https://habr.com/ru/post/193372/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../193360/index.html">How will the ‚ÄúNoSQL‚Äù architect help and ... will it help?</a></li>
<li><a href="../193364/index.html">Our bicycle startup</a></li>
<li><a href="../193366/index.html">Build a career in a large organization. Tips & tricks</a></li>
<li><a href="../193368/index.html">7 ways to improve the design process of responsive design</a></li>
<li><a href="../193370/index.html">Run LendWings. Part 1. Belarusian swamp</a></li>
<li><a href="../193374/index.html">Detailed anatomy of a simple XBMC plugin</a></li>
<li><a href="../193376/index.html">Google Apps script: getting data from Flurry</a></li>
<li><a href="../193378/index.html">Installing and configuring TeamSpeak 3 servers on VDS</a></li>
<li><a href="../193380/index.html">Guide to designing relational databases (7-9 part of 15) [translation]</a></li>
<li><a href="../193382/index.html">Intel announced Quark, the processor for the "Internet of things"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>