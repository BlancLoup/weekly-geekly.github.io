<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a blog engine with Phoenix and Elixir / Part 8. Finish with comments</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator: ‚Äú Elixir and Phoenix are a great example of where modern web development is heading. Already, these tools provide high-quality ac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a blog engine with Phoenix and Elixir / Part 8. Finish with comments</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/19c/859/5e6/19c8595e62e14d4c82cff672cd250bcc.png"><br><br><p>  From the translator: ‚Äú <i>Elixir and Phoenix are a great example of where modern web development is heading.</i>  <i>Already, these tools provide high-quality access to real-time technologies for web applications.</i>  <i>Sites with increased interactivity, multiplayer browser games, microservices - those areas in which these technologies will serve a good service.</i>  <i>The following is a translation of a series of 11 articles that describe in detail the aspects of development on the Phoenix framework that would seem such a trivial thing as a blog engine.</i>  <i>But do not hurry to sulk, it will be really interesting, especially if the articles encourage you to pay attention to the Elixir or become its followers.</i> <br><br></p><p>  In this part we will finish the routine work on the comments, then to move on to more interesting things. </p><a name="habracut"></a><br><p>  At the moment, our application is based on: </p><br><ul><li>  <b>Elixir</b> : v1.3.1 </li><li>  <b>Phoenix</b> : v1.2.0 </li><li>  <b>Ecto</b> : v2.0.2 </li></ul><br><h2>  Where did we leave off </h2><br><p>  The previous part ended with the creation of a small nice comments interface.  With it, you can view a list of comments to posts and add new ones.  But he still lacks some possibilities. </p><br><ol><li>  First, you should hide the ‚ÄúApprove / Delete‚Äù buttons for guests, and also not show them in comments from the author of the post or administrator. <br></li><li>  Secondly, it is necessary in principle to make the ‚ÄúApprove / Delete‚Äù buttons perform their functions. <br></li><li>  And, thirdly, you need to stop showing unapproved comments to guests. <br></li></ol><br><p>  We start by setting up the authorization model, as prescribed by paragraphs 1 and 3. </p><br><h2>  Show comments with the authorization flag </h2><br><p>  Open the file <strong>web / controllers / post_controller.ex</strong> .  Going down, you will see a bunch of authorization logic that we already have.  Instead of adding a new one, let's fix this code a little, thus preparing it for reuse. </p><br><p>  First, we transfer the authorization check to a private function: </p><br><pre><code class="hljs pgsql">defp is_authorized_user?(conn) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = get_session(conn, :<span class="hljs-built_in"><span class="hljs-built_in">current_user</span></span>) (<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> &amp;&amp; (<span class="hljs-type"><span class="hljs-type">Integer</span></span>.to_string(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.id) == conn.params["user_id"] || Pxblog.RoleChecker.is_admin?(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  And then we turn to it from the <strong>authorize_user</strong> function: </p><br><pre> <code class="hljs sql">defp authorize_user(conn, _opts) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> is_authorized_user?(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_flash(:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>, <span class="hljs-string"><span class="hljs-string">"You are not authorized to modify that post!"</span></span>) |&gt; redirect(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: page_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>)) |&gt; halt <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  Run the tests and make sure that nothing is broken. </p><br><pre> <code class="hljs sql">$ mix test Compiled web/controllers/post_controller.ex ....................................................................... Finished in 1.3 seconds (0.5s on <span class="hljs-keyword"><span class="hljs-keyword">load</span></span>, <span class="hljs-number"><span class="hljs-number">0.7</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> tests) <span class="hljs-number"><span class="hljs-number">71</span></span> tests, <span class="hljs-number"><span class="hljs-number">0</span></span> failures Randomized <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> <span class="hljs-number"><span class="hljs-number">501973</span></span></code> </pre> <br><p>  Wonderful!  Then you need to add a new plug-in to set the authorization flag, which we will use in the template.  To do this, take the function we just wrote: </p><br><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">Add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the top <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the controller <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the other plug declarations plug :set_authorization_flag # <span class="hljs-keyword"><span class="hljs-keyword">Add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the bottom <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the other plug definitions defp set_authorization_flag(conn, _opts) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assign(conn, :author_or_admin, is_authorized_user?(conn)) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  We can test the performance in two ways: </p><br><ol><li>  Throw all the code into the templates and see what happens. <br></li><li>  Start writing tests. <br></li></ol><br><p>  Instead of checking everything manually, let's write tests all the same (hey, you need to write tests anyway)! </p><br><h2>  Writing tests to verify authorization </h2><br><p>  Let's get rid of the initial test ‚ÄúShows chosen resource‚Äù, in return for which we will add four new ones: when is the <strong>is_authorized_user</strong> function <strong>?</strong>  returns true for the author or administrator, and false for the guest or user who entered in error.  We need to change the <b>setup</b> block, add an exit function and write some new tests.  To do this, in the file <strong>test / controllers / post_controller_test.exs,</strong> we write: </p><br><pre> <code class="hljs sql">setup <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">role</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(:<span class="hljs-keyword"><span class="hljs-keyword">role</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(:<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>) other_user = <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(:<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>) post = <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(:post, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) admin_role = <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(:<span class="hljs-keyword"><span class="hljs-keyword">role</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(:<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>: admin_role) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = build_conn() |&gt; login_user(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) {:ok, <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, other_user: other_user, <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">role</span></span>, post: post, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, session_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: %{username: user.username, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: user.password} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp logout_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, session_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  And then add a few tests to the new logic: </p><br><pre> <code class="hljs pgsql">test "when logged in as the author, shows chosen resource with author flag set to true", %{conn: conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post: post} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = login_user(conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) |&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(user_post_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post)) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ "Show post" <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> conn.assigns[:author_or_admin] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test "when logged in as an admin, shows chosen resource with author flag set to true", %{conn: conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>, post: post} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = login_user(conn, <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>) |&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(user_post_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post)) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ "Show post" <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> conn.assigns[:author_or_admin] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test "when not logged in, shows chosen resource with author flag set to false", %{conn: conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post: post} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = logout_user(conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) |&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(user_post_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post)) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ "Show post" refute conn.assigns[:author_or_admin] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test "when logged in as a different user, shows chosen resource with author flag set to false", %{conn: conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, other_user: other_user, post: post} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = login_user(conn, other_user) |&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(user_post_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post)) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ "Show post" refute conn.assigns[:author_or_admin] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  Now run the tests again to make sure everything is still good: </p><br><pre> <code class="hljs sql">$ mix test .......................................................................... Finished in 1.2 seconds (0.5s on <span class="hljs-keyword"><span class="hljs-keyword">load</span></span>, <span class="hljs-number"><span class="hljs-number">0.7</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> tests) <span class="hljs-number"><span class="hljs-number">74</span></span> tests, <span class="hljs-number"><span class="hljs-number">0</span></span> failures Randomized <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> <span class="hljs-number"><span class="hljs-number">206903</span></span></code> </pre> <br><p>  Wonderful!  Now, when we are confident in the work of the flag, let's take the UI. </p><br><h2>  Connect the Delete Button </h2><br><p>  Let's start by changing the output of comments in the Post Show template ( <strong>web / templates / post / show.html.eex</strong> file): </p><br><pre> <code class="hljs javascript">&lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"comments"</span></span>&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Comments</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;%= <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> comment &lt;- @post.comments <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> %&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">render</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Pxblog.CommentView</span></span></span></span><span class="xml"><span class="hljs-tag">, "</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">comment.html</span></span></span></span><span class="xml"><span class="hljs-tag">", </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">comment:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">comment</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">author_or_admin:</span></span></span></span><span class="xml"><span class="hljs-tag"> @</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">conn.assigns</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:author_or_admin</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">conn:</span></span></span></span><span class="xml"><span class="hljs-tag"> @</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">conn</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">post:</span></span></span></span><span class="xml"><span class="hljs-tag"> @</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">post</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><p>  Notice how much we did in the render function.  Initially, it was decided not to use <strong>@author_or_admin</strong> , since we cannot be sure that the parameter will be set.  Instead, we used the more secure <strong>@ conn.assigns</strong> function.  Then we need to pass the <strong>@conn</strong> and <strong><a href="https://habrahabr.ru/users/post/" class="user_link">post</a></strong> paths to the helper. </p><br><p>  Now the comment template will be able to read the flag created by us, so let's move on to editing it ( <strong>web / templates / comment / comment.html.eex file</strong> ).  Here you need to do two things: </p><br><ol><li>  If the user is an author or administrator, display a comment.  If not, do not show anything.  To achieve this, we wrap the output of the comment under some condition. <br></li><li>  If the user is an author or administrator, display the ‚ÄúApprove / Delete‚Äù buttons. <br></li></ol><br><p>  Let's start with the first step.  At the top of the template, add the line: </p><br><pre> <code class="hljs mel">&lt;%= <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> @conn.assigns[:author_or_admin] || @comment.approved <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> %&gt;</code> </pre> <br><p>  (Again, note the use of <code>conn.assigns</code> instead of a simple <code>@value</code> ).  At the bottom of the template, add: </p><br><pre> <code class="hljs pgsql">&lt;% <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> %&gt;</code> </pre> <br><p>  Then find the Approve / Delete buttons and change the div containing them: </p><br><pre> <code class="hljs javascript">&lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"col-xs-4 text-right"</span></span>&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> @</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">conn.assigns</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">:author_or_admin</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">do</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unless</span></span></span></span><span class="xml"><span class="hljs-tag"> @</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">comment.approved</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">do</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"btn btn-xs btn-primary approve"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Approve</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"btn btn-xs btn-danger delete"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Delete</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">%</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span></span><span class="xml"><span class="hljs-tag"> %&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><p>  The final version of the template should look like this: </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">conn.assigns</span></span></span><span class="hljs-tag">[</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:author_or_admin</span></span></span><span class="hljs-tag">] || @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">comment.approved</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">do</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"comment"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"row"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"col-xs-4"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">comment.author</span></span></span><span class="hljs-tag"> %&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"col-xs-4"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">em</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">comment.inserted_at</span></span></span><span class="hljs-tag"> %&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">em</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"col-xs-4 text-right"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">conn.assigns</span></span></span><span class="hljs-tag">[</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:author_or_admin</span></span></span><span class="hljs-tag">] </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">do</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unless</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">comment.approved</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">do</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-xs btn-primary approve"</span></span></span><span class="hljs-tag">&gt;</span></span>Approve<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-xs btn-danger delete"</span></span></span><span class="hljs-tag">&gt;</span></span>Delete<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"row"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"col-xs-12"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">comment.body</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span></code> </pre> <br><p>  Now try to open the post in two different browser windows: in one - by an authorized user, and in the other - by a guest.  For the first, comments on the check and buttons will be shown, for the second - only approved comments. </p><br><p>  We are very close to finalizing the comments, so let's document the last piece: we‚Äôll configure the approve and delete buttons. </p><br><h2>  Configure the Delete Button </h2><br><p>  To make the delete button work, you need to make sure that the controller supports the delete action.  Open the file <strong>web / controllers / comment_controller.ex</strong> and scroll down to the <strong>delete</strong> function.  Right now, it returns only <code>conn</code> , so you need to change it to something like this: </p><br><pre> <code class="hljs sql">def <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-string"><span class="hljs-string">"post_id"</span></span> =&gt; post_id}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = Repo.get!(Post, post_id) |&gt; Repo.preload(:<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) Repo.get!(<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) |&gt; Repo.delete! <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_flash(:info, <span class="hljs-string"><span class="hljs-string">"Deleted comment!"</span></span>) |&gt; redirect(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: user_post_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, post.user, post)) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  And now you can write a test to delete comments.  To do this, open the file <strong>test / controllers / comment_controller_test.exs</strong> .  First of all, add the line <strong>alias Pxblog.Comment</strong> , if it was not there before.  Then add a comment insert in the setup block: </p><br><pre> <code class="hljs sql">setup <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(:<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) post = <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(:post, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(:<span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>) {:ok, <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: build_conn(), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post: post, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  Finally, we write the test itself: </p><br><pre> <code class="hljs pgsql">test "deletes the comment", %{conn: conn, post: post, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(conn, post_comment_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>, post, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> redirected_to(conn) == user_post_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, post.<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post) refute Repo.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>.id) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  Now let's run the tests, everything should be green.  It remains to do only the Delete button itself. Return to the file <strong>web / templates / comment / comment.html.eex</strong> and replace the Delete button code with the following one. </p><br><pre> <code class="hljs mel">&lt;%= link <span class="hljs-string"><span class="hljs-string">"Delete"</span></span>, method: :<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>, to: post_comment_path(@conn, :<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>, @post, @comment), class: <span class="hljs-string"><span class="hljs-string">"btn btn-xs btn-danger delete"</span></span>, data: [confirm: <span class="hljs-string"><span class="hljs-string">"Are you sure you want to delete this comment?"</span></span>] %&gt;</code> </pre> <br><p>  There are so many things to stay in more detail.  First we set the text for the button.  Then we tell her to use the DELETE method instead of GET.  And then - where to send the command for deletion (you can use <strong>mix phoenix.routes</strong> to get a list of available routes).  Next we define CSS classes and set a pop-up window with confirmation of the action. </p><br><p>  That's all!  Check out the functionality yourself.  If the tests are green, then we are done with the work on the Delete button! </p><br><h2>  Customize the Approve button </h2><br><p>  The implementation of the confirmation button will be a bit more complicated.  We need to try to understand what the essence of the ‚Äúapproved‚Äù flag update is all about.  Let's start by writing the code for the update function in the comment controller ( <strong>web / controllers / comment_controller.ex</strong> file): </p><br><pre> <code class="hljs sql">def <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-string"><span class="hljs-string">"post_id"</span></span> =&gt; post_id, <span class="hljs-string"><span class="hljs-string">"comment"</span></span> =&gt; comment_params}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = Repo.get!(Post, post_id) |&gt; Repo.preload(:<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> = Repo.get!(<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) changeset = Comment.changeset(<span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>, comment_params) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Repo.update(changeset) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, _} -&gt; <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_flash(:info, <span class="hljs-string"><span class="hljs-string">"Comment updated successfully."</span></span>) |&gt; redirect(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: user_post_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, post.user, post)) {:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>, _} -&gt; <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_flash(:info, <span class="hljs-string"><span class="hljs-string">"Failed to update comment!"</span></span>) |&gt; redirect(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: user_post_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, post.user, post)) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  And we‚Äôll write a check for changing the ‚Äúapproved‚Äù status in the file <strong>test / controllers / comment_controller_test.exs</strong> : </p><br><pre> <code class="hljs sql">defp login_user(conn, user) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, session_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: %{username: user.username, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: user.password} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"updates chosen resource and redirects when data is valid and logged in as the author"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post: post, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = login_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) |&gt; put(post_comment_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>, post, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>: %{<span class="hljs-string"><span class="hljs-string">"approved"</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) assert redirected_to(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) == user_post_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post) assert Repo.get_by(<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: comment.id, approved: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  Restart the tests.  Everything should be green!  Now we need <br>  change the ‚ÄúApprove‚Äù button so that clicking on it sends a request to the update function with the approve parameter set to true.  Replace it in the <strong>web / templates / comment / comment.html.eex file with the</strong> following code: </p><br><pre> <code class="hljs mel">&lt;%= form_for @conn, post_comment_path(@conn, :update, @post, @comment), [method: :put, as: :comment, style: <span class="hljs-string"><span class="hljs-string">"display: inline;"</span></span>], fn f -&gt; %&gt; &lt;%= hidden_input f, :approved, value: <span class="hljs-string"><span class="hljs-string">"true"</span></span> %&gt; &lt;%= submit <span class="hljs-string"><span class="hljs-string">"Approve"</span></span>, class: <span class="hljs-string"><span class="hljs-string">"btn btn-xs btn-primary approve"</span></span> %&gt; &lt;% end %&gt;</code> </pre><br><p>  This will create a small form for the sole purpose of making the update button work.  It is sent via PUT, displays the inline form, and sets the ‚Äúapproved‚Äù value to true through a hidden field.  We are close to perfection, except that technically ANY can change / delete / confirm comments!  We need to add authorization to the comment controller to keep the application safe! </p><br><h2>  Add authorization to the comment controller </h2><br><p>  Copy the <strong>authorize_user</strong> and <strong>is_authorized_user functions?</strong>  from <strong>PostController</strong> to <strong>CommentController</strong> (in <strong>web / controllers / comment_controller.ex</strong> ), but with some changes.  First we need to make sure that we are actually working with the expected post, so we will change <strong>authorize_user</strong> to <strong>set_post_and_authorize_user</strong> : </p><br><pre> <code class="hljs sql">defp set_post(conn) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = Repo.get!(Post, conn.params[<span class="hljs-string"><span class="hljs-string">"post_id"</span></span>]) |&gt; Repo.preload(:<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) assign(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :post, post) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp set_post_and_authorize_user(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, _opts) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = set_post(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> is_authorized_user?(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_flash(:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>, <span class="hljs-string"><span class="hljs-string">"You are not authorized to modify that comment!"</span></span>) |&gt; redirect(<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: page_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>)) |&gt; halt <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp is_authorized_user?(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = get_session(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">current_user</span></span>) post = conn.assigns[:post] <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> &amp;&amp; (user.id == post.user_id) || Pxblog.RoleChecker.is_admin?(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  And we will need to add a plug to the top of the controller: </p><br><pre> <code class="hljs ruby">plug <span class="hljs-symbol"><span class="hljs-symbol">:set_post_and_authorize_user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> action <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:update</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:delete</span></span>]</code> </pre> <br><p>  Run the tests.  We will get several errors depending on whether we are logged in before updating / deleting or not, so let's change our tests (in the file <strong>test / controllers / comment_controller_test.exs</strong> ): </p><br><pre> <code class="hljs pgsql">test "deletes the comment when logged in as an authorized user", %{conn: conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post: post, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = login_user(conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) |&gt; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(post_comment_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>, post, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> redirected_to(conn) == user_post_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, post.<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post) refute Repo.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>.id) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test "does not delete the comment when not logged in as an authorized user", %{conn: conn, post: post, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(conn, post_comment_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>, post, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> redirected_to(conn) == page_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> Repo.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>.id) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test "updates chosen resource and redirects when data is valid and logged in as the author", %{conn: conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post: post, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = login_user(conn, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) |&gt; put(post_comment_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>, post, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>: %{"approved" =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> redirected_to(conn) == user_post_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, post) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> Repo.get_by(<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>, %{id: <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>.id, approved: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test "does not update the comment when not logged in as an authorized user", %{conn: conn, post: post, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = put(conn, post_comment_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>, post, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>: %{"approved" =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> redirected_to(conn) == page_path(conn, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) refute Repo.get_by(<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>, %{id: <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>.id, approved: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  And now let's run our tests: </p><br><pre> <code class="hljs mel">$ mix test Compiling <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> (.ex) ........................................................................... Finished <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1.1</span></span> seconds <span class="hljs-number"><span class="hljs-number">75</span></span> tests, <span class="hljs-number"><span class="hljs-number">0</span></span> failures Randomized with <span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> <span class="hljs-number"><span class="hljs-number">721237</span></span></code> </pre> <br><p>  That's all!  All our buttons are configured and work, and we properly show / hide unconfirmed posts and actions, depending on whether the user is authorized or not! </p><br><h2>  Conclusion </h2><br><p>  Now we have a fully working part of the comments with a small admin panel.  There are many other features that we can start adding here.  For example, the system of live comments (for which we will take in the next part), the updated design of our blogging system (for which we will get into Brunch), and generally we will go over the code and clean / fix it a bit (for example, we now have a ton of duplicate code with user authentication)!  I would also like to give users the opportunity to log in through third-party systems and add support for RSS feeds, import from other platforms, etc. </p><br><h2>  Other series articles </h2><br><ol><li>  <a href="https://habrahabr.ru/post/311088/">Introduction</a> </li><li>  <a href="https://habrahabr.ru/post/313482/">Authorization</a> </li><li>  <a href="https://habrahabr.ru/post/315252/">Adding Roles</a> </li><li>  <a href="https://habrahabr.ru/post/316368/">Process roles in controllers</a> </li><li>  <a href="https://habrahabr.ru/post/316996/">We connect ExMachina</a> </li><li>  <a href="https://habrahabr.ru/post/317550/">Markdown support</a> </li><li>  <a href="https://habrahabr.ru/post/318790/">Add comments</a> </li><li>  We finish with comments </li><li>  <a href="https://habrahabr.ru/post/332094/">Channels</a> </li><li>  <a href="https://habrahabr.ru/post/333020/">Channel testing</a> </li><li>  <a href="https://habrahabr.ru/post/335048/">Conclusion</a> </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/323462/">https://habr.com/ru/post/323462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323450/index.html">Localization of indie games at Unity: hidden costs</a></li>
<li><a href="../323452/index.html">Visual Studio 2017 and new features of Microsoft tools</a></li>
<li><a href="../323456/index.html">Women who have changed business</a></li>
<li><a href="../323458/index.html">What to base React applications</a></li>
<li><a href="../323460/index.html">How to return to coders when over forty</a></li>
<li><a href="../323466/index.html">Protocol features in IO games</a></li>
<li><a href="../323468/index.html">How we ranked nine million developers on Github</a></li>
<li><a href="../323470/index.html">Why are all virtual assistants women?</a></li>
<li><a href="../323472/index.html">Why are we sure we deployed</a></li>
<li><a href="../323474/index.html">How IT professionals work. Daria Kulaga, Lead Developer, AT Consulting Regional Business Unit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>