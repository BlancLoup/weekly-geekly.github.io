<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Postgres 9.3 highlights of material features: materialized views</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PostgreSQL 9.3 will come with a pretty cool feature called materialized views . The feature was developed by Kevin Grittner and recently committed to:...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Postgres 9.3 highlights of material features: materialized views</h1><div class="post__text post__text-html js-mediator-article">  PostgreSQL 9.3 will come with a pretty cool feature called <a href="http://www.postgresql.org/docs/devel/static/rules-materializedviews.html">materialized views</a> .  The feature was developed by Kevin Grittner and recently committed to: <br><br><blockquote>  commit 3bf3ab8c563699138be02f9dc305b7b77a724307 <br>  Date: Sunday, March 4, 18:23:31 2013 -0600 <br>  Posted by: Kevin Grittner <br><br>  Added materialized views 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A materialized view has a rule, just like a regular view, and a heap, as well as other physical properties, like a table.  The rule is used only for filling the table, the links in the queries indicate the materialized data. <br><br>  Implemented minimal functionality, but it can be useful in many cases.  Currently, data is loaded only ‚Äúon demand‚Äù with the CREATE MATERIALIZED VIEW and REFRESH MATERIALIZED VIEW instructions.  It is expected that in future releases incremental data updates with different update time settings will be added, and the notion of ‚Äúfresh‚Äù data will be given a clearer definition.  At some point, even queries will be able to use the materialized data instead of the data of the tables themselves, but this requires the implementation of the above described functionality in the first place. <br><br>  Most of the documentation work was done by Robert Haas.  Review: Noah Misch, Thom Brown, Robert Haas, Marko Tiikkaja.  A security review, including a decision on how to implement sepgsql, is expected from KaiGai Kohei. </blockquote><a name="habracut"></a>  What is a materialized view?  In short, this is a mutant of the table and the usual presentation.  A view is a projection of data using a given relationship that does not have a repository.  The table is ... table! <br><br>  The materialized view is somewhere in the middle - it is a projection of tabular data that has its own repository.  It uses the query to get its data as a view, but the data is stored as in a regular table.  The materialized view can be updated with fresh data by re-executing the query used during the creation phase.  In addition, it can be <i>truncated</i> .  In the latter case, it remains in a non-scanning state.  Also, since the materialized view has its own rich storage, it can use table spaces ( <i>tablespace</i> ) and its own indexes.  Pay attention to the fact that it may be <i>unlogged</i> ( <b>approx. Transl</b> .: That is, the data is not written to <i>write-ahead log</i> ). <br><br>  Together with this feature, 4 new SQL commands are introduced: <br><br>  ‚Ä¢ <a href="http://www.postgresql.org/docs/devel/static/sql-creatematerializedview.html">CREATE MATERIALIZED VIEW</a> <br>  ‚Ä¢ <a href="http://www.postgresql.org/docs/devel/static/sql-altermaterializedview.html">ALTER MATERIALIZED VIEW</a> <br>  ‚Ä¢ <a href="http://www.postgresql.org/docs/devel/static/sql-dropmaterializedview.html">DROP MATERIALIZED VIEW</a> <br>  ‚Ä¢ <a href="http://www.postgresql.org/docs/devel/static/sql-refreshmaterializedview.html">REFRESH MATERIALIZED VIEW</a> <br><br>  CREATE, ALTER and DROP ‚Äî in this case, these are the usual <a href="http://ru.wikipedia.org/wiki/Data_Definition_Language">DDL</a> commands for manipulating the definition of a view.  The most interesting team is the REFRESH (there were long disputes within the community about its name).  This command can be used to update the materialized view with fresh data by restarting the scanning query.  Note that REFRESH can also be used to clear data ( <i>truncate</i> ), although not real, by running with the WITH NO DATA option. <br><br>  Materialized views have many advantages in various situations: quick access to data that must be obtained from a remote server (reading a file on a <i>postgres</i> server via <i>file_fdw</i> , etc.), using periodically updated data (a caching system), projection of data from ORDER BY from large tables, periodic execution of expensive ‚ÄúJOIN‚Äù -s in the background, etc. <br><br>  I can already imagine some wonderful combinations of data updating procedures and background workers.  Who ever said that automatically updating data in materialized views is impossible? <br><br>  And now, let's see how it works: <br><br><blockquote>  <font color="#007800">postgres</font> = <font color="#666666"># CREATE TABLE aa AS SELECT generate_series (1,1000000) AS a;</font> <br>  SELECT <font color="#000000">1,000,000</font> <br>  <font color="#007800">postgres</font> = <font color="#666666"># CREATE VIEW aav AS SELECT * FROM aa WHERE a &lt;= 500000;</font> <br>  CREATE VIEW <br>  <font color="#007800">postgres</font> = <font color="#666666"># CREATE MATERIALIZED VIEW aam AS SELECT * FROM aa WHERE a &lt;= 500000;</font> <br>  SELECT <font color="#000000">500000</font> </blockquote><br>  Dimensions for each relationship: <br><br><blockquote>  <font color="#007800">postgres</font> = <font color="#666666"># SELECT pg_relation_size ('aa') AS tab_size, pg_relation_size ('aav') AS view_size, pg_relation_size ('aam') AS matview_size;</font> <br>  tab_size <font color="#000000">|</font>  view_size <font color="#000000">|</font>  matview_size <br>  ---------- + ----------- + -------------- <br>  <font color="#000000">36249600</font> <font color="#000000">|</font>  <font color="#000000">0</font> <font color="#000000">|</font>  <font color="#000000">18137088</font> <br>  <font color="#7a0874">(</font> <font color="#000000">1</font> row <font color="#7a0874">)</font> </blockquote><br>  The materialized view uses the storage (in this case, 18 MB) to the extent necessary to store the data selected from the parent table (36 MB in size) during the execution of the request to create the view. <br>  Updating a received view is very easy. <br><br><blockquote>  <font color="#007800">postgres</font> = <font color="#666666"># DELETE FROM aa WHERE a &lt;= 500000;</font> <br>  DELETE <font color="#000000">500,000</font> <br>  <font color="#007800">postgres</font> = <font color="#666666"># SELECT count (*) FROM aam;</font> <br>  count <br>  - <font color="#000000">500,000</font> <br>  <font color="#7a0874">(</font> <font color="#000000">1</font> row <font color="#7a0874">)</font> <br>  <font color="#007800">postgres</font> = <font color="#666666"># REFRESH MATERIALIZED VIEW aam;</font> <br>  REFRESH MATERIALIZED VIEW <br>  <font color="#007800">postgres</font> = <font color="#666666"># SELECT count (*) FROM aam;</font> <br>  count <br>  - <font color="#000000">0</font> <br>  <font color="#7a0874">(</font> <font color="#000000">1</font> row <font color="#7a0874">)</font> </blockquote><br>  Changes in the parent table were reflected in the materialized view only after the execution of the REFRESH command.  Please note that at the time of this writing, REFRESH used an exclusive lock (eh ...). <br>  The materialized view can be transferred to the unscannable state using the REFRESH option WITH the NO NO DATA option. <br><br><blockquote>  <font color="#007800">postgres</font> = <font color="#666666"># REFRESH MATERIALIZED VIEW aam WITH NO DATA;</font> <br>  REFRESH MATERIALIZED VIEW <br>  <font color="#007800">postgres</font> = <font color="#666666"># SELECT count (*) FROM aam;</font> <br>  ERROR: materialized view <font color="#ff0000">"aam"</font> has not been populated <br>  HINT: Use the REFRESH MATERIALIZED VIEW command. </blockquote><br>  There was a new system table matviews, which contain information about the current state of the materialized views. <br><br><blockquote>  <font color="#007800">postgres</font> = <font color="#666666"># SELECT matviewname, isscannable FROM pg_matviews;</font> <br>  matviewname <font color="#000000">|</font>  isscannable <br>  ------------- + ------------- <br>  aam <font color="#000000">|</font>  f <br>  <font color="#7a0874">(</font> <font color="#000000">1</font> row <font color="#7a0874">)</font> </blockquote><br>  <a href="http://ru.wikipedia.org/wiki/Data_Manipulation_Language">DML</a> queries cannot be performed on the materialized view, since these views may not correspond to the current value of the parent table.  Regular views, on the other hand, perform the corresponding query every time it is needed, so it is possible to modify parent tables ( <a href="http://michael.otacoo.com/postgresql-2/postgres-9-3-feature-highlight-auto-updatable-views/">updatable views</a> ) through them. <br><br><blockquote>  <font color="#007800">postgres</font> = <font color="#666666"># INSERT INTO aam VALUES (1);</font> <br>  ERROR: cannot change materialized view <font color="#ff0000">"aam"</font> <br>  <font color="#007800">postgres</font> = <font color="#666666"># UPDATE aam SET a = 5;</font> <br>  ERROR: cannot change materialized view <font color="#ff0000">"aam"</font> <br>  <font color="#007800">postgres</font> = <font color="#666666"># DELETE FROM aam;</font> <br>  ERROR: cannot change materialized view <font color="#ff0000">"aam"</font> <br></blockquote><br>  Now a few words about the improvement and degradation of performance that you can get using materialized views (given the fact that you can manipulate their indexes).  For example, you can very easily improve the performance of sampling queries in materialized views without worrying about the data schema in the parent table at all: <br><br><blockquote>  <font color="#007800">postgres</font> = <font color="#666666"># EXPLAIN ANALYZE SELECT * FROM aam WHERE a = 1;</font> <br>  QUERY PLAN <br>  <font color="#660033">-------------------------------------------------- ------------------------------------------------</font> <br>  Seq Scan on aam <font color="#7a0874">(</font> <font color="#007800">cost</font> = 0.00..8464.00 <font color="#007800">rows</font> = <font color="#000000">1</font> <font color="#007800">width</font> = <font color="#000000">4</font> <font color="#7a0874">)</font> <font color="#7a0874">(</font> actual <font color="#007800"><font color="#000000">time</font></font> = 0.060..155.934 <font color="#007800">rows</font> = <font color="#000000">1</font> <font color="#007800">loops</font> = <font color="#000000">1</font> <font color="#7a0874">)</font> <br>  Filter: <font color="#7a0874">(</font> a = <font color="#000000">1</font> <font color="#7a0874">)</font> <br>  Rows Removed by Filter: <font color="#000000">499999</font> <br>  Total runtime: <font color="#000000">156.047</font> ms <br>  <font color="#7a0874">(</font> <font color="#000000">4</font> rows <font color="#7a0874">)</font> <br>  <font color="#007800">postgres</font> = <font color="#666666"># CREATE INDEX aam_ind ON aam (a);</font> <br>  CREATE INDEX <br>  <font color="#007800">postgres</font> = <font color="#666666"># EXPLAIN ANALYZE SELECT * FROM aam WHERE a = 1;</font> <br>  QUERY PLAN <br>  <font color="#660033">-------------------------------------------------- -------------------------------------------------- --------------</font> <br>  Index Only Scan using aam_ind on aam <font color="#7a0874">(</font> <font color="#007800">cost</font> = 0.42..8.44 <font color="#007800">rows</font> = <font color="#000000">1</font> <font color="#007800">width</font> = <font color="#000000">4</font> <font color="#7a0874">)</font> <font color="#7a0874">(</font> actual <font color="#007800"><font color="#000000">time</font></font> = 2.096..2.101 <font color="#007800">rows</font> = <font color="#000000">1</font> <font color="#007800">loops</font> = <font color="#000000">1</font> <font color="#7a0874">)</font> <br>  Index Cond: <font color="#7a0874">(</font> a = <font color="#000000">1</font> <font color="#7a0874">)</font> <br>  Heap Fetches: <font color="#000000">1</font> <br>  Total runtime: <font color="#000000">2.196</font> ms <br>  <font color="#7a0874">(</font> <font color="#000000">4</font> rows <font color="#7a0874">)</font> </blockquote><br>  Note that indexes and constraints (materialized views can have <i>constraints</i> !) On the parent table are not copied to materialized views.  For example, a quick query that scans the primary key of a table can result in a deadly long sequential brute force, running on a materialized view. <br><br><blockquote>  <font color="#007800">postgres</font> = <font color="#666666"># INSERT INTO bb VALUES (generate_series (1,100000));</font> <br>  INSERT <font color="#000000">0</font> <font color="#000000">100000</font> <br>  <font color="#007800">postgres</font> = <font color="#666666"># EXPLAIN ANALYZE SELECT * FROM bb WHERE a = 1;</font> <br>  QUERY PLAN <br>  <font color="#660033">-------------------------------------------------- -------------------------------------------------- -------------</font> <br>  Index Only Scan using bb_pkey on bb <font color="#7a0874">(</font> <font color="#007800">cost</font> = 0.29..8.31 <font color="#007800">rows</font> = <font color="#000000">1</font> <font color="#007800">width</font> = <font color="#000000">4</font> <font color="#7a0874">)</font> <font color="#7a0874">(</font> actual <font color="#007800"><font color="#000000">time</font></font> = 0.078..0.080 <font color="#007800">rows</font> = <font color="#000000">1</font> <font color="#007800">loops</font> = <font color="#000000">1</font> <font color="#7a0874">)</font> <br>  Index Cond: <font color="#7a0874">(</font> a = <font color="#000000">1</font> <font color="#7a0874">)</font> <br>  Heap Fetches: <font color="#000000">1</font> <br>  Total runtime: <font color="#000000">0.159</font> ms <br>  <font color="#7a0874">(</font> <font color="#000000">4</font> rows <font color="#7a0874">)</font> <br>  <font color="#007800">postgres</font> = <font color="#666666"># CREATE MATERIALIZED VIEW bbm AS SELECT * FROM bb;</font> <br>  SELECT <font color="#000000">100000</font> <br>  <font color="#007800">postgres</font> = <font color="#666666"># EXPLAIN ANALYZE SELECT * FROM bbm WHERE a = 1;</font> <br>  QUERY PLAN <br>  <font color="#660033">-------------------------------------------------- -------------------------------------------------</font> <br>  Seq Scan on bbm <font color="#7a0874">(</font> <font color="#007800">cost</font> = 0.00..1776.00 <font color="#007800">rows</font> = <font color="#000000">533</font> <font color="#007800">width</font> = <font color="#000000">4</font> <font color="#7a0874">)</font> <font color="#7a0874">(</font> actual <font color="#007800"><font color="#000000">time</font></font> = 0.144..41.873 <font color="#007800">rows</font> = <font color="#000000">1</font> <font color="#007800">loops</font> = <font color="#000000">1</font> <font color="#7a0874">)</font> <br>  Filter: <font color="#7a0874">(</font> a = <font color="#000000">1</font> <font color="#7a0874">)</font> <br>  Rows Removed by Filter: <font color="#000000">99999</font> <br>  Total runtime: <font color="#000000">41.935</font> ms <br>  <font color="#7a0874">(</font> <font color="#000000">4</font> rows <font color="#7a0874">)</font> </blockquote><br>  Such anti-patterns are definitely not recommended for use on industrial systems! <br>  In general, materialized views are a great feature, especially for use in applications that require caching.  Enjoy! </div><p>Source: <a href="https://habr.com/ru/post/188802/">https://habr.com/ru/post/188802/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../188790/index.html">Monitoring Hen's Production</a></li>
<li><a href="../188792/index.html">Gigabyte U2442 - a good laptop with a difficult future</a></li>
<li><a href="../188794/index.html">Rostelecom began to provide mobile services in St. Petersburg</a></li>
<li><a href="../188798/index.html">Startup Happy Farm - Advice Wallet attracted an investment of $ 300 thousand</a></li>
<li><a href="../188800/index.html">Mobile application developers - the key to success for Russian business</a></li>
<li><a href="../188804/index.html">Creating an IT business from scratch</a></li>
<li><a href="../188808/index.html">MEGA released its own SDK</a></li>
<li><a href="../188812/index.html">Probabilistic models: struggle with cycles and variational approximations</a></li>
<li><a href="../188814/index.html">ThL W100 - a small but powerful smartphone</a></li>
<li><a href="../188816/index.html">Qt 5.1 and correct deployment on Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>