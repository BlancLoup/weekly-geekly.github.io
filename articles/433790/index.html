<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Advanced multi-stage build templates</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The multistage assembly function in Dockerfile files allows you to create small images of containers with a higher level of caching and a smaller amou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Advanced multi-stage build templates</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/getpro/habr/post_images/ae4/9db/b18/ae49dbb18f8454823b9e133b737cacf0.png" alt="image"></p><br><p>  The multistage assembly function in Dockerfile files allows you to create small images of containers with a higher level of caching and a smaller amount of protection.  In this article, I‚Äôll show several advanced templates ‚Äî something more than copying files between build and execute steps.  They allow you to maximize the effectiveness of the function.  However, if you are a beginner in the field of multi-stage assembly, then first, probably, it would not be superfluous to read <a href="https://docs.docker.com/develop/develop-images/multistage-build/">the usage guide</a> . </p><a name="habracut"></a><br><h3 id="sovmestimost-versiy">  Version Compatibility </h3><br><p>  Support for multi-stage build was added to Docker in version v17.05.  All templates work with any subsequent version, but some are much more efficient, thanks to the <a href="https://github.com/moby/buildkit">build</a> using server-side <a href="https://github.com/moby/buildkit">BuildKit</a> .  For example, BuildKit effectively skips unused stages and, if possible, creates stages at the same time (I singled out these examples separately).  Currently, BuildKit <a href="https://github.com/moby/moby/pull/37151">is</a> being <a href="https://github.com/moby/moby/pull/37151">added to Moby</a> as an experimental server part of the build and should be available in Docker CE v18.06.  It can also be used <a href="https://github.com/moby/buildkit">offline</a> or as part of the <a href="https://github.com/genuinetools/img">img</a> project. </p><br><hr><br><h4 id="nasledovanie-ot-etapa">  Inheritance from the stage </h4><br><p> Multi-stage build adds several new syntax concepts.  First of all, you can assign the stage beginning with the <code>FROM</code> command the name <code>AS stagename</code> and use the option <code>--from=stagename</code> in the <code>COPY</code> to copy the files from this stage.  In fact, the <code>FROM</code> command and the <code>--from</code> label have much more in common, it‚Äôs not for nothing that they have the same name.  Both take the same argument, recognize it and either start a new phase from this point, or use it as a source to copy the file.  That is, to use the previous stage in the original image quality for the current stage, you can take not only <code>--from=stagename</code> , but also the name of the stage <code>FROM stagename</code> .  It is useful if you use the same common parts in several commands in the Dockerfile: reduces the common code and simplifies its maintenance, keeping the child stages separate.  Thus, rebuilding one stage does not affect the build cache for others.  Accordingly, each stage can be assembled individually using the <code>--target</code> label when calling <code>docker build</code> . </p><br><pre> <code class="plaintext hljs">FROM ubuntu AS base RUN apt-get update &amp;&amp; apt-get install git FROM base AS src1 RUN git clone ‚Ä¶ FROM base as src2 RUN git clone ‚Ä¶</code> </pre> <br><p>  In this example, the second and third stages in BuildKit are built simultaneously. </p><br><h3 id="neposredstvennoe-ispolzovanie-obrazov">  Direct use of images </h3><br><p>  Instead of using assembly step names in <code>FROM</code> commands that previously only supported image references, you can directly use images with the <code>--from</code> label.  It turns out to copy files directly from these images.  For example, <code>linuxkit/ca-certificatesimage</code> in the following code directly copies the TLS CA roots to the current stage. </p><br><pre> <code class="plaintext hljs">FROM alpine COPY --from=linuxkit/ca-certificates / /</code> </pre> <br><h3 id="psevdonim-obschego-obraza">  Common nickname </h3><br><p>  The build step does not necessarily include any commands;  it may consist of a single <code>FROM</code> string.  If an image is used in several places, it will make reading easier and make it so that if you need to update a shared image, you only need to change one line. </p><br><pre> <code class="plaintext hljs">FROM alpine:3.6 AS alpine FROM alpine RUN ‚Ä¶ FROM alpine RUN ‚Ä¶</code> </pre> <br><p>  In this example, every place that uses the alpine image is actually fixed to <code>alpine:3.6</code> , and not <code>alpine:latest</code> .  When it comes time to upgrade to <code>alpine:3.7</code> , you will need to change a single line, and you can be sure: now the updated version is used in all elements of the assembly. </p><br><p>  This is all the more important when the assembly argument is used in the alias.  The following example is similar to the previous one, but allows the user to redefine all instances of the assembly in which the alpine image is involved, by setting the option <code>--build-arg ALPINE_VERSION=value</code> .  Remember: any arguments used in the <code>FROM</code> commands must be defined <a href="https://docs.docker.com/engine/reference/builder/">before the first stage of the assembly</a> . </p><br><pre> <code class="plaintext hljs">ARG ALPINE_VERSION=3.6 FROM alpine:${ALPINE_VERSION} AS alpine FROM alpine RUN ‚Ä¶</code> </pre> <br><h3 id="ispolzovanie-argumentov-sborki-v-from">  Using assembly arguments in "- from" </h3><br><p>  The value specified in the <code>--from</code> label of the <code>COPY</code> must not contain assembly arguments.  For example, the following example is invalid. </p><br><pre> <code class="plaintext hljs">// THIS EXAMPLE IS INTENTIONALLY INVALID FROM alpine AS build-stage0 RUN ‚Ä¶ FROM alpine ARG src=stage0 COPY --from=build-${src} . .</code> </pre> <br><p>  This is due to the fact that the dependencies between the stages need to be determined even before the assembly begins.  Then the constant evaluation of all teams is not required.  For example, the environment variable defined in the <code>alpine</code> image may affect the estimated value from <code>--from</code> .  The reason we can evaluate the arguments of the <code>FROM</code> command is because these arguments are defined globally before the start of any stage.  Fortunately, as we found out earlier, it is enough to define the stage of the alias using one <code>FROM</code> command and refer to it. </p><br><pre> <code class="plaintext hljs">ARG src=stage0 FROM alpine AS build-stage0 RUN ‚Ä¶ FROM build-${src} AS copy-src FROM alpine COPY --from=copy-src . .</code> </pre> <br><p>  Now, if you override the <code>src</code> assembly argument, the initial stage for the final <code>COPY</code> element is switched.  Note: if some stages are no longer used, then only BuildKit-based linkers will be able to skip them. </p><br><h3 id="usloviya-ispolzuyuschie-argumenty-sborki">  Conditions using assembly arguments </h3><br><p>  We were asked to add support for <code>IF/ELSE</code> style conditions in Dockerfile.  We still do not know whether we will add something similar, but in the future we will try - using the support of the client part in BuildKit.  Meanwhile, to achieve a similar behavior, you can use the current multi-stage concept (with some planning). </p><br><pre> <code class="plaintext hljs">// THIS EXAMPLE IS INTENTIONALLY INVALID FROM alpine RUN ‚Ä¶ ARG BUILD_VERSION=1 IF $BUILD_VERSION==1 RUN touch version1 ELSE IF $BUILD_VERSION==2 RUN touch version2 DONE RUN ‚Ä¶</code> </pre> <br><p>  The previous example shows pseudo-code for recording conditions using <code>IF/ELSE</code> .  To achieve similar behavior with the current multi-stage builds, you may need to define different branch conditions as separate steps and use an argument to choose the right dependency path. </p><br><pre> <code class="plaintext hljs">ARG BUILD_VERSION=1 FROM alpine AS base RUN ‚Ä¶ FROM base AS branch-version-1 RUN touch version1 FROM base AS branch-version-2 RUN touch version2 FROM branch-version-${BUILD_VERSION} AS after-condition FROM after-condition RUN ‚Ä¶</code> </pre> <br><p>  The last stage in the Dockerfile is based on the <code>after-condition</code> stage, which is an image alias (recognized based on the <code>BUILD_VERSION</code> assembly <code>BUILD_VERSION</code> ).  Depending on the value of <code>BUILD_VERSION</code> , one or another stage of the middle section is selected. </p><br><p>  Please note: only BuildKit-based linkers can skip unused branches.  In previous versions of linkers, all stages would be built, but before creating the final image, their results would be discarded. </p><br><h3 id="pomoschnik-po-razrabotketestirovaniyu-dlya-minimalnogo-proizvodstvennogo-etapa">  Development / Testing Assistant for Minimum Production Stage </h3><br><p>  Finally, let's take a look at an example of combining previous templates to demonstrate how to create a Dockerfile that creates a minimal production image and can then use its contents to test and create a development image.  Let's start with the basic Dockerfile example: </p><br><pre> <code class="plaintext hljs">FROM golang:alpine AS stage0 ‚Ä¶ FROM golang:alpine AS stage1 ‚Ä¶ FROM scratch COPY --from=stage0 /binary0 /bin COPY --from=stage1 /binary1 /bin</code> </pre> <br><p>  When a minimal production image is created, this is a fairly common option.  But what if you also need to get an alternative developer image or run tests with these binaries at the final stage?  The first thing that comes to mind is simply to copy similar binaries during the testing and development phases.  The problem is this: there is no guarantee that you will test all production binaries in the same combination.  At the final stage, something may change, and you will forget to make similar changes at other stages or make an error in the path to copy binary files.  In the end, we are not testing a separate binary file, but a final image. </p><br><p>  An alternative is to define the development and testing phase after the production phase and copy the entire contents of the production phase.  Then use the <code>FROM</code> command for the production phase to again make the default production phase the last step. </p><br><pre> <code class="plaintext hljs">FROM golang:alpine AS stage0 ‚Ä¶ FROM scratch AS release COPY --from=stage0 /binary0 /bin COPY --from=stage1 /binary1 /bin FROM golang:alpine AS dev-env COPY --from=release / / ENTRYPOINT ["ash"] FROM golang:alpine AS test COPY --from=release / / RUN go test ‚Ä¶ FROM release</code> </pre> <br><p>  By default, this Dockerfile will continue to build the minimum default image, while, for example, an assembly with the option <code>--target=dev-env</code> will create an image with a shell containing all the binaries of the final version. </p><br><hr><br><p>  I hope this was useful and suggested how to create more efficient multistage Dockerfile files.  If you participate in <a href="https://2018.dockercon.com/">DockerCon2018</a> and want to learn more about multi-stage builds, Dockerfiles, BuildKit, or any related topics, subscribe to the <a href="https://hallwaytrack.dockercon.com/">Hallway track</a> linker or track Docker‚Äôs internal meetings on the <a href="">Contribute and Collaborate</a> tracks or <a href="">Black Belt</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/433790/">https://habr.com/ru/post/433790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../433722/index.html">HeisenBug through the eyes of SberTech employee</a></li>
<li><a href="../433724/index.html">Some uncomfortable truth about LDAC</a></li>
<li><a href="../433726/index.html">Getting Started with the Automation API: Part 1 - Overview</a></li>
<li><a href="../433728/index.html">Google closed the project of the Chinese search engine with censorship due to disagreements within the company</a></li>
<li><a href="../433730/index.html">Optimization of relational databases without downtime on the example of the most loaded database in Badoo</a></li>
<li><a href="../433792/index.html">Shell scripts in Ansible</a></li>
<li><a href="../433796/index.html">How Homo Sapiens conquered the world. Communication and Negotiation Skills</a></li>
<li><a href="../433798/index.html">HomeKit and ioBroker Let's be friends houses</a></li>
<li><a href="../433800/index.html">Using Cypress UDB PSoC Controllers to Reduce the Number of Interrupts in a 3D Printer</a></li>
<li><a href="../433802/index.html">How and why we won the Big Data track at the Urban Tech Challenge</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>