<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk Managment Interface (AMI), Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="AMI is Asterisk's powerful and convenient software interface (API) for managing the system from external programs. In addition to AMI, AGI is often us...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk Managment Interface (AMI), Part 1</h1><div class="post__text post__text-html js-mediator-article">  AMI is Asterisk's powerful and convenient software interface (API) for managing the system from external programs.  In addition to AMI, AGI is often used - it is an interface for launching external applications that control the Asterisk channel within a particular call.  Thanks to AMI, external programs can make connections with Asterisk via the TCP protocol, initiate command execution, read the result of their execution, as well as receive notifications about events in real time.  These mechanisms can be used, for example, in the following cases: <br><ul><li>  Need to know the state of the system </li><li>  Number of active subscribers </li><li>  Run CLI commands remotely </li><li>  Improve CDR storage </li><li>  ‚Ä¶ and much more </li></ul><br>  AMI is often used to integrate with business processes and systems, CRM software (Customer Relationship Management).  It can also be used for a variety of applications, such as automatic dialing programs and click-to-call systems (click-to-call). <br><br>  Asterisk is often managed from the CLI console, but when using AMI, you do not need direct access to the server on which Asterisk is running.  AMI is the simplest tool that, in the hands of a developer, can be a very powerful and flexible tool for integration with other software products.  It allows developers to use the information generated by Asterisk in real time. <br><br>  It is also worth noting that Asterisk since version 1.6 uses the interface manager version 1.1.  Basically, the changes concerned the unification of many teams of the same type and the standardization of answers issued by various modules.  You can find out the version of the interfaces using the CoreSettings command.  The version may change further if the AMI interface loses full compatibility with previous versions. <br><a name="habracut"></a><br><h1>  How does AMI work </h1>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Between the Asterisk server and the client program, a simple, per-line protocol is used to establish a connection; each line of the message consists of two lines: <br><ul><li>  key is a keyword describing the nature of the information contained in the current line.  The keyword is not unique and can occur several times in the same package. </li><li>  value - the value of the parameter </li><li>  The keyword is separated from the value by a colon. </li></ul><br>  In the following, we will use the term ‚Äúpackage‚Äù, which will describe a series of ‚Äúkey: value‚Äù constructions separated by CRLF and completed by the additional sequence CRLF. <br><br>  The protocol of interaction between Asterisk and the client can be described by the following characteristics: <br><ul><li>  Before sending commands to the Asterisk server, you must perform a session connecting the client to the Asterisk server; </li><li>  Packets can be transmitted in any order and at any time after passing the authentication procedure; </li><li>  The first line of the packet must contain one of the following keys: ‚ÄúAction‚Äù (the only option when sent by the client), and keys are ‚ÄúEvent‚Äù (Event) and ‚ÄúResponse‚Äù (must be sent from Asterisk to the client); </li><li>  The order of the lines in the package does not matter; you can use any programming language with which you can form packages on the client side; </li><li>  CRLF is used to separate each of the lines in the packet and the two CRLF sequences (also known as \ r \ n) in order to signify the completion of the transfer of the command to Asterisk </li></ul><br>  AMI accepts connections established on a network port (by default, TCP port 5038).  The client program connects to the AMI through this port and is authenticated, then the Asterisk will respond to requests and also send notifications about changes in the state of the specified subsystems <br>  Types of packages <br><br>  The packet transmitted from the client to the Asterisk server and back is determined by the following key characteristics: <br><ul><li>  Action, packets sent by the client connected to AMI.  After the server has processed this package, some action will be taken.  There are relatively flexible restrictions on the actions taken by the client.  One package - one action.  The Action package must contain the name of the operation to be performed, as well as all the necessary parameters; </li><li>  Response, determines the answer that Asterisk sends to the client upon the completion of the action; </li><li>  Event, data related to the event that is generated inside the Asterisk core or expansion module. </li></ul><br>  As a rule, the client sends Action packets to Asterisk (they are also called commands).  The asterisk, in turn, executes the request and returns the result (often the result is the success of the action with a brief description in case of failure) received in the Response package.  There is no guarantee regarding the order of arrival of results (response packages), therefore, in a client request, the ActionID parameter is usually included in each Action package, and the corresponding Response package will contain the same value in the ActionID field.  Thus, the client can very easily process Action and Response packets, in any desired order, without waiting for Response packets to take the next action. <br><br>  The following CLI command (Tab completion completes) helps to get a complete list of AMI commands available in your version of Asterisk: <br> <code>*CLI&gt; manager show commands</code> <br> <br>  Packets Response.  As written above, serve as responses to the transmitted commands.  One response is sent to a command and may carry several values: <br><ul><li>  "Success" - the action is successful and all information is contained in this package. </li><li>  ‚ÄúError‚Äù - an error occurred, a detailed description in the header of ‚ÄúMessage‚Äù </li><li>  ‚ÄúFollows‚Äù - the result of execution will be transmitted in subsequent Event packages. </li></ul><br>  Event packages (events) are applied in two contexts.  On the one hand, they inform the client about changes in the status of the Asterisk subsystems (eg. Channel status changes), on the other hand, they transfer the data set that Asterisk returns in response to Action. <br><ul><li>  When a client sends an Action packet, Asterisk may (in cases where it is necessary to return many homogeneous entries) send a Response packet containing the ‚ÄúResponse: Follows‚Äù record.  Next, the Asterisk sends a number of events containing a data set and, finally, an event that reports that all data has been sent.  All Event packets generated by this contain the ActionID of the original Action packet that initiated the request.  Thus, you can easily handle them, as well as Response packages.  An example of an event generated by an Action is the Action Status, which triggers a Status event for each of the active channels.  After all Status events have been transmitted, the StatusComplete event is sent. </li><li>  Events are created by various structural parts of Asterisk (SIP / IAX2 / ... channels, CDR, dialplan, different parts of the core).  The main task assigned to the events is to allow the external connected system to receive information from the Asterisk, collecting all these events, analyzing them and performing actions depending on the results obtained. </li></ul><br>  Events are not documented in the CLI, so detailed information can be found in the documentation (file manager_1_1.txt), on voip-info.org.  If you still have the impression that some event is not described, but it should be - you can find all sorts of events in the source code of the corresponding module by the function name - manager_event <br><br>  Before turning to practical examples, it is worth noting that since version 1.6 of Asterisk, the AMI interface has acquired the version number 1.1.  This is due to bringing the format of commands to a single format and partial loss of compatibility.  The article will cover the work of version 1.6, where differences exist explanations will be given in brackets. <br>  Security <br><br>  Since the possibilities for managing the operation of the system provided through the AMI interface are almost endless.  In addition to an unencrypted password and the ability to restrict access to AMI from certain ip-addresses, the Manager interface (as it is also called) does not have other security tools, so it is not recommended to use it on public IP addresses. <br><br>  If the use of the public network is necessary, then it is necessary to ensure that access is limited using iptables or made through VPN tunnels of any type.  Access to the AMI interface can also be obtained via the built-in HTTP (S) server, access is configured in the http.conf file.  It is worth noting that, by default, the AMI interface is prohibited, just like working with it through an HTTP server. <br><br>  Also on an unreliable network, if you want to provide end-user access to AMI (for example, click-2-call functionality via TAPI), AstManProxy is recommended to handle all connections to the Manager API.  About him another time. <br><br><h1>  AMI Configuration </h1><br><br>  In order to use the AMI interface, you must edit the /etc/asterisk/manager.conf file, which is responsible for the configuration. <br><br> <code>[general] <br> enabled=yes ;    AMI (- no) <br> port=5038 ;   TCP 5038 <br> bindaddr=192.168.0.1 ;      (0.0.0.0 -   ) <br> timestampevents = yes ;       <br> displayconnects = yes ;      AMI <br> allowmultiplelogin = yes ;        <br> <br> ;  ,   <br> [admin] ;  ,     <br> secret=passwd1234 ;   AMI <br> deny=0.0.0.0/0.0.0.0 ;   ip- <br> permit=192.168.0.2/255.255.255.0 ;      ip <br> read=system, call, log, verbose, command, agent, user ;      <br> write=system, call,log, verbose, command, agent, user ;     <br></code> <br>  The [general] section defines general connection settings.  Enables AMI enabled = yes.  Note: For the settings to take effect, you must do an AMI overload: <br><br> <code>*CLI&gt;module reload manager</code> <br> <br>  or <br> <code>*CLI&gt;manager reload</code> <br> <br>  Using the deny and permit options, you can specify ip-addresses from which it is possible to connect to Asterisk.  You can add more system users (by copying the section starting with square brackets) and assign access rights to them: <br><ul><li>  read - read permissions; </li><li>  write - write permission. </li></ul><br>  In the above example, the admin user was given extensive rights, right up to stopping the Asterisk service (the command option is responsible for this).  In subsequent versions (1.6.1 and later) it is forbidden to use commands in AMI, which can lead to the asterisk stopping. <br><br><h1>  Links </h1><br><ul><li>  <a href="http://svn.digium.com/svn/asterisk/trunk/doc/manager_1_1.txt">AMI 1.1 Change Documentation</a> </li><li>  <a href="http://svn.digium.com/svn/asterisk/trunk/configs/manager.conf.sample">Configuration file (trunk)</a> </li><li>  <a href="http://www.voip-info.org/wiki/view/Aynchronous%2BJavascript%2BAsterisk%2BManager%2B(AJAM)">AJAM Description</a> </li><li>  <a href="http://www.voip-info.org/tiki-index.php%3Fpage%3DAstManProxy">Astmanproxy</a> </li></ul><br><br></div><p>Source: <a href="https://habr.com/ru/post/64105/">https://habr.com/ru/post/64105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../64097/index.html">Problem2</a></li>
<li><a href="../64098/index.html">10 phrases, after which your resume will be put aside</a></li>
<li><a href="../64100/index.html">The creator of DRKB Vitaly Nevzorov died</a></li>
<li><a href="../64101/index.html">Small program on PHP-GTK</a></li>
<li><a href="../64103/index.html">Ext GWT 2.0 Released</a></li>
<li><a href="../64108/index.html">Followme - our answer to Chamberlain</a></li>
<li><a href="../64110/index.html">New version of symfony 1.3 on site</a></li>
<li><a href="../64111/index.html">ASN.1 and Erlang</a></li>
<li><a href="../64113/index.html">Links to repositories with fresh software post</a></li>
<li><a href="../64115/index.html">Let's talk about Zend_Navigation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>