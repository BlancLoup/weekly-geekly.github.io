<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>When a programmer has nothing to do, he writes a Gopher-server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I hope the author of the previous archaeological post did not release the Gin of the Week of Gopher to Habr. I also do not want to do this, but since ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>When a programmer has nothing to do, he writes a Gopher-server</h1><div class="post__text post__text-html js-mediator-article">  I hope the author of the <a href="http://habrahabr.ru/post/238547/">previous</a> archaeological post did not release the Gin of the Week of Gopher to Habr.  I also do not want to do this, but since the topic has been raised, I dare to take part of the sin for my soul. <br><br>  An example of the implementation of the Gopher server in 140 lines on JS. <br><br>  A little background.  Some time ago I really had absolutely nothing to do and as part of preparing the internal Node.js seminar I decided to slightly stretch the brain with the implementation of some ancient, forgotten by everyone in the name of good, protocol for such an ultramodern and trendy thing like Noda.  Initially, my choice was on IRC, but after reading all the RFCs and looking at a couple of implementations on this, something I curled up.  There was only a week left before the seminar, and writing a working IRC server during this time seemed to me not so unrealistic, but obviously problematic. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Perhaps the only advantage of Gopher in the current historical context is its amazing simplicity.  See, <a href="https://www.ietf.org/rfc/rfc1436.txt">RFC1436</a> is just a shorty by IETF standards.  <a href="http://en.wikipedia.org/wiki/Gopher_(protocol)">The Wikipedia article</a> is even shorter.  And this is quite enough. <br><a name="habracut"></a><br>  So, to make your own stupid Gopher server, we need the following ingredients. <br><br><ul><li>  The <a href="http://nodejs.org/api/net.html">net</a> module, because we need to listen to the socket.  The default port is 70th, but we will make it configurable via the environment variable. </li><li>  The <a href="http://nodejs.org/api/fs.html">fs</a> module, because we need to be able to read and list the contents of the folder.  Similarly, we will configure the root folder through the environment, or we will take the current one. </li><li>  Yes, to read the environment, the <a href="http://nodejs.org/api/os.html">os</a> module is indispensable. </li><li>  You will also need the <a href="https://github.com/broofa/node-mime">mime</a> module - Gopher‚Äôs extensions provide special answers for several predefined file types. </li><li>  Finally, Gopher theoretically supports full-text search, and we will also <a href="">emulate it</a> .  It was clumsy for me, but it seems to work. </li></ul><br><br>  First of all, we hang on the socket of the listener, which will wait until the client sends us a string ending in CRLF - then we must respond to the request, or NULL - then we must close the connection: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> server = net.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sock</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Client connected from '</span></span> + sock.remoteAddress + <span class="hljs-string"><span class="hljs-string">' port '</span></span> + sock.remotePort); sock.on(<span class="hljs-string"><span class="hljs-string">'end'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Client disconnected'</span></span>); }); sock.on(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">buf</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Received '</span></span> + buf.length + <span class="hljs-string"><span class="hljs-string">' byte(s) of data'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; buf.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b = buf.readUInt8(i); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (b) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x0</span></span>: r = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xD</span></span>: r = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xA</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r) { handleQuery(query, sock); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: r = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; query += <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(b); } } }); });</code> </pre> <br><br>  If we need to respond to a request, then we see if the string was empty.  If empty, we answer with a menu (and Gopher is a text-based menu-based protocol, the fields of which are separated by tabs) containing a listing of the current directory.  If not, depending on the type of resource requested, either we give its content or we do a full-text search.  In the full-text query, we must meet the tab character, its presence and check it first. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">query, sock</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> paramPos = query.indexOf(TAB); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (paramPos &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> search = query.substr(paramPos + <span class="hljs-number"><span class="hljs-number">1</span></span>); query = query.substr(<span class="hljs-number"><span class="hljs-number">0</span></span>, paramPos); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = fs.realpathSync(query == <span class="hljs-string"><span class="hljs-string">''</span></span> ? ROOT_DIR + <span class="hljs-string"><span class="hljs-string">'/'</span></span> : ROOT_DIR + query); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Handling search query '</span></span> + search + <span class="hljs-string"><span class="hljs-string">' in the path '</span></span> + query); answerInfo(sock, <span class="hljs-string"><span class="hljs-string">'Search results for query '</span></span> + search + <span class="hljs-string"><span class="hljs-string">' in current directory and all subdirectories:'</span></span>); printList(sock, path, query, indexer.searchFor(path, search)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = fs.realpathSync(query == <span class="hljs-string"><span class="hljs-string">''</span></span> ? ROOT_DIR + <span class="hljs-string"><span class="hljs-string">'/'</span></span> : ROOT_DIR + query); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Handling path query '</span></span> + path); fs.exists(path, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">exists</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!exists) { answerError(sock, <span class="hljs-string"><span class="hljs-string">'File '</span></span> + path + <span class="hljs-string"><span class="hljs-string">" doesn't exists"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } }); fs.stat(path, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, stats</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stats.isDirectory()) { answerDirList(sock, query, path); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { fs.readFile(path, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, data</span></span></span><span class="hljs-function">) </span></span>{ sock.end(data); }); } }); } }</code> </pre><br><br>  We generate the listing itself based on the mime type of the files, substituting the corresponding magic constants. <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printList</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sock, path, query, entries</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> answer = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entries.length == <span class="hljs-number"><span class="hljs-number">0</span></span>) { answerInfo(sock, <span class="hljs-string"><span class="hljs-string">'Nothing to display here'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; entries.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entry = entries[i]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stat = fs.statSync(path + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + entry); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stat.isDirectory()) { answer += <span class="hljs-string"><span class="hljs-string">"1"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mt = mime.lookup(entry); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((mt.indexOf(<span class="hljs-string"><span class="hljs-string">'text/html'</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) || (mt.indexOf(<span class="hljs-string"><span class="hljs-string">'application/xhtml+xml'</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>)) { answer += <span class="hljs-string"><span class="hljs-string">'h'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mt.indexOf(<span class="hljs-string"><span class="hljs-string">'uue'</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { answer += <span class="hljs-string"><span class="hljs-string">'6'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mt.indexOf(<span class="hljs-string"><span class="hljs-string">'text/'</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { answer += <span class="hljs-string"><span class="hljs-string">'0'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mt.indexOf(<span class="hljs-string"><span class="hljs-string">'image/gif'</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { answer += <span class="hljs-string"><span class="hljs-string">'g'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mt.indexOf(<span class="hljs-string"><span class="hljs-string">'image/'</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { answer += <span class="hljs-string"><span class="hljs-string">'I'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mt.indexOf(<span class="hljs-string"><span class="hljs-string">'audio/'</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { answer += <span class="hljs-string"><span class="hljs-string">'s'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mt.indexOf(<span class="hljs-string"><span class="hljs-string">'binhex'</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { answer += <span class="hljs-string"><span class="hljs-string">'4'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((mt.indexOf(<span class="hljs-string"><span class="hljs-string">'compressed'</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) || (mt.indexOf(<span class="hljs-string"><span class="hljs-string">'archive'</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>)) { answer += <span class="hljs-string"><span class="hljs-string">'5'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { answer += <span class="hljs-string"><span class="hljs-string">'9'</span></span>; } } answer += entry + TAB + query + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + entry + TAB + SERVER + TAB + PORT + <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>; } } answer += <span class="hljs-string"><span class="hljs-string">'7Search in this directory and all subdirectories...'</span></span> + TAB + query + TAB + SERVER + TAB + PORT + <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>; answer += EOF; sock.end(answer); }</code> </pre><br><br>  A little more binding code, and we are convinced that for such a high-level modern framework as Node.js, the implementation of some protocol that was outdated in the last century is indeed a child‚Äôs task for about two and a half hours.  We make all this ugliness in the form of slides (which took more time), go to the seminar, break the applause and loud applause. <br><br>  And in this profit. <br><br>  Yes, I almost forgot.  It's not enough to write a server, because you also need a client.  We are convinced that all modern browsers got rid of the support of Gopher about a <s>hundred and</s> ten years ago (in the name of good), but the enthusiasts who wrote a plugin for Firefox remained in the world.  On <a href="https://addons.mozilla.org/en-US/firefox/addon/overbiteff/">OverbiteFF</a> and debugging. <br><br>  Actually, all code is completely in the form of a <a href="">project on GitHub</a> .  If someone is able to write type 8 support, please send a request. </div><p>Source: <a href="https://habr.com/ru/post/238805/">https://habr.com/ru/post/238805/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../238793/index.html">Drupal 8 beta</a></li>
<li><a href="../238795/index.html">We read Habr by mail</a></li>
<li><a href="../238797/index.html">What can we expect from 14 nanometers?</a></li>
<li><a href="../238801/index.html">Media Center with IPTV from laptop and monitor</a></li>
<li><a href="../238803/index.html">The company is planned to introduce SED? 10 recommendations to an IT specialist</a></li>
<li><a href="../238807/index.html">What will happen to the law on the prohibition of the storage of personal data of Russians abroad</a></li>
<li><a href="../238809/index.html">20 ways to scam when buying an iPhone</a></li>
<li><a href="../238813/index.html">LOTSMAN: We write our WorkFlow configurator. Start</a></li>
<li><a href="../238815/index.html">Windows 10 from Microsoft, new Google requirements for device manufacturers, new mobile advertising opportunities - and other news of the week for mobile developers</a></li>
<li><a href="../238817/index.html">Lenovo Yoga 13 + Comodo Firewall ‚â† <3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>