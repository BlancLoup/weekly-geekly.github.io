<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Spirit: Node.js MVC Framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi guys! From this point on, I want to start a stateful cycle with details on creating my own MVC framework for node.js , the name of which will be Sp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Spirit: Node.js MVC Framework</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/58/05/580516ea7b4df58e811b24c0fde3441c.png"><br>  Hi guys!  From this point on, I want to start a stateful cycle with details on creating my own MVC framework for <code>node.js</code> , the name of which will be Spirit. <br><br>  The first article will consist of four parts: <br>  1. The idea and mission of the framework <br>  2. Setting up the server <br>  3. Creating framework framework <br>  4. Creating an advanced and convenient router <br><br>  I warn you right away that the article is huge, with a bunch of text and big blocks of code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h2>  The idea and mission of the framework </h2><br>  Spirit will evolve slowly, as inspiration, mood and time (which is now a little).  Although criticism and suggestions are welcome - I will develop it according to my own vision and, if the first article is warmly accepted by the community, putting the details of each logical section as an article. <br><br>  The main objectives are training and warming up interest in the platform.  I will be very happy if someone forks the project and makes a standing framework on its basis, you can even turn to me for moral support.  However, if you want to take part in the development of Spirit with a detailed description of your actions, than to earn yourself a positive (real) karma - write to shocksilien@gmail.com, we will discuss). <br><br>  All source code will be available on GitHub link <a href="http://github.com/theshock/spirit">github.com/theshock/spirit</a> <br><br>  Although I will try to describe the details, the style of presentation implies that the reader knows at least the basics of administration, programming in javascript and node.js in particular, and has an idea of ‚Äã‚ÄãCMF.  In some places, to unload the article, I cut out the pieces of code, leaving only comments, I hope you will think it out yourself.  In any case - a complete and working example is on the GitHub. <br><br>  In the examples, I assume that we use the Debian system, and the user's home directory is "/ home / spirit".  The site will be located on <a href="http://spirit.example.com/">spirit.example.com</a> , unless otherwise noted. <br><br><h2>  Server Tuning </h2><br>  Unlike nginx and apache, node.js out of the box is not auto-running on the server and some configuration needs to be done. <br><br>  First, with the help of <code>init</code> we create a daemon, and then with the help of <code>monit</code> check whether the server has crashed.  This topic has long been painted, information can be found <a href="http://www.google.com.ua/search%3Fq%3D%25D0%2598%25D1%2581%25D0%25BF%25D0%25BE%25D0%25BB%25D1%258C%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5%2BNode.js%2B%25D1%2581%2BInit%2B%25D0%25B8%2BMonit">in Google</a> , for example <a href="http://nodejs.ru/296">on the site nodejs.ru</a> .  This approach was tested and approved by me personally using the example of the <a href="http://habr.ru/p/105691/">abbreviation of references to node.js</a> , which in a few hours reduced more than 15,000 references and did not even flinch, it still stands (almost 20 days). <br><br>  The second step is the nginx as a frontend. <br><blockquote><pre> <code class="python hljs">server { listen <span class="hljs-number"><span class="hljs-number">80</span></span>; server_name spirit.example.com; access_log /home/spirit/example-app/logs/nginx.access.log; location / { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">8124</span></span>/; } location ~* \.(html|js|ico|gif|jpg|png|css|doc|xml|rar|zip|swf|avi|mpg|flv|mpeg|wmv|ogv|oga|ogg)$ { root /home/spirit/example-app/public; } }</code> </pre></blockquote><br>  We see a very simple code - nginx redirects everything except static to our node.js, which will be located on port 8124 (or any other one that you specify).  Statics will be given without any participation of node.js directly by nginks. <br><br><h2>  Create a skeleton framework </h2><br>  So, we will be committed to this directory structure: <br><blockquote> <code><font color="#999"><font color="#333">/home/spirit/</font> <br> ‚îú <font color="#00c">lib/</font> <br> ‚îÇ   ‚îú <font color="#00c">mysql-libmysqlclient/</font> <br> ‚îÇ   ‚îú <font color="#00c"><b>spirit/</b></font> <br> ‚îÇ   ‚îî <font color="#060">MooTools.js</font> <br> ‚îú <font color="#00c">example-app/</font> <br> ‚îÇ   ‚îú <font color="#00c">engine/</font> <br> ‚îÇ   ‚îÇ   ‚îú <font color="#00c">classes/</font> <br> ‚îÇ   ‚îÇ   ‚îî <font color="#060">init.js</font> <br> ‚îÇ   ‚îú <font color="#999">logs/</font> <br> ‚îÇ   ‚îî <font color="#999">public/</font> <br> ‚îî <font color="#00c">another-example-app/</font> <br> ‚îú <font color="#00c">engine/</font> <br> ‚îÇ   ‚îú <font color="#00c">classes/</font> <br> ‚îÇ   ‚îî <font color="#060">init.js</font> <br> ‚îú <font color="#999">logs/</font> <br> ‚îî <font color="#999">public/</font> <br></font></code> </blockquote><br>  There are two key ideas in this scheme: <br>  1. All libraries, incl.  and Spirit will be located in separate application directories from applications - this will allow keeping several applications on one server without duplicating the list of all libraries. <br>  2. Each application has two key directories - the engine, in which we will store the server logic and public, all the content of which we will give to the client.  This will protect the server code from any encroachments outside and delimit various logic. <br><br>  In the <code>lib</code> directory, we will drop all the libraries we need. <br><br>  Spirit is based on the modified MooTools, how to connect it, I told <a href="http://habr.ru/p/105691/">in the topic about the abbreviation of links</a> .  For ease of connection, I hooked <a href="http://mootools.net/docs/more/Class/Class.Binds">MooTools.More Class.Binds</a> into the <code>lib/MooTools.js</code> <a href="http://mootools.net/docs/more/Class/Class.Binds">file</a> , which will allow passing methods of objects as arguments <a href="http://habr.ru/p/103760/">without losing context</a> and slightly expanded the prototype string by adding the <code>htmlEscape</code> , <code>ucfirst</code> and <code>lcfirst</code> . <br><br><h3>  Application Initialization </h3><br>  The connection (require) of libraries in the code occurs by one of the following methods: <br>  1. By name.  For example, <code><font color="#00c">require( <font color="#f00">'fs'</font> )</font></code> .  Thus, we include one of the libraries wired into the kernel and <a href="http://nodejs.org/api.html">described in the documentation</a> . <br>  2. By relative to the current file path.  For example, <code><font color="#00c">require( <font color="#f00">'./classes/foo'</font> )</font></code> or <code><font color="#00c">require( <font color="#f00">'../lib/mootools.js'</font> )</font></code> <br>  3. On the absolute path.  For example, <code><font color="#00c">require( <font color="#f00">'/home/spirit/lib/mootools'</font> )</font></code> <br><br>  The second and third paths, in fact, are a link to the javascript file, but without the .js at the end (of course, otherwise there is a chance to catch the error).  I recommend that you protect yourself from using relative paths as much as possible, since they work inconsistently, depend on the environment, and they also have a different root in each file. <br><blockquote><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// __dirname -  ,   //  ,      var libPath = __dirname + '/../../lib'; //  : /home/spirit/lib //            // fs.realpathSync(libPath),     //    MooTools   , //      require(libPath + '/MooTools').apply(GLOBAL); //       var spirit = require(libPath + '/spirit/spirit') .createSpirit(__dirname, libPath); //     -   //    ,   require('http').listen spirit.listen("127.0.0.1:8124");</span></span></code> </pre></blockquote><br><br><h3>  We write the main class </h3><br>  Everything that we want to pass to make it possible to export - we have to add to the exports object.  That is, if we want to do <code><font color="#000000"><font color="#007700">var</font> <font color="#0000BB">foo</font> <font color="#007700">= new (require(</font> <font color="#DD0000">'./bar'</font> <font color="#007700">).</font> <font color="#0000BB">bar</font> <font color="#007700">);</font></font></code>  , in the <code>bar.js</code> file <code>bar.js</code> we have to do this: <code><font color="#000000"><font color="#0000BB">exports</font> <font color="#007700">.</font> <font color="#0000BB">bar</font> <font color="#007700">= new Class({</font> <font color="#FF8000">/* ... */</font> <font color="#007700">});</font></font></code>  .  First of all, I prefer to declare such variables not in a dot, but in square brackets, then in editors it is highlighted as a string (of which there is usually the least), which additionally highlights the name of the class with which we work.  Secondly, at first I didn‚Äôt like this approach and I even found it inconvenient (in the example above, there is a need to <code>require</code> repeat the <code>bar</code> twice), but in the end we will turn it so that it plays into our hands - it will be comfortable and beautiful.  So, the function to create the main framework class: <br><blockquote><pre> <code class="javascript hljs">exports[<span class="hljs-string"><span class="hljs-string">'createSpirit'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">projectPath, libPath</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Spirit(projectPath, libPath); };</code> </pre></blockquote><br><br>  In the class itself, we implement the following ideas: <br>  1. All classes are in <code>app/classes</code> and <code>lib/spirit/classes</code> <br>  2. When loading a class by name, we first check the application directory, then the framework (unless stated otherwise).  Thus, it will be possible to overload the framework classes if necessary (this detail will be described later) <br>  3. Loaded classes are cached, thus avoiding unnecessary access to the file system (or is it already cached in node.js?) <br>  4. The class will be the starting point for all other activities. <br><br>  I will post the class code on pastin, and here I will describe only the interface <br><br><blockquote>  <b><a href="http://pastebin.com/0b14MEbe">pastebin.com/0b14MEbe</a></b> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Spirit = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class({ <span class="hljs-attr"><span class="hljs-attr">Binds</span></span>: [<span class="hljs-string"><span class="hljs-string">'hit'</span></span>, <span class="hljs-string"><span class="hljs-string">'load'</span></span>], <span class="hljs-attr"><span class="hljs-attr">initialize</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String projectPath, String libPath</span></span></span><span class="hljs-function">) </span></span>{ }, <span class="hljs-attr"><span class="hljs-attr">load</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String className, Boolean fromSpirit</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   load    , : // spirit.load('Controllers.User'); //     ,  ,    -   //  fromSpirit    //  ,    }, loadLib : function (libName) { //     , : // spirit.loadLib('mysql-libmysqlclient') //     libPath //           }, //       hit : function (req, res) { }, listen : function (port, url) { //     //  .listen(8124, '127.0.0.1')  //  .listen('127.0.0.1:8124') } }); var load = function (path, className) { // some code is here //         //    Spirit.      ? //  ! return data[className](this); };</span></span></code> </pre></blockquote><br><br>  This approach leads to the following style for creating classes. <br><blockquote><pre> <code class="javascript hljs">exports[<span class="hljs-string"><span class="hljs-string">'Name.Space.ClassName'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">spirit</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class({ <span class="hljs-attr"><span class="hljs-attr">method</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response.writeHead(<span class="hljs-number"><span class="hljs-number">200</span></span>, {<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response.end(msg); } }); };</code> </pre></blockquote><br><br>  It is not yet clear why this is necessary? <br><blockquote><pre> <code class="javascript hljs">exports[<span class="hljs-string"><span class="hljs-string">'Helper.AnotherClass'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">spirit</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mysql = spirit.loadLib(<span class="hljs-string"><span class="hljs-string">'mysql-libmysqlclient'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class({ <span class="hljs-attr"><span class="hljs-attr">Extends</span></span> : spirit.load(<span class="hljs-string"><span class="hljs-string">'Name.Space.ClassName'</span></span>), <span class="hljs-attr"><span class="hljs-attr">start</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.method(<span class="hljs-string"><span class="hljs-string">'Started'</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">query</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// using mysql } }); };</span></span></code> </pre></blockquote><br><br>  How would you include <code>Name.Space.ClassName</code> ? <code><font color="#000000"><font color="#007700">require(</font> <font color="#DD0000">'../Name/Space/ClassName'</font> <font color="#007700">);</font></font></code>  ?  And if the class to move to another place - would rewrite all the way?  Would a library be loaded by writing the full path? <br>  Let's look at another example.  Suppose our framework has a Router class that handles every hit: <br><blockquote><pre> <code class="javascript hljs">exports[<span class="hljs-string"><span class="hljs-string">'Router'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">spirit</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class({ <span class="hljs-comment"><span class="hljs-comment">// .. hit : function (request, response) { // some code }, // .. }); };</span></span></code> </pre></blockquote><br><br>  We want to enter hit logging.  We declare the class Router in the directory of our application: <br><br><blockquote><pre> <code class="javascript hljs">exports[<span class="hljs-string"><span class="hljs-string">'Router'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">spirit</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Logger = spirit.load(<span class="hljs-string"><span class="hljs-string">'Logger'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> logger = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Logger; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class({ <span class="hljs-attr"><span class="hljs-attr">Extends</span></span> : spirit.load(<span class="hljs-string"><span class="hljs-string">'Router'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>), <span class="hljs-attr"><span class="hljs-attr">hit</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ logger.log(<span class="hljs-string"><span class="hljs-string">'hit!'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parent(request, response); }, <span class="hljs-comment"><span class="hljs-comment">// .. }); };</span></span></code> </pre></blockquote><br><br>  Thus, we can extend classes by changing the framework's behavior and not getting into the source code. <br><br><h2>  Create a router </h2><br>  The router will parse the requests to it and give it to the desired controller. <br>  Routing will be as follows: <br>  1. First, using regexps, a match is checked with one of the addresses of manually added routes.  This will allow you to enter special URLs that do not fall under the default principle of the router. <br>  2. If the route is not found in point 2, the address is broken down by slashes and the closest one is searched for among the controllers.  With the url / AA / BB / CC / DD / EE address, the AA.BB.CC.DD.EE controller is first searched, then AA.BB.CC.DD and so on until the desired one is found.  If there is no such controller, the Index controller is substituted.  If there is no AA.BB.CC.DD controller, but AA.BB.CC.DD.Index, then it will be selected.  Then the method is selected and everything else is passed as arguments. <br><br>  All classes of controllers will be loaded when the application is initialized, thus avoiding unnecessary miscalculations with each request. <br><br>  This is how the catalog of our application will look like: <br><blockquote> <code><font color="#999"><font color="#333">/home/spirit/example-app/</font> <br> ‚îú <font color="#00c">engine/</font> <br> ‚îÇ   ‚îú <font color="#00c">classes/</font> <br> ‚îÇ   ‚îÇ   ‚îú <font color="#00c">controllers/</font> <br> ‚îÇ   ‚îÇ   ‚îÇ   ‚îú <font color="#00c">Admin/</font> <br> ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú <font color="#060">Articles.js</font> <br> ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî <font color="#060">Index.js</font> <br> ‚îÇ   ‚îÇ   ‚îÇ   ‚îú <font color="#00c">Man/</font> <br> ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú <font color="#060">Index.js</font> <br> ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî <font color="#060"><b>Route.js</b></font> <br> ‚îÇ   ‚îÇ   ‚îÇ   ‚îú <font color="#060">Index.js</font> <br> ‚îÇ   ‚îÇ   ‚îÇ   ‚îî <font color="#060">Users.js</font> <br> ‚îÇ   ‚îÇ   ‚îî <font color="#060">Controller.js</font> <br> ‚îÇ   ‚îî <font color="#060">init.js</font> <br> ‚îú <font color="#999">logs/</font> <br> ‚îî <font color="#999">public/</font> <br></font></code> </blockquote><br><br>  Add the following code to our init-file of the application, which will demonstrate the approach to manual routes.  : A,: D,: H,: W correspond to the following patterns: [az], [0-9], [0-9a-f], [0-9a-z], respectively.  &lt;and&gt; are responsible for ensuring that this expression is at the beginning and at the end of the address, respectively.  Thus, an expression, for example, <code>&lt;/test-:A&gt;</code> does not match the URL " <code>/test-abc123</code> ", while the expression <code>/test-:A</code> matches this URL.  All templates are added to an array and passed as an argument when calling the controller method.  If there is an argsMap, then the Hash is passed.  For example, at the address " <code>/articles-15/page-3</code> " the first argument will be an array <code>[15, 3]</code> , but if you pass <code>argsMap : ['id', 'page']</code> , the hash will be passed to the method <code>{id:15, page:3}</code> . <br><blockquote><pre> <code class="javascript hljs">spirit.createRouter() .addRoutes( { <span class="hljs-attr"><span class="hljs-attr">route</span></span> : <span class="hljs-string"><span class="hljs-string">"&lt;/article-:D/page-:D"</span></span> , <span class="hljs-attr"><span class="hljs-attr">contr</span></span> : <span class="hljs-string"><span class="hljs-string">'Man.Route:articleWithPage'</span></span> , <span class="hljs-attr"><span class="hljs-attr">argsMap</span></span> : [<span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-string"><span class="hljs-string">'page'</span></span>] }, { <span class="hljs-attr"><span class="hljs-attr">route</span></span> : <span class="hljs-string"><span class="hljs-string">"&lt;/article-:D"</span></span> , <span class="hljs-attr"><span class="hljs-attr">contr</span></span> : <span class="hljs-string"><span class="hljs-string">'Man.Route:article'</span></span> , <span class="hljs-attr"><span class="hljs-attr">argsMap</span></span> : [<span class="hljs-string"><span class="hljs-string">'id'</span></span>] }, { <span class="hljs-attr"><span class="hljs-attr">route</span></span> : <span class="hljs-string"><span class="hljs-string">"&lt;/~:W&gt;"</span></span> , <span class="hljs-attr"><span class="hljs-attr">contr</span></span> : <span class="hljs-string"><span class="hljs-string">'Man.Route:user'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">route</span></span> : <span class="hljs-string"><span class="hljs-string">"&lt;/hash-:H&gt;"</span></span> , <span class="hljs-attr"><span class="hljs-attr">contr</span></span> : <span class="hljs-string"><span class="hljs-string">'Man.Route:hash'</span></span> } );</code> </pre></blockquote><br><br>  But the controller that works with this code (in the diagram above it is bold): <br><blockquote><pre> <code class="javascript hljs">exports[<span class="hljs-string"><span class="hljs-string">'Controllers.Man.Route'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">spirit</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class({ <span class="hljs-attr"><span class="hljs-attr">Extends</span></span> : spirit.load(<span class="hljs-string"><span class="hljs-string">'Controller'</span></span>), <span class="hljs-attr"><span class="hljs-attr">indexAction</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exit(<span class="hljs-string"><span class="hljs-string">'(Man.Route) index action'</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">testAction</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exit(<span class="hljs-string"><span class="hljs-string">'(Man.Route) test action'</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">articleWithPageAction</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exit(<span class="hljs-string"><span class="hljs-string">'(Man.Route) article #'</span></span> + args.id + <span class="hljs-string"><span class="hljs-string">', page #'</span></span> + args.page); }, <span class="hljs-attr"><span class="hljs-attr">articleAction</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exit(<span class="hljs-string"><span class="hljs-string">'(Man.Route) article #'</span></span> + args.id); }, <span class="hljs-attr"><span class="hljs-attr">hashAction</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exit(<span class="hljs-string"><span class="hljs-string">'(Man.Route) hash: '</span></span> + args[<span class="hljs-number"><span class="hljs-number">0</span></span>]); }, <span class="hljs-attr"><span class="hljs-attr">userAction</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exit(<span class="hljs-string"><span class="hljs-string">'(Man.Route) user: '</span></span> + args[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } }); };</code> </pre></blockquote><br>  And the parent controller, which we will use in order for all children to set the <code>exit</code> method: <br><blockquote><pre> <code class="javascript hljs">exports[<span class="hljs-string"><span class="hljs-string">'Controller'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">spirit</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class({ <span class="hljs-attr"><span class="hljs-attr">exit</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response.writeHead(<span class="hljs-number"><span class="hljs-number">200</span></span>, {<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response.end(msg); } }); };</code> </pre></blockquote><br><br>  First you need to expand the Spirit class, we will shift the analysis of requests completely onto Router‚Äôs shoulders: <br><blockquote><pre> <code class="javascript hljs"> createRouter : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Router = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.load(<span class="hljs-string"><span class="hljs-string">'Router'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> router = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Router(); router.spirit = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.router = router; router.init(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> router; }, <span class="hljs-attr"><span class="hljs-attr">hit</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.router.hit(req, res); },</code> </pre></blockquote><br><br>  The router itself will also not be particularly heaped up and will give the main work to its deputy: <br><blockquote><pre> <code class="javascript hljs">exports[<span class="hljs-string"><span class="hljs-string">'Router'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">spirit</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> RouterHelper = spirit.load(<span class="hljs-string"><span class="hljs-string">'Router.Helper'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class({ <span class="hljs-attr"><span class="hljs-attr">init</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.spirit.requirePath + <span class="hljs-string"><span class="hljs-string">'Controllers'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.routerHelper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouterHelper(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.routerHelper.requireAll(path); }, <span class="hljs-attr"><span class="hljs-attr">hit</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> contrData = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.routerHelper.route(request); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> contr = contrData.contr; contr.spirit = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.spirit; contr.request = request; contr.response = response; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> contr.before == <span class="hljs-string"><span class="hljs-string">'function'</span></span>) contr.before(); contr[contrData.method](contrData.args); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> contr.after == <span class="hljs-string"><span class="hljs-string">'function'</span></span>) contr.after(); }, <span class="hljs-attr"><span class="hljs-attr">addRoutes</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rh = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.routerHelper; rh.addRoutes.apply(rh, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); } }); };</code> </pre></blockquote><br><br>  The Deputy also has two subordinates - the one who is responsible for manually added routes (RouterRegexp) and who is the default way (RouterPlain).  Pay attention to the requireAll method - it synchronously recursively manages the controller directory and all classes are connected.  In this case, asynchronous is not necessary, since this method is called only when the project is initialized, but in real code it is advisable to write such things in an asynchronous style ‚Äî the time to access the file system will not slow down the code execution process.  I like Node.js because, unlike <a href="http://ua2.php.net/manual/en/ref.filesystem.php">some other languages</a> , all method names are clear, beautiful, short and follow the same style. <br><br><blockquote><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); exports[<span class="hljs-string"><span class="hljs-string">'Router.Helper'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">spirit</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> RouterPlain = spirit.load(<span class="hljs-string"><span class="hljs-string">'Router.Plain'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> RouterRegexp = spirit.load(<span class="hljs-string"><span class="hljs-string">'Router.Regexp'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class({ <span class="hljs-attr"><span class="hljs-attr">initialize</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">router</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.router = router; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.plain = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouterPlain(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.regexp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouterRegexp(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">route</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = request.url; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.regexp.route(url) || <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.plain.route(url); }, <span class="hljs-attr"><span class="hljs-attr">requireAll</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">path</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> files = fs.readdirSync(path); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; files.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> file = path + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + files[i]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stat = fs.statSync(file); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stat.isFile()) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addController(file); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stat.isDirectory()) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.requireAll(file); } } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.checkAllIndexActions(); }, <span class="hljs-comment"><span class="hljs-comment">//       regexp  addRoutes : function (routes) {}, //  ".js"       removeExt : function (file) {}, //      indexAction checkAllIndexActions : function () {}, //       addController : function (file) {}, //     false,   createController : function (name) {} }); };</span></span></code> </pre></blockquote><br><br>  First of all, it is necessary to disassemble the regulars that are passed using <code>addRoutes</code> <br><blockquote><pre> <code class="javascript hljs">exports[<span class="hljs-string"><span class="hljs-string">'Router.Regexp'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">spirit</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class({ <span class="hljs-attr"><span class="hljs-attr">initialize</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">routerHelper</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.routerHelper = routerHelper; }, <span class="hljs-attr"><span class="hljs-attr">route</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//            for (var i = 0; i &lt; this.routes.length; i++) { var route = this.routes[i]; //           //      lastIndex,  //        , //   route.regexp.lastIndex = 0; var result = route.regexp.exec(url); if (result) { return { contr : this.routerHelper .createController(route.contr.name), method : route.contr.method, args : this.regexpRouteArgs(result, route.argsMap) }; } } return false; }, routes : [], addRoute : function (route, controller, argsMap) { }, addRoutes : function (hash) { }, //     ,   addRoutes //         , //  ( )) -    regexpContr : function (string) { var parts = string.split(':'); var method = parts.length &gt; 0 ? parts[1] + 'Action' : 'indexAction'; var contr = 'Controllers.' + parts[0]; // ... }, //         //      // ,        regexpRoute : function (route) { var re = new RegExp(); re.compile(this.prepareRegexp(route), 'ig'); return re; }, replaces : { A : '([az]+)', D : '([0-9]+)', H : '([0-9a-f]+)', W : '([0-9a-z]+)', }, prepareRegexp : function (route) { return route .escapeRegExp() .replace(/&gt;$/, '$') .replace(/^&lt;/, '^') .replace(/:([ADHW])/g, function ($0, $1) { return this.replaces[$1]; }.bind(this)); }, //  ,   regexp.exec  //    input  lastIndex  //  ,   argsMap regexpRouteArgs : function (result, argsMap) { }, }); };</span></span></code> </pre></blockquote><br><br>  When the router did not work according to regular expressions, we use the default router: <br><blockquote><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); exports[<span class="hljs-string"><span class="hljs-string">'Router.Plain'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">spirit</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class({ <span class="hljs-attr"><span class="hljs-attr">initialize</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">routerHelper</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.routerHelper = routerHelper; }, <span class="hljs-attr"><span class="hljs-attr">route</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parts = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getControllerName(url); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> controller = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.routerHelper.createController(parts.name); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> method = <span class="hljs-string"><span class="hljs-string">'indexAction'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parts.args.length) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> action = parts.args[<span class="hljs-number"><span class="hljs-number">0</span></span>].lcfirst(); <span class="hljs-comment"><span class="hljs-comment">//    -      //     -  ,  -  indexAction if (typeof controller[action + 'Action'] == 'function') { method = action + 'Action'; parts.args.shift(); } } return { contr : controller, method : method, args : parts.args }; }, getControllerName : function (url) { var controllers = this.routerHelper.controllers; //  pathname       var path = this.splitUrl(url); var name, args = []; do { if (!path.length) { //     - name = 'Controllers.Index'; break; } //         name = 'Controllers.' + path.join('.') + '.Index'; if (controllers[name]) break; //  -      name = 'Controllers.' + path.join('.'); if (controllers[name]) break; //    -    args.unshift(path.pop()); } while (true); return { name : name, args : args }; }, splitUrl : function (urlForSplit) { return url .parse(urlForSplit, true) .pathname.split('/') .filter(function (item) { return !!item; }) .map(function (item) { return item.ucfirst(); }); }, }); };</span></span></code> </pre></blockquote><br><br><h2>  Extension classes </h2><br>  UPD: In the comments I was asked to show the advanced router when in the URL you need to specify links to two different files, for example when comparing revisions in the repository.  But the links should not be by identifier, but by the way, for example " <code>shock/spirit/init.js/f81e45</code> ".  I suggest using this link template: <br>  <code><font color="#00c">http://example.com/compare/( <font color="#060">shock/spirit/init.js/f81e45</font> )/( <font color="#060">tenshi/spirit/src/init.js/d5d218</font> )</font></code> , in which each file is shown in brackets.  But the framework tools do not allow this.  No problem.  In our project (without touching the framework) we create the class Router.Regexp: <br><br><blockquote><pre> <code class="javascript hljs">exports[<span class="hljs-string"><span class="hljs-string">'Router.Regexp'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">spirit</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class({ <span class="hljs-attr"><span class="hljs-attr">Extends</span></span> : spirit.load(<span class="hljs-string"><span class="hljs-string">'Router.Regexp'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>), <span class="hljs-attr"><span class="hljs-attr">prepareRegexp</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parent(route) .replace(<span class="hljs-regexp"><span class="hljs-regexp">/:P/g</span></span>, <span class="hljs-string"><span class="hljs-string">'([0-9a-z._\\/-]+)'</span></span>); } }); };</code> </pre></blockquote><br>  We have introduced a new modifier - ": P".  It would probably be more correct to simply extend the Router.Regexp.replaces object, but I wanted to show the possibilities of overloading methods.  Great, now add a new route to init.js: <br><br><blockquote><pre> <code class="javascript hljs">spirit.createRouter() .addRoutes( <span class="hljs-comment"><span class="hljs-comment">// ... { route : "&lt;/compare/(:P)/(:P)&gt;" , contr : 'Man.Route:compare' } );</span></span></code> </pre></blockquote><br>  And add the method to Man.Route: <br><blockquote><pre> <code class="javascript hljs"> compareAction : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exit(<span class="hljs-string"><span class="hljs-string">'Compare "'</span></span> + args[<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-string"><span class="hljs-string">'" and "'</span></span> + args[<span class="hljs-number"><span class="hljs-number">1</span></span>] + <span class="hljs-string"><span class="hljs-string">'"'</span></span>); }</code> </pre></blockquote><br>  Go to <code><font color="#00c">http://example.com/compare/( <font color="#060">shock/spirit/init.js/f81e45</font> )/( <font color="#060">tenshi/spirit/src/init.js/d5d218</font> )</font></code> and get the answer: <br><blockquote> <code>Compare " <font color="#060">shock/spirit/init.js/f81e45</font> " and " <font color="#060">tenshi/spirit/src/init.js/d5d218</font> "</code> </blockquote> <br><br><h2>  Conclusion </h2><br>  So, we created our project, forced the server to display it on the web, learned how to include classes and, after analyzing the address, send the action to the required controller.  In the following articles we will connect the View as some kind of template engine, and a Model in which information about our objects will be stored.  After a couple of articles, we will try to write a blog on our framework.  Interesting? </div><p>Source: <a href="https://habr.com/ru/post/106846/">https://habr.com/ru/post/106846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../10684/index.html">The Internet is growing at the expense of blogs</a></li>
<li><a href="../106841/index.html">Each student - on the "hamster"</a></li>
<li><a href="../106842/index.html">Backpacks for cowards!</a></li>
<li><a href="../106843/index.html">Why do programmers break deadlines</a></li>
<li><a href="../106845/index.html">Windows 8 may appear in two years</a></li>
<li><a href="../106849/index.html">Broadcast master class for the company "Kaspersky Lab"</a></li>
<li><a href="../10685/index.html">Ten of the best games to play in a drunken state</a></li>
<li><a href="../106850/index.html">Chatbot Suzette won the L√∂bner Prize, was able to deceive the judge</a></li>
<li><a href="../106853/index.html">Teacher Foo and command line utilities</a></li>
<li><a href="../106858/index.html">Duel of Samsung Galaxy TAB vs Apple iPad</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>