<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Qt / Objective-C ++ 11 or building a Qt project using GCC-4.7 and Clang</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good luck to everyone! 

 Today I will tell dear habrages about another perversion - about building a project written in Qt, under Mac OS X by the GCC...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Qt / Objective-C ++ 11 or building a Qt project using GCC-4.7 and Clang</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/73d/226/d20/73d226d206c8012d750fe0f45dd89c2a.png" align="right">  Good luck to everyone! <br><br>  Today I will tell dear habrages about another perversion - about building a project written in Qt, under Mac OS X by the GCC-4.7.0 compiler with Clang impurity (about the hose - at the end of the article, it will become clear why ). <br><br>  Why do we need GCC 4.7?  Well, for example, to use all those cool features from the standard C ++ 11.  Is this not enough?  In addition to supporting the new standard, there are a <a href="http://gcc.gnu.org/gcc-4.7/changes.html">lot of improvements</a> in it compared to the GCC 4.2 bundled with Xcode (although it turns out to be i686-apple-darwin11-llvm-g ++ - 4.2), so the meaning of the transition to 4.7 is clearly there.  But the problems are present, as described below. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We can assume that we will need some features from <code>Cocoa</code> , which means we will need the Objcetive-C compiler, and even better - Objective-C ++, for example, to <a href="http://habrahabr.ru/post/133700/">integrate</a> our Qt-application into the Mac OS X environment. <br><a name="habracut"></a><br>  We will start with the installation of GCC-4.7.0.  You can, of course, use the ready-made assembly (for example, <a href="https://github.com/sol-prog/gcc-4.7-binary">from here</a> ), but we will go the way of the Jedi and build the compilers themselves, because in the assembly by the link above there is no support for Objective-C [++].  It is simpler than it seems at first glance, you can do everything manually (following the instructions, for example, <a href="http://solarianprogrammer.com/2012/02/20/living-on-the-edge-building-gcc-4-7-on-mac-osx-lion/">from here</a> ), and you can make a normal script that will do all the work for us.  For example, my script, based on <a href="http://apple.stackexchange.com/questions/38222/how-do-i-install-gcc-via-homebrew">this discussion</a> , will require brew and wget: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # # This script downloads and builds GCC 4.7.0 for Mac OS X. # Depends on: brew, wget # # This file is modifyed version of script by Konrad Rudolph, found here: # http://apple.stackexchange.com/questions/38222/how-do-i-install-gcc-via-homebrew # VERSION=4.7.0 VER_SHORT=4.7 PREFIX=/usr/local/gcc-${VER_SHORT} TEMP_DIR=temp-gcc LANGUAGES=c,c++,objc,obj-c++ MAKE='make -j 4' echo "Preparing to install GCC ${VERSION}..." echo " Installation path: ${PREFIX}" echo " Temporary dir: ${TEMP_DIR}" echo " Programming languages: ${LANGUAGES}" brew-path() { brew info $1 | head -n3 | tail -n1 | cut -d' ' -f1; } # Prerequisites echo echo "Installing gmp, mpfr and libmpc using brew..." brew install gmp brew install mpfr brew install libmpc # Download &amp; install the latest GCC echo echo "Downloading GCC sources..." mkdir -p $PREFIX mkdir ${TEMP_DIR} cd ${TEMP_DIR} wget ftp://ftp.gnu.org/gnu/gcc/gcc-${VERSION}/gcc-${VERSION}.tar.gz tar xfz gcc-$VERSION.tar.gz rm gcc-${VERSION}.tar.gz cd gcc-${VERSION} mkdir build cd build echo echo "Configuring GCC..." ../configure \ --prefix=$PREFIX \ --with-gmp=$(brew-path gmp) \ --with-mpfr=$(brew-path mpfr) \ --with-mpc=$(brew-path libmpc) \ --program-suffix=-${VER_SHORT} \ --enable-languages=${LANGUAGES} \ --with-system-zlib \ --enable-stage1-checking \ --enable-plugin \ --enable-lto \ --disable-multilib echo echo "Building GCC..." $MAKE bootstrap echo echo "Installing GCC..." make install</span></span></code> </pre>  (its development can be monitored on the <a href="">githab</a> ) <br><br>  Well, after a half-hour (¬±) build, we get GCC 4.7.0, which is installed in /usr/local/gcc-4.7/bin.  Now you can try to build our project with it.  But first, just check if it works: <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PATH=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/gcc-4.7/bin:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span> $ g++-4.7 --version g++-4.7 (GCC) 4.7.0 Copyright (C) 2012 Free Software Foundation, Inc.     .      .   - ,       - .</code> </pre><br>  Well, not bad at all.  But how to make qmake build a project with this compiler?  In addition to the <code>export PATH</code> we will need to tell qmake which compiler to use.  This can be done in two ways. <br><br>  The first method, rough, crooked and uncomfortable, and most importantly - fundamentally wrong.  Specify the compiler in the .pro file: <br><br><pre> <code class="bash hljs">macx { QMAKE_CXX = g++-4.7 QMAKE_CXXFLAGS += -std=c++11 -v QMAKE_CXXFLAGS_X86_64 -= -Xarch_x86_64 QMAKE_CC = gcc-4.7 QMAKE_CFLAGS += -std=c++11 -v QMAKE_CFLAGS_X86_64 -= -Xarch_x86_64 QMAKE_LINK = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CXX</span></span> QMAKE_LINK_SHLIB = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CXX</span></span> QMAKE_LINK_C = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CC</span></span> QMAKE_LINK_C_SHLIB = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CC</span></span> QMAKE_LFLAGS_X86_64 -= -Xarch_x86_64 QMAKE_OBJECTIVE_CFLAGS_X86_64 -= -Xarch_x86_64 }</code> </pre><br>  The second way, neat, beautiful and <b>correct</b> .  Create your <code>mkspec</code> !  To do this, go to <code>/usr/local/Qt4.8/mkspecs</code> , and execute some simple commands to start with: <br><br><pre> <code class="bash hljs">sudo cp macx-g++ macx-g++47 sudo cp common/g++-base.conf common/g++47-base.conf sudo cp common/g++-macx.conf common/g++47-macx.conf</code> </pre><br>  Next, in our favorite text editor (in my case, mcedit), we bring the <code>macx-g++47/qmake.conf</code> to the following form: <br><br><pre> <code class="bash hljs">MAKEFILE_GENERATOR = UNIX TARGET_PLATFORM = macx TEMPLATE = app CONFIG += qt warn_on release app_bundle incremental global_init_link_order lib_version_first plugin_no_soname link_prl QT += core gui QMAKE_INCREMENTAL_STYLE = sublib include(../common/mac.conf) include(../common/gcc-base-macx.conf) include(../common/g++47-macx.conf) load(qt_config)</code> </pre><br>  In essence, we append ‚Äú47‚Äù in the middle of the last but one line.  Next, edit the file <code>common/g++47-macx.conf</code> , make it like this: <br><br><pre> <code class="bash hljs">include(g++47-base.conf) QMAKE_CFLAGS_RELEASE_WITH_DEBUGINFO += $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CFLAGS_DWARF2</span></span> QMAKE_CXXFLAGS_RELEASE_WITH_DEBUGINFO += $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CFLAGS_DWARF2</span></span> QMAKE_LFLAGS_RELEASE_WITH_DEBUGINFO += -g $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CFLAGS_DWARF2</span></span> QMAKE_LFLAGS_STATIC_LIB += -all_load QMAKE_CFLAGS_X86_64 += -mmacosx-version-min=10.5 -std=c++11 QMAKE_CFLAGS_PPC_64 += -mmacosx-version-min=10.5 -std=c++11 QMAKE_CXXFLAGS_X86_64 = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CFLAGS_X86_64</span></span> QMAKE_CXXFLAGS_PPC_64 = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CFLAGS_PPC_64</span></span> QMAKE_OBJECTIVE_CFLAGS_X86_64 = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CFLAGS_X86_64</span></span> QMAKE_OBJECTIVE_CFLAGS_PPC_64 = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CFLAGS_PPC_64</span></span> QMAKE_LFLAGS_X86_64 = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CFLAGS_X86_64</span></span> QMAKE_LFLAGS_PPC_64 = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CFLAGS_PPC_64</span></span> QMAKE_OBJCFLAGS_PRECOMPILE = -x objective-c-header -c <span class="hljs-variable"><span class="hljs-variable">${QMAKE_PCH_INPUT}</span></span> -o <span class="hljs-variable"><span class="hljs-variable">${QMAKE_PCH_OUTPUT}</span></span> QMAKE_OBJCFLAGS_USE_PRECOMPILE = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CFLAGS_USE_PRECOMPILE</span></span> QMAKE_OBJCXXFLAGS_PRECOMPILE = -x objective-c++-header -c <span class="hljs-variable"><span class="hljs-variable">${QMAKE_PCH_INPUT}</span></span> -o <span class="hljs-variable"><span class="hljs-variable">${QMAKE_PCH_OUTPUT}</span></span> QMAKE_OBJCXXFLAGS_USE_PRECOMPILE = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CFLAGS_USE_PRECOMPILE</span></span></code> </pre><br>  Again, in essence, we change only the build flags and add <font color="#acacac"><s>MAGIC NUMBER</s></font> 47. <br><br>  Now we finish <code>g++47-base.conf</code> : <br><br><pre> <code class="bash hljs">QMAKE_CC = gcc-4.7 QMAKE_LINK_C = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CC</span></span> QMAKE_LINK_C_SHLIB = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CC</span></span> QMAKE_CFLAGS_RELEASE_WITH_DEBUGINFO += -O2 -g QMAKE_CXX = g++-4.7 QMAKE_LINK = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CXX</span></span> QMAKE_LINK_SHLIB = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CXX</span></span> QMAKE_CXXFLAGS_RELEASE_WITH_DEBUGINFO += $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CFLAGS_RELEASE_WITH_DEBUGINFO</span></span> QMAKE_PCH_OUTPUT_EXT = .gch QMAKE_CFLAGS_PRECOMPILE = -x c-header -c <span class="hljs-variable"><span class="hljs-variable">${QMAKE_PCH_INPUT}</span></span> -o <span class="hljs-variable"><span class="hljs-variable">${QMAKE_PCH_OUTPUT}</span></span> QMAKE_CFLAGS_USE_PRECOMPILE = -include <span class="hljs-variable"><span class="hljs-variable">${QMAKE_PCH_OUTPUT_BASE}</span></span> QMAKE_CXXFLAGS_PRECOMPILE = -x c++-header -c <span class="hljs-variable"><span class="hljs-variable">${QMAKE_PCH_INPUT}</span></span> -o <span class="hljs-variable"><span class="hljs-variable">${QMAKE_PCH_OUTPUT}</span></span> QMAKE_CXXFLAGS_USE_PRECOMPILE = $<span class="hljs-variable"><span class="hljs-variable">$QMAKE_CFLAGS_USE_PRECOMPILE</span></span></code> </pre><br><img src="https://habrastorage.org/storage2/d29/d28/2d6/d29d282d6bf06c21b7b2cb3247857cd1.png" alt="image" align="left">  Here we again added "-4.7" in a couple of lines.  Well, that will be enough.  Now you can customize Qt Creator to work with the new mkspec!  In the settings, go to <code>Build &amp; Run -&gt; Tool Chains -&gt; Add -&gt; GCC</code> , in the Compiler path field enter <code>/usr/local/gcc-4.7/bin/g++-4.7</code> , in the Debugger - <code>/usr/bin/gdb</code> , and mkspec - <code>macx-g++47</code> .  The toolchain itself can be called something like ‚ÄúGCC-4.7‚Äù, ‚Äúc ++ 11 compiler‚Äù or something like that.  Now you can choose our new toolchain in the project settings and - voila!  - the project will be assembled by our freshly assembled compiler!  If we want to use the whole thing from the console, it will be enough to call qmake with the <code>-spec macx-g++47</code> parameter. <br><br>  Well, you can work, projects are collected, run and work.  But there are a couple of problems ... <br><br>  More precisely, problem.  One of them is if you try to start using Objective-C [++] in the project, then the compiler will be a little bent.  Why?  The reason is simple: the Objective-C compiler from GCC does not understand blocks!  How so?  Why?  Who allowed?  I do not know, but the fact is a fact.  Therefore, it will be extremely confusing outside of C / C ++.  It's a pity.  But let's not lose heart!  If Objective-C [++] code cannot be compiled using GCC, we will compile it with clang.  To do this, again, edit the <code>g++47-base.conf</code> and <code>g++47-macx.conf</code> , <code>g++47-macx.conf</code> following lines to the end: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># in file g++47-base.conf QMAKE_OBJECTIVE_CC = clang # in file g++47-macx.conf QMAKE_OBJECTIVE_CFLAGS += -std=c++0x -stdlib=libc++</span></span></code> </pre><br>  Thus, all our C / C ++ sources will be built with g ++ - 4.7, and Objective-C sources [++] will be built with clang.  Uncomfortable?  Of course, uncomfortable!  It would seem that it is easier to switch completely to clang, since it supports C ++ 11 in some volume.  But!  It‚Äôs still a long way from GCC, so in our * .mm files we‚Äôll be careful not to use C ++ 11 in large quantities, the hose will not withstand everything, unfortunately.  But in the * .cpp files there is a place to roam! <br><br>  If you are reluctant to walk around mkcpecs and edit them, <a href="https://github.com/silvansky/qt48_mkspec_gcc-47">I ask for a github</a> , there I posted my version.  And remember!  GCC 4.7 is installed in <code>/usr/local/gcc-4.7/bin/</code> , so you cannot do without PATH export!  Although, in Qt Creator you can add this path in the PATH for building in the project properties. <br><br>  Successful builds!  And fewer errors! <br><br>  <b>PS:</b> If you find inaccuracies and / or know better methods, please unsubscribe in the comments =). </div><p>Source: <a href="https://habr.com/ru/post/144707/">https://habr.com/ru/post/144707/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144700/index.html">Development and application of the PAM module for authentication in Astra Linux using Rutoken EDS and Rutoken S</a></li>
<li><a href="../144701/index.html">Using Windows Azure in a bootstrapping SaaS startup</a></li>
<li><a href="../144703/index.html">Smashing Magazine refused button Like</a></li>
<li><a href="../144705/index.html">Eric Schmidt: disconnect from computers for an hour every day</a></li>
<li><a href="../144706/index.html">Electronic door peephole</a></li>
<li><a href="../144708/index.html">ZooKeeper or write distributed locking service</a></li>
<li><a href="../144709/index.html">Fidel.ru - everything</a></li>
<li><a href="../144710/index.html">‚ÄúRunet today‚Äù, May 28, 2012. Experts of the issue: Maria Chernitskaya, Alexey Andreev</a></li>
<li><a href="../144712/index.html">Instant file search in Windows. Sleight of hand and no fraud</a></li>
<li><a href="../144713/index.html">Registration for PHDays 2012 contests has begun</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>