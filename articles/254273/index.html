<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimization of ISPmanager for projects on Bitrix or how I crossed ISPmanager and VMBitrix (Bitrix environment)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="UPDATE 04/23/2015 



1. Solution successfully tested on ISPmanager 4 
2. In Apache MPM-ITK mode, the restore.php script gives an error, information o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimization of ISPmanager for projects on Bitrix or how I crossed ISPmanager and VMBitrix (Bitrix environment)</h1><div class="post__text post__text-html js-mediator-article">  <b>UPDATE 04/23/2015</b> <br><br><ol><li>  Solution successfully tested on ISPmanager 4 </li><li>  In Apache MPM-ITK mode, the restore.php script gives an error, information on it in the "Important Information" section </li></ol><br><br><h1>  What for? </h1>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/842/444/2a3/8424442a32051ed14361487c7118b20f.png" alt="image"><br><br>  Perhaps you are already familiar with such a product as <a href="https://www.1c-bitrix.ru/products/env/">"1C-Bitrix: Web Environment" - Linux</a> .  This is often an ideal solution for projects based on the CMS Bitrix, but, sometimes, a purely ‚Äúconsole‚Äù menu does not have the necessary functionality for people working on projects. <br><br>  For example, another popular product, <a href="https://www.ispsystem.ru/software/ispmanager">ISPmanager</a> , allows you to create FTP accounts from a convenient web panel for administrators in just a couple of mouse clicks, while you need Linux administration skills to perform similar actions from the console.  But you see, sometimes you just want to manage your server and projects from the tab in the browser, without the help of the ssh console. <br><br>  However, ISPmanager (in our case, its latest version is number 5) is not ready to work out of the box even with sites on Bitrix, not to mention Bitrix24, corporate portals.  Some of the functionality is not available, and projects are quite slow.  It takes a long time to learn the recommendations of the documentation on Bitrix, which, unfortunately, is sometimes very late with updating relevant information. <br><br>  Due to the requirement to work with projects through the " <a href="https://ru.wiktionary.org/wiki/user-friendly">user-friendly</a> " interface of ISPmanager 4/5 and the need to maintain the speed and functionality of the projects, a decision was made about some kind of "crossing" of these two systems. <br><br><a name="habracut"></a><br><br><h1>  And so, before you begin, <b>carefully read the important information.</b> </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/a9d/773/97d/a9d77397d6e1ee6e9edb20d32c5a6a64.png" alt="image"><br><ol><li>  The installation script was <b>tested only on clean CentOS 6.6 x64_86, immediately after installing stable ISPmanager 4/5 and including nginx in ‚ÄúFeatures‚Äù.</b> <br>  For advanced users who want to use the proposed solution, who have previously modified any settings in their system, it is <b>strongly not recommended to install the scripts fully automatically - execute commands from them manually</b> </li><li>  <b>The author does not give any guarantees</b> for the stable or proper operation of the proposed solution.  All instructions you perform <b>at your own risk.</b>  The current version of scripts and configuration files is under active testing. </li><li>  <b>The ‚Äúcompression‚Äù module</b> in the system must be <b>DELETED.</b> </li><li>  <b>The</b> Apache MPM-ITK <b>bitrix restore.php script</b> crashes with the short_open_tag parameter must be turned on in php.ini <br>  This happens because of the incorrect use of the if condition in this script.  The problem exists because in all other php modes it is not modulated, but I have already contacted the developers of 1C-Bitrix and they will have to correct the problem (another question is when they will do it).  If someone is interested in the details of the bug - I will answer in the comments <br><br>  So far, as a temporary fix, we use a distribution kit from the archive attached to the article to restore the site. <br><br><h1>  Fully automatic optimization </h1><br><br><img src="https://habrastorage.org/getpro/habr/post_images/77d/2ea/018/77d2ea018f1026258c8adc52179c2cea.png" alt="image"><br><br>  For your convenience, the entire solution is decorated in fully automatic scripts and pre-prepared configuration files. <br><br>  <u><b>The following scenario is considered:</b></u> <br><br><ol><li>  You have installed clean CentOS 6.6 x86_64 </li><li>  Install ISPmanager 4/5, <a href="https://www.ispsystem.ru/software/ispmanager/download">following the official instructions</a> </li><li>  <b>In the "Features" section of the ISPmanager 4/5 panel, activate Nginx</b> </li></ol><br><br><img src="https://habrastorage.org/getpro/habr/post_images/28c/5df/730/28c5df730db6bd1eb2f294726f48508b.png" alt="image"><br><br>  <u><b>Then you can proceed to the optimization itself: (all links at the end of the publication)</b></u> <br><ol><li>  we launch <b>"bitrix-en_5.1.2_patched_2.sh"</b> </li><li>  <b>Copy the</b> script <b>"isp_patch_V0.x.sh"</b> together with the unpacked archive <b>"patch_filesV0.1.zip"</b> to an arbitrary directory on the server </li><li>  we launch <b>isp_patch_V0.x.sh</b> </li></ol><br><br>  <i><b>Congratulations, your server with ISPmanager 4/5 is ready to work with projects on Bitrix</b></i> <br><br>  <u><b>It remains only to deploy the site in a fresh domain: (all links at the end of the publication)</b></u> <br><img src="https://habrastorage.org/getpro/habr/post_images/43c/610/d9c/43c610d9c7401b360bcafa15c0ea3684.png" alt="image"><br><br><ul><li>  The variant I proposed on how to do this is in a separate but small instruction ‚Äú <b>creating a host.pdf</b> ‚Äù (in any case, pay attention to connecting the necessary apache and nginx config to the created host) </li><li>  For your convenience, I post the distribution kit for installing Bitrix in the " <b>bitrix_install.zip</b> " archive (the installation in this case takes place in the <a href="http://dev.1c-bitrix.ru/learning/course/%3FCOURSE_ID%3D32%26LESSON_ID%3D5050">Quick Install / Short install</a> mode) </li></ul><br><br><h1>  What happened </h1><br><br>  Fully working default ISPManager 4/5, who learned how to work with projects on Bitrixes quickly and without loss of functionality. <br><br>  The assembly is already used in our company - <a href="http://www.mcart.ru/">AMC Art</a> , both for its sites and stands, and for the production of client sites. <br><br>  <b>I will be glad to any of your comments, comments and suggestions!</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/950/8da/35e/9508da35e22d526b49a034b3fe365dd9.jpg" alt="image"><br><br><h1>  Consider the proposed solution in more detail. </h1><br><br><h2>  Stage 1. bitrix-env.sh (or ‚Äú1C-Bitrix: Web Environment‚Äù - Linux) </h2><br><br><img src="https://habrastorage.org/getpro/habr/post_images/27a/a5f/c11/27aa5fc112aedf14bb0e56267cdb1447.png" alt="image"><br><br>  The classic installation of Bitrix occurs on the Bitrix environment, which is installed via a script <br>  <a href="http://www.1c-bitrix.ru/products/env/">www.1c-bitrix.ru/products/env</a> <br>  We‚Äôll start optimizing our ISPmanager with bitrix-env.sh. <br>  In fact, there is nothing special in the script itself, first there is a standard check of the distribution of the system, then, based on the results of this check, this or that necessary software is installed. <br>  All magic happens when the script adds the ‚Äúbranded‚Äù 1C-Bitrix repository and installs the bitrix-env * and bx-nginx package into the system.  We will focus our attention on them. <br><br>  And so, our " <b>bitrix-env_5.1.2_patched_2.sh</b> " is nothing more than a slightly altered script from 1C-Bitrix itself, but the main "trick" in the bitrix-env installation is removed from it, why - I will tell further. <br><br><h2>  Stage 2. bitrix-env.rpm (or Main Configuration Step) </h2><br><br><img src="https://habrastorage.org/getpro/habr/post_images/760/54b/63c/76054b63c02a0decc185bc1546b75c1c.png" alt="image"><br><br>  The ecosystem offered by bitrix-env does not suit us, cluttering up potentially conflicting ISPmanager packages / configs and the Bitrix environment does not need anything at all. <br><br>  Leaving in my opinion only necessary, I transferred everything from the rpm package to the isp_patch.sh script (attention, tested only on centos 6.6 x64). <br><br>  Further - a little more. <br><br><h3>  Stage 2.1 bx-nginx (or Nginx with Push &amp; Pull support) </h3><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fe3/cc2/9ac/fe3cc29ac8e984a3d50bcdf13f843203.png" alt="image"><br><br>  This package, which is offered to us by the Bitrix environment, is nothing more than a compiled nginx with the ‚Äúpush and pull‚Äù module, which is used in such functionality as, for example, ‚ÄúBusiness chat‚Äù, ‚ÄúLive comments‚Äù, ‚ÄúVideo calls‚Äù, ‚Äú Mobile app". <br><br>  We can just pick up our system, kindly compiled 1C-Bitrix, ready nginx binary to your machine with ISPmanager and save yourself from having to compile it yourself (22 and 23 lines of script) <br><br><h3>  Stage 2.2 bvat.bx (or software parameter autotuner) </h3><br><br><img src="https://habrastorage.org/getpro/habr/post_images/212/703/2c3/2127032c37cb03a4950084600996afd8.png" alt="image"><br>  An interesting component of the ‚ÄúBitrix environment‚Äù is the bvat.bx script, which is written into the system autoload and performs software tuning tasks that are responsible for the project‚Äôs work (mainly the server‚Äôs mysql and RAM usage).  The tuner itself works quite simply.  Based on the current configuration of the system, it exposes this or that prepared ‚Äúpreset‚Äù of settings as effective parameters.  I would like to note that the configuration provides for changes in the parameters that bvat.bx has set without turning it off completely (although you can do this). <br><br>  In our script, lines 25-31 are responsible for its installation. <br><br>  Similar to the reference Bitrix environment, your own parameters for the mysql server can be written in the /etc/mysql/conf.d/z_bx_custom.cnf file (which will be used to bypass bvat.bx).  Also, by connecting your configuration files after the bvat configuration files, you can bypass its autotuning for the rest of the software, if this or that parameter set automatically does not suit you. <br><br>  Since the script's logic is to my liking, it is easy to add its ‚Äúautomation‚Äù to its values, and installing it in the system was quite simple, I included it in my configuration. <br><br><h3>  Stage 2.3 php settings </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/243/f48/d20/243f48d209e0208a913d1dd4c29c9a6f.png" alt="image"><br>  Change a few parameters in php.ini (lines 33-40 in our script) <br><ul><li>  memory_limit = 512M </li><li>  pcre.backtrack_limit = 1000000 </li><li>  short_open_tag = On </li></ul><br>  and disable dav modules for php <br><h3>  Stage 2.4 mysql settings </h3><br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c4/724/358/7c4724358bea710a910f028582e5a1fe.png" alt="image"><br>  42-48 lines of the script copy the previously prepared and configured my.cnf, in which you probably want to change something yourself. <br><br><h3>  Stage 2.5 bitrixenv.ini (or php directives necessary for Bitrix to work) </h3><br><br><img src="https://habrastorage.org/getpro/habr/post_images/088/a72/297/088a722975688ca251536a2eb20c4069.png" alt="image"><br><br>  An integral part of the classic Bitrix environment is the /etc/php.d/bitrixenv.ini file, which contains the necessary settings for the directives listed in it. <br><br>  with a minimal difference with the original file, I will copy it to my ISPmanager machine, as /etc/httpd/bx/bx_apache.conf (lines 50-52). <br><br>  <b>It is important to note that we will not intentionally include this file anywhere</b> , in order to prescribe it if necessary only for individual Virtualhosts created from under ISPmanager (in the config-apache section). <br><br><h3>  Step 2.6 Configuring nginx </h3><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f98/cd9/dec/f98cd9dec615d28fd96ed26fb41dc152.png" alt="image"><br>  Nginx settings in my script have an ‚Äúautotune‚Äù share (line 64 and 67) <br>  The rest is taken from the configuration files for nginx from the Bitrix environment. <br><br>  lines 72-77 are responsible for server level compression <br>  79-82 - for push &amp; pull <br><br>  Note the <i><b>bx / conf / bitrix.conf file</b></i> .  It is important to note that <b>we never intentionally include this file in</b> order to <b>preserve</b> it if necessary only to individual hosts created from under ISPmanager (in the nginx config section) <br><br>  In addition, it has a block ‚ÄúSome security options‚Äù with pre-prepared, but commented-out options related to host security. <br><br><h1>  File Link </h1><br>  <a href="">isp.bitrix_v0.6.zip</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/254273/">https://habr.com/ru/post/254273/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254257/index.html">We make payments iOS AppStore with checking on the server</a></li>
<li><a href="../254259/index.html">Remote control of the Lego Mindstorms robot via JMX and IP Video</a></li>
<li><a href="../254261/index.html">Trinity computer in browser</a></li>
<li><a href="../254263/index.html">Creating a plugin for logical replication in PostgreSQL 9.4+</a></li>
<li><a href="../254267/index.html">Evolution of web injects, part 1</a></li>
<li><a href="../254275/index.html">The ratio of abstraction and complexity in modeling</a></li>
<li><a href="../254277/index.html">The results of a survey of the popularity of PHP frameworks from Sitepoint</a></li>
<li><a href="../254279/index.html">MVC on the server does not happen</a></li>
<li><a href="../254281/index.html">Complete energy autonomy or how to survive with solar panels in the outback (part 3. transitional)</a></li>
<li><a href="../254287/index.html">iOS app from sketch to App Store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>