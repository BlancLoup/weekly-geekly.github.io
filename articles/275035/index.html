<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DLP do-it-yourself system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In addition to the main task of preventing the leakage of confidential information, DLP systems may also have secondary (additional) tasks. These incl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DLP do-it-yourself system</h1><div class="post__text post__text-html js-mediator-article">  In addition to the main task of preventing the leakage of confidential information, DLP systems may also have secondary (additional) tasks.  These include: <br><br><ul><li>  copying transmitted messages to investigate security incidents in the future; </li><li>  eliminating the possibility of sending not only confidential information, but also various undesirable (spam, offensive expressions, information of erotic content, huge amounts of data, etc.); </li><li>  filtering unwanted information upon receipt, not only when sending; </li><li>  eliminate the use of information resources, employees, for personal purposes; </li><li>  traffic reduction, channel load optimization; </li><li>  control of staff time. </li></ul><br>  Our manual DLP system will not solve all the tasks, and focus only on: <br><br><ul><li>  search for specific files on the network; </li><li>  reporting and delivery of reports to the system administrator or security officer; </li><li>  Perform deletion according to certain criteria. </li></ul><a name="habracut"></a><br>  Finding files on Windows is a simple and trivial task.  Even searching on a remote machine is not much more difficult.  But if you need something to find on hundreds of machines, then the question arises how?  Do not use your hands to go through all the PCs.  This task is quite common in the work of Windows admins, when, for example, an audit of information storage is needed.  You will say that there are examples of implementation, yes, but they are more aimed at searching for data that is prohibited for storage (movies, games, etc.), the variant I proposed implements one of the tasks of the DLP system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And so what can a script (or rather a set of scripts)?  In order not to bother the administrator and unload the list of PCs for checking, the script integrates with AD and receives the information it needs, it is possible to filter by extension and name, add exceptions, generate a report in a folder and send the message to the administrator and user (Notification of detected files and recommendations to be taken).  Parameters can be combined and changed, getting the necessary functionality.  After the search, a list of files is created with the names of the PCs in which information on the search is stored.  The second part of the script is to delete the found files, all or according to certain criteria. <br><br>  We use this script to track users and notify them about the need to store working documents in a specific place (personal network drive), the script identifies the active user on the PC, takes the mailbox data from the AD and sends notifications about which file is found and where on a local disk that the user must move to the network storage or it will be deleted.  In the end, we delete, what is not according to the regulations.  Thus, we realize one of the functions of DLP-systems for controlling the storage of confidential information. <br><br><h2>  File Script Algorithm </h2><br><img align="left" src="https://habrastorage.org/files/ba9/525/5bf/ba95255bf6da4fcf900ecf9155d64a71.jpg"><br><br><ol><li>  Gets a list of workstations from a specific OU </li><li>  Checks the data in the HomePage attribute, if it is ‚ÄúPass‚Äù, skips searching for files, as this computer has already searched </li><li>  Checks availability </li><li>  If not available, writes this to a file. </li><li>  If available, searches for files. </li><li>  At the end of the search, writes to the attribute HomePage - the value "Pass" </li><li>  The file is formed by the name of the machine and the list of found files. </li><li>  Message is sent to the administrator with an attachment </li><li>  Specifies the name of the local user. </li><li>  Find out in AD mailing address of the user </li><li>  Sends a copy of the report </li></ol><br><h2>  Algorithm bypass reset script </h2><br><img align="left" src="https://habrastorage.org/files/ef8/fd5/44e/ef8fd544e584406aab5a44da143e4784.jpg"><br><br><ol><li>  Get list of cars from AD </li><li>  Sets the value of the attribute notpass </li></ol><br>  Thus, all the machines fall into the script processing field, including those that have already been scanned. <br><br><h2>  File Delete Script Algorithm </h2><br><img src="https://habrastorage.org/files/cfc/25e/4df/cfc25e4df82e4b809d83a3f46d3feeca.jpg"><br><br><ol><li>  Load script contents </li><li>  For each line in the list (result), deletes the object on the remote computer </li></ol><br><h2>  Setting up the script and running (file auditing) </h2><br>  The script is executed as a command with the specified parameters.  Below are examples of running the script and its parameters.  Start-AuditFiles - the command that executes the script.  Parameters can be combined, as required by the task. <br><br><h3>  Example 1 </h3><br><pre><code class="bash hljs">Start-AuditFiles -OU <span class="hljs-string"><span class="hljs-string">"OU=Test,DC=root,DC=local"</span></span> -SMTP smtp.server.com -AdminMail administrator@server.com -IncludeFile *.doc,*.docx,*.sys -ExclusionFile *File1*,*File2* -ExclusionFolder ‚Äú*Folder1*,*Folder2*‚Äù -ReportPath \\server\reports\ - Throttle 5</code> </pre> <br>  In this example, the search is performed on computers from the OU, all files with the extension (* .doc, *. Docx, *. Sys) except files (* File1 *, * File2 *), except directories (* Folder1 *, * Folder2 *) , the report is duplicated in the directory (\\ server \ reports \).  The report is sent to the user and administrator.  The number of threads is 5. <br><br><h3>  Example 2 </h3><br><pre> <code class="bash hljs">Start-AuditFiles -RemoteComputer ws-pc-4902,ws-pc-0982 -SMTP smtp.server.com -AdminMail administrator@server.com -Include *.doc,*.docx,*.sys -ExclusionFile *New*,*au* -AdminOnly - Throttle 10</code> </pre><br>  In this example, the search is performed on computers (ws-pc-4902, ws-pc-098), all files with the extension (* .doc, *. Docx, *. Sys) except files (* File1 *, * File2 *).  The report is sent only to the administrator.  The number of threads is 10. <br><br><h3>  Target computer settings </h3><br>  <b>OU</b> ( <i>required or RemoteComputer must be specified</i> ) - path to the organizational unit with target computers, if this parameter is not specified, the RemoteComputer parameter should be specified.  One of these two parameters should be used in the script. <br><br>  Example: -OU "OU = Test, DC = root, DC = local" or -OU $ Computerlist (the variable is set in combination with other scripts). <br><br>  <b>RemoteComputer</b> ( <i>mandatory or OU must be specified</i> ) - is set if it is necessary to execute the script only for certain computers from the list, either one specific or several, specifying them with a comma. <br><br>  Example: -RemoteComputer ws-pc-4902, ws-pc-0982 <br><br><h3>  Search options </h3><br>  <b>IncludeFile</b> ( <i>required, it is possible to use a mask</i> *) - a list of files or their extensions to be searched (may be a list). <br><br>  <b>ExclusionFile</b> ( <i>optional</i> ) - a list of files that should be excluded from the search (can be a list). <br><br>  <b>ExclusionFolder</b> ( <i>optional</i> ) - the list of excluded directories. <br><br><h3>  Report Options </h3><br>  <b>ReportPath</b> ( <i>optional</i> ) - the path to a network resource or local directory to which the scan results will be copied. <br><br>  <b>AdminMail</b> ( <i>optional</i> ) - the address on whose behalf the report is sent, reports destined for the administrator will be delivered to the same address. <br><br>  <b>SMTP</b> ( <i>optional</i> ) - The name of the SMTP server used as the sending gateway. <br><br>  <b>AdminOnly</b> ( <i>optional</i> ) - enables the report sending mode only to the administrator. <br><br>  <b>Throttle</b> ( <i>mandatory, numeric value from 1 - to 99</i> ) - sets the number of scan threads. <br><br><h2>  Module installation </h2><br>  It is necessary in the directory "C: \ Windows \ system32 \ WindowsPowerShell \ v1.0 \ Modules", copy the files: <br>  <i>Invoke-Parallel.psm1</i> <i><br></i>  <i>Start-AuditFiles.psm1</i> <br><br>  Before running the script, modules must be imported: <br><br><pre> <code class="bash hljs">Import-Module C:\Windows\system32\WindowsPowerShell\v1.0\Modules\Invoke-Parallel.psm1 Import-Module C:\Windows\system32\WindowsPowerShell\v1.0\Modules\Start-AuditFiles.psm1</code> </pre><br><h3>  Script (module) </h3><br>  This script must be saved as an <i>Invoke-Parallel.psm1</i> file. <br><br><div class="spoiler">  <b class="spoiler_title">Script Invoke-Parallel.psm1</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span> Invoke-Parallel { [cmdletbinding(DefaultParameterSetName=<span class="hljs-string"><span class="hljs-string">'ScriptBlock'</span></span>)] Param ( [Parameter(Mandatory=<span class="hljs-variable"><span class="hljs-variable">$false</span></span>,position=0,ParameterSetName=<span class="hljs-string"><span class="hljs-string">'ScriptBlock'</span></span>)] [System.Management.Automation.ScriptBlock]<span class="hljs-variable"><span class="hljs-variable">$ScriptBlock</span></span>, [Parameter(Mandatory=<span class="hljs-variable"><span class="hljs-variable">$false</span></span>,ParameterSetName=<span class="hljs-string"><span class="hljs-string">'ScriptFile'</span></span>)] [ValidateScript({<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-path <span class="hljs-variable"><span class="hljs-variable">$_</span></span> -pathtype leaf})] <span class="hljs-variable"><span class="hljs-variable">$ScriptFile</span></span>, [Parameter(Mandatory=<span class="hljs-variable"><span class="hljs-variable">$true</span></span>,ValueFromPipeline=<span class="hljs-variable"><span class="hljs-variable">$true</span></span>)] [Alias(<span class="hljs-string"><span class="hljs-string">'CN'</span></span>,<span class="hljs-string"><span class="hljs-string">'__Server'</span></span>,<span class="hljs-string"><span class="hljs-string">'IPAddress'</span></span>,<span class="hljs-string"><span class="hljs-string">'Server'</span></span>,<span class="hljs-string"><span class="hljs-string">'ComputerName'</span></span>)] [PSObject]<span class="hljs-variable"><span class="hljs-variable">$InputObject</span></span>, [PSObject]<span class="hljs-variable"><span class="hljs-variable">$Parameter</span></span>, [switch]<span class="hljs-variable"><span class="hljs-variable">$ImportVariables</span></span>, [switch]<span class="hljs-variable"><span class="hljs-variable">$ImportModules</span></span>, [int]<span class="hljs-variable"><span class="hljs-variable">$Throttle</span></span> = 20, [int]<span class="hljs-variable"><span class="hljs-variable">$SleepTimer</span></span> = 200, [int]<span class="hljs-variable"><span class="hljs-variable">$RunspaceTimeout</span></span> = 0, [switch]<span class="hljs-variable"><span class="hljs-variable">$NoCloseOnTimeout</span></span> = <span class="hljs-variable"><span class="hljs-variable">$false</span></span>, [int]<span class="hljs-variable"><span class="hljs-variable">$MaxQueue</span></span>, [validatescript({Test-Path (Split-Path <span class="hljs-variable"><span class="hljs-variable">$_</span></span> -parent)})] [string]<span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> = <span class="hljs-string"><span class="hljs-string">"C:\temp\log.log"</span></span>, [switch] <span class="hljs-variable"><span class="hljs-variable">$Quiet</span></span> = <span class="hljs-variable"><span class="hljs-variable">$false</span></span> ) Begin { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( -not <span class="hljs-variable"><span class="hljs-variable">$PSBoundParameters</span></span>.ContainsKey(<span class="hljs-string"><span class="hljs-string">'MaxQueue'</span></span>) ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-variable"><span class="hljs-variable">$RunspaceTimeout</span></span> -ne 0){ <span class="hljs-variable"><span class="hljs-variable">$script</span></span>:MaxQueue = <span class="hljs-variable"><span class="hljs-variable">$Throttle</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-variable"><span class="hljs-variable">$script</span></span>:MaxQueue = <span class="hljs-variable"><span class="hljs-variable">$Throttle</span></span> * 3 } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-variable"><span class="hljs-variable">$script</span></span>:MaxQueue = <span class="hljs-variable"><span class="hljs-variable">$MaxQueue</span></span> } Write-Verbose <span class="hljs-string"><span class="hljs-string">"Throttle: '</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$throttle</span></span></span><span class="hljs-string">' SleepTimer '</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sleepTimer</span></span></span><span class="hljs-string">' runSpaceTimeout '</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$runspaceTimeout</span></span></span><span class="hljs-string">' maxQueue '</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$maxQueue</span></span></span><span class="hljs-string">' logFile '</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$logFile</span></span></span><span class="hljs-string">'"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$ImportVariables</span></span> -or <span class="hljs-variable"><span class="hljs-variable">$ImportModules</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$StandardUserEnv</span></span> = [powershell]::Create().addscript({ <span class="hljs-variable"><span class="hljs-variable">$Modules</span></span> = Get-Module | Select -ExpandProperty Name <span class="hljs-variable"><span class="hljs-variable">$Snapins</span></span> = Get-PSSnapin | Select -ExpandProperty Name <span class="hljs-variable"><span class="hljs-variable">$Variables</span></span> = Get-Variable | Select -ExpandProperty Name @{ Variables = <span class="hljs-variable"><span class="hljs-variable">$Variables</span></span> Modules = <span class="hljs-variable"><span class="hljs-variable">$Modules</span></span> Snapins = <span class="hljs-variable"><span class="hljs-variable">$Snapins</span></span> } }).invoke()[0] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$ImportVariables</span></span>) { Function _temp {[cmdletbinding()] param() } <span class="hljs-variable"><span class="hljs-variable">$VariablesToExclude</span></span> = @( (Get-Command _temp | Select -ExpandProperty parameters).Keys + <span class="hljs-variable"><span class="hljs-variable">$PSBoundParameters</span></span>.Keys + <span class="hljs-variable"><span class="hljs-variable">$StandardUserEnv</span></span>.Variables ) Write-Verbose <span class="hljs-string"><span class="hljs-string">"Excluding variables </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$( ($VariablesToExclude | sort )</span></span></span><span class="hljs-string"> -join "</span></span>, <span class="hljs-string"><span class="hljs-string">")"</span></span> <span class="hljs-variable"><span class="hljs-variable">$UserVariables</span></span> = @( Get-Variable | Where { -not (<span class="hljs-variable"><span class="hljs-variable">$VariablesToExclude</span></span> -contains <span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Name) } ) Write-Verbose <span class="hljs-string"><span class="hljs-string">"Found variables to import: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$( ($UserVariables | Select -expandproperty Name | Sort )</span></span></span><span class="hljs-string"> -join "</span></span>, <span class="hljs-string"><span class="hljs-string">" | Out-String).`n"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$ImportModules</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$UserModules</span></span> = @( Get-Module | Where {<span class="hljs-variable"><span class="hljs-variable">$StandardUserEnv</span></span>.Modules -notcontains <span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Name -and (Test-Path <span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Path -ErrorAction SilentlyContinue)} | Select -ExpandProperty Path ) <span class="hljs-variable"><span class="hljs-variable">$UserSnapins</span></span> = @( Get-PSSnapin | Select -ExpandProperty Name | Where {<span class="hljs-variable"><span class="hljs-variable">$StandardUserEnv</span></span>.Snapins -notcontains <span class="hljs-variable"><span class="hljs-variable">$_</span></span> } ) } } Function Get-RunspaceData { [cmdletbinding()] param( [switch]<span class="hljs-variable"><span class="hljs-variable">$Wait</span></span> ) Do { <span class="hljs-variable"><span class="hljs-variable">$more</span></span> = <span class="hljs-variable"><span class="hljs-variable">$false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (-not <span class="hljs-variable"><span class="hljs-variable">$Quiet</span></span>) { Write-Progress -Activity <span class="hljs-string"><span class="hljs-string">"Running Query"</span></span> -Status <span class="hljs-string"><span class="hljs-string">"Starting threads"</span></span>` -CurrentOperation <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$startedCount</span></span></span><span class="hljs-string"> threads defined - </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$totalCount</span></span></span><span class="hljs-string"> input objects - </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$script</span></span></span><span class="hljs-string">:completedCount input objects processed"</span></span>` -PercentComplete $( Try { <span class="hljs-variable"><span class="hljs-variable">$script</span></span>:completedCount / <span class="hljs-variable"><span class="hljs-variable">$totalCount</span></span> * 100 } Catch {0} ) } Foreach(<span class="hljs-variable"><span class="hljs-variable">$runspace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$runspaces</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$currentdate</span></span> = Get-Date <span class="hljs-variable"><span class="hljs-variable">$runtime</span></span> = <span class="hljs-variable"><span class="hljs-variable">$currentdate</span></span> - <span class="hljs-variable"><span class="hljs-variable">$runspace</span></span>.startTime <span class="hljs-variable"><span class="hljs-variable">$runMin</span></span> = [math]::Round( <span class="hljs-variable"><span class="hljs-variable">$runtime</span></span>.totalminutes ,2 ) <span class="hljs-variable"><span class="hljs-variable">$log</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span> | select Date, Action, Runtime, Status, Details <span class="hljs-variable"><span class="hljs-variable">$log</span></span>.Action = <span class="hljs-string"><span class="hljs-string">"Removing:'</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$($runspace.object)</span></span></span><span class="hljs-string">'"</span></span> <span class="hljs-variable"><span class="hljs-variable">$log</span></span>.Date = <span class="hljs-variable"><span class="hljs-variable">$currentdate</span></span> <span class="hljs-variable"><span class="hljs-variable">$log</span></span>.Runtime = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$runMin</span></span></span><span class="hljs-string"> minutes"</span></span> If (<span class="hljs-variable"><span class="hljs-variable">$runspace</span></span>.Runspace.isCompleted) { <span class="hljs-variable"><span class="hljs-variable">$script</span></span>:completedCount++ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-variable"><span class="hljs-variable">$runspace</span></span>.powershell.Streams.Error.Count -gt 0) { <span class="hljs-variable"><span class="hljs-variable">$log</span></span>.status = <span class="hljs-string"><span class="hljs-string">"CompletedWithErrors"</span></span> Write-Verbose (<span class="hljs-variable"><span class="hljs-variable">$log</span></span> | ConvertTo-Csv -Delimiter <span class="hljs-string"><span class="hljs-string">";"</span></span> -NoTypeInformation)[1] foreach(<span class="hljs-variable"><span class="hljs-variable">$ErrorRecord</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$runspace</span></span>.powershell.Streams.Error) { Write-Error -ErrorRecord <span class="hljs-variable"><span class="hljs-variable">$ErrorRecord</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-variable"><span class="hljs-variable">$log</span></span>.status = <span class="hljs-string"><span class="hljs-string">"Completed"</span></span> Write-Verbose (<span class="hljs-variable"><span class="hljs-variable">$log</span></span> | ConvertTo-Csv -Delimiter <span class="hljs-string"><span class="hljs-string">";"</span></span> -NoTypeInformation)[1] } <span class="hljs-variable"><span class="hljs-variable">$runspace</span></span>.powershell.EndInvoke(<span class="hljs-variable"><span class="hljs-variable">$runspace</span></span>.Runspace) <span class="hljs-variable"><span class="hljs-variable">$runspace</span></span>.powershell.dispose() <span class="hljs-variable"><span class="hljs-variable">$runspace</span></span>.Runspace = <span class="hljs-variable"><span class="hljs-variable">$null</span></span> <span class="hljs-variable"><span class="hljs-variable">$runspace</span></span>.powershell = <span class="hljs-variable"><span class="hljs-variable">$null</span></span> } ElseIf ( <span class="hljs-variable"><span class="hljs-variable">$runspaceTimeout</span></span> -ne 0 -and <span class="hljs-variable"><span class="hljs-variable">$runtime</span></span>.totalseconds -gt <span class="hljs-variable"><span class="hljs-variable">$runspaceTimeout</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$script</span></span>:completedCount++ <span class="hljs-variable"><span class="hljs-variable">$timedOutTasks</span></span> = <span class="hljs-variable"><span class="hljs-variable">$true</span></span> <span class="hljs-variable"><span class="hljs-variable">$log</span></span>.status = <span class="hljs-string"><span class="hljs-string">"TimedOut"</span></span> Write-Verbose (<span class="hljs-variable"><span class="hljs-variable">$log</span></span> | ConvertTo-Csv -Delimiter <span class="hljs-string"><span class="hljs-string">";"</span></span> -NoTypeInformation)[1] Write-Error <span class="hljs-string"><span class="hljs-string">"Runspace timed out at </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$($runtime.totalseconds)</span></span></span><span class="hljs-string"> seconds for the object:`n</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$($runspace.object | out-string)</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-variable"><span class="hljs-variable">$noCloseOnTimeout</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$runspace</span></span>.powershell.dispose() } <span class="hljs-variable"><span class="hljs-variable">$runspace</span></span>.Runspace = <span class="hljs-variable"><span class="hljs-variable">$null</span></span> <span class="hljs-variable"><span class="hljs-variable">$runspace</span></span>.powershell = <span class="hljs-variable"><span class="hljs-variable">$null</span></span> <span class="hljs-variable"><span class="hljs-variable">$completedCount</span></span>++ } ElseIf (<span class="hljs-variable"><span class="hljs-variable">$runspace</span></span>.Runspace -ne <span class="hljs-variable"><span class="hljs-variable">$null</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$log</span></span> = <span class="hljs-variable"><span class="hljs-variable">$null</span></span> <span class="hljs-variable"><span class="hljs-variable">$more</span></span> = <span class="hljs-variable"><span class="hljs-variable">$true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-variable"><span class="hljs-variable">$logFile</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$log</span></span>){ (<span class="hljs-variable"><span class="hljs-variable">$log</span></span> | ConvertTo-Csv -Delimiter <span class="hljs-string"><span class="hljs-string">";"</span></span> -NoTypeInformation)[1] | out-file <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> -append } } <span class="hljs-variable"><span class="hljs-variable">$temphash</span></span> = <span class="hljs-variable"><span class="hljs-variable">$runspaces</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">clone</span></span>() <span class="hljs-variable"><span class="hljs-variable">$temphash</span></span> | Where { <span class="hljs-variable"><span class="hljs-variable">$_</span></span>.runspace -eq <span class="hljs-variable"><span class="hljs-variable">$Null</span></span> } | ForEach { <span class="hljs-variable"><span class="hljs-variable">$Runspaces</span></span>.remove(<span class="hljs-variable"><span class="hljs-variable">$_</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-variable"><span class="hljs-variable">$PSBoundParameters</span></span>[<span class="hljs-string"><span class="hljs-string">'Wait'</span></span>]){ Start-Sleep -milliseconds <span class="hljs-variable"><span class="hljs-variable">$SleepTimer</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-variable"><span class="hljs-variable">$more</span></span> -and <span class="hljs-variable"><span class="hljs-variable">$PSBoundParameters</span></span>[<span class="hljs-string"><span class="hljs-string">'Wait'</span></span>]) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-variable"><span class="hljs-variable">$PSCmdlet</span></span>.ParameterSetName -eq <span class="hljs-string"><span class="hljs-string">'ScriptFile'</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$ScriptBlock</span></span> = [scriptblock]::Create( $(Get-Content <span class="hljs-variable"><span class="hljs-variable">$ScriptFile</span></span> | out-string) ) } elseif(<span class="hljs-variable"><span class="hljs-variable">$PSCmdlet</span></span>.ParameterSetName -eq <span class="hljs-string"><span class="hljs-string">'ScriptBlock'</span></span>) { [string[]]<span class="hljs-variable"><span class="hljs-variable">$ParamsToAdd</span></span> = <span class="hljs-string"><span class="hljs-string">'$_'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-variable"><span class="hljs-variable">$PSBoundParameters</span></span>.ContainsKey(<span class="hljs-string"><span class="hljs-string">'Parameter'</span></span>) ) { <span class="hljs-variable"><span class="hljs-variable">$ParamsToAdd</span></span> += <span class="hljs-string"><span class="hljs-string">'$Parameter'</span></span> } <span class="hljs-variable"><span class="hljs-variable">$UsingVariableData</span></span> = <span class="hljs-variable"><span class="hljs-variable">$Null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-variable"><span class="hljs-variable">$PSVersionTable</span></span>.PSVersion.Major -gt 2) { <span class="hljs-variable"><span class="hljs-variable">$UsingVariables</span></span> = <span class="hljs-variable"><span class="hljs-variable">$ScriptBlock</span></span>.ast.FindAll({<span class="hljs-variable"><span class="hljs-variable">$args</span></span>[0] -is [System.Management.Automation.Language.UsingExpressionAst]},<span class="hljs-variable"><span class="hljs-variable">$True</span></span>) If (<span class="hljs-variable"><span class="hljs-variable">$UsingVariables</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$List</span></span> = New-Object <span class="hljs-string"><span class="hljs-string">'System.Collections.Generic.List`1[System.Management.Automation.Language.VariableExpressionAst]'</span></span> ForEach (<span class="hljs-variable"><span class="hljs-variable">$Ast</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$UsingVariables</span></span>) { [void]<span class="hljs-variable"><span class="hljs-variable">$list</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$Ast</span></span>.SubExpression) } <span class="hljs-variable"><span class="hljs-variable">$UsingVar</span></span> = <span class="hljs-variable"><span class="hljs-variable">$UsingVariables</span></span> | Group SubExpression | ForEach {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Group | Select -First 1} <span class="hljs-variable"><span class="hljs-variable">$UsingVariableData</span></span> = ForEach (<span class="hljs-variable"><span class="hljs-variable">$Var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$UsingVar</span></span>) { Try { <span class="hljs-variable"><span class="hljs-variable">$Value</span></span> = Get-Variable -Name <span class="hljs-variable"><span class="hljs-variable">$Var</span></span>.SubExpression.VariablePath.UserPath -ErrorAction Stop [pscustomobject]@{ Name = <span class="hljs-variable"><span class="hljs-variable">$Var</span></span>.SubExpression.Extent.Text Value = <span class="hljs-variable"><span class="hljs-variable">$Value</span></span>.Value NewName = (<span class="hljs-string"><span class="hljs-string">'$__using_{0}'</span></span> -f <span class="hljs-variable"><span class="hljs-variable">$Var</span></span>.SubExpression.VariablePath.UserPath) NewVarName = (<span class="hljs-string"><span class="hljs-string">'__using_{0}'</span></span> -f <span class="hljs-variable"><span class="hljs-variable">$Var</span></span>.SubExpression.VariablePath.UserPath) } } Catch { Write-Error <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$($Var.SubExpression.Extent.Text)</span></span></span><span class="hljs-string"> is not a valid Using: variable!"</span></span> } } <span class="hljs-variable"><span class="hljs-variable">$ParamsToAdd</span></span> += <span class="hljs-variable"><span class="hljs-variable">$UsingVariableData</span></span> | Select -ExpandProperty NewName -Unique <span class="hljs-variable"><span class="hljs-variable">$NewParams</span></span> = <span class="hljs-variable"><span class="hljs-variable">$UsingVariableData</span></span>.NewName -join <span class="hljs-string"><span class="hljs-string">', '</span></span> <span class="hljs-variable"><span class="hljs-variable">$Tuple</span></span> = [Tuple]::Create(<span class="hljs-variable"><span class="hljs-variable">$list</span></span>, <span class="hljs-variable"><span class="hljs-variable">$NewParams</span></span>) <span class="hljs-variable"><span class="hljs-variable">$bindingFlags</span></span> = [Reflection.BindingFlags]<span class="hljs-string"><span class="hljs-string">"Default,NonPublic,Instance"</span></span> <span class="hljs-variable"><span class="hljs-variable">$GetWithInputHandlingForInvokeCommandImpl</span></span> = (<span class="hljs-variable"><span class="hljs-variable">$ScriptBlock</span></span>.ast.gettype().GetMethod(<span class="hljs-string"><span class="hljs-string">'GetWithInputHandlingForInvokeCommandImpl'</span></span>,<span class="hljs-variable"><span class="hljs-variable">$bindingFlags</span></span>)) <span class="hljs-variable"><span class="hljs-variable">$StringScriptBlock</span></span> = <span class="hljs-variable"><span class="hljs-variable">$GetWithInputHandlingForInvokeCommandImpl</span></span>.Invoke(<span class="hljs-variable"><span class="hljs-variable">$ScriptBlock</span></span>.ast,@(<span class="hljs-variable"><span class="hljs-variable">$Tuple</span></span>)) <span class="hljs-variable"><span class="hljs-variable">$ScriptBlock</span></span> = [scriptblock]::Create(<span class="hljs-variable"><span class="hljs-variable">$StringScriptBlock</span></span>) Write-Verbose <span class="hljs-variable"><span class="hljs-variable">$StringScriptBlock</span></span> } } <span class="hljs-variable"><span class="hljs-variable">$ScriptBlock</span></span> = <span class="hljs-variable"><span class="hljs-variable">$ExecutionContext</span></span>.InvokeCommand.NewScriptBlock(<span class="hljs-string"><span class="hljs-string">"param(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$($ParamsToAdd -Join ", ")</span></span></span><span class="hljs-string">)`r`n"</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Scriptblock</span></span>.ToString()) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Throw <span class="hljs-string"><span class="hljs-string">"Must provide ScriptBlock or ScriptFile"</span></span>; Break } Write-Debug <span class="hljs-string"><span class="hljs-string">"`</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ScriptBlock</span></span></span><span class="hljs-string">: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$($ScriptBlock | Out-String)</span></span></span><span class="hljs-string">"</span></span> Write-Verbose <span class="hljs-string"><span class="hljs-string">"Creating runspace pool and session states"</span></span> <span class="hljs-variable"><span class="hljs-variable">$sessionstate</span></span> = [System.Management.Automation.Runspaces.InitialSessionState]::CreateDefault() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$ImportVariables</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-variable"><span class="hljs-variable">$UserVariables</span></span>.count -gt 0) { foreach(<span class="hljs-variable"><span class="hljs-variable">$Variable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$UserVariables</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$sessionstate</span></span>.Variables.Add( (New-Object -TypeName System.Management.Automation.Runspaces.SessionStateVariableEntry -ArgumentList <span class="hljs-variable"><span class="hljs-variable">$Variable</span></span>.Name, <span class="hljs-variable"><span class="hljs-variable">$Variable</span></span>.Value, <span class="hljs-variable"><span class="hljs-variable">$null</span></span>) ) } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$ImportModules</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-variable"><span class="hljs-variable">$UserModules</span></span>.count -gt 0) { foreach(<span class="hljs-variable"><span class="hljs-variable">$ModulePath</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$UserModules</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$sessionstate</span></span>.ImportPSModule(<span class="hljs-variable"><span class="hljs-variable">$ModulePath</span></span>) } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-variable"><span class="hljs-variable">$UserSnapins</span></span>.count -gt 0) { foreach(<span class="hljs-variable"><span class="hljs-variable">$PSSnapin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$UserSnapins</span></span>) { [void]<span class="hljs-variable"><span class="hljs-variable">$sessionstate</span></span>.ImportPSSnapIn(<span class="hljs-variable"><span class="hljs-variable">$PSSnapin</span></span>, [ref]<span class="hljs-variable"><span class="hljs-variable">$null</span></span>) } } } <span class="hljs-variable"><span class="hljs-variable">$runspacepool</span></span> = [runspacefactory]::CreateRunspacePool(1, <span class="hljs-variable"><span class="hljs-variable">$Throttle</span></span>, <span class="hljs-variable"><span class="hljs-variable">$sessionstate</span></span>, <span class="hljs-variable"><span class="hljs-variable">$Host</span></span>) <span class="hljs-variable"><span class="hljs-variable">$runspacepool</span></span>.Open() Write-Verbose <span class="hljs-string"><span class="hljs-string">"Creating empty collection to hold runspace jobs"</span></span> <span class="hljs-variable"><span class="hljs-variable">$Script</span></span>:runspaces = New-Object System.Collections.ArrayList <span class="hljs-variable"><span class="hljs-variable">$bound</span></span> = <span class="hljs-variable"><span class="hljs-variable">$PSBoundParameters</span></span>.keys -contains <span class="hljs-string"><span class="hljs-string">"InputObject"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(-not <span class="hljs-variable"><span class="hljs-variable">$bound</span></span>) { [System.Collections.ArrayList]<span class="hljs-variable"><span class="hljs-variable">$allObjects</span></span> = @() } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> ){ New-Item -ItemType file -path <span class="hljs-variable"><span class="hljs-variable">$logFile</span></span> -force | Out-Null (<span class="hljs-string"><span class="hljs-string">""</span></span> | Select Date, Action, Runtime, Status, Details | ConvertTo-Csv -NoTypeInformation -Delimiter <span class="hljs-string"><span class="hljs-string">";"</span></span>)[0] | Out-File <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> } <span class="hljs-variable"><span class="hljs-variable">$log</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span> | Select Date, Action, Runtime, Status, Details <span class="hljs-variable"><span class="hljs-variable">$log</span></span>.Date = Get-Date <span class="hljs-variable"><span class="hljs-variable">$log</span></span>.Action = <span class="hljs-string"><span class="hljs-string">"Batch processing started"</span></span> <span class="hljs-variable"><span class="hljs-variable">$log</span></span>.Runtime = <span class="hljs-variable"><span class="hljs-variable">$null</span></span> <span class="hljs-variable"><span class="hljs-variable">$log</span></span>.Status = <span class="hljs-string"><span class="hljs-string">"Started"</span></span> <span class="hljs-variable"><span class="hljs-variable">$log</span></span>.Details = <span class="hljs-variable"><span class="hljs-variable">$null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-variable"><span class="hljs-variable">$logFile</span></span>) { (<span class="hljs-variable"><span class="hljs-variable">$log</span></span> | convertto-csv -Delimiter <span class="hljs-string"><span class="hljs-string">";"</span></span> -NoTypeInformation)[1] | Out-File <span class="hljs-variable"><span class="hljs-variable">$LogFile</span></span> -Append } <span class="hljs-variable"><span class="hljs-variable">$timedOutTasks</span></span> = <span class="hljs-variable"><span class="hljs-variable">$false</span></span> } Process { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-variable"><span class="hljs-variable">$bound</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$allObjects</span></span> = <span class="hljs-variable"><span class="hljs-variable">$InputObject</span></span> } Else { [void]<span class="hljs-variable"><span class="hljs-variable">$allObjects</span></span>.add( <span class="hljs-variable"><span class="hljs-variable">$InputObject</span></span> ) } } End { Try { <span class="hljs-variable"><span class="hljs-variable">$totalCount</span></span> = <span class="hljs-variable"><span class="hljs-variable">$allObjects</span></span>.count <span class="hljs-variable"><span class="hljs-variable">$script</span></span>:completedCount = 0 <span class="hljs-variable"><span class="hljs-variable">$startedCount</span></span> = 0 foreach(<span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$allObjects</span></span>){ <span class="hljs-variable"><span class="hljs-variable">$powershell</span></span> = [powershell]::Create() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$VerbosePreference</span></span> -eq <span class="hljs-string"><span class="hljs-string">'Continue'</span></span>) { [void]<span class="hljs-variable"><span class="hljs-variable">$PowerShell</span></span>.AddScript({<span class="hljs-variable"><span class="hljs-variable">$VerbosePreference</span></span> = <span class="hljs-string"><span class="hljs-string">'Continue'</span></span>}) } [void]<span class="hljs-variable"><span class="hljs-variable">$PowerShell</span></span>.AddScript(<span class="hljs-variable"><span class="hljs-variable">$ScriptBlock</span></span>).AddArgument(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$parameter</span></span>) { [void]<span class="hljs-variable"><span class="hljs-variable">$PowerShell</span></span>.AddArgument(<span class="hljs-variable"><span class="hljs-variable">$parameter</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$UsingVariableData</span></span>) { Foreach(<span class="hljs-variable"><span class="hljs-variable">$UsingVariable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$UsingVariableData</span></span>) { Write-Verbose <span class="hljs-string"><span class="hljs-string">"Adding </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$($UsingVariable.Name)</span></span></span><span class="hljs-string"> with value: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$($UsingVariable.Value)</span></span></span><span class="hljs-string">"</span></span> [void]<span class="hljs-variable"><span class="hljs-variable">$PowerShell</span></span>.AddArgument(<span class="hljs-variable"><span class="hljs-variable">$UsingVariable</span></span>.Value) } } <span class="hljs-variable"><span class="hljs-variable">$powershell</span></span>.RunspacePool = <span class="hljs-variable"><span class="hljs-variable">$runspacepool</span></span> <span class="hljs-variable"><span class="hljs-variable">$temp</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span> | Select-Object PowerShell, StartTime, object, Runspace <span class="hljs-variable"><span class="hljs-variable">$temp</span></span>.PowerShell = <span class="hljs-variable"><span class="hljs-variable">$powershell</span></span> <span class="hljs-variable"><span class="hljs-variable">$temp</span></span>.StartTime = Get-Date <span class="hljs-variable"><span class="hljs-variable">$temp</span></span>.object = <span class="hljs-variable"><span class="hljs-variable">$object</span></span> <span class="hljs-variable"><span class="hljs-variable">$temp</span></span>.Runspace = <span class="hljs-variable"><span class="hljs-variable">$powershell</span></span>.BeginInvoke() <span class="hljs-variable"><span class="hljs-variable">$startedCount</span></span>++ Write-Verbose ( <span class="hljs-string"><span class="hljs-string">"Adding {0} to collection at {1}"</span></span> -f <span class="hljs-variable"><span class="hljs-variable">$temp</span></span>.object, <span class="hljs-variable"><span class="hljs-variable">$temp</span></span>.starttime.tostring() ) <span class="hljs-variable"><span class="hljs-variable">$runspaces</span></span>.Add(<span class="hljs-variable"><span class="hljs-variable">$temp</span></span>) | Out-Null Get-RunspaceData <span class="hljs-variable"><span class="hljs-variable">$firstRun</span></span> = <span class="hljs-variable"><span class="hljs-variable">$true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-variable"><span class="hljs-variable">$runspaces</span></span>.count -ge <span class="hljs-variable"><span class="hljs-variable">$Script</span></span>:MaxQueue) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-variable"><span class="hljs-variable">$firstRun</span></span>){ Write-Verbose <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$($runspaces.count)</span></span></span><span class="hljs-string"> items running - exceeded </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Script</span></span></span><span class="hljs-string">:MaxQueue limit."</span></span> } <span class="hljs-variable"><span class="hljs-variable">$firstRun</span></span> = <span class="hljs-variable"><span class="hljs-variable">$false</span></span> Get-RunspaceData Start-Sleep -Milliseconds <span class="hljs-variable"><span class="hljs-variable">$sleepTimer</span></span> } } Write-Verbose ( <span class="hljs-string"><span class="hljs-string">"Finish processing the remaining runspace jobs: {0}"</span></span> -f ( @(<span class="hljs-variable"><span class="hljs-variable">$runspaces</span></span> | Where {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Runspace -ne <span class="hljs-variable"><span class="hljs-variable">$Null</span></span>}).Count) ) Get-RunspaceData -<span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (-not <span class="hljs-variable"><span class="hljs-variable">$quiet</span></span>) { Write-Progress -Activity <span class="hljs-string"><span class="hljs-string">"Running Query"</span></span> -Status <span class="hljs-string"><span class="hljs-string">"Starting threads"</span></span> -Completed } } Finally { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( (<span class="hljs-variable"><span class="hljs-variable">$timedOutTasks</span></span> -eq <span class="hljs-variable"><span class="hljs-variable">$false</span></span>) -or ( (<span class="hljs-variable"><span class="hljs-variable">$timedOutTasks</span></span> -eq <span class="hljs-variable"><span class="hljs-variable">$true</span></span>) -and (<span class="hljs-variable"><span class="hljs-variable">$noCloseOnTimeout</span></span> -eq <span class="hljs-variable"><span class="hljs-variable">$false</span></span>) ) ) { Write-Verbose <span class="hljs-string"><span class="hljs-string">"Closing the runspace pool"</span></span> <span class="hljs-variable"><span class="hljs-variable">$runspacepool</span></span>.close() } [gc]::Collect() } } }</code> </pre><br></div></div><br>  The following script must be saved as a <i>Start-AuditFiles.psm1 file</i> . <br><br><div class="spoiler">  <b class="spoiler_title">Script Start-AuditFiles.psm1</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$Body</span></span> = <span class="hljs-string"><span class="hljs-string">",              .     ,            .     : 1)         2)         . Function Start-AuditFiles { &lt;# .Synopsis     ,        .Description            (C$ D$ ..  .).   : 1.      OU      2.    3.     4.      ,   5.    6.   ,    ,    7.    ,       .Examples  1 Start-AuditFiles -OU "</span></span>OU=Test,DC=root,DC=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span><span class="hljs-string"><span class="hljs-string">" -SMTP smtp.server.com -AdminMail administrator@server.com -IncludeFile *.doc,*.docx,*.sys -ExclusionFile *File1*,*File2* -ExclusionFolder *Folder1*,*Folder2* -ReportPath \\server\reports\         OU,     (*.doc,*.docx,*.sys)   (*File1*,*File2*),   (*Folder1*,*Folder2*),     (\\server\reports\)  2 Start-AuditFiles -RemoteComputer ws-pc-4902,ws-pc-0982 -SMTP smtp.server.com -AdminMail administrator@server.com -Include *.doc,*.docx,*.sys -ExclusionFile *New*,*au* -AdminOnly        (ws-pc-4902,ws-pc-098),     (*.doc,*.docx,*.sys)   (*File1*,*File2*),     .Notes       OU  RemoteComputer, OU   , RemoteComputer          .Link ... #&gt; [CmdletBinding()] Param ( [String]</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$OU</span></span></span><span class="hljs-string">, [String[]]</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RemoteComputer</span></span></span><span class="hljs-string">, [String[]]</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ExclusionFile</span></span></span><span class="hljs-string">, [String]</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ReportPath</span></span></span><span class="hljs-string">, [String]</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$AdminMail</span></span></span><span class="hljs-string">, [String[]]</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$IncludeFile</span></span></span><span class="hljs-string">, [String[]]</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ExclusionFolder</span></span></span><span class="hljs-string">, [Switch]</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$AdminOnly</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$false</span></span></span><span class="hljs-string">, [String]</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SMTP</span></span></span><span class="hljs-string">, [String]</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Throttle</span></span></span><span class="hljs-string"> = 5 ) If (!</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RemoteComputer</span></span></span><span class="hljs-string">) {</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Hosts</span></span></span><span class="hljs-string"> = (Get-ADComputer -Filter * -SearchBase </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$OU</span></span></span><span class="hljs-string"> -Properties * | where { ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PSItem</span></span></span><span class="hljs-string">.HomePage -notlike 'pass' )} ).name} else { </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Hosts</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RemoteComputer</span></span></span><span class="hljs-string"> } invoke-parallel -InputObject </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Hosts</span></span></span><span class="hljs-string"> -throttle </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Throttle</span></span></span><span class="hljs-string"> -ImportVariables -ScriptBlock { if(Test-Connection -ComputerName </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_</span></span></span><span class="hljs-string"> -BufferSize 16 -quiet -count 2) { </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Object</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ErrorActionPreference</span></span></span><span class="hljs-string"> = 'SilentlyContinue' </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ExclusionFolder2</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ExclusionFolder</span></span></span><span class="hljs-string"> -replace "</span></span>,<span class="hljs-string"><span class="hljs-string">","</span></span>|<span class="hljs-string"><span class="hljs-string">" </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$StartTime</span></span></span><span class="hljs-string"> = (Get-Date).ToString() </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Hosts</span></span></span><span class="hljs-string"> (Get-WMIObject Win32_LogicalDisk -filter "</span></span>DriveType = 3<span class="hljs-string"><span class="hljs-string">" -ComputerName </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Object</span></span></span><span class="hljs-string"> | %{Get-ChildItem ('\\' + </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Object</span></span></span><span class="hljs-string"> + '\' + (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$_</span></span></span><span class="hljs-string">.DeviceID).remove(1) + '$\*') -Include </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$IncludeFile</span></span></span><span class="hljs-string"> -Exclude </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ExclusionFile</span></span></span><span class="hljs-string"> -Recurse -Force | ?{</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PSItem</span></span></span><span class="hljs-string">.FullName -notmatch </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ExclusionFolder2</span></span></span><span class="hljs-string">}}).FullName | Out-File -FilePath </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$env</span></span></span><span class="hljs-string">:TEMP\$Object.txt -Encoding unicode If (!</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ReportPath</span></span></span><span class="hljs-string">) {} else {Copy-Item -Path </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$env</span></span></span><span class="hljs-string">:TEMP\$Object.txt -Destination </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ReportPath</span></span></span><span class="hljs-string"> -Force} </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$EndTime</span></span></span><span class="hljs-string"> = (Get-Date).ToString() Write-Output (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Object</span></span></span><span class="hljs-string">) | Add-Content </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$env</span></span></span><span class="hljs-string">:TEMP\Online.txt Invoke-Item </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$env</span></span></span><span class="hljs-string">:TEMP\$Object.txt </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Results</span></span></span><span class="hljs-string"> = "</span></span><span class="hljs-string"><span class="hljs-string">" | Select ComputerName, "</span></span>StartTime<span class="hljs-string"><span class="hljs-string">", "</span></span>EndTime<span class="hljs-string"><span class="hljs-string">" </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Results</span></span></span><span class="hljs-string">.ComputerName = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Object</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Results</span></span></span><span class="hljs-string">.StartTime = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$StartTime</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Results</span></span></span><span class="hljs-string">.EndTime =</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$EndTime</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Results</span></span></span><span class="hljs-string"> If ((Get-Content </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$env</span></span></span><span class="hljs-string">:TEMP\$Object.txt) -eq </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Null</span></span></span><span class="hljs-string">) {} else { Try { Send-MailMessage -SmtpServer </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SMTP</span></span></span><span class="hljs-string"> -to </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$AdminMail</span></span></span><span class="hljs-string"> -Body </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Object</span></span></span><span class="hljs-string"> -From denis.pasternak@hotmail.com -Subject </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Object</span></span></span><span class="hljs-string"> -Attachments </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$env</span></span></span><span class="hljs-string">:TEMP\$Object.txt } Catch {''} If (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$AdminOnly</span></span></span><span class="hljs-string"> -eq </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$True</span></span></span><span class="hljs-string">) { Write-Host "</span></span>  AdminOnly -    <span class="hljs-string"><span class="hljs-string">" -ForegroundColor Yellow} else { </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Username</span></span></span><span class="hljs-string">=((gwmi win32_computersystem -computer </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Object</span></span></span><span class="hljs-string"> -ErrorAction SilentlyContinue).UserName -split '\\')[1] if(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$username</span></span></span><span class="hljs-string"> -ne </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$null</span></span></span><span class="hljs-string">) { </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Body</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Body</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$dispalyname</span></span></span><span class="hljs-string"> = (Get-AdUser </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$username</span></span></span><span class="hljs-string"> -properties DisplayName).DisplayName </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$email</span></span></span><span class="hljs-string"> = (Get-AdUser </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$username</span></span></span><span class="hljs-string"> -properties mail).mail sleep -Seconds 3 Send-MailMessage -SmtpServer </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SMTP</span></span></span><span class="hljs-string"> -Body ( ' ' + </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Dispalyname</span></span></span><span class="hljs-string"> + ' ' + </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Body</span></span></span><span class="hljs-string"> | out-string ) -To </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$email</span></span></span><span class="hljs-string"> -From </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$AdminMail</span></span></span><span class="hljs-string"> -Subject </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Object</span></span></span><span class="hljs-string"> -Attachments </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$env</span></span></span><span class="hljs-string">:TEMP\$Object.txt -Encoding Unicode } } } else{ } } else { (Write-Output (</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Object</span></span></span><span class="hljs-string"> + ' ' + (Get-Date).ToString()) | Add-Content </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$env</span></span></span><span class="hljs-string">:TEMP\Offline.txt)} } </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$OU</span></span></span><span class="hljs-string">= </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$null</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RemoteComputer</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$null</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$Hosts</span></span></span><span class="hljs-string"> = </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$nul</span></span></span><span class="hljs-string"> Get-Content </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$env</span></span></span><span class="hljs-string">:TEMP\Online.txt | Set-ADComputer -HomePage 'pass' } Function Remove-AuditFiles { [CmdletBinding(SupportsShouldProcess=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$True</span></span></span><span class="hljs-string">)] Param ( [String]</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TargetFile</span></span></span><span class="hljs-string"> ) Get-Content -Path "</span></span><span class="hljs-variable"><span class="hljs-variable">$env</span></span>:TEMP\<span class="hljs-variable"><span class="hljs-variable">$Path</span></span><span class="hljs-string"><span class="hljs-string">" | %{Remove-Item </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PSItem</span></span></span><span class="hljs-string">} } Function Reset-AuditComputers { [CmdletBinding(SupportsShouldProcess=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$True</span></span></span><span class="hljs-string">)] Param ( [String]</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TargetOU</span></span></span><span class="hljs-string"> ) Get-ADComputer -Filter * -SearchBase </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TargetOU</span></span></span><span class="hljs-string"> -Properties * | Set-ADComputer -HomePage 'notpass' '' | Set-Content -Path </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$env</span></span></span><span class="hljs-string">:TEMP\Online.txt }</span></span></code> </pre><br></div></div><br><h2>  Scheduled Run </h2><br>  Create a file in the example directory c: \ scripts. <br><br>  RunScript.ps1 file <br><br>  Copy the text: <br><br><pre> <code class="bash hljs">Import-Module C:\Windows\system32\WindowsPowerShell\v1.0\Modules\Invoke-Parallel.psm1 Import-Module C:\Windows\system32\WindowsPowerShell\v1.0\Modules\Start-AuditFiles.psm1 <span class="hljs-comment"><span class="hljs-comment">#   ,       Start-AuditFiles -OU "OU=Test,DC=root,DC=local" -SMTP smtp.server.com -AdminMail administrator@server.com -IncludeFile *.doc,*.docx,*.sys -ExclusionFile *File1*,*File2* -ExclusionFolder *Folder1*,*Folder2* -ReportPath \\server\reports\ - Throttle 5</span></span></code> </pre><br><h4>  Creating a file search schedule </h4><br><ul><li>  in computer management, go to the "Task Scheduler" section.  Create a task, enter the desired task name </li><li>  specify the frequency ‚ÄúDaily‚Äù </li><li>  set the period "every day" </li><li>  leave the option "Run the program" </li><li>  program path - C: \ Windows \ System32 \ WindowsPowerShell \ v1.0 \ powershell.exe Startup Argument - C: \ Scripts \ RunScript.ps1 </li><li>  after creation, open the task property, go to the "Triggers" tab </li><li>  set the option ‚ÄúRepeat task every‚Äù, specifying the desired frequency of repetition </li><li>  set the options ‚ÄúRun for all users‚Äù and ‚ÄúRun with the highest priority‚Äù.  Specify a user who has the right to read all files on remote computers.  Typically, these are users who are members of the administrators group on remote computers. </li></ul><br><h2>  Information on results and work files </h2><br>  The script stores the scan results in the% TEMP% directory.  In the example, this directory is: C: \ Users \ Administrator \ AppData \ Local \ Temp.  If the computer is available and the file is found, a file is created with the result.  If the computer is not available - information about this is added to the offline.txt file. <br><br><img src="https://habrastorage.org/files/2da/d9c/ca6/2dad9cca651e4a8b8c35e760ea1a1992.jpg"><br><br><h2>  Delete found files </h2><br>  Run PowerShell run the command: <br><br><pre> <code class="bash hljs">Import-Module C:\Windows\system32\WindowsPowerShell\v1.0\Modules\Start-AuditFiles.psm1 Remove-AuditFiles  Remove-AuditFiles - TargetFile ws-9281.txt,ws-8721.txt</code> </pre><br>  <i>Remove-AuditFiles</i> - performs a search of all search results, processing each result will remove files. <br><br>  You can specify a specific file (specific computer). For example: <br><br>  Remove-AuditFiles - TargetFile ws-9281.txt, ws-8721.txt <br><br><h2>  Reset scanned computers list </h2><br>  Run PowerShell run the command: <br><br>  <b>Reset-auditcomputers</b> <br><br>  After execution, the computers in the specified OU will be marked as not scanned: <br><br><pre> <code class="bash hljs">Import-Module C:\Windows\system32\WindowsPowerShell\v1.0\Modules\Start-AuditFiles.psm1 Reset-AuditComputers - TargetOU OU <span class="hljs-string"><span class="hljs-string">"OU=Test,DC=root,DC=local"</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">Script description</b> <div class="spoiler_text">  The $ Body variable contains the text that will later be inserted into the body of the letter.  In the future, this text will be sent in a letter to the end user. <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$Body</span></span> = <span class="hljs-string"><span class="hljs-string">",              .     ,            .     : 1)         2)         .</span></span></code> </pre><br>  The beginning of the function, which is given the derived name Start-AuditFiles: <br><br><pre> <code class="bash hljs">Function Start-AuditFiles {</code> </pre><br>  Description of the script, the accompanying help text.  Allows you to use help, get information about examples and syntax using "Get-Help Start-AuditFiles": <br><br><pre> <code class="bash hljs">&lt;<span class="hljs-comment"><span class="hljs-comment"># .Synopsis     ,        .Description            (C$ D$ ..  .).   : 1.      OU      2.    3.     4.      ,   5.    6.   ,    ,    7.    ,       .Examples  1 Start-AuditFiles -OU "OU=Test,DC=root,DC=local" -SMTP smtp.server.com -AdminMail administrator@server.com -IncludeFile *.doc,*.docx,*.sys -ExclusionFile *File1*,*File2* -ExclusionFolder *Folder1*,*Folder2* -ReportPath \\server\reports\         OU,     (*.doc,*.docx,*.sys)   (*File1*,*File2*),   (*Folder1*,*Folder2*),     (\\server\reports\)  2 Start-AuditFiles -RemoteComputer ws-pc-4902,ws-pc-0982 -SMTP smtp.server.com -AdminMail administrator@server.com -Include *.doc,*.docx,*.sys -ExclusionFile *New*,*au* -AdminOnly        (ws-pc-4902,ws-pc-098),     (*.doc,*.docx,*.sys)   (*File1*,*File2*),     .Notes       OU  RemoteComputer, OU   , RemoteComputer          .Link ... #&gt;</span></span></code> </pre><br>  We describe the variables that will be used in the function below: <br><br>  $ OU - the path to the Organization Unit in Active Directory <br>  $ ExclusionFile - list of files excluded from the search <br>  $ ReportPath - path to the directory where reports will be duplicated <br>  $ AdminMail - email address of the administrator from which reports are sent and where the copy intended for the administrator will be sent <br>  $ IncludeFile - file extensions or file names that are searched <br>  $ ExclusionFolder - list of folders excluded from the search <br>  $ AdminOnly - the parameter corresponds to whether reports will be sent only to the administrator <br>  $ SMTP - the address or name of the SMTP server <br>  $ Throttle - the number of parallel threads. <br><br><pre> <code class="bash hljs">[CmdletBinding()] Param ( [String]<span class="hljs-variable"><span class="hljs-variable">$OU</span></span>, [String[]]<span class="hljs-variable"><span class="hljs-variable">$RemoteComputer</span></span>, [String[]]<span class="hljs-variable"><span class="hljs-variable">$ExclusionFile</span></span>, [String]<span class="hljs-variable"><span class="hljs-variable">$ReportPath</span></span>, [String]<span class="hljs-variable"><span class="hljs-variable">$AdminMail</span></span>, [String[]]<span class="hljs-variable"><span class="hljs-variable">$IncludeFile</span></span>, [String[]]<span class="hljs-variable"><span class="hljs-variable">$ExclusionFolder</span></span>, [Switch]<span class="hljs-variable"><span class="hljs-variable">$AdminOnly</span></span> = <span class="hljs-variable"><span class="hljs-variable">$false</span></span>, [String]<span class="hljs-variable"><span class="hljs-variable">$SMTP</span></span>, [String]<span class="hljs-variable"><span class="hljs-variable">$Throttle</span></span> = 5 )</code> </pre><br>  A check is performed if the ‚ÄúRemoteComputer‚Äù key was used, in this case, the scan will take place only on a specific (specified) computer, if the ‚ÄúOU‚Äù key is specified - in this case the list will be obtained from the defined OU AD, computers with the HomePage attribute will not be selected ‚ÄúPass‚Äù (this is done in order to exclude a second search on machines that have already been searched). <br><br><pre> <code class="bash hljs">If (!<span class="hljs-variable"><span class="hljs-variable">$RemoteComputer</span></span>) {<span class="hljs-variable"><span class="hljs-variable">$Hosts</span></span> = (Get-ADComputer -Filter * -SearchBase <span class="hljs-variable"><span class="hljs-variable">$OU</span></span> -Properties * | <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> { ( <span class="hljs-variable"><span class="hljs-variable">$PSItem</span></span>.HomePage -notlike <span class="hljs-string"><span class="hljs-string">'pass'</span></span> )} ).name} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-variable"><span class="hljs-variable">$Hosts</span></span> = <span class="hljs-variable"><span class="hljs-variable">$RemoteComputer</span></span> }</code> </pre><br>  The beginning of the script execution, the Host value and the number of threads are substituted: <br><br><pre> <code class="bash hljs">invoke-parallel -InputObject <span class="hljs-variable"><span class="hljs-variable">$Hosts</span></span> -throttle <span class="hljs-variable"><span class="hljs-variable">$Throttle</span></span> -ImportVariables -ScriptBlock {</code> </pre><br>  Check the availability of a computer on the network: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Test-Connection -ComputerName <span class="hljs-variable"><span class="hljs-variable">$_</span></span> -BufferSize 16 -quiet -count 2) {</code> </pre><br>  The values ‚Äã‚Äãof the variables required to perform the search are taken from the variables described above.  The beginning of the search is remembered. <br><br><pre> <code class="bash hljs"> <span class="hljs-variable"><span class="hljs-variable">$Object</span></span> = <span class="hljs-variable"><span class="hljs-variable">$_</span></span> <span class="hljs-variable"><span class="hljs-variable">$ErrorActionPreference</span></span> = <span class="hljs-string"><span class="hljs-string">'SilentlyContinue'</span></span> <span class="hljs-variable"><span class="hljs-variable">$ExclusionFolder2</span></span> = <span class="hljs-variable"><span class="hljs-variable">$ExclusionFolder</span></span> -replace <span class="hljs-string"><span class="hljs-string">","</span></span>,<span class="hljs-string"><span class="hljs-string">"|"</span></span> <span class="hljs-variable"><span class="hljs-variable">$StartTime</span></span> = (Get-Date).ToString() <span class="hljs-variable"><span class="hljs-variable">$Hosts</span></span></code> </pre><br>  Performing a search: <br><br><ul><li>  get a list of physical disks (Get-WMIObject Win32_LogicalDisk -filter "DriveType = 3" -ComputerName $ Object) </li><li>  UNC path is formed with a drive letter (Get-ChildItem ('\\' + $ Object + '\' + ($ _. DeviceID) .remove (1) + '$ \ *') </li><li>  specifies the search key for included objects and exclusions (-Include $ IncludeFile -Exclude $ ExclusionFile -Recurse -Force) </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exception for directories, remove unnecessary directories from the search results (? {$ PSItem.FullName -notmatch $ ExclusionFolder2}}). FullName) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">report is generated in the temporary directory (Out-File -FilePath $ env: TEMP </font></font><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Object.txt -Encoding unicode)</font></font></li></ul><br><pre> <code class="bash hljs">(Get-WMIObject Win32_LogicalDisk -filter <span class="hljs-string"><span class="hljs-string">"DriveType = 3"</span></span> -ComputerName <span class="hljs-variable"><span class="hljs-variable">$Object</span></span> | %{Get-ChildItem (<span class="hljs-string"><span class="hljs-string">'\\'</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Object</span></span> + <span class="hljs-string"><span class="hljs-string">'\'</span></span> + (<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.DeviceID).remove(1) + <span class="hljs-string"><span class="hljs-string">'$\*'</span></span>) -Include <span class="hljs-variable"><span class="hljs-variable">$IncludeFile</span></span> -Exclude <span class="hljs-variable"><span class="hljs-variable">$ExclusionFile</span></span> -Recurse -Force | ?{<span class="hljs-variable"><span class="hljs-variable">$PSItem</span></span>.FullName -notmatch <span class="hljs-variable"><span class="hljs-variable">$ExclusionFolder2</span></span>}}).FullName | Out-File -FilePath <span class="hljs-variable"><span class="hljs-variable">$env</span></span>:TEMP\<span class="hljs-variable"><span class="hljs-variable">$Object</span></span>.txt -Encoding unicode</code> </pre><br>     ,    ¬´ReportPath¬ª,     . <br><pre> <code class="bash hljs"> If (!<span class="hljs-variable"><span class="hljs-variable">$ReportPath</span></span>) {} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {Copy-Item -Path <span class="hljs-variable"><span class="hljs-variable">$env</span></span>:TEMP\<span class="hljs-variable"><span class="hljs-variable">$Object</span></span>.txt -Destination <span class="hljs-variable"><span class="hljs-variable">$ReportPath</span></span> -Force}</code> </pre><br>    . <br><br><pre> <code class="bash hljs"> <span class="hljs-variable"><span class="hljs-variable">$EndTime</span></span> = (Get-Date).ToString()</code> </pre><br>     ,    . <br><br><pre> <code class="bash hljs">Write-Output (<span class="hljs-variable"><span class="hljs-variable">$Object</span></span>) | Add-Content <span class="hljs-variable"><span class="hljs-variable">$env</span></span>:TEMP\Online.txt</code> </pre><br>       ,       ,     . <br><br><pre> <code class="bash hljs"> Invoke-Item <span class="hljs-variable"><span class="hljs-variable">$env</span></span>:TEMP\<span class="hljs-variable"><span class="hljs-variable">$Object</span></span>.txt <span class="hljs-variable"><span class="hljs-variable">$Results</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span> | Select ComputerName, <span class="hljs-string"><span class="hljs-string">"StartTime"</span></span>, <span class="hljs-string"><span class="hljs-string">"EndTime"</span></span> <span class="hljs-variable"><span class="hljs-variable">$Results</span></span>.ComputerName = <span class="hljs-variable"><span class="hljs-variable">$Object</span></span> <span class="hljs-variable"><span class="hljs-variable">$Results</span></span>.StartTime = <span class="hljs-variable"><span class="hljs-variable">$StartTime</span></span> <span class="hljs-variable"><span class="hljs-variable">$Results</span></span>.EndTime =<span class="hljs-variable"><span class="hljs-variable">$EndTime</span></span> <span class="hljs-variable"><span class="hljs-variable">$Results</span></span></code> </pre><br>   ,    ,   ( ),     .    . <br><br><pre> <code class="bash hljs">If ((Get-Content <span class="hljs-variable"><span class="hljs-variable">$env</span></span>:TEMP\<span class="hljs-variable"><span class="hljs-variable">$Object</span></span>.txt) -eq <span class="hljs-variable"><span class="hljs-variable">$Null</span></span>) {}</code> </pre><br>      ,      SMTP ,  ,  ,  . <br><br><pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Try { Send-MailMessage -SmtpServer <span class="hljs-variable"><span class="hljs-variable">$SMTP</span></span> -to <span class="hljs-variable"><span class="hljs-variable">$AdminMail</span></span> -Body <span class="hljs-variable"><span class="hljs-variable">$Object</span></span> -From denis.pasternak@hotmail.com -Subject <span class="hljs-variable"><span class="hljs-variable">$Object</span></span> -Attachments <span class="hljs-variable"><span class="hljs-variable">$env</span></span>:TEMP\<span class="hljs-variable"><span class="hljs-variable">$Object</span></span>.txt } Catch {<span class="hljs-string"><span class="hljs-string">''</span></span>}</code> </pre><br>     ,      ,     . <br><br><pre> <code class="bash hljs">If (<span class="hljs-variable"><span class="hljs-variable">$AdminOnly</span></span> -eq <span class="hljs-variable"><span class="hljs-variable">$True</span></span>) { Write-Host <span class="hljs-string"><span class="hljs-string">"  AdminOnly -    "</span></span> -ForegroundColor Yellow} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span></code> </pre><br>       . <br><br><pre> <code class="bash hljs">{ <span class="hljs-variable"><span class="hljs-variable">$Username</span></span>=((gwmi win32_computersystem -computer <span class="hljs-variable"><span class="hljs-variable">$Object</span></span> -ErrorAction SilentlyContinue).UserName -split <span class="hljs-string"><span class="hljs-string">'\\'</span></span>)[1] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-variable"><span class="hljs-variable">$username</span></span> -ne <span class="hljs-variable"><span class="hljs-variable">$null</span></span>)</code> </pre><br>     ,    Active Directory,        Email.      Active Directory. <br><br><pre> <code class="bash hljs"> { <span class="hljs-variable"><span class="hljs-variable">$Body</span></span> = <span class="hljs-variable"><span class="hljs-variable">$Body</span></span> <span class="hljs-variable"><span class="hljs-variable">$dispalyname</span></span> = (Get-AdUser <span class="hljs-variable"><span class="hljs-variable">$username</span></span> -properties DisplayName).DisplayName <span class="hljs-variable"><span class="hljs-variable">$email</span></span> = (Get-AdUser <span class="hljs-variable"><span class="hljs-variable">$username</span></span> -properties mail).mail sleep -Seconds 3</code> </pre><br>   ,       $Body      Active Directory. <br><br><pre> <code class="bash hljs">Send-MailMessage -SmtpServer <span class="hljs-variable"><span class="hljs-variable">$SMTP</span></span> -Body ( <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Dispalyname</span></span> + <span class="hljs-string"><span class="hljs-string">' '</span></span> + <span class="hljs-variable"><span class="hljs-variable">$Body</span></span> | out-string ) -To <span class="hljs-variable"><span class="hljs-variable">$email</span></span> -From <span class="hljs-variable"><span class="hljs-variable">$AdminMail</span></span> -Subject <span class="hljs-variable"><span class="hljs-variable">$Object</span></span> -Attachments <span class="hljs-variable"><span class="hljs-variable">$env</span></span>:TEMP\<span class="hljs-variable"><span class="hljs-variable">$Object</span></span>.txt -Encoding Unicode</code> </pre><br>     ,     ,       . <br><br><pre> <code class="bash hljs"> } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { (Write-Output (<span class="hljs-variable"><span class="hljs-variable">$Object</span></span> + <span class="hljs-string"><span class="hljs-string">' '</span></span> + (Get-Date).ToString()) | Add-Content <span class="hljs-variable"><span class="hljs-variable">$env</span></span>:TEMP\Offline.txt)} }</code> </pre><br>  . <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$OU</span></span>= <span class="hljs-variable"><span class="hljs-variable">$null</span></span> <span class="hljs-variable"><span class="hljs-variable">$RemoteComputer</span></span> = <span class="hljs-variable"><span class="hljs-variable">$null</span></span> <span class="hljs-variable"><span class="hljs-variable">$Hosts</span></span> = <span class="hljs-variable"><span class="hljs-variable">$nul</span></span></code> </pre><br>   ¬´HomePage¬ª     Active Directory.          ,      . <br><br><pre> <code class="bash hljs">Get-Content <span class="hljs-variable"><span class="hljs-variable">$env</span></span>:TEMP\Online.txt | Set-ADComputer -HomePage <span class="hljs-string"><span class="hljs-string">'pass'</span></span> }</code> </pre><br>  ,  ,   (     ),        . $TargetFile ‚Äì           . <br><br><pre> <code class="bash hljs">Function Remove-AuditFiles { [CmdletBinding(SupportsShouldProcess=<span class="hljs-variable"><span class="hljs-variable">$True</span></span>)] Param ( [String]<span class="hljs-variable"><span class="hljs-variable">$TargetFile</span></span> ) Get-Content -Path <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$env</span></span></span><span class="hljs-string">:TEMP\$Path"</span></span> | %{Remove-Item <span class="hljs-variable"><span class="hljs-variable">$PSItem</span></span>} }</code> </pre><br>     HomePage   Active Directory.      OU.    -. <br><br><pre> <code class="bash hljs">Function Reset-AuditComputers { [CmdletBinding(SupportsShouldProcess=<span class="hljs-variable"><span class="hljs-variable">$True</span></span>)] Param ( [String]<span class="hljs-variable"><span class="hljs-variable">$TargetOU</span></span> ) Get-ADComputer -Filter * -SearchBase <span class="hljs-variable"><span class="hljs-variable">$TargetOU</span></span> -Properties * | Set-ADComputer -HomePage <span class="hljs-string"><span class="hljs-string">'notpass'</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> | Set-Content -Path <span class="hljs-variable"><span class="hljs-variable">$env</span></span>:TEMP\Online.txt }</code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/275035/">https://habr.com/ru/post/275035/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275023/index.html">Implements setImmediate: messages, mutations, or promises, which is faster?</a></li>
<li><a href="../275025/index.html">Old New Year Clearance Sale</a></li>
<li><a href="../275027/index.html">21 free educational resource for game developers</a></li>
<li><a href="../275031/index.html">A schoolboy hacked email and got access to personal data of the head of the US National Intelligence</a></li>
<li><a href="../275033/index.html">Are you sure that all All-Flash storage systems are ready for use in the corporate sector?</a></li>
<li><a href="../275037/index.html">Analyze this or about software quality.</a></li>
<li><a href="../275039/index.html">We read the container of the private key CryptoPro by means of OpenSSL</a></li>
<li><a href="../275043/index.html">Shazam: music recognition algorithms, signatures, data processing</a></li>
<li><a href="../275045/index.html">Iosevka - another font for coding</a></li>
<li><a href="../275047/index.html">Email from your server: pitfalls</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>