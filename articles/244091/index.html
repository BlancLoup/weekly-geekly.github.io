<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Testing components in the Unity Engine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In continuation of the article on CPC, I will talk in more detail about testing components. 
 There is a lot of information about unit testing and BDD...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Testing components in the Unity Engine</h1><div class="post__text post__text-html js-mediator-article">  In continuation of the <a href="http://habrahabr.ru/post/243479/">article on CPC,</a> I will talk in more detail about testing components. <br>  There is a lot of information about unit testing and BDD, this article will be devoted to configuring SpecFlow to work with the Unity Engine, and also contain general recommendations for creating a test architecture of a game with a component-oriented approach. <br><a name="habracut"></a><br>  The general rules for developing a component that can be easily tested, I formulated as follows: <br>  1) What only a person can see / hear should be in a separate component. <br>  2) The component must have a "default" behavior.  It is better to consider it a reference. <br>  3) Do not forget: one component - one behavior. <br>  Thus, I made adjustments to my <a href="https://github.com/sountex/COPTD">implementation of the core gameplay</a> of the Tower Defense game: <br>  Some components access the Renderer via GetComponent () ‚Äîan unnecessary dependency on the mandatory presence of the Renderer component.  All visualization should be in separate components.  I specified default values ‚Äã‚Äãfor all fields: this will simplify the setting of the component itself.  Also expanded the functionality of the game by entering the Player: <br>  A player is a person whose behavior is to transfer control to the game through input devices. <br>  Now, to start the game, you need to click the "Start game" button in the UI, and then select the towers in UI for building with an indication of where to build them.  And when all the towers are built, the game will begin. <br>  <b>But the question is: for which components are Unit tests needed, and which ones should be checked by specification?</b> <br>  The answer to this question may vary depending on the number of components and the total complexity of the project.  It is worth remembering that the overall behavior of the game object is made up of the behavior of the components.  And I have the following recommendation: <br>  It is necessary to assess the complexity of the implementation of the logic inside the component.  If it is easy to make a mistake in it, it is worth to be safe and make a separate unit test for the component.  In other cases, you can make a general specification that will check the behavior of the game object as a whole. <br>  <b>Preparatory work.</b> <br>  From additions to Unity, we need the following: <br>  1) <a href="https://www.assetstore.unity3d.com/en/">UnityTestTools</a> - runner NUnit tests from Unity developers in the editor environment. <br>  2) <a href="https://visualstudiogallery.msdn.microsoft.com/20b80b8c-659b-45ef-96c1-437828fe7cf2">Visual Studio Tools</a> (former UnityVS) - plugin for debugging. <br>  Visual Studio will need <a href="http://www.specflow.org/">SpecFlow</a> <br>  <b>And we start with the Unit tests.</b> <br>  Many add unit tests directly to the project itself, but do not make the assembly heavier.  Not much time will take the selection of a set of tests in a separate assembly, which will not be included in the final version of the game (build). <br>  After adding UnityTestTools to Unity, you need to open the solution (generated by UnityVs) and add a new project like ‚Äúclass library‚Äù to it, which will contain our unit tests of components.  For example, let's call the assembly TowerDefenseCore.UnitTests.  The important point is to set up the assembly: <br>  1) Add to the references of the assembly: <br>  - "nunit.framework.dll" and "nunit.core.dll" from Assets \ UnityTestTools \ UnitTesting \ Editor \ NUnit \ Libs <br>  - "UnityEngine.dll" from Library \ UnityAssemblies <br>  - Assembling "Assembly-CSharp.dll" from the solution <br>  <u>Important:</u> do not copy them locally. <br>  2) You need to configure the properties of the assembly, specifying the output path.  The build must be in the Assets directory ‚Äî for example, Assets \ Tests. <br>  Writing unit tests performed in the Unity Test Runner is no different from regular unit tests.  However, there are several important points. <br>  <b>First,</b> instantiating a game object (GameObject.Instantiate method) is not necessary. <br>  Here is a simple test of the DamageApplicator component: <br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Test</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DamageApplicator_DirectDamage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> damageApplicator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DamageApplicator(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hp = damageApplicator.DirectDamage(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">90f</span></span>, hp); }</code> </pre> <br>  DamageApplicator has no dependencies on other components that would be resolved in the Awake / Start / OnEnable method.  But if a component uses Awake for this purpose, then it must be invoked forcibly: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Test</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Hittable_DeadOnDirectDamage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> componentsHolder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameObject(); <span class="hljs-comment"><span class="hljs-comment">// ,      componentsHolder.AddComponent&lt;DamageAplicator&gt;(); var hittable = componentsHolder.AddComponent&lt;Hittable&gt;(); hittable.Awake();//:     ,      DamageApplicator hittable.DirectDamage(50); Assert.AreEqual(50, hittable.HP); hittable.DirectDamage(50); Assert.AreEqual(true, hittable.IsDead); }</span></span></code> </pre><br>  <b>Second:</b> test the operation of components using Coroutine.  It is important to specify MaxTime, the calculated reference runtime (if any) or in the while loop an additional check to see if the test passed. <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Test</span></span>] [MaxTime(<span class="hljs-number"><span class="hljs-number">10000</span></span>)]<span class="hljs-comment"><span class="hljs-comment">//BeginDPS  5    0.5 ,   100HP public void DamageInflictor_BeginDPS() { var target = new GameObject(); target.AddComponent&lt;DamageApplicator&gt;(); var hittable = target.AddComponent&lt;Hittable&gt;(); hittable.Awake(); var tower = new GameObject(); var dmger = tower.AddComponent&lt;DamageInflictor&gt;(); dmger.BeginDPS(hittable);// Coroutine while (dmger.inflictDamage().MoveNext())//  Coroutine Thread.Sleep(100); Assert.True(hittable.IsDead); }</span></span></code> </pre><br>  <b>The third point:</b> it is better to test the behavior of each component, rather than the scene as a whole.  In the Test Runner settings in the options, specify Run test on a new scene. <br>  Build the build, switch to Unity, and in the Unity Test Tools menu, select Test Runner.  As you will see, tests from the assembly will appear to run. <br><br>  <b>SpecFlow setting.</b> <br>  Let's create the class library TowerDefenseCore.Specs in the solution.  Set it up: <br>  1) Add packages to it: Install-Package SpecFlow.NUnit <br>  2) Add assembly dependencies: <br>  - "TechTalk.SpecFlow.dll" from \ packages \ SpecFlow.1.9.0 \ lib \ net35 <br>  - "UnityEngine.dll" from Library \ UnityAssemblies <br>  - Assembling "Assembly-CSharp.dll" from the solution <br>  <u>Important:</u> do not copy them locally. <br>  3) You need to configure the properties of the assembly, specifying the output path.  The build must be in the Assets directory ‚Äî for example, Assets \ Tests. <br>  4) <u>Important:</u> copy "TechTalk.SpecFlow.dll" in Assets \ UnityTestTools \ UnitTesting \ Editor \ NUnit \ Libs. <br>  Now, in addition to the tests from TowerDefenseCore.UnitTests, there will be Steps from TowerDefenseCore.Specs in Test Runner. <br><br>  A simple example of Feature that tests creep behavior when taking damage: <br>  Feature: CreepLogic <br>  Creep alive, take damage and dead. <br>  @ creep <br>  Scenario: Check creep is dead <br>  Given creep is alive <br>  When Creep take damage 100 <br>  Then creep is dead <br>  And the generated steps: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Binding</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CreepLogicSteps</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Hittable _creep; [Given(<span class="hljs-string"><span class="hljs-string">@"Creep is alive"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GivenCreepIsAlive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> componentsHolder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameObject(); componentsHolder.AddComponent&lt;DamageApplicator&gt;(); _creep = componentsHolder.AddComponent&lt;Hittable&gt;(); _creep.Awake(); } [When(<span class="hljs-string"><span class="hljs-string">@"Creep take damage (.*)"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WhenCreepTakeDamage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dmg</span></span></span><span class="hljs-function">)</span></span> { _creep.DirectDamage(dmg); } [Then(<span class="hljs-string"><span class="hljs-string">@"Creep is dead"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ThenCreepIsDead</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { NUnitFramework.Assert.AreEqual(<span class="hljs-literal"><span class="hljs-literal">true</span></span>, _creep.IsDead); } }</code> </pre><br>  In Test Runner, the test will be displayed with the name CheckCreepIsDead. <br><img src="https://habrastorage.org/files/739/bdf/fba/739bdffbaa154303b6541f5abe6552dd.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the beginning of the article I mentioned the Player‚Äôs behavior.  What are ways to automate the verification of his behavior without human intervention - the topic for a separate article. </div><p>Source: <a href="https://habr.com/ru/post/244091/">https://habr.com/ru/post/244091/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244079/index.html">GPS monitoring for personal use (part 1)</a></li>
<li><a href="../244083/index.html">Temperature control in server cabinets with Arduino</a></li>
<li><a href="../244085/index.html">How we implement Open source in state-owned companies and large-scale commerce in Russia</a></li>
<li><a href="../244087/index.html">NaviGuild your own navigator</a></li>
<li><a href="../244089/index.html">.NEXT 2014 Moscow: we break up the hall reports together</a></li>
<li><a href="../244093/index.html">LinkMeUp. Issue number 21. Network monitoring and management systems</a></li>
<li><a href="../244095/index.html">How does decompilation in .Net or Java using the example .Net</a></li>
<li><a href="../244097/index.html">Miranda NG Project Receives Wild Signs Award (Part One)</a></li>
<li><a href="../244099/index.html">Byrobot: quadrocopter for Chuck Norris and 6d thinking</a></li>
<li><a href="../244101/index.html">WUD 2014 - World Usability Day</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>