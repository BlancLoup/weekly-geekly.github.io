<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cloning a 50Gb database from Prod to Dev in 1 second without loss of integrity</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tool list 


- Proxmox 
- ZFS 
- Lxc 
- MongoDB as an experimental base 
 Foreword 
 My name is Evgeny Savyolov, I do networking, virtualization, Wind...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cloning a 50Gb database from Prod to Dev in 1 second without loss of integrity</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/te/hf/2o/tehf2ofyya2nhvnaemtwjozfvu4.png"><br><h2>  Tool list </h2><br><ul><li>  Proxmox </li><li>  ZFS </li><li>  Lxc </li><li>  MongoDB as an experimental base </li></ul><br><h2>  Foreword </h2><br>  My name is Evgeny Savyolov, I do networking, virtualization, Windows and Linux servers, coordinating the work of programmers and customers in a small company. <br><br>  I see that many use virtualization systems such as Proxmox, but do not know how to take advantage of LXC and ZFS.  Many simply use classic file systems, such as Ext4, and the classic methods of cloning and backing up containers.  This leads to downtime during cloning of large containers and high server load. <br><br>  I will try to share my experience. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>I also prepared the material in the form of a 6-minute screencast.</i>  <i>Voice support is not, so you can not look for headphones :).</i>  <i>But there are annotations below.</i> <br><br><div class="spoiler">  <b class="spoiler_title">View video</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/vw0JFTApD4E" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><a name="habracut"></a><br><h2>  Initial settings </h2><br>  <b>Proxmox</b> <br>  Installed immediately on ZFS <br>  <b>ZFS</b> <br>  Support is enabled by default for Proxmox.  The default settings are good.  Doubts are caused by: swap partition on ZFS and zvol block size for KVM virtual machines. <br>  <b>Lxc</b> <br>  Support is enabled by default for Proxmox.  The default settings are excellent. <br>  <b>MongoDB</b> <br>  Test base for 50Gb inside LXC container created using Proxmox Web Console <br><br><h2>  Cloning and Testing </h2><br><h4>  1. Let's get acquainted with the source container </h4><br>  Root container file system takes 56.5GiB on disk with snapshots and 30Gib on disk without snapshots. <br><br><pre><code class="bash hljs">zfs list rpool/data/containers/subvol-105-disk-1 NAME USED AVAIL REFER MOUNTPOINT rpool/data/containers/subvol-105-disk-1 56.5G 98.3G 30.0G /rpool/data/containers/subvol-105-disk-1</code> </pre> <br>  Below you can see that our container occupies 44.4GiB places logically (excluding snapshots and LZ4 compression). <br><br><pre> <code class="bash hljs">zfs get logicalreferenced rpool/data/containers/subvol-105-disk-1 NAME PROPERTY VALUE SOURCE rpool/data/containers/subvol-105-disk-1 logicalreferenced 44.4G -</code> </pre><br>  <i>Inside a Ubuntu 14.04 container with a MongoDB 3.4 database</i> <br><br><h4>  2. Create a new container in Proxmox, we will clone the original container into it </h4><br>  When creating a new container, be careful, as a template, you must specify the template used in the main container. <br><br>  That is, if the main container is Ubuntu 14.04, then the new container should also be Ubuntu 14.04. <br><br>  If this is not done, then after cloning the file system from the source container, the new container will not start.  The fact is that besides the file system, containers have certain launch attributes that depend on the OS inside the container. <br><br><h4>  3. Destroy the file system of the new container. </h4><br>  Replace the number inside the square brackets with the number of the new container.  <b><i>Warning</i></b> : this operation is irreversible! <br><br><pre> <code class="bash hljs">zfs destroy rpool/data/images/vm-[111]-disk-1</code> </pre> <br><h4>  4. Take a snapshot of the source container </h4><br>  A snapshot is one atomic operation. <br><br>  ZFS ensures that a snapshot is taken instantly, regardless of the size of the file system.  We can also be sure that ‚Äúinside‚Äù the operation of taking a snapshot, no data of the file system (consistency) will be changed. <br><br><pre> <code class="bash hljs">zfs snapshot rpool/data/images/vm-[105]-disk-1@demo <span class="hljs-comment"><span class="hljs-comment">#demo -  </span></span></code> </pre> <br><h4>  5. Make a clone of the source container file system. </h4><br>  File system cloning is always performed with a snapshot of another file system.  The name of the clone must be specified taking into account the name of the new container, then after creating the file system, you will not need to change the mount points to launch the container. <br><br><pre> <code class="bash hljs">zfs <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> rpool/data/images/vm-[105]-disk-1@demo rpool/data/images/vm-[111]-disk-1</code> </pre> <br><h4>  6. Run the zfs list output and demonstrate that the clone does not consume additional space. </h4><br>  Below you can see that our container occupies 112KiB on disk and refers to 30.0Gib <br><br><pre> <code class="bash hljs"> zfs list rpool/data/containers/subvol-111-disk-1 NAME USED AVAIL REFER MOUNTPOINT rpool/data/containers/subvol-111-disk-1 112K 98.2G 30.0G /rpool/data/containers/subvol-111-disk-1</code> </pre><br><h4>  7. Run the clone container and demonstrate that everything works.  Let's change part of the database. </h4><br>  The container can be launched from the Proxmox Web interface or using the following command: <br><br><pre> <code class="bash hljs">pct start 111</code> </pre><br>  To find out the IP address of the new container, you can go to it. <br><br><pre> <code class="bash hljs">lxc-attach -n 111 ifconfig <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre><br>  It remains for us to connect to the cloned database, for example using MongoBooster and change part of the data.  I will impose a complex index. <br><br><div class="spoiler">  <b class="spoiler_title">Screenshot</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/g8/rw/ji/g8rwjib3oowb9guo5tisqk_jqug.png"><br></div></div><br><h4>  8. Run the zfs list output and demonstrate that the clone consumes the space that was required to change part of the database. </h4><br>  Space is spent only on modified blocks. <br><br>  Usually, the larger the block size, the more space will be expended, but zfs uses transparent lz4 compression, which reduces the overhead of using efficient 128KiB blocks. <br><br>  Below you can see that our container occupies 144MiB on disk and refers to 30.1Gib <br><br><pre> <code class="bash hljs">zfs list rpool/data/containers/subvol-111-disk-1 NAME USED AVAIL REFER MOUNTPOINT rpool/data/containers/subvol-111-disk-1 144M 98.2G 30.1G /rpool/data/containers/subvol-111-disk-1</code> </pre><br><h4>  9. Results </h4><br>  In the future, we will not need to remove or create containers in Proxmox.  We simply destroy the clone file system and again remove the clone from the Production base. <br><br>  This is done instantly.  The clone's network settings will not change, as it will not change the Mac address. <br><br><h2>  Instead of conclusion </h2><br>  Rely on your comments.  I will try to answer all interesting questions and supplement the article with these questions and the answers to them, pleasant viewing. </div><p>Source: <a href="https://habr.com/ru/post/341170/">https://habr.com/ru/post/341170/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341156/index.html">Security Week 43: The Great IoT Reap Is Coming, Like NATO Cyberconf Hackers Flying, Bad Exception Rabbit Ears ExPetr</a></li>
<li><a href="../341160/index.html">Remove radial distortion from photos and videos using the openCV library and the python language</a></li>
<li><a href="../341164/index.html">Your users do not need passwords.</a></li>
<li><a href="../341166/index.html">How to arrange an open source project</a></li>
<li><a href="../341168/index.html">Virtuozzo Storage: Actual Operating Experience, Optimization and Problem Solving Tips</a></li>
<li><a href="../341172/index.html">Connecting a remote COM controller to a computer‚Äôs USB port via unmatched lines</a></li>
<li><a href="../341178/index.html">SILVER: how I design iOS apps</a></li>
<li><a href="../341180/index.html">Paul Graham. All articles in Russian. Two years later</a></li>
<li><a href="../341182/index.html">Virtual Infrastructure Provider Development: 1cloud Experience</a></li>
<li><a href="../341192/index.html">Localization of comments in the code. Yandex lecture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>