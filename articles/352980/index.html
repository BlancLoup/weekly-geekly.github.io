<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Never Fail Twice, or how to build a monitoring system from scratch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We had 2 virtual machines, 75 sites, tens of thousands of monitoring machines, thousands of metrics, two databases and one ActiveMQ line, Python and a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Never Fail Twice, or how to build a monitoring system from scratch</h1><div class="post__text post__text-html js-mediator-article">  We had 2 virtual machines, 75 sites, tens of thousands of monitoring machines, thousands of metrics, two databases and one ActiveMQ line, Python and a whole host of libraries of all sorts and colors, pandas, as well as numpy, dash, flask, SQL Alchemy.  Not that it was the necessary supply for the system, but if it began to assemble the components, it becomes difficult to stop.  The only thing that made me fear was javascript.  Nothing in the world is more helpless, irresponsible and vicious than JS zombies.  I knew that sooner or later we will move on to this rubbish. <br><br><img src="https://habrastorage.org/webt/gm/3i/tm/gm3itmzqk9hbgtclkdkxc9cfygi.png" alt="image"><br><a name="habracut"></a><br><h4>  Never fails </h4><br>  Monitoring distributed systems is quite a non-trivial task, where there are pitfalls.  On the other hand, there are a huge number of both commercial and open-source solutions for various monitoring tasks.  Under the cut on why open decisions did not fit us, what we understood from the analysis of successful and unsuccessful monitoring projects, and why it was decided to build Yet Another Alert System.  It was a fascinating adventure, where at the stages from analyzing data in Python to the final solution and building the system, we met almost all of Computer Science and even a bit of matane. <br><br>  If we consider the problem of monitoring in general, the tasks are divided into two main groups. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Low Level Monitoring - monitoring infrastructure by the parameters of the CPU, Disk usage networking, Java Heap Usage, GC cycles and so on.  Everything is quite simple here and there are many working ready-made solutions.  In many cases, fairly simple thresholds;  in the case of a JVM, you can monitor the regularity of the processes on the Java heap sawtooth graphs - increasing the frequency of the peaks may indicate problems in memory management and frequent GC cycles. </li><li>  High Level Monitoring - when business indicators (BI) or Key Performance Indicators (KPI) are selected as metrics, such as volumes of user sessions, transactions, payments, etc.  Low level monitoring cannot adequately reflect what is happening in the system at the level of business logic. </li></ul><br>  Why is it difficult? <br><br>  - Monitoring a complex distributed system is already an engineering problem in itself <br>  - Various problems lead to implicit changes in system behavior. <br>  - Many different metrics of one system <br>  - Different metrics correlate among themselves <br><br>  I work as a Technical Architect in a large company, and we have problems with timely detection of problems in production systems. <br><br>  We operate financial transactions in highly regulated markets.  The system architecture is service-oriented, the components have complex business logic, there are different backend options for different clients of the (B2B) company. <br><br><h4>  Low level monitoring and tests do not cover a whole range of problems. </h4><br>  Firstly, due to the high complexity of the products and the huge number of settings, there are situations when incorrect settings lead to degradation of financial indicators, or hidden bugs in the logic affect the overall functionality of the entire system. <br><br>  Secondly, there are specific 3d-party integration for different countries, and the problems arising from the partners begin to flow to us.  Problems of this kind are not caught by low level monitoring;  to solve them, you need to monitor key indicators (KPI), compare them with system statistics and look for correlations. <br><br>  The company had previously implemented a solution from Hewlett Packard Service Health Analyzer, which was (to put it mildly) imperfect.  Judging by the marketing prospectus, it is a system that studies itself and provides early detection of problems.  In fact, it was a black box that could not be configured, with all the problems needed to contact HP and wait for months until the support engineers did something that wouldn't work as well.  And yet - a terrible user interface, an old JVM ecosystem (Java 6.0), and, most importantly, a large number of False Positives and (worse,) False Negatives, that is, some serious problems were either not detected or were caught much later than it should , which was expressed in a very specific financial loss. <br><br>  The figure shows that the granularity of SHA is 15 minutes - this means that even in case of problems, the minimum reaction time is 15 minutes ... <br><br><img src="https://habrastorage.org/webt/85/hn/km/85hnkmfqhd6dcxouqmimfnppko8.png" alt="image"><br><br>  That is, it all often looked something like this ... <br><br><img src="https://habrastorage.org/webt/xw/7d/n1/xw7dn1vgr-qm6pp0-iphff41cxg.jpeg" alt="image"><br><br><h2>  On the shoulders of giants </h2><br>  Many companies tried to build their monitoring systems.  These were not always success stories. <br><br><h3>  Etsy - Kale System </h3><br>  Etsy is an online marketplace for handmade goods.  The headquarters of the company is located in New York.  The company collected more than 250,000 different metrics from its servers and tried to look for anomalies in the metrics using complex mathematical algorithms.  But‚Ä¶ <br><br>  Meet Kale. <br><br><img src="https://habrastorage.org/webt/zk/va/k9/zkvak92u8vd04kemaqp4bofl8mu.png" alt="image"><br><br>  One of the problems Kale was that the system used a lot of different technological stacks.  In the diagram you can see 4 different stacks, plus 2 frameworks.  To develop and maintain the system, highly skilled engineers were required who were familiar with these stacks.  The search for bugs also required knowledge in many stacks. <br><br>  The second problem is the monitoring approach itself.  Kale was only looking for anomalies.  But if you have 250,000 metrics, then for every tick hundreds of anomalies will be statistically observed.  If you expand the permissible limits, then problems will slip.  If narrowed, there will be a huge number of false positives. <br><br>  Etsy engineers tried to fight the number False Positives, but after three years of development the project was closed.  On this topic there is a good <a href="https://www.youtube.com/watch%3Fv%3Dsn-btkORIxg.">video from Andrew Clegg.</a> <br><br>  I want to highlight one slide from this video. <br><br><img src="https://habrastorage.org/webt/ol/n2/y7/oln2y7jpn7egjnsjtlrlrraa3cq.png" alt="image"><br><br>  Finding anomalies is more than catching outliers.  Outliers emissions will be observed on any real production data in normal operation mode.  Not all anomalies should lead to alarm triggering at all levels. <br><br>  A universal approach is not suitable for anything;  There are no free lunches.  That's why HP's SHA solution doesn't work as it should, trying to be a versatile tool. <br><br>  And interestingly, the possible approaches to solving these problems. <br><br>  Send an alert on anomalies in business and user metrics <br>  Use other metrics for root cause analysis. <br><br><h3>  Google SRE teams BorgMon </h3><br>  The book Site Reliability Engineering has a whole chapter devoted to the issue of monitoring the production of Google systems.  In short, <br><br><ul><li>  Google aimed for simpler and faster monitoring systems with better tools for post hoc analysis. </li><li> Their goal was to avoid magical systems that automatically teach thresholds or automatically seek correlations.  A person should be well aware of what is happening in the system and according to what rules alerts are generated. </li><li>  The rules for problem response systems were kept as simple as possible.  They gave a very fast response time to simple, localized, serious anomalies. <br></li><li>  A person should be well aware of what is happening in the system and according to what rules alerts are generated. </li></ul><br>  On these principles, Google built a successful BorgMon system. <br><br><h2>  Time series </h2><br>  Time series is a data series indexed by time.  If we take as a series of economic processes (from the production of champagne to sales in stores or online transactions), then they have some common properties: the processes are regular, have a certain frequency, usually have seasonal periods and trend lines.  Using this information, you can simplify the analysis. <br><br>  Take a weekly series of real data on the number of transactions.  We can see a pronounced regularity (two peaks are performance tests).  There is daily regularity, plus an increase in activity on Friday and on weekends, after which the activity begins to subside until the next weekend. <br><br><img src="https://habrastorage.org/webt/1v/8l/sx/1v8lsxiyiijywff6freimzem5au.png" alt="image"><br><br>  On Habr√© there were many quite good materials on this subject, for example <a href="https://habrahabr.ru/company/ods/blog/327242/">here</a> . <br><br>  On Medium there is my introduction to time series modeling (in english): <a href="https://medium.com/%40ATavgen/time-series-modelling-a9bf4f467687">Time series modeling</a> . <br><br>  In a nutshell: each measurement contains signal components and measurement / noise errors.  There are many factors that affect both the processes themselves and the metrics collected. <br><br>  <b>Point = Sig + err</b> <br><br>  We have a model that describes the signal.  If the model is subtracted from the measurement, then the better the model captures the signal, the more the result of the subtraction will tend to stationarity or white noise - and this is easy to verify. <br><br>  In an <a href="https://medium.com/%40ATavgen/time-series-modelling-a9bf4f467687">article on Medium,</a> I gave examples of modeling linear and segmented regression. <br><br>  For the monitoring system, I chose modeling using sliding statistics for mean and scatter.  The moving average is essentially a low pass filter that smooths the noise and leaves the main trend lines.  Here are our data on the number of transactions in another week, after the passage of the moving average with a window of 60 minutes (peaks removed): <br><br><img src="https://habrastorage.org/webt/jv/kw/ts/jvkwtsa3iqysisvy7rl2_g86oc0.png" alt="image"><br><br>  We also collect and moving variance to set the permissible boundaries of the model.  As a result, we get something from Salvador Dali. <br><br><img src="https://habrastorage.org/webt/xt/9i/m2/xt9im2sjcx77c7wbp6hpebb0bf8.png" alt="image"><br><br>  We enter here the data for another week and we can immediately see outliers. <br><br><img src="https://habrastorage.org/webt/c1/kc/ct/c1kcctl2ra-zvakzgkzreoeewuk.png" alt="image"><br><br>  Now we have everything we need to build our Alert System. <br><br><h4>  An important digression. </h4><br>  The Kale project experience speaks about a very important point.  Alerting is not the same as searching for anomalies and outliers in metrics, since, as already mentioned, there will always be anomalies on single metrics. <br><br>  In fact, we have two logical levels. <br><br>  - The first is to search for anomalies in the metrics and send a notification of the violation, if an anomaly is found.  This is the level of issue of information. <br>  - The second level is a component that receives information about violations and decides whether this is a critical incident or not. <br><br>  In this way, we humans act when we investigate a problem.  We look at something, if we detect deviations from the norm, we look again, and then make a decision based on the observations. <br><br>  At the beginning of the project, we decided to try Kapacitor, since it has the ability to define custom functions in Python.  But each function sits in a separate process, which would create an overhead for hundreds and thousands of metrics.  Because of this and some other problems, it was decided to abandon it. <br><br>  For building your own system, Python was chosen as the main stack, because there is an excellent ecosystem for data analysis, fast libraries (pandas, numpy, etc.), excellent support for web solutions.  You name it. <br><br>  For me, this was the first big project, fully and entirely executed in Python.  I myself came to Python from the Java world.  I did not want to multiply the zoo of stacks for one system, which was ultimately rewarded. <br><br><h2>  General architecture. </h2><br>  The system is built as a set of loosely coupled components or services that spin in their processes on their Python VM.  This is natural for a general logical partitioning (events emitter / rules engine) and gives other advantages. <br><br>  Each component does a limited number of specific things.  In the future, this will allow you to quickly expand the system and add new user interfaces without affecting the basic logic and not being afraid to break it.  Between the components are fairly clear boundaries. <br><br>  Distributed deploy is convenient if you need to locate the agent locally to closer to the site that it monitors - or you can aggregate together a large number of different systems. <br><br>  Communication must be message-based, since the entire system must be asynchronous. <br>  I chose ActiveMQ as the Message Queue, but if I want to change, for example, with RabbitMQ, there will be no problems, since all the components communicate using the standard STOMP protocol. <br><br><img src="https://habrastorage.org/webt/9f/jp/ci/9fjpciawxp4bcvegu3xb6kp5m5g.png"><br><br>  <b>Event streamer</b> is a component that stores statistical models, selects data at certain intervals, and finds outliers.  It is quite simple ustroen: <br><br><img src="https://habrastorage.org/webt/z8/kk/w7/z8kkw7cllligh21erawon70cmgi.jpeg" alt="image"><br><br>  <b>Worker</b> is the main working unit that stores one model of the same metric along with meta-information.  It consists of the date of the connector and the handler to which the data is transmitted.  The handler tests them on a statistical model, and if it detects violations, then sends them to the agent, which sends the event to the queue. <br><br>  <b>Workers are</b> completely independent of each other, each cycle is executed through a pool of threads.  Since most of the time is spent on I / O operations, Global Interpreter Lock Python does not greatly affect the result.  The number of threads is set in the config;  on the current configuration, the optimal number was 8 threads. <br><br><img src="https://habrastorage.org/webt/ju/o2/op/juo2opllshmag7b3ljaoufamxbg.jpeg" alt="image"><br><br>  Now for the Consumer part.  The component is subscribed to a topic in the queue, and when a message arrives it adds it to the dictionary associated with the tick and with each site.  The system stores all the events in a certain window and deletes the oldest ones upon receipt of each new message.  In order not to view the entire dictionary, the keys are stored in the Priority Queue, ordered by timestamp. <br><br><img src="https://habrastorage.org/webt/1f/l6/k3/1fl6k3etjmr8bxbowlnobkto48s.png" alt="image"><br><br>  Architecturally, the component looks like this. <br><br><img src="https://habrastorage.org/webt/nm/yt/u5/nmytu5tapbmcv8hyofbpffh8nos.jpeg" alt="image"><br><br>  Each message is sent to the Rule Engine, and then the fun begins.  At the very beginning of development, I rigidly set the rules in the code: when one metric falls and the other grows, then send an alert.  But this solution is not universal and requires getting into the code for any extension.  Therefore, I needed some kind of language that sets the rules.  Then I had to remember the Abstract Syntactic Trees and define a simple language to describe the rules. <br><br>  The rules are described in the YAML format, but you can use any other, just add your parser.  Rules are defined as regular expressions for the names of metrics or simply for prefixes of metrics.  Speed ‚Äã‚Äãis the speed of degradation of metrics, more on that below. <br><br><img src="https://habrastorage.org/webt/fs/7h/zi/fs7hzibbfpnknejwu2strn25exu.png" alt="image"><br><br>  When the component is started, the rules are read and the syntax tree is built.  When each message is received, all events from this site for one tick are checked according to the specified rules, and if the rule is triggered, an alert is generated.  There are several rules that worked. <br><br>  If we consider the dynamics of incidents developing in time, then we can also take into account the speed of the fall (severity level) and the change in speed (forecast severity change) <br><br><img src="https://habrastorage.org/webt/kj/1-/3e/kj1-3ekkcbitiahmxwy5i4y8in4.jpeg" alt="image"><br><br>  Velocity is the slope or discrete derivative, which is calculated for each violation.  The same applies to acceleration, a discrete derivative of the second order. <br>  These values ‚Äã‚Äãcan be set in the rules.  Cumulative derivatives of the first and second orders can be taken into account in the overall assessment of the incident. <br><br>  To store historical events using the database via ORM (SQL Alchemy) <br><br>  So, we have a working backend.  Now you need a user interface for managing the system and reporting on the metrics triggered by a specific rule. <br><br>  I wanted to stay the maximum in one stack.  And here comes Dash <a href="https://dash.plot.ly/">dash.plot.ly.</a> <br><br>  This is a framework for data visualization add-on over Flask and Plotly.  You can make interactive web interfaces not in a week or two, but in a matter of hours.  Not a single line of Javascript, easy extensibility, and the output is ReactJS-based WebUI and perfect integration with Python. <br><br>  One of the components through the WebUI controls the start, stop, build of Workers.  Since we do not know in what state the component storing the workers, whether the calculations have completed or not, all API calls go through messages (Remote Procedures Call over Messaging). <br><br><img src="https://habrastorage.org/webt/k_/tt/v7/k_ttv7tlwwmtvo5v94lcaudakgq.png" alt="image"><br><br>  A separate component builds an on-demand dynamic report that contains metrics associated with this alert.  When an alert is generated, a link to the report is generated in one of the properties.  Also, if desired, it is possible to receive live stream. <br><br><img src="https://habrastorage.org/webt/nz/zc/bm/nzzcbmdntott1ejafse4v6lmblg.png" alt="image"><br><br>  Integration with Grafana is also done and you can click on the link to go to Grafana. <br><br>  There is one more moment.  Since the alert flies every time the rules are triggered, with long downtime several alerts will be generated every minute.  Need a system of accounting and deduplication.  We already had such a system in the company and I integrated there, but my colleague found an excellent alternative solution. <br><br>  Meet <a href="http://alerta.readthedocs.io/en/latest/">Alert</a> . <br><blockquote>  At-a-glance 'visualization.  If you‚Äôre on a single screen. </blockquote>  Alert is a tool used to consolidate and deduplicate signals from many sources along with their visualization and accounting. <br><br><img src="https://habrastorage.org/webt/yt/lt/nz/ytltnzuaawxpmpr1az5xhvage2w.png" alt="image"><br><br>  This is a great tool that integrated very easily, including the user interface that I built into the WebUI system.  Alerta has ready integration with Email, Slack, HipChat and so on.  She can write Alerts back to influxDB for further visualization in Grafana. <br><br>  From the moment of the first rally to the release in production, just over 6 months passed.  We catch most of the incidents a few minutes earlier (on average 12-15) than the old alert system HP.  In addition, the system detects and signals some problems that were slipping through other monitoring systems. <br><br>  Now we are building up statistics in order to more precisely set up the rules.  There are further plans for the development of the system, for example, try to look at the metrics through Convolution Networks (third-party project). <br><br>  It was a very interesting adventure, on which we met abstract syntax trees, priority queues, matan and a lot more.  At the moment, the system consists of 5 components (microservices), together with Alerta - 7 components.  The company has the intention to release this system in open source, but this requires a few more months. <br><br>  An adventure that is still ongoing. <br><br><img src="https://habrastorage.org/webt/s6/im/fs/s6imfsylrudogj0wnmixjnotgg8.jpeg" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/352980/">https://habr.com/ru/post/352980/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352970/index.html">How 64k intro is created today: immersion immersion</a></li>
<li><a href="../352972/index.html">From the Baltic Sea to the Indian Ocean</a></li>
<li><a href="../352974/index.html">Cryptocurrency for beginners. How to start using Bitcoin</a></li>
<li><a href="../352976/index.html">Manipulating Google search results</a></li>
<li><a href="../352978/index.html">Apache Kafka Review</a></li>
<li><a href="../352982/index.html">Alice, Google Assistant, Siri, Alexa. How to write applications for voice assistants</a></li>
<li><a href="../352984/index.html">Security Week 12: card games, hand-driven malware and a healthy approach to leaks</a></li>
<li><a href="../352986/index.html">Messengers, it's time to take the next step.</a></li>
<li><a href="../352988/index.html">Self-Managed Virtual Infrastructures: VMware Updates vRealize Suite</a></li>
<li><a href="../352990/index.html">Massive attack on cisco</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>