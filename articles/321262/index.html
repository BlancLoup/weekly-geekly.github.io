<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Logging with rsyslog, file names in tags, multi-line messages and fault tolerance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Image from oxygen-icons.org 
 Task 


 Transfer log files to central server: 


- If the server is unavailable, do not lose messages, but accumulate a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Logging with rsyslog, file names in tags, multi-line messages and fault tolerance</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/346/388/785/3463887857734c5bbbd7fb0fb7f193f9.png" alt="image"></p><br><p>  <em>Image from <a href="http://www.oxygen-icons.org/">oxygen-icons.org</a></em> </p><br><h2 id="zadacha">  Task </h2><br><p>  Transfer log files to central server: </p><br><ul><li>  If the server is unavailable, do not lose messages, but accumulate and transmit when it appears on the network. </li><li>  Correctly transmit multi-line messages. </li><li>  When new log files appear, client reconfiguration is enough; server configuration changes are not required </li><li>  You can transfer the contents of all the log files with the corresponding template name, and their contents on the server will be saved separately into files with the same name. </li></ul><br><p>  Conditions: the infrastructure uses only Linux servers. </p><a name="habracut"></a><br><ul><li>  <a href="https://habr.com/ru/post/321262/">Task</a> </li><li>  <a href="https://habr.com/ru/post/321262/">Choosing software</a> </li><li>  <a href="https://habr.com/ru/post/321262/">Message format and legacy</a> <br><ul><li>  <a href="https://habr.com/ru/post/321262/">Alternative to syslog protocol: RELP</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/321262/">Rsyslog configuration</a> </li><li>  <a href="https://habr.com/ru/post/321262/">Message handling</a> </li><li>  <a href="https://habr.com/ru/post/321262/">Configuration examples</a> </li><li>  <a href="https://habr.com/ru/post/321262/">Client: sending logs with saving file name</a> <br><ul><li>  <a href="https://habr.com/ru/post/321262/">Reading log files specified via wildcard</a> </li><li>  <a href="https://habr.com/ru/post/321262/">Multiline messages</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/321262/">Server</a> </li><li>  <a href="https://habr.com/ru/post/321262/">Reliable message delivery.</a>  <a href="https://habr.com/ru/post/321262/">Queues</a> </li><li>  <a href="https://habr.com/ru/post/321262/">fault tolerance</a> </li><li>  <a href="https://habr.com/ru/post/321262/">Interaction with logrotate</a> <br><ul><li>  <a href="https://habr.com/ru/post/321262/">Logs that rsyslog writes</a> </li><li>  <a href="https://habr.com/ru/post/321262/">Logs written by the application and read by rsyslog</a> </li></ul></li><li>  <a href="https://habr.com/ru/post/321262/">Total</a> </li></ul><br><h2 id="vybor-softa">  Choosing software </h2><br><p>  Why do I need a syslog server when there are elastic beats, logstash, systemd-journal-remote and many more new brilliant technologies? </p><br><ul><li>  This is a standard for logging in POSIX-compatible systems. <br>  Some software, for example haproxy, uses only it.  That is completely get rid of the syslog you still will not succeed </li><li>  It is used by network iron. </li><li>  More difficult to set up, but richer in capabilities than alternative solutions. <br>  For example, Elastic Filebeat is still not able to inotify. </li><li>  No memory required.  It is possible to use on embedded systems after a <a href="http://wiki.rsyslog.com/index.php/Reducing_memory_usage">little tuning</a> . </li><li>  Allows you to change the message before saving / forwarding. <br>  A strange task, but sometimes required.  For example, <a href="https://ru.wikipedia.org/wiki/PCI_DSS">PCI DSS</a> in Section 3.4 requires that card numbers be masked or encrypted if they are saved to disk.  The subtlety is that if someone entered the card number in the search box or in the feedback form, then as soon as you saved the query in the log, you violate the standard. </li></ul><br><p>  <em>Observation</em> : Users try to enter the card number in any input field on the page, and strive to inform it to the support along with the CVV. </p><br><h2 id="format-soobscheniy-i-legacy">  Message format and legacy </h2><br><div class="spoiler">  <b class="spoiler_title">TLDR: everything is bad</b> <div class="spoiler_text"><p>  Syslog appeared in the 80s, and quickly became the standard of logging for Unix-like systems and network equipment.  There was no standard, everyone wrote according to the principle of compatibility with existing software.  In 2001, the IETF described the current state of affairs in RFC 3164 (status "informational").  Since the implementations are very different, in particular, this document says "the content of any IP packet sent to UDP port 514 should be considered as a syslog message".  Then they tried to standardize the format in RFC 3195, but the document was unsuccessful, for it there is not a single live implementation for it at the moment.  In 2009, RFC 5424 was adopted, defining structured messages, but rarely does anyone use it. </p><br><p>  <a href="http://www.rsyslog.com/doc/syslog_parsing.html">Here</a> you can read what rsyslog author Rainer Gerhards thinks about all this.  In fact, everything still implements syslog as it is, and the task to interpret all this diversity is to go to the syslog server.  For example, a <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/pmciscoios.html">special module is</a> included in rsyslog to parse the format used by CISCO IOS, and for the worst cases, starting from version 5, you can define your own parsers. </p></div></div><br><p>  Syslog messages when transferring over the network look like this: </p><br><pre><code class="plaintext hljs">&lt;PRI&gt; TIMESTAMP HOST TAG MSG</code> </pre> <br><ul><li>  <code>PRI</code> - Priority.  Calculated as <code>facility * 8 + severity</code> . <br><ul><li>  Facility (category) takes values ‚Äã‚Äãfrom 0 to 23, they correspond to various categories of system services: 0 - kernel, 2 - mail, 7 - news.  The last 8 - from local0 to local7 - are defined for services that do not fall into predefined categories.  <a href="https://en.wikipedia.org/wiki/Syslog">Full list</a> . </li><li>  Severity takes on values ‚Äã‚Äãfrom 0 (emergency, highest) to 7 (debug, lowest).  <a href="https://en.wikipedia.org/wiki/Syslog">Full list</a> . </li></ul></li><li>  <code>TIMESTAMP</code> - time, usually in the format "Feb 6 18:45:01".  According to RFC 3164, it can be recorded in ISO 8601 time format: "2017-02-06T18: 45: 01.519832 + 03: 00" with greater accuracy and taking into account the time zone used. </li><li>  <code>HOST</code> - the name of the host that generated the message. </li><li>  <code>TAG</code> - contains the name of the program that generated the message.  No more than 32 alphanumeric characters, although in fact many implementations allow more.  Any non-alphanumeric character ends the TAG and starts the MSG, usually a colon is used.  Sometimes in square brackets contains the number of the process that generated the message.  Since <code>[ ]</code> is not alphanumeric characters, the process number along with them should be considered part of the message.  But usually all implementations consider this to be part of the tag, considering everything to be after the characters ":" </li><li>  <code>MSG</code> is a message.  Because of the uncertainty about where the tag ends and the message begins, a space may be added to the beginning.  Cannot contain newline characters: they are frame delimiters, and will begin a new message.  Ways to still send instant message: <br><ul><li>  shielding.  We will receive on the receiver side text with <code>#012</code> instead of line breaks </li><li>  using octet-counted TCP Framing, as defined in RFC 5425 for TLS-enabled syslog.  Non-standard, only some implementations. </li></ul></li></ul><br><h4 id="alternativa-protokolu-syslog-relp">  Alternative to syslog protocol: RELP </h4><br><p>  If messages are sent between hosts using rsyslog, you can use the <a href="http://www.rsyslog.com/doc/relp.html">RELP</a> - Reliable Event Logging Protocol instead of plain TCP sysog.  It was created for rsyslog, now supported by some other systems.  In particular, it is understood by Logstash and Graylog.  For transport uses TCP.  Can optionally encrypt messages using TLS.  More reliable plain TCP syslog, does not lose the message when the connection is broken.  Solves the problem with multi-line messages. </p><br><h2 id="konfiguraciya-rsyslog">  Rsyslog configuration </h2><br><p>  Unlike the second common alternative, syslog-ng, rsyslog is compatible with the configs of historical syslogd: </p><br><pre> <code class="bash hljs">auth,authpriv.* /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/auth.log *.*;auth,authpriv.none /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/syslog *.* @syslog.example.net</code> </pre> <br><p>  Since the rsyslog capabilities are much larger than those of its predecessor, the config file format has been extended with additional directives starting with the <code>$</code> sign: </p><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$ActionFileDefaultTemplate</span></span> RSYSLOG_TraditionalFileFormat <span class="hljs-variable"><span class="hljs-variable">$WorkDirectory</span></span> /var/spool/rsyslog <span class="hljs-variable"><span class="hljs-variable">$IncludeConfig</span></span> /etc/rsyslog.d/*.conf</code> </pre> <br><p>  Starting with the sixth version, the si-like format RainerScript appeared, allowing to set complex rules for processing messages. </p><br><p>  Since all this was done gradually and taking into account compatibility with old configs, a couple of unpleasant moments turned out in the end: </p><br><ul><li>  some plugins (I haven't come across such yet) may not support the new RainerScript style of settings, they still need old directives </li><li>  setting via old directives does not always work as expected for the new format: <br><ul><li>  if the <code>omfile</code> module <code>omfile</code> called using the old format: <br>  <code>auth,authpriv.* /var/log/auth.log</code> , the owner and permissions of the resulting file are governed by the old <code>$FileOwner</code> , <code>$FileGroup</code> , <code>$FileCreateMode</code> .  But if it is called using <code>action(type="omfile" ...)</code> , then these directives are ignored, and you must configure the action parameters or specify when the module is loaded </li><li>  Directives like <code>$ActionQueueXXX</code> configure only the queue that will be used in the first action after them, then the values ‚Äã‚Äãare reset. </li></ul></li><li>  semicolons are forbidden somewhere, and somewhere opposite are mandatory (the second less often) </li></ul><br><p>  In order not to stumble over these subtleties (yes, they are described in the documentation, but who reads it all?), You should follow simple rules: </p><br><ul><li>  for small simple configs use the old format: <br> <code>:programname, startswith, "haproxy" /var/log/haproxy.log</code> </li> <li>  for complex processing of messages and for fine-tuning of Actions always use RainerScript, without touching the legacy directive like <code>$DoSomething</code> </li></ul><br><p>  More information about the format of the config <a href="http://www.rsyslog.com/doc/v8-stable/configuration/basic_structure.html">here</a> . </p><br><h2 id="obrabotka-soobscheniy">  Message handling </h2><br><ul><li>  All messages come from Input (there may be a lot of them) and get processed by the RuleSet attached to it.  If this is not explicitly specified, then the messages will fall into the RuleSet by default.  All message processing directives that are not rendered into separate RuleSet blocks apply to it.  In particular, it includes all directives from the traditional format of configs: <br> <code>local7.* /var/log/myapp/my.log</code> </li> <li>  A list of parsers is attached to Input to parse the message.  If not explicitly specified, a list of parsers will be used to parse the traditional syslog format. </li><li>  The parser extracts properties from the message.  Most used: <br><ul><li>  <code>$msg</code> - message </li><li>  <code>$rawmsg</code> - the entire message before parser processing </li><li>  <code>$fromhost</code> , <code>$fromhost-ip</code> - DNS name and IP address of the sending host </li><li>  <code>$syslogfacility</code> , <code>$syslogfacility-text</code> - facility in numeric and text form </li><li>  <code>$syslogseverity</code> , <code>$syslogseverity-text</code> - the same for severity </li><li>  <code>$timereported</code> - time from the message </li><li>  <code>$syslogtag</code> - TAG field </li><li>  <code>$programname</code> - TAG field with cut process id: <code>named[12345]</code> -&gt; <code>named</code> </li><li>  the entire list can be found <a href="http://www.rsyslog.com/doc/v8-stable/configuration/properties.html">here</a> </li></ul></li><li>  RuleSet contains a list of rules, the rule consists of a filter and one or more Actions attached to it </li><li>  Filters are logical expressions using message properties.  <a href="http://www.rsyslog.com/doc/v8-stable/configuration/filters.html">More about filters</a> </li><li>  The rules are applied sequentially to the message that entered the RuleSet, the message does not stop at the first rule that was triggered. </li><li>  To stop processing a message, you can use special discard action: <code>stop</code> or <code>~</code> in legacy format. </li><li>  Inside Action, templates are often used.  Templates allow you to generate data for transfer to Action from message properties, for example, the format of a message to transfer over the network or the name of a file to write.  <a href="http://www.rsyslog.com/doc/v8-stable/configuration/templates.html">More about templates</a> </li><li>  Typically, an Action uses an output module ("om ...") or a message modification module ("mm ...").  Here are some of them: <br><ul><li>  <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/omfile.html">omfile</a> - output to file </li><li>  <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/omfwd.html">omfwd</a> - transfer on a network, through udp or tcp </li><li>  <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/omrelp.html">omrelp</a> - send over the network via RELP </li><li>  <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/ommysql.html">onmysql</a> , <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/ompgsql.html">ompgsql</a> , <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/omoracle.html">omoracle</a> - write to database </li><li>  <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/omelasticsearch.html">omelasticsearch</a> - write to ElasticSearch </li><li>  <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/omamqp1.html">omamqp1</a> - transfer via AMQP 1.0 protocol </li><li>  <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/idx_output.html">entire list</a> of output modules </li></ul></li></ul><br><p>  ‚Üí <a href="http://www.rsyslog.com/doc/v8-stable/configuration/basic_structure.html">Learn more about the order of processing messages</a> </p><br><h2 id="primery-konfiguracii">  Configuration examples </h2><br><p>  We record all the messages of the auth and authpriv categories into the <code>/var/log/auth.log</code> file, and continue processing them: </p><br><pre> <code class="plaintext hljs"># legacy auth,authpriv.* /var/log/auth.log #   if ( $syslogfacility-text == "auth" or $syslogfacility-text == "authpriv" ) then { action(type="omfile" file="/var/log/auth.log") }</code> </pre> <br><p>  All messages with the program name starting with "haproxy" are written to the <code>/var/log/haproxy.log</code> file, without flushing the buffer to the disk after writing each message, and stop further processing: </p><br><pre> <code class="plaintext hljs"># legacy (      ,   ) :programname, startswith, "haproxy", -/var/log/haproxy.log &amp; ~ #   if ( $programname startswith "haproxy" ) then { action(type="omfile" file="/var/log/haproxy.log" flushOnTXEnd="off") stop } #   if $programname startswith "haproxy" then -/var/log/haproxy.log &amp;~</code> </pre> <br><p>  <code>rsyslogd -N 1</code> check: <code>rsyslogd -N 1</code> .  More configuration examples: <a href="http://www.rsyslog.com/doc/v8-stable/configuration/examples.html">one</a> , <a href="http://wiki.rsyslog.com/index.php/Configuration_Samples">two</a> . </p><br><h2 id="klient-peresylka-logov-s-sohraneniem-imeni-fayla">  Client: sending logs with saving file name </h2><br><p>  We will save the file names in the <code>TAG</code> field.  I would like to include directories in the names in order not to observe a single-level scattering of files: <code>haproxy/error.log</code> .  If the log is not read from the file, but from the messages sent from the program to the syslog, then it may not agree to write the <code>/</code> symbol to TAG, because it does not conform to the standard.  Therefore, we encode them with double underscores, and on the log server we parse back. </p><br><p>  Create a template for transferring logs over the network.  We want to send messages with tags longer than 32 characters (we have long log names), and transmit a more accurate, than the standard, time stamp indicating the time zone.  In addition, the local variable <code>$.suffix</code> will be added to the name of the log file, later it becomes clear why.  Local variables in RainerScript begin with a dot.  If a variable is not defined, it will expand to an empty string. </p><br><pre> <code class="bash hljs">template (name=<span class="hljs-string"><span class="hljs-string">"LongTagForwardFormat"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"string"</span></span> string=<span class="hljs-string"><span class="hljs-string">"&lt;%PRI%&gt;%TIMESTAMP:::date-rfc3339% %HOSTNAME% %syslogtag%%$.suffix%%msg:::sp-if-no-1st-sp%%msg%"</span></span>)</code> </pre> <br><p>  Now create a RuleSet that will be used to transfer logs over the network.  It can be attached to Input, reading files, or called as a function.  Yes, rsyslog allows you to call one RuleSet from another.  To use RELP, you must first load the appropriate module. </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># http://www.rsyslog.com/doc/relp.html module(load="omrelp") ruleset(name="sendToLogserver") { action(type="omrelp" Target="syslog.example.net" Port="20514" Template="LongTagForwardFormat") }</span></span></code> </pre> <br><p>  Now create an Input that reads the log file and attach this RuleSet to it. </p><br><pre> <code class="bash hljs">input(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"imfile"</span></span> File=<span class="hljs-string"><span class="hljs-string">"/var/log/myapp/my.log"</span></span> Tag=<span class="hljs-string"><span class="hljs-string">"myapp/my.log"</span></span> Ruleset=<span class="hljs-string"><span class="hljs-string">"sendToLogserver"</span></span>)</code> </pre> <br><p>  It should be noted that for each readable file, rsyslog creates state files in its working directory (set by <code>$WorkDirectory</code> directive).  If rsyslog cannot create files there, then the entire log file will be re-transmitted after restarting rsyslog. </p><br><p>  In case some application writes to a common syslog with a certain tag, and we want both to save it to a file and send it over the network: </p><br><pre> <code class="plaintext hljs"># Template to output only message template(name="OnlyMsg" type="string" string="%msg:::drop-last-lf%\n") if( $syslogtag == 'nginx__access:') then { # write to file action(type="omfile" file="/var/log/nginx/access" template="OnlyMsg") # forward over network call sendToLogserver stop }</code> </pre> <br><p>  The last <code>stop</code> needed to stop processing these messages, otherwise they will fall into a common syslog.  By the way, if an application can choose another unix socket for syslog, besides the standard <code>/dev/log</code> (nginx and haproxy can do this), then you can use the <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/imuxsock.html">imuxsock</a> module to make a separate Input for this socket and attach the desired RuleSet to it without general logs flow by tags. </p><br><h4 id="chtenie-log-faylov-zadannyh-cherez-wildcard">  Reading log files specified via wildcard </h4><br><p>  <em>Interlude</em> </p><br><p>  Programmer: I can not find somevendor.log logs for the beginning of last month on the log server, see pliz. <br>  Devops: Uh ... but do we really write such logs?  It‚Äôs necessary to warn.  Well, in any case, everything older than a week has rubbed logrothey, if we didn‚Äôt save it, then it‚Äôs gone. <br>  Programmer: <em>violently indignant</em> <br></p><br><p>  If the application writes a lot of different logs, and sometimes new ones appear, then updating configs every time is inconvenient.  I want to automate it.  The <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/imfile.html">imfile</a> module can read <a href="http://www.rsyslog.com/doc/v8-stable/configuration/modules/imfile.html">wildcard</a> files and save the path to the file in the message's metadata.  True, the path remains complete, and we need only the last component, which we have to get from there.  By the way, this is where the <code>$.suffix</code> variable <code>$.suffix</code> </p><br><pre> <code class="bash hljs">input(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"imfile"</span></span> File=<span class="hljs-string"><span class="hljs-string">"/srv/myapp/logs/*.log"</span></span> Tag=<span class="hljs-string"><span class="hljs-string">"myapp__"</span></span> Ruleset=<span class="hljs-string"><span class="hljs-string">"myapp_logs"</span></span> addMetadata=<span class="hljs-string"><span class="hljs-string">"on"</span></span>) ruleset(name=<span class="hljs-string"><span class="hljs-string">"myapp_logs"</span></span>) { <span class="hljs-comment"><span class="hljs-comment"># http://www.rsyslog.com/doc/v8-stable/rainerscript/functions.html # re_extract(expr, re, match, submatch, no-found) set $.suffix=re_extract($!metadata!filename, "(.*)/([^/]*)", 0, 2, "all.log"); call sendToLogserver }</span></span></code> </pre> <br><p>  Wildcards are supported only in the imfile <code>inotify</code> mode (this is the default mode).  Starting with version 8.25.0, wildcards are supported both in the file name and in the path: / var / log / <em>/</em> .log. </p><br><h4 id="mnogostrochnye-soobscheniya">  Multiline messages </h4><br><p>  For working with log files containing multi-line messages, the imfile module offers three options: </p><br><ul><li>  <code>readMode=1</code> - messages are separated by an empty line </li><li>  <code>readMode=2</code> - new messages start at the beginning of the line, the message continues with an indent.  Often that looks like spectra </li><li>  <code>startmsg.regex</code> - determine the start of a new message on regexp (POSIX Extended) </li></ul><br><p>  The first two options have problems in <code>inotify</code> mode, and if necessary, the third one easily replaces them with the corresponding regexp.  Reading multi-line logs has one subtlety.  Usually, the sign of a new message is at its beginning, and we cannot be sure that the program has finished writing the past message until the following has begun.  Because of this, the last message may never be transmitted.  To avoid this, we set <code>readTimeout</code> , after which the message is considered complete and will be transmitted. </p><br><pre> <code class="bash hljs">input(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"imfile"</span></span> File=<span class="hljs-string"><span class="hljs-string">"/var/log/mysql/mysql-slow.log"</span></span> <span class="hljs-comment"><span class="hljs-comment"># http://blog.gerhards.net/2013/09/imfile-multi-line-messages.html startmsg.regex="^# Time: [0-9]{6}" readTimeout="2" # no need to escape new line for RELP escapeLF="off" Tag=" mysql__slow.log" Ruleset="sendToLogserver")</span></span></code> </pre> <br><h2 id="server">  Server </h2><br><p>  On the server, you must accept the transferred logs and decompose them into directories, in accordance with the IP of the sending host and the time of receipt: <code>/srv/log/192.168.0.1/2017-02-06/myapp/my.log</code> .  In order to set the name of the log file depending on the content of the message, we can also use templates.  The <code>$.logpath</code> variable will need to be set inside the RuleSet before using the template. </p><br><pre> <code class="bash hljs">template(name=<span class="hljs-string"><span class="hljs-string">"RemoteLogSavePath"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"list"</span></span>) { constant(value=<span class="hljs-string"><span class="hljs-string">"/srv/log/"</span></span>) property(name=<span class="hljs-string"><span class="hljs-string">"fromhost-ip"</span></span>) constant(value=<span class="hljs-string"><span class="hljs-string">"/"</span></span>) property(name=<span class="hljs-string"><span class="hljs-string">"timegenerated"</span></span> dateFormat=<span class="hljs-string"><span class="hljs-string">"year"</span></span>) constant(value=<span class="hljs-string"><span class="hljs-string">"-"</span></span>) property(name=<span class="hljs-string"><span class="hljs-string">"timegenerated"</span></span> dateFormat=<span class="hljs-string"><span class="hljs-string">"month"</span></span>) constant(value=<span class="hljs-string"><span class="hljs-string">"-"</span></span>) property(name=<span class="hljs-string"><span class="hljs-string">"timegenerated"</span></span> dateFormat=<span class="hljs-string"><span class="hljs-string">"day"</span></span>) constant(value=<span class="hljs-string"><span class="hljs-string">"/"</span></span>) property(name=<span class="hljs-string"><span class="hljs-string">"$.logpath"</span></span> ) }</code> </pre> <br><p>  Load the required modules and turn off <code>$EscapeControlCharactersOnReceive</code> , otherwise in the received logs all line breaks will be replaced with <code>\n</code> </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Accept RELP messages from network module(load="imrelp") input(type="imrelp" port="20514" ruleset="RemoteLogProcess") # Default parameters for file output. Old-style global settings are not working with new-style actions module(load="builtin:omfile" FileOwner="syslog" FileGroup="adm" dirOwner="syslog" dirGroup="adm" FileCreateMode="0640" DirCreateMode="0755") # Module to remove 1st space from message module(load="mmrm1stspace") # http://www.rsyslog.com/doc/v8-stable/configuration/input_directives/rsconf1_escapecontrolcharactersonreceive.html # Print recieved LF as-it-is, not like '\n'. For multi-line messages # Default: on $EscapeControlCharactersOnReceive off</span></span></code> </pre> <br><p>  Now we will create a RuleSet, which parses the incoming logs and puts them into folders.  Services that rely on logging solely on syslog expect it to save message time.  Therefore, logs arriving from the standard facility will be saved in syslog format, and for local0-local7 arriving from the facility, we will extract the log name from the <code>TAG</code> field and record only the message itself without the remaining syslog fields.  The problem with the space glued to the message remains for RELP, because it occurs even at the stage of parsing messages, we will cut this space. </p><br><p>  To increase performance, we will write asynchronously: <code>asyncWriting="on"</code> and with a large buffer <code>ioBufferSize=64k</code> .  We will not <code>flushOnTXEnd="off"</code> buffer after each received message <code>flushOnTXEnd="off"</code> , but we will do this every second so that the logs appear on the log server fairly quickly: <code>flushInterval="1"</code> . </p><br><pre> <code class="plaintext hljs">ruleset(name="RemoteLogProcess") { # For facilities local0-7 set log filename from $programname field: replace __ with / # Message has arbitary format, syslog fields are not used if ( $syslogfacility &gt;= 16 ) then { # Remove 1st space from message. Syslog protocol legacy action(type="mmrm1stspace") set $.logpath = replace($programname, "__", "/"); action(type="omfile" dynaFileCacheSize="1024" dynaFile="RemoteLogSavePath" template="OnlyMsg" flushOnTXEnd="off" asyncWriting="on" flushInterval="1" ioBufferSize="64k") # Logs with filename defined from facility # Message has syslog format, syslog fields are used } else { if (($syslogfacility == 0)) then { set $.logpath = "kern"; } else if (($syslogfacility == 4) or ($syslogfacility == 10)) then { set $.logpath = "auth"; } else if (($syslogfacility == 9) or ($syslogfacility == 15)) then { set $.logpath = "cron"; } else { set $.logpath ="syslog"; } # Built-in template RSYSLOG_FileFormat: High-precision timestamps and timezone information action(type="omfile" dynaFileCacheSize="1024" dynaFile="RemoteLogSavePath" template="RSYSLOG_FileFormat" flushOnTXEnd="off" asyncWriting="on" flushInterval="1" ioBufferSize="64k") } } # ruleset</code> </pre> <br><h2 id="nadyozhnaya-dostavka-soobscheniy-ocheredi">  Reliable message delivery.  Queues </h2><br><p><img src="https://habrastorage.org/files/531/96b/eb1/53196beb160c48baa0e52ee3472439a5.jpg" alt="image"></p><br><p>  <em>image from the blog <a href="http://www.k-max.name/linux/rsyslog-na-debian-nastrojka-servera/">k-max.name</a></em> </p><br><p>  For some Actions, execution can sometimes slow down or stop, for example, sending logs over the network or writing to the database.  In order not to lose the message and not interfere with the following Actions, you can use <a href="http://www.rsyslog.com/doc/v8-stable/concepts/queues.html">queues</a> .  Each Action is always associated with a message queue, by default it is a zero size Direct Queue.  There is also a main queue for incoming messages from all Input, it can also be configured. </p><br><p>  Types of queues: disk, in-memory, and the most interesting option- combined: Disk-Assisted Memory Queues.  Such queues use memory and begin to use the disk if the queue in memory is full, or you need to save unsent messages while the service is being restarted.  Messages will be recorded to disk when the number of messages in the queue reaches <code>queue.highwatermark</code> , and will stop stored on the disk when their number drops to <code>queue.lowwatermark</code> .  In order for unsent messages to be saved to disk during a service preload, you must specify <code>queue.saveonshutdown="on"</code> . </p><br><p>  If sending logs over the network or writing to the database was unsuccessful, the Action is suspended.  rsyslog tries to resume Action at certain time intervals that increase with each attempt.  To start sending logs shortly after solving problems, you need to set <code>action.resumeRetryCount="-1"</code> (unlimited) and the interval for stopping the queue is smaller: <code>action.resumeInterval="10"</code> .  Read more about the <a href="http://www.rsyslog.com/doc/v8-stable/configuration/actions.html">options Actions</a> . </p><br><p>  RuleSet on the client with the queue will look like this: </p><br><pre> <code class="bash hljs">ruleset(name=<span class="hljs-string"><span class="hljs-string">"sendToLogserver"</span></span>) { <span class="hljs-comment"><span class="hljs-comment"># Queue: http://www.rsyslog.com/doc/v8-stable/concepts/queues.html#disk-assisted-memory-queues # Disk-Assisted Memory Queue: queue.type="LinkedList" + queue.filename # queue.size - max elements in memory # queue.highwatermark - when to start saving to disk # queue.lowwatermark - when to stop saving to disk # queue.saveonshutdown - save on disk between rsyslog shutdown # action.resumeRetryCount - number of retries for action, -1 = eternal # action.resumeInterval - interval to suspend action if destination can not be connected # After each 10 retries, the interval is extended: (numRetries / 10 + 1) * Action.ResumeInterval action(type="omrelp" Target="syslog.example.net" Port="20514" Template="LongTagForwardFormat" queue.type="LinkedList" queue.size="10000" queue.filename="q_sendToLogserver" queue.highwatermark="9000" queue.lowwatermark="50" queue.maxdiskspace="500m" queue.saveonshutdown="on" action.resumeRetryCount="-1" action.reportSuspension="on" action.reportSuspensionContinuation="on" action.resumeInterval="10") }</span></span></code> </pre> <br><p>  Now you can safely reboot the log server - the messages are stored in the queue and will be transmitted when it becomes available. </p><br><p>  <strong>ATTENTION:</strong> When sending messages from the queue after restoring the network, their relative order may be disturbed (thanks to <a href="https://habr.com/ru/users/zystem/" class="user_link">zystem</a> for comment).  The author rsyslog <a href="https://github.com/rsyslog/rsyslog/issues/1400">replied</a> that this is the expected behavior, you can read more here: <a href="http://www.gerhards.net/download/LinuxKongress2010rsyslog.pdf">http://www.gerhards.net/download/LinuxKongress2010rsyslog.pdf</a> (section 7 "Concurrency-related Optimizations").  In short: an attempt to preserve a strict message order during multi-threaded processing of a queue led to a drop in performance due to the need for thread blocking;  the concept of a strict sequence of messages may not make sense for some types of transport, multi-threaded generators and message receivers. </p><br><h2 id="otkazoustoychivost">  fault tolerance </h2><br><p>  You can configure the Action to be executed only if the previous Action has been suspended: <a href="http://www.rsyslog.com/action-execonlywhenpreviousissuspended-preciseness/">description</a> .  This allows you to configure a failover configuration.  Some Actions use transactions to increase performance.  In this case, success or failure will be known only after the completion of the transaction, when the messages have already been processed.  This can lead to the loss of part of the message without calling the failover Action.  To prevent this from happening, you must set the parameter <code>queue.dequeuebatchsize="1"</code> (default 16), which can reduce performance. </p><br><pre> <code class="bash hljs">ruleset(name=<span class="hljs-string"><span class="hljs-string">"sendToLogserver"</span></span>) { action(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"omrelp"</span></span> Target=<span class="hljs-string"><span class="hljs-string">"syslog1.example.net"</span></span> Port=<span class="hljs-string"><span class="hljs-string">"20514"</span></span> Template=<span class="hljs-string"><span class="hljs-string">"LongTagForwardFormat"</span></span>) action(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=<span class="hljs-string"><span class="hljs-string">"omrelp"</span></span> Target=<span class="hljs-string"><span class="hljs-string">"syslog2.example.net"</span></span> Port=<span class="hljs-string"><span class="hljs-string">"20514"</span></span> Template=<span class="hljs-string"><span class="hljs-string">"LongTagForwardFormat"</span></span> action.execOnlyWhenPreviousIsSuspended=<span class="hljs-string"><span class="hljs-string">"on"</span></span> queue.dequeuebatchsize=<span class="hljs-string"><span class="hljs-string">"1"</span></span>) }</code> </pre> <br><p>  I have not tried this opportunity in production yet. </p><br><h2 id="vzaimodeystvie-s-logrotate">  Interaction with logrotate </h2><br><h3 id="logi-kotorye-pishet-sam-rsyslog">  Logs that rsyslog writes </h3><br><p>  Normally rotated using the default <code>smth.log</code> : <code>smth.log</code> renamed to <code>smth.log.1</code> , a new <code>smth.log</code> is created.  In the post-rotate action, you need to send SIGHUP to the rsyslogd process. <strong></strong> : rsyslog      SIGHUP,    -. </p><br><pre> <code class="bash hljs">/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/someapp/*.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>{ weekly missingok rotate 5 create 0644 syslog adm sharedscripts postrotate <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -s run/rsyslogd.pid &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -HUP $(cat /run/rsyslogd.pid) <span class="hljs-comment"><span class="hljs-comment"># postrotate script should always return 0 true endscript }</span></span></code> </pre> <br><h3 id="logi-zapisyvaemye-prilozheniem-i-schityvaemye-rsyslog"> ,     rsyslog </h3><br><p>  ,     (SIGHUP  - ),    . rsyslog   inode    . </p><br><p>     logrotate <code>copytruncate</code> ,   <code>smth.log</code>    <code>smth.log.1</code>      . rsyslog         (  ,       ).    8.16.0,  <code>imfile</code>   <code>reopenOnTruncate</code> (- <code>"off"</code> ,  <code>"on"</code> ).    rsyslog     (inode  ,   ).    "",       .    8.16.0,     <code>copytruncate</code>     SIGHUP  rsyslogd  post-rotate action. </p><br><p> <em></em> :  Debian/Ubuntu       logrotate   ,    ‚Äî   .      <code>/etc/cron.daily/logrotate</code> . </p><br><h2 id="itog">  Total </h2><br><p>      .     ,    syslog.    .  -    .        ,    . </p><br><p>   rsyslog v8,      .  Ubuntu   ppa <a href="https://launchpad.net/~adiscon/%2Barchive/ubuntu/v8-stable">adiscon/v8-stable</a> .  CentOS/RHEL   <a href="http://www.rsyslog.com/rhelcentos-rpms/"> </a> . </p><br><p> <strong>PS</strong> <a href="https://selivan.github.io/2017/02/07/rsyslog-log-forward-save-filename-handle-multi-line-failover.html">    </a> </p><br><p> <strong>UPD:</strong>          ,  <a href="https://habr.com/ru/users/zystem/" class="user_link">zystem</a> . </p><br><p> <strong>UPD2:</strong>      logrotate. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/321262/">https://habr.com/ru/post/321262/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321252/index.html">Tarantool: Good, Bad, Angry</a></li>
<li><a href="../321254/index.html">Pass to the ground - how Apple Pay and Samsung Pay were launched in Yandex.Money</a></li>
<li><a href="../321256/index.html">The logic of consciousness. Part 11. Natural coding of visual and sound information</a></li>
<li><a href="../321258/index.html">ReactOS at FOSDEM 2017</a></li>
<li><a href="../321260/index.html">Procedural level generation for MERC in Unity</a></li>
<li><a href="../321266/index.html">Standard exchange 1C-Bitrix on BASH: Detailed parsing of the script of incremental unloading</a></li>
<li><a href="../321268/index.html">Let's Encrypt and Express. To each server - on the green lock</a></li>
<li><a href="../321270/index.html">How to evaluate big tasks</a></li>
<li><a href="../321274/index.html">Features of the distributed storage architecture in Dropbox</a></li>
<li><a href="../321276/index.html">As we did not go to Y Combinator, ‚Äú... the profit plan is simple - here the drugs are legal, $ 70 cant ...‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>