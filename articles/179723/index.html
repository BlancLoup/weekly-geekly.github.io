<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse AdMob SDK or another way to protect your code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This story began with the news that the Bentley salon opens in Minsk in summer. So I realized that it was time to embed advertising in my second game,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse AdMob SDK or another way to protect your code</h1><div class="post__text post__text-html js-mediator-article">  This story began with the news that the Bentley salon opens in Minsk in summer.  So I realized that it was time to embed advertising in my second game, otherwise I risk to end up in the queue.  I downloaded the latest version of the SDK (6.4.1 at the moment), integrated it into the game, launched it and immediately saw the suspicious lines in logcat <a name="habracut"></a>  : <br><br><pre><code class="java hljs"><span class="hljs-number"><span class="hljs-number">05</span></span>-<span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">06.312</span></span>: D/dalvikvm(<span class="hljs-number"><span class="hljs-number">1379</span></span>): DexOpt: --- BEGIN <span class="hljs-string"><span class="hljs-string">'ads2133480362.jar'</span></span> (bootstrap=<span class="hljs-number"><span class="hljs-number">0</span></span>) --- <span class="hljs-number"><span class="hljs-number">05</span></span>-<span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">06.632</span></span>: D/dalvikvm(<span class="hljs-number"><span class="hljs-number">1413</span></span>): creating instr width table <span class="hljs-number"><span class="hljs-number">05</span></span>-<span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">06.671</span></span>: D/dalvikvm(<span class="hljs-number"><span class="hljs-number">1413</span></span>): DexOpt: load <span class="hljs-number"><span class="hljs-number">2</span></span>ms, verify+opt <span class="hljs-number"><span class="hljs-number">18</span></span>ms <span class="hljs-number"><span class="hljs-number">05</span></span>-<span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">06.703</span></span>: D/dalvikvm(<span class="hljs-number"><span class="hljs-number">1379</span></span>): DexOpt: --- END <span class="hljs-string"><span class="hljs-string">'ads2133480362.jar'</span></span> (success) --- <span class="hljs-number"><span class="hljs-number">05</span></span>-<span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">06.703</span></span>: D/dalvikvm(<span class="hljs-number"><span class="hljs-number">1379</span></span>): DEX prep <span class="hljs-string"><span class="hljs-string">'/data/data/by.squareroot.kingsquare/cache/ads2133480362.jar'</span></span>: unzip in <span class="hljs-number"><span class="hljs-number">0</span></span>ms, rewrite <span class="hljs-number"><span class="hljs-number">391</span></span>ms</code> </pre> <br>  <b>dexopt</b> is a <a href="http://www.netmite.com/android/mydroid/dalvik/docs/dexopt.html">program</a> for checking and optimizing DEX files.  It is not clear why it would work for her, especially after launching the application and with the strange <b>ads2133480362.jar</b> file.  Since I had nothing to do with this file and this was not the case before, all suspicions fell on AdMob.  Apparently, AdMob SDK saves some jar file to the application cache directory, loads classes from there and uses them when loading and displaying banners.  It remains to find out what the AdMob SDK developers are so diligently hiding from us. <br><br><h4>  Reverse AdMob SDK </h4><br>  Of course, the classes in the SDK are obfuscated, but this does not complicate our task very much.  In order to find some starting point, let's look at which classes have a call to the <i>Context.getCacheDir ()</i> method.  They turned out to be a little, just two.  In one of them, this method is used to set <i>WebSettings.setAppCachePath ()</i> , so that there remains only one suspicious class with the name of <b>ak.class</b> that no longer says <b>anything</b> . <br>  Personally, I use <a href="http://java.decompiler.free.fr/">JD</a> for decompilation.  Let's look at the part of the method in this class, where there is a call to <i>Context.getCacheDir ()</i> : 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arrayOfByte1 = an.a(ao.a()); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arrayOfByte2 = an.a(arrayOfByte1, ao.b()); File localFile2 = File.createTempFile(<span class="hljs-string"><span class="hljs-string">"ads"</span></span>, <span class="hljs-string"><span class="hljs-string">".jar"</span></span>, paramContext.getCacheDir()); FileOutputStream localFileOutputStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(localFile2); localFileOutputStream.write(arrayOfByte2, <span class="hljs-number"><span class="hljs-number">0</span></span>, arrayOfByte2.length); localFileOutputStream.close();</code> </pre><br>  If you remove the curse imposed by the evil proguard and rename classes and variables into more understandable ones, you get the following code: <br><br><pre> <code class="java hljs">String keyBase64 = Base64Consts.getKeyBase64(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] keyBytes = Decrypter.decodeKey(keyBase64); String classBase64 = Base64Consts.getClassBase64(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] classBytes = Decrypter.decodeClassBytes(keyBytes, classBase64); File classFile = File.createTempFile(<span class="hljs-string"><span class="hljs-string">"ads"</span></span>, <span class="hljs-string"><span class="hljs-string">".jar"</span></span>, context.getCacheDir()); FileOutputStream out = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(classFile); out.write(classBytes, <span class="hljs-number"><span class="hljs-number">0</span></span>, classBytes.length); out.close();</code> </pre><br>  Now you can disassemble in order, where does the jar-file come from.  The <b>Base64Consts</b> class (formerly <b>ao</b> ) contains strings in Base64 encoding: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Base64Consts</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKeyBase64</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"ARuhFl7nBw/97YxsDjOCIqF0d9D2SpkzcWN42U/KR6Q="</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getClassBase64</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"SuhNEgGjhJl/XS1FVuhqPkUehkYsZY0198PVH9C0C..."</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    ,      } }</span></span></code> </pre><br>  The <b>keyBase64</b> string <b>is</b> turned into a key using the <i>Decrypter.decodeKey ()</i> method: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] decodeKey(String keyBase64) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] keyBytes = Base64Util.decode(keyBase64); ByteBuffer byteBuffer = ByteBuffer.wrap(keyBytes, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] key128 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">16</span></span>]; byteBuffer.get(key128); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; key128.length; i++) { key128[i] = ((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(key128[i] ^ <span class="hljs-number"><span class="hljs-number">0x44</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key128; }</code> </pre><br>  The method decodes a string into an array of bytes (AdMob SDK uses its class for this purpose, since android.util.Base64 appeared only at api level 8) and a block of 16 bytes from the 5th byte is taken from the resulting 32-byte array. .  Every byte is a magic number 0x44.  As a result of these manipulations, a 128-bit AES key is obtained. <br><br>  The <b>classBase64</b> string <b>is</b> converted into a byte array, which is a jar file, using the <i>Decrypter.decodeClassBytes ()</i> method: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] decodeClassBytes(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] keyBytes, String cryptedBytesBase64) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] cryptedBytes = Base64Util.decode(cryptedBytesBase64); ByteBuffer buffer = ByteBuffer.allocate(cryptedBytes.length); buffer.put(cryptedBytes); buffer.flip(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] initializationVector = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] input = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[cryptedBytes.length - <span class="hljs-number"><span class="hljs-number">16</span></span>]; buffer.get(initializationVector); buffer.get(input); SecretKeySpec keySpec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecretKeySpec(keyBytes, <span class="hljs-string"><span class="hljs-string">"AES"</span></span>); Cipher cipher = Cipher.getInstance(<span class="hljs-string"><span class="hljs-string">"AES/CBC/PKCS5Padding"</span></span>); cipher.init(Cipher.DECRYPT_MODE, keySpec, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IvParameterSpec(initializationVector)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cipher.doFinal(input); }</code> </pre><br>  The method decodes a string into an array of bytes, the first 16 bytes in this array is the initialization vector, and the rest is encrypted data.  The output is an array of bytes, which is stored in a jar-file and from which classes are dynamically loaded.  Finally, you can see what's inside. <br><br><h5>  Mysterious ad.jar </h5><br>  To load classes from this jar file, the AdMob SDK uses the <b>DexClassLoader</b> .  Used internally is this: <br><br><pre> <code class="java hljs">DexClassLoader classLoader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DexClassLoader(classFile, context.getCacheDir()), <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, context.getClassLoader()); Class clazz = classLoader.loadClass(b(keyBytes, Base64Consts.getClassNameBase64())); Method m = clazz.getMethod(b(keyBytes, Base64Consts.getMethodNameBase64()), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class[<span class="hljs-number"><span class="hljs-number">0</span></span>]);</code> </pre><br>  After this, the jar file is deleted.  The names of the classes and methods are encrypted in the same way as the jar file itself (Base64 + AES), so it will be faster and easier to immediately look inside the jar file. <br><br>  It is quite expected that the classes.dex file is inside.  <a href="https://code.google.com/p/dex2jar/">Having driven</a> it through <a href="https://code.google.com/p/dex2jar/">dex2jar,</a> we got another jar file, this time with classes. <br><br><h5>  Thank you Mario!  But our princess is in another castle! </h5><br>  Here disappointment awaited me.  Inside it turned out five obfuscated classes that were not anything interesting.  For example, this class: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Long.valueOf(Calendar.getInstance().getTime().getTime() / <span class="hljs-number"><span class="hljs-number">1000L</span></span>); } }</code> </pre><br>  And this: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Build.VERSION(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Build.VERSION.RELEASE; } }</code> </pre><br>  One of the classes takes the value of Settings.Secure.ANDROID_ID and counts it as md5-hash.  Another one considers the SHA-2 hash of the entire apk-file.  Apparently, these parameters are used in requests sent to the server. <br>  In general, no secret algorithms, no hidden messages, nothing.  Why so hide such a trivial code is a mystery to me. <br><br><h4>  A needle in an egg, an egg in a duck ... </h4><br>  Although there was nothing interesting inside, AdMob uses an interesting way to protect its code.  The code is compiled, assembled into a jar-file, the jar-file is converted into a dex-format, the dex-file is packed again into a jar, the jar-file is encrypted with AES and finally encoded with Base64.  In principle, a good way, especially if you get the key from the server. <br><br>  Although it may be that such a clever way will fall under the definition of Dangerous Products from the <a href="https://play.google.com/about/developer-content-policy.html">Google Play Developer Program Policies</a> : <br><blockquote>  Identical app download code for Google Play's update mechanism. </blockquote><br>  In principle, the code changes - a library is formed from the air, from which classes are loaded.  But AdMob can do that for sure. </div><p>Source: <a href="https://habr.com/ru/post/179723/">https://habr.com/ru/post/179723/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179693/index.html">ProfitFest: Samara Internet Workers Festival, June 22-23, 2013</a></li>
<li><a href="../179695/index.html">Sony refill: waterproof Xperia ZR</a></li>
<li><a href="../179701/index.html">KriyaMoney. Part 2. Idea</a></li>
<li><a href="../179705/index.html">Building a decorative transistor computer - step 1</a></li>
<li><a href="../179715/index.html">KriyaMoney. Part 3. Theory</a></li>
<li><a href="../179725/index.html">Corporate Cluster. Thinking out loud</a></li>
<li><a href="../179731/index.html">Errors in the implementation of the Corporate Portal or electronic document management</a></li>
<li><a href="../179733/index.html">How i was point</a></li>
<li><a href="../179735/index.html">0day vulnerability in Linux from 2.6.37 to 3.8.10</a></li>
<li><a href="../179739/index.html">The history of the creation of Diablo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>