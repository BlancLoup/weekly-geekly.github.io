<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Amazon EC2 Autoscale Load Balancer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many people know that Amazon provides the ability to automatically increase the power of your pool (increase the number of virtual servers) depending ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Amazon EC2 Autoscale Load Balancer</h1><div class="post__text post__text-html js-mediator-article">  Many people know that Amazon provides the ability to automatically increase the power of your pool (increase the number of virtual servers) depending on the load.  However, I could not find an explanatory description of the practical implementation of such a scheme in the Russian-speaking segment of the network.  I would venture to present to the public the result of my studies on this topic. <br><br>  So, the input data.  Our server, judging by the attendance curve, will soon begin to experience very severe loads, especially at peak times.  To efficiently handle the traffic, as well as to avoid denial of service, it was decided to use the mechanisms provided by Amazon, which allow the necessary number of servers to be started in real time.  At the same time, when the load decreases, the resulting pool should ‚Äúslow down‚Äù, automatically decreasing in size, and thereby reduce the financial costs of the project. <br><br><a name="habracut"></a><br>  For all this, we picked up a virtual server (EC2 instance in Amazon terminology, then I will sometimes use a vulgar tracing from English - ‚Äúinstance‚Äù), on which we configured all the necessary software.  It is important that everything be done so that the software does not need any additional configuration, and such identical machines could be started as much as necessary, without causing any conflicts, because the instance starts from the finished fixed impression.  Such a server in our project will serve as a multiple front-end, on which the load will be balanced by means of Amazon, while the database is stored separately, and the content of users (for example, uploaded photos and avatars) is generally stored on Amazon S3. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Well, we believe that the reference front-end is ready for us, we can proceed. <br><br>  This is how the scheme will look like from a certain distance: <br><img src="http://s2.ipicture.ru/uploads/20120120/8VIT26Si.gif" alt="image"><br><br><h4>  1. First, <b>remove the image from the reference instance</b> </h4><br>  The quickest way to do this is through the AWS management console, i.e.  via web interface.  To do this, go to the menu item ELASTIC BLOCK STORE -&gt; Snapshots and take a new snapshot from the volume of our front-end.  Then, by right-clicking on the resulting snapshot, select the item ‚ÄúCreate image from snapshot‚Äù to get an image (so-called AMI) for further cloning.  When creating an AMI, it is important to specify the correct (same as in the reference instance) Kernel ID, otherwise there is a chance that AMI will simply not start. <br><br><h4>  2. <b>Install the necessary tools</b> for working with balancer and autoscaling </h4><br>  Actually, you can manage your farm absolutely from any computer, we chose one of the servers with Ubuntu for ourselves, so I‚Äôll give examples of settings for this OS. <br><br><h5>  2.1.  <b>Put java</b> (if not already installed) and write the JAVA_HOME environment variable </h5><br><pre> <code class="hljs swift"><code class="bash">apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-jdk</code></code> </pre> <br><br>  Add a line to / etc / environment (in this case) <br><pre> <code class="hljs objectivec"><code class="bash">JAVA_HOME=<span class="hljs-string"><span class="hljs-string">"/usr/lib/jvm/java-6-openjdk"</span></span></code></code> </pre> <br><br>  Next, we put the Amazon toolkit.  I put it in the / opt directory, and make symbolic links to make it easier to find the necessary folders in the future, but this is of course a matter of taste. <br><br><h5>  2.2.  <b>Let's put the Amazon toolkit to adjust the balancer</b> </h5><br><pre> <code class="hljs nginx"><code class="bash"><span class="hljs-attribute"><span class="hljs-attribute">wget</span></span> http://ec2-downloads.s3.amazonaws.com/ElasticLoadBalancing.zip unzip ElasticLoadBalancing.zip mv ElasticLoadBalancing-<span class="hljs-number"><span class="hljs-number">1.0.15.1</span></span> /opt/ ln -s /opt/ElasticLoadBalancing-<span class="hljs-number"><span class="hljs-number">1.0.15.1</span></span> /opt/ELB</code></code> </pre> <br><br>  Add environment variables (I do this by editing / etc / environment) <br>  in the PATH variable you need to add the path "/ opt / ELB: / opt / ELB / bin" <br><br>  Add AWS_ELB_HOME variable there: <br><pre> <code class="hljs objectivec"><code class="bash">AWS_ELB_HOME=<span class="hljs-string"><span class="hljs-string">"/opt/ELB"</span></span></code></code> </pre> <br><br>  Create a file / opt / ELB / credential-file, where to put your AWS credentials (if you do not know what it is - see AWS management console -&gt; Security credentials) in the format: <br><pre> <code class="hljs"><code class="bash">AWSAccessKeyId=xxx AWSSecretKey=xxx</code></code> </pre> <br><br><pre> <code class="hljs perl"><code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">chmod</span></span> <span class="hljs-number"><span class="hljs-number">600</span></span> /opt/ELB/credential-file</code></code> </pre> <br><br>  Add in / etc / environment the variable AWS_CREDENTIAL_FILE: <br><pre> <code class="hljs objectivec"><code class="bash">AWS_CREDENTIAL_FILE=<span class="hljs-string"><span class="hljs-string">"/opt/ELB/credential-file"</span></span></code></code> </pre> <br><br><h5>  2.3.  <b>Install Amazon Toolkit for Autoscaling</b> </h5><br><pre> <code class="hljs nginx"><code class="bash"><span class="hljs-attribute"><span class="hljs-attribute">wget</span></span> http://ec2-downloads.s3.amazonaws.com/AutoScaling-2011-01-01.zip unzip AutoScaling-<span class="hljs-number"><span class="hljs-number">2011</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>.zip mv AutoScaling-<span class="hljs-number"><span class="hljs-number">1.0.39.0</span></span> /opt/ ln -s /opt/AutoScaling-<span class="hljs-number"><span class="hljs-number">1.0.39.0</span></span>/ /opt/AS</code></code> </pre><br><br>  Add environment variables in / etc / environment - the path "/ opt / AS: / opt / AS / bin" must be added to the PATH variable <br><br>  Add the AWS_AUTO_SCALING_HOME variable there: <br><pre> <code class="hljs objectivec"><code class="bash">AWS_AUTO_SCALING_HOME=<span class="hljs-string"><span class="hljs-string">"/opt/AS"</span></span></code></code> </pre> <br><br><h5>  2.4.  <b>Install Amazon Toolkit for Monitoring Settings.</b> </h5><br><pre> <code class="hljs nginx"><code class="bash"><span class="hljs-attribute"><span class="hljs-attribute">wget</span></span> http://ec2-downloads.s3.amazonaws.com/CloudWatch-2010-08-01.zip unzip CloudWatch-<span class="hljs-number"><span class="hljs-number">2010</span></span>-<span class="hljs-number"><span class="hljs-number">08</span></span>-<span class="hljs-number"><span class="hljs-number">01</span></span>.zip mv CloudWatch-<span class="hljs-number"><span class="hljs-number">1.0.12.1</span></span> /opt/ ln -s /opt/CloudWatch-<span class="hljs-number"><span class="hljs-number">1.0.12.1</span></span>/ /opt/CW</code></code> </pre> <br><br>  Add environment variables in / etc / environment - add the path "/ opt / CW: / opt / CW / bin" to the PATH variable <br><br>  Add the AWS_CLOUDWATCH_HOME variable there: <br><pre> <code class="hljs objectivec"><code class="bash">AWS_CLOUDWATCH_HOME=<span class="hljs-string"><span class="hljs-string">"/opt/CW"</span></span></code></code> </pre> <br><br><h5>  2.5.  <b>Checking the installed toolkit</b> </h5><br>  To check the variables set in / etc / environment, you can re-login or re-read them in any way. <br>  We give commands: <br><pre> <code class="hljs dos"><code class="bash">elb-<span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">help</span></span></code></code> </pre> <br><pre> <code class="hljs pgsql"><code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-cmd <span class="hljs-comment"><span class="hljs-comment">--help</span></span></code></code> </pre> <br><pre> <code class="hljs dos"><code class="bash">mon-<span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">help</span></span></code></code> </pre> <br>  Each of them must issue a certificate, or if there were any errors during installation, point them out. <br><br><h4>  3. Let's go.  Actually <b>configure the load balancer with autoscaling</b> </h4><br><h5>  3.1.  <b>We create a balancer</b> </h5><br><br><pre> <code class="hljs pgsql"><code class="bash">elb-<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>-lb myLB <span class="hljs-comment"><span class="hljs-comment">--headers --listener "lb-port=80,instance-port=80,protocol=http" --region us-west-1 --availability-zones us-west-1c</span></span></code></code> </pre> <br><br>  Where myLB is the name of our balancer <br>  --listener "lb-port = 80, instance-port = 80, protocol = http" - listen to port 80, send traffic to port 80 on the target instance and use the http protocol <br>  --region us-west-1 region, where the balancer will be raised <br>  --availability-zones us-west-1c zone where the balancer will be raised <br><br>  In response, we get something like: <br><pre> <code class="hljs css"><code class="bash"><span class="hljs-selector-tag"><span class="hljs-selector-tag">DNS_NAME</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DNS_NAME</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DNS_NAME</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">myLB-108660279</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.us-west-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.elb</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.amazonaws</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span></code></code> </pre><br>  This is the address of our future balancer. <br><br><h5>  3.2.  <b>Create a validation test for the balancer</b> (healthcheck) </h5><br>  This is a test by which the balancer understands that the target instance is already heavily loaded and transfers traffic to the next instance. <br><pre> <code class="hljs cmake"><code class="bash">elb-configure-healthcheck myLB --headers --<span class="hljs-keyword"><span class="hljs-keyword">target</span></span> <span class="hljs-string"><span class="hljs-string">"HTTP:80/"</span></span> --interval <span class="hljs-number"><span class="hljs-number">30</span></span> --timeout <span class="hljs-number"><span class="hljs-number">10</span></span> --unhealthy-threshold <span class="hljs-number"><span class="hljs-number">2</span></span> --healthy-threshold <span class="hljs-number"><span class="hljs-number">2</span></span> --region us-west-<span class="hljs-number"><span class="hljs-number">1</span></span></code></code> </pre> <br><br>  where myLB is the name of our balancer <br>  --headers is an optional parameter that includes the display of field names in the description of this healthchek <br>  --target "HTTP: 80 /" - protocol: port / URI to check <br>  --interval 30 - check interval (check every 30 seconds) <br>  --timeout 10 - timeout, if exceeded - the instance feels rather bad <br>  --unhealthy-threshold 2 - how many checks to do before finally making sure that the instance is unhealthy <br>  --healthy-threshold 2 - how many checks to do before finally making sure that the instance is healthy <br>  --region us-west-1 - location <br><br>  If the command is successful, we will get something like this: <br><pre> <code class="hljs pgsql"><code class="bash">HEALTH_CHECK TARGET <span class="hljs-type"><span class="hljs-type">INTERVAL</span></span> TIMEOUT HEALTHY_THRESHOLD UNHEALTHY_THRESHOLD HEALTH_CHECK HTTP:<span class="hljs-number"><span class="hljs-number">80</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span></code></code> </pre><br><br><h5>  3.3.  <b>Create a configuration for launching a new instance</b> when autoscaling </h5><br><pre> <code class="hljs mel"><code class="bash">as-create-<span class="hljs-keyword"><span class="hljs-keyword">launch</span></span>-config myAS --<span class="hljs-keyword"><span class="hljs-keyword">image</span></span>-id ami-fd015fb8 --kernel aki<span class="hljs-number"><span class="hljs-number">-9</span></span>ba0f1de --key ubuntu --<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> ubuntu-new --region us-west<span class="hljs-number"><span class="hljs-number">-1</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>-type m1.xlarge</code></code> </pre> <br><br>  Where myAS is the configuration name <br>  --image-id XXX - ID of the nugget (AMI) created in step 1 <br>  --kernel XXX - Kernel ID for AMI created in step 1 <br>  --key XXX - the name of your access key <br>  --group XXX - the name of the security group - a set of firewall rules for access to this instance <br>  --instance-type XXX - type of instance launched <br>  --region us-west-1 - region <br><br>  In the case of a successful configuration, we get the following output: <br><pre> <code class="hljs lua"><code class="bash">OK-Created launch <span class="hljs-built_in"><span class="hljs-built_in">config</span></span></code></code> </pre> <br><br><h5>  3.4.  <b>We describe the properties of the server pool during autoscaling, bind the pool to the balancer</b> </h5><br><pre> <code class="hljs mel"><code class="bash">as-create-auto-scaling-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> myASG --<span class="hljs-keyword"><span class="hljs-keyword">launch</span></span>-configuration myAS --availability-zones us-west<span class="hljs-number"><span class="hljs-number">-1</span></span>c --<span class="hljs-keyword"><span class="hljs-keyword">min</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> --load-balancers myLB --grace-period <span class="hljs-number"><span class="hljs-number">500</span></span> --health-check-type ELB --region us-west<span class="hljs-number"><span class="hljs-number">-1</span></span></code></code> </pre> <br><br>  Where myASG is the pool name <br>  --launch-configuration myAS - the configuration name to run from the previous step <br>  --min-size 1 - minimum pool size <br>  --max-size 20 max pool size <br>  --load-balancers myLB - binding to balancer <br>  --grace-period 300 is an important parameter that indicates how many seconds after the start of a new instance it can be loaded.  For example, after the start, I have a deployment application, so this period is quite long <br>  --health-check-type ELB is a healthchek type, in our case Elastic Load Balancer <br>  --region us-west-1 - location <br>  --availability-zones us-west-1c - zone <br><br><h5>  3.5.  <b>We describe the growth policy of the pool</b> </h5><br><pre> <code class="hljs pgsql"><code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-put-scaling-<span class="hljs-keyword"><span class="hljs-keyword">policy</span></span> myUp-<span class="hljs-keyword"><span class="hljs-keyword">policy</span></span> -auto-scaling-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> myASG <span class="hljs-comment"><span class="hljs-comment">--adjustment=1 --type ChangeInCapacity --cooldown 300 --region us-west-1</span></span></code></code> </pre> <br><br>  Where myUp-policy is the name of the policy <br>  -auto-scaling-group myASG - name of the server pool to which the policy will apply <br>  --type ChangeInCapacity - type of policy.  In this case, the absolute change in the number of servers in the pool.  It can also take the values ‚Äã‚ÄãExactCapacity (the exact value of the new pool size), PercentChangeInCapacity (percentage of the current value of the change in the size of the pool). <br>  --adjustment = 1 - in this case we add one server to the pool <br>  --cooldown 600 - timeout before the next pool size change.  It should reasonably correlate with the grace-period parameter (at least be no less) specified in the previous step. <br>  --region us-west-1 region of placement <br><br>  In response, we get a line - a handle to this policy, something like this: <br><pre> <code class="hljs pgsql"><code class="bash">arn:aws:autoscaling:us-west<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-number"><span class="hljs-number">033313991904</span></span>:scalingPolicy:<span class="hljs-number"><span class="hljs-number">5</span></span>ae9e75d<span class="hljs-number"><span class="hljs-number">-4344</span></span><span class="hljs-number"><span class="hljs-number">-4</span></span>b3f-abb0-c501c7221ecf:autoScalingGroupName/myASG:policyName/myUp-<span class="hljs-keyword"><span class="hljs-keyword">policy</span></span></code></code> </pre> <br><br><h5>  3.6.  <b>Bind pool growth policy to balancer monitoring</b> </h5><br><pre> <code class="hljs perl"><code class="bash">mon-put-metric-<span class="hljs-keyword"><span class="hljs-keyword">alarm</span></span> MyHighLatAlarm --metric-name Latency --comparison-operator GreaterThanThreshold --evaluation-periods <span class="hljs-number"><span class="hljs-number">1</span></span> --namespace <span class="hljs-string"><span class="hljs-string">"AWS/ELB"</span></span> --period <span class="hljs-number"><span class="hljs-number">60</span></span> --statistic Average --threshold <span class="hljs-number"><span class="hljs-number">80</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">alarm</span></span>-actions arn:aws:autoscaling:us-west-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">033313</span></span>991904:scalingPolicy:<span class="hljs-number"><span class="hljs-number">5</span></span>ae9e75d-<span class="hljs-number"><span class="hljs-number">4344</span></span>-<span class="hljs-number"><span class="hljs-number">4</span></span>b3f-abb<span class="hljs-number"><span class="hljs-number">0</span></span>-c501c7221ecf:autoScalingGroupName/myASG:policyName/myUp-policy --dimensions <span class="hljs-string"><span class="hljs-string">"LoadBalancerName=myELB"</span></span>--unit Seconds --region us-west-<span class="hljs-number"><span class="hljs-number">1</span></span></code></code> </pre> <br><br>  Where MyHighLatAlarm is the name of the binding <br>  --metric-name Latency is an important parameter.  We show that we are actually measuring the delay on the balancer.  This metric was created when the balancer was created automatically.  (which can be verified by checking the output of the mon-list-metrics command). <br>  --comparison-operator GreaterThanThreshold is a comparison operator, in this case ‚Äúgreater than a threshold value‚Äù, may also be ‚ÄúGreaterThanOrEqualToThreshold‚Äù, LessThanThreshold ‚Äùand‚Äú LessThanOrEqualToThreshold ‚Äù <br>  --evaluation-periods 1 - how many times to check the metric before comparing with the threshold <br>  --namespace "AWS / EC2" - namespace (required parameter, why it is not clear) <br>  --period 60 survey period <br>  --statistic average - how we measure the threshold.  In this case, by the average, and maybe also ‚ÄúSampleCount‚Äù, ‚ÄúSum‚Äù, ‚ÄúMinimum‚Äù, ‚ÄúMaximum‚Äù <br>  --threshold 80 is the delay threshold itself. <br>  --alarm-actions arn: aws: autoscaling: us-west-1: 033313991904: scalingPolicy: 5ae9e75d-4344-4b3f-abb0-c501c7221ecf: autoScalingGroupName / myASG: policyName / myUp-policy - saying that to achieve the threshold execute policy, described by this descriptor that we created in the previous step. <br>  --dimensions "LoadBalancerName = myLB" - we filter the alarms on this basis. <br>  --unit Seconds - units of measurement <br>  --region us-west-1 - location region. <br><br>  Uff.  Now we have a pool that will respond to the load, adding one server at a time.  However, it would be desirable for the pool to ‚Äúdeflate‚Äù in response to a decrease in load.  To do this, we need to describe the pool reduction policy and bind it to the balancer metric.  I will not repeat the details, everything seems to be clear from the syntax: <br><br><h5>  3.7.  <b>Describe the pool reduction policy</b> </h5><br><pre> <code class="hljs pgsql"><code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-put-scaling-<span class="hljs-keyword"><span class="hljs-keyword">policy</span></span> myScaleDown-<span class="hljs-keyword"><span class="hljs-keyword">policy</span></span> <span class="hljs-comment"><span class="hljs-comment">--auto-scaling-group myASG --adjustment=-1 --type ChangeInCapacity --cooldown 600 --region us-west-1</span></span></code></code> </pre> <br><br>  We get the policy descriptor: <br><pre> <code class="hljs ruby"><code class="bash"><span class="hljs-symbol"><span class="hljs-symbol">arn:</span></span><span class="hljs-symbol"><span class="hljs-symbol">aws:</span></span><span class="hljs-symbol"><span class="hljs-symbol">autoscaling:</span></span>us-west-<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">033313</span></span>991904<span class="hljs-symbol"><span class="hljs-symbol">:scalingPolicy</span></span><span class="hljs-symbol"><span class="hljs-symbol">:a764b4d4-aff5-</span></span><span class="hljs-number"><span class="hljs-number">4061</span></span>-ba3a-<span class="hljs-symbol"><span class="hljs-symbol">c35c05ad1d25:</span></span>autoScalingGroupName/<span class="hljs-symbol"><span class="hljs-symbol">myASG:</span></span>policyName/myScaleDown-policy</code></code> </pre> <br><br><h5>  3.8.  <b>Bind a pool reduction policy to balancer monitoring</b> </h5><br><pre> <code class="hljs ruby"><code class="bash">mon-put-metric-alarm MyLowLatAlarm --comparison-operator LessThanThreshold --evaluation-periods <span class="hljs-number"><span class="hljs-number">1</span></span> --metric-name Latency --namespace <span class="hljs-string"><span class="hljs-string">"AWS/EC2"</span></span> --period <span class="hljs-number"><span class="hljs-number">600</span></span> --statistic Average --threshold <span class="hljs-number"><span class="hljs-number">20</span></span> --alarm-actions <span class="hljs-symbol"><span class="hljs-symbol">arn:</span></span><span class="hljs-symbol"><span class="hljs-symbol">aws:</span></span><span class="hljs-symbol"><span class="hljs-symbol">autoscaling:</span></span>us-west-<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">033313</span></span>991904<span class="hljs-symbol"><span class="hljs-symbol">:scalingPolicy</span></span><span class="hljs-symbol"><span class="hljs-symbol">:a764b4d4-aff5-</span></span><span class="hljs-number"><span class="hljs-number">4061</span></span>-ba3a-<span class="hljs-symbol"><span class="hljs-symbol">c35c05ad1d25:</span></span>autoScalingGroupName/<span class="hljs-symbol"><span class="hljs-symbol">myASG:</span></span>policyName/myScaleDown-policy ---dimensions <span class="hljs-string"><span class="hljs-string">"LoadBalancerName=myLB"</span></span> --unit Seconds --region us-west-<span class="hljs-number"><span class="hljs-number">1</span></span></code></code> </pre> <br><br><h4>  4. <b>Contact the balancer</b> by name and patronymic. </h4><br>  Great.  Now you can test the whole thing, referring to our balancer according to its public DNS name obtained in step 3.1., In our case <a href="http://mylb-108660279.us-west-1.elb.amazonaws.com/">myLB-108660279.us-west-1.elb.amazonaws.com</a> <br><br>  Amazon advises then make a CNAME DNS record indicating the given name for your site's domain: <br><pre> <code class="hljs css"><code class="bash"><span class="hljs-selector-tag"><span class="hljs-selector-tag">www</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.site</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IN</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">CNAME</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">myLB-108660279</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.us-west-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.elb</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.amazonaws</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span></code></code> </pre> <br>  Then you can get on the balancer, simply referring to <a href="http://www.site.com/">www.site.com</a> <br><br><h4>  5. <b>How do we get rid of all this?</b> </h4><br>  Now a few words about how to disassemble this structure (when you play enough with the test version for example), so that it does not eat money in vain (albeit small, but still).  This suddenly turned out to be a nontrivial task, since  the balancer with scaling did not allow itself to be disassembled, constantly producing new instances and not letting the balancer quench while those same instances hung behind it.  In general, the correct sequence of actions was as follows: <br><br>  get a list of our alarms: <br><pre> <code class="hljs sql"><code class="bash">mon-<span class="hljs-keyword"><span class="hljs-keyword">describe</span></span>-alarms <span class="hljs-comment"><span class="hljs-comment">--region us-west-1</span></span></code></code> </pre> <br><br>  Let's clean them one by one: <br><pre> <code class="hljs perl"><code class="bash">mon-<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>-alarms --region us-west-<span class="hljs-number"><span class="hljs-number">1</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">alarm</span></span>-name MyHighLatAlarm mon-<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>-alarms --region us-west-<span class="hljs-number"><span class="hljs-number">1</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">alarm</span></span>-name MyLowLatAlarm</code></code> </pre> <br><br>  Get a list of our policies: <br><pre> <code class="hljs pgsql"><code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-describe-policies <span class="hljs-comment"><span class="hljs-comment">--region us-west-1</span></span></code></code> </pre> <br><br>  Let's clean them one by one: <br><pre> <code class="hljs pgsql"><code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">policy</span></span> myScaleDown-<span class="hljs-keyword"><span class="hljs-keyword">policy</span></span> <span class="hljs-comment"><span class="hljs-comment">--auto-scaling-group myASG --region us-west-1 as-delete-policy myUp-policy --auto-scaling-group myASG --region us-west-1</span></span></code></code> </pre> <br><br>  Here it is, a trick.  First it turns out that the group size should be set to zero so that the instances are not undermined: <br><pre> <code class="hljs mel"><code class="bash">as-update-auto-scaling-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> myASG --<span class="hljs-keyword"><span class="hljs-keyword">min</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> --region us-west<span class="hljs-number"><span class="hljs-number">-1</span></span></code></code> </pre> <br><br>  Now we will wait about five minutes until all the instances have gone out and delete the pool: <br><pre> <code class="hljs pgsql"><code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>-auto-scaling-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> myASG <span class="hljs-comment"><span class="hljs-comment">--region us-west-1</span></span></code></code> </pre> <br><br>  Delete the configuration: <br><pre> <code class="hljs pgsql"><code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>-launch-config myAS <span class="hljs-comment"><span class="hljs-comment">--region us-west-1</span></span></code></code> </pre> <br><br>  Well, finally extinguish the balancer: <br><pre> <code class="hljs pgsql"><code class="bash">elb-<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>-lb myLB <span class="hljs-comment"><span class="hljs-comment">--region us-west-1</span></span></code></code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/136827/">https://habr.com/ru/post/136827/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136818/index.html">eBayWorld - shopping service in any foreign online stores!</a></li>
<li><a href="../136819/index.html">Droider Show # 24. Mao Tablet</a></li>
<li><a href="../136821/index.html">Phone contests Imagine Cup 2012</a></li>
<li><a href="../136823/index.html">Kinect + GlovePIE or how to start developing for games</a></li>
<li><a href="../136826/index.html">Linux privilege escalation> = 2.6.39</a></li>
<li><a href="../136828/index.html">Implementing Iterators in C # (Part 1)</a></li>
<li><a href="../136829/index.html">Types of instance in amazon ec2</a></li>
<li><a href="../136830/index.html">Imaginary personalities. How to create your twins for the good</a></li>
<li><a href="../136831/index.html">Every fifth American now has a tablet</a></li>
<li><a href="../136833/index.html">Authorization on the site using phpBB / XenForo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>