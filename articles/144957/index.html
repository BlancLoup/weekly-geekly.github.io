<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>There is no reception against scrap: OpenJDK hack vs. Class Encryption</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The purpose of this article is to prevent developers from using class-file encryption tools for obfuscators to protect their applications and from was...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>There is no reception against scrap: OpenJDK hack vs. Class Encryption</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/a48/bec/b60/a48becb603f9283d91791648601debe6.png">  The purpose of this article is to prevent developers from using class-file encryption tools for obfuscators to protect their applications and from wasting money on them. <br>  Issues of protecting bytecode from reverse engineering and circumventing this protection are discussed in detail in Dmitry Leskov's fundamental work - <a href="http://www.excelsior-usa.com/articles/java-obfuscators.html">Protect Your Java Code - Through Obfuscators And Beyond</a> . <br>  The class-file encryption mechanism assumes that the contents of the classes are stored in an encrypted form, and when the application starts via a specialized ClassLoader or JVMTI interface, the decrypted bytecode is loaded into the Java virtual machine. <br><a name="habracut"></a><br>  Methods for circumventing such protection are mentioned in detail in the above article, fortunately or unfortunately, there are a number of products that include a native component that interacts with the JVM and tracks debug mode or the presence of foreign agents.  But this, despite all the assurances of the developers of such products, does not protect your byte code at all. <br><br>  In order to demonstrate the vulnerability of ALL obfuscators that encrypt class files, it is enough to launch the application protected by them with the -XX: + TraceClassLoading option and make sure that all encrypted class files are safely seen at this JVM trace level.  We will go further, take the source OpenJDK and insert the unloading of the byte-code of the loaded class-files. <br><br>  For the experiment, we will use Debian Linux 6.0.5 (Stable) and the OpenJDK7 source bundle.  Instructions for installing JDK from source codes on other platforms are available here: <a href="http://hg.openjdk.java.net/jdk7/build/raw-file/tip/README-builds.html">OpenJDK Build README</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order to minimize the number of changes to the OpenJDK source code, we will, when the -XX option is enabled: + TraceClassLoading, save the byte code of all loaded classes to the class.dump file relative to the working directory.  The file structure is as follows: <br><br><pre><code class="hljs cs">{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lengthClassName, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] className, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lengthByteCode, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytecode }, { next record ‚Ä¶ }, ‚Ä¶</code> </pre> <br><br>  Prepare the environment for the assembly: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get install openjdk-6-jdk # apt-get build-dep openjdk-6</span></span></code> </pre><br>  Next, you need to download the OpenJDK source code that is convenient for you and our <a href="https://licel.ru/wp-content/uploads/openjdk-classFileParser.patch">patch</a> , which will add the following code to the ClassFileParser :: parseClassFile function, to the hotspot / src / share / vm / classfile / classFileParser.cpp file: <br><br><pre> <code class="hljs perl">      // dumping class bytecode      // <span class="hljs-keyword"><span class="hljs-keyword">dump</span></span> file <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>:      <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> of the class name - <span class="hljs-number"><span class="hljs-number">4</span></span> bytes      // class name      // <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> of the class bytecode - <span class="hljs-number"><span class="hljs-number">4</span></span> bytes      // byte code      // ... <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> class ...  ClassFileStream* cfs = stream();  FILE * pFile;  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> = cfs-&gt;<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>();  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nameLength = strlen(this_klass-&gt;external_name());  pFile = fopen(<span class="hljs-string"><span class="hljs-string">"classes.dump"</span></span>,<span class="hljs-string"><span class="hljs-string">"ab"</span></span>);  <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> size of the class name  fputc((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((nameLength &gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span>) &amp; 0XFF), pFile );  fputc((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((nameLength &gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span>) &amp; 0XFF), pFile );  fputc((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((nameLength &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) &amp; 0XFF), pFile );  fputc((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(nameLength &amp; 0XFF), pFile );      <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> class name  fwrite (this_klass-&gt;external_name() , <span class="hljs-number"><span class="hljs-number">1</span></span>, nameLength, pFile );  <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> size of the class bytecode  fputc((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((<span class="hljs-keyword"><span class="hljs-keyword">length</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span>) &amp; 0XFF), pFile );  fputc((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((<span class="hljs-keyword"><span class="hljs-keyword">length</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span>) &amp; 0XFF), pFile );  fputc((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((<span class="hljs-keyword"><span class="hljs-keyword">length</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) &amp; 0XFF), pFile );  fputc((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">length</span></span> &amp; 0XFF), pFile );      <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> class bytecode  fwrite (cfs-&gt;buffer() , <span class="hljs-number"><span class="hljs-number">1</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">length</span></span>, pFile );  fclose(pFile);</code> </pre><br><br>  Make sure the JDK is going fine: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># export LANG=C ALT_BOOTDIR=/usr/lib/jvm/java-6-openjdk ALLOW_DOWNLOADS=true # make sanity &amp;&amp; make</span></span></code> </pre><br>  Apply the patch and run the build <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd $OPENJDK_SRC # patch -p1 &lt; $PATH_TO_PATCH_FILE # make</span></span></code> </pre><br>  Next, go to the bin directory of the compiled JRE: $ OPENJDK_SRC / build / linux-i586 / j2re-image / bin / <br>  To test the performance of java run with a single parameter -XX: + TraceClassLoading: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ./java -XX:+TraceClassLoading</span></span></code> </pre><br>  And look at classes.dump, it will contain all the class files that the JRE loads at startup. <br><br>  And now the most interesting, let's take a Java-application with an encrypted byte-code, for example, you can use some kind of obfuscator with this function.  For obvious reasons, I will not mention specific names, it is enough to search Google for the key ‚Äúbyte-code encryption‚Äù.  Inside SomeClassGuard.jar, the com / **** / someclassguard / engine hierarchy contains encrypted class files; you can verify this by installing any decompiler yourself or look in the HEX viewer for the file header. <br><br>  Now run SomeClassGuard.jar: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ./java -XX:+TraceClassLoading -jar SomeClassGuard.jar</span></span></code> </pre><br>  Next, we need to unpack the classes.dump file obtained after running SomeClassGuard.jar, for this we will write a small Java program: <br><br><pre> <code class="hljs pgsql">package openjdkmod; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.DataInputStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.EOFException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.File; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.FileInputStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.FileNotFoundException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.FileOutputStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-comment"><span class="hljs-comment">/** * Classes dump format extractor class. * Author Ivan Kinash kinash@licel.ru */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ClassesDumpExractor {   <span class="hljs-comment"><span class="hljs-comment">/**    * Extract contents classes.dump to specified dir    */</span></span>   <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> main(String[] args) throws FileNotFoundException, IOException {       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (args.length != <span class="hljs-number"><span class="hljs-number">2</span></span>) {           <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.err.println("Usage openjdkmod.ClassesDumpExtractor &lt;classes.dump file&gt; &lt;out dir&gt;");           <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">-1</span></span>);       }       File classesDumpFile = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> File(args[<span class="hljs-number"><span class="hljs-number">0</span></span>]);       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!classesDumpFile.<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>()) {           <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.err.println("Source file: " + args[<span class="hljs-number"><span class="hljs-number">0</span></span>] + " not found!");           <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">-1</span></span>);       }       File outDir = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> File(args[<span class="hljs-number"><span class="hljs-number">1</span></span>]);       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!outDir.<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>()) {           outDir.mkdirs();       }       DataInputStream din = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DataInputStream(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FileInputStream(classesDumpFile));       <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) {           try {               <span class="hljs-type"><span class="hljs-type">int</span></span> classNameLength = din.readInt();               byte[] classNameBytes = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> byte[classNameLength];               din.readFully(classNameBytes);               String className = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> String(classNameBytes);               <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("className:" + className);               <span class="hljs-type"><span class="hljs-type">int</span></span> classLength = din.readInt();               byte[] classBytes = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> byte[classLength];               din.readFully(classBytes);               File parentDir = className.indexOf(".")&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>?<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> File(outDir, className.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>,className.lastIndexOf(".")).replace(".", File.separator)):outDir;               <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!parentDir.<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>()) parentDir.mkdirs();               File outFile = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> File(parentDir, (className.indexOf(".")&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>?className.substring(className.lastIndexOf(".")+<span class="hljs-number"><span class="hljs-number">1</span></span>):className)+".class");               FileOutputStream outFos = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FileOutputStream(outFile);               outFos.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(classBytes);               outFos.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>();           } catch (EOFException e) {               din.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>();               <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;           }       }   } }</code> </pre><br>  And run it with the parameters: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># java openjdkmod.ClassesDumpExractor classes.dump dump_directory</span></span></code> </pre><br><br>  At the output, we get a directory with decrypted class files. <br><br>  Findings. <br>  Protecting class files with encryption is absolutely pointless, dangerous, expensive (at least not free). <br>  If you need to protect your bytecode: <br>  1) Use bytecode compilers in native code. <br>  2) The combination of the classic obfuscator with obfuscator with the function of string encryption. <br>  For super-protection: use external devices that support secure storage and execution of byte-code inside. <br>  The technique used above can be used to debug various applications, when you need to see which bytecode is loaded during operation. <br><br>  Note1: <br>  The same results can be achieved without modifying the source code of the JDK using the sun.misc.Unsafe class, although you need to dig a little in the format of storing classes inside the JVM. <br><br>  Note2: <br>  Well, of course, the author is not responsible for your use of the data contained in this article. <br><br>  Note3: The original image is taken from here: <a href="http://it.wikipedia.org/wiki/File">it.wikipedia.org/wiki/File</a> : Netbeans-Duke.png </div><p>Source: <a href="https://habr.com/ru/post/144957/">https://habr.com/ru/post/144957/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144951/index.html">HTML5 maps for mobile platforms</a></li>
<li><a href="../144952/index.html">Mobile technology: developing the world</a></li>
<li><a href="../144954/index.html">5 years to satellites on Yandex.Maps</a></li>
<li><a href="../144955/index.html">Uploading .3DS files to Android</a></li>
<li><a href="../144956/index.html">Opera Mini 7 for J2ME, BlackBerry and S60</a></li>
<li><a href="../144958/index.html">Google program for women entrepreneurs for the first time in Russia!</a></li>
<li><a href="../144959/index.html">Date Modification Problem via strtotime</a></li>
<li><a href="../144960/index.html">Introduction to Windows Server AppFabric. Hosting Services, hosting and scaling WCF and WF services</a></li>
<li><a href="../144961/index.html">‚ÄúElectronic media‚Äù or what threatens for posting negative information about the company?</a></li>
<li><a href="../144962/index.html">Method to remove subnets from SBL or how we spammed Spamhaus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>