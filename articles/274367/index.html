<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The architecture of the game client multiplayer Tower Defense. Christmas story</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 Some may remember that half a year ago I wrote about how we wrote down a prototype multiplayer game in six months . 
 According to the re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The architecture of the game client multiplayer Tower Defense. Christmas story</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br>  Some may remember that half a year ago I <a href="http://habrahabr.ru/post/258859/">wrote about how we wrote down a prototype multiplayer game in six months</a> . <br>  According to the results of the voting, then the audience decided that it was worth writing a sequel about the architecture of the game.  Under the cut, the second series in the now undeservedly forgotten genre of production drama, a lot of pictures, video of the actual gameplay at the moment, and the New Year cat. <br><br><h2>  Summary of the previous series </h2><br><img src="https://habrastorage.org/files/4f7/fe2/9c7/4f7fe29c7da340459dd9d8345172f69e.jpg" width="50%" align="left">  Sometime at the end of December 2014, a team of four people decided to create a clone of one of the most popular mods for WarCraft 3 - Legion TD. <a name="habracut"></a>  Having collected the simplest prototype for six months in their free time, the young programmers suddenly realized that they badly needed artists, modelers and designers.  Having entered the spamming path of spam in specialized communities and groups, while simultaneously rewriting the game server on Go, they managed to draw to the dark side a whole group of remarkable experts from the FSU.  At that time, far beyond the ocean, a similar clone for three years was developed by a simple American boy Brent "Lisk" Batas.  He had good artwork and almost zero code, but refused to cooperate with our heroes.  Even the <a href="http://habrahabr.ru/users/a11aud/" class="user_link">a11aud</a> 'server-client bundle demonstrated during a business trip to San Francisco did not convince the American.  It was decided to continue the development based only on their own strength.  Modelers, texture designers and designers worked hard styluses to have time to roll out the MVP by the appointed date - the eve of the new 2016.  And in general, we succeeded. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  And what is actually done? </h2><br>  Total to date, together we have the Tower Defense with the first game race, constantly improving graphics: <br><img src="https://habrastorage.org/files/d11/8c8/378/d118c83789fd483e90a193de760d1598.png"><br>  <i>Orc in armor</i> <br><img src="https://habrastorage.org/files/a1a/3b0/fc0/a1a3b0fc048949b49f7806145c5269c5.png"><br>  <i>Steam drone</i> <br><img src="https://habrastorage.org/files/547/016/f00/547016f0073e4f4cad78a2e618de82ab.png"><br>  <i>Self-propelled turret</i> <br><img src="https://habrastorage.org/files/59f/d55/554/59fd55554854412aa6072125d7d3aa09.png"><br>  <i>Goblin Mechanic</i> <br><img src="https://habrastorage.org/files/bf1/e19/f54/bf1e19f541364cc7ba0059da48d10265.png"><br>  <i>Alchemist</i> <br><ul><li>  Super fast scalable authoritarian Go game server with bots, reconnect support and replay recording. </li><li>  Cross-platform client with whistles. </li><li>  Lobby server with bots and matchmaking </li><li>  Cross-platform launcher </li></ul><br><br>  But back to the promised topic.  I will try to give the main design solutions that have confirmed their worth.  To many, they certainly seem obvious, but believe me, as it turned out, this is not quite so.  The low threshold for entry into Unity makes even the most childlike design mistakes possible. <br><br><h3>  First thought </h3><br>  If the game state is described by a complex serialized data structure, as in our case, you should always have easy access to any information that interests you.  Since our project is somewhat more complicated than the casual mainstream, ready-made Unity recipes do not suit us.  Due to the fact that we used our own technology stack, serialization and deserialization are not done in two accounts.  Let me remind you that in our project, the server sends eight players in the delta state of the game in json format 10 times per second.  As a solution, we wrote a singleton, which parses server messages, updates the game state on the client and provides a convenient interface to any game data. <br>  With this approach, obtaining the necessary information for different components of clients, for example, coordinates for the unit manager and mini-map is not difficult. <br>  No matter how great the temptation is to hang all the functionality on such a class up to <br><pre><code class="cs hljs">StateHub.Instance.GetLastKilledWithBlackMagicDwarfUID()</code> </pre>  Be prudent, remember the God Object.  Apparently Sergey Sychev meant this in his speech on OOP in Unity at the last meeting of the Unity User Group in St. Petersburg (I will add a link to the report when it will be published) when I urged not to use singletons at all.  But it seems to me that a sense of proportion and common sense will tell you when to stop. <br><br><h3>  Second thought </h3><br>  In our case, it makes sense to use the event model.  In the "Legion" there is the concept of phase.  There is a construction phase, a combat phase, an arena battle phase.  As mentioned above, the server sends status updates 10 times per second.  We generate events of arrival of the new message and phase change.  This is quite enough to simply and logically organize the instantiation of units, the assembly of corpses, the switching of musical themes and other utilitarian operations.  Since our game client does not calculate any game logic and is essentially just a ‚ÄúTV with remote control,‚Äù these few events are enough. <br><br><h3>  Third thought </h3><br>  Separate MonoBehaviour as View and directly game information for units.  The thing is trivial, but as it turned out, quite a few Unity programmers write almost all the code in one script.  This is not a big deal in a small project, but if you are thinking of something more serious than a flapiberd, better think about it beforehand. <br><br><h3>  Before and after </h3><br>  Half a year ago <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/huQePwzpcns%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjBCh8QoI_x0lSui1nPY54M7ltElw" frameborder="0" allowfullscreen=""></iframe><br>  Now <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/n8lEoCkVq7Y%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjH1zD3FLjtUfi8BmbO4ONPFBOYjw" frameborder="0" allowfullscreen=""></iframe><br>  There is a lot of work, of course, but progress is evident. <br><br><h2>  In the following series </h2><br><img src="https://habrastorage.org/files/6d7/3ae/bec/6d73aebec996482590ebb5437cadaddc.jpg" align="right">  Brent "Lisk" Batas announced his intention to go to crowdfunding by the end of February and start a closed beta test by the end of 2016. <br>  Our team of Spiced Jackal plans to continue developing, searching for investments, promoting the game called KrownGuards and catch up ahead of competitors.  These are the results of our hard work year.  We want to thank everyone who worked and works with us and congratulate everyone on the upcoming new year.  See you in 2016! <br>  PS We will be happy to answer questions, if any. <br><img src="https://habrastorage.org/files/350/1f7/edf/3501f7edf8ee41d48c5bda84a2675679.jpg"><br></div><p>Source: <a href="https://habr.com/ru/post/274367/">https://habr.com/ru/post/274367/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274357/index.html">Working alone is very difficult.</a></li>
<li><a href="../274359/index.html">Cybersecurity 2015</a></li>
<li><a href="../274361/index.html">How to monitor the appearance of questions on toster.ru ,.stackoverflow.com and stackoverflow.com</a></li>
<li><a href="../274363/index.html">Receptions work in Blender. Part 3</a></li>
<li><a href="../274365/index.html">The Million Dollar Indie Steam Phenomenon</a></li>
<li><a href="../274371/index.html">Budget homemade PTS "on the knees" (Mobile TV-station). Part 2: camera layout and team work</a></li>
<li><a href="../274373/index.html">Yes, you zadolbali your information society</a></li>
<li><a href="../274375/index.html">Yota: achievements of the outgoing year</a></li>
<li><a href="../274377/index.html">Yota network readiness for the New Year holidays</a></li>
<li><a href="../274379/index.html">Annual Report Habrapost - 2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>