<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We do GraphQL API on PHP and MySQL. Part 2: Mutations, Variables, Validation and Security</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, I wrote an article on how to make your GraphQL server in PHP using the graphql-php library and using it to implement a simple API for...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We do GraphQL API on PHP and MySQL. Part 2: Mutations, Variables, Validation and Security</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/0bc/8d1/715/0bc8d171582548d690cb776d7fb2ae8c.png" alt="image"><br><br>  Not so long ago, I wrote <a href="https://habrahabr.ru/post/328122/">an article</a> on how to make your GraphQL server in PHP using the graphql-php library and using it to implement a simple API for getting data from MySQL. <br><br>  Now I want to talk about how to make your GraphQL server work with mutations, and also try to answer the most common questions in the comments to the previous article, showing how to use data validation and touch on the security of the queries themselves. <br><a name="habracut"></a><br><h2>  Foreword </h2><br>  I want to remind you that in this example I use the <a href="https://github.com/webonyx/graphql-php">graphql-php</a> library.  I know that there are other solutions besides her, but at the moment it is impossible to say which one is better. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Also, I‚Äôll clarify that this article doesn‚Äôt encourage you to use PHP instead of Node.js or vice versa, but just want to show you how to use GraphQL if you‚Äôre on your own, or because of the circumstances of irresistible force working with PHP. <br><br>  In order not to explain everything from the beginning, I will take the final code from the <a href="https://habrahabr.ru/post/328122/">previous article</a> as a basis.  You can also view it in <a href="https://github.com/XAHTEP26/graphql-php-tutorial/tree/master/get-data-from-mysql">the article repository on Github</a> .  If you have not read the previous article, I recommend to read it before continuing. <br><br>  This article will need to send INSERT and UPDATE database queries.  This has nothing to do with GraphQL directly, so I‚Äôll just add a couple of new methods to the existing DB.php file so as not to focus on them in the future.  As a result, the file code will be as follows: <br><br><div class="spoiler">  <b class="spoiler_title">App / DB.php</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">PDO</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DB</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $pdo; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($config)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  PDO  self::$pdo = new PDO("mysql:host={$config['host']};dbname={$config['database']}", $config['username'], $config['password']); //      self::$pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_OBJ); } public static function selectOne($query) { $records = self::select($query); return array_shift($records); } public static function select($query) { $statement = self::$pdo-&gt;query($query); return $statement-&gt;fetchAll(); } public static function affectingStatement($query) { $statement = self::$pdo-&gt;query($query); return $statement-&gt;rowCount(); } public static function update($query) { $statement = self::$pdo-&gt;query($query); $statement-&gt;execute(); return $statement-&gt;rowCount(); } public static function insert($query) { $statement = self::$pdo-&gt;query($query); $success = $statement-&gt;execute(); return $success ? self::$pdo-&gt;lastInsertId() : null; } }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  <i>As I said in the last article - using this class to access the database on a live project is strictly prohibited.</i>  <i>Instead, use the query designer available in the framework you are using or any other tool that can provide security.</i> <br></div></div><br>  So let's get started. <br><br><h2>  Mutations and variables </h2><br>  As I mentioned in the previous article, GraphQL, along with Query, can contain another root data type - Mutation. <br><br>  This type is responsible for changing data on the server.  Just as in REST, it is recommended to use GET requests for data retrieval, and for changing POST data (PUT, DELETE) requests, in GraphQL, you should use Query for receiving data from the server, and Mutation for changing data. <br><br>  The description of the field types for Mutation is the same as for Query.  Mutations as well as queries can return data - this is convenient if you, for example, want to request updated information from the server immediately after the mutation is completed. <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  <i>According to the specification, the mutations are different from the usual requests, that the field mutations are always performed sequentially one after the other, while the field requests can be executed in parallel.</i> <br></div></div><br>  Let's create a Mutation type in a separate MutationType.php file in the Type folder: <br><br><div class="spoiler">  <b class="spoiler_title">App / Type / MutationType.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">DB</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Types</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>\<span class="hljs-title"><span class="hljs-title">Definition</span></span>\<span class="hljs-title"><span class="hljs-title">ObjectType</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MutationType</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectType</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $config = [ <span class="hljs-string"><span class="hljs-string">'fields'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-comment"><span class="hljs-comment">//     ]; } ]; parent::__construct($config); } }</span></span></code> </pre> <br>  And add it to our Types.php type registry: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>\<span class="hljs-title"><span class="hljs-title">MutationType</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $mutation; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mutation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$mutation ?: (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$mutation = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MutationType()); }</code> </pre> <br></div></div><br>  It remains to add the mutation we just created to the schema in the graphql.php file immediately after Query: <br><br><pre> <code class="php hljs">$schema = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Schema([ <span class="hljs-string"><span class="hljs-string">'query'</span></span> =&gt; Types::query(), <span class="hljs-string"><span class="hljs-string">'mutation'</span></span> =&gt; Types::mutation() ]);</code> </pre> <br>  This completes the creation of the mutation, but so far little sense from it.  Let's add to the mutation fields to change the data of existing users. <br><br><h3>  Change user information </h3><br>  As we already know, the data in the query can be passed as arguments.  This means that we can easily add the ‚ÄúchangeUserEmail‚Äù field to the mutation, which will take 2 arguments: <br><br><ul><li>  id - user id </li><li>  email - new user email address </li></ul><br>  Let's change the code for the MutationType.php file: <br><br><div class="spoiler">  <b class="spoiler_title">App / Type / MutationType.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">DB</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Types</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>\<span class="hljs-title"><span class="hljs-title">Definition</span></span>\<span class="hljs-title"><span class="hljs-title">ObjectType</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MutationType</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectType</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $config = [ <span class="hljs-string"><span class="hljs-string">'fields'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'changeUserEmail'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; Types::user(), <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' E-mail '</span></span>, <span class="hljs-string"><span class="hljs-string">'args'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; Types::int(), <span class="hljs-string"><span class="hljs-string">'email'</span></span> =&gt; Types::string() ], <span class="hljs-string"><span class="hljs-string">'resolve'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($root, $args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  email  DB::update("UPDATE users SET email = '{$args['email']}' WHERE id = {$args['id']}"); //    ""   $user = DB::selectOne("SELECT * from users WHERE id = {$args['id']}"); if (is_null($user)) { throw new \Exception('    id'); } return $user; } ] ]; } ]; parent::__construct($config); } }</span></span></code> </pre> </div></div><br>  Now we can perform a mutation that will change the user's E-mail and return its data: <br><br> <a href=""><img src="https://habrastorage.org/web/ac5/f4f/756/ac5f4f756b8f4815aca58346dfef43d6.png" alt="GraphQL user email change request"></a> <br><br><h4>  Query variables </h4><br>  It turned out not bad, but it is not always convenient to insert the values ‚Äã‚Äãof the arguments in the query text. <br>  To simplify the insertion of dynamic data into a query in GraphQL, there is a special vocabulary of variable variables. <br><br>  The values ‚Äã‚Äãof variables are transmitted to the server along with the request and, as a rule, in the form of a JSON object.  Therefore, in order for our GraphQL server to work with them, let's change the endpoint code a little by adding to it the extraction and decoding of variables from the query: <br><br><pre> <code class="php hljs">$variables = <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($input[<span class="hljs-string"><span class="hljs-string">'variables'</span></span>]) ? json_decode($input[<span class="hljs-string"><span class="hljs-string">'variables'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>;</code> </pre> <br>  And then pass them to GraphQL with the fifth parameter: <br><br><pre> <code class="php hljs">$result = GraphQL::execute($schema, $query, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $variables);</code> </pre> <br>  Then the code of the graphql.php file will be as follows: <br><br><div class="spoiler">  <b class="spoiler_title">graphql.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/vendor/autoload.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">DB</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Types</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">GraphQL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">Schema</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     $config = [ 'host' =&gt; 'localhost', 'database' =&gt; 'gql', 'username' =&gt; 'root', 'password' =&gt; 'root' ]; //     DB::init($config); //   $rawInput = file_get_contents('php://input'); $input = json_decode($rawInput, true); $query = $input['query']; //    $variables = isset($input['variables']) ? json_decode($input['variables'], true) : null; //   $schema = new Schema([ 'query' =&gt; Types::query(), 'mutation' =&gt; Types::mutation() ]); //   $result = GraphQL::execute($schema, $query, null, null, $variables); } catch (\Exception $e) { $result = [ 'error' =&gt; [ 'message' =&gt; $e-&gt;getMessage() ] ]; } //   header('Content-Type: application/json; charset=UTF-8'); echo json_encode($result);</span></span></code> </pre> </div></div><br>  Now we can transfer the data in the form of JSON (in the GraphiQL browser extensions for this, there is a ‚ÄúQuery variables‚Äù tab in the lower left corner).  And you can insert variables into a request by passing them into a mutation in the same way as arguments are passed to an anonymous function (with an indication of the type): <br> <code>mutation($userId: Int, $userEmail: String)</code> <br> <br>  Then they can be specified as argument values: <br> <code>changeUserEmail (id: $userId, email: $userEmail)</code> <br> <br>  And now the same query will look like this: <br><br> <a href=""><img src="https://habrastorage.org/web/f54/eb5/6de/f54eb56de27c45ed8363b4b50b1086e4.png" alt="GraphQL user email change request using variables"></a> <br><br><h3>  Add new user </h3><br>  In principle, we could make a similar mutation to add a new user, simply by adding a couple of missing arguments and removing the id, but we‚Äôd rather create a separate data type for user input. <br><br>  In GraphQL data types are divided into 2 types: <br><br><ul><li>  <b>Output</b> types - types for data output (or field types) </li><li>  <b>Input</b> types - data entry types (or argument types) </li></ul><br>  All simple data types (Scalar, Enum, List, NonNull) refer to both types simultaneously. <br>  Such types as Interface and Union relate only to Output, but in this article we will not consider them. <br><br>  The composite type Object, discussed in the <a href="https://habrahabr.ru/post/328122/">previous section</a> , also applies to Output, and for Input there is a similar type of InputObject. <br><br>  The difference between InputObject and Object is that its fields cannot have arguments (args) and resolvers (resolve), and their types (type) must be of the Input types type. <br><br>  Let's create a new type of InputUserType to add a user.  It will be similar to the UserType type, only we will now inherit not from ObjectType, but from InputObjectType: <br><br><div class="spoiler">  <b class="spoiler_title">App / Type / InputUserType.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Types</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>\<span class="hljs-title"><span class="hljs-title">Definition</span></span>\<span class="hljs-title"><span class="hljs-title">InputObjectType</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InputUserType</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InputObjectType</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $config = [ <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'fields'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; Types::string(), <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span> ], <span class="hljs-string"><span class="hljs-string">'email'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; Types::string(), <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'E-mail '</span></span> ] ]; } ]; <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::__construct($config); } }</code> </pre> </div></div><br>  And do not forget to add it to our Types.php type registry: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>\<span class="hljs-title"><span class="hljs-title">InputUserType</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $inputUser; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inputUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$inputUser ?: (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$inputUser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputUserType()); }</code> </pre> <br>  Fine!  Now we can use it to add a new ‚ÄúaddUser‚Äù field in MutationType.php next to the ‚ÄúchangeUserEmail‚Äù field: <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'addUser'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; Types::user(), <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'args'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'user'</span></span> =&gt; Types::inputUser() ], <span class="hljs-string"><span class="hljs-string">'resolve'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($root, $args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      $userId = DB::insert("INSERT INTO users (name, email) VALUES ('{$args['user']['name']}', '{$args['user']['email']}')"); //         return DB::selectOne("SELECT * from users WHERE id = $userId"); } ]</span></span></code> </pre> <br>  I draw attention to the fact that this field has one argument of type InputUser ( <code>Types::inputUser()</code> ) and returns the newly created user of type User ( <code>Types::user()</code> ). <br><br>  Is done.  Now we can add a new user to the database using a mutation.  User data is passed to Variables and we specify a variable as InputUser type: <br><br> <a href=""><img src="https://habrastorage.org/web/4a1/0bb/1df/4a10bb1df91843f68ea935f1c14e2e5a.png" alt="GraphQL user add request"></a> <br><br><h2>  Validation and Security </h2><br>  I would divide the validation in GraphQL into 2 types: <br><br><ul><li>  Validation of data transmitted with the request (arguments and variables) </li><li>  Validation of the queries themselves </li></ul><br>  And even in the comments to the previous article, it has been said many times that the security of your application is in your hands, and not in the hands of GraphQL, I will still show a couple of simple ways to protect your application when using <a href="https://github.com/webonyx/graphql-php">graphql-php</a> . <br><br><h3>  Data validation </h3><br>  Everything that we have done before this, in our example, is in no way protected from entering incorrect data. <br>  Let's add a simple data validation, indicating which arguments are required, as well as organize the validation Email. <br><br>  To denote the required arguments, we will use the special NonNull data type in GraphQL.  Let's connect it to our type registry: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nonNull</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Type::nonNull($type); }</code> </pre> <br>  Now we just wrap them with the types of the arguments that are required. <br><br>  We assume that for the user in InputUserType.php the fields "name" and "email" are required: <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'fields'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; Types::nonNull(Types::string()), <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span> ], <span class="hljs-string"><span class="hljs-string">'email'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; Types::nonNull(Types::string()), <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'E-mail '</span></span> ], ]; }</code> </pre> <br>  And for the changeUserEmail mutation, the ‚Äúid‚Äù and ‚Äúemail‚Äù will be required: <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'args'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; Types::nonNull(Types::int()), <span class="hljs-string"><span class="hljs-string">'email'</span></span> =&gt; Types::nonNull(Types::string()) ]</code> </pre> <br>  Now, if we forget to specify a required parameter, we get an error.  But we can still specify any string as the user's E-mail.  Let's fix it. <br><br>  In order for us to check the received E-mail, we need to create for it our scalar data type. <br><br>  GraphQL has several built-in scalar types: <br><br><ul><li>  String </li><li>  Int </li><li>  Float </li><li>  Boolean </li><li>  Id </li></ul><br>  With some of them you are already familiar, and the purpose of the others is obvious. <br><br>  To create a custom scalar data type, we need to write a class for it that will inherit from ScalarType and implement 3 methods: <br><br><ul><li>  serialize - serialize the internal representation of the data into a string </li><li>  parseValue - parsing data in a variable for internal representation </li><li>  parseLiteral - data parsing in the query text for internal representation </li></ul><br>  The parseValue and parseLiteral methods for scalar types in many cases will be very similar, but you should pay attention to the fact that parseValue takes as its argument the value of a variable, and the parseLiteral object of the Node class that contains this value in the "value" property. <br><br>  Let's finally create a new scalar Email data type in a separate EmailType.php file.  In order not to store all types in one big heap, I will place this file in the ‚ÄúScalar‚Äù subfolder of the ‚ÄúType‚Äù folder: <br><br><div class="spoiler">  <b class="spoiler_title">App / Type / Scalar / EmailType.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>\<span class="hljs-title"><span class="hljs-title">Scalar</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>\<span class="hljs-title"><span class="hljs-title">Definition</span></span>\<span class="hljs-title"><span class="hljs-title">ScalarType</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EmailType</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ScalarType</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $value; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!filter_var($value, FILTER_VALIDATE_EMAIL)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'  E-mail'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $value; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseLiteral</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($valueNode)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!filter_var($valueNode-&gt;value, FILTER_VALIDATE_EMAIL)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'  E-mail'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $valueNode-&gt;value; } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  <i>You can check your E-mail for validity in any way you can.</i>  <i>Any framework also has handy tools for this.</i> <br></div></div><br>  It remains only to add the next data type to the Types.php registry: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>\<span class="hljs-title"><span class="hljs-title">Scalar</span></span>\<span class="hljs-title"><span class="hljs-title">EmailType</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $emailType; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">email</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$emailType ?: (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$emailType = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EmailType()); }</code> </pre> <br>  And replace all email fields with the type String ( <code>Types::string()</code> ) with Email ( <code>Types::email()</code> ).  For example, the full code of MutationType.php will now be like this: <br><br><div class="spoiler">  <b class="spoiler_title">App / Type / MutationType.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">DB</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Types</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>\<span class="hljs-title"><span class="hljs-title">Definition</span></span>\<span class="hljs-title"><span class="hljs-title">ObjectType</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MutationType</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectType</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $config = [ <span class="hljs-string"><span class="hljs-string">'fields'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'changeUserEmail'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; Types::user(), <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' E-mail '</span></span>, <span class="hljs-string"><span class="hljs-string">'args'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; Types::nonNull(Types::int()), <span class="hljs-string"><span class="hljs-string">'email'</span></span> =&gt; Types::nonNull(Types::email()) ], <span class="hljs-string"><span class="hljs-string">'resolve'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($root, $args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  email  DB::update("UPDATE users SET email = '{$args['email']}' WHERE id = {$args['id']}"); //    ""   $user = DB::selectOne("SELECT * from users WHERE id = {$args['id']}"); if (is_null($user)) { throw new \Exception('    id'); } return $user; } ], 'addUser' =&gt; [ 'type' =&gt; Types::user(), 'description' =&gt; ' ', 'args' =&gt; [ 'user' =&gt; Types::inputUser() ], 'resolve' =&gt; function ($root, $args) { //      $userId = DB::insert("INSERT INTO users (name, email) VALUES ('{$args['user']['name']}', '{$args['user']['email']}')"); //         return DB::selectOne("SELECT * from users WHERE id = $userId"); } ] ]; } ]; parent::__construct($config); } }</span></span></code> </pre> </div></div><br>  And the InputUserType.php code is: <br><br><div class="spoiler">  <b class="spoiler_title">App / Type / InputUserType.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Types</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">Type</span></span>\<span class="hljs-title"><span class="hljs-title">Definition</span></span>\<span class="hljs-title"><span class="hljs-title">InputObjectType</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InputUserType</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InputObjectType</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $config = [ <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'fields'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; Types::nonNull(Types::string()), <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span> ], <span class="hljs-string"><span class="hljs-string">'email'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; Types::nonNull(Types::email()), <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'E-mail '</span></span> ], ]; } ]; <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::__construct($config); } }</code> </pre> </div></div><br>  And now when you enter the wrong E-mail we will see the error: <br><br> <a href=""><img src="https://habrastorage.org/web/f9c/d6b/c62/f9cd6bc620554019b3acdf38b68a4698.png" alt="Error in graphQL query: incorrect email"></a> <br><br>  As you can see, now in the request for the <code>$userEmail</code> variable we specify the type of Email, not String.  We also add exclamation marks after specifying the type of all required query arguments. <br><br><h3>  Validation request </h3><br>  To ensure security, GraphQL performs a number of operations related to the validation of the received request.  Most of them are included in graphql-php by default and you have already encountered them when you saw errors when receiving a response from the GraphQL server, so I will not analyze them all, but I will show one - the most interesting case. <br><br><h4>  Fragment looping </h4><br>  When you want to request several objects that have the same fields, you would hardly want to enter the same list of fields for each object in the request. <br><br>  To solve this problem in GraphQL there are fragments (Fragments).  That is, you can list all the necessary fields in the fragment once, and then use this fragment in the request as many times as you need. <br><br>  Syntax fragments resemble the spread operator in JavaScript.  For example, let's ask for a list of users and their friends with some information about them. <br><br>  Without fragments, it would look like this: <br><br> <a href=""><img src="https://habrastorage.org/web/5b6/a4c/6fa/5b6a4c6fab04462f8272f2069db5e557.png" alt="GraphQL query list of users and their friends"></a> <br><br>  And by creating a <code>userFields</code> fragment for the User type, we can rewrite our query like this: <br><br> <a href=""><img src="https://habrastorage.org/web/361/aa2/a02/361aa2a02d20404cb4ae5f600c769bc2.png" alt="GraphQL query fragments"></a> <br><br>  Maybe in this case we do not get much benefit from the use of fragments, but in a more complex query they will definitely be useful. <br><br>  But we are now talking about security.  What does it have to do with some fragments? <br><br>  And despite the fact that now the potential intruder has the opportunity to loop the request, using a fragment within himself.  And after that, our server would probably fall, but GraphQL will not allow it to do this and will give an error: <br><br> <a href=""><img src="https://habrastorage.org/web/a76/060/471/a7606047127349b1909eafd42a2d7531.png" alt="Error in graphQL query: fragment looping"></a> <br><br><h4>  Query complexity and depth of query </h4><br>  Also, in addition to the standard validation of the query, graphql-php allows you to specify the maximum complexity and maximum depth of the query. <br><br>  Roughly speaking, complexity is an integer, which in most cases corresponds to the number of fields in the query, and depth is the number of nesting levels in the query fields. <br><br>  By default, the maximum complexity and maximum depth of the query are zero, that is, unlimited.  But we can limit them by connecting the classes for validation and the corresponding rules to graphql.php: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">Validator</span></span>\<span class="hljs-title"><span class="hljs-title">DocumentValidator</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">Validator</span></span>\<span class="hljs-title"><span class="hljs-title">Rules</span></span>\<span class="hljs-title"><span class="hljs-title">QueryComplexity</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">Validator</span></span>\<span class="hljs-title"><span class="hljs-title">Rules</span></span>\<span class="hljs-title"><span class="hljs-title">QueryDepth</span></span>;</code> </pre> <br>  And adding these rules to the validator immediately before executing the query: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//      6 DocumentValidator::addRule('QueryComplexity', new QueryComplexity(6)); //      1 DocumentValidator::addRule('QueryDepth', new QueryDepth(1));</span></span></code> </pre> <br>  As a result, the code of the graphql.php file should look like this: <br><br><div class="spoiler">  <b class="spoiler_title">graphql.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/vendor/autoload.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">DB</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Types</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">GraphQL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">Schema</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">Validator</span></span>\<span class="hljs-title"><span class="hljs-title">DocumentValidator</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">Validator</span></span>\<span class="hljs-title"><span class="hljs-title">Rules</span></span>\<span class="hljs-title"><span class="hljs-title">QueryComplexity</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">GraphQL</span></span>\<span class="hljs-title"><span class="hljs-title">Validator</span></span>\<span class="hljs-title"><span class="hljs-title">Rules</span></span>\<span class="hljs-title"><span class="hljs-title">QueryDepth</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     $config = [ 'host' =&gt; 'localhost', 'database' =&gt; 'gql', 'username' =&gt; 'root', 'password' =&gt; 'root' ]; //     DB::init($config); //   $rawInput = file_get_contents('php://input'); $input = json_decode($rawInput, true); $query = $input['query']; //    $variables = isset($input['variables']) ? json_decode($input['variables'], true) : null; //   $schema = new Schema([ 'query' =&gt; Types::query(), 'mutation' =&gt; Types::mutation() ]); //      6 DocumentValidator::addRule('QueryComplexity', new QueryComplexity(6)); //      1 DocumentValidator::addRule('QueryDepth', new QueryDepth(1)); //   $result = GraphQL::execute($schema, $query, null, null, $variables); } catch (\Exception $e) { $result = [ 'error' =&gt; [ 'message' =&gt; $e-&gt;getMessage() ] ]; } //   header('Content-Type: application/json; charset=UTF-8'); echo json_encode($result);</span></span></code> </pre> </div></div><br>  Now let's check our server.  First we introduce a valid query: <br><br> <a href=""><img src="https://habrastorage.org/web/ccb/4ba/ce5/ccb4bace5c4e463f9c6b89015c15f0e9.png" alt="Valid graphq query"></a> <br><br>  Now we change the query so that its complexity is more than the maximum allowed: <br><br> <a href=""><img src="https://habrastorage.org/web/2bc/cad/8f9/2bccad8f9b744c97a5c872d5391c1aeb.png" alt="Error in graphQL query: Exceeding maximum query complexity"></a> <br><br>  And similarly we will increase the depth of the query <br><br> <a href=""><img src="https://habrastorage.org/web/40e/8c9/766/40e8c97661b2445095fc80aa02e01181.png" alt="Error in GraphQL query: Exceeding the maximum complexity and depth of the query"></a> <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  <i>If you use GraphiQL - an extension for the browser or a similar tool for testing queries, then it is worth remembering that when you download it, it sends a request to the endpoint to find out which fields are available, what types they are, their description, etc.</i> <i><br><br></i>  <i>And this request is also validated.</i>  <i>Therefore, you should either disable the validation of the request before loading the extension, or specify the maximum allowable complexity and depth greater than in this request.</i> <i><br><br></i>  <i>In my extension for GrapiQL, the depth of the ‚Äúsystem‚Äù query is 7, and the complexity is 109. Consider this nuance in order to avoid misunderstanding where errors occur.</i> <br></div></div><br><br>  That is, now you have the opportunity to limit the load on the server and deal with such a problem as Nested attak. <br><br><h2>  Conclusion </h2><br>  Thanks for attention. <br><br>  Ask questions and I will try to answer them.  And also I will be grateful if you point out my mistakes to me. <br><br>  <a href="https://github.com/XAHTEP26/graphql-php-tutorial/tree/master/mutation-and-validation">Source code</a> with comprehensive comments is also available on Github. <br><br>  Other parts of this article: <br><ol><li>  <a href="https://habrahabr.ru/post/328122/">Installation, layout and queries</a> </li><li>  Mutations, variables, validation and security </li><li>  <a href="https://habrahabr.ru/post/329408/">Problem solving N + 1 queries</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/329238/">https://habr.com/ru/post/329238/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329228/index.html">Creating data models for QComboBox</a></li>
<li><a href="../329230/index.html">Library for visualizing sports seasons</a></li>
<li><a href="../329232/index.html">How cloud can help future technology</a></li>
<li><a href="../329234/index.html">8 skills required in the profession of Data Scientist</a></li>
<li><a href="../329236/index.html">Games and gameplay: different types of players</a></li>
<li><a href="../329240/index.html">JSF 2 + Maven + Jetty. Training</a></li>
<li><a href="../329242/index.html">Avoiding Hell with Monads</a></li>
<li><a href="../329244/index.html">What addresses do we see in traceroute</a></li>
<li><a href="../329246/index.html">Loading real landscapes in unity 3d</a></li>
<li><a href="../329248/index.html">Clever blocking bypass in Ukraine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>