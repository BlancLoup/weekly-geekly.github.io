<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to restore a domain controller</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The tale that SystemState made by NTBackup is not such an aid when restoring DC. 

 I'll start from far away. 
 He settled down and took the place of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to restore a domain controller</h1><div class="post__text post__text-html js-mediator-article">  The tale that <b>SystemState</b> made by <b>NTBackup is</b> not such an <b>aid</b> when restoring DC. <br><a name="habracut"></a><br>  I'll start from far away. <br>  He settled down and took the place of the administrator, previously worked as a developer, but then they paid significantly more, so I decided to change the scope of activities so far. <br><br>  There were 4 servers in my competence: <br>  dc - domain controller <br>  fs - file + print server <br>  av - server with antivirus + local chat <br>  db - for the base <br><br>  In a month, 2 new servers arrived: one went for one special project beyond my competence, and one for infrastructure needs, i.e.  for me. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I previously worked with hyper-v, so I decided not to bother and deployed it, not vmware, even though I tried it too. <br>  Brought another domain controller dc2, wsus, new fs, print server, etc. <br>  They wrote off the old servers: av, db using <i>Acronis True Image Universal Restore was</i> transferred to hyper-v, the old fs was simply removed. <br>  And so we had: dc1 (old dc physical), under hyper-v dc2 was spinning, new fs, etc.  what is necessary for life. <br><br>  After a year and a half, a lot of equipment arrived and decided to give the existing hyper-v server for other tasks, and deploy a cluster of two hyper-v servers.  Potiha threw servers from the old hyper-v to the cluster.  So far we have decided not to touch domain controllers. <br><br>  The dc1 server began to sneak and we decided that we should get rid of it.  They made a copy using disk2vhd and there was a fresh <b>SystemState done</b> daily using <b>NTBackup</b> . <br>  We decide to start with the vhd file dc1.  We created a virtual machine with this vhd - at startup we get BSOD.  With the help of <i>Acronis True Image Universal Restore, we</i> have achieved that the server is started, but AD swears that it is bad for him and AD does not actually plow.  In the internet they found that it is impossible to do this with DC: take images of partitions. <br><br>  He leaned on the work and got a little distracted.  dc2 served as DC. <br><br>  The partner decided to transfer the dc2 server from the old hyper-v to the cluster.  Just threw the vhd file, created a new virtual machine with this file and started the server.  The OS booted, but the new network card turned out to be and AD will not work. <br>  Randomly, he deleted the xml virtual machine description file on the old hyper-v.  Now, on the old hyper-v server, dc2 swore similarly. <br><br>  We decided to restore dc1 from <b>SystemState</b> on a hyper-v cluster, since  The dc1 physical server does not support booting from cd, and the OS itself has already stopped loading.  I put the same Windows Server 2003. I restore <b>SystemState</b> , but after reboot <b>BSOD *** Stop: 0x0000007B</b> . <br>  We find on technet how you can try to revive dc2. <br><br>  Create a new virtual machine, connect the vhd dc2 file to it, load into it.  In it, we add the environment variable <b>DEVMGR_SHOW_NONPRESENT_DEVICES</b> with a value of 1. Then we show hidden devices in the device manager, find the old network one, and save the device's GUID.  We delete the vhd file from the created virtual machine and export it (without the vhd file it goes faster :)).  In the escorted xml file, we go with the GUID of the network card.  Then we import the virtual machine and connect the untouched vhd file from dc2. <br><br>  We are loading into <b>Directory Services Restore Mode</b> (you need the administrator's password, we reset it, because the user was blocked, etc.), we add the <a href="http://technet.microsoft.com/en-us/library/virtual_active_directory_domain_controller_virtualization_hyperv">technet.microsoft.com/en-us/library/virtual_active_directory_domain_controller_virtualization_hyperv</a> (WS.10) described here <a href="http://technet.microsoft.com/en-us/library/virtual_active_directory_domain_controller_virtualization_hyperv">.</a> .aspx parameters in the registry. <br>  The system boots, but the AD snap-ins on startup report problems with the <b>workstation</b> service.  The server is in a state not a member server, but also not a domain controller.  Having rummaged on technet we find discussion of a similar problem in one branch.  There, the correct answers are highlighted and they all say that it was necessary to use ntbackup, etc.  (yes, this ntbackup helped), but at the very bottom was a post where a friend advised: remove the <b>Client for Microsoft Networks</b> in the TCI / IP properties of the network card, and then install it immediately. <br><br>  And it helped: snap AD began to open without problems.  Captured roles. <br>  On the advice of his brother, also an admin, he decided to raise dc3 on the cluster to check if everything will be replicated normally.  Everything was normal and already according to the method described here <a href="http://www.petri.co.il/delete_failed_dcs_from_ad.htm">www.petri.co.il/delete_failed_dcs_from_ad.htm</a> cleaned mention of dc1. <br>  After the new dc1 was raised on the cluster, with the old ip and the transfer of roles to it, because  so needed for local infrastructure. <br><br><h5>  Conclusion </h5><br>  1 - From the very beginning, it was necessary to deploy another additional dc, lower d1, and then re-create it <br>  2 - do not delete anything ahead of time: you just need to turn off dc2 on the old hyper-v and use the export of the virtual machine <br>  3 - Consult and discuss actions before starting work. <br><br><h5>  PS </h5><br>  Maybe there are any suggestions and wishes that could be done better, more efficiently or faster. </div><p>Source: <a href="https://habr.com/ru/post/126663/">https://habr.com/ru/post/126663/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126656/index.html">Energizer company has released a universal charger</a></li>
<li><a href="../126658/index.html">Installing Ubuntu on a real hard drive via VirtualBox</a></li>
<li><a href="../126660/index.html">The real alternative to nVidia 3Dvision or when cheap doesn't mean bad</a></li>
<li><a href="../126661/index.html">Ridley Scott will shoot the continuation of the film "Blade Runner"</a></li>
<li><a href="../126662/index.html">Canobuvosti, 105th edition</a></li>
<li><a href="../126664/index.html">PHP 5.3 certification from Zend</a></li>
<li><a href="../126665/index.html">Patent Wars: Digging the Pits for Yourself?</a></li>
<li><a href="../126666/index.html">Updates to the service of filing documents in arbitration courts "My arbitrator"</a></li>
<li><a href="../126667/index.html">We continue games with experimental T2000 - stage, we share power</a></li>
<li><a href="../126669/index.html">Reflections on how to ask correctly in order to receive answers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>