<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introducing Iron: Melt Ore on Rust</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Iron is a high-level web framework written in the Rust programming language and built on the basis of another well-known hyper library. Iron is design...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introducing Iron: Melt Ore on Rust</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/8e7/339/992/8e7339992cd744908885c294893f390b.png"><br><blockquote>  Iron is a high-level web framework written in the Rust programming language and built on the basis of another well-known hyper library.  Iron is designed to take advantage of all the benefits that Rust gives us. </blockquote><br><a name="habracut"></a><br><h2>  Philosophy </h2><br><p>  Iron is built on the principle of extensibility as much as possible. <br>  He introduces concepts for expanding his own functional: </p><br><ul><li>  "intermediate" types - used to implement the end-to-end functionality in processing requests; </li><li>  modifiers - used to change requests and responses most ergonomic <br>  in a way. </li></ul><br><p>  With the basic part of the modifiers and intermediate types you will get acquainted in the course of the article. </p><br><p>  <a href="http://ironframework.io/" title="There are links to the main repository in github and documentation">Iron Official Website</a> </p><br><h2>  Project creation </h2><br><p>  First, create a project using Cargo, using the command: </p><br><pre><code class="hljs pgsql">cargo <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> rust-iron-tutorial <span class="hljs-comment"><span class="hljs-comment">--bin</span></span></code> </pre> <br><p>  Next, add the dependence <code>iron = "0.4.0"</code> to the <code>[dependencies]</code> section of the <code>Cargo.toml</code> file. </p><br><h2>  Writing the first program using Iron </h2><br><p>  Let's write the first simple program on Rust using Iron, which will respond to any requests on port 3000 with the text "Hello habrahabr!". </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">crate</span></span> iron; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> iron::prelude::*; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> iron::status; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() { Iron::new(|_: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Request| { <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(Response::with((status::<span class="hljs-literal"><span class="hljs-literal">Ok</span></span>, <span class="hljs-string"><span class="hljs-string">"Hello habrahabr!\n"</span></span>))) }).http(<span class="hljs-string"><span class="hljs-string">"localhost:3000"</span></span>).unwrap(); }</code> </pre> <br><p>  Run the code using the <code>cargo run</code> command and after the compilation is complete and the program starts, test the service, for example, using curl: </p><br><pre> <code class="hljs ruby">[loomaclin@loomaclin ~]$ curl <span class="hljs-symbol"><span class="hljs-symbol">localhost:</span></span><span class="hljs-number"><span class="hljs-number">3000</span></span> Hello habrahabr!</code> </pre> <br><p>  Let's analyze the program to understand what is happening here.  The first line of the program imports the <code>iron</code> package. <br>  In the second line, a prelude module was connected, containing a set of the most important types, such as <code>Request</code> , <br>  <code>Response</code> , <code>IronRequest</code> , <code>IronResult</code> , <code>IronError</code> and <code>Iron</code> .  The third line connects the <code>status</code> module, which contains lists of codes for answering requests.  <code>Iron::new</code> creates a new <code>Iron::new</code> instance, which, in turn, is the base object of your server.  It takes a parameter object that implements the type of <code>Handler</code> .  In our case, we pass a closure whose argument is a mutable reference to the transmitted request. </p><br><h2>  Specify mime-type in the response header </h2><br><p>  Most often, when building web services (SOAP, REST), it is required to send answers indicating the type of content they contain.  For this, Iron provides special tools. </p><br><p>  Perform the following. </p><br><p>  We connect the corresponding structure: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> iron::mime::Mime;</code> </pre> <br><p>  Bind the name <code>content_type</code> , which will store the parsed value of the following type using the connected <code>Mime</code> type: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> content_type = <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>.parse::&lt;Mime&gt;().unwrap();</code> </pre> <br><p>  Modify the query response line as follows: </p><br><pre> <code class="rust hljs"><span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(Response::with((content_type, status::<span class="hljs-literal"><span class="hljs-literal">Ok</span></span>, <span class="hljs-string"><span class="hljs-string">"{}"</span></span>)))</code> </pre> <br><p>  Run the program and check the performance: </p><br><pre> <code class="hljs vbscript">[loomaclin@loomaclin ~]$ curl -v localhost:<span class="hljs-number"><span class="hljs-number">3000</span></span> * Rebuilt URL <span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: localhost:<span class="hljs-number"><span class="hljs-number">3000</span></span>/ * Trying ::<span class="hljs-number"><span class="hljs-number">1.</span></span>.. * Connected <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> localhost (::<span class="hljs-number"><span class="hljs-number">1</span></span>) port <span class="hljs-number"><span class="hljs-number">3000</span></span> (#<span class="hljs-number"><span class="hljs-number">0</span></span>) &gt; <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> / HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> &gt; Host: localhost:<span class="hljs-number"><span class="hljs-number">3000</span></span> &gt; User-Agent: curl/<span class="hljs-number"><span class="hljs-number">7.49</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; Accept: */* &gt; &lt; HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK &lt; Content-Type: application/json &lt; <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>: Tue, <span class="hljs-number"><span class="hljs-number">12</span></span> Jul <span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span> GMT &lt; Content-Length: <span class="hljs-number"><span class="hljs-number">2</span></span> &lt; * Connection #<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> host localhost <span class="hljs-built_in"><span class="hljs-built_in">left</span></span> intact {}</code> </pre> <br><h2>  Manage response status codes </h2><br><p>  In the <code>StatusCode</code> enumeration, located in the <code>status</code> module, various status codes are located.  Let's use this and return the "client" error 404 - <code>NotFound</code> , changing the line to form the answer to the request: </p><br><pre> <code class="rust hljs"><span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(Response::with((content_type, status::NotFound)))</code> </pre> <br><p>  Check: </p><br><pre> <code class="hljs vbscript">[loomaclin@loomaclin ~]$ curl -v localhost:<span class="hljs-number"><span class="hljs-number">3000</span></span> * Rebuilt URL <span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: localhost:<span class="hljs-number"><span class="hljs-number">3000</span></span>/ * Trying ::<span class="hljs-number"><span class="hljs-number">1.</span></span>.. * Connected <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> localhost (::<span class="hljs-number"><span class="hljs-number">1</span></span>) port <span class="hljs-number"><span class="hljs-number">3000</span></span> (#<span class="hljs-number"><span class="hljs-number">0</span></span>) &gt; <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> / HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> &gt; Host: localhost:<span class="hljs-number"><span class="hljs-number">3000</span></span> &gt; User-Agent: curl/<span class="hljs-number"><span class="hljs-number">7.49</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; Accept: */* &gt; &lt; HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> Found &lt; Content-Length: <span class="hljs-number"><span class="hljs-number">2</span></span> &lt; Content-Type: application/json &lt; <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>: Tue, <span class="hljs-number"><span class="hljs-number">12</span></span> Jul <span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">40</span></span> GMT &lt; * Connection #<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> host localhost <span class="hljs-built_in"><span class="hljs-built_in">left</span></span> intact</code> </pre> <br><p>  Note: in fact, the entire <code>status</code> module is a wrapper for the corresponding enumerations in the <code>hyper</code> library on which <code>iron</code> is based. </p><br><h2>  Redirect requests </h2><br><p>  For redirect to <code>iron</code> , the <code>Redirect</code> structure from the <code>modifiers</code> module is used (not to be confused with <code>modifier</code> ).  It consists of a target URL, where it will be necessary to redirect. <br>  Let's try to apply it by making the following changes: </p><br><p>  Connect the <code>Redirect</code> structure: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> iron::modifiers::Redirect;</code> </pre> <br><p>  Add the <code>Url</code> module connection to the <code>status</code> module connection: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> iron::{Url, status};</code> </pre> <br><p>  Bind the name of the <code>url</code> , which will store the parsed value of the redirect address: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> url = Url::parse(<span class="hljs-string"><span class="hljs-string">"https://habrahabr.ru/"</span></span>).unwrap();</code> </pre> <br><p>  Change the initialization block Iron as follows: </p><br><pre> <code class="rust hljs"> Iron::new(<span class="hljs-keyword"><span class="hljs-keyword">move</span></span> |_: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Request | { <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(Response::with((status::Found, Redirect(url.clone())))) }).http(<span class="hljs-string"><span class="hljs-string">"localhost:3000"</span></span>).unwrap();</code> </pre> <br><p>  Check the result: </p><br><pre> <code class="hljs markdown">[loomaclin@loomaclin ~]$ curl -v localhost:3000 <span class="hljs-bullet"><span class="hljs-bullet">* Rebuilt URL to: localhost:3000/ *</span></span> Trying ::1... <span class="hljs-bullet"><span class="hljs-bullet">* Connected to localhost (::1) port 3000 (#0) &gt; GET / HTTP/1.1 &gt; Host: localhost:3000 &gt; User-Agent: curl/7.49.1 &gt; Accept: *</span></span>/<span class="hljs-bullet"><span class="hljs-bullet">* &gt; &lt; HTTP/1.1 302 Found &lt; Location: https://habrahabr.ru/ &lt; Date: Tue, 12 Jul 2016 21:39:24 GMT &lt; Content-Length: 0 &lt; *</span></span> Connection #0 to host localhost left intact</code> </pre> <br><p>  You can also use another <code>RedirectRaw</code> structure from the <code>modifiers</code> module, which requires only a string to be constructed. </p><br><h2>  Work with type http-request </h2><br><p>  The <code>Request</code> structure has a <code>method</code> field that allows you to determine the type of the incoming HTTP request. <br>  We will write a service that will save the data transmitted in the request body with the type <code>Put</code> , <br>  read data from a file and transmit it in response to a request of type <code>Get</code> . </p><br><p>  We annotate the imported <code>iron</code> container with the <code>macro_use</code> attribute in order to use the <code>iexpect</code> and <code>itry</code> to handle error situations in the future: </p><br><pre> <code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#[macro_use]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">crate</span></span> iron;</code> </pre> <br><p>  We connect modules for working with the file system and input / output from the standard library: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::io; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::fs;</code> </pre> <br><p>  We connect the <code>method</code> module, which contains the list of http request types: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> iron::method;</code> </pre> <br><p>  We change the initialization block <code>Iron</code> in such a way as to associate the received request with the name <code>req</code> : </p><br><pre> <code class="rust hljs">Iron::new(|req: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Request| { ... ... ... }.http(<span class="hljs-string"><span class="hljs-string">"localhost:3000"</span></span>).unwrap();</code> </pre> <br><p>  We add to the processing of the request a pattern matching the <code>method</code> field for two types of <code>Get</code> and <code>Put</code> requests, and for the rest we will use the answer in the form of the <code>BadRequest</code> status code: </p><br><pre> <code class="rust hljs"> <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> req.method { method::Get =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> f = iexpect!(fs::File::open(<span class="hljs-string"><span class="hljs-string">"foo.txt"</span></span>).ok(), (status::<span class="hljs-literal"><span class="hljs-literal">Ok</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); Response::with((status::<span class="hljs-literal"><span class="hljs-literal">Ok</span></span>, f)) }, method::Put =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> f = itry!(fs::File::create(<span class="hljs-string"><span class="hljs-string">"foo.txt"</span></span>)); itry!(io::copy(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> req.body, &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> f)); Response::with(status::Created) }, _ =&gt; Response::with(status::BadRequest) }</code> </pre> <br><p>  In <code>Iron</code> <code>iexcept</code> macro <code>iexcept</code> used to expand an <code>Option</code> object passed to it, and if <code>Option</code> contains <code>None</code> macro returns <code>Ok(Response::new())</code> with the default modifier <code>status::BadRequest</code> . <br>  The <code>itry</code> macro <code>itry</code> used to wrap an error in <code>IronError</code> . </p><br><p>  We try to run and test performance. </p><br><p>  PUT: </p><br><pre> <code class="hljs ruby">[loomaclin@loomaclin ~]$ curl -X PUT -d my_file_content <span class="hljs-symbol"><span class="hljs-symbol">localhost:</span></span><span class="hljs-number"><span class="hljs-number">3000</span></span> [loomaclin@loomaclin ~]$ cat ~<span class="hljs-regexp"><span class="hljs-regexp">/IdeaProjects/cycle</span></span><span class="hljs-regexp"><span class="hljs-regexp">/foo.txt my_file_content</span></span></code> </pre> <br><p>  GET: </p><br><pre> <code class="hljs ruby">[loomaclin@loomaclin ~]$ curl <span class="hljs-symbol"><span class="hljs-symbol">localhost:</span></span><span class="hljs-number"><span class="hljs-number">3000</span></span> my_file_content</code> </pre> <br><p>  POST: </p><br><pre> <code class="hljs vbscript">[loomaclin@loomaclin ~]$ curl -X POST -v localhost:<span class="hljs-number"><span class="hljs-number">3000</span></span> * Rebuilt URL <span class="hljs-keyword"><span class="hljs-keyword">to</span></span>: localhost:<span class="hljs-number"><span class="hljs-number">3000</span></span>/ * Trying ::<span class="hljs-number"><span class="hljs-number">1.</span></span>.. * Connected <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> localhost (::<span class="hljs-number"><span class="hljs-number">1</span></span>) port <span class="hljs-number"><span class="hljs-number">3000</span></span> (#<span class="hljs-number"><span class="hljs-number">0</span></span>) &gt; POST / HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> &gt; Host: localhost:<span class="hljs-number"><span class="hljs-number">3000</span></span> &gt; User-Agent: curl/<span class="hljs-number"><span class="hljs-number">7.49</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; Accept: */* &gt; &lt; HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">400</span></span> Bad <span class="hljs-built_in"><span class="hljs-built_in">Request</span></span> &lt; Content-Length: <span class="hljs-number"><span class="hljs-number">0</span></span> &lt; <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>: Tue, <span class="hljs-number"><span class="hljs-number">12</span></span> Jul <span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span> GMT &lt; * Connection #<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> host localhost <span class="hljs-built_in"><span class="hljs-built_in">left</span></span> intact</code> </pre> <br><h2>  Implementing end-to-end functionality using pre- and post-processing </h2><br><p>  In <code>iron</code> there are also types of <code>BeforeMiddleware</code> , <code>AfterMiddleware</code> and <code>AroundMiddleware</code> for <code>AroundMiddleware</code> -through functionality, <br>  allowing to implement the logic for processing the request before it started in the main handler, and after it ended there. </p><br><p>  Let's write an example of using <del>  AOP'o similar </del>  specified types: </p><br><div class="spoiler">  <b class="spoiler_title">Sample code</b> <div class="spoiler_text"><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">crate</span></span> iron; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> iron::prelude::*; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> iron::{BeforeMiddleware, AfterMiddleware, AroundMiddleware, Handler}; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleStruct</span></span></span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleStructAroundHandler</span></span></span></span>&lt;H:Handler&gt; { logger: SampleStruct, handler: H} <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> BeforeMiddleware <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> SampleStruct { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">before</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, req: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Request) -&gt; IronResult&lt;()&gt; { <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"  ."</span></span>); <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(()) } } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> AfterMiddleware <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> SampleStruct { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">after</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, req: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Request, res: Response) -&gt; IronResult&lt;Response&gt; { <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"  ."</span></span>); <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(res) } } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span>&lt;H: Handler&gt; Handler <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> SampleStructAroundHandler&lt;H&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, req: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Request) -&gt; IronResult&lt;Response&gt; { <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"     ."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> res = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.handler.handle(req); res } } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> AroundMiddleware <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> SampleStruct { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">around</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, handler: <span class="hljs-built_in"><span class="hljs-built_in">Box</span></span>&lt;Handler&gt;) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Box</span></span>&lt;Handler&gt; { <span class="hljs-built_in"><span class="hljs-built_in">Box</span></span>::new(SampleStructAroundHandler { logger: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, handler: handler }) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Box</span></span>&lt;Handler&gt; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sample_of_middlewares</span></span></span></span>(_:&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Request) -&gt; IronResult&lt;Response&gt; { <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"   ."</span></span>); <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(Response::with((iron::status::<span class="hljs-literal"><span class="hljs-literal">Ok</span></span>, <span class="hljs-string"><span class="hljs-string">",    !"</span></span>))) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> chain = Chain::new(sample_of_middlewares); chain.link_before(SampleStruct); chain.link_after(SampleStruct); chain.link_around(SampleStruct); Iron::new(chain).http(<span class="hljs-string"><span class="hljs-string">"localhost:3000"</span></span>).unwrap(); }</code> </pre> </div></div><br><p>  This example introduces the <code>SampleStruct,</code> structure for which the <code>BeforeMiddleware</code> types with the <code>before</code> function and <code>AfterMiddleware</code> with the <code>after</code> function are implemented.  With their help, all end-to-end logic can be implemented.  The <code>AroundMiddleware</code> type <code>AroundMiddleware</code> used in conjunction with the <code>Handler</code> type to add an additional handler.  Add all implemented <br>  handlers in the request processing life cycle is performed using a special type of <code>Chain</code> , which allows you to form a chain of calls to pre and post handlers. </p><br><p>  Test the program. <br>  In the console: </p><br><pre> <code class="hljs ruby">[loomaclin@loomaclin ~]$ curl <span class="hljs-symbol"><span class="hljs-symbol">localhost:</span></span><span class="hljs-number"><span class="hljs-number">3000</span></span> ,    !</code> </pre> <br><p>  In the output of the program: </p><br><pre> <code class="hljs pgsql"> Running `target/<span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">cycle</span></span>`   .      .    .   .</code> </pre> <br><h2>  Routing </h2><br><p>  What server API can do without routing?  Add it =) Modify our basic example from the beginning of the article as follows. </p><br><p>  We connect the collection from the standard library: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::collections:HashMap;</code> </pre> <br><p>  Let's declare the structure for storing the collection ‚Äúpath-handler‚Äù and describe for this structure the constructor, which will initialize this collection, and the function to add new routes to the collection with their handlers: </p><br><pre> <code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Router</span></span></span></span> { routes: HashMap&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">Box</span></span>&lt;Handler&gt;&gt; } <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Router { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span></span>() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">Self</span></span> { Router { routes: HashMap::new() } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_route</span></span></span></span>&lt;H&gt;(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, path: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, handler: H) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> H: Handler { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.routes.insert(path, <span class="hljs-built_in"><span class="hljs-built_in">Box</span></span>::new(handler)); } }</code> </pre> <br><p>  To use our structure in conjunction with <code>Iron</code> you need to implement for it the type <code>Handler</code> with the function <code>handle</code> : </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Handler <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Router { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, req: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Request) -&gt; IronResult&lt;Response&gt; { <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.routes.get(&amp;req.url.path().join(<span class="hljs-string"><span class="hljs-string">"/"</span></span>)) { <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(handler) =&gt; handler.handle(req), <span class="hljs-literal"><span class="hljs-literal">None</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(Response::with(status::NotFound)) } } }</code> </pre> <br><p>  In the <code>handle</code> function, by the path passed in the request, we find the corresponding handler in the collection and call the handler of this path with the transfer of the request to it.  If the path passed in the request is not "registered" in the collection, the response with the <code>NotFound</code> error code is <code>NotFound</code> . </p><br><p>  The last thing to do is to initialize our router and register in it the paths we need with their handlers: </p><br><pre> <code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> router = Router::new(); router.add_route(<span class="hljs-string"><span class="hljs-string">"hello_habrahabr"</span></span>.to_string(), |_: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Request| { <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(Response::with((status::<span class="hljs-literal"><span class="hljs-literal">Ok</span></span>, <span class="hljs-string"><span class="hljs-string">"Hello Loo Maclin!\n"</span></span>))) }); router.add_route(<span class="hljs-string"><span class="hljs-string">"hello_habrahabr/again"</span></span>.to_string(), |_: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Request| { <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(Response::with((status::<span class="hljs-literal"><span class="hljs-literal">Ok</span></span>, <span class="hljs-string"><span class="hljs-string">" !\n"</span></span>))) }); router.add_route(<span class="hljs-string"><span class="hljs-string">"error"</span></span>.to_string(), |_: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Request| { <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(Response::with(status::BadRequest)) }); ...</code> </pre> <br><p>  Adding new paths occurs by calling the function implemented above. <br>  Initialize the <code>Iron</code> instance using our router: </p><br><pre> <code class="rust hljs">Iron::new(router).http(<span class="hljs-string"><span class="hljs-string">"localhost:3000"</span></span>).unwrap();</code> </pre> <br><p>  Testing: </p><br><pre> <code class="hljs vbscript">[loomaclin@loomaclin ~]$ curl localhost:<span class="hljs-number"><span class="hljs-number">3000</span></span>/hello_habrahabr Hello Loo Maclin! [loomaclin@loomaclin ~]$ curl localhost:<span class="hljs-number"><span class="hljs-number">3000</span></span>/hello_habrahabr/again  ! [loomaclin@loomaclin ~]$ curl -v localhost:<span class="hljs-number"><span class="hljs-number">3000</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">error</span></span> * Trying ::<span class="hljs-number"><span class="hljs-number">1.</span></span>.. * Connected <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> localhost (::<span class="hljs-number"><span class="hljs-number">1</span></span>) port <span class="hljs-number"><span class="hljs-number">3000</span></span> (#<span class="hljs-number"><span class="hljs-number">0</span></span>) &gt; <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">error</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> &gt; Host: localhost:<span class="hljs-number"><span class="hljs-number">3000</span></span> &gt; User-Agent: curl/<span class="hljs-number"><span class="hljs-number">7.49</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> &gt; Accept: */* &gt; &lt; HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">400</span></span> Bad <span class="hljs-built_in"><span class="hljs-built_in">Request</span></span> &lt; <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>: Wed, <span class="hljs-number"><span class="hljs-number">13</span></span> Jul <span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> GMT &lt; Content-Length: <span class="hljs-number"><span class="hljs-number">0</span></span> &lt; * Connection #<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> host localhost <span class="hljs-built_in"><span class="hljs-built_in">left</span></span> intact</code> </pre> <br><h2>  Conclusion </h2><br><p>  This article comes to an end. <br>  In addition to the considered functionality, Iron takes out most of the typical web framework functionality for the base extensions: </p><br><ul><li>  <a href="https://github.com/iron/router">Routing</a> </li><li>  <a href="https://github.com/iron/mount">Mounting</a> </li><li>  <a href="https://github.com/iron/staticfile">Work with static files</a> </li><li>  <a href="https://github.com/iron/logger">Logging</a> </li><li>  <a href="https://github.com/iron/body-parser">JSON parsing into structures</a> </li><li>  <a href="https://github.com/iron/urlencoded">Work with encoded URL</a> </li><li>  <a href="https://github.com/iron/cookie">Cookies</a> </li><li>  <a href="https://github.com/iron/session">Session mechanism</a> </li></ul><br><p>  The article is intended for basic acquaintance with Iron, and I would like to hope that it copes with this goal. </p><br><p>  Thanks for attention! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/305714/">https://habr.com/ru/post/305714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305704/index.html">Why break even secure CMS on a secure hosting</a></li>
<li><a href="../305706/index.html">Add an arbitrary phone in the personal account of the mobile operator Kyivstar (Ukraine)</a></li>
<li><a href="../305708/index.html">Impressions from the best reports at the International PHP Conference</a></li>
<li><a href="../305710/index.html">GIMP 2.9.4 released</a></li>
<li><a href="../305712/index.html">ViaLatM and social functions</a></li>
<li><a href="../305716/index.html">Opening API for working with services from Russian low-cost host (part 1)</a></li>
<li><a href="../305718/index.html">Checking the source code of FlashDevelop with PVS-Studio</a></li>
<li><a href="../305720/index.html">Business Processes: How everything is started and confused. Chapter Three General BPM Classification and BPMS Philosophy</a></li>
<li><a href="../305722/index.html">How to write a good text for a site or email-letter: WIIFM technology</a></li>
<li><a href="../305724/index.html">Features of the choice of solid-state drives (SSD) for servers and RAID-arrays</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>