<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We pump smart charging Imax B6</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Truly they say: laziness is the engine of progress! So I thought the mind was agitated to automate the process of measuring and training acid batterie...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We pump smart charging Imax B6</h1><div class="post__text post__text-html js-mediator-article">  Truly they say: laziness is the engine of progress!  So I thought the mind was agitated to automate the process of measuring and training acid batteries.  After all, who, in his right mind, will, in this age of smart chips, hang on a battery with multimeters and a stopwatch?  Surely, many people know the "national" charger Imax B6.  On Habr√© there is <a href="http://habrahabr.ru/post/150213/">an article</a> about him (and not even one).  Below I will write what I did to her and why. <br><br><img src="https://habrastorage.org/files/5c1/a46/30e/5c1a4630e1ce4af195f96c2943aac4e1.jpg"><br><a name="habracut"></a><br><h3>  Accuracy </h3><br>  In the beginning, my goal was to increase the discharge capacity in order to measure my batteries for a bespereboynik and, in perspective, train them without risking premature old age (me, well, not batteries).  Chased the device in disassembled form. <br><br>  Inside, it is generously packed with a variety of differential amplifiers, a multiplexer, a high-efficiency buck-boost regulator, a good package, and an open source code for a <u>very good</u> firmware can be found in the network.  With a charging current of up to 5 amps, they can even charge car batteries at 50A / h (current 0.1C).  With all this, at the same time, wealth, as current sensors, ordinary 1 W resistors are used here, which, among other things, work at the limit of their power, which means that their resistance drops significantly under load.  Can you trust such a measuring device?  Having blown up and having touched these ‚Äúsensors‚Äù with doubts, the doubts are gone - I want to redo them for manganin shunts! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Manganin (there is also constantan) is a special alloy for shunts, which practically do not change their resistance from heating.  But its resistance is an order of magnitude smaller than replaceable resistors.  Also, in the circuit of the device, operational amplifiers are used to amplify the voltage from the sensor to readable microcontroller values ‚Äã‚Äã(I suppose the upper limit of digitization is the reference voltage from TL431, about 2.495 volts). <br><br>  My refinement is to solder the shunts instead of resistors, and compensate for the difference in levels by changing the gain of the operational amplifiers to LM2904: DA2: 1 and DA1: 1 (see diagram). <br><br><div class="spoiler">  <b class="spoiler_title">Scheme</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/a39/52e/f0b/a3952ef0b7903dce7c9e99270d3c2f1f.jpg" alt="image"><br></div></div><br>  To rework we need: the device itself is original (I describe the remake of the original), manganin shunts (I took from Chinese multimeters), ISP programmer, cheali-charger firmware (for calibration), Atmel Studio for its assembly (not necessary), eXtreme Burner AVR for its firmware and experience <s>in building bricks for</s> successful firmware atmega (All links are at the end of the article). <br>  And also: the ability to solder SMD and an irresistible desire to restore justice. <br><br>  I have never studied the design of circuits and amateur radio in general, so it was <s>lazy</s> to make such changes to a working device like this on the move.  And then multisim came to the rescue!  It is possible without touching the soldering iron in it: to realize the idea, debug it, correct mistakes and understand whether it will work at all.  In this example, I modeled a piece of the circuit, with an operational amplifier, for a circuit providing a charge mode: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/737/de7/f7a/737de7f7a522b935132797c4a9f57d1c.png" alt="image"><br><br>  R77 creates negative feedback.  Together with R70, they form a divider that sets the gain, which can be calculated something like this (R77 + R70) / R70 = gain.  My shunt turned out to be about 6.5 mŒ©, which at a current of 5 A will amount to a voltage drop of 32.5 mV, and we need to get 1.96 V to match the logic of the circuit and the expectations of its developer.  I took 1 kŒ© and 57 kŒ© resistors as R70 and R77 respectively.  The simulator turned out to be 1.88 volts at the output, which is quite acceptable.  I also threw out the resistors R55 and R7, as reducing linearity, they are not used in the photo (perhaps this is a mistake), and the shunt connected it with dedicated wires to the bottom of R70, C18, and the top of the shunt directly to the "+" input of the OU. <br><br> <a href=""><img src="https://habrastorage.org/files/cb1/68f/b01/cb168fb01dd34b839bb459b59aa8e71e.jpg"></a> <br><br>  The extra tracks are trimmed, including on the reverse side of the board.  It is important to solder the wiring well, so that they do not fall off, over time, from the shunt or the board, because not only the microcontroller's ADC is powered from this sensor, but also the feedback on the current of the pulse controller, which, when a signal is lost, can go into maximum mode and to ditch <br><br>  The circuit for the discharge mode is not fundamentally different, but since I am putting the VT7 on the radiator, and increasing the discharge power to the limit of the field (94W on datasheet), I would also like to set the maximum discharge current more. <br><br>  As a result, I received: R50 - shunt 5.7 mŒ©, R8 and R14 - 430 Ohms and 22 kŒ©, respectively, which gives the required 1.5 volts at the output at a current through the shunt 5 A. However, I experimented with a high current - maximum It was 5.555 A, so I stitched a limit of 5.5 A into the firmware (in the file "cheali-charger \ src \ hardware \ atmega32 \ targets \ imaxB6-original \ HardwareConfig.h"). <br><br>  In the course of the problem got out - the charger refused to admit that it is calibrated (i discharge).  This is due to the fact that not the macro definition MAX_DISCHARGE_I in the file ‚ÄúHardwareConfig.h‚Äù, but the second calibration point for checking the first one (the points are described in the file ‚ÄúGlobalConfig.h‚Äù) are used for testing.  I did not begin to delve into these subtleties of the intricacies of the code and just cut out this check in the checkAll () function in the ‚ÄúCalibrate.cpp‚Äù file. <br><br>  As a result of alterations, a device turned out that provided an acceptable linearity of measurements in the range from 100mA to 5A and which could be called measuring if not for one thing: since I left a powerful bit field inside the case (despite improved cooling), the board was heated it still distorts the result of the measurement, and the measurements ‚Äúfloat‚Äù a little downward ... Not sure who is to blame for this: the error amplifier or the microcontroller ADC.  In any case, IMHO, it is necessary to move this field to the outside of the case and provide him with sufficient cooling (up to 94W or replace it with another suitable N-channel). <br><br><h3>  Firmware </h3><br>  I did not want to write about it, but they made me. <br><br><ol><li>  Download and install the necessary materials (links at the end of the article). <br><br></li><li>  On the programmer we unsolder and put the jumper JP3 - this will switch the interface to a slow mode.  Until I put the jumper - I had problems with the firmware. <br><br></li><li>  We connect the programmer to the device, and the programmer to the computer (the picture below is for the original device! The clone is connected differently): <br><br><img src="https://habrastorage.org/files/cc9/dd7/52a/cc9dd752aae141a496b4fbd79da0961f.jpg"><br><br></li><li>  In the program of eXtreme Burner, choose our chip (menu Chip-&gt; ATmega32), after which we try to read everything (Read All).  If everything worked out, the original firmware and EEPROM can be saved anywhere, just in case. <br><br></li><li>  Now we will try to compile our firmware (this action is not necessary, you can take the finished one from the ‚Äúcheali-charger \ hex \ cheali-charger-imaxB6-original-0.33.hex‚Äù folder, in that case, go to step 6). <br>  In general, how and what can be done is often written in the accompanying documentation, for example, about the assembly - in the file ‚Äúbuilding.md‚Äù. <br><br>  In this case, the order is as follows: <br><br><ul><li>  install atmel studio and cmake </li><li>  Run Atmel Studio Command Prompt and go to the folder with <br>  cheali-charger. <br>  That is, for example: cd s: \ cheali-charger </li><li>  execute: s: \ cheali-charger&gt; cmake.  -G "Unix" <br>  Makefiles </li><li>  execute: s: \ cheali-charger&gt; make </li><li>  A firmware file should be created here: <br>  "S: \ cheali-charger \ src \ hardware \ atmega32 \ targets \ imaxB6-original \ cheali-charger * .hex" </li></ul><br></li><li>  Download our firmware in eXtreme Burner, then click Write-&gt; Flash.  God forbid to sew by mistake ‚Äúeverything‚Äù, for example: wrong fyuzy, which are on the third tab - in this case, you can lose access for further firmware through the ISP, and maybe through other interfaces.  It is really possible to revive the resulting brick only on a high-voltage parallel programmer.  Just in case, the correct fyuzy: low = 3F, high = C5. <br><br></li><li>  Calibration.  It will need a li-ion battery of at least 2 cells.  The calibration order can be read in ‚ÄúREADME.md‚Äù.  It is possible, by rearranging it towards the balanced connector, to calibrate all 6 inputs, while the first 2 can be calibrated separately (more precisely) in the expert calibration menu, written about it in ‚Äúcalibration_expert.md‚Äù. </li></ol><br><h3>  A little about my completion of cooling </h3><br>  The field VT7, in a new place, is glued on a hot-melt glue, and its heat sink is soldered to the copper plate: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/38a/0ad/fc8/38a0adfc8f76618f24b15111f437cc46.jpg"><br><br>  Cooling decided to make an unnecessary radiator on the heat pipe from the motherboard.  The photo shows a suitable pressure plate and a transistor pad, along the perimeter of which an insulating plastic is laid - just in case.  The heels of the soldering iron tip are soldered directly to the board, to the common wire - will play the role of an additional heat sink from the converter: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/08c/982/ffe/08c982ffe86d4b8b6b96afc4425dd880.jpg"></a> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/6e4/2c7/083/6e42c708379ea281178c88c7b499f73c.jpg"></a> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/f6c/ae9/2e1/f6cae92e1756e387e676235494b6894a.jpg"></a> <br><br>  The assembled design does not hurt to stand on the legs of the device: <br><br> <a href="http://radikal.ru/fp/307ba0e333c140e48f9cbcde104c046e"><img src="https://habrastorage.org/getpro/habr/post_images/45f/ffa/a62/45fffaa62a21571eef9e4b3316398be8.jpg"></a> <a href="http://radikal.ru/fp/b72defce17fc4a3882565b8c4d4381c5"><img src="https://habrastorage.org/getpro/habr/post_images/0b7/f64/9fd/0b7f649fd6755d164a2d8cd9cfee3a99.jpg"></a> <br><br>  Ready for firmware: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/8af/5ec/577/8af5ec577cbac34b75be3b40d5d64588.jpg"></a> <br><br>  I experienced this alteration in passive cooling mode: a discharge of 20 minutes for a 6-volt Pb-battery with a maximum current of 5.5A.  The power is highlighted 30 ... 31W.  The temperature on the heat pipe, through a thermocouple, reached 91 ¬∞ C, the case also became hot and, at some point, the screen began to turn purple.  I, of course, immediately interrupted the test.  The screen could not bounce back for a long time, but then let it go. <br><br>  Now it is obvious that the portable load unit, with a detachable connection, would be the best solution: there are no restrictions on the size of the radiator and the fan, and the charge itself would be more compact and light (no discharge is needed in the field). <br><br>  I hope that this article will help newcomers to be bolder in experiments on helpless pieces of hardware. <br>  Comments and additions are welcome. <br><br>  <b><font color="red">Warning</font></b> : the described modifications, when misused, can damage the charging components, turn it into an irreversible "brick", as well as reduce the reliability of the device and create a risk of fire.  The author declines responsibility for possible damage, including for wasted time. <br><br><h3>  Links </h3><br>  Alternative cheali-charger firmware: <a href="https://github.com/stawel/cheali-charger">https://github.com/stawel/cheali-charger</a> (Her youtube review: <a href="http://www.youtube.com/watch%3Fv%3DOU3tUc5qOTQ">one</a> , <a href="http://www.youtube.com/watch%3Fv%3D8z-kbDg9rcY">two</a> ). <br>  To compile the firmware: <a href="http://www.atmel.com/tools/ATMELSTUDIO.aspx">Atmel Studio</a> and <a href="http://www.cmake.org/">CMake</a> <br>  Flash programmer: <a href="http://extremeelectronics.co.in/avr-tutorials/gui-software-for-usbasp-based-usb-avr-programmers/">eXtreme Burner AVR</a> <br>  ISP Programmer: <a href="http://www.ebay.com/itm/USB-ISP-USBASP-Programmer-for-ATMEL-51-AVR-Programmer-M80-/291325525791%3Fpt%3DLH_DefaultDomain_0%26hash%3Ditem43d45abf1f">USBASP Programmer for ATMEL</a> </div><p>Source: <a href="https://habr.com/ru/post/250661/">https://habr.com/ru/post/250661/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250641/index.html">Solution: Adobe AIR does not find a connected iOS device from under Windows 7</a></li>
<li><a href="../250643/index.html">Without cuts. The second month of cashback service Kubyshka in Russia</a></li>
<li><a href="../250653/index.html">Setting up the IPAM service step by step</a></li>
<li><a href="../250657/index.html">DevCon Digest # 2. Immerse in ASP.NET</a></li>
<li><a href="../250659/index.html">Android application architecture ... The right way?</a></li>
<li><a href="../250663/index.html">No cdn one</a></li>
<li><a href="../250665/index.html">Using AppBarButton in Windows 8.1</a></li>
<li><a href="../250667/index.html">Legacy code is cancer</a></li>
<li><a href="../250669/index.html">Seventh annual Microsoft Research Summer School. This time about machine learning and intelligence</a></li>
<li><a href="../250671/index.html">Insecure password storage in IBM WebSphere</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>