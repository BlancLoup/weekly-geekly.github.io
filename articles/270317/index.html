<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Material ProgressBar for pre-Lollipop</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the time of this writing, I am working with great guys at Novoda on an application for broadcasting video for television in the UK Channel 4 . One ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Material ProgressBar for pre-Lollipop</h1><div class="post__text post__text-html js-mediator-article"> At the time of this writing, I am working with great guys at <a href="https://www.novoda.com/">Novoda</a> on an application for broadcasting video for television in the UK <a href="http://www.channel4.com/">Channel 4</a> .  One of the design elements that I had to implement was an endless ProgressBar in the Material Design style.  For Android Lollipop and above, the creation of such a design is easy, but now the support of devices of earlier OS versions has become a test for us.  In this article we will look at a solution to this problem. <br><br>  First, let's see how the endless <code>ProgressBar</code> works on Lollipop: <br><br><img src="https://habrastorage.org/files/ec9/897/593/ec98975938e04e338a6fd1d84ebed6e0.gif">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      While the style of the widget looked pretty easy to implement, the root of the problem lay in animation with an indefinite time.  The short line goes from left to right, but its length varies throughout the journey. <br><a name="habracut"></a><br>  First of all, I decided to make a backport to the existing solution.  But there were some implementation difficulties, since <code>AnimatedVectorDrawable</code> used there, which is not available until Lollipop.  The solution that I found was a little insidious, but it still gave me a surprisingly very similar result. <br><br>  The solution includes the creation of our own implementation of the <code>ProgressBar</code> (which is the successor of the standard <code>ProgressBar</code> ) which completely bypasses the standard logic of indefinite time and implements its own based on the standard primary and secondary behavior that is already built into the <code>ProgressBar</code> .  The trick is in the method of processing it - first the background, then the second progress and then the first.  If the background and the primary progress of one color, and the secondary progress of another color, then the effect of changing the length. <br><br>  Let's look at an example for a better understanding.  If we set the background color to light green, the secondary progress is medium green, and the primary progress is dark green, we get the following result: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/85c/1b8/b69/85c1b8b6923cb67603790b6cd14fe647.png" alt="image"><br><br>  However, if we set the primary color to be the same as the background, we get the desired effect: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/614/05c/1d5/61405c1d59dbc7cc1500e5d4155c46c5.png" alt="image"><br><br>  We can customize the start and end points simply by setting the secondaryProgress value and the ProgressBar value, respectively. <br><br>  And now let's see how we implemented it in the code: <br><br><div class="spoiler">  <b class="spoiler_title">Implementation code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MaterialProgressBar</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProgressBar</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> INDETERMINATE_MAX = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String SECONDARY_PROGRESS = <span class="hljs-string"><span class="hljs-string">"secondaryProgress"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String PROGRESS = <span class="hljs-string"><span class="hljs-string">"progress"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Animator animator = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> duration; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MaterialProgressBar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, AttributeSet attrs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> defStyleAttr)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context, attrs, defStyleAttr); TypedArray ta = context.obtainStyledAttributes(attrs, R.styleable.MaterialProgressBar, defStyleAttr, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> backgroundColour; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> progressColour; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { backgroundColour = ta.getColor(R.styleable.MaterialProgressBar_backgroundColour, <span class="hljs-number"><span class="hljs-number">0</span></span>); progressColour = ta.getColor(R.styleable.MaterialProgressBar_progressColour, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> defaultDuration = context.getResources().getInteger(android.R.integer.config_mediumAnimTime); duration = ta.getInteger(R.styleable.MaterialProgressBar_duration, defaultDuration); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { ta.recycle(); } Resources resources = context.getResources(); setProgressDrawable(resources.getDrawable(android.R.drawable.progress_horizontal)); createIndeterminateProgressDrawable(backgroundColour, progressColour); setMax(INDETERMINATE_MAX); <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.setIndeterminate(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setIndeterminate(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createIndeterminateProgressDrawable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@ColorInt </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> backgroundColour, @ColorInt </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> progressColour)</span></span></span><span class="hljs-function"> </span></span>{ LayerDrawable layerDrawable = (LayerDrawable) getProgressDrawable(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (layerDrawable != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { layerDrawable.mutate(); layerDrawable.setDrawableByLayerId(android.R.id.background, createShapeDrawable(backgroundColour)); layerDrawable.setDrawableByLayerId(android.R.id.progress, createClipDrawable(backgroundColour)); layerDrawable.setDrawableByLayerId(android.R.id.secondaryProgress, createClipDrawable(progressColour)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Drawable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createClipDrawable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@ColorInt </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> colour)</span></span></span><span class="hljs-function"> </span></span>{ ShapeDrawable shapeDrawable = createShapeDrawable(colour); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClipDrawable(shapeDrawable, Gravity.START, ClipDrawable.HORIZONTAL); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> ShapeDrawable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createShapeDrawable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@ColorInt </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> colour)</span></span></span><span class="hljs-function"> </span></span>{ ShapeDrawable shapeDrawable = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ShapeDrawable(); setColour(shapeDrawable, colour); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> shapeDrawable; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setColour</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ShapeDrawable drawable, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> colour)</span></span></span><span class="hljs-function"> </span></span>{ Paint paint = drawable.getPaint(); paint.setColor(colour); } . . . }</code> </pre></div></div><br>  The main method here is <code>createIndeterminateProgressDrawable()</code> which replaces the layer in <code>LayerDrawable</code> (which will be processed as a <code>ProgressBar</code> ) with matching colors. <br><br>  I would also like to note that we rigidly prescribe this as a <code>ProgressBar</code> with an indefinite time in the constructor - in order to preserve the simplicity and ease of understanding the example.  In fact, there is additional code for switching the standard <code>ProgressBar</code> to a mode with an indefinite time. <br><br>  Now we can draw a segment, but how to animate it?  This is surprisingly simple - we animate progress and secondary progress with the value of the ProgressBar, but using different interpolators: <br><br><div class="spoiler">  <b class="spoiler_title">Implementation code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MaterialProgressBar</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProgressBar</span></span></span><span class="hljs-class"> </span></span>{ . . . <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setIndeterminate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> indeterminate)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isStarted()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } animator = createIndeterminateAnimator(); animator.setTarget(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); animator.start(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> animator != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; animator.isStarted(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Animator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createIndeterminateAnimator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ AnimatorSet set = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnimatorSet(); Animator progressAnimator = getAnimator(SECONDARY_PROGRESS, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DecelerateInterpolator()); Animator secondaryProgressAnimator = getAnimator(PROGRESS, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AccelerateInterpolator()); set.playTogether(progressAnimator, secondaryProgressAnimator); set.setDuration(duration); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> set; } <span class="hljs-meta"><span class="hljs-meta">@NonNull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> ObjectAnimator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAnimator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String propertyName, Interpolator interpolator)</span></span></span><span class="hljs-function"> </span></span>{ ObjectAnimator progressAnimator = ObjectAnimator.ofInt(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, propertyName, <span class="hljs-number"><span class="hljs-number">0</span></span>, INDETERMINATE_MAX); progressAnimator.setInterpolator(interpolator); progressAnimator.setDuration(duration); progressAnimator.setRepeatMode(ValueAnimator.RESTART); progressAnimator.setRepeatCount(ValueAnimator.INFINITE); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> progressAnimator; } }</code> </pre></div></div><br>  Having made our <code>ProgressBar</code> bit more than usual, and slightly slowing down the animation, we will see the following: <br><br><img src="https://habrastorage.org/files/598/f7e/d4e/598f7ed4e205480f95416c53bf5ec1c7.gif"><br><br>  Nevertheless, we‚Äôll return it to normal sizes and speeds and compare it to the standard ProgressBar widget of indefinite time implemented in Lollipop: <br><br><img src="https://habrastorage.org/files/4c7/eb5/ce0/4c7eb5ce09f44be98d2b2ed821a4cdc7.gif"><br><br>  Of course, they are not identical - the implementation in Lollipop has an animation a second shorter.  In spite of this, this implementation is close enough to the original to be used on devices prior to Lollipop. <br><br>  The source code used in the article is available <a href="https://github.com/StylingAndroid/MaterialProgressBar/tree/master">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/270317/">https://habr.com/ru/post/270317/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270307/index.html">A cryptographic program encrypts user files offline.</a></li>
<li><a href="../270309/index.html">Creating a plugin for Intellij IDEA. Notes and small tips</a></li>
<li><a href="../270311/index.html">Utility for the developer</a></li>
<li><a href="../270313/index.html">Project Cenntenial</a></li>
<li><a href="../270315/index.html">The results of the competition held by our company on SECR2015</a></li>
<li><a href="../270321/index.html">Workflow automation for a small development team (Part 2)</a></li>
<li><a href="../270323/index.html">Microsoft cloud-based prescription services: the practice of Russian service providers</a></li>
<li><a href="../270325/index.html">Next, in search of palindromes</a></li>
<li><a href="../270327/index.html">Call Tracking Paying Lead, Not Numbers</a></li>
<li><a href="../270329/index.html">Correctly parsim logs from 3CX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>