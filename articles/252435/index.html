<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring Amazon Elastic Load Balancing: with email forwarding and redirects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The release time of my weekend project was approaching. Mobile apps were uploaded to the app stores and we were waiting for a response from Apple, sin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring Amazon Elastic Load Balancing: with email forwarding and redirects</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/85e/aba/0de/85eaba0deedb4a14b785b532f27eb07f.png" alt="image"><br><br>  The release time of my weekend project was approaching.  Mobile apps were uploaded to the app stores and we were waiting for a response from Apple, since the Google Play checkout is pretty quick and painless.  All server application code was already written, there was nothing to do, and free time was about a week.  I thought that it would be nice to acquire a load balancer in advance so as not to spend a lot of time setting it up in the future, and besides, setting up after the release would most likely cause the server to stop servicing users for a while.  For hosting servers, we used Amazon EC2, and therefore we chose Amazon Balancer (ELB) as the load balancer. <br><a name="habracut"></a><br><h4>  As it was </h4><br>  The domain was registered at <a href="http://www.internetbs.net/">Internet.bs</a> , on ec2 the server was assigned a permanent ip address via elastic ip.  Accordingly, the domain registrar had an A record (A record), which indicated this ip.  Also, a good registrar provided the opportunity to set up email forwarding, which I gladly took advantage of to receive mail sent to feeback@imyarek.com to my inbox.  Also, the registrar was able to redirect from one subdomain name to another, which I used to redirect all users from <a href="http://www.xn--e1afhgu3g.com/">www.namere.com</a> to name.com.  When I moved, I wanted to save it all, without installing additional servers and applications, and even more so there was no desire to write additional code. <br><br><h4>  Relocation: ELB, Route53 and NS Records </h4><br>  The first thing I did was set up ELB.  Everything is quite simple here: in EC2, on the Load Balancers tab, click Create Create Load Balancer and select which server ports to correspond to which ELB ports through the convenient dialog, configure Health Check (periodically checking the availability of some URL on the ELB server will determine which servers are alive, and which ones should not be sent requests, because they do not respond), and choose the server to which the load will be distributed.  All these parameters can then be changed on the already running ELB.  By the way, if your web application uses HTTPS, I recommend to configure it on ELB, and use http on application servers, this will relieve your servers.  In our case, this allowed us to process several times more requests per second. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Then it was time to bind the domain to ELB, because, although ELB was not configured, the server with the application was still used directly.  Since ELB has a dynamic ip address, linking it simply with the help of A record will not work.  To do this, you will have to use another Amazon service - Route 53. To do this, you need to create a hosted zone with our domain name.  This will create 2 entries - NS and SOA.  To bind a domain to a hosted zone, you need to create or replace an NS record at the domain registrar with values ‚Äã‚Äãfrom the NS record of the hosted zone.  Next, you need to specify what our domain will correspond to, for this you need to create an A (A record) record in the Hosted Zone with the alias option selected and select our ELB in the Alias ‚Äã‚ÄãTarget drop-down list. <br><br><img src="https://habrastorage.org/files/f36/313/afa/f36313afa22242b2a503e1de4ec272f0.png" alt="image"><br><br>  After that, our server became available again at the old address.  But he began to respond only to requests to the address without www, and the address from www did not respond at all. <br><br><h4>  We configure 301 Redirect to the domain without www from the domain with www </h4><br>  You can configure and vice versa, the setting will be completely similar.  Why 301 Redirect and not another A record pointing to the same ELB?  From the point of view of search engines, in this case we will have two sites with completely identical content, and the search engines do not like this to say the least. <br>  Setting up a redirect was not as easy as it could be done with our registrar.  As a solution on the forums and on Stack Overflow, set up a redirect to Apache or nginx, but these solutions did not suit us, since our application server is Apache Tomcat.  I did not want to set another server in front of him - the response time grew unpleasantly.  It was also proposed to write the code with the appropriate logic, but did not want to do this at all. <br>  The solution was found, though not at all obvious.  To do this, we will need to create S3 Bucket with the name of the domain from which we want to redirect users.  It is important to create it with the domain name, otherwise you will not be able to link this bucket to the domain in Route 53 later.  Enter the name of the domain to which it will redirect users and save the configuration. <br><br><img src="https://habrastorage.org/files/42d/403/909/42d403909f8542009d2d3c8c8b3433ed.png" alt="image"><br><br>  Then in Route 53 in the Hosted Zone of our domain we create an A record for the domain name with www (or without) with the alias option and specify our created S3 bucket as the alias target. <br><br><img src="https://habrastorage.org/files/2e3/26a/de4/2e326ade43d948b7a90b35aefdd2c9a0.png" alt="image"><br><br>  Great, now our domain is available with www and without www and even correctly redirects the user to our chosen option. <br><br><h4>  Email forwarding </h4><br>  Unfortunately, it is impossible to configure Email Forwarding with Amazon services, because there is simply no such service.  But I found the excellent service <a href="http://improvmx.com/">ImprovMX</a> , which allowed <a href="http://improvmx.com/">me</a> to set up email forwarding in just a minute.  Instructions for setting up (if you can call it that, because only one action is required) is on the site itself.  All you need to do is to create an MX record with the following content in Hosted Zone: <br><br><pre><code class="hljs css">10 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mx1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.improvmx</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> 20 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mx2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.improvmx</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span></code> </pre> <br>  It remains only to enter the domain name and the mailbox to which the letters will be redirected to the site. <br><br><h4>  Conclusion </h4><br>  What we got in the end: load sharing between our application servers, while maintaining the necessary functionality - redirecting to a domain without www from the domain c www and email forwarding.  Bonus received an increase in performance, as well as the ability to quickly increase productivity by simply adding multiple servers.  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/252435/">https://habr.com/ru/post/252435/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252417/index.html">Announcement of the book by Brian Kernigan "The Go Programming Language"</a></li>
<li><a href="../252419/index.html">C #: how not to "shoot yourself in the leg"</a></li>
<li><a href="../252421/index.html">A hundred lines of code for the beloved</a></li>
<li><a href="../252429/index.html">DICOM Viewer from the inside. Voxel render</a></li>
<li><a href="../252433/index.html">HSTS-based super cookies will track you even in private mode</a></li>
<li><a href="../252437/index.html">Unexpected exception filter behavior in C # 6</a></li>
<li><a href="../252439/index.html">Auto registration of tests on C language tools</a></li>
<li><a href="../252441/index.html">Reconnect - Facebook Login Vulnerability</a></li>
<li><a href="../252443/index.html">Documentation in Doxygen</a></li>
<li><a href="../252445/index.html">Fragmented video stream compression method</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>