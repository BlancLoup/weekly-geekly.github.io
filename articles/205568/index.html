<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cocos2d-x: a few tips on how to prevent memory leaks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cocos2d-x is a ‚Äúengine‚Äù, or rather, a set of classes that greatly simplifies the development of graphical applications for operating systems such as i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cocos2d-x: a few tips on how to prevent memory leaks</h1><div class="post__text post__text-html js-mediator-article">  Cocos2d-x is a ‚Äúengine‚Äù, or rather, a set of classes that greatly simplifies the development of graphical applications for operating systems such as iOS, Android, Windows phone, Windows, as well as for HTML 5. Unlike cocos2d-iphone, cocos2d- x assumes development in C ++, which is why it is so versatile.  Those who write in C ++ know that the entire responsibility for allocating and freeing memory rests on the programmer‚Äôs shoulders.  But the cocos2d-x developers didn‚Äôt take good care of this and built a pool of objects into their wonderful engine, which involves using smart pointers or, in other words, smart pointers. <a name="habracut"></a>  The smart pointer contains the counter of its clients, when the counter is zero, the memory allocated for the object is cleared.  In this article, I will show how to properly create and delete objects in cocos2d-x to avoid memory leaks.  All objects of cocos2d-x classes are smart pointers.  They received this functionality from their parent CCObject, which is the initial link in the engine class library hierarchy. <br><br>  Usually a programmer who wants to create an object in the heap writes such code: <br><pre><code class="cpp hljs">CMyObject* pObject = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CMyObject(); <span class="hljs-comment"><span class="hljs-comment">// ,   CMyObject ‚Äî    .</span></span></code> </pre> <br>  In this case, a CMyObject is created in memory and a pointer to it is placed in the variable pObject.  After pObject is no longer needed, memory must be returned: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> pObject;</code> </pre><br>  Usually, many objects are created in work projects, often not in a single application module, and we must make sure that they are all deleted at the end, otherwise we get a memory leak.  To avoid such trouble, cocos2d-x uses open static functions to create objects.  Especially when the programmer extends the functionality of the engine classes, he must adhere to this rule to avoid memory leaks. <br>  Consider an example of creating a sprite in cocos2d-x: <br><pre> <code class="cpp hljs">... CCSprite* pSprite = CCSprite::create(¬´spritename.png¬ª); ...</code> </pre><br>  create - static function - a member of the CCSprite class to create an object.  Let's look at the code for this function: <br><pre> <code class="cpp hljs">CCSprite* CCSprite::create(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *pszFileName) { CCSprite *pobSprite = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CCSprite(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pobSprite &amp;&amp; pobSprite-&gt;initWithFile(pszFileName)) { pobSprite-&gt;autorelease(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pobSprite; } CC_SAFE_DELETE(pobSprite); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; }</code> </pre><br>  First we create an object, initialize it and use the code: <br><pre> <code class="cpp hljs">pobSprite-&gt;autorelease();</code> </pre><br>  add to the pool.  If the initialization was successful, then the pointer to CCSprite will return to us, and if not, then CC_SAFE_DELETE will remove pobSprite. <br>  After performing this function, our pSprite m_uReference is equal to one unit and it remains to live until it exits the local function, since the pool is updated on each engine clock cycle.  Here you have to be careful: if pSprite is global in the redistribution of the class, then it will point to garbage.  To avoid this, we need to use the created object.  For example, add a sprite to the layer: <pre> <code class="cpp hljs">pLayer-&gt;addChild(pSprite);</code> </pre>  or array <pre> <code class="cpp hljs">pArray-&gt;addObject(pSprite);</code> </pre>  and so on. Each time pSprite is added, its m_uReference will increase, not necessarily by 1. This is a specific implementation of the engine, within which its worklists, arrays, etc., also affect m_uReference.  And each time pSprite is deleted, its m_uReference will decrease accordingly.  You can increase or decrease m_uReference yourself using methods: <br><pre> <code class="cpp hljs">pSprite-&gt;retain(); <span class="hljs-comment"><span class="hljs-comment">// m_uReference +=1 pStrite-&gt;release(); // m_uReference -=1</span></span></code> </pre><br>  Use these methods carefully, and each retain () should correspond to a release () call.  Otherwise the object will remain in memory and a memory leak will occur. <br>  Now let's talk about expanding classes.  Suppose we need an object that is almost like CCSprite, but with additional functionality, say Bonus. <br>  I will give an example of declaring a derived class from my project: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TABonus</span></span></span><span class="hljs-class">:</span></span><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CCSprite { TABonusType mType; TABonus(b2World* world, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> pX, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> pY,TABonusType type); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> pBegX, pBegY; <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~TABonus(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> TABonus* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b2World* world, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pX, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pY,TABonusType type)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> TABonusType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mType;} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pSecondElapsed)</span></span></span></span>; };</code> </pre><br>  Note that the constructor is declared in the closed section - this means that the direct creation of the object is prohibited.  For this, the class has a static create function. <br>  Let's look at the function code: <br><pre> <code class="cpp hljs">TABonus* TABonus::create(b2World* world, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> pX, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> pY,TABonusType type) { TABonus* pRet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TABonus(world,pX,pY,type); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pRet-&gt;init()) { pRet-&gt;autorelease(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pRet; } CC_SAFE_DELETE(pRet); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; }</code> </pre><br>  It is similar to the previously discussed.  Now, to create a TABonus, you need to use the following code: <br><pre> <code class="cpp hljs">TABonus* pBonus = TABonus::create(world,pX,pY, btCoins);<span class="hljs-comment"><span class="hljs-comment">// pBonus -&gt;m_uReference == 0 pLayer-&gt;addChild(pBonus); //pBonus-&gt;m_uReference&gt;0</span></span></code> </pre><br><br>  <b>Conclusion:</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      - Try to avoid creating objects directly through the operator new, for this use static functions.  Also, when inheriting from a derived class, you must write your own static functions. <br>  - To remove an object, you need to remove it from all containers where it was added, then its m_uReference will be reset and the memory allocated for the object will be returned to the heap.  For example, remove pSprite from the layer: <br><pre> <code class="cpp hljs">pLayer-&gt;removeChild(pSprite, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>  or from array: <br><pre> <code class="cpp hljs">pArray-&gt;removeObject(pSprite);</code> </pre><br>  - Do not use delete for an object created in a static function, because no one except you knows that there is no more object. <br>  - In order for the object to live, you need to increase its m_uReference by adding it to the container, or by calling retain (). <br><br>  Play by the rules and win. <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/205568/">https://habr.com/ru/post/205568/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../20556/index.html">Apple Globally Updates iPhone Firmware</a></li>
<li><a href="../205560/index.html">API First architecture or reasoning on the topic: thick server vs. thin</a></li>
<li><a href="../205562/index.html">Viber now has the ability to call any phones.</a></li>
<li><a href="../205564/index.html">December 10th is an alternative programmer day</a></li>
<li><a href="../205566/index.html">By car in the "cloud"</a></li>
<li><a href="../205570/index.html">Object oriented C</a></li>
<li><a href="../205572/index.html">Installing ADB driver for phones of lesser-known manufacturers</a></li>
<li><a href="../205574/index.html">Pair programming as a service</a></li>
<li><a href="../205578/index.html">StartAD.mobi: Greetings</a></li>
<li><a href="../20558/index.html">Internet consumers are more satisfied than ever</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>