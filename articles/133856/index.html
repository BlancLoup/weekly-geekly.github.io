<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Continuation of the story about the "Heart" of an electronic device or the simplest programming Silicon Labs C8051F320</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, I wrote an article about my craft on the basis of a Silicon Labs C8051F320 microcontroller. It's time to tell about the programming o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Continuation of the story about the "Heart" of an electronic device or the simplest programming Silicon Labs C8051F320</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, I wrote an article about <a href="http://habrahabr.ru/blogs/DIY/132295/">my craft</a> on the basis of a Silicon Labs C8051F320 microcontroller.  It's time to tell about the programming of this uk for simple tasks. <br><img src="https://habrastorage.org/storage1/390cae7d/05b493f6/6c81c839/a3643aa6.png" alt="image"><br><br>  Details under the cut. <br><a name="habracut"></a><br><br>  So, in the previous article I talked about a small scarf, which should be the basis of the future device.  On it is located the microcontroller itself and its small kit designed for firmware reset, power supply, etc.  One of the tasks that this device was supposed to perform at our place of work was to manage some of the devices on the research bench.  Since, in essence, the task was not very difficult, the firmware for the mic did not require any complicated solutions like working with USB and other specific things, but the analysis of this firmware may in the future be good for those who will have to work with a similar mic on learning ( My friend seems to be programming the 51st kernel now or by work.  But first things first. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Task </h5><br><br>  The task was set fairly simple - to organize the simplest on / off of remote devices from the microcontroller, organizing the necessary delays between operations.  In theory, it was necessary to still manage these delays from a PC via USB, but as it turned out later, this is not so important. <br><br><h5>  Hardware </h5><br><br>  To solve this problem, it was necessary to implement the hardware part of the device, which is responsible for interfacing the remote control devices, since the ‚Äúheart‚Äù itself did not carry anything on board, and it was originally intended to handle the peripheral board.  I will not dwell on the hardware, as the article about the firmware, but still for the completeness of the picture I will present its scheme and a brief description. <br><br>  In total, there were 6 remote devices, three of which were controlled via fiber-optic communication, two through a relay and one with a simple pulse of 5 volts.  Since our bosses do not like everything to be done wisely and, accordingly, they don‚Äôt want to allocate money for competent work, the concept was heaped up quickly and on the knee, so that there may be minor flaws.  Here she is. <br><br><img src="https://habrastorage.org/storage1/f8748cac/0d6c502a/b043244b/acd4880c.jpg"><br><br>  After making sure that no changes in the device are expected, or rather specifying with the authorities that there will not be any ‚ÄúOh, let's get ...‚Äù, after which we will have to make a completely new scheme, we started to produce a printed circuit board.  I have already said about the lack of money, so I would just say that everything was made from the improvised elements - the board was etched on our knee from a piece of old textolite, the elements were found in the storeroom.  In general, complete devastation.  Research institutes, what else to say ... In general, the result is visible in the photo: <br><br><img src="https://habrastorage.org/storage1/8fad5672/fa44d74d/941f69f9/556a08f3.jpg"><br><br><img src="https://habrastorage.org/storage1/b515a370/33e38a27/f845d65f/3959ba4a.jpg"><br><br>  By the way, then everything happened ‚ÄúOh, and let's ...‚Äù, so I had to rivet a couple of small handkerchiefs, cut the tracks on this one and put all the snot together, but the post is not about that. <br><br><h5>  Software part </h5><br>  The description of the program part will consist of several sub-paragraphs to make it easier to read and understand what it is all about. <br><br><h6>  Work algorithm </h6><br>  The algorithm is simple as boots: <br><ul><li>  Check the presence of an external signal "Start" from the upstream device </li><li>  If the signal is received - we work the specified sequence, having spat on check of operation of devices.  By the way, this method seemed to me to be not quite correct, so I did a single check, so that I didn‚Äôt bang, but I implemented it just by hardware, and not in the firmware. </li><li>  We return to the first point </li></ul><br><br>  The algorithm is selected, the apatate part is ready, proceed to the configuration and programming of the microcontroller. <br><br><h6>  Configuring the microcontroller </h6><br>  What I like about SILabs is that they have a bunch of buns in the form of programs for initializing, configuring, flashing and direct debugging of their microcontrollers.  So, we take their program for the initial configuration of the IC from <a href="">their site</a> and launch it.  Select in the settings we need MK and start the configuration. <br><br><img src="https://habrastorage.org/storage1/9a7258e0/2e0861dc/7662fbd8/061d88e4.png"><br><br><img src="https://habrastorage.org/storage1/1f85eb6e/77d57ced/03ad724b/2430eaae.png"><br><br>  In the process of configuring the MK, we will need to configure its I / O ports so that they have a logical zero in the initial state, configure the timer-counter at the interval we need (EMNIP I set 50 microseconds), enable the timer interrupts and even small things.  I do not remember exactly, I did it for a long time, I‚Äôll just show you an example.  In the Properties menu, select the item we need and see the open window, where all the parameters we need are configured in the GUI. <br><br><img src="https://habrastorage.org/storage1/3501f910/8d3281a0/54766bec/511d269f.png"><br><br>  When you click OK, all settings are copied to the code window.  Configured MK, but not in a hurry to close the configurator, it is still needed.  We download from <a href="http://www.silabs.com/products/mcu/Pages/SoftwareDownloads.aspx">the same site</a> <a href="">Silicon Labs IDE</a> , with which we will be flashing the MK.  Run it. <br><br>  There is one nuance, she needs to slip the compiler from Keil C51 to use it.  I will not dwell on it, just show the picture how to do it.  Open the Project menu - Tool Chain Integration and specify the paths to the Keil compilers. <br><br><img src="https://habrastorage.org/storage1/30b57abc/16f9d64c/83d051cd/59681937.png"><br><br>  Open the configurator and copy the resulting code from it into the IDE. <br><br><pre><code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/--------------------------------------------------------------------------------/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Initialization of timer /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/--------------------------------------------------------------------------------/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ void timerInit(void) { TMOD = 0x10; TMR2CN = 0x24; TF2LEN = 1; TMR2RLL = 0xCF; TMR2RLH = 0xFF; TMR2L = 0xCF; TMR2H = 0xFF; T2SPLIT = 0; T2SOF = 0; ET2 = 1; TMR2 = 0xffff; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ set to reload immediately ET2 = 1; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ enable Timer2 interrupts TR2 = 1; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ start Timer2 } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/--------------------------------------------------------------------------------/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Initialization of ports I/</span></span>O /<span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/--------------------------------------------------------------------------------/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ void portIOInit(void) { P1MDOUT = 0x7F; XBR1 = 0x40; P0 = 0x00; P1 = 0x00; P2 = 0x00; } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/------------------------------------------------------------------------------/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Interrupts init /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/------------------------------------------------------------------------------/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ void interruptsInit(void) { IP = 0x20; IE = 0xA0; } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/----------------------------------------------------------------------------- /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ SYSCLK_Init /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/----------------------------------------------------------------------------- /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ This routine initializes the system clock to use the internal 24.5MHz /</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> /<span class="hljs-regexp"><span class="hljs-regexp">/ oscillator as its clock source. Also enables missing clock detector reset. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ void SYSCLK_Init (void) { OSCICN = 0xC3; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ configure internal oscillator for /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ its lowest frequency RSTSRC = 0x04; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ enable missing clock detector } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/------------------------------------------------------------------------------/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Device init /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/------------------------------------------------------------------------------/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ void deviceInit(void) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ disable watchdog timer PCA0MD &amp;= ~0x40; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ WDTE = 0 (clear watchdog timer SYSCLK_Init(); timerInit(); portIOInit(); interruptsInit(); EA = 1; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ enable global interrupts /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/------------------------------------------------------------------------------/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Main function /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/------------------------------------------------------------------------------/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ void main(void) { _delay1 = 0; _delay2 = 19980; _widthImp = 20; _cDelay = 0; _state = ST_IDLE; deviceInit(); while(1) { }; } }</span></span></code> </pre> <br><br><h6>  Implementation of the main task </h6><br>  So, the MC is configured, we proceed to the implementation of the main task - we check the incoming signal and work out the sequence. <br><br>  The algorithm of this function is as follows: we start the timer for clicks every 50 microseconds.  Create a global variable _state, which will be responsible for the current state of the controller.  By default we make it equal to 0, i.e.  the first state.  The remaining states of the MC will be made more readable using define: <br><br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ST_IDLE 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ST_DELAY_0 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ST_RNT_START 2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ST_DELAY_1 3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ST_RNT_STOP 4</span></span></code> </pre><br><br>  We look at the interrupt table on the controller datasheet and find out that the interrupt of the timer we need has a vector (number) 5. The code that implements the function: <br><br><pre> <code class="hljs bash">//------------------------------------------------------------------------------// // Timer ISR // //------------------------------------------------------------------------------// void timerISR (void) interrupt 5 { TF2H = 0; TF2L = 0; // Clear Timer2 interrupt flag switch(_state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ST_IDLE: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_inputPulse == 0) { _state = ST_DELAY_0; _cDelay = 0; } <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ST_DELAY_0: _cDelay++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_cDelay&gt;=_delay1) { _state = ST_RNT_START; _rntStart = ON; _cDelay = 0; } <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ST_RNT_START: _cDelay++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_cDelay &gt;= _widthImp) { _state = ST_DELAY_1; _rntStart = OFF; _cDelay = 0; } <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ST_DELAY_1: _cDelay++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_cDelay &gt;= _delay2) { _state = ST_RNT_STOP; _rntStop = ON; _cDelay = 0; } <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ST_RNT_STOP: _cDelay++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_cDelay &gt;= _widthImp) { _state = ST_IDLE; _rntStop = OFF; _cDelay = 0; } <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; default: _state = ST_IDLE; <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; }</code> </pre><br><br>  So what are we doing?  With each click of the timer, check the status of the MC.  If it is 0, we check if there is a start signal at the input.  If it is (inputPulse == 1) - run the sequence.  The duration of the delays between signals is controlled by the number of timer clicks, checking it with each click in the state processing code.  At the completion of the entire cycle of operation - we return the MC to the state 0 and wait for the next incoming signal. <br><br><h6>  Firmware </h6><br><br>  MK is compiled and stitched up quite simply, from the same IDE by pressing one button.  We connect the programmer to the board (as shown in the previous article), turn on the power, press the "Connect" button, then the "Download code" button.  All MK flashed.  You can run the code for execution in MK from here by pressing the ‚ÄúGo‚Äù button.  Here you can set breakpoints and conduct a debug session with it, viewing the results on an oscilloscope. <br><br><img src="https://habrastorage.org/storage1/1b42fc2c/5327580b/72234c3e/f0fd84de.png"><br>  The buttons are shown in the picture and signed in different colors. <br><br><h4>  Conclusion </h4><br><br>  As you can see, not everything is so difficult when working with this MK.  I think that this post will help someone to deal with it. </div><p>Source: <a href="https://habr.com/ru/post/133856/">https://habr.com/ru/post/133856/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133848/index.html">New version of VDI-in-a-Box</a></li>
<li><a href="../133849/index.html">PHPShop online store can now be synchronized with R-Keeper StoreHouse</a></li>
<li><a href="../133850/index.html">Getting Realization Experience. Part 2 of 2</a></li>
<li><a href="../133851/index.html">Silicon Valley Islet</a></li>
<li><a href="../133855/index.html">Design patterns in automaton programming</a></li>
<li><a href="../133857/index.html">Imagine Cup Meeting in Novosibirsk</a></li>
<li><a href="../133858/index.html">Monetizing Android applications using AdMob ads with the option of paid disconnection. Part one</a></li>
<li><a href="../133859/index.html">UK intelligence agencies GCHQ launched a hacking code contest to attract new talent</a></li>
<li><a href="../133860/index.html">bash script with support for long (gnu-style) options</a></li>
<li><a href="../133862/index.html">Answers to questions about the PlayBook 4G and PIM applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>