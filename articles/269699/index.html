<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Compare me completely. Reflection in the service of .NET developer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I faced the following task: it is necessary to compare many pairs of objects. But there is one nuance: objects are the object‚Äôs most, and yo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Compare me completely. Reflection in the service of .NET developer</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/028/1fa/7c0/0281fa7c0f364af7bd6fce4cc3b751de.jpg" align="left"><br><br>  Recently, I faced the following task: it is necessary to compare many pairs of objects.  But there is one nuance: objects are the object‚Äôs most, and you need to compare across the entire set of public properties.  And it is absolutely not necessary that the types of compared objects implement the <a href="https://msdn.microsoft.com/en-us/library/ms131187(v%3Dvs.110).aspx"><code>IEquatable&lt;T&gt;</code></a> interface. <br><br>  It was obvious that reflection should be used.  However, during the implementation, I was faced with many subtleties and eventually resorted to the <s>black magic of the</s> dynamic generation of IL.  In this article I would like to share my experience and talk about how I solved this problem.  If you are interested in the topic, then please under the cat! <br><a name="habracut"></a><br><h5>  Part 1. Object in reflection </h5><br><blockquote>  ‚ÄúSubmit here <s>MFC</s> IEqualityComparer!‚Äù, He shouted, stamping with all four paws <br></blockquote><br>  In .NET, it is assumed that classes that perform object comparisons implement the <a href="https://msdn.microsoft.com/en-us/library/ms132151(v%3Dvs.110).aspx">IEqualityComparer &lt;T&gt;</a> interface.  This allows you to embed them in collection classes, such as lists and dictionaries, and use custom equality equality when searching.  We will not deviate from this agreement and proceed to implement the <code>IEqualityComparer&lt;object&gt;</code> interface using the reflection mechanism.  Recall that reflection refers to inspecting metadata and compiled code during program execution (readers unfamiliar with reflection are strongly advised to read the chapter ‚ÄúReflection and Metadata‚Äù in the book by Joseph and Ben Albahari <a href="http://www.williamspublishing.com/Books/978-5-8459-1819-2.html">‚ÄúC # 5.0. Reference. Full Language Description‚Äù</a> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ReflectionComparer : IEqualityComparer&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">bool</span></span> Equals(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> y) { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">bool</span></span> Equals(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> y) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CompareObjectsInternal(x?.GetType(), x, y); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> GetHashCode(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> obj) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.GetHashCode(); } private <span class="hljs-type"><span class="hljs-type">bool</span></span> CompareObjectsInternal(<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> y) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> NotImplementedException(); } }</code> </pre><br>  Note that the <code>Equals</code> method is marked as <code>new</code> .  This is done because it overlaps the <code>Object.Equals(object, object)</code> method. <br><br>  Now let's take a step back and determine more precisely what we are going to compare.  Objects can be arbitrarily complex, everything must be considered.  By combining the following types of properties we can cover a wide class of input data: <br><br><ul><li>  all primitive types (Boolean, Byte, SByte, Int16, UInt16, Int32, UInt32, Int64, UInt64, IntPtr, UIntPtr, Char, Double, Single); </li><li>  lines; </li><li>  arrays (for simplicity, we will consider only one-dimensional arrays); </li><li>  transfers; </li><li>  collections that implement the IEnumerable &lt;T&gt; interface; </li><li>  structures; </li><li>  classes. </li></ul><br>  We write the framework of the <code>CompareObjectsInternal</code> method, and then consider some special cases. <br><br><pre> <code class="hljs pgsql">private <span class="hljs-type"><span class="hljs-type">bool</span></span> CompareObjectsInternal(<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> y) { //          <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ReferenceEquals(x, y)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; //     <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ReferenceEquals(x, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) != ReferenceEquals(y, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; //     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x.GetType() != y.GetType()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>.GetTypeCode(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>) == TypeCode.String) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((string)x).Equals((string)y); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.IsArray) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CompareArrays(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, x, y); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.IsImplementIEnumerable()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CompareEnumerables(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, x, y); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.IsClass || <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.IsInterface) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CompareAllProperties(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, x, y); //      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.IsPrimitive || <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.IsEnum) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x.Equals(y); //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.IsNullable()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CompareNullables(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, x, y); //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.IsValueType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CompareAllProperties(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, x, y); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x.Equals(y); }</code> </pre><br>  The above code is quite understandable: first, we check objects for reference equality and <code>null</code> equality, then we check types, and then we consider various cases.  Moreover, for strings, primitive types, and enumeration types, without further ado, we call the <code>Equals</code> method.  To check the types of belonging to nullable types and types of collections, we use the <code>IsNullable</code> and <code>IsImplementIEnumerable</code> extension methods, the source code of which can be found below. <br><br><div class="spoiler">  <b class="spoiler_title">Extension method code</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">bool</span></span> IsImplementIEnumerable(this <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.GetInterface("IEnumerable`1") != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> GetIEnumerableInterface(this <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.GetInterface("IEnumerable`1"); <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">bool</span></span> IsNullable(this <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.IsGenericType &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.GetGenericTypeDefinition() == typeof (Nullable&lt;&gt;);</code> </pre><br></div></div><br>  In the case of classes, interfaces, and structures, we compare all the relevant properties.  Note that indexers in .NET are also properties, but we will limit ourselves to simple (parameterless) properties that have getters, and the comparison of collections will be processed separately.  To check whether a property is an indexer, we can use the <a href="https://msdn.microsoft.com/en-us/library/system.reflection.propertyinfo.getindexparameters(v%3Dvs.110).aspx">PropertyInfo.GetIndexParameters</a> method.  If the method returned an array of nonzero length, then we are dealing with an indexer. <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareAllProperties</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> properties = type.GetProperties(BindingFlags.Instance | BindingFlags.Public); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> readableNonIndexers = properties.Where(p =&gt; p.CanRead &amp;&amp; p.GetIndexParameters().Length == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (PropertyInfo propertyInfo <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> readableNonIndexers) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = propertyInfo.GetValue(x, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b = propertyInfo.GetValue(y, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CompareObjectsInternal(propertyInfo.PropertyType, a, b)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br>  The next case is a comparison of nullable objects.  If the underlying type is primitive, then we can compare the values ‚Äã‚Äãusing the <code>Equals</code> method.  If there are structures inside objects, then it is necessary to first extract the inner signs and then compare them for all public properties.  We can safely access the <code>Value</code> property, since equality tests have already been performed earlier in the <code>CompareObjectsInternal</code> method. <br><br><pre> <code class="hljs scala"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> bool <span class="hljs-type"><span class="hljs-type">CompareNullables</span></span>(<span class="hljs-type"><span class="hljs-type">Type</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-type"><span class="hljs-type">Type</span></span> underlyingTypeOfNullableType = <span class="hljs-type"><span class="hljs-type">Nullable</span></span>.<span class="hljs-type"><span class="hljs-type">GetUnderlyingType</span></span>(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (underlyingTypeOfNullableType.<span class="hljs-type"><span class="hljs-type">IsPrimitive</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x.<span class="hljs-type"><span class="hljs-type">Equals</span></span>(y); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> valueProperty = <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetProperty</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">"</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Value</span></span></span></span><span class="hljs-class"><span class="hljs-params">"</span></span></span><span class="hljs-class">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = valueProperty.<span class="hljs-type"><span class="hljs-type">GetValue</span></span>(x, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b = valueProperty.<span class="hljs-type"><span class="hljs-type">GetValue</span></span>(y, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">CompareAllProperties</span></span>(underlyingTypeOfNullableType, a, b); }</code> </pre><br>  Let us turn to the comparison of collections.  You can implement the implementation in at least two ways: write your non-generic method that works with IEnumerable, or use the <a href="https://msdn.microsoft.com/en-us/library/vstudio/bb342073(v%3Dvs.100).aspx">Enumerable.SequenceEqual &lt;TSource&gt;</a> extension method.  For collections whose elements are type-values, it is obvious that the non-generic method will work more slowly, since  he will constantly have to do the packing / unpacking of the values.  When using the same LINQ method, we first need to substitute the type of the collection's elements into the TSource type parameter using the <a href="https://msdn.microsoft.com/en-us/library/system.reflection.methodinfo.makegenericmethod(v%3Dvs.110).aspx">MakeGenericMethod</a> method), and then call the method by passing the two compared collections.  Moreover, if the collection contains elements of non-primitive types, then we can pass an additional argument ‚Äî the comparer ‚Äî the current instance of our <code>ReflectionComparer</code> class (not for nothing, we implemented the <code>IEqualityComparer&lt;object&gt;</code> interface <code>IEqualityComparer&lt;object&gt;</code> !).  Therefore, to compare collections, select LINQ: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MethodInfo GenericSequenceEqualWithoutComparer = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Enumerable) .GetMethods(BindingFlags.Public | BindingFlags.Static) .First(m =&gt; m.Name == <span class="hljs-string"><span class="hljs-string">"SequenceEqual"</span></span> &amp;&amp; m.GetParameters().Length == <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MethodInfo GenericSequenceEqualWithComparer = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Enumerable) .GetMethods(BindingFlags.Public | BindingFlags.Static) .First(m =&gt; m.Name == <span class="hljs-string"><span class="hljs-string">"SequenceEqual"</span></span> &amp;&amp; m.GetParameters().Length == <span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareEnumerables</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type collectionType, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y</span></span></span><span class="hljs-function">)</span></span> { Type enumerableInterface = collectionType.GetIEnumerableInterface(); Type elementType = enumerableInterface.GetGenericArguments()[<span class="hljs-number"><span class="hljs-number">0</span></span>]; MethodInfo sequenceEqual; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] arguments; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (elementType.IsPrimitive) { sequenceEqual = GenericSequenceEqualWithoutComparer; arguments = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] {x, y}; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sequenceEqual = GenericSequenceEqualWithComparer; arguments = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] {x, y, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>}; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sequenceEqualMethod = sequenceEqual.MakeGenericMethod(elementType); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>)sequenceEqualMethod.Invoke(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, arguments); }</code> </pre><br>  The last case - comparison of arrays - is in many ways similar to the comparison of collections.  The difference is that instead of using the standard LINQ method, we use the samopisny generalized method.  The implementation of array comparison is presented below: <br><br><div class="spoiler">  <b class="spoiler_title">Comparing arrays</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">private static MethodInfo GenericCompareArraysMethod = typeof(ReflectionComparer).GetMethod("GenericCompareArrays", BindingFlags.NonPublic | BindingFlags.Static); private static <span class="hljs-type"><span class="hljs-type">bool</span></span> GenericCompareArrays&lt;T&gt;(T[] x, T[] y, IEqualityComparer&lt;T&gt; comparer) { var comp = comparer ?? EqualityComparer&lt;T&gt;.<span class="hljs-keyword"><span class="hljs-keyword">Default</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; x.Length; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!comp.Equals(x[i], y[i])) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } private <span class="hljs-type"><span class="hljs-type">bool</span></span> CompareArrays(<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> y) { var elementType = <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.GetElementType(); <span class="hljs-type"><span class="hljs-type">int</span></span> xLength, yLength; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (elementType.IsValueType) { //  -     <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>,   <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span> xLength = ((<span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>) x).Length; yLength = ((<span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>) y).Length; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { xLength = ((<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[]) x).Length; yLength = ((<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[]) y).Length; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xLength != yLength) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; var compareArraysPrimitive = GenericCompareArraysMethod.MakeGenericMethod(elementType); var arguments = elementType.IsPrimitive ? <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] {x, y, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>} : <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] {x, y, this}; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-type"><span class="hljs-type">bool</span></span>) compareArraysPrimitive.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, arguments); }</code> </pre><br></div></div><br>  So, all the pieces of the puzzle are assembled - our reflective comparer is ready.  Below are the results of a comparison of the performance of a reflexive comparer compared with the manual implementation on ‚Äútest‚Äù data.  Obviously, the execution time of the comparison <b>is</b> very dependent on the type of objects being compared.  As an example, two types of objects were compared here - conditionally ‚Äúmore complicated‚Äù and ‚Äúsimpler‚Äù.  To estimate the runtime, the <a href="https://github.com/PerfDotNet/BenchmarkDotNet">BenchmarkDotNet</a> library was used, for which I want to express special thanks to Andrey Akinshin <a href="https://habrahabr.ru/users/dreamwalker/" class="user_link">DreamWalker</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Code here</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Struct { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m_a; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> m_b; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> m_c; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> A =&gt; m_a; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> B =&gt; m_b; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> C =&gt; m_c; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Struct</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c</span></span></span><span class="hljs-function">)</span></span> { m_a = a; m_b = b; m_c = c; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SimpleClass</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> A { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Struct B { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ComplexClass</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> A { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IntPtr B { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> UIntPtr C { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> D { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> SimpleClass E { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? F { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] G { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; H { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> I { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> J { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } [BenchmarkTask(platform: BenchmarkPlatform.X86, jitVersion: BenchmarkJitVersion.LegacyJit)] [BenchmarkTask(platform: BenchmarkPlatform.X64, jitVersion: BenchmarkJitVersion.LegacyJit)] [BenchmarkTask(platform: BenchmarkPlatform.X64, jitVersion: BenchmarkJitVersion.RyuJit)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ComparisonTest</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MakeArray</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> array = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[count]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; array.Length; ++i) array[i] = i; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> array; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> List&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MakeList</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(count); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; list.Count; ++i) list.Add(i); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> list; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ComplexClass x = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ComplexClass { A = <span class="hljs-number"><span class="hljs-number">2</span></span>, B = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntPtr(<span class="hljs-number"><span class="hljs-number">2</span></span>), C = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UIntPtr(<span class="hljs-number"><span class="hljs-number">2</span></span>), D = <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, E = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleClass { A = <span class="hljs-number"><span class="hljs-number">42</span></span>, B = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Struct(<span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">3.14</span></span>, <span class="hljs-string"><span class="hljs-string">"meow"</span></span>) }, F = <span class="hljs-number"><span class="hljs-number">1</span></span>, G = MakeArray(<span class="hljs-number"><span class="hljs-number">100</span></span>), H = MakeList(<span class="hljs-number"><span class="hljs-number">100</span></span>), I = <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>.MaxValue, J = <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>.MaxValue }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ComplexClass y = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ComplexClass { A = <span class="hljs-number"><span class="hljs-number">2</span></span>, B = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntPtr(<span class="hljs-number"><span class="hljs-number">2</span></span>), C = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UIntPtr(<span class="hljs-number"><span class="hljs-number">2</span></span>), D = <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, E = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleClass { A = <span class="hljs-number"><span class="hljs-number">42</span></span>, B = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Struct(<span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">3.14</span></span>, <span class="hljs-string"><span class="hljs-string">"meow"</span></span>) }, F = <span class="hljs-number"><span class="hljs-number">1</span></span>, G = MakeArray(<span class="hljs-number"><span class="hljs-number">100</span></span>), H = MakeList(<span class="hljs-number"><span class="hljs-number">100</span></span>), I = <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>.MaxValue, J = <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>.MaxValue }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ReflectionComparer comparer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReflectionComparer(); [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReflectionCompare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = comparer.Equals(x, y); } [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ManualCompare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = CompareComplexObjects(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareComplexObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xA != yA) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xB != yB) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xC != yC) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xD != yD) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xE != yE) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xEA != yEA) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s1 = xEB; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s2 = yEB; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s1.A != s2.A) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!s1.B.Equals(s2.B)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s1.C != s2.C) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xF != yF) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xG != yG) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xG?.Length != yG?.Length) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] a = xG, b = yG; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; a.Length; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a[i] != b[i]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xH != yH) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!xHSequenceEqual(yH)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!xIEquals(yI)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!xJEquals(yJ)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } [BenchmarkTask(platform: BenchmarkPlatform.X86, jitVersion: BenchmarkJitVersion.LegacyJit)] [BenchmarkTask(platform: BenchmarkPlatform.X64, jitVersion: BenchmarkJitVersion.LegacyJit)] [BenchmarkTask(platform: BenchmarkPlatform.X64, jitVersion: BenchmarkJitVersion.RyuJit)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SimpleComparisonTest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SimpleClass x = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleClass { A = <span class="hljs-number"><span class="hljs-number">42</span></span>, B = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Struct(<span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">3.14</span></span>, <span class="hljs-string"><span class="hljs-string">"meow"</span></span>) }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SimpleClass y = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleClass { A = <span class="hljs-number"><span class="hljs-number">42</span></span>, B = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Struct(<span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">3.14</span></span>, <span class="hljs-string"><span class="hljs-string">"meow"</span></span>) }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ReflectionComparer comparer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReflectionComparer(); [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReflectionCompare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = comparer.Equals(x, y); } [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ManualCompare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = CompareSimpleObjects(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareSimpleObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xA != yA) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s1 = xB; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s2 = yB; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s1.A != s2.A) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!s1.B.Equals(s2.B)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s1.C != s2.C) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Results here</b> <div class="spoiler_text">  BenchmarkDotNet = v0.7.8.0 <br>  OS = Microsoft Windows NT 6.2.9200.0 <br>  Processor = Intel¬Æ Core (TM) i5-2410M CPU @ 2.30GHz, ProcessorCount = 4 <br>  HostCLR = MS .NET 4.0.30319.42000, Arch = 64-bit [RyuJIT] <br><br>  <b>Results of comparison of ComplexClass objects</b> <br><table><tbody><tr><th>  Method </th><th>  Platform </th><th>  Jit </th><th>  Avrtime </th><th>  Stddev </th><th>  op / s </th></tr><tr><td>  ManualCompare </td><td>  X64 </td><td>  Legacyjit </td><td>  1,364.3835 ns </td><td>  47.6975 ns </td><td>  732,941.68 </td></tr><tr><td>  ReflectionCompare </td><td>  X64 </td><td>  Legacyjit </td><td>  36,779.9097 ns </td><td>  3,080.9738 ns </td><td>  27,188.92 </td></tr><tr><td>  ManualCompare </td><td>  X64 </td><td>  Ryujit </td><td>  930.8761 ns </td><td>  43.6018 ns </td><td>  1,074,294.12 </td></tr><tr><td>  ReflectionCompare </td><td>  X64 </td><td>  Ryujit </td><td>  36,909.7334 ns </td><td>  3,762.0698 ns </td><td>  27,093.98 </td></tr><tr><td>  ManualCompare </td><td>  X86 </td><td>  Legacyjit </td><td>  936.3367 ns </td><td>  38.3831 ns </td><td>  1,067,992.54 </td></tr><tr><td>  ReflectionCompare </td><td>  X86 </td><td>  Legacyjit </td><td>  32,446.6969 ns </td><td>  1,687.8442 ns </td><td>  30,819.81 </td></tr></tbody></table><br>  <b>SimpleClass object comparison results</b> <br><table><tbody><tr><th>  Method </th><th>  Platform </th><th>  Jit </th><th>  Avrtime </th><th>  Stddev </th><th>  op / s </th></tr><tr><td>  Handwritten </td><td>  X64 </td><td>  Legacyjit </td><td>  131.5205 ns </td><td>  4.9045 ns </td><td>  7,603,376.64 </td></tr><tr><td>  ReflectionComparer </td><td>  X64 </td><td>  Legacyjit </td><td>  3,859.7102 ns </td><td>  269.8845 ns </td><td>  259,087.15 </td></tr><tr><td>  Handwritten </td><td>  X64 </td><td>  Ryujit </td><td>  61.2438 ns </td><td>  1.9025 ns </td><td>  16,328,222.24 </td></tr><tr><td>  ReflectionComparer </td><td>  X64 </td><td>  Ryujit </td><td>  3,841.4645 ns </td><td>  374.0006 ns </td><td>  260,317.46 </td></tr><tr><td>  Handwritten </td><td>  X86 </td><td>  Legacyjit </td><td>  71.5982 ns </td><td>  5.4304 ns </td><td>  13,966,823.95 </td></tr><tr><td>  ReflectionComparer </td><td>  X86 </td><td>  Legacyjit </td><td>  3,636.7963 ns </td><td>  241.3940 ns </td><td>  274,967.76 </td></tr></tbody></table></div></div><br>  Naturally, the performance of the reflexive comparer is lower than the self-written one.  Reflection is slow and its API works with <code>object</code> , which immediately affects performance, if the compared objects contain value types, because of the need to perform boxing / unboxing.  And here it is necessary to proceed from their own needs.  If reflection is not used often, then you can live with it.  But in my particular case, the reflexive comparer was not fast enough.  ‚ÄúCome on new <s>, Mish</s> ,‚Äù I said to myself and began the second option. <br><br><h5>  Part 2. The emit game </h5><br><img src="https://habrastorage.org/files/aa4/555/949/aa4555949ff84cf0b112c33d9c47156d.jpg"><br><br><blockquote>  You can live like this, but better speed up <br>  <i>Group Leningrad, "I would be in heaven"</i> <br><br>  Neo: And you read it? <br>  Cypher: It comes.  Over time you get used to it.  I don't even notice the code.  I see a blonde, brunette, redhead. <br>  <i>The film "The Matrix" (The Matrix)</i> <br></blockquote><br>  Reflection allows us to extract all the necessary information about the types of objects being compared.  But we cannot use these types directly to get the properties we need or call the required method, which leads us to use the slow reflection API (PropertyInfo.GetValue, MethodInfo.Invoke, etc.).  And what if we could, using type information, once generate the code to compare objects and call it every time, without resorting to reflection anymore?  And, fortunately, we can do it!  The namespace <a href="https://msdn.microsoft.com/en-us/library/system.reflection.emit(v%3Dvs.110).aspx">System.Reflection.Emit</a> provides us with the means to create dynamic methods - <a href="https://msdn.microsoft.com/en-us/library/system.reflection.emit.dynamicmethod(v%3Dvs.110).aspx">DynamicMethod</a> using the <a href="https://ru.wikipedia.org/wiki/Common_Intermediate_Language">IL</a> - <a href="https://msdn.microsoft.com/en-us/library/system.reflection.emit.ilgenerator(v%3Dvs.110).aspx">ILGenerator generator</a> .  The same approach is used, for example, to compile regular expressions in the .NET Framework itself (you can see the implementation <a href="http://referencesource.microsoft.com/">here</a> ). <br><br>  About generation IL on Habr√© already <a href="http://habrahabr.ru/post/172487/">wrote</a> .  Therefore, only briefly recall the features of IL. <br><br>  <a href="https://ru.wikipedia.org/wiki/Common_Intermediate_Language">Intermediate Language (IL)</a> is an object-oriented assembly language used by the .NET and Mono platforms.  High-level languages, such as C #, VB.NET, F #, are compiled into IL, and IL, in turn, is compiled by JIT into machine code.  Because of its intermediate position in this chain, language has its name.  IL uses a stack-based computational model, that is, all input and output data is transmitted through the stack, and not through registers, as in many processor architectures.  IL supports loading and saving local variables and arguments, type conversion, creating and manipulating objects, passing control, calling methods, exceptions, and many others. <br><br>  For example, the increment of an integer variable on IL is written as follows: <br><br><pre> <code class="hljs ruby">ldloc.<span class="hljs-number"><span class="hljs-number">0</span></span> /<span class="hljs-regexp"><span class="hljs-regexp">/   ldc.i4.1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   add /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  stloc.0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     </span></span></code> </pre><br>  You can view the result of the C # complation in IL by various means, for example, ILDasm (the utility that comes with Visual Studio) or <a href="http://ilspy.net/">ILSpy</a> .  But my favorite way is through the great <a href="http://tryroslyn.azurewebsites.net/">Try Roslyn</a> web application, written by Andrey Shchekin <a href="https://habrahabr.ru/users/ashmind/" class="user_link">ashmind</a> . <br><br>  Let's return to our task.  We will again do the implementation of the <code>IEqualityComparer&lt;object&gt;</code> interface: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> DynamicCodeComparer : IEqualityComparer&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; { //     private delegate <span class="hljs-type"><span class="hljs-type">bool</span></span> Comparer(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> y); //    private static <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>, Comparer&gt; ComparerCache = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>, Comparer&gt;(); <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">bool</span></span> Equals(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> y) { //          <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ReferenceEquals(x, y)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; //     <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ReferenceEquals(x, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) != ReferenceEquals(y, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> xType = x.GetType(); //     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xType != y.GetType()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; // //     .  ,        // Comparer comparer; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ComparerCache.TryGetValue(xType, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> comparer)) { ComparerCache[xType] = comparer = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ComparerDelegateGenerator().Generate(xType); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> comparer(x, y); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> GetHashCode(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> obj) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.GetHashCode(); } }</code> </pre><br>  The <code>Equals</code> method uses a dictionary to maintain a cache of generated delegates ‚Äî comparers that perform object comparisons.  If the comparer for a particular type is not yet in the dictionary, then we will generate a new delegate.  All logic for dynamic delegate generation will be concentrated in the <code>ComparerDelegateGenerator</code> class. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ComparerDelegateGenerator { //     private ILGenerator il; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Comparer Generate(<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>) { //       ,     var dynamicMethod = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DynamicMethod("__DynamicCompare", typeof(<span class="hljs-type"><span class="hljs-type">bool</span></span>), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>[] { typeof(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>), typeof(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>) }, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>.Module); il = dynamicMethod.GetILGenerator(); // //          // il.LoadFirstArg(); var arg0 = il.CastToType(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>); il.LoadSecondArg(); var arg1 = il.CastToType(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>); //   CompareObjectsInternal(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, arg0, arg1); //      ,    il.ReturnTrue(); //       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (Comparer)dynamicMethod.CreateDelegate(typeof(Comparer)); } }</code> </pre><br>  In the <code>Generate</code> method above there is one small nuance.  The nuance is to create a dynamic method in the same module as the type of objects being compared.  Otherwise, the dynamic method code will not be able to access the type and will receive a <code>TypeAccessException</code> exception.  The <code>ILGenerator</code> class allows <code>ILGenerator</code> to generate instructions using the <a href="https://msdn.microsoft.com/en-us/library/system.reflection.emit.ilgenerator.emit(v%3Dvs.110).aspx">Emit (OpCode)</a> method, which takes a command code as an argument.  But, in order not to litter our class with such details, we will use extension methods, from whose names it will be clear what they are doing.  The code for the Extension methods <code>LoadFirstArg, LoadSecondArg, CastToType</code> and <code>ReturnTrue</code> is presented below.  It should be clarified that the <code>Generate</code> method <code>CompareObjectsInternal</code> will generate <code>return false</code> as soon as it encounters different values.  Therefore, the last dynamic method <code>return true</code> will <code>return true</code> to handle the situation when objects are equal. <br><br><div class="spoiler">  <b class="spoiler_title">Extension method code</b> <div class="spoiler_text"><pre> <code class="hljs haskell">//        public static void <span class="hljs-type"><span class="hljs-type">LoadFirstArg</span></span>(this <span class="hljs-type"><span class="hljs-type">ILGenerator</span></span> il) =&gt; il.<span class="hljs-type"><span class="hljs-type">Emit</span></span>(<span class="hljs-type"><span class="hljs-type">OpCodes</span></span>.<span class="hljs-type"><span class="hljs-type">Ldarg_0</span></span>); //        public static void <span class="hljs-type"><span class="hljs-type">LoadSecondArg</span></span>(this <span class="hljs-type"><span class="hljs-type">ILGenerator</span></span> il) =&gt; il.<span class="hljs-type"><span class="hljs-type">Emit</span></span>(<span class="hljs-type"><span class="hljs-type">OpCodes</span></span>.<span class="hljs-type"><span class="hljs-type">Ldarg_1</span></span>); //           public static <span class="hljs-type"><span class="hljs-type">LocalBuilder</span></span> <span class="hljs-type"><span class="hljs-type">CastToType</span></span>(this <span class="hljs-type"><span class="hljs-type">ILGenerator</span></span> il, <span class="hljs-type"><span class="hljs-type">Type</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">var</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeclareLocal(type)</span></span></span><span class="hljs-class">; //   -      </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsValueType</span></span></span><span class="hljs-class"> || </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsPrimitive</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Emit</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Unbox_Any</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">); } //       else { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Emit</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Castclass</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">); } il.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SetLocal</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">); return x; } //     (  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class">) public static void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LoadZero</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILGenerator</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">) =&gt; il.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Emit</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ldc_I4_0</span></span></span><span class="hljs-class">); //     (  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">) public static void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LoadOne</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILGenerator</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">) =&gt; il.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Emit</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ldc_I4_1</span></span></span><span class="hljs-class">); //     false public static void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReturnFalse</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILGenerator</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LoadZero</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Emit</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ret</span></span></span><span class="hljs-class">); } //     true public static void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReturnTrue</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILGenerator</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LoadOne</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Emit</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ret</span></span></span><span class="hljs-class">); }</span></span></code> </pre></div></div><br>  Next, consider the <code>CompareObjectsInternal</code> method, which will generate different comparison code depending on the type of objects: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">private</span></span> void <span class="hljs-type"><span class="hljs-type">CompareObjectsInternal</span></span>(<span class="hljs-type"><span class="hljs-type">Type</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LocalBuilder</span></span></span><span class="hljs-class"> x, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LocalBuilder</span></span></span><span class="hljs-class"> y) { //  ,      ,    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">var</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">whenEqual</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DefineLabel</span></span></span><span class="hljs-class">(); //     - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsValueType</span></span></span><span class="hljs-class">) { //    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">,      </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">JumpIfReferenceEquals</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">whenEqual</span></span></span><span class="hljs-class">); //      </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class">,     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReturnFalseIfOneIsNull</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">); //  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsArray</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CompareArrays</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetElementType</span></span></span><span class="hljs-class">(), </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">); } //    else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsClass</span></span></span><span class="hljs-class"> || </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsInterface</span></span></span><span class="hljs-class">) { //  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetTypeCode(type)</span></span></span><span class="hljs-class"> == </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TypeCode</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CompareStrings</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">whenEqual</span></span></span><span class="hljs-class">); } //  else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsImplementIEnumerable</span></span></span><span class="hljs-class">()) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CompareEnumerables</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">); } //      else { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CompareAllProperties</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">); } } } //   else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsNullable</span></span></span><span class="hljs-class">()) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CompareNullableValues</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">whenEqual</span></span></span><span class="hljs-class">); } //     else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsPrimitive</span></span></span><span class="hljs-class"> || </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsEnum</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ComparePrimitives</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">whenEqual</span></span></span><span class="hljs-class">); } //  else { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CompareAllProperties</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">); } //  ,      ,    il.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MarkLabel</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">whenEqual</span></span></span><span class="hljs-class">); }</span></span></code> </pre><br>  As can be seen from the code, we handle the same situations as in the reflexive comparator, but in a slightly different order.    ,    <code>null</code>     ,    .          <code>HasValue</code> . <br><br>        ,       .     ,  ,         . <br><br><pre> <code class="hljs ruby">private void CompareArrays(Type elementType, LocalBuilder x, LocalBuilder y) { var loop = il.DefineLabel(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       il.LoadArrayLength(x); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     il.LoadArrayLength(y); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     il.JumpWhenEqual(loop); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ,     il.ReturnFalse(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-literal"><span class="hljs-literal">false</span></span> il.MarkLabel(loop); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     var index = il.DeclareLocal(typeof(int)); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    -  var loopCondition = il.DefineLabel(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>         var loopBody = il.DefineLabel(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      il.LoadZero(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> il.SetLocal(index); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   il.Jump(loopCondition); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      il.MarkLabel(loopBody); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     { var xElement = il.GetArrayElement(elementType, x, index); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     var yElement = il.GetArrayElement(elementType, y, index); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     CompareObjectsInternal(elementType, xElement, yElement); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   il.Increment(index); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   } il.MarkLabel(loopCondition); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>        { il.LoadLocal(index); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     il.LoadArrayLength(x); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    il.JumpWhenLess(loopBody); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       ,      } }</code> </pre><br>     ,   <s> </s>     ,     .          .       <code>CompareArrays</code>            ,   .      ,     IL    ,  ,         :  ,       .            ( <code>Jump, JumpWhenLess</code> )   <code>loopBody, loopCondition</code> . <br><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="hljs haskell">//       public static void <span class="hljs-type"><span class="hljs-type">LoadLocal</span></span>(this <span class="hljs-type"><span class="hljs-type">ILGenerator</span></span> il, <span class="hljs-type"><span class="hljs-type">LocalBuilder</span></span> x) =&gt; il.<span class="hljs-type"><span class="hljs-type">Emit</span></span>(<span class="hljs-type"><span class="hljs-type">OpCodes</span></span>.<span class="hljs-type"><span class="hljs-type">Ldloc</span></span>, x); //          public static void <span class="hljs-type"><span class="hljs-type">SetLocal</span></span>(this <span class="hljs-type"><span class="hljs-type">ILGenerator</span></span> il, <span class="hljs-type"><span class="hljs-type">LocalBuilder</span></span> x) =&gt; il.<span class="hljs-type"><span class="hljs-type">Emit</span></span>(<span class="hljs-type"><span class="hljs-type">OpCodes</span></span>.<span class="hljs-type"><span class="hljs-type">Stloc</span></span>, x); //       public static void <span class="hljs-type"><span class="hljs-type">LoadArrayLength</span></span>(this <span class="hljs-type"><span class="hljs-type">ILGenerator</span></span> il, <span class="hljs-type"><span class="hljs-type">LocalBuilder</span></span> array) { il.<span class="hljs-type"><span class="hljs-type">LoadLocal</span></span>(array); il.<span class="hljs-type"><span class="hljs-type">Emit</span></span>(<span class="hljs-type"><span class="hljs-type">OpCodes</span></span>.<span class="hljs-type"><span class="hljs-type">Ldlen</span></span>); il.<span class="hljs-type"><span class="hljs-type">Emit</span></span>(<span class="hljs-type"><span class="hljs-type">OpCodes</span></span>.<span class="hljs-type"><span class="hljs-type">Conv_I4</span></span>); } //      ,          public static void <span class="hljs-type"><span class="hljs-type">LoadArrayElement</span></span>(this <span class="hljs-type"><span class="hljs-type">ILGenerator</span></span> il, <span class="hljs-type"><span class="hljs-type">Type</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsEnum</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Enum</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetUnderlyingType(type)</span></span></span><span class="hljs-class">; } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsPrimitive</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">typeof</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IntPtr</span></span></span><span class="hljs-class">) || </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">typeof</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UIntPtr</span></span></span><span class="hljs-class">)) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Emit</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ldelem_I</span></span></span><span class="hljs-class">); } else { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCode</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opCode</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">switch</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetTypeCode(type)</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TypeCode</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Boolean</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TypeCode</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int32</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opCode</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ldelem_I4</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">break</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TypeCode</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Char</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TypeCode</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UInt16</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opCode</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ldelem_U2</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">break</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TypeCode</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SByte</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opCode</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ldelem_I1</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">break</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TypeCode</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Byte</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opCode</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ldelem_U1</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">break</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TypeCode</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int16</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opCode</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ldelem_I2</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">break</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TypeCode</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UInt32</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opCode</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ldelem_U4</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">break</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TypeCode</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int64</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TypeCode</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UInt64</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opCode</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ldelem_I8</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">break</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TypeCode</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Single</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opCode</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ldelem_R4</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">break</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TypeCode</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Double</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opCode</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ldelem_R8</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">break</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">throw</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ArgumentOutOfRangeException</span></span></span><span class="hljs-class">(); } il.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Emit</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opCode</span></span></span><span class="hljs-class">); } } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsValueType</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Emit</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ldelema</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">); } else { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Emit</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Ldelem_Ref</span></span></span><span class="hljs-class">); } } //   ,       public static </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LocalBuilder</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetArrayElement</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILGenerator</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">elementType</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LocalBuilder</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">array</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LocalBuilder</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">var</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeclareLocal(elementType)</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LoadLocal(array)</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LoadLocal(index)</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LoadArrayElement(elementType)</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SetLocal(x)</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">; } //       public static void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Increment</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILGenerator</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LocalBuilder</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LoadLocal(x)</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LoadOne</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Emit</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OpCodes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Add</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">il</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SetLocal(x)</span></span></span><span class="hljs-class">; }</span></span></code> </pre></div></div><br>   <code>DynamicCodeComparer</code>   <code>SimpleClass</code> ,        : <br><br><div class="spoiler"> <b class="spoiler_title">  - IL</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">.<span class="hljs-keyword"><span class="hljs-keyword">method</span></span> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">bool</span></span> __DynamicCompare ( <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> ) cil managed { // <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span> begins at RVA <span class="hljs-number"><span class="hljs-number">0x2050</span></span> // Code size <span class="hljs-number"><span class="hljs-number">215</span></span> (<span class="hljs-number"><span class="hljs-number">0xd7</span></span>) .maxstack <span class="hljs-number"><span class="hljs-number">15</span></span> .locals init ( [<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SimpleClass, [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SimpleClass, [<span class="hljs-number"><span class="hljs-number">2</span></span>] int32, [<span class="hljs-number"><span class="hljs-number">3</span></span>] int32, [<span class="hljs-number"><span class="hljs-number">4</span></span>] valuetype Struct, [<span class="hljs-number"><span class="hljs-number">5</span></span>] valuetype Struct, [<span class="hljs-number"><span class="hljs-number">6</span></span>] int32, [<span class="hljs-number"><span class="hljs-number">7</span></span>] int32, [<span class="hljs-number"><span class="hljs-number">8</span></span>] float64, [<span class="hljs-number"><span class="hljs-number">9</span></span>] float64, [<span class="hljs-number"><span class="hljs-number">10</span></span>] string, [<span class="hljs-number"><span class="hljs-number">11</span></span>] string ) IL_0000: ldarg<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_0001: castclass SimpleClass IL_0006: stloc<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_0007: ldarg<span class="hljs-number"><span class="hljs-number">.1</span></span> IL_0008: castclass SimpleClass IL_000d: stloc<span class="hljs-number"><span class="hljs-number">.1</span></span> IL_000e: ldloc<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_000f: ldloc<span class="hljs-number"><span class="hljs-number">.1</span></span> IL_0010: beq IL_00d5 IL_0015: ldloc<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_0016: ldnull IL_0017: ceq IL_0019: ldloc<span class="hljs-number"><span class="hljs-number">.1</span></span> IL_001a: ldnull IL_001b: ceq IL_001d: beq IL_0024 IL_0022: ldc.i4<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_0023: ret IL_0024: ldloc<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_0025: callvirt instance int32 SimpleClass::get_A() IL_002a: stloc<span class="hljs-number"><span class="hljs-number">.2</span></span> IL_002b: ldloc<span class="hljs-number"><span class="hljs-number">.1</span></span> IL_002c: callvirt instance int32 SimpleClass::get_A() IL_0031: stloc<span class="hljs-number"><span class="hljs-number">.3</span></span> IL_0032: ldloc<span class="hljs-number"><span class="hljs-number">.2</span></span> IL_0033: ldloc<span class="hljs-number"><span class="hljs-number">.3</span></span> IL_0034: beq IL_003b IL_0039: ldc.i4<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_003a: ret IL_003b: ldloc<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_003c: callvirt instance valuetype Struct SimpleClass::get_B() IL_0041: stloc.s <span class="hljs-number"><span class="hljs-number">4</span></span> IL_0043: ldloc<span class="hljs-number"><span class="hljs-number">.1</span></span> IL_0044: callvirt instance valuetype Struct SimpleClass::get_B() IL_0049: stloc.s <span class="hljs-number"><span class="hljs-number">5</span></span> IL_004b: ldloca.s <span class="hljs-number"><span class="hljs-number">4</span></span> IL_004d: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> instance int32 Struct::get_A() IL_0052: stloc.s <span class="hljs-number"><span class="hljs-number">6</span></span> IL_0054: ldloca.s <span class="hljs-number"><span class="hljs-number">5</span></span> IL_0056: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> instance int32 Struct::get_A() IL_005b: stloc.s <span class="hljs-number"><span class="hljs-number">7</span></span> IL_005d: ldloc.s <span class="hljs-number"><span class="hljs-number">6</span></span> IL_005f: ldloc.s <span class="hljs-number"><span class="hljs-number">7</span></span> IL_0061: beq IL_0068 IL_0066: ldc.i4<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_0067: ret IL_0068: ldloca.s <span class="hljs-number"><span class="hljs-number">4</span></span> IL_006a: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> instance float64 Struct::get_B() IL_006f: stloc.s <span class="hljs-number"><span class="hljs-number">8</span></span> IL_0071: ldloca.s <span class="hljs-number"><span class="hljs-number">5</span></span> IL_0073: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> instance float64 Struct::get_B() IL_0078: stloc.s <span class="hljs-number"><span class="hljs-number">9</span></span> IL_007a: ldloc.s <span class="hljs-number"><span class="hljs-number">8</span></span> IL_007c: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-type"><span class="hljs-type">bool</span></span> [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Double::IsNaN(float64) IL_0081: ldloc.s <span class="hljs-number"><span class="hljs-number">9</span></span> IL_0083: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-type"><span class="hljs-type">bool</span></span> [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Double::IsNaN(float64) IL_0088: <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> IL_0089: brtrue IL_0099 IL_008e: ldloc.s <span class="hljs-number"><span class="hljs-number">8</span></span> IL_0090: ldloc.s <span class="hljs-number"><span class="hljs-number">9</span></span> IL_0092: beq IL_0099 IL_0097: ldc.i4<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_0098: ret IL_0099: ldloca.s <span class="hljs-number"><span class="hljs-number">4</span></span> IL_009b: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> instance string Struct::get_C() IL_00a0: stloc.s <span class="hljs-number"><span class="hljs-number">10</span></span> IL_00a2: ldloca.s <span class="hljs-number"><span class="hljs-number">5</span></span> IL_00a4: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> instance string Struct::get_C() IL_00a9: stloc.s <span class="hljs-number"><span class="hljs-number">11</span></span> IL_00ab: ldloc.s <span class="hljs-number"><span class="hljs-number">10</span></span> IL_00ad: ldloc.s <span class="hljs-number"><span class="hljs-number">11</span></span> IL_00af: beq IL_00d5 IL_00b4: ldloc.s <span class="hljs-number"><span class="hljs-number">10</span></span> IL_00b6: ldnull IL_00b7: ceq IL_00b9: ldloc.s <span class="hljs-number"><span class="hljs-number">11</span></span> IL_00bb: ldnull IL_00bc: ceq IL_00be: beq IL_00c5 IL_00c3: ldc.i4<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_00c4: ret IL_00c5: ldloc.s <span class="hljs-number"><span class="hljs-number">10</span></span> IL_00c7: ldloc.s <span class="hljs-number"><span class="hljs-number">11</span></span> IL_00c9: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> instance <span class="hljs-type"><span class="hljs-type">bool</span></span> [mscorlib]<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.String::Equals(string) IL_00ce: brtrue IL_00d5 IL_00d3: ldc.i4<span class="hljs-number"><span class="hljs-number">.0</span></span> IL_00d4: ret IL_00d5: ldc.i4<span class="hljs-number"><span class="hljs-number">.1</span></span> IL_00d6: ret } // <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> Test::__DynamicCompare</code> </pre></div></div><br><div class="spoiler"> <b class="spoiler_title">  - C# (   ILSpy)</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> __DynamicCompare(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> obj, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> obj2) { SimpleClass simpleClass = (SimpleClass)obj; SimpleClass simpleClass2 = (SimpleClass)obj2; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (simpleClass != simpleClass2) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (simpleClass == <span class="hljs-literal"><span class="hljs-literal">null</span></span> != (simpleClass2 == <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = simpleClass.A; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a2 = simpleClass2.A; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a != a2) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } Struct b = simpleClass.B; Struct b2 = simpleClass2.B; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a3 = b.get_A(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a4 = b2.get_A(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a3 != a4) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> b3 = b.get_B(); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> b4 = b2.get_B(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>.IsNaN(b3) &amp; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>.IsNaN(b4)) &amp;&amp; b3 != b4) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> c = b.get_C(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> c2 = b2.get_C(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c != c2) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-literal"><span class="hljs-literal">null</span></span> != (c2 == <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!c.Equals(c2)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre></div></div><br>     ,  ,     .       ,     ,  ,  ,  . <br><br><h5>  results </h5><br>      <code>DynamicCodeComparer, ReflectionComparer</code>         ,         .    IL          . <br><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Struct { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m_a; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> m_b; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> m_c; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> A =&gt; m_a; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> B =&gt; m_b; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> C =&gt; m_c; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Struct</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c</span></span></span><span class="hljs-function">)</span></span> { m_a = a; m_b = b; m_c = c; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SimpleClass</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> A { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Struct B { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ComplexClass</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> A { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IntPtr B { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> UIntPtr C { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> D { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> SimpleClass E { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? F { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] G { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; H { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> I { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> J { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } [BenchmarkTask(platform: BenchmarkPlatform.X86, jitVersion: BenchmarkJitVersion.LegacyJit)] [BenchmarkTask(platform: BenchmarkPlatform.X64, jitVersion: BenchmarkJitVersion.LegacyJit)] [BenchmarkTask(platform: BenchmarkPlatform.X64, jitVersion: BenchmarkJitVersion.RyuJit)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ComplexComparisonTest</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MakeArray</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> array = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[count]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; array.Length; ++i) array[i] = i; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> array; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> List&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MakeList</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(count); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; list.Count; ++i) list.Add(i); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> list; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ComplexClass x = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ComplexClass { A = <span class="hljs-number"><span class="hljs-number">2</span></span>, B = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntPtr(<span class="hljs-number"><span class="hljs-number">2</span></span>), C = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UIntPtr(<span class="hljs-number"><span class="hljs-number">2</span></span>), D = <span class="hljs-string"><span class="hljs-string">"Habrahabr!"</span></span>, E = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleClass { A = <span class="hljs-number"><span class="hljs-number">42</span></span>, B = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Struct(<span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">3.14</span></span>, <span class="hljs-string"><span class="hljs-string">"meow"</span></span>) }, F = <span class="hljs-number"><span class="hljs-number">1</span></span>, G = MakeArray(<span class="hljs-number"><span class="hljs-number">100</span></span>), H = MakeList(<span class="hljs-number"><span class="hljs-number">100</span></span>), I = <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>.MaxValue, J = <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>.MaxValue }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ComplexClass y = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ComplexClass { A = <span class="hljs-number"><span class="hljs-number">2</span></span>, B = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntPtr(<span class="hljs-number"><span class="hljs-number">2</span></span>), C = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UIntPtr(<span class="hljs-number"><span class="hljs-number">2</span></span>), D = <span class="hljs-string"><span class="hljs-string">"Habrahabr!"</span></span>, E = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleClass { A = <span class="hljs-number"><span class="hljs-number">42</span></span>, B = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Struct(<span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">3.14</span></span>, <span class="hljs-string"><span class="hljs-string">"meow"</span></span>) }, F = <span class="hljs-number"><span class="hljs-number">1</span></span>, G = MakeArray(<span class="hljs-number"><span class="hljs-number">100</span></span>), H = MakeList(<span class="hljs-number"><span class="hljs-number">100</span></span>), I = <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>.MaxValue, J = <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>.MaxValue }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ReflectionComparer reflectionComparer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReflectionComparer(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DynamicCodeComparer dynamicCodeComparer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DynamicCodeComparer(); [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReflectionCompare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = reflectionComparer.Equals(x, y); } [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DynamicCodeCompare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = dynamicCodeComparer.Equals(x, y); } [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ManualCompare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = CompareComplexObjects(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareComplexObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xA != yA) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xB != yB) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xC != yC) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xD != yD) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xE != yE) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xEA != yEA) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s1 = xEB; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s2 = yEB; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s1.A != s2.A) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!s1.B.Equals(s2.B)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s1.C != s2.C) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xF != yF) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xG != yG) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xG?.Length != yG?.Length) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] a = xG, b = yG; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; a.Length; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a[i] != b[i]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xH != yH) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!xHSequenceEqual(yH)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!xIEquals(yI)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!xJEquals(yJ)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } [BenchmarkTask(platform: BenchmarkPlatform.X86, jitVersion: BenchmarkJitVersion.LegacyJit)] [BenchmarkTask(platform: BenchmarkPlatform.X64, jitVersion: BenchmarkJitVersion.LegacyJit)] [BenchmarkTask(platform: BenchmarkPlatform.X64, jitVersion: BenchmarkJitVersion.RyuJit)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SimpleComparisonTest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SimpleClass x = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleClass { A = <span class="hljs-number"><span class="hljs-number">42</span></span>, B = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Struct(<span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">3.14</span></span>, <span class="hljs-string"><span class="hljs-string">"meow"</span></span>) }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SimpleClass y = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleClass { A = <span class="hljs-number"><span class="hljs-number">42</span></span>, B = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Struct(<span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">3.14</span></span>, <span class="hljs-string"><span class="hljs-string">"meow"</span></span>) }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ReflectionComparer reflectionComparer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReflectionComparer(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DynamicCodeComparer dynamicCodeComparer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DynamicCodeComparer(); [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReflectionCompare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = reflectionComparer.Equals(x, y); } [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DynamicCodeCompare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = dynamicCodeComparer.Equals(x, y); } [Benchmark] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ManualCompare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = CompareSimpleObjects(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareSimpleObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xA != yA) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s1 = xB; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s2 = yB; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s1.A != s2.A) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!s1.B.Equals(s2.B)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s1.C != s2.C) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre></div></div><br> <b>   ComplexClass</b> <br><table><tbody><tr><th>  Method </th><th> Platform </th><th> Jit </th><th> AvrTime </th><th> StdDev </th><th> op/s </th></tr><tr><td> DynamicCodeComparer </td><td> X64 </td><td> LegacyJit </td><td> 1,104.7155 ns </td><td> 32.9474 ns </td><td> 905,210.51 </td></tr><tr><td> Handwritten </td><td> X64 </td><td> LegacyJit </td><td> 1,360.3273 ns </td><td> 39.9703 ns </td><td> 735,117.32 </td></tr><tr><td> ReflectionComparer </td><td> X64 </td><td> LegacyJit </td><td> 38,043.3600 ns </td><td> 2,261.3159 ns </td><td> 26,290.11 </td></tr><tr><td> DynamicCodeComparer </td><td> X64 </td><td> RyuJit </td><td> 834.8742 ns </td><td> 58.1986 ns </td><td> 1,197,785.93 </td></tr><tr><td> Handwritten </td><td> X64 </td><td> RyuJit </td><td> 968.3789 ns </td><td> 33.1622 ns </td><td> 1,032,653.82 </td></tr><tr><td> ReflectionComparer </td><td> X64 </td><td> RyuJit </td><td> 37,751.3104 ns </td><td> 1,763.3172 ns </td><td> 26,489.20 </td></tr><tr><td> DynamicCodeComparer </td><td> X86 </td><td> LegacyJit </td><td> 776.0265 ns </td><td> 22.8038 ns </td><td> 1,288,615.79 </td></tr><tr><td> Handwritten </td><td> X86 </td><td> LegacyJit </td><td> 915.5713 ns </td><td> 26.0536 ns </td><td> 1,092,214.32 </td></tr><tr><td> ReflectionComparer </td><td> X86 </td><td> LegacyJit </td><td> 32,382.2746 ns </td><td> 1,748.4016 ns </td><td> 30,881.10 </td></tr></tbody></table><br> <b>   SimpleClass</b> <br><table><tbody><tr><th>  Method </th><th> Platform </th><th> Jit </th><th> AvrTime </th><th> StdDev </th><th> op/s </th></tr><tr><td> DynamicCodeComparer </td><td> X64 </td><td> LegacyJit </td><td> 215.7626 ns </td><td> 8.2063 ns </td><td> 4,634,725.08 </td></tr><tr><td> Handwritten </td><td> X64 </td><td> LegacyJit </td><td> 160.4945 ns </td><td> 6.8949 ns </td><td> 6,230,741.94 </td></tr><tr><td> ReflectionComparer </td><td> X64 </td><td> LegacyJit </td><td> 6,654.3290 ns </td><td> 380.7790 ns </td><td> 150,278.15 </td></tr><tr><td> DynamicCodeComparer </td><td> X64 </td><td> RyuJit </td><td> 168.4194 ns </td><td> 9.4654 ns </td><td> 5,937,569.56 </td></tr><tr><td> Handwritten </td><td> X64 </td><td> RyuJit </td><td> 87.8513 ns </td><td> 3.3118 ns </td><td> 11,382,874.20 </td></tr><tr><td> ReflectionComparer </td><td> X64 </td><td> RyuJit </td><td> 6,954.6437 ns </td><td> 387.1803 ns </td><td> 143,789.85 </td></tr><tr><td> DynamicCodeComparer </td><td> X86 </td><td> LegacyJit </td><td> 180.4105 ns </td><td> 6.5036 ns </td><td> 5,542,914.59 </td></tr><tr><td> Handwritten </td><td> X86 </td><td> LegacyJit </td><td> 93.0846 ns </td><td> 4.0584 ns </td><td> 10,742,923.17 </td></tr><tr><td> ReflectionComparer </td><td> X86 </td><td> LegacyJit </td><td> 6,431.5783 ns </td><td> 314.5633 ns </td><td> 155,483.09 </td></tr></tbody></table><br><h5>  Conclusion </h5><br>       ¬´No silver bullet¬ª       (accidental complexity)    (essential complexity),     .        ,  - ,   -         .          ,        .           ,         <code>IEquatable&lt;T&gt;</code> .      ,   -   . <br><br>  ,  .  Have a nice programming! <br><br>  : <br><ul><li> <a href="https://github.com/akarpov89/DynamicComparer">   </a> <br></li><li> <a href="http://www.williamspublishing.com/Books/978-5-8459-1819-2.html"> ,  . C# 5.0.</a>  <a href="http://www.williamspublishing.com/Books/978-5-8459-1819-2.html">Directory.</a> <a href="http://www.williamspublishing.com/Books/978-5-8459-1819-2.html">  </a> <br></li><li> <a href="http://www.apress.com/9781590596463">Serge Lidin. Expert .NET 2.0 IL Assembler</a> <br></li><li> MSDN ‚Äî <a href="https://msdn.microsoft.com/en-us/library/system.reflection.emit%2528v%253Dvs.110%2529.aspx">System.Reflection.Emit Namespace</a> <br></li><li>  <a href="https://github.com/PerfDotNet/BenchmarkDotNet">BenchmarkDotNet</a> <br></li><li> <a href="http://tryroslyn.azurewebsites.net/">Try Roslyn</a> <br></li></ul></div><p>Source: <a href="https://habr.com/ru/post/269699/">https://habr.com/ru/post/269699/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269689/index.html">Server Push Implementation for Nancy</a></li>
<li><a href="../269691/index.html">Telecommunications giant TalkTalk suffered from cyber attack</a></li>
<li><a href="../269693/index.html">Parallel processing of a large select in several sessions</a></li>
<li><a href="../269695/index.html">From Java to Scala: 7 reasons to learn a new language</a></li>
<li><a href="../269697/index.html">Cold perfection: news on the data center cooling systems market</a></li>
<li><a href="../269701/index.html">Monitoring is handy on IxoraRMS. Quick and tasteful</a></li>
<li><a href="../269705/index.html">Sharing checkstyle and gerrit</a></li>
<li><a href="../269707/index.html">Duke, take out the trash! - Part 2</a></li>
<li><a href="../269709/index.html">Validation of complex structures with PHPixie Validate</a></li>
<li><a href="../269711/index.html">Another build Vivaldi 1.0.303.37 - Beta Candidate</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>