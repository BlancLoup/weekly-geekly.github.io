<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to launch ClickHouse on your own and win the jackpot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We decided to describe a simple and proven way for those who want to implement ClickHouse analytical database on their own or just try ClickHouse on t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to launch ClickHouse on your own and win the jackpot</h1><div class="post__text post__text-html js-mediator-article"><p>  We decided to describe a simple and proven way for those who want to <strong>implement <a href="https://clickhouse.yandex/">ClickHouse</a> analytical database</strong> on their own or just try ClickHouse on their own data.  It was this path we ourselves went through in the news aggregator Mass Media2 and achieved impressive results. </p><br><p><img src="https://habrastorage.org/files/c6e/839/4a3/c6e8394a3f74489d813d8e869676a776.png" alt="Clickhouse-client"></p><br><p>  In the preface of the article - a short story about our attempts to introduce Druid and InfluxDB.  Why, after the successful launch of ClickHouse, we were able to stop using InfiniDB and Cassandra. </p><br><a name="habracut"></a><br><p>  The main part of the article is devoted <strong><a href="https://github.com/smi2">to ClickHouse helpers</a> , which we developed and released in open-source</strong> .  By the way, welcome to pull requests with suggestions and comments. </p><br><p>  We assume that the reader is familiar with the <a href="https://clickhouse.yandex/reference_ru.html">official ClickHouse documentation</a> . </p><br><h1 id="kto-my-takie-i-s-kakimi-dannymi-rabotaem">  Who we are and what data we work with </h1><br><p>  In the beginning we will tell about who we are and about the data, by the example of which we will further analyze the work with ClickHouse.  Media2 is an information service that has been providing relevant news around the clock since 2008 and forms a complete information picture of the day.  Today, Media2 includes a news aggregator and <a href="https://smi2.net/corporate/traffic/">exchange network</a> with more than 2500 partners, including the leading federal online media, industry sites and regional publications.  The monthly audience of mass media2 is about 15 million people. </p><br><p>  We will analyze the work with ClickHouse on the example of one of the simple parts of the data collected from our <strong>news aggregator</strong> , which is represented by three regional sites: <a href="http://smi2.ru/">smi2.ru</a> , <a href="https://smi2.ua/">smi2.ua</a> and <a href="http://smi2.kz/">smi2.kz.</a>  At each site we collect and process data about views and clicks on the news.  This data is used both in real time - for the issuance of content, and for post-analysis of the effectiveness of materials. </p><br><p>  In your case, the analyzed data can be, for example, server logs, statistics on events on websites, in booking systems, e-mailing, tracking sensors, etc. In all these cases, and if you have a lot of data, ClickHouse is worth it. to try. </p><br><h1 id="kak-my-prishli-k-clickhouse">  How we came to ClickHouse </h1><br><p>  We identified the following critical requirements for an analytical database: </p><br><ul><li>  real-time query processing speed </li><li>  presence of built-in analytic functions </li><li>  availability of <a href="https://clickhouse.yandex/reference_ru.html">functions for</a> <a href="https://clickhouse.yandex/reference_ru.html">approximate calculations</a> </li><li>  linear scalability, since to achieve linear scalability without degradation with an increase in the number of servers is a rather difficult technical task </li><li>  availability of sharding and data replication "out of the box" </li><li>  no single point of failure (data can be written to each node in the cluster) </li><li>  optimal cost of ownership (value for money) </li></ul><br><p>  As a background, I would like to talk about what technological stack we used earlier, what we had to give up and how we came to ClickHouse. </p><br><h2 id="neudachnyy-opyt-s-druid-i-influxdb">  Bad experience with Druid and InfluxDB </h2><br><p>  This year we deployed an assembly based on the <a href="http://druid.io/">Druid</a> - <a href="https://imply.io/product">Imply Analytics Platform</a> , as well as <a href="https://github.com/druid-io/tranquility">Tranquility</a> , and were ready to launch in production ... But after the release of ClickHouse, they immediately abandoned Druid, although they spent two months studying and implementing it. </p><br><p>  Of the benefits noted for themselves the following: </p><br><ul><li>  Support RT stream from HTTP, Spark, Kafka, etc. </li><li>  Graphic Tools Pivot, Caravel </li></ul><br><p>  However, the following disadvantages outweighed the balance: </p><br><ul><li>  Infrastructure complexity: separate nodes are required for receiving, processing and storing data; for fault tolerance, a double number of servers is required </li><li>  Tranquility, designed for realtime data processing, contains errors that lead to the fall of the entire Tranquility;  Tranquility versions are not compatible with each other;  for ourselves, we appreciated Tranquility for a good and interesting product, but so far Beta </li></ul><br><p>  We also had a trial approach to the <a href="http://influxdata.com/">InfluxDB</a> system (see the <a href="https://habrahabr.ru/company/selectel/blog/245515/">article</a> ), which we planned to use for building and analyzing metrics.  We evaluated the project as deep Alfa due to frequent data loss and system crashes, so we also stopped working in this direction.  Perhaps now the state of the product has changed for the better. </p><br><h2 id="cassandra-i-infinidb-proderzhalis-u-nas-dva-goda">  Cassandra and InfiniDB stayed with us for two years </h2><br><p>  <a href="http://cassandra.apache.org/">Cassandra was</a> used in our production from 2014 to 2016: </p><br><ul><li>  Worked on 5 servers </li><li>  Maintained a load of up to 10K events per second for insertion and up to about 1K events per second for reading </li><li>  Approximately 1 time in 2 months there were desynchronization of data schemes (perhaps it was the problem of the version we used) </li></ul><br><p>  In the same period, we used <a href="https://github.com/infinidb/infinidb">InfiniDB</a> .  From the positive moments I would like to note the following: </p><br><ul><li>  Window support </li><li>  Easy integration with existing MySQL via Federated engine </li><li>  The built-in MyISAM and InnoDB engines, which allowed unloading from the InfiniDB engine to the InnoDB engine inside a single server </li><li>  The ability to delete partitions of data for each day, according to specific columns </li></ul><br><p>  However, it was not without negative points: </p><br><ul><li>  Lack of normal cluster and data replication.  I had to make a hot copy of the data, i.e. a server clone </li><li>  The first versions had to be reloaded regularly due to memory leaks and service hangs. </li><li>  Hanging processes to write or read requests.  Had to kill long processes through event handlers nagios </li><li>  The difficulty of loading data.  There is only a separate console tool cpimport.  I had to implement a wrapper that parses the utility output in stdout for errors and statistics for the result of the execution of the insert. </li><li>  Conditional single-threading: either we write, or we read.  Large system resources consumed </li></ul><br><h2 id="i-tut-yandeks-vylozhil-v-otkrytyy-dostup-clickhouse">  And here "Yandex" laid out in open access ClickHouse </h2><br><p>  Due to shortcomings and problems with the DBMS we use for analytics, we regularly looked around in search of alternatives.  In particular, we paid attention <a href="https://habrahabr.ru/company/yandex/blog/273305/">to the internal development of ‚ÄúYandex‚Äù</a> , which bribed with its incredible speed and generally met our expectations from an analytical database (see above). </p><br><p> There are currently no free or low-cost analytical databases for processing real-time, large data at a level like ClickHouse.  In any case, we do not know about these.  From paid databases, we tested HP Vertica and Greenplum.  Analytics can also be read using Hadoop MapReduce, but not in near real-time mode.  By the way, in the ‚ÄúYandex‚Äù there is <a href="https://habrahabr.ru/company/yandex/blog/311104/">YT</a> (‚ÄúYt‚Äù, as they call it themselves) - MapReduce is a platform for working with big data, but it also does not work in real time, although it is actively used.  That is, for analytics in real time, in our opinion, ClickHouse is best suited.  Therefore, when Yandex published <a href="https://habrahabr.ru/company/yandex/blog/303282/">ClickHouse in open access</a> in the summer, we definitely decided to try it. </p><br><h1 id="kak-nam-pomog-clickhouse">  How ClickHouse helped us </h1><br><p>  We can confidently say that the ClickHouse launch process was faster and easier than with other DBMS.  We hope that our article will allow you to do this much faster :) </p><br><p>  If you skip the story about how we launched ClickHouse and eventually successfully launched, it is worth noting the following results of the launch of ClickHouse. </p><br><p>  <strong>Benefits in development</strong> .  In a relatively short time, we managed to close 80% of the tasks associated with data analysis, and these tasks have accumulated a lot.  New analytics tasks have become much easier and faster. </p><br><p>  <strong>Benefits in the gland</strong> .  Compared with the same Druid, ClickHouse's hardware requirements were significantly lower, so we were able to save on hardware.  Plus, we abandoned 5 nodes under Cassandra, 4 nodes under InfiniDB and 2 nodes under MySQL (historically remaining analytics).  In total, we abandoned 11 servers, for which we had to constantly monitor and not to miss alerts about problems from nagios. </p><br><p>  <strong>The benefits of data storage</strong> .  ClickHouse stores data using various compression mechanisms.  Due to the support of sharding and replication, ClickHouse is able to store and process data distributedly.  Replication not only improves data storage reliability, but also optimizes read operations within the cluster. </p><br><p>  <strong>Speed ‚Äã‚Äãbenefits</strong> .  ClickHouse is really fast, we have seen this on our tasks, the speed has increased several times! </p><br><p>  Here, many will think that it would be nice to give for an example benchmarks ... We suggest turning to <a href="https://clickhouse.yandex/benchmark.html">Yandex benchmarks</a> and watching our videos with requests for real data sets.  The statistics collected and analyzed by us using ClickHouse data at the moment is as follows: </p><br><ul><li>  up to 8,000‚Äì12,000 events per second are recorded </li><li>  approximately 21.5 billion events per month </li><li>  about 10 billion lines in the database for the month </li></ul><br><p>  The data is stored on 6 SX131 servers from Hetzner with 3 shards with 2 replicas. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Yp1qAoDS8FM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h1 id="osobennosti-clickhouse">  Features ClickHouse </h1><br><p>  Like any data product, <a href="https://clickhouse.yandex/reference_ru.html">ClickHouse</a> <a href="https://clickhouse.yandex/reference_ru.html">has its own characteristics</a> .  Here are some of them: </p><br><ul><li>  No UPDATE and Derivatives: INSERT UPDATE and DELETE </li><li>  No transaction </li><li>  Deleting data by month through deleting partitions </li></ul><br><p>  In addition, ClickHouse does not know how to build out-of-the-box graphics, this requires additional tools. </p><br><p>  For us, transactionality and the lack of UPDATE / DELETE are not important.  We have long been accustomed to bypass these problems.  However, we would love to be able to store data for only a few days.  The plans of "Yandex" - add the ability to delete partitions by day. </p><br><h1 id="nashi-proekty-dlya-clickhouse">  Our projects for ClickHouse </h1><br><p>  In the process of developing and implementing ClickHouse, we are faced with some inconveniences and the lack of the ‚Äúbuns‚Äù we need.  Therefore, without becoming wait for favors from " <del>  Yandex </del>  ‚ÄùNature, we decided to facilitate the work themselves.  Another motivator was that we wanted to contribute to the development of a promising open-source project.  Plus - this was our first experience of participating in open-source development. </p><br><p>  So two of our open-source projects were born, which allowed ourselves to significantly speed up and simplify the process of implementing ClickHouse and working with it: </p><br><ol><li>  <a href="https://github.com/smi2/clickhouse-frontend">Graphic client</a> for working with DB </li><li>  <a href="https://github.com/smi2/phpClickHouse">Wrapper for PHP</a> for convenient work with the database that implements the features of ClickHouse </li></ol><br><p>  The following describes the main features of each project. </p><br><h2 id="nash-graficheskiy-klient-dlya-clickhouse-vozmozhnosti-i-osobennosti">  Our graphical client for ClickHouse: features and features </h2><br><ul><li>  View a list of databases and tables </li><li>  View table contents </li><li>  Highlight ClickHouse functions, table and field names </li><li>  Auto-completion for table, column, and built-in names </li><li>  Execution of selected / current / multiple requests in the editor </li><li>  Automatic query type detection: CREATE TABLE / INSERT / SELECT </li><li>  Easy insertion of dictionary values </li><li>  Themes for the query editor, the themes for the entire editor (light and dark) </li><li>  Hotkeys </li></ul><br><p>  The client is written entirely in JavaScript, without using the server side. </p><br><p>  You can safely use our <a href="http://guiclickhouse.smi2.ru/">latest published build</a> . </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/u5DOWnm47vg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2 id="nash-php-drayver-dlya-clickhouse-vozmozhnosti-i-osobennosti">  Our PHP driver for ClickHouse: features and features </h2><br><ul><li>  No dependencies, only curl and json modules are required </li><li>  Work with ClickHouse cluster, automatic detection of necessary nodes for different configurations </li><li>  Perform a query on each node in the cluster (see our <a href="https://github.com/smi2/phpMigrationsClickhouse">separate project on ClickHouse migrations</a> ) </li><li>  Asynchronous requests to read data and insert data </li><li>  Compression support on the fly when writing data to ClickHouse from a local file without creating temporary files </li><li> Supports read requests using a local CSV file to make a query of the form <code>select * from X where id in (local_csv_file)</code> </li><li>  Work with table partitions </li><li>  Insert array into column </li><li>  Write the result of the query directly to a file with compression support without creating temporary files </li><li>  Getting the size of the table, database and list of processes on each node </li><li>  Getting statistics on SELECT query </li></ul><br><p>  Driver tested for PHP 5.6 and 7, HHVM 3.9. </p><br><p>  We want to immediately warn readers that the driver does not use ready-made solutions like Guzzle (and PSR-7 in general), but is implemented through the <code>include.php</code> file.  We hope that this fact will not scare you from further reading. </p><br><h1 id="primery-raboty-s-clickhouse">  Examples of working with ClickHouse </h1><br><p>  Let‚Äôs look at an example of how ClickHouse works <a href="https://github.com/smi2/phpClickHouse">from PHP</a> and using our <a href="https://github.com/smi2/clickhouse-frontend">graphical client</a> . </p><br><p>  We believe that you have successfully installed ClickHouse from the <a href="https://clickhouse.yandex/">deb-package of the latest version</a> and read the <a href="https://clickhouse.yandex/tutorial.html">Quick start guide</a> . </p><br><p>  Let <code>site_id = 1</code> for smi2.ru, <code>site_id = 2</code> for smi2.ua, and <code>site_id = 3</code> for smi2.kz. </p><br><p>  On each site events related to articles (news).  We will register data about the impressions of articles (views) and clicks on each article (clicks). </p><br><p>  For each event we will fix several attributes: </p><br><ul><li>  User IP Address </li><li>  city ‚Äã‚Äãof user </li><li>  referer </li><li>  UTM tag from referer </li><li>  unique user ID </li></ul><br><h2 id="podklyuchenie-k-serveru-clickhouse-sozdanie-bd-i-tablicy">  Connecting to the ClickHouse server, creating a database and a table </h2><br><p>  To record event data, create a database of <code>articles</code> on the ClickHouse server and inside it the <code>events</code> table with the following structure: </p><br><pre> <code class="sql hljs"> event_date Date event_time DateTime event_type Enum8('VIEWS' = 1, 'CLICKS' = 2) site_id Int32 article_id Int32 ip String city String user_uuid String referer String utm String</code> </pre> <br><p>  First consider the creation of a database and a table using our <strong>graphical client</strong> .  We connect via a graphical client to the ClickHouse server and execute a query to create a new database and a new table: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> articles ; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> articles.events ( event_date <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>, event_time DateTime, event_type Enum8(<span class="hljs-string"><span class="hljs-string">'VIEWS'</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'CLICKS'</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>), site_id Int32, article_id Int32, ip <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, city <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, user_uuid <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, referer <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, utm <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">engine</span></span>=MergeTree(event_date, (site_id, event_type, article_id), <span class="hljs-number"><span class="hljs-number">8192</span></span>)</code> </pre> <br><p><img src="https://habrastorage.org/files/007/5cb/466/0075cb4664e3413b8532eedabdefaa30.png" alt="Clickhouse GUI example"></p><br><p>  Let us explain some parameters of this request: </p><br><ul><li>  <code>MergeTree</code> is a table engine.  There are also <code>Log</code> , <code>CollapsingMergeTree</code> , <code>SummingMergeTree</code> , <code>ReplacingMergeTree</code> and others. </li><li>  The first parameter, <code>event_date</code> indicates the name of a Date column containing a date. </li><li>  <code>(site_id, event_type, article_id)</code> - a tuple defining the primary key of the table (index). </li></ul><br><p>  Most of the read requests plan to indicate which site we need data for, so <code>site_id</code> used first in the index. </p><br><p>  Now we will try to create a connection to the ClickHouse server, a database and a table through our <strong>PHP driver</strong> .  To do this, first install the driver. </p><br><p>  Installing a stable driver assembly can be done through <code>composer</code> : <br> <code>composer require smi2/phpclickhouse</code> </p> <br><p>  or clone the driver from the main (master) branch of the Git repository: <br> <code>git clone https://github.com/smi2/phpClickHouse.git</code> </p> <br><p>  More detailed information on driver installation is available in <a href="https://github.com/smi2/phpClickHouse">the driver documentation</a> , which also contains a description of driver functions and ChangeLog. </p><br><p>  After the driver has been successfully installed, we perform a request to connect to the server, create a database and a table: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//  $config=['host'=&gt;'192.168.1.20','port'=&gt;'8123','username'=&gt;'default','password'=&gt;'']; //   $client=new \ClickHouseDB\Client($config); //     $client-&gt;ping(); //     $client-&gt;write('CREATE DATABASE IF NOT EXISTS articles'); $client-&gt;write("CREATE TABLE IF NOT EXISTS articles.events ( event_date Date, event_time DateTime, event_type Enum8('VIEWS' = 1, 'CLICKS' = 2), site_id Int32, article_id Int32, ip String, city String, user_uuid String, referer String, utm String ) engine=MergeTree(event_date, (site_id, event_type, article_id), 8192) "); //  default  $client-&gt;database('articles'); //    print_r($client-&gt;showTables());</span></span></code> </pre> <br><p>  Please note that requests in the driver are divided into the following: </p><br><ul><li>  a record </li><li>  data insertion </li><li>  reading </li></ul><br><p>  Inserts and reads can be performed in parallel. </p><br><p>  Requests to write and insert data do not contain a response, only checks are made that the server‚Äôs response was positive.  Requests for reading the answer contain (the exception is the direct recording of the response to the file). </p><br><h2 id="vstavka-dannyh-v-tom-chisle-iz-tsv-fayla">  Inserting data, including from a TSV file </h2><br><p>  Insert the data that we will use for testing: </p><br><pre> <code class="php hljs">$client-&gt;insert(<span class="hljs-string"><span class="hljs-string">'events'</span></span>, [ [date(<span class="hljs-string"><span class="hljs-string">'Ym-d'</span></span>), time(), <span class="hljs-string"><span class="hljs-string">'CLICKS'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1234</span></span>, <span class="hljs-string"><span class="hljs-string">'192.168.1.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'Moscow'</span></span>, <span class="hljs-string"><span class="hljs-string">'xcvfdsazxc'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>], [date(<span class="hljs-string"><span class="hljs-string">'Ym-d'</span></span>), time(), <span class="hljs-string"><span class="hljs-string">'CLICKS'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1235</span></span>, <span class="hljs-string"><span class="hljs-string">'192.168.1.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'Moscow'</span></span>, <span class="hljs-string"><span class="hljs-string">'xcvfdsazxc'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://yandex.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>], [date(<span class="hljs-string"><span class="hljs-string">'Ym-d'</span></span>), time(), <span class="hljs-string"><span class="hljs-string">'CLICKS'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1236</span></span>, <span class="hljs-string"><span class="hljs-string">'192.168.1.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'Moscow'</span></span>, <span class="hljs-string"><span class="hljs-string">'xcvfdsazxc'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>], [date(<span class="hljs-string"><span class="hljs-string">'Ym-d'</span></span>), time(), <span class="hljs-string"><span class="hljs-string">'CLICKS'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1237</span></span>, <span class="hljs-string"><span class="hljs-string">'192.168.1.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'Moscow'</span></span>, <span class="hljs-string"><span class="hljs-string">'xcvfdsazxc'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>], ], [ <span class="hljs-string"><span class="hljs-string">'event_date'</span></span>, <span class="hljs-string"><span class="hljs-string">'event_time'</span></span>, <span class="hljs-string"><span class="hljs-string">'event_type'</span></span>, <span class="hljs-string"><span class="hljs-string">'site_id'</span></span>, <span class="hljs-string"><span class="hljs-string">'article_id'</span></span>, <span class="hljs-string"><span class="hljs-string">'ip'</span></span>, <span class="hljs-string"><span class="hljs-string">'city'</span></span>, <span class="hljs-string"><span class="hljs-string">'user_uuid'</span></span>, <span class="hljs-string"><span class="hljs-string">'referer'</span></span>, <span class="hljs-string"><span class="hljs-string">'utm'</span></span> ] );</code> </pre> <br><p>  This insert method is suitable only for small tables or tables of reference books, since in this case the array will be converted to a row. </p><br><p>  Get the result of inserting data: </p><br><pre> <code class="php hljs">print_r( $client-&gt;select(<span class="hljs-string"><span class="hljs-string">'SELECT * FROM events'</span></span>)-&gt;rows() );</code> </pre> <br><p>  More information about reading data is written below.  To insert more lines, we will use <strong>direct loading of the TSV file</strong> that will be generated during the event.  To do this, we will record the TSV file on the server where the events occur, and to simplify sending it to ClickHouse. </p><br><p>  Suppose that we have a certain <code>UserEvent</code> class that allows us to obtain all the necessary data for insertion, the data is checked for validity inside the class: </p><br><pre> <code class="php hljs">$row = [ <span class="hljs-string"><span class="hljs-string">'event_date'</span></span> =&gt; $userEvent-&gt;getDate(), <span class="hljs-string"><span class="hljs-string">'event_time'</span></span> =&gt; $userEvent-&gt;getTime(), <span class="hljs-string"><span class="hljs-string">'event_type'</span></span> =&gt; $userEvent-&gt;getType(), <span class="hljs-string"><span class="hljs-string">'site_id'</span></span> =&gt; $userEvent-&gt;getSiteId(), <span class="hljs-string"><span class="hljs-string">'article_id'</span></span> =&gt; $userEvent-&gt;getArticleId(), <span class="hljs-string"><span class="hljs-string">'ip'</span></span> =&gt; $userEvent-&gt;getIp(), <span class="hljs-string"><span class="hljs-string">'city'</span></span> =&gt; $userEvent-&gt;getCity(), <span class="hljs-string"><span class="hljs-string">'user_uuid'</span></span> =&gt; $userEvent-&gt;getUserUuid(), <span class="hljs-string"><span class="hljs-string">'referer'</span></span> =&gt; $userEvent-&gt;getReferer(), <span class="hljs-string"><span class="hljs-string">'utm'</span></span> =&gt; $userEvent-&gt;getUtm(), ];</code> </pre> <br><p>  We will write to a file that is rotated every minute in the following way (we assume all the flaws - write errors, locks, etc. - the line is always written): </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   $filename='/tmp/articles.events_version1_'.date("YmdHi").'.TSV'; //     TabSeparated $text=\ClickHouseDB\FormatLine::TSV($row)."\n"; //       CSV // $text=\ClickHouseDB\FormatLine::CSV($row)."\n"; file_put_contents($filename,$text,FILE_APPEND);</span></span></code> </pre> <br><p>  On GitHub for tests, <a href="https://github.com/smi2/phpClickHouse/blob/master/doc/article_01_userevent.php">the</a> <a href="https://github.com/smi2/phpClickHouse/blob/master/doc/article_01_userevent.php"><code>UserEvent</code></a> <a href="https://github.com/smi2/phpClickHouse/blob/master/doc/article_01_userevent.php">class emulator</a> is made and <a href="https://github.com/smi2/phpClickHouse/blob/master/doc/article_01_bigtable.php">an example of</a> using this class with writing to the base. </p><br><p>  Suppose that we have accumulated 5-10 such files, and we are ready to send them to the database: </p><br><pre> <code class="php hljs">$file_data_names= [ <span class="hljs-string"><span class="hljs-string">'/tmp/articles.events_version1_201612121201.TSV'</span></span>, <span class="hljs-string"><span class="hljs-string">'/tmp/articles.events_version1_201612121301.TSV'</span></span>, <span class="hljs-string"><span class="hljs-string">'/tmp/articles.events_version1_201612121401.TSV'</span></span> ] <span class="hljs-comment"><span class="hljs-comment">//   $client-&gt;enableHttpCompression(true); //  TSV-  ClickHouse $result_insert = $client-&gt;insertBatchTSVFiles('events', [$file_data_names], [ 'event_date', 'event_time', 'event_type', 'site_id', 'article_id', 'ip', 'city', 'user_uuid', 'referer', 'utm' ]); //  ,      foreach ($file_data_names as $fileName) { echo $fileName . " : " . $result_insert[$fileName]-&gt;totalTimeRequest() . "\n"; }</span></span></code> </pre> <br><p>  It is worth noting that working with <strong>CSV files is</strong> also supported.  For them, you need to use the <code>insertBatchFiles()</code> function, similar to the <code>insertBatchTSVFiles()</code> function.  However, when using TSV files, there is an additional possibility to insert the date and time in the DateTime field in the unix timestamp format.  See the <a href="https://clickhouse.yandex/reference_ru.html">ClickHouse documentation</a> for more information about the support for the TabSeparated format. </p><br><p>  <a href="https://clickhouse.yandex/reference_ru.html">ClickHouse uses the CSV format</a> corresponding to <a href="https://tools.ietf.org/html/rfc4180">RFC 4180</a> .  At the same time, standard PHP tools, namely the <code>fputcsv()</code> function, does not fully comply with the format requirements (see <a href="https://bugs.php.net/bug.php%3Fid%3D50686">error report</a> ). </p><br><p>  To fully support the TSV and CSV files, we implemented array-to-string converters: <code>FormatLine::CSV()</code> and <code>FormatLine::TSV()</code> , which use the ClickHouse ability to store data in columns in the form of arrays. </p><br><p>  With large amounts of data inserted from data files, we enable compression mode.  In this case, streaming compression is used without creating temporary files, which saves server server network resources, slightly increasing the CPU load.  The data transfer rate increases, and the total time spent on processing a single file is reduced several times. </p><br><p>  In our example, for each row we pass the <code>event_date</code> field, although the same date is passed in the <code>event_time</code> field.  You can save resources and don‚Äôt transfer fields each time that you can calculate on the ClickHouse server from another field.  For more information about <strong>defaults,</strong> see the <a href="https://clickhouse.yandex/reference_ru.html">ClickHouse documentation</a> . </p><br><p>  The <code>utm</code> field will be filled from the <code>referer</code> field, if it contains utm_campaign, through the <code>extractURLParameter(referer,'utm_campaign')</code> function <code>extractURLParameter(referer,'utm_campaign')</code> . </p><br><p>  Recreate the table: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> articles.events ( event_date <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> toDate(event_time), event_time DateTime, event_type Enum8(<span class="hljs-string"><span class="hljs-string">'VIEWS'</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'CLICKS'</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>), site_id Int32, article_id Int32, ip <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, city <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, user_uuid <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, referer <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, utm <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> extractURLParameter(referer, <span class="hljs-string"><span class="hljs-string">'utm_campaign'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">engine</span></span>=MergeTree(event_date, (site_id, event_type,article_id), <span class="hljs-number"><span class="hljs-number">8192</span></span>)</code> </pre> <br><p>  Change the record: </p><br><pre> <code class="php hljs">$client-&gt;insert(<span class="hljs-string"><span class="hljs-string">'events'</span></span>, [ [time(), <span class="hljs-string"><span class="hljs-string">'CLICKS'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1234</span></span>, <span class="hljs-string"><span class="hljs-string">'192.168.1.11'</span></span>, <span class="hljs-string"><span class="hljs-string">'Moscow'</span></span>, <span class="hljs-string"><span class="hljs-string">'user_11'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>], [time(), <span class="hljs-string"><span class="hljs-string">'VIEWS'</span></span> , <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1237</span></span>, <span class="hljs-string"><span class="hljs-string">'192.168.1.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'Tobruk'</span></span>, <span class="hljs-string"><span class="hljs-string">'user_32'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://smi2.ru?utm_campaign=CM1'</span></span>], [time(), <span class="hljs-string"><span class="hljs-string">'VIEWS'</span></span> , <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1237</span></span>, <span class="hljs-string"><span class="hljs-string">'192.168.1.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'Gisborne'</span></span>, <span class="hljs-string"><span class="hljs-string">'user_12'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://smi2.ru?utm_campaign=CM1'</span></span>], [time(), <span class="hljs-string"><span class="hljs-string">'VIEWS'</span></span> , <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1237</span></span>, <span class="hljs-string"><span class="hljs-string">'192.168.1.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'Moscow'</span></span>, <span class="hljs-string"><span class="hljs-string">'user_43'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://smi2.ru?utm_campaign=CM3'</span></span>], ], [<span class="hljs-string"><span class="hljs-string">'event_time'</span></span>, <span class="hljs-string"><span class="hljs-string">'event_type'</span></span>, <span class="hljs-string"><span class="hljs-string">'site_id'</span></span>, <span class="hljs-string"><span class="hljs-string">'article_id'</span></span>, <span class="hljs-string"><span class="hljs-string">'ip'</span></span>, <span class="hljs-string"><span class="hljs-string">'city'</span></span>, <span class="hljs-string"><span class="hljs-string">'user_uuid'</span></span>, <span class="hljs-string"><span class="hljs-string">'referer'</span></span>] );</code> </pre> <br><h2 id="chtenie-dannyh">  Reading data </h2><br><p>  Less words - more code! .. Let's give a simple example of how two requests are executed in parallel through a driver: </p><br><pre> <code class="php hljs">$state1 = $db-&gt;selectAsync(<span class="hljs-string"><span class="hljs-string">'SELECT 1 AS ping'</span></span>); $state2 = $db-&gt;selectAsync(<span class="hljs-string"><span class="hljs-string">'SELECT 2 AS ping'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    ClickHouse $db-&gt;executeAsync(); //  print_r($state1-&gt;rows()) print_r($state2-&gt;rows())</span></span></code> </pre> <br><p>  Option without asynchrony: </p><br><pre> <code class="php hljs">$statement = $db-&gt;select(<span class="hljs-string"><span class="hljs-string">''</span></span>SELECT <span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ping<span class="hljs-string"><span class="hljs-string">');</span></span></code> </pre> <br><p>  The result of requests is a <code>Statement</code> object that can do the following: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//       $statement-&gt;count(); //        LIMIT- (rows_before_limit_at_least) $statement-&gt;countAll(); //       $statement-&gt;fetchOne(); //  "" ,    SELECT  WITH TOTALS print_r($statement-&gt;totals()); //       print_r($statement-&gt;rows()); //   ,        ,   curl print_r($statement-&gt;totalTimeRequest()); //    curl_info print_r($statement-&gt;responseInfo()); //     ,  ClickHouse print_r($result-&gt;statistics());</span></span></code> </pre> <br><p>  Let's try to read our data.  Suppose we need to calculate how many unique users viewed articles by day: </p><br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> event_date, uniqCombined(user_uuid) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> count_users <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">events</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> site_id=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> event_date <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> event_date <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre> <br><p>  How many users who viewed articles clicked: </p><br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> user_uuid, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> clicks <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> articles.events <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> event_type <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( <span class="hljs-string"><span class="hljs-string">'CLICKS'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> site_id = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> user_uuid <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> user_uuid <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> articles.events <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> event_type <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( <span class="hljs-string"><span class="hljs-string">'VIEWS'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> site_id = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> user_uuid ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> user_uuid <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre> <br><p>  What UTM tags gave the most views and clicks: </p><br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> utm, countIf(event_type <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span>(<span class="hljs-string"><span class="hljs-string">'VIEWS'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> views, countIf(event_type <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span>(<span class="hljs-string"><span class="hljs-string">'CLICKS'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> clicks <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">events</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> event_date = today() <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> site_id = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> utm <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> views <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span></code> </pre> <br><h2 id="ispolzovanie-vneshnih-dannyh-dlya-obrabotki-zaprosa">  Using external data to process a request </h2><br><p>  Suppose that we need to calculate <em>how many unique users have viewed article X per day</em> , in which several article identifiers are listed in X.  This can be done like this: </p><br><pre> <code class="sql hljs">WHERE article_id IN (1,2,3,4,5,6,7,8,9)</code> </pre> <br><p>  In this example, everything will work fine.  But what if the identifiers are thousands or tens of thousands?  In this case, ClickHouse functionality is useful, which allows you to use <a href="https://clickhouse.yandex/reference_ru.html">external data to process the request</a> . </p><br><p>  Consider this opportunity ClickHouse example.  Create a CSV file <code>'/tmp/articles_list.csv'</code> , in which we list all the necessary <code>article_id</code> for the <code>article_id</code> request, and ask ClickHouse to create a temporary <code>namex</code> table containing one column: </p><br><pre> <code class="php hljs">$whereIn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \ClickHouseDB\WhereInFile(); $whereIn-&gt;attachFile(<span class="hljs-string"><span class="hljs-string">'/tmp/articles_list.csv'</span></span>, <span class="hljs-string"><span class="hljs-string">'namex'</span></span>, [<span class="hljs-string"><span class="hljs-string">'article_id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Int32'</span></span>], \ClickHouseDB\WhereInFile::FORMAT_CSV);</code> </pre> <br><p>  Then the contents of the CSV file can be used on the server: </p><br><pre> <code class="php hljs">$sql = <span class="hljs-string"><span class="hljs-string">" SELECT article_id, countIf(event_type='CLICKS') AS count_clicks, countIf(event_type='VIEWS') AS count_views FROM articles.events WHERE article_id IN (SELECT article_id FROM namex) GROUP BY article_id ORDER BY count_views DESC "</span></span>; $result = $db-&gt;select($sql, [], $whereIn);</code> </pre> <br><p>  See this example on <a href="https://github.com/smi2/phpClickHouse/blob/master/doc/article_01_wherein.php">github</a> . </p><br><p>  Also, the <code>attachFile()</code> function supports TabSeparated and TabSeparatedWithNames formats. </p><br><h1 id="chto-dalshe">  What's next </h1><br><p>  On this, we, perhaps, will complete the first part of our story about ClickHouse. </p><br><p>  You can find out a lot of useful information about ClickHouse in the <a href="https://groups.google.com/forum/">Google group</a> . </p><br><p>  If you have comments or you have found errors, typos - welcome to the world of open-source, we will wait for your pull request for <a href="">this article</a> .  If you like data analysis and you are interested in working with data and ClickHouse - welcome to our team;) </p><br><p>  We plan to do a <strong>series of materials on our experience with ClickHouse</strong> . <br>  The plans - the following topics. </p><br><p>  Part 2: </p><br><ul><li>  Connect to a ClickHouse cluster from PHP </li><li>  Sending requests to the cluster, the implementation of migrations to PHP </li></ul><br><p>  Part 3: </p><br><ul><li>  Using MySQL dictionaries in ClickHouse </li><li>  Table engines: CollapsingMergeTree, SummingMergeTree, MaterializedView </li></ul><br><p>  Part 4: </p><br><ul><li>  Examples of requests in ClickHouse on open data media2 </li><li>  Sampling data in ClickHouse </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/314558/">https://habr.com/ru/post/314558/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314544/index.html">Mars rover Initialization</a></li>
<li><a href="../314550/index.html">Offensive programming: paranoid, offensive, offensive or defenseless programming</a></li>
<li><a href="../314552/index.html">The digest of fresh materials from the world of the frontend for the last week No. 235 (November 1 - 6, 2016)</a></li>
<li><a href="../314554/index.html">Be King of your state with Angular2 State Machine</a></li>
<li><a href="../314556/index.html">Almost half of the developers spend 10-25% of the time to correct errors in the finished product</a></li>
<li><a href="../314560/index.html">Making a project on Node.js using Mongoose, Express, Cluster. Part 2.1</a></li>
<li><a href="../314562/index.html">The book "Web Development. Comprehensive Guide ¬ª</a></li>
<li><a href="../314564/index.html">Simplify or die. What should be the product for the Russian E-commerce?</a></li>
<li><a href="../314566/index.html">7 things about books and life that I learned by reading 100 books a year</a></li>
<li><a href="../314570/index.html">Emoji is just the beginning. And why business communications are no longer effective without smiles.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>