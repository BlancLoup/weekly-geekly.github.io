<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MySQL query optimization using custom variables</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction In the modern world there are a large number of tasks, within which one has to process large arrays of the same type of data. Vivid examp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MySQL query optimization using custom variables</h1><div class="post__text post__text-html js-mediator-article">  <b>Introduction</b>  In the modern world there are a large number of tasks, within which one has to process large arrays of the same type of data.  Vivid examples are systems for analyzing stock quotes, weather conditions, network traffic statistics.  Many of these systems use various relational databases, the tables of which contain such amounts of data that the correct creation and optimization of queries to these tables becomes simply necessary for the normal functioning of the system.  This article describes the solution methods (and comparative temporal characteristics of the methods used) of several tasks for obtaining data from <i>MySQL</i> DBMS tables containing statistics about network traffic passing through the routers of one of the major Russian network providers.  The intensity of the data stream coming from the main router is such that, on average, 400 million to a billion records containing information about <i>TCP / IP</i> transactions enter the database tables of the network traffic monitoring system used (the router in question exports data using the <i>netflow</i> protocol).  <i>MySQL is</i> used as a database management system. <br><a name="habracut"></a><br>  <b>The use of databases.</b>  Inquiries in the theory of relational databases are based on the concept of operations on sets, while in the theory of sets, the concept of time is absent.  In reality, everything is different: DBMS implements abstract concepts based on real equipment.  As a result, the execution of requests requires a lot (sometimes extremely long) time, and it is not always possible to wait for a long time, therefore the problem of finding ways to speed up the applied requests is quite acute - good, these ways exist.  One of the main and most frequently used methods is the indexing of tables, which allows to speed up their viewing.  Another way is to create queries that influence the planning mechanism, allowing the requests of different clients to interact more effectively.  It is also possible to modify the hardware settings to improve performance, bypassing the physical limitations inherent in a particular type of equipment. <br><br>  <b>Work with indexes</b> .  A table with no indexes is a random set of rows, and to find the desired record, let's say by id, you need to check all its rows to match the desired value, for this you need to scan the entire table from beginning to end.  This can take a lot of time and will be extremely inefficient, especially if the table contains only a few records that satisfy the search condition. <br><br>  As an example, consider a table containing organizations under the jurisdiction of the Internet provider under consideration.  In this context, there are two fields in the table - organization id ( <b>org_id</b> ) and organization name ( <b>org_name</b> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Suppose we added an index to the <b>org_id</b> field (see Fig. 1).  The index contains an entry for each row in the table, and the index entries are sorted by <b>org_id</b> .  Now, instead of scanning all the records in the table, we can use the index.  Suppose that it is required to find a line containing an entry about an organization ( <i>Institute of Automation and Electrometry of the Siberian Branch of the Russian Academy of Sciences</i> ) with a unique identifier ( <b>org_id</b> ) equal to 2. Scanning by index returns a single line.  The values ‚Äã‚Äãin the index are sorted in ascending order, so reaching the next value (with <b>org_id</b> equal to <i>3</i> ) you can complete the scan: after <i>3</i> we will not find the desired values.  If the desired values ‚Äã‚Äãare somewhere in the middle of the table, using special algorithms (for example, using the binary search method), you can go to the desired row without a long linear scan of the table. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c0a/f68/8ae/c0af688aef3a18ff240cfb3c5a21c281.png"><br>  Fig.  1. Interaction with a table using an index <br><br>  In general, most queries can be optimized if we correctly create the necessary indexes in the table and construct the query so that they are efficiently used.  However, there are such queries whose execution speeds do not help indexes at all - for example, when more than about 1/10 of all records in a table are selected by index, the optimizer will prefer <i>FTS (Full Table Scan)</i> instead of using an index, since sequential reads from disk it happens faster than reading from different parts of the disk (moving the head over the disk - <i>seek</i> is an ‚Äúexpensive‚Äù operation).  The optimizer can be ‚Äúforced‚Äù to use the index using the <b>FORCE INDEX</b> option, but this usually does not give a gain in speed.  Also, the tables can be so large that creating an index will be impractical in terms of the volume occupied or the duration of the operation.  In addition, for the convenience of using indices one has to ‚Äúpay off‚Äù in a certain way, indices have their drawbacks.  Most of them are insignificant, but you should know about them. <br><br>  <b>Disadvantages of using indexes.</b>  First, indexes speed up data retrieval, but they slow down the operation of adding, deleting, and modifying data in the indexed columns, because every time you change data in such a table, you have to rebuild the index.  The relationship here is simple: the more indexes the table has, the greater the slowing down of operations on records. <br><br>  Secondly, the index file occupies a certain place on the disk (there are cases when the indexes take up more space than the data itself).  When creating a large number of indexes, the size of such an index file can quickly reach its maximum size.  This may cause tables to reach the size limit faster than it would have been without using indexes. <br><ul><li>  For tables such as <a href="http://dev.mysql.com/doc/refman/5.0/en/myisam-storage-engine.html">MyISAM,</a> excessive indexing of tables can result in an index file reaching its maximum size faster than a data file (the problem can be solved with <a href="http://dev.mysql.com/doc/refman/5.1/en/partitioning.html">PARTITIONING</a> ). </li><li>  <a href="http://dev.mysql.com/doc/refman/5.0/en/bdb-storage-engine.html">BDB</a> type tables store data and indexes in a single file.  This, of course, is the reason for the faster reaching the maximum size of a table file. </li><li>  <a href="http://dev.mysql.com/doc/refman/5.0/en/innodb-storage-engine.html">InnoDB</a> type tables are located in a single tablespace.  When adding indexes, the disk space allocated for the table space will be exhausted faster. </li></ul>  <b>User variables.</b>  MySQL supports <a href="http://dev.mysql.com/doc/refman/5.0/en/user-variables.html">user variables</a> (hereinafter referred to as <b>PP</b> ) starting with version 3.23.6.  Variables can be assigned values ‚Äã‚Äãand accessed later ‚Äî this can also be used when there is a need to save the results of calculations for use in further queries. <br>  For example, in order to find products with a minimum price, you can perform the following actions: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @min_price:=<span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(price) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> shop; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> shop <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> price=@min_price;</code> </pre>  User variables are written as <b>@var_name</b> , and can take integer ( <b>int</b> ), fractional ( <b>real</b> ) and string ( <b>string</b> ) type values.  Assignment of a variable to a value is done through the SET operator ( <code>SET @var1='RUS'</code> ), through the <i>SELECT statement</i> ( <code>SELECT 'RUS' INTO @var1;</code> ) or during the execution of the query through the operator ‚Äú: =‚Äù (‚Äú=‚Äù is treated as equality) ( <b>@ var1: = 72</b> ). <br><img src="https://habrastorage.org/getpro/habr/post_images/b71/5ca/e8d/b715cae8dcd166f46a8bd0102720d784.png"><br>  An uninitialized variable is <b>NULL</b> . <br><br><blockquote>  It is necessary to initialize the variables before executing the query, because otherwise the type of variables will be determined during the execution of the query itself, and it may be detected incorrectly, as a result, an incorrect result will be obtained.  <a href="http://sqlinfo.ru/forum/viewtopic.php%3Fid%3D4235">Example</a> , <a href="http://bugs.mysql.com/bug.php%3Fid%3D61408">discussion</a> . <br></blockquote><br>  <b>The benefits of using PP</b> .  The ability to save intermediate results in variables and operate them in the course of further query execution allows you to significantly speed up the execution of some queries (due to a smaller number of table scans), and also allows you to perform such queries that are implemented in the standard relational model is very difficult or not at all. <br><br>  <b>Disadvantages of using PP.</b> <br><ul><li>  Difficult portability to other DBMSs (the PP mechanism serves as a specific add-on over the relational model of databases within MySQL).  However, this drawback is not very critical, since at the moment all large DBMS have their own deviations from the ANSI SQL standard. </li><li>  The behavior of user variables will depend on the order of execution of a complex query, which may be changed by the MySQL optimizer (unless the <b>STRAIGHT_JOIN</b> operator is used). </li></ul><br>  <b>Example number 1.</b>  One of the important tasks in monitoring network traffic is fixing the peaks of downloads provided by communication channels from Internet providers (see Fig. 2). <br><img src="https://habrastorage.org/getpro/habr/post_images/a87/db7/a00/a87db7a00a8611badcd8030260c41ab0.png"><br>  Fig.  2. Graph showing the channel loading dynamics <br><br>  The monitoring system stores information about the incoming and outgoing traffic in its entirety, and in particular, for each of the channels in separate tables.  Table type is <i>MyISAM</i> . <br>  The simplified form of the table of this type: <table><tbody><tr><td>  <b>t</b> (timestamp) </td><td>  <b>src</b> (number of bytes given) </td><td>  <b>dst</b> (number of bytes received) </td></tr></tbody></table>  To search for the maximum incoming (as well as outgoing, but in this case, work with the <b>src</b> field) traffic, you need to scan the entire table, while comparing the <b>dst</b> field values ‚Äã‚Äãcorresponding to the t <sub>prev</sub> (timestamp in the previous step) and t <sub>curr</sub> (temporary label in the current step).  This is the main difficulty: in the framework of the relational model, it is impossible to remember the previous value in the process of scanning the table and use it directly.  It can be calculated using the subquery <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dst <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t t2 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t2.t&lt;t1.t <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t2.t <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre>  where <b>t1.t</b> is the current value of the timestamp), but this design greatly complicates the query, in general, the complexity of the query from <a href="http://en.wikipedia.org/wiki/Big_O_notation">O (n)</a> increases to O (n <sup>2</sup> ) (due to the fact that for each timestamp it is necessary to calculate the previous one by scan the entire table), which greatly affects the speed of the query.  If there is a unique index in the table on the <b>t</b> field, the calculation will be carried out much faster, but this is when it is known that there are no missing timestamps in the table (and this ideal situation is almost never encountered), and the previous timestamp is calculated simply by subtracting the desired interval from the current (at a unique index sample is very fast).  In the general case, the timestamp value in the previous step has to be calculated by a subquery, based not on strict equality, but on a nonstrict one, using sorting, and such a query, of course, works much longer.  In the relational variant, in the subquery for faster data retrieval, an index is required on the <b>t</b> field, and an external query is used to work with the <b>dst</b> field; therefore, in this case, the composite index <b>t_dst</b> to the fields ( <b>t</b> , <b>dst</b> ) is created in the table. <br><br>  Query option within the framework of the relational database model: <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(t1.dst-(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dst <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t t2 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t2.t&lt;t1.t <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t2.t <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> t t1;</code> </pre> <br>  As can be seen from the query, you have to come in the table n + 1 times.  custom variables allow you to implement such a query in one pass through the table.  In order for a query that performs one pass through the table to work correctly, it is necessary that the data be selected in ascending order of the timestamp. <br>  This can be achieved in the following ways. <br><ul><li>  Sort the data in the table (if required) by an <code>ALTER TABLE `t` ORDER BY `t`</code> (for <i>MyISAM</i> tables, a working solution) before the query is executed.  If the data was inserted sequentially, but several records were deleted from the table, you need to defragment the table with the <code>OPTIMIZE TABLE `t`</code> .  Since the data is sorted in advance, the query uses the <code>IGNORE INDEX(t_dst)</code> instruction so that the data is selected not by index, but sequentially. </li><li>  The presence of a composite index for selectable (used in <b>WHERE / ORDER BY / GROUP BY</b> ) fields allows you to select by it (by index) data ‚Äî that is, in ascending order of the selected field.  In this case, the presence of a composite index <b>t_dst</b> on the fields ( <b>t</b> , <b>dst</b> ) provides a sample of data in ascending order of the label <b>t</b> .  In order for the optimizer to use the index in the sample, you need to use the <code>FORCE INDEX(t_dst)</code> . </li><li>  Select data not from table t, but from a dynamic sample created from it, sorted by field t in ascending order ( <code>SELECT * FROM `t` ORDER BY `t`</code> ). </li></ul><br>  The ability to select data in one pass is based on the fact that it is possible to memorize the value of the dst column on the previous row of the table into a user variable and compare it with the value of dst on the current row of the table. <br><br>  A query that works with a table where the data is arranged in the right order. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @next_data=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @max_value=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @next_data:=<span class="hljs-string"><span class="hljs-string">`dst`</span></span> <span class="hljs-string"><span class="hljs-string">`nextdata`</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (@next_data- @<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>&gt;@max_value, @max_value:=@next_data-@<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, @max_value), @<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>:=dst <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IGNORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span>(t_dst); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @max_value;</code> </pre> <br>  A query that selects data in the desired order by index: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @next_data=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @max_value=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @next_data:=<span class="hljs-string"><span class="hljs-string">`dst`</span></span> <span class="hljs-string"><span class="hljs-string">`nextdata`</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (@next_data- @<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>&gt;@max_value, @max_value:=@next_data-@<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, @max_value), @<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>:=dst <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FORCE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span>(t_dst); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @max_value;</code> </pre> <br>  A query that sorts the data during the selection process: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @next_data=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @max_value=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @next_data:=<span class="hljs-string"><span class="hljs-string">`dst`</span></span> <span class="hljs-string"><span class="hljs-string">`nextdata`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (@next_data - @<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> &gt; @max_value, @max_value:=@next_data-@<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, @max_value), @<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>:=dst <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t) t1; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @max_value;</code> </pre> <br>  Table 1 shows the duration of the query (with a different number of rows in the table).  The number of rows in the table is determined by the duration of the interval.  In this case, one minute intervals are considered. <br><table><tbody><tr><td>  Period </td><td>  Number of lines </td><td>  Relational query option </td><td>  Request from PP (sequential selection) </td><td>  Request with PP (sorting in progress) </td><td>  Request from PP (sorting is carried out by sampling by index) </td></tr><tr><td>  1 day </td><td>  1,440 </td><td>  2.67 seconds </td><td>  0.00 sec </td><td>  0.00 sec </td><td>  0.00 sec </td></tr><tr><td>  Week 1 </td><td>  10,080 </td><td>  2 min 11 sec </td><td>  0.00 sec </td><td>  0.01 sec </td><td>  0.02 sec </td></tr><tr><td>  1 month </td><td>  43,200 </td><td>  40 min 1 sec </td><td>  0.02 sec </td><td>  0.04 seconds </td><td>  0.07 seconds </td></tr><tr><td>  1 year </td><td>  525,600 </td><td>  More than three days </td><td>  0.54 seconds </td><td>  0.68 sec </td><td>  0.94 seconds </td></tr></tbody></table>  Table 1. Measurements of the duration of the execution of requests from example No. 1. <br><br>  The results of measuring the duration of the execution of queries confirm that the relational variant of the query is absolutely inapplicable in this case, and all variants of queries with user variables are executed faster than in a second, which is acceptable in most cases. <br><br>  <b>Example number 2.</b>  To analyze the channel load, you regularly have to evaluate the load for certain time intervals (several seconds, several minutes).  In this case, the selected interval with a duration of 5 seconds.  The structure of the table from which data is selected is the same as in example No. 1, the time stamp <b>t</b> must be of type <b>TIMESTAMP</b> . <br><br>  By a relational query, such a sample is implemented through grouping and then sorting the results: <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">INTERVAL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">UNIX_TIMESTAMP</span></span>(<span class="hljs-string"><span class="hljs-string">`t`</span></span>)%<span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> s5,<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-string"><span class="hljs-string">`dst`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`d`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> s5 <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">`t</span></span></code> </pre> <br>  In addition to a full pass through the table, this query also implements grouping and sorting the result. <br>  The same query can be implemented through user variables with a smaller load due to the absence of explicit grouping, and, therefore, sorting (provided that there are no missing timestamps in the table). <br><br>  A query that works with a table, where the data is arranged in the correct order: <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @c:=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span>, <span class="hljs-string"><span class="hljs-string">`dst`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">UNIX_TIMESTAMP</span></span>(<span class="hljs-string"><span class="hljs-string">`t`</span></span>) % <span class="hljs-number"><span class="hljs-number">5</span></span>, @c := @c+<span class="hljs-string"><span class="hljs-string">`dst`</span></span>, @c := <span class="hljs-string"><span class="hljs-string">`dst`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`dst`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">UNIX_TIMESTAMP</span></span>(<span class="hljs-string"><span class="hljs-string">`t`</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>) % <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`mark`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IGNORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span>(<span class="hljs-string"><span class="hljs-string">`t_dst`</span></span>)) t1 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> mark = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre> <br>  A query that selects data in the desired order by index: <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @c:=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span>, <span class="hljs-string"><span class="hljs-string">`dst`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">UNIX_TIMESTAMP</span></span>(<span class="hljs-string"><span class="hljs-string">`t`</span></span>) % <span class="hljs-number"><span class="hljs-number">5</span></span>, @c := @c+<span class="hljs-string"><span class="hljs-string">`dst`</span></span>, @c := <span class="hljs-string"><span class="hljs-string">`dst`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`dst`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">UNIX_TIMESTAMP</span></span>(<span class="hljs-string"><span class="hljs-string">`t`</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>) % <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`mark`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FORCE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span>(<span class="hljs-string"><span class="hljs-string">`t_dst`</span></span>)) t1 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> mark = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre> <br>  A query that sorts the data during the selection process: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @c:=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span>, <span class="hljs-string"><span class="hljs-string">`dst`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">UNIX_TIMESTAMP</span></span>(<span class="hljs-string"><span class="hljs-string">`t`</span></span>) % <span class="hljs-number"><span class="hljs-number">5</span></span>, @c := @c+<span class="hljs-string"><span class="hljs-string">`dst`</span></span>, @c := <span class="hljs-string"><span class="hljs-string">`dst`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`dst`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">UNIX_TIMESTAMP</span></span>(<span class="hljs-string"><span class="hljs-string">`t`</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>) % <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">`mark`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span>) t1) t2 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> mark = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre>  As part of the subquery execution, the summing into the <b>@c</b> variable <b>occurs first</b> , and if the timestamp corresponds to a five-second interval, the counter is reset and the <b>mark is</b> assigned the value 1. Next, the external query selects those rows whose <b>mark</b> is 1, that is, the required ones. <br>  Table 2 shows the duration of the query (with a different number of rows in the table). <br><table><tbody><tr><td>  Period </td><td>  Number of lines </td><td>  Relational query option </td><td>  Request from PP (sequential selection) </td><td>  Request with PP (sorting in progress) </td><td>  Request from PP (sorting is carried out by sampling by index) </td></tr><tr><td>  1 day </td><td>  86,400 </td><td>  0.11 sec </td><td>  0.05 sec </td><td>  0.1 sec </td><td>  0.08 seconds </td></tr><tr><td>  Week 1 </td><td>  604,800 </td><td>  0.86 sec </td><td>  0.33 sec </td><td>  0.73 sec </td><td>  0.6 sec </td></tr><tr><td>  1 month </td><td>  2,592,000 </td><td>  33.72 seconds </td><td>  1.65 sec </td><td>  3.62 sec </td><td>  2.83 seconds </td></tr><tr><td>  1 season <br>  (3 months) </td><td>  7,776,000 </td><td>  2 min 45 sec </td><td>  4.87 seconds </td><td>  10.46 seconds </td><td>  8.36 seconds </td></tr></tbody></table>  Table 2. Measurements of the duration of the execution of requests from example No. 2 <br><br>  As in the first example, the given variants of queries using custom MySQL variables work several times faster. <br><br>  <b>Example number 3</b> .  From the point of view of the work of the network, the subordinate organizations are described by certain technical characteristics, in particular, by ranges of IP addresses allocated for the organization.  Sometimes there is a need to isolate the largest continuous blocks of IP-addresses allocated for the organization. <br>  The table of organizations and their network ranges (nets) is represented as follows: <br><table><tbody><tr><td>  <b>org_id</b> <br>  (organization id) </td><td>  <b>org_name</b> <br>  (Name of the organization) </td><td>  <b>net</b> <br>  (network address, 4 bytes) </td><td>  <b>net</b> <br>  (network mask, 4 bytes) </td></tr></tbody></table><br>  If you need to choose the largest continuous network range for each organization, there is no particular difficulty.  But if you need to select the two largest network ranges ‚Äî the relational query query option becomes quite complicated ‚Äî you need to count the number of larger network ranges for each range, then weed out those that are smaller than the first two (see <a href="http://sqlinfo.ru/forum/viewtopic.php%3Fid%3D1742">here</a> for more details). <br><br>  Option query in the relational model: <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t1.org_id, t1.org_name, (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`nets`</span></span> t2 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t2.org_id = t1.org_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ((t2.mask&lt;&lt;<span class="hljs-number"><span class="hljs-number">32</span></span>)+t2.net) &lt; ((t1.mask&lt;&lt;<span class="hljs-number"><span class="hljs-number">32</span></span>)+t1.net) ) c, <span class="hljs-keyword"><span class="hljs-keyword">inet_ntoa</span></span>(t1.net), <span class="hljs-keyword"><span class="hljs-keyword">inet_ntoa</span></span>(t1.mask) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> nets t1 <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> c&lt;<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> org_id, <span class="hljs-keyword"><span class="hljs-keyword">mask</span></span>;</code> </pre>  With the help of user variables, it is possible within one pass to count the number of derived network ranges and reset the counter when the organization changes.  If the counter reaches the desired value (in this case, 2), the records are not displayed.  The table itself before use must be sorted by the size of the network ranges within the organization. <br><br>  Query option with MySQL user variables: <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @i=<span class="hljs-number"><span class="hljs-number">0</span></span>, @p=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.org_id, t.org_name, <span class="hljs-keyword"><span class="hljs-keyword">inet_ntoa</span></span>(t.net), <span class="hljs-keyword"><span class="hljs-keyword">inet_ntoa</span></span>(t.mask) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`nets`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">`org_id`</span></span>, <span class="hljs-string"><span class="hljs-string">`mask`</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ( (<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@p=org_id, @i:=@i+<span class="hljs-number"><span class="hljs-number">1</span></span>,(@i:=<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (@p:=org_id))) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> @i&lt;<span class="hljs-number"><span class="hljs-number">2</span></span>);</code> </pre>  The high efficiency of the query with the PP results from the fact that in the relational variant of the query there is a subquery that processes each record in the table. <br><br>  <b>Example number 4.</b>  In previous experiments, the option of modifying the structure of a table has never been considered (in real life it is far from always possible or convenient to change it).  However, when working with temporal tables, it is simply a decision to make another column, which will contain the previous <b>prev</b> value of the parameter being measured.  For the highest speed of searching for the maximum difference value, you can add a field that will contain the <b>diff</b> difference between the current value of the measurement <b>d</b> and the previous one. <br><br>  Consider the option of changing the table structure - adding the <b>prev</b> column.  The original data table is: <br><table><tbody><tr><td>  <b>t</b> (timestamp) </td><td>  <b>d</b> (measurement data) </td></tr></tbody></table>  The table does not contain indexes and a primary key ‚Äî if there is an index on the <b>t</b> field or a composite index on the ( <b>t, d</b> ) fields <b>, the</b> relational query option is <a href="http://sqlinfo.ru/forum/viewtopic.php%3Fid%3D4973">much slower</a> . <br><br>  Option modification in the framework of the relational model of the database: <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`t_modifyed`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t, (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">`d`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span> <span class="hljs-string"><span class="hljs-string">`in`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">`in`</span></span>.t &lt; <span class="hljs-string"><span class="hljs-string">`out`</span></span>.<span class="hljs-string"><span class="hljs-string">`t`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ) prev, d <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span> <span class="hljs-string"><span class="hljs-string">`out`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span>;</code> </pre>  Modification option using custom variables: <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @v = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`t_moifyed`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t, @v prev, @v:=dd <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">`t`</span></span>;</code> </pre>  Table 3 shows the duration of the query (with a different number of rows in the table). <br><table><tbody><tr><td>  Period </td><td>  Number of lines </td><td>  Relational query option </td><td>  Request from PP (sequential selection) </td><td>  Request with PP (sorting in progress) </td></tr><tr><td>  1 day </td><td>  1,440 </td><td>  0.35 sec </td><td>  0.00 sec </td><td>  0.00 sec </td></tr><tr><td>  Week 1 </td><td>  10,800 </td><td>  12.33 seconds </td><td>  0.00 sec </td><td>  0.01 sec </td></tr><tr><td>  1 month </td><td>  43,200 </td><td>  3 min 45 sec </td><td>  0.10 sec </td><td>  0.15 sec </td></tr><tr><td>  1 year </td><td>  525,600 </td><td>  more than 5 hours </td><td>  0.54 seconds </td><td>  0.96 seconds </td></tr></tbody></table>  Table 3. Measurements of the duration of the execution of requests from example No. 4. <br>  <b>Other uses.</b>  Many relational DBMSs allow you to use the number of the current output line during the execution of a query. <br><ul><li>  Oracle (variable: rownum) </li><li>  Microsoft SQL (ROW_NUMBER () function) </li><li>  PostgreSQL (ROW_NUMBER () function) </li></ul>  In MySQL, rownum can be correctly emulated only with user variables: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @n:=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @n:=@n+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rownum</span></span>, t.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> t;</code> </pre> <br>  Strictly speaking, there is no need to use rownum in MySQL: there is a LIMIT instruction to limit the number of returned rows by the query, but sometimes it may be necessary. <br><br>  <b>Conclusion.</b>  Using custom variables in a particular type of query allows you to achieve greater speed when executing queries than in their relational counterparts.  This may occur if: <br><ul><li>  the query is such that it cannot efficiently use indexes (the number of selected values ‚Äã‚Äãby index is too large and the optimizer does <i>FTS</i> ); </li><li>  during the execution of the query, the values ‚Äã‚Äãcalculated in the previous steps and entered into user variables are used. </li></ul>  <b>Similar opportunity in other relational DBMS.</b>  A mechanism similar to the mechanism of user variables is found in almost all modern relational DBMSs.  This section provides examples for PostgreSQL and Microsoft SQL.  In the case of using the functions listed below, it is necessary to take into account that when creating them, no action was taken so that the rows were selected from the table in the required order (ascending <b>t</b> ). <br><br>  <a href="http://www.postgresql.org/"><b>PostgreSQL</b></a> : <a href="http://www.postgresql.org/"><b>PostgreSQL</b></a> DBMS does not support the ability to use custom variables in the query execution process.  But starting from version 9.0 in PostgreSQL it is possible to create anonymous blocks of code.  Unfortunately, they do not support formal parameters and do not return values.  However, it is possible to create a function in the <a href="http://www.postgresql.org/docs/8.3/interactive/sql-createfunction.html">pg_temp schema</a> , which will automatically remove the function from the schema upon completion of the session.  An example of a function that calculates the maximum differential: <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> pg_temp.max_drop(); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> pg_temp.max_drop() <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> prev <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>; curr INTEGER; max_ INTEGER; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> max_ := <span class="hljs-number"><span class="hljs-number">0</span></span>; prev := 0; FOR curr IN <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> d <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pogoda <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (curr - prev &gt; max_) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> max_ := curr - prev; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; prev := curr; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; RETURN max_; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">lANGUAGE</span></span> plpgsql;</code> </pre>  <a href="http://www.microsoft.com/sqlserver/ru/ru/default.aspx"><b>Microsoft SQL</b></a> : The main difference between a query and a query using the MySQL PP is that the variable must be set in advance. <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @diff <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @prev <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @diff = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @prev = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @diff = <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> @diff&gt; (d-@prev) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @diff <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> (d-@prev) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, @prev = d <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> npogoda; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @diff;</code> </pre>  <a href="http://oracle.com/"><b>Oracle</b></a> : at the time of this writing in Oracle SQL, there is no possibility to use user variables ‚Äî such an option is available only in PL / SQL and extensions such as SQLPLUS, Oracle XE, and.  etc. <br><br>  <b>Thanks</b>  The author is grateful for the invaluable help in the process of writing the following people: <br><ul><li>  <a href="http://habrahabr.ru/users/rgbeast/">Grigory Rubtsov [rgbeast]</a> </li><li>  <a href="http://habrahabr.ru/users/retvizan/">[retvizan]</a> </li><li>  <a href="http://webew.ru/users/49.webew">Pavel Pushkarev [paulus]</a> </li><li>  <a href="http://habrahabr.ru/users/1234ru/">[1234ru]</a> </li></ul><br></div><p>Source: <a href="https://habr.com/ru/post/133781/">https://habr.com/ru/post/133781/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133775/index.html">Release IDE Arduino 1.0!</a></li>
<li><a href="../133776/index.html">Extensions for Google Chrome. Part one. Getting started</a></li>
<li><a href="../133777/index.html">Live Nyancat in your terminal</a></li>
<li><a href="../133778/index.html">Performance Comparison JSON-serializer for .NET</a></li>
<li><a href="../133780/index.html">We write a primitive and useless compiler</a></li>
<li><a href="../133782/index.html">Google translate + Asterisk IVR</a></li>
<li><a href="../133783/index.html">What operating systems and distributions do you use on the servers?</a></li>
<li><a href="../133784/index.html">Getting Realization Experience. Part 1 of 2</a></li>
<li><a href="../133787/index.html">Creating a highly sensitive directional antenna with phased arrays or why specialists go abroad</a></li>
<li><a href="../133789/index.html">Google+ will soon provide a ‚Äúmultiadmin‚Äù feature for brand pages</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>