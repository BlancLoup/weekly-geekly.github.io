<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write for UEFI BIOS in Visual Studio. Part 2 - we create our first driver and speed debugging</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 This article will cover basic things about text I / O programming. In the program, which we will create this time ourselves from scratc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write for UEFI BIOS in Visual Studio. Part 2 - we create our first driver and speed debugging</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  This article will cover basic things about text I / O programming.  In the program, which we will create this time ourselves from scratch, we first enter from the keyboard, and then we will display a text line, touching along the path of some unobvious programming features under UEFI. <br><br>  The second half of the article will be about speeding up the driver load when starting up for debugging, since two minutes that are spent on it now, if you launch it several times during the debugging process, your driver will be very annoying. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/c72/0bb/1e1/c720bb1e1650461bb5dd97f0a2a5320d.png"></div><br>  Those who are interested - welcome under cat. <br><a name="habracut"></a><br><h3>  Training </h3><br>  Immediately make your catalog for our exercises in the root of <b>edk2</b> and call it <b>EducationPkg</b> .  All projects will be created inside it.  You can create every single project at the root of <b>edk2</b> , there are no obstacles for this, but approximately on the tenth project, the zoo from its projects and packages of the <b>edk2</b> framework will divorce at the root, which will lead, at best, to confusion.  So, create the directory <b>C: \ FW \ edk2 \ EducationPkg</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Using the UEFI Driver Wizard </h3><br>  Creating a set of files for the <b>edk2</b> project is a big topic that deserves a separate article.  You can read about it if you want to know the truth right now, in the <b>EDK II Module Writer's Guide</b> , Chapter 3 <b>Module Development</b> - <a href="https://github.com/tianocore-docs/Docs/raw/master/User_Docs/EDK_II%2520Module%2520Writer_s%2520Guide_0_7.pdf">here</a> or google.  For the time being, we will use the Intel utility <b>UEFI Driver Wizard</b> , which lies in the downloaded directory in <b>C: \ FW \ UEFIDriverWizard, to create the fileset.</b> <br><br>  We start the <b>UEFI Driver Wizard</b> , and the first thing to do is to specify the <b>Workspace</b> <b>C: \ FW \ edk2</b> working environment using the <b>File ‚Üí OPEN WORKSPACE command</b> .  If this is not done first, then the <b>UEFI Driver Wizard</b> will carefully guide us through all the stages of creation, and then, with apologies, will say that the project driver can not create. <br><br>  After specifying the Workspace, select <b>File ‚Üí New UEFI Driver</b> and perform the following actions: <br><br>  1. Click on the <b>Browse</b> button, go to the directory <b>C: \ FW \ edk2 \ EducationPkg</b> and create inside it your directory <b>MyFirstDriver</b> , in which we will work further.  The driver name will take the same name. <br><br>  2. Set <b>Driver Revision</b> to 1.0.  I do not advise to put less than one - in the <b>Wizard there is an</b> error, as a result of which a revision results in 0.0 after creating project files. <br><br>  3. Everything else is left unchanged, so that it turns out, as shown in the screenshot <br><br><img src="https://habrastorage.org/web/efb/696/607/efb69660768a4c75b5a5727846be3ce3.png"><br><br>  Click the Next button and go to the next screen: <br><br>  We tick the <b>Component Name Protocol</b> and <b>Component Name 2 Protocol</b> , do not touch the rest: <br><br><img src="https://habrastorage.org/web/939/c57/03a/939c5703a70241cc9ae3f92514bfa632.png"><br><br>  and then immediately click Finish, without touching the other settings.  We receive a message about the successful creation of the project: <br><br><img src="https://habrastorage.org/web/fec/6ab/f04/fec6abf04ce6458c8a23fa4d4ad49724.png"><br>  Click <b>OK</b> and close the <b>UEFI Driver Wizard</b> , we will not need it anymore. <br><br><h3>  Adding a module to the list for compilation </h3><br>  Since there is nothing ideal in the world, we will have to manually add a line for our driver to the list of modules for compilation.  Here we must stop and give a little help. <br><br>  All modules in <b>edk2</b> are included in the so-called.  <b>Packages</b> are groups of modules that are interconnected according to some common feature.  To include a new module in any <b>package</b> , we need to add the path to the source code of the module to the <b>PackageName.dsc</b> file ( <b>dsc</b> - short for Description), and this module will be compiled as part of the <b>Package</b> .  <b>UEFI Wizard Driver</b> our driver for compilation can not be added automatically, alas, for objective reasons (how could he know what you created for your new <b>package</b> (or which of the existing ones you intend to work with?). Therefore, we prescribe with pens. <br><br>  Please understand that our <b>EducationPkg</b> is not yet a <b>package</b> , but just a collection of projects, and no more. <br><br>  Open the file <b>C: \ FW \ edk2 \ Nt32Pkg \ Nt32Pkg.dsc</b> , look for a line in it <br><br> <code># Add new modules here</code> <br> <br>  and after this line we set the path to the file <b>MyFirstDriver.inf of</b> our driver relative to <b>C: \ FW \ edk2</b> .  It should turn out like this: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment"># Add new modules here EducationPkg/MyFirstDriver/MyFirstDriver.inf ##############################################################################</span></span></code> </pre> <br><h3>  Very important lyrical digression </h3><br>  Now you sadly think that you have to re-configure the project in <b>Visual Studio</b> , and it is in vain.  Remember, in the first article we did not indicate anywhere which project we are talking about.  Therefore, you do not need to edit anything, compilation after adding our inf-file to <b>Nt32Pkg</b> will go like this.  This leads us to a very important consequence: we can add to an existing <b>Visual Studio</b> project, for example, <b>NT32</b> , files of any project from the huge <b>edk2</b> tree and all of them will be available for editing and, most importantly, setting control points, Watch and all others. features that <b>Visual Studio</b> offers.  Actually, this is one of the most interesting advantages of this approach to working at <b>UEFI</b> using <b>Visual Studio</b> .  And when you click on <b>F5,</b> before the compilation starts, the autosave of the modified sources added to the project will be performed.  True, we pay for this approach with an increased compilation time, but we will further investigate this problem. <br><br>  Let's do what we just talked about for our project.  Right <b>click</b> on the <b>NT32</b> project in <b>Visual Studio</b> ( <b>remember to</b> switch it to the default project in <b>Solution</b> ), select <b>Add ‚Üí Existing Item</b> , go to our directory <br><br> <code>C:\FW\edk2\EducationPkg\MyFirstDriver</code> <br> <br>  select all files with the mouse and click on <b>Add</b> , adding them to our <b>NT32</b> project. <br><br><h3>  Compiling and running the driver </h3><br>  Click on <b>F5</b> or the <b>Debugging</b> button in <b>Visual Studio</b> , wait for the <b>Shell</b> to load, enter in it: <br><br> <code>fs0: <br> load MyFirstDriver.efi</code> <br> <br>  And then we look at the message about the successful loading of our driver.  It does nothing, which is not at all surprising - we haven‚Äôt added any functionality to it yet.  We just need to check that we correctly added our driver to <b>edk2</b> , and nothing more. <br>  Here is what we need to see (the address can be any): <br><br><img src="https://habrastorage.org/web/523/350/759/5233507591b447cebd52dd7968089045.png"><br>  To close the window, click the <b>Stop Debugging</b> buttons, or <b>Shift + F5</b> in <b>Visual Studio</b> . <br><br><h3>  Add your code </h3><br>  Open the file <b>MyFirstDriver.c</b> from the resulting project tree in <b>Visual Studio</b> and add our code to it.  But first, a little theory, before moving on to practice. <br><br>  In the <b>UEFI BIOS,</b> all interaction with the hardware, in our case, by emulating it on a virtual machine, occurs through <b>protocols</b> , you cannot take and write a certain byte to a specific port directly.  In a very simplified form, you can consider the protocol as the name of a ‚Äúclass‚Äù, an instance of which is created to work with the device when it is registered in the system.  Like a regular class instance, the protocol contains data and functions, and all the work with the equipment is ensured by calling the appropriate private functions of the class. <br><br>  When working in <b>UEFI</b> , <b>tables</b> are used that contain pointers to all instances of the ‚Äúclasses‚Äù.  There are several of these tables; in the case of our driver, we use the <b>System Table</b> , using the already declared <b>gST</b> pointer.  The hierarchy of these tables is quite simple: there is a main <b>System Table</b> , which contains (among other things) references to <b>Boot Services</b> and <b>Runtime Services</b> .  However, it will probably be easier to show the code: <br><br><pre> <code class="cpp hljs">gST = *SystemTable; gBS = gST-&gt;BootServices; gRT = gST-&gt;RuntimeServices;</code> </pre> <br>  By variable name: <b>gST</b> stands for: <br>  <b>g</b> - means that the variable is global <br>  <b>ST</b> , you guessed it, means <b>System Table</b> <br><br>  So, our task is to send the string <b>I have written my first UEFI driver</b> to the output device (in our case, the display).  It would be nice, of course, to use the same <b>printf</b> in unix-style and just specify different streams, but alas - there are very serious limitations with the use of <b>printf</b> in <b>UEFI</b> , so for now let's keep it aside, until better times. <br><br>  Insert the output of our line into the function <b>EntryPoint () of</b> our driver.  Add in the variable declaration area our variable of type <b>CHAR16</b> (two-byte character encoding <b>UCS-2 is used</b> ) in the function <b>MyFirstDriverDriverEntryPoint ()</b> in <b>MyFirstDriver.c</b> : <br><br><pre> <code class="cpp hljs">CHAR16 *MyString = <span class="hljs-string"><span class="hljs-string">L"I have written my first UEFI driver\r\n"</span></span>;</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Lyrical digression</b> <div class="spoiler_text">  edk2 does not forgive <b>Warning</b> -s, for it is all the same - that <b>Warning</b> , that <b>Error</b> - it sends to, hmm, the fix in both cases, so the compiler options in <b>edk2 are</b> configured by default.  He thus implicitly says "Pioneer has no place here."  Of course, you can disable this option in configs, but you shouldn‚Äôt explain how to do this ‚Äî if you can disable it, you can remove the sources of Warning messages in the code too, and you don‚Äôt need it.  Therefore, type the types explicitly and comment on unused variables.  Sometimes, in the case of using third-party sources, the complete suppression of errors can be quite a difficult task. <br></div></div><br>  After, at the very end of the <b>MyFirstDriverDriverEntryPoint ()</b> function, insert the output code of our text variable to the output console (default screen, in our case): <br><br><pre> <code class="cpp hljs">gST-&gt;ConOut-&gt;OutputString(gST-&gt;ConOut, MyString);</code> </pre> <br>  Click on F5, enter fs0: load MyFirstDriver.efi, and get our line on the screen: <br><br><img src="https://habrastorage.org/web/b80/108/438/b801084380a946cda9d2e9387c49a1b0.png"><br><br>  The first program from scratch is written and works.  We can congratulate yourself. <br><br>  Let us now analyze our line: <br><br><pre> <code class="cpp hljs">gST-&gt;ConOut-&gt;OutputString(gST-&gt;ConOut, MyString);</code> </pre> <br>  In it: <br>  <b>gST</b> - pointer to the <b>System Table</b> <br>  <b>ConOut</b> - <b>protocol</b> , or, as we conditionally called it, the "class" of text output <br>  <b>OutputString</b> is the output function itself.  The first parameter in it, as it is easy to guess, is <b>this</b> for our protocol <b>EFI_SIMPLE_TEXT_OUTPUT_PROTOCOL</b> . <br><br>  Let's reformulate the above in a different form, for better understanding.  Here is the hierarchy of the main <b>System Table</b> , obtained in the <b>Watch</b> window when you stop at a breakpoint in <b>Visual Studio</b> .  The <b>OutputString</b> function we used is <b>highlighted</b> .  Notice also the <b>BootServices</b> and <b>RuntimeServices elements</b> at the bottom of the table, which were discussed earlier: <br><br><img src="https://habrastorage.org/web/2b5/4e3/2fc/2b54e32fcb644ecaa621ff1e905db67f.png"><br><br><h3>  Entering text from the keyboard and displaying it on the screen </h3><br>  Well, we derived the text contained in the string constant.  Now you need to enter something into a string variable and then display this variable on the screen to make sure that you have never made a mistake in the process. <br><br>  Let's take another screenshot of the same <b>gST</b> , but already in the <b>ConIn</b> part.  It looks like this: <br><br><img src="https://habrastorage.org/web/a56/22b/32a/a5622b32a58b47c5958602a8b0236658.png"><br>  In our next example, we will memorize the password entered from the keyboard, displaying the characters entered using multi-colored asterisks in the New Year (or drug addict, as one friend noted) style, and after pressing <b>Enter</b> , display the password in the next line.  This is just a training example, replacing the entered password with asterisks is already implemented in the <b>HII API</b> , as well as re-entering the password, and checking the re-match. <br><br><div class="spoiler">  <b class="spoiler_title">Disclaimer</b> <div class="spoiler_text">  According to Feng Shui, it would be necessary to make a ‚Äúsimplifying‚Äù pointer <b>* ConOut = gST-&gt; ConOut</b> , but for the purpose of learning, let us leave it as it is, so as not to recall which table we are currently accessing. <br></div></div><br>  First we add local variables in the <b>MyFirstDriverDriverEntryPoint ()</b> function instead of our previously added variable MyString. <br><br><pre> <code class="cpp hljs"> UINTN EventIndex; UINTN Index = <span class="hljs-number"><span class="hljs-number">0</span></span>; EFI_INPUT_KEY Keys; CHAR16 PasswordString[<span class="hljs-number"><span class="hljs-number">256</span></span>];</code> </pre><br>  Now enter the text of the program, replacing the previously added function <br><br><pre> <code class="cpp hljs">gST-&gt;ConOut-&gt;OutputString(gST-&gt;ConOut, MyString);</code> </pre> <br>  to the following: <br><br><pre> <code class="cpp hljs">gST-&gt;ConOut-&gt;ClearScreen(gST-&gt;ConOut); <span class="hljs-comment"><span class="hljs-comment">// ,  gST-&gt;ConOut-&gt;SetCursorPosition(gST-&gt;ConOut, 3, 10); //    10- , 3-  gST-&gt;ConOut-&gt;OutputString(gST-&gt;ConOut, L"Enter password up to 255 characters lenght, then press 'Enter' to continue\r\n"); //      do { //    gBS-&gt;WaitForEvent (1, &amp;gST-&gt;ConIn-&gt;WaitForKey, &amp;EventIndex); //      gST-&gt;ConIn-&gt;ReadKeyStroke (gST-&gt;ConIn, &amp;Keys); //     gST-&gt;ConOut-&gt;SetAttribute(gST-&gt;ConOut, Index &amp; 0x7F); //     PasswordString[Index++] = (Keys.UnicodeChar); //     ‚Äì  ,    gST-&gt;ConOut-&gt;OutputString(gST-&gt;ConOut, L"*"); } //   Enter     255 ,      while (!(Keys.UnicodeChar == CHAR_LINEFEED || Keys.UnicodeChar == CHAR_CARRIAGE_RETURN || Index == 254)); //   ,  1   PasswordString[Index++] = '\0'; //       gST-&gt;ConOut-&gt;SetAttribute(gST-&gt;ConOut, 0x0F); //  ,   gST-&gt;ConOut-&gt;OutputString(gST-&gt;ConOut, L"\r\nEntered password is: \r\n"); gST-&gt;ConOut-&gt;OutputString(gST-&gt;ConOut, PasswordString); gST-&gt;ConOut-&gt;OutputString(gST-&gt;ConOut, L"\r\n");</span></span></code> </pre> <br>  Hit F5 and settle in the already usual pose for a couple of minutes: <br><br><img src="https://habrastorage.org/web/3dd/267/145/3dd267145cd94348a2acc8add88561d5.png"><br><br>  After the <b>Shell</b> prompt, as always, enter <b>fs0:</b> and <b>load MyFirstDriver</b> (or <b>load my</b> and then <b>press</b> <b>Tab</b> twice, for <b>Shell</b> ).  We get such a picture (of course, the text will be the one that you entered yourself): <br><br><img src="https://habrastorage.org/web/d94/a05/598/d94a05598e344c8a8360d791da606509.png"><br><br>  Press Shift + F5 to close debugging, after having admired. <br><br>  Further in the article we will get acquainted closer with the <b>UEFI Shell, PCD</b> environment and debug messages - without this, it is impossible to move on.  But we will not get acquainted in the abstract, but in the useful process of accelerating and automating the launch of a driver for debugging. <br><br><h3>  Creating and editing the boot script UEFI Shell </h3><br>  Now, since you probably have already recompiled the program more than once or twice, you are morally ripe to reduce this annoying waiting time for loading <b>UEFI Shell</b> and driving the same commands each time to load our driver.  To begin with, we remove all manual text input to <b>Shell by</b> writing the appropriate script.  We will write the script directly in <b>Shell</b> .  From the point of view of common sense, it is better to open the script file in <b>Far Manager</b> and edit it there, but what will happen to you in the future that you will be thrown into the <b>Shell of a</b> real machine, and not a virtual machine with access to its file system from the host.  Therefore, once we create a script in the <b>Shell</b> editor and write it down to get the appropriate skill. <br><br>  The script file that is executed at startup (similar to <b>autoexec.bat</b> or <b>bashrc</b> ) for <b>UEFI Shell</b> is called <b>startup.nsh</b> , the one that <b>Shell</b> invites us to skip every time at boot.  Log in to the <b>UEFI Shell</b> by pressing the <b>F5</b> key in <b>Visual Studio</b> and enter <b>fs0:</b> to switch to our file system.  Now from <b>Shell</b> enter the command <br><br><pre> <code class="cpp hljs">edit startup.nsh</code> </pre> <br>  and in the opened editor, enter, with a line break by <b>Enter</b> : <br><br><pre> <code class="cpp hljs">FS0: load MyFirstDriver.efi</code> </pre> <br><img src="https://habrastorage.org/web/257/fd0/5ce/257fd05cec834b15b48d3936ba150a6d.png"><br><br>  Next, press <b>F2</b> , then <b>Enter</b> to write and then <b>F3</b> to exit the editor back to <b>Shell</b> . <br><br>  We will not re-create everything anew this time, since we have not changed anything in the program.  We type the <b>Exit</b> command in the <b>Shell</b> , and in the text box that opens a-la <b>BIOS Setup</b> , and in <b>UEFI</b> terms, the <b>Main Form</b> , select <b>Continue</b> .  After that, we will be thrown back into <b>Shell</b> again, but this time the <b>startup.nsh</b> script we created will be <b>executed</b> and our driver will start automatically. <br><br><h3>  Debug messages </h3><br>  For now, we can write debugging messages to the screen, but when we work with <b>HII</b> forms ( <b>Human Interface Infrastructure</b> ) - such an opportunity will not present itself, the screen will be occupied with hardware configuration forms.  What to do in this case? <br><br><div class="spoiler">  <b class="spoiler_title">Somewhat abstract topic</b> <div class="spoiler_text">  At the very beginning, after receiving a new board from the factory, it is not always, oh, the display console for debugging output is not always available.  In terms of the likelihood of possible connection errors, the display goes much ahead of the serial port, in which you can only screw up with the RX-TX direction.  Therefore, there is also a serial port output, completely analogous to the one on the screen, with <b>ConOut replaced</b> by <b>StdErr</b> .  Those.  function <br><pre> <code class="cpp hljs">gST-&gt;ConOut-&gt;OutputString(gST-&gt;ConOut, L‚ÄùTest <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>‚Äù);</code> </pre> <br>  will display the ‚ÄúTest string‚Äù on the display, and the function <br><pre> <code class="cpp hljs">gST-&gt;StdErr-&gt;OutputString(gST-&gt;StdErr, L‚ÄùTest <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>‚Äù);</code> </pre> <br>  will output a test message to the serial port.  Try it.  Later, we will redirect the output in the virtual machine from the serial port to the log file, which may be useful in the future - write logs to a USB flash drive inserted into the USB port on a real hardware. <br></div></div><br><h3>  Display debug information in the OVMF window </h3><br>  To display information in the OVMF window, there is a DEBUG macro, which is usually used as follows: <br><br><pre> <code class="cpp hljs">DEBUG((EFI_D_INFO, <span class="hljs-string"><span class="hljs-string">"Test message is: %s\r\n"</span></span>, Message));</code> </pre> <br>  Where the first argument is a certain analogue of the Linux level of error messages <b>ERROR_LEVEL</b> , and the second, as you might guess, is a pointer to a string that needs to be output to the OVMF console. <br><br>  The first argument can take the following values: <br><br> <code>#define EFI_D_INIT 0x00000001 // Initialization style messages <br> #define EFI_D_WARN 0x00000002 // Warnings <br> #define EFI_D_LOAD 0x00000004 // Load events <br> #define EFI_D_FS 0x00000008 // EFI File system <br> #define EFI_D_POOL 0x00000010 // Alloc &amp; Free's <br> #define EFI_D_PAGE 0x00000020 // Alloc &amp; Free's <br> #define EFI_D_INFO 0x00000040 // Informational debug messages <br> #define EFI_D_VARIABLE 0x00000100 // Variable <br> #define EFI_D_BM 0x00000400 // Boot Manager (BDS) <br> #define EFI_D_BLKIO 0x00001000 // BlkIo Driver <br> #define EFI_D_NET 0x00004000 // SNI Driver <br> #define EFI_D_UNDI 0x00010000 // UNDI Driver <br> #define EFI_D_LOADFILE 0x00020000 // UNDI Driver <br> #define EFI_D_EVENT 0x00080000 // Event messages <br> #define EFI_D_VERBOSE 0x00400000 // Detailed debug messages that may significantly impact boot performance <br> #define EFI_D_ERROR 0x80000000 // Error</code> <br> <br>  By adjusting the level of appearance of these messages in the log, we can maintain the required balance between the level of logging and the performance of the system as a whole. <br><br><div class="spoiler">  <b class="spoiler_title">More about the DEBUG macro</b> <div class="spoiler_text">  1. Its output has formatting and works like <b>printf</b> formatting.  The <b>% r</b> format is <b>very</b> useful for debugging, which displays the Status diagnostic variable not as a 32-bit number in HEX, but as a human-readable line like <b>Supported</b> , <b>Invalid Argument</b> , etc. <br><br>  2. This macro is automatically disabled when changing <b>Debug</b> to <b>Release</b> , so don‚Äôt be in a hurry to comment on it or hang up with ifndefs - everything has already been done for us. <br><br>  3. Double brackets are really needed there.  Try to remove and see what happens. <br></div></div><br><h3>  Small example </h3><br>  To illustrate what was written, <b>let's</b> add to the <b>MyFirstDriverDriverEntryPoint ()</b> function, immediately after declaring variables, output text from several messages to the log with different levels of debugging and see which ones are displayed and which ones are filtered: <br><br><pre> <code class="cpp hljs">DEBUG((EFI_D_INFO, <span class="hljs-string"><span class="hljs-string">"Informational debug messages\r\n"</span></span>)); DEBUG((EFI_D_ERROR, <span class="hljs-string"><span class="hljs-string">"Error messages\r\n"</span></span>)); DEBUG((EFI_D_WARN, <span class="hljs-string"><span class="hljs-string">"Warning messages\r\n"</span></span>));</code> </pre> <br>  We start to debug and look into the <b>OVMF</b> window: <br><br><img src="https://habrastorage.org/web/33c/fe1/9e8/33cfe19e813e4bcda94ad2bb88de7a94.png"><br><br>  It can be seen that the messages with the <b>EFI_D_INFO</b> and <b>EFI_D_ERROR levels</b> got into the log, but <b>they</b> did not hit with the <b>EFI_D_WARN</b> level. <br><br>  The mechanism for adjusting debug levels is quite simple: as we see in the list above, each level is characterized by one bit in a 32-bit word.  To filter out messages that we do not need at the moment, we set the bit mask to the value of the level that cuts off bits that do not fall into this mask.  In our case, the mask was <b>0x80000040</b> , because the <b>EFI_D_WARN</b> level with a value of <b>0x00000002 was</b> filtered and did not hit the output, and the <b>EFI_D_INFO</b> level with a value of <b>0x00000040</b> , and <b>EFI_D_ERROR</b> with its value of <b>0x80000000</b> were in the mask and the corresponding messages were output. <br><br>  Now we will not further delve into consideration of the implementation of the debug output level adjustment mechanism, we will consider only ways to change it in practice.  There are two of them, the first one is fast, and the second one is correct.  We begin, of course, with fast.  Open the file <b>c: \ FW \ Nt32Pkg \ Nt32Pkg.dsc</b> and look for the line in it containing <b>PcdDebugPrintErrorLevel</b> .  Here she is: <br><br> <code>gEfiMdePkgTokenSpaceGuid.PcdDebugPrintErrorLevel|0x80000040</code> <br> <br>  Change the mask value to <b>0x80000042</b> and start building and debugging again. <br><br>  Since we have changed the configuration file, <b>edk2</b> will again rebuild all-all-all binaries for <b>Nt32Pkg</b> , but this process is finite, and here we see all three lines in the log, which was required to prove: <br><br><img src="https://habrastorage.org/web/d20/043/e7f/d20043e7f7644854b5278ce0c30d2aad.png"><br><br>  How to make quickly sorted out.  Now do the right thing. <br><br><h3>  Platform Configuration Database (PCD) </h3><br>  The problem with the previous approach is that the <b>edk2</b> tree and the <b>Nt32Pkg</b> package are the only ones, and changing the system settings for the only project is a direct path to the underworld, because at best in a week you will forget about this change completely and curse the fiend of hell called <b>edk2</b> , that a month ago, regularly created from tested source codes under version control exactly what was needed, and now it gives out something completely different.  Therefore, <b>edk2 has</b> a mechanism for changing system settings for a single project in order to localize changes to these settings only for this project.  This mechanism is called <b>PCD</b> - <b>Platform Configuration Database</b> , and allows a lot.  In general, a good style in <b>edk2</b> is considered to be to <b>remove</b> from the source code in <b>PCD</b> any parameter that may be changed in the future.  The length of the article does not allow one to dwell on the <b>PCD</b> description in more detail; therefore, it is better to look at the details about <b>PCD</b> <a href="https://github.com/tianocore-docs/Docs/raw/master/User_Docs/EDK_II%2520Module%2520Writer_s%2520Guide_0_7.pdf">here</a> in Section 3.7.3 or <a href="https://www.intel.com/content/dam/www/public/us/en/documents/white-papers/edkii-platform-config-database-entries-paper.pdf">here</a> .  For the first time, it is enough to restrict ourselves to reading the file <b>C: \ FW \ edk2 \ MdeModulePkg \ Universal \ PCD \ Dxe \ Pcd.inf</b> <br><br>  From the point of view of practice, configuration using <b>PCD is</b> done like this: in the same file <b>c: \ FW \ Nt32Pkg \ Nt32Pkg.dsc</b> change the display level of messages in the <b>OVMF</b> window: <br><br><pre> <code class="cpp hljs">EducationPkg/MyFirstDriver/MyFirstDriver.inf { &lt;PcdsFixedAtBuild&gt; gEfiMdePkgTokenSpaceGuid.PcdDebugPrintErrorLevel|<span class="hljs-number"><span class="hljs-number">0x80000042</span></span> }</code> </pre> <br>  Do not rush to immediately write the file.  First, correct back <b>0x80000042</b> to the default value <b>0x80000040</b> in the line that we edited earlier: <br><br><pre> <code class="cpp hljs">gEfiMdePkgTokenSpaceGuid.PcdDebugPrintErrorLevel|<span class="hljs-number"><span class="hljs-number">0x80000042</span></span></code> </pre> <br>  And now you can write a file and rebuild the project.  We start on debugging on <b>F5</b> and we see our treasured three lines in the debug console. <br><br><h3>  Speeding up debugging </h3><br>  Remove a couple more annoying delays when starting up for debugging.  Obviously, the first candidate is waiting for those 5 seconds before launching the <b>startup.nsh</b> script.  Of course, it can also press a space, but any <s>self-respecting lazy</s> programmer should automate manual operations as much as possible. <br><br>  Now it is necessary to contradict what was said earlier.  The problem is that in these 5 seconds the delays are not written through PCD, but contrary to Feng Shui, directly, in the Shell sources.  Therefore, we, whether we want it or not, will have to do the same: open the file <b>C: \ FW \ edk2 \ ShellPkg \ Application \ Shell \ Shell.c</b> and change the initial value "5" to "1" <br><br><pre> <code class="cpp hljs">ShellInfoObject.ShellInitSettings.Delay = <span class="hljs-number"><span class="hljs-number">1</span></span>;<span class="hljs-comment"><span class="hljs-comment">//5;</span></span></code> </pre> <br>  It would be possible to set it to 0, but you never know ... We will forget to change it on a real hardware system, but it will not be possible to recompile later. <br><br>  Hit <b>F5</b> and enjoy 1 sec.  delays instead of 5. <br><br>  If someone knows how to set this delay value correctly, through <b>PCD</b> and without editing the <b>Shell</b> source code - let me know in a personal or in the comments, I will correct it. <br><br><h3>  Still accelerating </h3><br>  We recall about the progress bar, but in reality - just the timer waiting for the selection of the boot option.  This is how it looks on the main screen: <br><br><img src="https://habrastorage.org/web/ef0/2e9/a07/ef02e9a076fc4ede9abfce27c46abea3.png"><br><br>  And in <b>the OVMF launch window,</b> it looks a little different: <br><br><img src="https://habrastorage.org/web/fe5/9fa/1ed/fe59fa1ed8394d6aa2f67652200604b2.png"><br><br>  As Winnie-the-Pooh used to say, ‚ÄúThis is a train ‚Äî for good reason!‚Äù We must find the source and also reduce it to 1 sec. <br><br>  Run a search on all files with the <b>* .c</b> extension of the <b>Zzzzz</b> line, find this line in the source code <b>C: \ FW \ MdeModulePkg \ Universal \ BdsDxe \ BdsEntry.c</b> and see there such a block of code: <br><br><pre> <code class="cpp hljs"> DEBUG ((EFI_D_INFO, <span class="hljs-string"><span class="hljs-string">"[Bds]BdsWait ...Zzzzzzzzzzzz...\n"</span></span>)); TimeoutRemain = PcdGet16 (PcdPlatformBootTimeOut); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (TimeoutRemain != <span class="hljs-number"><span class="hljs-number">0</span></span>) { DEBUG ((EFI_D_INFO, <span class="hljs-string"><span class="hljs-string">"[Bds]BdsWait(%d)..Zzzz...\n"</span></span>, (UINTN) TimeoutRemain)); PlatformBootManagerWaitCallback (TimeoutRemain);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accordingly, it is clear that the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TimeoutRemain</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">is read from the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PCD</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> configuration database </font><font style="vertical-align: inherit;">, in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PcdPlatformBootTimeOut</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter </font><font style="vertical-align: inherit;">. Ok, open our configuration file </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c: \ FW \ Nt32Pkg \ Nt32Pkg.dsc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , look for the line with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PcdPlatformBootTimeOut there</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="cpp hljs"> gEfiMdePkgTokenSpaceGuid.PcdPlatformBootTimeOut|<span class="hljs-string"><span class="hljs-string">L"Timeout"</span></span>|gEfiGlobalVariableGuid|<span class="hljs-number"><span class="hljs-number">0x0</span></span>|<span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br>   ,  ,   <b>PcdDebugPrintErrorLevel</b>    ,   ‚Äì         ,    <b>MyFirstDriver</b>     <b>startup.nsh</b> ,    ,     .    ‚Äî ,            .  10  1    ,  <b>F5</b>    .       23 . <br><br><h3>  ,    ‚Äî  </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We remove the second display, which we have no reason for yet, but has already begun to annoy. </font><font style="vertical-align: inherit;">We edit the lines in our favorite configuration file </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c: \ FW \ Nt32Pkg \ Nt32Pkg.dsc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , opening it and removing </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">! My EDK II 2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">! UGA Window 2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in two lines to make it:</font></font><br><br><pre> <code class="cpp hljs">gEfiNt32PkgTokenSpaceGuid.PcdWinNtGop|<span class="hljs-string"><span class="hljs-string">L"UGA Window 1"</span></span>|VOID|<span class="hljs-number"><span class="hljs-number">52</span></span></code> </pre> <br>  and <br><br><pre> <code class="cpp hljs">gEfiNt32PkgTokenSpaceGuid.PcdWinNtUga|<span class="hljs-string"><span class="hljs-string">L"UGA Window 1"</span></span>|VOID|<span class="hljs-number"><span class="hljs-number">52</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can, of course, </font><font style="vertical-align: inherit;">change the </font><font style="vertical-align: inherit;">very inscription in the header of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UGA Window 1 window</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for something spiritually closer to you personally, but this is up to you.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> For the future </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is another big reserve for reducing the compile time and launch of the project (at times) - to compile not the entire </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">edk2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but only our module. </font><font style="vertical-align: inherit;">But about this, as they say - in the next series. </font><font style="vertical-align: inherit;">You can still try to do it yourself, an elementary decision, as you will see later. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You may now seem overkill - paying so much attention to reducing compilation and launch time, but believe me - when you start writing your programs, the difference between the target 10 seconds before launch, to which we will come, and 2 minutes, which were initially - is huge. </font><font style="vertical-align: inherit;">Time spent now very quickly will pay off - the third article is not far off, and it will have to debug a lot.</font></font></div><p>Source: <a href="https://habr.com/ru/post/338404/">https://habr.com/ru/post/338404/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338392/index.html">Visiting a fairy tale: patent trolls</a></li>
<li><a href="../338394/index.html">Hidden costs in the implementation of CRM-systems. Field experience</a></li>
<li><a href="../338396/index.html">We connect Swagger module in Play Framework</a></li>
<li><a href="../338398/index.html">Libgdx Practical questions and answers</a></li>
<li><a href="../338402/index.html">Choosing a help desk system. 9 typical misconceptions</a></li>
<li><a href="../338406/index.html">PostgreSQL Power</a></li>
<li><a href="../338408/index.html">Sale of electronic signatures and related services</a></li>
<li><a href="../338410/index.html">IT vs AI: will cars be taken away from their creators?</a></li>
<li><a href="../338412/index.html">RailsClub 2017. Interview with Nikita Sobolev, the organizer of elixir-lang.moscow</a></li>
<li><a href="../338414/index.html">How operators form tariffs in different countries of the world</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>