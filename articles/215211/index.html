<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monkeyrunner. Pixel-perfect testing web pages on Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since Google released the monkeyrunner test automation tool, a lot of time has passed, and there has been no improvement in it. However, for the task ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monkeyrunner. Pixel-perfect testing web pages on Android</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/3a7/a60/3e6/3a7a603e6a5b57f63ea0906d2ef3f2de.jpg" align="left" height="150">  Since Google released the <a href="http://developer.android.com/tools/help/monkeyrunner_concepts.html">monkeyrunner</a> test automation <a href="http://developer.android.com/tools/help/monkeyrunner_concepts.html">tool, a</a> lot of time has passed, and there has been no improvement in it.  However, for the task of regularly checking web pages for correct layout, there was no better tool.  Those who simply need a ready-made script for comparing screenshots of pages on an android with scrolling support can immediately download it from the <a href="https://bitbucket.org/fo2rist/monkeyrunner-sites-verificator/overview">link</a> .  Under the cut, it will be told what problems the mankayranner holds and how to overcome them. <br><a name="habracut"></a><br><h5>  Task </h5><br>  In short, the challenge was this: go through the pages of the list and make sure that they look the same as before (or almost the same).  Needless to scroll through the pages to the end. <br><br><h5>  Algorithm of the decision </h5><br>  By itself, it looks quite simple: <br><ol><li>  Open page from list </li><li>  Take a screenshot, compare it with the refrain </li><li>  If the screenshot is not much different, scroll the page on one screen and repeat step 2 </li><li>  If the page has ended, or the result is very different from the original, go to the next page. </li></ol><br>  To take screenshots, monkeyrunner has a ready-made <a href="http://developer.android.com/tools/help/MonkeyDevice.html">takeSnapshot</a> function, and for comparing them there is an absolutely excellent <a href="http://www.imagemagick.org/">ImageMagick</a> , which allows you to evaluate how similar the images are, and not just require 100% match.  ImageMedzhik has many comparison metrics, I use -metric RMSE. <br>  To determine when it is time to finish scrolling the village down, it is enough to compare the last two screens, if they coincided, then the end is reached. <br>  <a href="https://github.com/kyrus/python-junit-xml">Python-junit-xml is</a> used to export the results to CI or your favorite IDE. <br><br><h5>  Underwater rocks </h5><br>  Now the most interesting thing: if you do all this "in the forehead", then nothing will work.  There are several reasons. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>1. Windows</b> <br>  monkeyrunner has an interesting feature, monkeyrunner.bat under Windows in the process of execution replaces the current directory with the one where the mannei-manner itself lies, because it is so convenient for him.  As a result, all relative paths and <i>import</i> directives stop working in our script. <br>  To overcome this behavior, the script should determine its location by itself and continue to act only on absolute paths.  This is done like this: <br><pre><code class="python hljs">filepath = path.split(os.path.realpath(__file__))[<span class="hljs-number"><span class="hljs-number">0</span></span>] BASE_PATH = path.split(filepath)[<span class="hljs-number"><span class="hljs-number">0</span></span>].encode(FILENAMES_ENCODING) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> junit_xmls <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TestSuite, TestCase <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ImportError: <span class="hljs-comment"><span class="hljs-comment">#dirty hack that loads 3rd party modules from script's dir not from working dir, which is always changed by windows monkeyrynner import imp config = imp.load_source('config', BASE_PATH+'/src/config.py') junit_xml = imp.load_source('junit_xml', BASE_PATH+'/src/junit_xml/__init__.py') TestSuite = junit_xml.TestSuite TestCase = junit_xml.TestCase</span></span></code> </pre> <br><br>  <b>2. Russian characters</b> <br>  The very first attempt to test the Russian Wikipedia failed, as the mankairnner is based on the second python and inherits all known problems of unicode and national symbols.  I had to explicitly specify the encoding wherever possible, as well as slightly modify junit_xml, the author of which was unaware of the national symbols. <br>  For example, to create files correctly, you need to transfer the name to unicode explicitly. <pre> <code class="python hljs">filePath.decode(<span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>)</code> </pre> <br>  In addition, on the Russian-language versions of Windows, the script will simply fall if the wrong path to ImageMagick is given, because <i>Popen</i> simply does not expect to receive Russian characters in the error message, and Windows localizes its messages. <br><br>  <b>3. Scrolling</b> <br>  If we scroll the same page 10 times in the same browser on the same device using <a href="http://developer.android.com/tools/help/MonkeyDevice.html">MonkeyDevice.drag (),</a> we get 10 different results.  Drag simply does not guarantee that it will scroll the page equally.  To solve this problem, I had to apply the following trick: comparing a new page with an old one, I cut several pixels off the top and bottom of the page and look for its place of its entry into the original (fortunately ImageMagick can even do this), then how much the page is lower or higher than the supposed position, and there is an error scrolled, you need to subtract it at the next scroll.  Such feedback allows the script to not fall off on the third iteration and safely live to the end of the page. <br><br>  <b>4. Memory consumption</b> <br>  If you open 10-20 pages in a row, any browser will simply create 10-20 tabs, over time they will consume all the memory and the browser will simply stop responding normally to commands.  At best, page loading will slow down, but usually this causes the monkeyrunner to simply fall off due to a timeout.  To avoid this, I went for a small hack: before opening a new page, the current browser process is simply killed via adb, something like this <pre> <code class="python hljs">device.shell(<span class="hljs-string"><span class="hljs-string">'am force-stop '</span></span> + BROWSER_PACKAGE_NAME)</code> </pre> <br>  This hack helps the standard AOSP browser quite well in the emulator, but it doesn‚Äôt really work on Chrome, Opera and FF, so in the end I just had to write my own wrapper on the web-view, in fact, a lightweight browser without tabs.  Along the way, two other problems were resolved: the self-written browser does not ask for confirmation of access to the user's location and does not spoil the screenshots, and in addition it can be included in the script and it will be installed automatically via <a href="http://developer.android.com/tools/help/MonkeyDevice.html">MonkeyDevice.installPackage ()</a> <br><br>  <b>5. Failed connections</b> <br>  If you terminate the script and immediately restart it, most likely <a href="http://developer.android.com/tools/help/MonkeyRunner.html">MonkeyRunner.waitForConnection () will</a> simply fall down with an error, while the repeated call usually passes without problems.  Therefore, the final script always tries to connect to the device twice. <br><br>  <b>6. Screen lock</b> <br>  If the device was blocked at the time of launch, the script will simply not work correctly.  This can be avoided by simulating pressing the hardware menu button (for some unknown reason, it unlocks Android devices) <br><pre> <code class="python hljs">MonkeyDevice.press(<span class="hljs-string"><span class="hljs-string">"KEYCODE_MENU"</span></span>, MonkeyDevice.DOWN_AND_UP)</code> </pre> <br>  But since this will lead to the appearance of a menu on an unlocked device, it is better to first make sure that the device is locked, you can do this via dumpsys <br><pre> <code class="python hljs"> lockScreenRegexp = re.compile(<span class="hljs-string"><span class="hljs-string">'mShowingLockscreen=(true|false)'</span></span>) result = lockScreenRegexp.search(device.shell(<span class="hljs-string"><span class="hljs-string">'dumpsys window policy'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> result: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (result.group(<span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-string"><span class="hljs-string">'true'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> RuntimeError(<span class="hljs-string"><span class="hljs-string">"Couldn't determine screen lock state"</span></span>)</code> </pre><br><br>  Unlocking itself will not turn on the screen on the "sleeping" device, so before all these operations you should make a forced call to <a href="http://developer.android.com/tools/help/MonkeyDevice.html">MonkeyRunner.wake ()</a> <br>  After the device is successfully unlocked, you can rely on the fact that other functions will start to work correctly. <br><br><h5>  Total </h5><br>  With all the edits, you can already check the correctness of displaying pages without fear of drops every 5 minutes, but for a better result, you should choose either a test browser or an AOSP Browser from the vanilla android. <br><br>  P.S.  The code is on the bitback and is open for copying and modifications. </div><p>Source: <a href="https://habr.com/ru/post/215211/">https://habr.com/ru/post/215211/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215189/index.html">Python Meetup: January Meeting</a></li>
<li><a href="../215197/index.html">Interesting and informative: the flight to the ISS on the PTK NP</a></li>
<li><a href="../215203/index.html">Is IntelliJ based .NET support a reality?</a></li>
<li><a href="../215205/index.html">Cebit 2014 through the eyes of a robot webot</a></li>
<li><a href="../215207/index.html">IBM Watson supercomputer has learned to create its own recipes</a></li>
<li><a href="../215213/index.html">Image Catalyst 2.5</a></li>
<li><a href="../215215/index.html">Is the smart home controller (with Ethernet, WiFi, USB, blackjack and buns) for $ 20?</a></li>
<li><a href="../215223/index.html">Stanford University developed a paper microscope worth less than a dollar</a></li>
<li><a href="../215225/index.html">Break me down completely (ZeroNightsCrackme, Part 2)</a></li>
<li><a href="../215227/index.html">Simple monitoring of server load in real time with a web interface</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>