<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VPN bridge to local network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I read the habrahabr.ru/blogs/linux/67209 topic and decided to post here my article, which was previously visible only in the closed corporate Wiki. 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VPN bridge to local network</h1><div class="post__text post__text-html js-mediator-article">  <i>I read the <a href="http://habrahabr.ru/blogs/linux/67209/">habrahabr.ru/blogs/linux/67209</a> topic and decided to post here my article, which was previously visible only in the closed corporate Wiki.</i> <br><br>  Usually, when creating a VPN, a point-to-point connection to a server is used, or an ethernet tunnel with a server is installed, at which a specific subnet is assigned to the tunnel.  The VPN server at the same time performs the functions of routing and filtering traffic to access the local network through a VPN. <br><br>  This article discusses a different approach to creating a virtual network in which remote systems are connected to an already existing local subnet, and the VPN server acts as an Ethernet gateway.  Using this approach, we still have the ability to filter traffic based on the connection method (for example, use different filters for the local network and for remote users), but eliminates the need to configure routing, and remote machines are connected directly to the local network, they see resources that can even use broadcast packets without any additional configuration.  Through such a VPN, they display all computers on the local Windows network, all available XDMCP servers for XDMCP broadcast, etc. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h3>  Network structure and server setup </h3><br>  Suppose there is an office with a local network, an IP subnet <b>192.168.168.0/24 is used</b> .  We will include home users in this local network, that is, they will have an address from the same subnet.  You need to make sure that they do not have this subnet ‚Äúat home‚Äù and that no systems in the local network have addresses from the range that we will allocate to remote users. <br><br><h4>  Bridge support in the core </h4><br>  For the operation of such technology, we need some kernel drivers.  This is a universal driver for virtual network interfaces <b>tun</b> , and an ethernet bridge <b>bridge</b> driver.  You can include them in the kernel, or assemble modules: <br><br><pre>     -&gt; Networking
       -&gt; Networking support (NET [= y])
         -&gt; Networking options
           &lt;*&gt; 802.1d Ethenet Bridging (BRIDGE [= y])
     -&gt; Device Drivers
       -&gt; Network device support (NETDEVICES [= y])
         &lt;*&gt; Universal TUN / TAP device driver support (TUN [= y])
</pre><br>  If they are assembled by modules, you must either enable automatic loading of modules in the kernel, or load them yourself before establishing a VPN connection. <br><br><h4>  Software </h4><br>  The server will require OpenVPN and utilities to service the bridge.  In Gentoo, they are going as follows: <br><br><pre>   emerge net-misc / bridge-utils net-misc / openvpn
</pre><br><br>  When using&gt; = sys-apps / baselayout-1.12.6, this is enough; for older versions, you need special utilities to maintain tun / tap devices: <br><br><pre>   emerge sys-apps / usermode-utilities
</pre><br><br><h4>  Network configuration </h4><br>  Let eth2 be the interface to which the local network is connected, with the assigned address 192.168.168.254.  Its setup looked like this: <br><br><pre>   config_eth2 = ("192.168.168.254/24")
</pre><br><br>  Since he will participate in the bridge, he does not need to assign addresses.  Also, the newly created virtual interface tap0 participates in the bridge, which is also not assigned any address.  The address that was used by eth2 is now assigned to bridge br0: <br><br><pre>   config_eth2 = ("null")
  
   tuntap_tap0 = "tap"
   config_tap0 = ("null")
  
   depend_br0 () {
     need net.tap0 net.eth2
   }
  
   # specify existing interfaces, combining them into a bridge
   bridge_br0 = "eth2 tap0"
   # either, you can dynamically connect the newly emerging interfaces there
   # bridge_add_eth2 = "br0"
  
   config_br0 = ("192.168.168.254/24")
</pre><br><br>  You also need to create configuration scripts for the specified interfaces: <br><br><pre>   cd /etc/init.d
   ln -s net.lo net.eth2
   ln -s net.lo net.tap0
   ln -s net.lo net.br0
</pre><br><br>  It is enough to automatically load only the interface br0.  depend_br0 () will automatically raise all the rest necessary for its work: <br><br><pre>   rc-update add net.br0 default
   /etc/init.d/net.eth2 stop
   /etc/init.d/net.br0 start
</pre><br><br><h4>  Creating OpenVPN keys </h4><br>  We will authenticate clients using OpenSSL RSA keys.  To simplify the process, we prepared several init scripts for us: <br><br><pre>   cd / usr / share / openvpn / easy-rsa /
</pre><br><br>  There is a vars file in which we will enter general values: <br><br><pre>   nano vars
</pre><br><br>  At the bottom of this file we fill in our variables: <br><br><pre>   export KEY_COUNTRY = "RU"
   export KEY_PROVINCE = "Voronezh oblast"
   export KEY_CITY = "Boguchar"
   export KEY_ORG = "OrganiZationnAme"
   export KEY_EMAIL = "root@oza.ru"
</pre><br><br>  Load the variables from this file and build the CA (Certificate Authority): <br><br><pre>   source ./vars
   ./clean-all
   ./build-ca
</pre><br><br><h5>  Server key </h5><br><br>  To generate a server key with the name office, use the following command: <br><br><pre>   ./build-key-server office
</pre><br><br>  The question ‚ÄúCommon Name‚Äù must be answered with the server name (in our case, office).  Two questions at the end of ‚ÄúSign the certificate?  [y / n] "and" 1 out of 1 certificate requests certified, commit?  [y / n] ‚Äùanswer‚Äú y ‚Äù. <br><br>  If necessary, you can create additional server keys.  For example, these may be backup access servers to increase system reliability.  They are created by the same command, before it you need to run source ./vars. <br><br><h5>  Diffie-Hellman options </h5><br>  There is nothing extra to do here, but you have to wait. <br><br><pre>   ./build-dh
</pre><br><br>  This file is needed only on the server. <br><br><h5>  Customer keys </h5><br><br>  Each client must give his key.  For a client named client, the key is created by the command <br><br><pre>   ./build-key client
</pre><br><br>  The question about the ‚ÄúCommon Name‚Äù is answered with the name of the client (in this case, client).  We answer the two questions at the end. <br><br>  The generated keys and certificates are passed to clients via a secure channel.  If necessary, you can create more keys with the same command.  Before its launch, it is necessary to load the environment - run source ./vars. <br><br><h4>  Setup and start of the OpenVPN service </h4><br>  To start, use the following server configuration (/etc/openvpn/openvpn.conf file): <br><br><pre>   # This port is recommended by IANA for OpenVPN.  You can move to another port, but secrecy does not increase - it is still the first thing to admit that it is OpenPVN.
   port 1194
  
   # OpenVPN can use tcp and udp as the transport protocol, udp is preferable
   proto udp
  
   # The virtual interface that we included in the bridge is definitely of type tap (you cannot emulate Ethernet via tun)
   dev tap0
  
   # Root CA self signed certificate
   ca /etc/openvpn/keys/ca.crt
  
   # Certificate and server secret key.  crt must have modes 644, key - 600
   cert /etc/openvpn/keys/office.crt
   key /etc/openvpn/keys/office.key
  
   # File with Diffie-Hellman parameters.  If you have a different key length, correct the name :)
   dh /etc/openvpn/keys/dh1024.pem
  
   # Distribute addresses to remote clients in this subnet, from this range (note that the subnet is ALL, as in the network card config, and the range is part of the subnet)
   server-bridge 192.168.168.254 255.255.255.0 192.168.168.128 192.168.168.159
  
   # Allow clients to interact with each other (otherwise, only with the server and the network segment "behind the bridge")
   client-to-client
  
   # This will allow the client to give the same address, which was issued earlier, if not busy
   ifconfig-pool-persist /etc/openvpn/ipp.txt
  
   # If you do not want to send the DNS server address also via DHCP, you can remove the following line
   push "dhcp-option DNS 192.168.168.254"
  
   # Compression
   comp-lzo
   # Maximum number of clients - it makes sense to make less or equal to the number of addresses in the server-bridge range
   max-clients 32

   # Details on these keys - in the documentation OpenVPN
   keepalive 10 120

   # Do not reinitialize tun and do not re-read the key during reconnections;  if we work not as root, but as nobody, then we will not be allowed, therefore either all these options or none of them
   user nobody
   group nobody
   persist-key
   persist tun

   # Every minute OpenVPN resets the current state here (list of clients, routes, etc.)
   status /tmp/openvpn-status.log
  
   # Very noisy log, normal operation - verb 2
   verb 6
   log-append /var/log/openvpn.log
</pre><br><br>  The <b>office.key</b> key must have mode <b>600</b> (access only to the owner).  The <b>office.crt</b> and <b>dh1024.pem files</b> have mode <b>644</b> . <br><br><h4>  Filter setting </h4><br><br>  Since we use a bridge, there are several features of packet filtering.  For example, not all passing packets can be IPv4 at all.  To configure the operation of the bridge in the kernel, there are several parameters: <br><br>  <i>The variables of this group are stored in the files of the / proc / sys / net / bridge / directory.</i>  <i>They can also be configured in /etc/sysctl.conf, then they all get the prefix "net.brigde."</i> <br><ul><li>  <b>bridge-nf-call-arptables</b> <br>  The logical variable bridge-nf-call-arptables controls the transmission of ARP traffic to the FORWARD chain of the arptables packet filter.  The default value of 1 allows packet transmission to filters, 0 disables it. </li><li>  <b>bridge-nf-call-iptables</b> <br>  The logical variable bridge-nf-call-iptables controls the transmission of IPv4 traffic passing through the bridge to iptables chains.  The default value of 1 allows the transfer of packets for filtering, 0 - prohibits. </li><li>  <b>bridge-nf-call-ip6tables</b> <br>  The action is similar to the previous one, only it configures the transmission of IPv6 traffic for filtering to ip6tables chains. </li><li>  <b>bridge-nf-filter-vlan-tagged</b> <br>  The logical variable bridge-nf-filter-vlan-tagged determines whether IP / ARP traffic can be transmitted with VLAN tags to packet filtering programs (arptables / iptables).  The value 1 (set by default) allows the transfer of packets with VLAN tags to filtering programs, 0 - prohibits. </li></ul><br><br>  For filtering packets passing through the bridge, physdev matching is used, which distinguishes from which port of the bridge the packet should go and from which port.  We include it in the core: <br><br><pre> -&gt; Networking
   -&gt; Networking support (NET [= y])
     -&gt; Networking options
       -&gt; Network packet filtering framework (Netfilter) (NETFILTER [= y])
         -&gt; Core Netfilter Configuration
           -&gt; Netfilter Xtable support (required for ip_tables) (NETFILTER_XTABLES [= y])
             -&gt; "physdev" match support (NETFILTER_XT_MATCH_PHYSDEV [= y])
</pre><br><br>  In addition, the kernel configuration must allow the transfer of packets for iptables filtering, i.e.  bridge-nf-call-iptables = 1 and bridge-nf-call-ip6tables = 1 (if you use IPv6). <br>  Then you can use, for example, the following rules for filtering: <br><br><pre>   iptables -A FORWARD -p tcp --dport 22 -m physdev --physdev-in eth1 --physdev-out eth0 -j ACCEPT
</pre><br>  In more detail about setup of filtering between ports of a post it is possible to read in the article <a href="http://bwachter.lart.info/linux/bridges.html">Building bridges with Linux</a> <br><br>  If you do not want to make any distinction between LAN users and bridged VPN users, you can simply turn off these settings in the kernel (they are enabled by default): <br><br><pre>   echo "net.bridge.bridge-nf-call-iptables = 0" &gt;&gt; /etc/sysctl.conf echo "net.bridge.bridge-nf-call-ip6tables = 0" &gt;&gt; /etc/sysctl.conf </pre><br><br><h3>  Customers </h3><br>  On the client, you need to create an OpenVPN configuration file with the following content: <br><br><pre>   client
   nobind
   dev tap
   proto udp
   # Where to connect.  You can specify several remote options - the first available server will be used.  If there are several A-records for server.example.net, they are randomly selected between them.
   remote server.example.net 1194
   # Never give up, try to connect endlessly.
   resolv-retry infinite
   # Either all options together or none of them
   persist-key
   persist tun
   user nobody
   group nogroup
   comp-lzo
   ns-cert-type server
   ca ca.crt
   cert client.crt
   key client.key
</pre><br><br>  If the server is connected through several providers, you can increase the network resilience to failures.  To do this, the client needs to register several remote options, one per server, in the order of ‚Äúfirst preferred‚Äù. <br><br>  The file names specified in the parameters ca, cert and key are files transferred via a secure channel.  The permissions of the key file must be set to 600. <br><br><h4>  Linux </h4><br>  A universal tun / tap driver is required in the kernel, or as a module, but loaded. <br><br><h5>  Gentoo </h5><br>  When you install net-misc / openvpn, the /etc/init.d/openvpn script is created.  This script runs openvpn with the /etc/openvpn/openvpn.conf configuration file.  However, we can support several OpenVPN configurations at the same time, if we make symlinks like /etc/init.d/openvpn.network-name -&gt; /etc/init.d/openvpn - each such script runs OpenVPN with the configuration file / etc / openvpn /network-name.conf. <br><br>  Accordingly, we put the above config there, create a symlink and put the scripts in a subdirectory in / etc / openvpn /.  In the config, write the full path to the key and certificates.  Make sure that the file names in the config do not overlap, in order to avoid unpleasant effects! <br><br>  The start and stop of the network are done through the management of the /etc/openvpn.network-name service. <br><br><h4>  Windows </h4><br>  The configuration file is placed in the ‚ÄúC: \ Program Files \ OpenVPN \ config \‚Äù directory with a name like ‚Äúoffice.ovpn‚Äù, the rest of the files - keys and certificates are also placed there.  If we put them in a subdirectory (for example, we want to use several virtual networks and they all provided files with the same name ca.crt), we specify the full paths to the files. <br><br>  To start networks, you can either start the OpenVPN service (then all the * .ovpn configurations found in the config \ will be launched), or individually - click on the .ovpn file with the right button and select "Run OpenVPN with this configuration". <br><br><h3>  Possible problems </h3><br>  You can check the availability of the server, if it is running on TCP, by using ordinary telnet. <br><br><h4>  Windows </h4><br><h5>  No free virtual TAP adapter </h5><br><pre> Wed Dec 31 10:43:51 2008 TCP connection established with 88.83.201.253:1194 
 Wed Dec 31 10:43:51 2008 TCPv4_CLIENT link local: [undef] 
 Wed Dec 31 10:43:51 2008 TCPv4_CLIENT link remote: 88.83.201.253:1194 
 Wed Dec 31 10:44:51 2008 TLS Error: TLS key negotiation failed to occur within 60 seconds (check your network connectivity) 
 Wed Dec 31 10:44:51 2008 TLS Error: TLS handshake failed 
 Wed Dec 31 10:44:51 2008 Fatal TLS error (check_tls_errors_co), restarting 
 Wed Dec 31 10:44:51 2008 SIGUSR1 [soft, tls-error] received, process restarting 
 Wed Dec 31 10:44:56 2008 IMPORTANT: OpenVPN's port number is now 1194, based on the official port number assignment by IANA.  OpenVPN 2.0-beta16 and earlier used 5000 as the default port. 
 Wed Dec 31 10:44:56 2008 Re-using SSL / TLS context 
 Wed Dec 31 10:44:56 2008 LZO compression initialized 
 Wed Dec 31 10:44:56 2008 Attempting to establish TCP connection with 88.83.201.253:1194 
 Wed Dec 31 10:44:56 2008 TCP connection established with 88.83.201.253:1194 
 Wed Dec 31 10:44:56 2008 TCPv4_CLIENT link local: [undef] 
 Wed Dec 31 10:44:56 2008 TCPv4_CLIENT link remote: 88.83.201.253:1194 
 Wed Dec 31 10:45:11 2008 [office] Peer Connection Initiated with 88.83.201.253:1194 
 Wed Dec 31 10:45:13 2008 All TAP-Win32 adapters on this system are currently in use. 
 Wed Dec 31 10:45:13 2008 Exiting 
 Press any key to continue ...
</pre><br>  The OpenVPN log shows that the client successfully joined the server, logged in, but could not bind the virtual network to the virtual adapter.  Most likely, some other processes have already installed all the TAP-Win32 adapters in the system.  It could be OpenVPN itself, which hung and did not give up the adapter. <br><br>  It is treated by rebooting or finding out what processes and killing them could be. <br><br><h3>  Links </h3><br>  When writing this article, the following sources were used: <br><ol><li>  <a href="http://gentoo-wiki.com/HOWTO_OpenVPN_Server_for_Ethernet_Bridging_with_Server_Certificates">Gentoo Linux Wiki - OpenVPN Server for Ethenet Bridging with Server Certificates</a> (There is a copy of this page at: <a href="http://www.gentoo-wiki.info/HOWTO_OpenVPN_Server_for_Ethernet_Bridging_with_Server_Certificates">http://www.gentoo-wiki.info/HOWTO_OpenVPN_Server_for_Ethernet_Bridging_with_Server_Certificates</a> . Thank you <a href="http://habrahabr.ru/users/hexes/" class="user_link">hexes</a> for the link!) </li><li>  <a href="http://gentoo-wiki.com/HOWTO_OpenVPN_Linux_Server_Windows_Client">Gentoo Linux Wiki - HOWTO OpenVPN Linux Server Windows Client</a> </li><li>  <a href="http://openvpn.net/index.php/documentation/howto.html">OpenVPN Documentation - HOWTO</a> </li><li>  <a href="http://www.protocols.ru/modules.php%3Fname%3DNews%26file%3Darticle%26sid%3D61">Network protocols encyclopedia - sysctl options for IP stack</a> </li><li>  <a href="http://bwachter.lart.info/linux/bridges.html">Building bridges with Linux</a> </li></ol><br><br>  <b>PS</b> Some sources have fallen.  I will not remove links, but it is worth bearing in mind. </div><p>Source: <a href="https://habr.com/ru/post/67238/">https://habr.com/ru/post/67238/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../67232/index.html">Sibirtelecom and anlim</a></li>
<li><a href="../67233/index.html">MT Browser Switcher - for those who use multiple browsers</a></li>
<li><a href="../67234/index.html">How to make Yandex.Disk unlimited file storage system</a></li>
<li><a href="../67235/index.html">Scammers are not asleep!</a></li>
<li><a href="../67237/index.html">ESET on the Meeting of the System Administrators</a></li>
<li><a href="../67239/index.html">What file systems do you use and why them?</a></li>
<li><a href="../67242/index.html">Non-Apple Products</a></li>
<li><a href="../67244/index.html">My password manager with chess and poetess. And sync</a></li>
<li><a href="../67247/index.html">FCKEditor vs Opera - Hanging dialogs</a></li>
<li><a href="../67250/index.html">IOI-2009: another triumph of Gena Korotkevich</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>