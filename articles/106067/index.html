<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developing web applications in Common Lisp (part three)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This review is a small guide for those who decide (or decide) to entrust the future of their startup to this wonderful language. Despite the fact that...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developing web applications in Common Lisp (part three)</h1><div class="post__text post__text-html js-mediator-article">  This review is a small guide for those who decide (or decide) to entrust the future of their startup to this wonderful language.  Despite the fact that the main focus will be on web development, I will try to cover also more general topics related to Common Lisp in one way or another.  The material will be gathered from my own experience in developing the <a href="https://www.altermoby.com/about%3Flanguage%3Dru%26source%3Dhabr">AlterMoby</a> web service. <br><br>  The third part of this review will be devoted to the Hunchentoot web server.  Consider its architecture and basic features.  In addition, we will touch on some related issues, in particular, the generation of HTML / XML. <br><br><img src="https://habrastorage.org/storage/habraeffect/ba/ce/bacef3391c2615f44a3e25555fcd75a7.jpg" alt="image"><br><a name="habracut"></a><br><h4>  Choosing a web server </h4><br>  After deploying a minimal Lisp system in the <a href="http://habrahabr.ru/blogs/webdev/105215/">last part of</a> this review, it's time to choose a web server.  This question is not obvious - the same CLiki gives links to 7 different libraries.  When I chose a web server for work, it was based on several factors.  First, it must be known in the CL-community, supported by a wide range of enthusiasts and be up to date until the present time.  Secondly, at least one prospective web framework should be based on it.  In addition, it is advisable to verify the presence of commercially successful sites based on it.  Based on these criteria, only two products fell into my field of vision: Portable AllegroServ and Hunchentoot. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="http://portableaserve.sourceforge.net/">Portable AllegroServ</a> is a version of <a href="http://allegroserve.sourceforge.net/">AllegroServ</a> - the original web server, written specifically for Allegro CL.  The source code of the latter is not compatible with Common Lisp, since it uses non-standard extensions of the native compiler.  The fact is that the author AllegroServ sought to achieve maximum efficiency, and therefore was forced to deviate from a strict standard.  The result was a fast and elegant web-server, which, to this day, is probably the best choice for Allegro CL.  Since the AllegroServ source code was released under the LLGPL license, there were enthusiasts who adapted it to the standard Common Lisp.  The resulting product was called the Portable AllegroServ.  According to some lispers, the latter is inferior to the original, both in performance and reliability. <br><br>  The protagonist of this part of our review, the web-server with the strange name <a href="http://weitz.de/hunchentoot/">Hunchentoot</a> was initially oriented towards standard Common Lisp.  Therefore, it can work ‚Äúright out of the box‚Äù with most popular compilers.  For me, the essential argument in favor of Hunchentoot was also the fact that a promising <a href="http://common-lisp.net/project/cl-weblocks/">Weblocks</a> web framework is based on it.  Despite the fact that I ultimately refused to use this framework in my project, Hunchentoot did not disappoint me at all.  Next, we consider the structure and functionality of this beautiful product. <br><br><h4>  Meet the Hunchentoot </h4><br>  First of all, make sure that we have installed Hunchentoot: <br><br> <code>( <font color="#19177C">asdf:oos</font> <font color="#19177C">'asdf:load-op</font> <font color="#19177C">:hunchentoot</font> )</code> <br> <br>  Now create and run an instance of the class <i>acceptor</i> - the receiver of http requests: <br><br> <code>( <font color="#19177C">hunchentoot:start</font> ( <font color="#008000">make-instance</font> <font color="#19177C">'hunchentoot:acceptor</font> <font color="#19177C">:port</font> <font color="#666666">8080</font> ))</code> <br> <br>  In order for Hunchentoot to accept https requests, you need to replace the <i>'acceptor</i> with <i>' the ssl-acceptor</i> (its descendant), <i>remembering</i> to specify the certificate and key files. <br><br>  Consider the simplest handler taken from the Hunchentoot help: <br><br> <code>( <font color="#19177C">hunchentoot:define-easy-handler</font> ( <font color="#19177C">say-yo</font> <font color="#19177C">:uri</font> <font color="#BA2121">"/yo"</font> ) ( <font color="#19177C">name</font> ) <br> ( <font color="#008000">setf</font> ( <font color="#19177C">hunchentoot:content-type*</font> ) <font color="#BA2121">"text/plain"</font> ) <br> ( <font color="#008000">format</font> <font color="#880000">nil</font> <font color="#BA2121">"Hey~@[ ~a~]!"</font> <font color="#19177C">name</font> ))</code> <br> <br>  This handler is called say-yo, binds to the URL / yo and accepts a single name parameter (via GET or POST).  The handler generates a text document containing ‚ÄúHey name!‚Äù, Where name is the value of the name parameter, or simply ‚ÄúHey!‚Äù If the name parameter is not specified (i.e. equals nil).  If you are embarrassed by the intricacy of string formatting, familiarize yourself with the directives of the <a href="http://lisper.ru/pcl/a-few-format-recipes"><i>format</i></a> function.  Check the operation of this handler by going to / yo and / yo? Name = Vasia. <br><br>  Instead of text, the handler can give the desired file: <br><br> <code>( <font color="#19177C">hunchentoot:define-easy-handler</font> ( <font color="#19177C">get-file</font> <font color="#19177C">:uri</font> <font color="#BA2121">"/file"</font> ) ( <font color="#19177C">name</font> ) <br> ( <font color="#19177C">handle-static-file</font> ( <font color="#008000">format</font> <font color="#880000">nil</font> <font color="#BA2121">"/home/me/folder/~a"</font> <font color="#19177C">name</font> ))</code> <br> <br>  In principle, this functionality should be enough for writing a small amateur crafts.  More serious work will require to give up the <i>define-easy-handler</i> macro, having understood the query dispatch mechanism.  We outline the main features of the latter. <br><br>  Each instance of the <i>acceptor</i> class (and hence the <i>ssl-acceptor class</i> ) corresponds to a <b>query manager</b> .  The request manager is a function that accepts an instance of the <i>request</i> class (http request) and returns the output http stream (HTML / XML or binary data).  Since the output stream depends on the specified URL, in practice the request manager does not generate it, but searches for the corresponding handler, to which it delegates this role.  By default, the query manager scans the <i>dispatch-table *</i> list containing <b>the dispatch functions</b> .  Each dispatch function receives the request object, analyzes it according to its criteria, and if it does match, returns a <b>handler</b> , a function that generates an output stream (if non-matching returns nil).  Thus, the standard query dispatcher in turn starts the dispatch functions until one of them returns a handler.  At the end of the <i>* dispatch-table *</i> usually the <i>default dispatch</i> is located - the dispatching function that always returns a handler (by default, this is a message about a page that is not found). <br><br>  The dispatching scheme described above may seem somewhat complicated, however, in practice such a structure allows for greater flexibility.  In particular, the return handler approach allows writing elegant dispatch functions.  Dispatch handlers created by <i>define-easy-handlers macro</i> use this standard schema: <i>* dispatch-table *</i> contains <i>dispatch-easy-handlers</i> dispatch function.  The latter implements its simplified dispatcher, searching in its own internal list.  This list contains descriptions of all handlers defined with <i>define-easy-handlers</i> .  Thus, dispatching can be divided into many independent branches with its own handler selection logic. <br><br>  Hunchentoot defines several <b>generators of standard dispatch functions</b> , as well as some <b>standard handlers</b> .  For example, <i>create-prefix-dispatcher</i> at a given URL prefix and handler generates a dispatching function that checks URL requests for compliance with the specified prefix.  The <i>create-regex-dispatcher</i> function is similar to the previous one, but it generates a dispatch function that maps URLs to a given regular expression pattern.  The <i>create-folder-dispatcher-and-handler</i> function accepts a URL prefix and directory path, returning a dispatch function that distributes files from a given directory.  The standard handlers include the <i>handle-static-file</i> used by us in the get-file definition. <br><br>  The flexibility of Common Lisp allows you to redefine existing functions and methods on the fly, which cannot but contribute to Hunchentoot‚Äôs flexibility.  This way, you can not only create a new descendant of the <i>acceptor</i> class, but also override the default dispatcher, completely abandoning the handler search scheme described above, or completely change the query processing logic.  For example, in the course of working on my project, I made Hunchentoot check the format of multipart / form-data requests even in the process of downloading data, and not after they were fully accepted.  This avoids a situation where many machines post multi-megabyte garbage to the server during a DoS attack. <br><br>  As a powerful and modern web server, Hunchentoot supports many standard features.  These include support for cookies, convenient debugging and logging, and much more.  A description of this functionality can be found on its web page. <br><br><h4>  HTML / XML generation </h4><br>  To conclude this part of our review, consider the <a href="http://weitz.de/cl-who/">CL-WHO</a> library, which defines a simple and convenient DSL for generating HTML / XML.  As usual, it is better to see once: <br><br> <code>( <font color="#008000">push</font> <font color="#19177C">:tag3</font> <font color="#19177C">*html-empty-tags*</font> ) <br> ( <font color="#19177C">with-html-output-to-string</font> ( <font color="#19177C">http-stream</font> ) <br> ( <font color="#19177C">:tag1</font> <font color="#19177C">:attr1</font> <font color="#666666">1</font> <font color="#19177C">:attr2</font> <font color="#BA2121">"2"</font> <br> ( <font color="#19177C">:tag2</font> <font color="#19177C">:attr3</font> ( <font color="#008000">+</font> <font color="#666666">1</font> <font color="#666666">2</font> )) <br> ( <font color="#008000">loop</font> <font color="#19177C">for</font> <font color="#19177C">i</font> <font color="#19177C">from</font> <font color="#666666">1</font> <font color="#19177C">to</font> <font color="#666666">3</font> <font color="#008000">do</font> <br> ( <font color="#19177C">with-html-output</font> ( <font color="#19177C">http-stream</font> ) <br> ( <font color="#19177C">:tag3</font> <font color="#19177C">:attr4</font> ( <font color="#008000">when</font> ( <font color="#008000">oddp</font> <font color="#19177C">i</font> ) <font color="#BA2121">"odd"</font> ))))))</code> <br> <br>  The result of this design does not contradict intuition: <br><br> <code><font color="#BA2121">"&lt;tag1 attr1='1' attr2='2'&gt;&lt;tag2 attr3='3'&gt;&lt;/tag2&gt; <br> &lt;tag3 attr4='odd' /&gt;&lt;tag3 /&gt;&lt;tag3 attr4='odd' /&gt;&lt;/tag1&gt;"</font></code> <br> <br>  As you can see, the <i>with-html-output-to-string</i> macro builds an XML construct from opening and closing tags corresponding to the given s-expression.  The first command adds tag3 to the list of single tags.  For such a tag, in the absence of attachments, a closing tag will not be generated.  Next, the <i>with-html-output-to-string</i> macro is called, which is a wrapper for <i>with-html-output</i> - the main CL-WHO macro.  From the example we see that arbitrary control structures are allowed for automating code generation. <br><br>  The result string was created in XML mode.  In this mode, it is worth generating XML / XHTML documents.  To work with HTML, there is an SGML mode in which empty tags do not contain a closing slash, and attributes can be without values.  As in the case of Hunchentoot for more in-depth acquaintance with the CL-WHO I send you to her web page. </div><p>Source: <a href="https://habr.com/ru/post/106067/">https://habr.com/ru/post/106067/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../106059/index.html">Microsoft announces software to synchronize Windows Phone 7 devices with Macs</a></li>
<li><a href="../106061/index.html">Caution - unauthorized traffic!</a></li>
<li><a href="../106063/index.html">Data synchronizer Developer note</a></li>
<li><a href="../106064/index.html">USA</a></li>
<li><a href="../106066/index.html">Five favorite iPad apps for primary school</a></li>
<li><a href="../106068/index.html">Developers, Developers, Developers! Direct broadcast of PDC 2010 in Moscow pub</a></li>
<li><a href="../106070/index.html">HTC does not give preference to WP 7 or Android</a></li>
<li><a href="../106071/index.html">Should I make the project‚Äôs home page in a minimalist style?</a></li>
<li><a href="../106072/index.html">Sony announced TVs that support Google TV</a></li>
<li><a href="../106073/index.html">Career plateau</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>