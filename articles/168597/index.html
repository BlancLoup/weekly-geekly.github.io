<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Undocumented Microsoft SQL Server features: STATISTICS_ONLY, DBCC AUTOPILOT and SET AUTOPILOT</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you know, the SQL Server query optimizer uses a cost estimate to build an optimal query execution plan. SQL Server builds and evaluates multiple pl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Undocumented Microsoft SQL Server features: STATISTICS_ONLY, DBCC AUTOPILOT and SET AUTOPILOT</h1><div class="post__text post__text-html js-mediator-article">  As you know, the SQL Server query optimizer uses a cost estimate to build an optimal query execution plan.  SQL Server builds and evaluates multiple plans and selects a minimum cost plan among them. <br><br>  One of the problems that we occasionally encounter is that in order to understand how a new index will affect the execution of a particular query, we need to create this index.  Sometimes, especially when the table is very large, the process of creating an index is so slow that it turns into a real nightmare.  Moreover, after 20 minutes of waiting, we may well find that the newly created index, when the query is executed, is not used at all. <br><br>  Actually, the question is how to create a ‚Äúhypothetical‚Äù index?  Just to check whether such an index will be useful when performing a query. <br><a name="habracut"></a><br><h5>  WITH STATISTICS_ONLY </h5><br>  To create a hypothetical index, we can use the undocumented feature of the CREATE INDEX command.  For example: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> AdventureWorksDW <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> ix_FirstName <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> DimCustomer(FirstName) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> STATISTICS_ONLY = <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  As a result, statistics on this index will be created (a histogram has been constructed and density calculated) and an entry will appear in sys.indexes.  You can check this with sp_helpindex and DBCC SHOWSTATISTICS: <br><br><pre> <code class="sql hljs">sp_HelpIndex DimCustomer</code> </pre><br><img src="https://habrastorage.org/storage2/ed0/221/43d/ed022143df6721d0bddd6a5b9dd03e3e.png"><br><br><pre> <code class="sql hljs">DBCC SHOW_STATISTICS(DimCustomer, ix_FirstName)</code> </pre><br><img src="https://habrastorage.org/storage2/e2d/355/432/e2d3554322be1f61c23fef1f2697efe1.png"><br>  Benjamin Nevares describes these hypothetical indices <a href="http://sqlblog.com/blogs/ben_nevarez/archive/2009/11/11/database-engine-tuning-advisor-and-the-query-optimizer.aspx">here</a> . <br><br>  PS If you create an index using WITH STATISTICS_ONLY = 0, SQL Server will not generate statistics.  Only hypothetical index. <br><br><h5>  DBCC AUTOPILOT and SET AUTOPILOT </h5><br>  Now we have a hypothetical index, how do we use it? <br><br>  You can try to specify it explicitly using the hint: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DimCustomer <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>=ix_FirstName) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> FirstName = N<span class="hljs-string"><span class="hljs-string">'Eugene'</span></span></code> </pre><br>  and get the error: <br> <code>Msg 308, Level 16, State 1, Line 1 <br> Index 'ix_FirstName' on table 'DimCustomer' (specified in the FROM clause) does not exist.</code> <br> <br>  And if you specify the Index ID? <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DimCustomer <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>=<span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> FirstName = N<span class="hljs-string"><span class="hljs-string">'Eugene'</span></span></code> </pre><br>  Same: <br> <code>Msg 307, Level 16, State 1, Line 1 <br> Index ID 5 on table 'DimCustomer' (specified in the FROM clause) does not exist.</code> <br> <br>  So how can we create a query plan that takes this index into account? <br><br>  This is where the fun begins. <br><br>  DBCC AUTOPILOT is used to tell the optimizer that when drawing up a plan it is necessary to take into account the existence of a certain index.  This DBCC, together with the SET AUTOPILOT ON flag, allows us to use this index. <br><br>  Let's look at the syntax of this command: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> AUTOPILOT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>|<span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-comment"><span class="hljs-comment">/* DBCC TRACEON (2588) DBCC HELP('AUTOPILOT') */</span></span> DBCC AUTOPILOT (typeid [, dbid [, {maxQueryCost | tabid [, indid [, pages [, flag [, rowcounts]]]]} ]])</code> </pre><br><h5>  We are testing </h5><br>  So, let's see how it all works. <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- Current Cost = 0,762133 -- Clustered Index Scan on pk SELECT * FROM DimCustomer WHERE FirstName = N'Eugene' GO</span></span></code> </pre><br><img src="https://habrastorage.org/storage2/b38/c40/495/b38c40495245c256752f33be601e96d5.png"><br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- creating the index -- DROP INDEX ix_FirstName ON DimCustomer CREATE INDEX ix_FirstName ON DimCustomer(FirstName) WITH STATISTICS_ONLY = -1 GO -- Looking at the info necessary in the DBCC AUTOPILOT comand SELECT name, id, Indid, Dpages, rowcnt FROM sysindexes WHERE id = object_id('DimCustomer') GO</span></span></code> </pre><br><img src="https://habrastorage.org/storage2/a28/ea3/39f/a28ea339fa996fc9deb7873e452d7c40.png"><br><br><pre> <code class="sql hljs">DBCC AUTOPILOT (5, 9, 0, 0, 0, 0, 0) <span class="hljs-comment"><span class="hljs-comment">-- Starting with the TypeID 5 DBCC AUTOPILOT (6, 9, 37575172, 1, 0, 0, 0) -- Clustered Index with TypeID 6 DBCC AUTOPILOT (0, 9, 37575172, 2, 0, 0, 0) -- All other index with TypeID 0 DBCC AUTOPILOT (0, 9, 37575172, 3, 0, 0, 0) -- All other index with TypeID 0 DBCC AUTOPILOT (0, 9, 37575172, 5, 0, 0, 0) -- All other index with TypeID 0 GO SET AUTOPILOT ON GO -- Query to create the estimated execution plan with the cost = 0,0750712 SELECT * FROM dbo.DimCustomer WHERE FirstName = N'Eugene' OPTION (RECOMPILE) GO SET AUTOPILOT OFF GO</span></span></code> </pre><br>  <i>approx.</i>  <i>of the translator: What the TypeID parameter is, of course, is unknown, in another of his articles, the link to which is below, the same author writes that to use a particular index in the autopilot mode, you need to specify 0</i> <br><img src="https://habrastorage.org/storage2/be6/65a/58c/be665a58ce74288711e26e41a7ed7d45.png"><br><img src="https://habrastorage.org/storage2/669/6aa/2ea/6696aa2ea28f52b569c7dd863ebb300a.png"><br>  You can also fool the optimizer by passing arbitrary values ‚Äã‚Äãto DBCC AUTOPILOT as the Pages and RowCount parameters.  If you pass them equal to zero, the values ‚Äã‚Äãused are the same as for the cluster index. <br><br><h5>  findings </h5><br>  There are enough white spots in the description of these features, but I am sure that this post will be a good starting point for your own tests. <br><br>  I'm still playing with this thing, so you can calmly ask me questions, or share my discoveries. <br><br>  And you don‚Äôt need to say that you don‚Äôt have to use all this on production servers?  This is an undocumented opportunity, so no one can tell you exactly what and how it does, until the guys from Microsoft make it officially public and documented. <br><br>  <i>From the translator:</i> <i><br></i>  <i>Joining the author, I remind you that the use of undocumented functionality in a working environment can lead to undesirable consequences.</i> <i><br></i>  <i>Also, I want to add another link to the same author: <a href="http://www.simple-talk.com/sql/database-administration/hypothetical-indexes-on-sql-server/">Hypothetical Indexes on SQL Server</a> .</i>  <i>This is a newer, enhanced version of the same post.</i>  <i>Why did I not translate it?</i>  <i>Because they have the same essence, the main difference is that in the new version, it offers the CLR assembly, for more simple use of the DBCC AUTOPILOT, which, in my opinion, is not significant.</i> <i><br></i>  <i>All the code and all the screenshots were taken by me from the author, on my SQL Server 2005 SP4 it required minimal doping (for example, using WITH STATISTICS_ONLY instead of WITH STATISTICS_ONLY = -1), so everything should work on SQL Server 2005 and later (namely, starting from 2005 server, used by Database Tuning Advisor, which, presumably, uses this functionality).</i> <i><br></i>  <i>As usual, any suggestions and corrections for translation and style are welcome.</i> <i><br></i> </div><p>Source: <a href="https://habr.com/ru/post/168597/">https://habr.com/ru/post/168597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../168587/index.html">Now you can ask the company to fill in your description.</a></li>
<li><a href="../168589/index.html">The camera module for the Raspberry Pi will cost $ 25 and shoot FullHD video</a></li>
<li><a href="../168591/index.html">Regular Expression Crossword</a></li>
<li><a href="../168593/index.html">Analysis of the genome of bacteria. Continuation</a></li>
<li><a href="../168595/index.html">Step-by-step guide on "How to take the Cisco exam?"</a></li>
<li><a href="../168599/index.html">GetUpps! - application store for MegaFon subscribers</a></li>
<li><a href="../168601/index.html">PostgreSQL 9.2 Start!</a></li>
<li><a href="../168603/index.html">Microsoft accuses Google of reading user letters</a></li>
<li><a href="../168605/index.html">Mini flowmaster overview</a></li>
<li><a href="../168607/index.html">Death Package for Intel Network Cards</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>