<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NooLite + Raspberry Pi + Telegram = smart home</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="2 years ago, I was faced with the task of implementing remote control of heaters in my country house. In this article I want to share my version of au...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NooLite + Raspberry Pi + Telegram = smart home</h1><div class="post__text post__text-html js-mediator-article"><p>  2 years ago, I was faced with the task of implementing remote control of heaters in my country house.  In this article I want to share my version of automation and remote control, to which I eventually came.  I will try to cover the whole process and details of creating this hobby project and share all the difficulties that I had to face.  In the process of implementation, as the name of the article shows, I used Noolite (I‚Äôll talk about it in the article), Telegram, and quite a bit of Python. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e4c/7b1/a22/e4c7b1a22d2f498685038984fdb8ae69.png" alt="image"></div><a name="habracut"></a><br><h1 id="vvedenie">  Introduction </h1><br><p>  This project originates in 2014, when I faced the task of providing remote control of heaters in my country house.  The fact is that almost every weekend we spend with our family in the country.  And if in the summer we, having lingered for one reason or another in the city, when we arrived at the house, could immediately go to bed, in the winter, when the temperature drops to -30 degrees, I had to spend 3-4 hours for the heating of the house.  I have seen the following solutions to this problem: </p><br><ol><li><p>  <em>"Stupid solution"</em> - you can leave the heaters with built-in thermostats on at the minimum temperature for maintaining heat.  Actually there is nothing ‚Äúsmart‚Äù in this decision, but 24/7 working heaters in a wooden country house do not inspire confidence.  I wanted at least minimal control over their condition, automation, and some feedback; </p><br></li><li><p>  <em>GSM sockets</em> - my neighbors in the dacha use this solution.  If someone is not familiar with them, then this is just an adapter controlled via SMS commands that is plugged into the outlet, and the heater itself is plugged into it.  Not the most budget solution, if you need to provide heating of the whole house - a <a href="https://market.yandex.ru/catalog/56404/list%3Fwas_redir%3D1%26srnum%3D101%26suggest%3D2%26hid%3D91700%26text%3Dgsm%2520%25D1%2580%25D0%25BE%25D0%25B7%25D0%25B5%25D1%2582%25D0%25BA%25D0%25B0%26deliveryincluded%3D0%26onstock%3D1">link to the market</a> .  I see it as the simplest and less labor-consuming to implement, but having disadvantages during operation, such as: a whole bunch of SIM cards and work on maintaining their positive balance, since each room needs at least one heater, the limitations and inconveniences of controlling them SMS; </p><br></li><li>  <em>"Smart Home"</em> - the actual solution, built on the implementation of "smart home". </li></ol><br><p>  As the most promising solution, I chose the third option and the next question on the agenda was ‚ÄúWhich platform for implementation to choose?‚Äù. </p><br><p>  I don‚Äôt remember how much time I spent searching for suitable options, but in the end I found the following systems from the budget and affordable solutions in stores: <a href="http://www.noo.com.by/">NooLite</a> and <a href="http://www.trustsmarthome.com/ru/home-ru/">CoCo</a> (now renamed Trust).  When comparing them, the decisive role for me was played by the fact that NooLite has an open and documented API for managing any of its blocks.  At that time there was no need for it, but I immediately noted how much further flexibility this can give.  And the price of NooLite was significantly lower.  In the end, I opted for NooLite. </p><br><h1 id="realizaciya-1---avtomatizaciya-noolite">  Implementation 1 - NooLite automation </h1><br><p>  The NooLite system consists of power modules (for different types of loads), sensors (temperature, humidity, movement) and equipment controlling them: radio consoles, wall switches, USB adapters for a computer or PR1132 Ethernet gateway.  All this can be used in various combinations, connected to each other directly or managed via usb adapters or a gateway, you can read more about it on the official website of the manufacturer. </p><br><p>  For my task, I chose the PR1132 Ethernet gateway, which will control the power units and receive information from the sensors, as the central element of the smart home.  For the Ethernet gateway to work, you need to connect it to the network with a cable, there is no Wi-Fi support in it.  At that time, a network consisting of the Asus rt-n16 WiFi router and a USB modem for accessing the Internet was already organized in my house.  Therefore, for me, the entire installation of NooLite was only to connect the gateway with a cable to the router, locate the temperature sensors in the house and mount the power units in the central electric panel. </p><br><p>  <em>NooLite has a number of power units for different pluggable loads.</em>  <em>The most powerful unit can control loads up to 5000 watts.</em>  <em>If more load control is required, as in my case, then a load connection can be made via a controlled relay, which, in turn, will be controlled by the NooLite power unit.</em> </p><br><img src="https://habrastorage.org/files/5a0/81f/24b/5a081f24b66b4ebd8b194f33a6856840.png" alt="image"><br><p>  <i>Wiring diagram</i> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b75/d71/cb2/b75d71cb2a4c4e899899d3071653eebf.png" alt="image"></div><br><p>  <i>PR1132 Ethernet gateway and Asus rt-n16 router</i> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5c8/510/c81/5c8510c814ff422ab6b299f3454f55c6.png" alt="image"></div><br><p>  <i>Wireless temperature and humidity sensor PT111</i> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9cc/5ef/ef4/9cc5efef40d745f5976b37057c5de70f.png" alt="image"></div><br><p>  Electrical panel and power unit for external installation of the SR211 - in the future, instead of this unit, I used the unit for internal installation and placed it directly in the electrical panel </p><br><p>  Ethernet gateway PR1132 has a web-interface through which the binding / decoupling of power units, sensors and their management is carried out.  The interface itself is made in a rather "clumsy" minimalist style, but this is quite enough for access to all the necessary functionality of the system: </p><br><img src="https://habrastorage.org/files/fbd/bec/a13/fbdbeca13fe944ef9a840654eb676182.png" alt="image"><br><p>  <i>Settings</i> </p><br><img src="https://habrastorage.org/files/f4d/798/b9a/f4d798b9a17a4f89844cb5d2faf3d1c5.png" alt="image"><br><p>  <i>Control</i> </p><br><img src="https://habrastorage.org/files/b3f/5f7/162/b3f5f71621da427a91bd1cc8bd487aff.png" alt="image"><br><p>  <i>Page one switch group</i> </p><br><p>  Details on the binding and configuration of all this - again on the official website. </p><br><p>  At that time I could: </p><br><ul><li>  manage the heaters, while in the local network of a country house, which was not very useful, based on the initial task; </li><li>  create on / off timers by time and day of the week. </li></ul><br><p>  Just timers of automation for some time solved my initial task.  On Friday morning and afternoon, the heaters were turned on, and by the evening we were arriving at a warm house.  In case our plans change, a second timer was set up, which turned off the batteries closer to the night. </p><br><h1 id="realizaciya-2---udalennyy-dostup-k-umnomu-domu">  Implementation 2 - remote access to smart home </h1><br><p>  The first implementation allowed me to partially solve my problem, but still I wanted to control the online home and the availability of feedback.  I started looking for options for organizing access to the dacha network from outside </p><br><p> As I mentioned in the previous section, the dacha network has access to the Internet via a usb modem from one of the mobile operators.  By default, mobile modems have a gray ip address and cannot receive a white fixed ip without additional monthly expenses.  With such a gray IP, various no-ip services will not help either. </p><br><p>  The only option that I managed to come up with at the time was VPN.  I had a VPN server configured on the city router, which I used from time to time.  I needed to configure a VPN client on the country router and register static routes to the country network. </p><br><img src="https://habrastorage.org/files/9d9/caf/148/9d9caf148f5a481a87b2971db7f857ac.png" alt="image"><br><p>  <i>Wiring diagram</i> </p><br><p>  As a result, the country router kept the VPN connection to the city router and in order to access the NooLite gateway, I needed to connect from the client device (laptop, phone) via VPN to the city router. </p><br><p>  At this stage I could: </p><br><ul><li>  get access to smart home from any place; </li></ul><br><p>  In general, it is almost 100% cover the original task.  However, I understood that this implementation is far from optimal and easy to use, since every time I had to perform a number of additional actions on connecting to a VPN.  For me it was not a particular problem, but for the rest of the family it was not very convenient.  Also in this implementation there were a lot of intermediaries, which affected the resiliency of the entire system as a whole.  However, for some time I stopped on this version. </p><br><h1 id="realizaciya-3---telegram-bot">  Implementation 3 - Telegram bot </h1><br><p>  With the advent of bots in Telegram, I took note that this could be a fairly convenient interface for managing a smart home and, as soon as I had enough free time, I started developing in Python 3. </p><br><p>  The bot should have been somewhere and, as the most energy-efficient solution, I chose the Raspberry Pi.  Although this was my first experience with him, there was no particular difficulty in setting it up.  The image on the memory card, ethernet cable to the port and via ssh is a full-fledged Linux. </p><br><p>  As I already said, NooLite has a documented API, which was useful to me at this stage.  First, I wrote a simple wrapper for more convenient interaction with the API: </p><br><div class="spoiler">  <b class="spoiler_title">noolite_api.py</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" NooLite API wrapper """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> requests.auth <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> HTTPBasicAuth <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> requests.exceptions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ConnectTimeout, ConnectionError <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> xml.etree.ElementTree <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ET <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NooLiteSens</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""    ,         """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, temperature, humidity, state)</span></span></span><span class="hljs-function">:</span></span> self.temperature = float(temperature.replace(<span class="hljs-string"><span class="hljs-string">','</span></span>, <span class="hljs-string"><span class="hljs-string">'.'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> temperature != <span class="hljs-string"><span class="hljs-string">'-'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> self.humidity = int(humidity) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> humidity != <span class="hljs-string"><span class="hljs-string">'-'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> self.state = state <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NooLiteApi</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""     NooLite"""</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, login, password, base_api_url, request_timeout=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">10</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> self.login = login self.password = password self.base_api_url = base_api_url self.request_timeout = request_timeout <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_sens_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   xml    :return:  NooLiteSens     :rtype: list """</span></span> response = self._send_request(<span class="hljs-string"><span class="hljs-string">'{}/sens.xml'</span></span>.format(self.base_api_url)) sens_states = { <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-string"><span class="hljs-string">' ,   '</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-string"><span class="hljs-string">'  '</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-string"><span class="hljs-string">'   '</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-string"><span class="hljs-string">'     '</span></span> } response_xml_root = ET.fromstring(response.text) sens_list = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> sens_number <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">4</span></span>): sens_list.append(NooLiteSens( response_xml_root.find(<span class="hljs-string"><span class="hljs-string">'snst{}'</span></span>.format(sens_number)).text, response_xml_root.find(<span class="hljs-string"><span class="hljs-string">'snsh{}'</span></span>.format(sens_number)).text, sens_states.get(int(response_xml_root.find(<span class="hljs-string"><span class="hljs-string">'snt{}'</span></span>.format(sens_number)).text)) )) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sens_list <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_command_to_channel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, data)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   NooLite    NooLite  url   data :param data: url  :type data: dict :return: response """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._send_request(<span class="hljs-string"><span class="hljs-string">'{}/api.htm'</span></span>.format(self.base_api_url), params=data) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_send_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, url, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   NooLite        url    kwargs :param url: url   :type url: str :return: response  NooLite   """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: response = requests.get(url, auth=HTTPBasicAuth(self.login, self.password), timeout=self.request_timeout, **kwargs) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ConnectTimeout <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: print(e) <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NooLiteConnectionTimeout(<span class="hljs-string"><span class="hljs-string">'Connection timeout: {}'</span></span>.format(self.request_timeout)) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ConnectionError <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: print(e) <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NooLiteConnectionError(<span class="hljs-string"><span class="hljs-string">'Connection timeout: {}'</span></span>.format(self.request_timeout)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> response.status_code != <span class="hljs-number"><span class="hljs-number">200</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NooLiteBadResponse(<span class="hljs-string"><span class="hljs-string">'Bad response: {}'</span></span>.format(response)) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response <span class="hljs-comment"><span class="hljs-comment">#   NooLiteConnectionTimeout = type('NooLiteConnectionTimeout', (Exception,), {}) NooLiteConnectionError = type('NooLiteConnectionError', (Exception,), {}) NooLiteBadResponse = type('NooLiteBadResponse', (Exception,), {}) NooLiteBadRequestMethod = type('NooLiteBadRequestMethod', (Exception,), {})</span></span></code> </pre> </div></div><br><p>  And then the <a href="https://github.com/python-telegram-bot/python-telegram-bot">bot itself</a> was written using the <a href="https://github.com/python-telegram-bot/python-telegram-bot">python-telegram-bot</a> package: </p><br><div class="spoiler">  <b class="spoiler_title">telegram_bot.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> functools <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> yaml <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> telnetlib <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> requests.exceptions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ConnectionError <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ReplyKeyboardMarkup, ParseMode <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Updater, CommandHandler, Filters, MessageHandler, Job <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> noolite_api <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> NooLiteApi, NooLiteConnectionTimeout,\ NooLiteConnectionError, NooLiteBadResponse <span class="hljs-comment"><span class="hljs-comment">#      config = yaml.load(open('conf.yaml')) #    logger = logging.getLogger() logger.setLevel(logging.INFO) formatter = logging.Formatter( '%(asctime)s - %(filename)s:%(lineno)s - %(levelname)s - %(message)s' ) stream_handler = logging.StreamHandler() stream_handler.setFormatter(formatter) logger.addHandler(stream_handler) #     NooLite updater = Updater(config['telegtam']['token']) noolite_api = NooLiteApi( config['noolite']['login'], config['noolite']['password'], config['noolite']['api_url'] ) job_queue = updater.job_queue def auth_required(func): """ """ @functools.wraps(func) def wrapped(bot, update): if update.message.chat_id not in config['telegtam']['authenticated_users']: bot.sendMessage( chat_id=update.message.chat_id, text=" .\n   /auth password." ) else: return func(bot, update) return wrapped def log(func): """ """ @functools.wraps(func) def wrapped(bot, update): logger.info('Received message: {}'.format( update.message.text if update.message else update.callback_query.data) ) func(bot, update) logger.info('Response was sent') return wrapped def start(bot, update): """    """ bot.sendMessage( chat_id=update.message.chat_id, text="    .\n" "   /auth password." ) def auth(bot, update): """    ,         """ if config['telegtam']['password'] in update.message.text: if update.message.chat_id not in config['telegtam']['authenticated_users']: config['telegtam']['authenticated_users'].append(update.message.chat_id) custom_keyboard = [ ['/_', '/_'], ['/_', '/_'], ['/'] ] reply_markup = ReplyKeyboardMarkup(custom_keyboard) bot.sendMessage( chat_id=update.message.chat_id, text=" .", reply_markup=reply_markup ) else: bot.sendMessage(chat_id=update.message.chat_id, text=" .") def send_command_to_noolite(command): """   NooLite.  .   ,      . """ try: logger.info('Send command to noolite: {}'.format(command)) response = noolite_api.send_command_to_channel(command) except NooLiteConnectionTimeout as e: logger.info(e) return None, "* !*\n`{}`".format(e) except NooLiteConnectionError as e: logger.info(e) return None, "*!*\n`{}`".format(e) except NooLiteBadResponse as e: logger.info(e) return None, "*   !*\n`{}`".format(e) return response.text, None # ========================== Commands ================================ @log @auth_required def outdoor_light_on(bot, update): """  """ response, error = send_command_to_noolite({'ch': 2, 'cmd': 2}) logger.info('Send message: {}'.format(response or error)) bot.sendMessage(chat_id=update.message.chat_id, text="{}".format(response or error)) @log @auth_required def outdoor_light_off(bot, update): """  """ response, error = send_command_to_noolite({'ch': 2, 'cmd': 0}) logger.info('Send message: {}'.format(response or error)) bot.sendMessage(chat_id=update.message.chat_id, text="{}".format(response or error)) @log @auth_required def heaters_on(bot, update): """ """ response, error = send_command_to_noolite({'ch': 0, 'cmd': 2}) logger.info('Send message: {}'.format(response or error)) bot.sendMessage(chat_id=update.message.chat_id, text="{}".format(response or error)) @log @auth_required def heaters_off(bot, update): """ """ response, error = send_command_to_noolite({'ch': 0, 'cmd': 0}) logger.info('Send message: {}'.format(response or error)) bot.sendMessage(chat_id=update.message.chat_id, text="{}".format(response or error)) @log @auth_required def send_temperature(bot, update): """   """ try: sens_list = noolite_api.get_sens_data() except NooLiteConnectionTimeout as e: logger.info(e) bot.sendMessage( chat_id=update.message.chat_id, text="* !*\n`{}`".format(e), parse_mode=ParseMode.MARKDOWN ) return except NooLiteBadResponse as e: logger.info(e) bot.sendMessage( chat_id=update.message.chat_id, text="*   !*\n`{}`".format(e), parse_mode=ParseMode.MARKDOWN ) return except NooLiteConnectionError as e: logger.info(e) bot.sendMessage( chat_id=update.message.chat_id, text="*   noolite!*\n`{}`".format(e), parse_mode=ParseMode.MARKDOWN ) return if sens_list[0].temperature and sens_list[0].humidity: message = ": *{}C*\n: *{}%*".format( sens_list[0].temperature, sens_list[0].humidity ) else: message = "   : {}".format(sens_list[0].state) logger.info('Send message: {}'.format(message)) bot.sendMessage(chat_id=update.message.chat_id, text=message, parse_mode=ParseMode.MARKDOWN) @log @auth_required def send_log(bot, update): """   """ bot.sendDocument( chat_id=update.message.chat_id, document=open('/var/log/telegram_bot/err.log', 'rb') ) @log def unknown(bot, update): """ """ bot.sendMessage(chat_id=update.message.chat_id, text="    ") def power_restore(bot, job): """     """ for user_chat in config['telegtam']['authenticated_users']: bot.sendMessage(user_chat, '  ') def check_temperature(bot, job): """     E  ,    -     """ try: sens_list = noolite_api.get_sens_data() except NooLiteConnectionTimeout as e: print(e) return except NooLiteConnectionError as e: print(e) return except NooLiteBadResponse as e: print(e) return if sens_list[0].temperature and \ sens_list[0].temperature &lt; config['noolite']['temperature_alert']: for user_chat in config['telegtam']['authenticated_users']: bot.sendMessage( chat_id=user_chat, parse_mode=ParseMode.MARKDOWN, text='*  {} : {}!*'.format( config['noolite']['temperature_alert'], sens_list[0].temperature ) ) def check_internet_connection(bot, job): """               -    telnet     .         -  Raspberry Pi """ try: requests.get('http://ya.ru') config['noolite']['internet_connection_counter'] = 0 except ConnectionError: if config['noolite']['internet_connection_counter'] == 2: tn = telnetlib.Telnet(config['router']['ip']) tn.read_until(b"login: ") tn.write(config['router']['login'].encode('ascii') + b"\n") tn.read_until(b"Password: ") tn.write(config['router']['password'].encode('ascii') + b"\n") tn.write(b"reboot\n") elif config['noolite']['internet_connection_counter'] == 4: os.system("sudo reboot") else: config['noolite']['internet_connection_counter'] += 1 dispatcher = updater.dispatcher dispatcher.add_handler(CommandHandler('start', start)) dispatcher.add_handler(CommandHandler('auth', auth)) dispatcher.add_handler(CommandHandler('', send_temperature)) dispatcher.add_handler(CommandHandler('_', heaters_on)) dispatcher.add_handler(CommandHandler('_', heaters_off)) dispatcher.add_handler(CommandHandler('_', outdoor_light_on)) dispatcher.add_handler(CommandHandler('_', outdoor_light_off)) dispatcher.add_handler(CommandHandler('log', send_log)) dispatcher.add_handler(MessageHandler([Filters.command], unknown)) job_queue.put(Job(check_internet_connection, 60*5), next_t=60*5) job_queue.put(Job(check_temperature, 60*30), next_t=60*6) job_queue.put(Job(power_restore, 60, repeat=False)) updater.start_polling(bootstrap_retries=-1)</span></span></code> </pre></div></div><br><p>  This bot runs on Raspberry Pi under Supervisor, which monitors its status and starts it upon reboot. </p><br><img src="https://habrastorage.org/files/589/bc4/b63/589bc4b635b54b39a28b23825489e25a.png" alt="image"><br><p>  <i>Bot operation</i> </p><br><p>  When starting the bot: </p><br><ul><li>  sends a message to registered users that it is turned on and ready to work; </li><li>  monitors internet connection.  In the condition of work through the mobile Internet there were cases when it disappeared.  Therefore, a periodic connection availability check was added.  If the specified number of checks fails, then first the script reloads the router via telnet, and then, if that does not work, Raspberry Pi itself; </li><li>  monitors the indoor temperature and sends a notification to the user if it falls below a predetermined threshold; </li><li>  executes commands from registered users. </li></ul><br><p>  Commands are hardcoded in the code and include: </p><br><ul><li>  on / off heaters; </li><li>  on / off the street light; </li><li>  temperature acquisition from sensors; </li><li>  getting log file for debug. </li></ul><br><p>  An example of communication with the bot: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e14/f06/33d/e14f0633d33b41978eb30297e64a476e.png" alt="image"></div><br><p>  As a result, I and all family members received a fairly convenient interface for managing a smart home via Telegram.  All you need to do is to install a client telegram on your device and know the password to start communicating with the bot. </p><br><p>  In the end, I can: </p><br><ul><li>  manage your smart home from anywhere from any device with your Telegram account; </li><li>  receive information from sensors located in the house. </li></ul><br><p>  This implementation is 100% solved the original task, it was convenient and intuitive to use. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Budget (at current prices): </p><br><ul><li>  NooLite Ethernet Gateway - 6.000 rubles </li><li>  NooLite power sensor for load control - 1.500 rubles </li><li>  NooLite temperature and humidity sensor - 3.000 rubles (less moisture without moisture) </li><li>  Raspberry Pi - 4.000 rubles </li></ul><br><p>  On the way out I got a fairly flexible budget system that can be easily expanded as needed (NooLite gateway supports up to 32 channels).  I and family members can easily use it without having to perform any additional actions: I went into the telegram - checked the temperature - turned on the heaters. </p><br><p>  In fact, this implementation is not the last.  Just a week ago, I connected this entire system to Apple HomeKit, which allowed me to add control through the iOS app ‚ÄúHome‚Äù and the corresponding integration with Siri for voice control.  But the implementation process pulls on a separate article.  If the community is interested in this topic, it is ready in the near future to prepare another article. </p><br><p>  UPD: <a href="https://habrahabr.ru/post/312668/">second article about HomeKit integration</a> </p><br><p>  Related Links: </p><br><ul><li>  <a href="https://github.com/AlekseevAV/NooLite-telegram">github repository</a> </li><li>  <a href="http://www.noo.com.by/assets/files/PDF/PR1132.pdf">NooLite API</a> (at the very bottom of the instruction) </li><li>  <a href="https://core.telegram.org/bots/api">telegram bot API</a> </li><li>  <a href="https://github.com/python-telegram-bot/python-telegram-bot">python-telegram-bot</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/312328/">https://habr.com/ru/post/312328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312318/index.html">Create a game for WebGL using Unity 5 and JavaScript</a></li>
<li><a href="../312320/index.html">Data serialization or communication dialectics: simple serialization</a></li>
<li><a href="../312322/index.html">Development of modules for Magento 1.x - big guide + video</a></li>
<li><a href="../312324/index.html">What do we hate in job interviews?</a></li>
<li><a href="../312326/index.html">Remote work 2.0. Nadezhda Yurinova, Bookmate Marketing Director</a></li>
<li><a href="../312330/index.html">Network Monitoring with Apple TV</a></li>
<li><a href="../312336/index.html">Content theft in Chinese game dev</a></li>
<li><a href="../312338/index.html">MapReduce from scrap materials. Part III - Putting It All Together</a></li>
<li><a href="../312340/index.html">Basics of computer networks. Subject number 4. Network devices and types of cables used</a></li>
<li><a href="../312344/index.html">Pro application backward compatibility and digging out flight attendants</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>