<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Navalny Headquarters IT infrastructure and collection of signatures: Reaper-2018</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Series of publications about collecting signatures 
 1. Introduction, the site "Bulk 20! 8", preparation for the collection 
 2. Iron and networks, vi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Navalny Headquarters IT infrastructure and collection of signatures: Reaper-2018</h1><div class="post__text post__text-html js-mediator-article"><blockquote><h5>  Series of publications about collecting signatures </h5><br>  1. <a href="https://habrahabr.ru/company/fbk/blog/347312/">Introduction, the site "Bulk 20! 8", preparation for the collection</a> <br>  2. <a href="https://habrahabr.ru/company/fbk/blog/347316/">Iron and networks, video surveillance</a> <br>  3. <b>Reaper 2018: a system for collecting signatures</b> <br>  4. <a href="https://habrahabr.ru/company/fbk/blog/347342/">Project Management</a> </blockquote><br>  This is the third part of the material about the IT infrastructure of Navalny headquarters.  In previous chapters, we talked about the <a href="https://habrahabr.ru/company/fbk/blog/347312/">development of the site ‚ÄúBulk 20! 8‚Äù</a> , the <a href="https://habrahabr.ru/company/fbk/blog/347316/">organization of a network</a> at headquarters and the production of document scanners. <br><br>  This chapter describes the creation of a system for collecting signatures for the nomination of Navalny as a presidential candidate.  The stages of work and the resulting solutions are described.  The system of physical storage of sheets with signatures is described. <br><br> <a href="https://habrahabr.ru/company/fbk/blog/347320/"><img src="https://habrastorage.org/getpro/habr/post_images/de5/dcf/afc/de5dcfafc109e176ab69fc1c604b49cb.jpg"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Sheets, QR codes and ways to work with them </h2><br>  The subscription list is the main document in our system.  The first thing I want to do to work with a large collection of objects is to assign them a unique identifier in order to associate each object with an entry in the database.  But the form of the subscription list is very strictly spelled out in the law, any violation of it is a reason to reject in general all the signatures of the candidate.  On the sheet that is submitted to the electoral commission, no unnecessary marks and symbols are allowed. <br><a name="habracut"></a><br>  When collecting signatures in Novosibirsk, we placed each sheet in a multifore (transparent ‚Äúfile‚Äù), on which the sheet ID and all official notes were written on it with a marker.  It came up to four thousand sheets, but would not work for hundreds of thousands.  This time we considered the use of multiformers an unreliable and inconvenient solution. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/da8/59c/cd7/da859ccd78fd16e6701805e5bd8355c1.jpg"><br><br>  Lawyers invented a method that allowed us to identify each sheet and not to disrupt the form of the subscription list.  The law does not say anything about the physical size of the subscription list.  This allowed us to design the sheet so that the identification codes were put on its upper part, and before being submitted to the electoral commission, they were simply cut off. <br><br>  Sheet code consists of 6 characters.  You can use Latin numbers and letters that have graphic analogs in Cyrillic (you can write in any layout in forms).  For convenience, added separators: 91 ‚àí X7 ‚àí BA. <br><br>  The same identifier is printed as a QR code for automatic recognition at various stages of work.  QR codes won all other types of bar codes in terms of reliability and speed of recognition. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/592/4d0/8af/5924d08af5abd88e6a02fa81aad94a3b.jpg"><br><br>  The life of the staffs is full of difficulties, therefore QR codes were thoroughly tested in various stress situations for the sheets ... <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f49/721/1c0/f497211c06b696c5ea10a38711d19533.jpg"><br><br>  ... and decided that the three codes will be enough to process any living sheet. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/64e/b08/7b9/64eb087b94ac91292cdcf4a906208fa2.png"><br><br>  Lawyers and designers have seriously worked to make the layout consistent with both the law and common sense.  Separately tested the number of signatures on the sheet.  Few signatures - too many sheets, a lot of unnecessary scribbling (data collector and trustee), more errors in the testimony.  Many signatures - inconvenient to make voter data, more errors in the signature lines.  After experiments with prototypes, we stopped at five signatures. <br><br>  Each sheet (more precisely, sheet identifier) ‚Äã‚Äãis created in the database, after which it can be printed on A4 paper.  But you can not just take and print a sheet on the nearest printer.  By law, the production of subscription lists must be paid from the candidate‚Äôs electoral account.  Usually they are made by an external contractor.  Therefore, we have made the technical side as friendly and flexible as possible.  Sheets are either printed directly from the browser, or they are previously saved in a multi-page PDF file that can be sent to the contractor in any convenient way. <br><br><br><h2>  Owl: preparation for collecting signatures </h2><br>  The collection of physical signatures in the subscription lists can be started only after the nomination of a candidate and the opening of a special electoral account.  The law gives very little time for this.  It was important for us to do as many operations as possible in advance in order to debug all the processes and to speed up the work as soon as the elections were officially announced.  To preliminarily verify the data of our supporters, to train the staffs and test the collection mechanics, we launched the verification procedure. <br><br>  Verification is a beta version of collecting signatures: in real headquarters, with the same equipment, with the same strict verification of documents, but without putting a signature on the paper sheet.  To work with data of verified people, an application Sych was developed. <br><br><h3>  Composition Owl </h3><br>  RESTful API backend: Python 3.6, aiohttp, aiohttp_admin, SQLAlchemy. <br>  Databases: PostgreSQL, Redis. <br>  Daemon notifications. <br>  Passport number recognition daemon. <br>  Daemon to build analytics. <br>  Service passport check on his number. <br>  The boxed version <a href="https://kladr-api.ru/">Kladr-API</a> for work with addresses (PHP 5.6 + MongoDB). <br><br>  We decided to make for the Owl a separate backend with the RESTful API, because it was planned to integrate it with several services, including the Navalny 20! 8 website.  A separate PostgreSQL and Redis database was used as storage for caching.  To manage users came the aiohttp_admin library, which we modified to fit our needs. <br><br>  The internal operator interface is a step-by-step form for scanning a passport and filling in personal data.  Due to the large number of possible states, this form was written on React. <br><br>  Interaction with the site ‚ÄúBulk 20! 8‚Äù was conducted through an API that is protected by a token and is available only over the local network between virtual machines. <br><br><br><h3>  Record for verification </h3><br>  In order to evenly distribute the load on the staffs over time, they invented a verification record.  After registering on the site, the person got access to the recording interface, where he chose a convenient headquarters and time. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6a4/cfb/779/6a4cfb7792eff154fbce07a3ed6283cf.jpg"><br><br>  For load control, records management and schedule, we developed a separate interface available to the regional manager and headquarters coordinator: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f69/407/ff8/f69407ff8a7617ecb809ac1068660263.jpg"><br><br>  If a headquarters has an emergency, the coordinator may massively cancel future verification entries.  However, he cannot do this on his own - you must request a cancellation confirmation code from the regional manager.  We had to repeatedly use this option. <br><br><br><h3>  Notifications </h3><br>  Sychy was a branching notification system.  The signer should have received notifications by mail when he signed up for verification, missed the recording, a week after the cancellation of the recording, after successful verification, after the cancellation of the recording by headquarters and in several other cases. <br><br> <a href=""><img src="https://habrastorage.org/webt/vw/x6/ot/vwx6othsdyn3ctdmq0g5dxpricy.png"></a> <br><br>  SMS notifications were sent to remind you of the recording in three hours and to inform you that the headquarters canceled the recording.  The queue of notifications was made on the same principle as on the site ‚ÄúBulk 20! 8‚Äù: tables in the database with messages that were sent in groups via email and SMS gateways. <br><br><br><h3>  Passport Recognition </h3><br>  In order to evaluate the work of operators and determine the percentage of errors during data entry, I wanted to have an additional scan recognition.  Reliable automatic recognition was impossible to do because of the variability of passports, so two options were considered: send scans to Yandex.Tolok for users to recognize, or take a group of volunteers who would do this in the office.  But the issue of personal data security prevented both options, and we left automatic recognition only for the passport number. <br><br><br><h3>  Analyst Sycha </h3><br>  During verification, we not only refined and verified our base of supporters, but also tested the work of headquarters, infrastructure, equipment and the mechanics of collecting signatures.  To observe the process and adjust it, we made a simple analytics. <br><br>  Since the headquarters has three levels of process management - the coordinators of the headquarters (responsible for the work of one headquarters), regional managers (monitor the group of headquarters in several regions) and the management of the federal headquarters (monitors everything and everyone), the system grouped the data in different ways. for each category of users. <br><br>  Most of the details we showed to the headquarters coordinator.  He saw the statistics of all operators and the dynamics of key indicators and could make management decisions based on them: put up more or less operators, strengthen the alert, change the work schedule on weekends, fire or re-educate employees who often make mistakes, etc. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/a06/b1d/c69/a06b1dc69a640d2637d20c4ef0ae3f37.png"></a> <br><br>  We saved the regional manager from unnecessary details, and on the first screen he saw only the most important things in his group of headquarters: key indicators, ratings and problem headquarters (marked with alarming red).  We referred to ‚Äúproblem‚Äù headquarters with N% below the average, chronically underloaded (they needed additional notification) and overloaded by the number of records (this meant that not all people could enroll and need to increase the number of operators). <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/be3/70e/249/be370e2499f4fd64305423deaae21428.png"></a> <br>  In order to better deal with the detected problem, the regional manager could easily see the detailed statistics for each headquarters and see all the data that are available to the coordinator. <br><br>  It was important for the federal headquarters to immediately see the full picture, so we collected key campaign metrics on one screen and made a pivot table for all the cities where the verification is taking place.  In the table, you can select the headquarters of interest to view the full set of data on it. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/9ff/eb6/782/9ffeb67829fab75c21c26461dc9290b0.png"></a> <br><br>  In total, more than 50 indicators were displayed in the analytics.  The flexibility of SQLAlchemy was enough to never switch to pure SQL and to keep the code readable.  For the most time-consuming indicators, we first made caching in Redis, but it turned out to be easier to periodically calculate them in the background and, when prompted, take them from a file. <br><br><br><h2>  Reaper 2018: a system for collecting signatures </h2><br>  In parallel with the verification process, a system for collecting signatures was developed.  The architecture of the system used in Novosibirsk and able to work with physical objects - sheets and signatures was taken as a basis. <br><br>  From the backend side, the Reaper-2018 is the heir to the old Reaper, but he received the operator interface from the verification system.  Some screens were refined after analyzing reviews of the owl.  In addition, interfaces have been added for several levels of data verification and for controlling sheet movement. <br><br><br><h3>  Operator Interface </h3><br>  In the process of obtaining a signature, the operator must scan the voter's passport, fill out a questionnaire (given that the address indicated in the registration stamp can be written in a completely different format) and enter the data into the subscription list, following the instructions of the system.  But first we must check whether the voter meets the three key conditions: <br><br>  1. At the time of the election, he must be over 18 years old. <br>  2. If the voter is 20 or 45 years old, he must have a new passport. <br>  3. Passport should not be listed as invalid. <br><br>  Checking the base of invalid passports is a simple operation, but it also has its subtleties.  The base is distributed by the Ministry of Internal Affairs on its website.  Previously, before the elections, they for some reason turned off the possibility of unloading this base, so we started daily downloading the current version of the database in advance (do not forget to turn it off). <br><br>  Now in the database of more than 110 million entries (series and passport numbers).  For a quick search with a small amount of database and indexes, the following scheme was invented: PostgreSQL creates a table with a million entries, the primary key of which is the passport number (from 0 to 999999), and the second field contains all the series of invalid passports for this number.  To reduce the volume of the series, they were converted to binary format (two bytes each) and compressed using zlib (I just wanted to).  Initially, the base is about 1 GB without indexes.  After processing, it turns out 260 MB with an index.  One entry is checked for an average of 15 ms. <br><br><blockquote>  0.6% of passports of people who passed the verification were found in the database of invalid passports.  This means that without such verification we would spend 12% of the limit on invalid signatures only for this type of error. <br><br>  0.88% of the passports did not suit us, since the citizen was 20 or 45 years old, but he had not yet replaced the passport.  And this is another 18% of the limit of invalid signatures. </blockquote><br>  The subscription list contains 4 columns filled out by the operator: name, year of birth, passport number and address of permanent registration.  All these data passed through the Reaper to check and correct possible errors.  For example, in the fields for name and patronymic, the search for typos works: <br><br><img width="500" src="https://habrastorage.org/getpro/habr/post_images/3f2/714/8ad/3f27148ad63c4309bbf3776581520ec6.png"><br><br>  For prompts for names in the API, there is a method that compares the value with a large list and returns three response options: <br><br>  - everything is OK, there is such a name; <br>  - there is a similar name (such and such); <br>  - Unknown name (rare name or serious spelling mistakes). <br><br>  A separate story - the letter "e".  There are passports in which it is used, but in most cases it is replaced with ‚Äúe‚Äù, so we display a warning if there is ‚Äúe‚Äù in some field of passport data. <br><br>  The system does not fix anything itself, only informs.  The operator and inspectors should pay attention to such cases and make the right decision. <br><br><br><h3>  Document scanning </h3><br>  We use our own production scanners to obtain document images, and the Raspberry Pi as an operator station.  This is described in detail in the <a href="https://habrahabr.ru/company/fbk/blog/347316/">second chapter</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3e9/b2b/570/3e9b2b570f1a4eb74f6cc1b598a697b4.png"><br>  <sub>This image is not a scan of a passport, but is collected in a graphical editor from random data.</sub> <br><br>  The image is obtained on the client side of the HTML 5 Canvas API and is sent to the server as a base64 string, in which lies the JPEG.  From the frontend point of view, scanners can operate in two modes: USB webcam and streaming video from a computer on a local subnet.  Owl works only with USB-cameras, and the Reaper-2018 allows you to switch between modes.  The operator chooses which scanner to use. <br><br>  There was a small problem with the choice of the video stream of neighboring computers: tables and scanners can be moved, and operators can change.  We do not know which scanner will be next to the operator next time.  I had to sort through the headquarters subnet and give the operator the opportunity to choose any of the live scanners.  But it turned out that the scanner's video broadcast server, although they put the correct CORS headers (Access-Control-Allow-Origin: *), do not respond to OPTIONS requests.  The browser denied ajax requests to neighboring hosts, which made it impossible to use regular jQuery.ajax () for searching.  JSONP requests didn‚Äôt help either, because they couldn‚Äôt be canceled programmatically, and several dozen pending requests completely blocked the page.  Pictures helped to solve the problem.  We added tags to the DOM and assigned them a src video stream.  If the picture was resized in accordance with the size of the stream, then the stream was considered alive and shown to the operator. <br><br>  The display of the video stream in the browser noticeably loads modest Raspberry Pi processors, so we had to do a ‚Äúscreensaver‚Äù: after 5 minutes of inactivity, the browser pauses the broadcast. <br><br>  It is important for us to select the current information about the place of registration.  At the turn of the passport can be 6 stamps, but only one is needed.  The interface prompts you to select it using the arrows on the keyboard or by clicking on the desired stamp on the preview. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5db/a0b/228/5dba0b22896eea3f0f22dd0e1dacab07.jpg"><br><br>  More registration may not be.  Such voters are recorded in a separate subscription list with an empty region and address, and the registration scan is skipped. <br><br><br><h3>  Address Processing </h3><br>  The most difficult part in filling out the subscription list is the address of the voter.  More than half the errors due to which the signature is considered invalid are associated with the address. <br><br>  To the address of registration there is a large list of legal requirements.  For example: <br><br>  - it must be an address according to FIAS (federal information address system); <br>  - for the renamed streets it is necessary to indicate new names, even if the passport was old; <br>  - The law establishes a certain format of the hierarchy of address objects that need to be recorded (for example, you cannot specify an urban area). <br><br>  These are only basic points, but there are a lot of trifles, the list of which was replenished with each interaction with the election commission.  Failure to comply with even minor requirements - the reason for the electoral commission not to accept the signature. <br><br><blockquote>  At the collection of signatures in Novosibirsk, about 3.5% of signatures were invalidated due to claims to the ‚Äúaddress‚Äù field.  And this is 70% of the limit that is set for signatures for the nomination of a presidential candidate. </blockquote><br>  In order to fulfill all the requirements, we are forced to drive each address through a computer in order to form the correct format and indicate to the collector up to the symbol what he should write on the subscription list. <br><br>  We try, when it is possible, not to use API of third-party services, in order not to give data about our users and not to be in a situation when the API is suddenly turned off at the most crucial moment.  Work with addresses is a critical function for collecting signatures, so we had to make our API to the FIAS database. <br><br>  In the FIAS database, there is not yet enough high-quality and complete information about houses and apartments, so we stopped at street level.  In this form, the base with all additional constructions weighs about 2 GB and lives quite comfortably in the form of PostgreSQL.  Modified scripts from the <a href="https://github.com/asyncee/fias2pgsql">fias2pgsql</a> repository were used for import. <br><br>  For the universal all-Russian form of entering addresses, you cannot simply make the fields ‚Äúcity‚Äù, ‚Äústreet‚Äù, ‚Äúhouse‚Äù, since there are many different address formats and types of address objects.  A well-known example of an unusual format is Zelenograd, in which there are houses without a street name.  But believe me, on a nationwide scale, this is a rather trivial case. <br><br>  After a series of experiments, we settled on a form of three fields: <br><br>  - the subject of the Russian Federation - it is always there, this is the most understandable field; <br>  - FIAS address - field with autocompletion to addresses of the given region within FIAS; <br>  - house / building / apartment - a line where the data is copied exactly in accordance with the permanent registration stamp. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/958/188/959/958188959fce31c8679e71732a52809b.jpg"><br><br>  The lawyers have compiled a table of address transformations, with the help of which we brought the FIAS addresses into a format consistent with the election legislation.  Most often it was necessary to exclude one of the address elements.  Some addresses were excluded entirely (garage cooperatives, yard areas and other similar objects).  The IT department received a table with rules, and the legal department received in response 10 examples for each of the 44 address types. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/474/71b/2fd/47471b2fd79544365653f6124d530f30.png"><br><br>  After several such iterations, the base was ready for operation. <br><br>  The technical part of the task was to organize a convenient and fast search with auto-completion, which will withstand the load of 1 million queries per day.  Sphinx was used as a search engine.  The request is cleared of unnecessary characters and transferred to Sphinx, and it returns the full addresses of the objects, ranking them according to the specified rules. <br><br>  Sphinx indexes an address field written in XML format.  This storage format turned out to be convenient in that all the metadata can be hidden in XML attributes that Sphinx does not use for searching, but keeps in memory and returns in the results without additional reference to the database.  Somewhere on the frontend, these attributes are used to form a beautiful address bar. <br><img src="https://habrastorage.org/getpro/habr/post_images/1b9/74f/f82/1b974ff827de843c6fb7e20d281610ae.png"><br><br>  The solution was convenient and fast.  One request to the suggest API is performed in 15‚Äì20 ms, the backend calmly processes 300 simultaneous connections on a not very powerful virtual machine. <br><br><br><h3>  Filling out the subscription list </h3><br>  Signatures must be made on the lists of the subject of the Russian Federation to which the address of the citizen‚Äôs permanent registration belongs (or on special sheets without a region if there is no registration).  The reaper tells the operator which sheet of the region to take, and does not give a signature to the sheet of another region. <br><br><blockquote>  Imagine that you want to solve such a problem without a computer, collecting signatures at the station, where there will be many people from different regions and there will be no card store with empty sheets, sorted by region.  About a third of passports, the registration stamp does not contain the name of the region, and passersby do not know the rules of the game and can easily confuse something.  It looks like a source of a large number of errors, which is unacceptable at the legal limit of 5%. </blockquote><br>  Filling out the subscription list is a complicated and responsible procedure.  On the sheet there are lines of signatures, the tester of the collector and the signature of the trustee.  All these blocks must be completed in accordance with strict formal requirements.  At each stage of filling errors are possible, which can make the whole sheet or part of the signatures invalid. <br><br>  We have developed such scenarios of the operator's work that reduce the likelihood of typical errors.  The letters of witness of the sheets of the ‚Äúhome‚Äù region (about 80% of the signatures will be from the region in which the headquarters is located) are filled in by the collector in advance in a calm atmosphere.  For all blocks of the sheet, the Reaper shows exactly how they should be filled. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/592/750/737/592750737458243e4124091b23cd7b1e.png"><br>  The fill interface simulates the real subscription list, which is currently on the table in front of the operator.  Showing occupied lines, columns for filling, sheet number, large - data for entering. <br><br>  For a filled line, the operator must indicate its status (it is not always possible to fill in the line successfully the first time).  Each correction and deletion must correspond to a note from the collector on the sheet and the corresponding status in the database. <br><br>  After filling out the entire sheet on it is stamped with the date and signature of the collector.  The sheet is submitted for review. <br><br><br><h3>  Verification of signatures, work with sheets in the headquarters </h3><br>  At the end of each working day, all sheets with signatures are checked out, which takes place late in the evening or at night (we have small headquarters, there is simply no place to conduct all processes in parallel).  The verifier (he is the candidate's attorney) looks at each sheet and each signature, compares with fragments of the scanned pages of the passport, checks all relevant elements on the check list.  If errors are detected, it is marked in a special interface. <br><br><blockquote>  A witness record is checked separately.  Errors in the certification are especially dangerous, since they affect the entire sheet at once.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Such errors are due to the origin of approximately 9% of all invalid signatures. </font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some errors can be corrected, but only the collector can make corrections to the signature lines, and the headquarters does not have it in the evening / at night, so all the information necessary for the correction is transmitted electronically. </font><font style="vertical-align: inherit;">To understand the context, you need to see everything that happened with the line before. </font><font style="vertical-align: inherit;">This is how the ‚Äúchat‚Äù appeared between the examiner, the operator and the lawyer. </font><sub><font style="vertical-align: inherit;">All names and other data on the image are made up.</font></sub><font style="vertical-align: inherit;"> If errors seem fatal or have any doubts, the sheet is sent to a lawyer. </font><font style="vertical-align: inherit;">If the signatures do not contain errors or all corrections have already been made, the verifier signs the trustee and sends the sheet for sending to the central headquarters.</font></font><br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/798/7bb/2f9/7987bb2f9c33d8fe8eba6b90e13bbf30.jpg"></a> <br> <sub><font style="vertical-align: inherit;"></font></sub> <br><br><font style="vertical-align: inherit;"></font><br><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Smile and neurophysiology of happiness </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For quick and error-free selection of the status of the scanned string, we used buttons in the form of emoticons. It has deep neurophysiological causes. In the visual system of the brain there are ancient low-level mechanisms that respond to certain images. The visual system reacts most quickly to straight line segments of different orientations, since the lines are easily detected by the primary visual cortex. In the secondary visual cortex, simple geometric shapes are recognized (this needs to be learned) and a face pattern. And not just a face is recognized, but basic mimic expressions. That is, emoticons. Like the recognition of straight lines, it is an innate ability. Thanks to this low-level system, emoticons are recognized much faster and more accurately than text.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a0b/c75/8d1/a0bc758d1a9b2fd8cbdf894bc92ccb33.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Icons in the form of emoticons correspond well to the meaning of statuses that the verifier can assign signatures: ‚Äúgood‚Äù, ‚Äúthere are problems‚Äù, ‚Äúbad‚Äù. </font><font style="vertical-align: inherit;">There were some doubts with the ‚Äúshow a lawyer‚Äù emoticon, but we coped with it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is also an opinion that emoticons humanize the interface and thus slightly improve the life of the operator.</font></font> This is important because<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operators had to spend long hours at work with our system and not lose vigilance. </font></font><br><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sending sheets </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finished sheets are sent to the central headquarters every day. </font><font style="vertical-align: inherit;">Sheets can be many, several hundred. </font><font style="vertical-align: inherit;">We want to know exactly which sheets are ready and left the headquarters, but manually registering them is long and unreliable. </font><font style="vertical-align: inherit;">To account for the sheets sent written mobile application. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/739/885/23b/73988523b1a1c67639d5b67baad22f1d.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">He has a mode that allows you to quickly scan the codes of hundreds of sheets and reports if a sheet is attempted to be sent by mistake when it has not yet passed all processing steps at headquarters. </font><font style="vertical-align: inherit;">It takes 1-2 seconds to scan a single sheet. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After scanning, the sheets are packed and sent to Moscow.</font></font><br><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Form Details </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All passport data is entered and displayed in Source Code Pro Regular monospaced font. </font><font style="vertical-align: inherit;">It is easy to distinguish zero from the letter ‚ÄúO‚Äù, and the characters are quite similar to those commonly used in modern passports. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All forms are made so that between the fields and the main buttons you can switch tabs. </font><font style="vertical-align: inherit;">The input focus is in the right field, not only when the page is loaded, but also after closing the error message. </font><font style="vertical-align: inherit;">Modal dialogs capture the focus so that switching occurs only between their controls. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/bfa/a11/341/bfaa11341e048c64b9a6019e8a4912a9.gif"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All buttons that, when pressed, take something long to show, show it with all their appearance. </font><font style="vertical-align: inherit;">Input fields at the time of sending data are turned off. </font><font style="vertical-align: inherit;">In case of errors, detailed explanations appear.</font></font><br><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Logistics and physical storage of sheets </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shifting the pieces of paper is one of the activities in which humanity has achieved incredible success. </font><font style="vertical-align: inherit;">It would seem that you can go to the stationery shop, buy a set for collecting signatures "Federal" and not think about the details. </font><font style="vertical-align: inherit;">But there is a problem: all office solutions are too expensive. </font><font style="vertical-align: inherit;">We cannot deliver document scanners for several tens of thousands of rubles and cabinets with hanging folders for one hundred thousand at each headquarters, so at each stage we had to invent and create something from scrap materials.</font></font><br><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Some facts about process physics </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We need to hand over 315 thousand signatures. </font><font style="vertical-align: inherit;">For this, taking into account the regional quotas and the margin for various errors, about 1 million signatures must be collected and processed. </font><font style="vertical-align: inherit;">On each sheet there can be a maximum of five signatures, but in reality there will be about 3-4. </font><font style="vertical-align: inherit;">This gives us, roughly speaking, 300 thousand sheets. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A sheet of A4 paper has an area of ‚Äã‚Äã1/16 m¬≤. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The density of ordinary office paper is 80 g / m¬≤, each sheet weighs 5 g. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The height of a pack of 500 sheets is 4.5 cm for blank sheets, more than 6 cm for filled ones. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It turns out that all the collected sheets will weigh 1.5 tons, and they will be about 36 meters high when they are folded in one pack.</font></font><br><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to store all this? </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Subscription lists are printed, filled with signatures, checked, certified and sent daily to the central headquarters. One headquarters sends several hundred sheets a day, so there should be no problem at this stage. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The most interesting begins in the central headquarters. There you need to organize a storage system that allows you to easily take sheets from the regional headquarters and work with them until the end of the collection. After the collection is completed, the sheets should be grouped by region and sewn into folders for the electoral commission. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We cannot simply stack sheets in endless packs, since lawyers may at any time wish to remove part of the sheets according to a certain sample. You need to know exactly where each sheet is located, be able to quickly get it and return it.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For quick access, a system of indexing the physical database of sheets was invented. </font><font style="vertical-align: inherit;">The index consists of several levels: headquarters (box), box, folder. </font><font style="vertical-align: inherit;">Address folder in the archive looks like this: 77‚àí1‚àí15. </font><font style="vertical-align: inherit;">Inside each folder is 25 sheets (in random order). </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/2f3/77d/8d9/2f377d8d9ba95848b4c712f9f4361871.jpg"><br> <sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the left upper picture there is a box for 500 subscription lists in paper folders. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the right picture - a box for 2000 sheets in overhead folders.</font></font></sub> <br><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Retrieving and sorting sheets </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All sheets coming from the regions are scanned with an automatic two-way scanner (he was already in the office, so you did not have to collect it yourself from LEGO and Arduino). This device is able to upload the result to the server via SFTP. There, the scans are run through a python script that searches for QR codes in standard places, recognizes them and links scans to a common database. The script reliably handles even crumpled sheets. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a69/937/865/a69937865a705212e7e9ccec4c4f5875.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After scanning, the sheets go on sorting. Each sheet is scanned using a mobile application (sorting mode). It finds a sheet in the system, changes its status to ‚Äúarrived at the central headquarters‚Äù and shows the coordinates of the folder in which the sheet should be put. The operator confirms that put the sheet in the specified folder (closes the transaction).</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/d59/913/930/d59913930d9f13fe3b3e625eba2bf700.gif"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sheets of one region are placed in a folder sequentially, as long as there is space in it, so the whole process happens very quickly.</font></font><br><br><br><h2>  Backend </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Reaper 2018 is made on Django with a standard template engine and ORM. The database uses PostgreSQL. The service parts of the system - FIAS, passport checking, work with the preliminary registration data - are rendered into separate modules (django app) with their own databases. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The physical world of signatures is presented in the form of several classes of objects: a subscription list, a line in a sheet, a signature. The objects of these classes have attributes that reflect the state of the object in the real world. The state machine uses the ‚Äústate machine‚Äù template (state machine, finite state machine) and the django-fsm library. All transitions between states are registered in the form of FSM transactions, within which the necessary checks and additional actions with the object are carried out. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The state diagram looks like this:</font></font><br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/1df/8b4/c40/1df8b4c40400d96f2b73e33011c0885a.png"></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The position of the sheet in space is determined by the state of the lines that it contains. If there are lines that a lawyer has to check, the sheet receives the status ‚Äúto a lawyer‚Äù. As soon as the lawyer took the sheet and entered his code in the verification interface, the sheet receives the status ‚Äúfrom the lawyer‚Äù. Thus, we always know the exact position of all the sheets and understand their immediate fate.</font></font><br><br><br><h2>  Testing </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The signature collection system has too many different states and transitions between them to check it manually. To automate checks, all scenarios related to the work of operators and verifiers are covered with tests on the django side. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is useless to look at the system of collecting a million signatures when it does not contain these signatures. To fill the database, scripts were written that initialize the typical state of the database in the collection process, so that you can look at a system filled with something similar to real data.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The collection of signatures is very limited in time, and much of this time falls on New Year holidays. We expected that the load on staffs and the collection system would be uneven. It was important that the system easily coped with any realistic stream of signatures. At peak times, up to 10,000 signatures per hour were expected. For a regular web site, this does not look serious, but in our case this order of ‚Äúvisitors‚Äù can create a large load on the server. This is not just a visit or registration: obtaining each signature involves about 50 requests to the server and processing several high-resolution images. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stress testing was performed using </font></font><a href="https://locust.io/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Locust</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This is a simple tool, accessible through PyPI. Scenarios are described as python code, roughly as unit tests in Django: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/8dc/db2/262/8dcdb226287b37477c86e111a7f07ff8.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tests can be run via a web interface, which displays graphs of the speed of requests, the number of clients, and the server response time. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/dfb/2d7/2ba/dfb2d72bae45fe73ca6af9bcd1cbaa3c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The deployment of the project is organized in the same way as for the ‚ÄúNavalny 20! 8‚Äù site. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Access to the Reaper's web applications is only possible through the headquarters VPN network.</font></font><br><br><br><h2>  Monitoring </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We use various tools for monitoring servers and applications involved in the signature collection system. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zabbix monitors the status of all virtual machines of the project. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elasticsearch collects nginx logs from all virtualoks, Kibana shows this in the form of graphs. </font><font style="vertical-align: inherit;">In Sentry, all the errors from the applications and from the frontends fall. </font><font style="vertical-align: inherit;">The frontends are placed in a separate ‚Äúorganization‚Äù in order not to spoil the statistics on the backend errors. </font><font style="vertical-align: inherit;">A handy thing, but getting Sentry to work under our load was quite difficult.</font></font><br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/453/dab/fd3/453dabfd34d6b00524de5ce6bbdfe15c.png"></a> <br><br><font style="vertical-align: inherit;"></font><br><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Goose </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a functional monitoring, somewhat similar to </font></font><a href="https://uptime.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uptime.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , only self-made. The backend is built on django, the queues are made on celery with a backend in redis. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the Goose added project domains. For each domain, the addresses to be monitored, the check interval and the type of check are indicated. You can check the certificate, content, HTTP-headers, redirects, and something else useful. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If something went wrong, Gus can send letters and SMS or call in the middle of the night and explain the situation with a human voice (Twillio is used for calls and speech synthesis). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The web interface always shows which domains have errors and how are the queue checks. Every minute is 20-25 checks.</font></font><br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/1cc/611/d9e/1cc611d9e8c9d7a0fdaedf981bf3eb7a.png"></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Even in Gus, there is distributed monitoring via a ‚Äúbotnet‚Äù from mobile applications. </font><font style="vertical-align: inherit;">Applications receive a list of addresses for monitoring, check them (the status of the response and the presence of the specified content) and send the result to the server. </font><font style="vertical-align: inherit;">Such monitoring is convenient to monitor the blocking of Roskomnadzor and the state of the server under attack.</font></font><br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/888/d23/8d1/888d238d1698e239cf12c7387a9cfc73.png"></a> <br><br><hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In the next, final chapter, we will tell about the management of projects of the IT department. </font></font></div><p>Source: <a href="https://habr.com/ru/post/347320/">https://habr.com/ru/post/347320/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347302/index.html">Getting a personal phone number by analyzing and sorting social resources and accounts</a></li>
<li><a href="../347306/index.html">TypeScript real-time applications: chat development using WebSocket, Node and Angular</a></li>
<li><a href="../347312/index.html">IT infrastructure of Navalny headquarters and collection of signatures: preparation for collection, site ‚ÄúBulk 20! 8‚Äù</a></li>
<li><a href="../347314/index.html">"Fall" LKML.org: the cause of failure - the old home server</a></li>
<li><a href="../347316/index.html">IT infrastructure of Navalny headquarters and collection of signatures: hardware and networks</a></li>
<li><a href="../347322/index.html">Not a feature, but a bug</a></li>
<li><a href="../347324/index.html">Risks of using virtual number services for receiving SMS when registering on Internet resources</a></li>
<li><a href="../347328/index.html">Creating parametric database objects in nanoCAD Mechanics (Part 2)</a></li>
<li><a href="../347330/index.html">Developing AI for a turn-based game on Node.js (part 2)</a></li>
<li><a href="../347332/index.html">We read data from the open part of KOMPAS-3D files for integration with Pilot-ICE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>