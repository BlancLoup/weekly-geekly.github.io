<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Streaming in Rails 4</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is streaming? 
 Streaming has been around Rails since version 3.2, but it was limited solely to streaming templates . Rails 4 came out with more ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Streaming in Rails 4</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/storage2/d39/24f/6a0/d3924f6a00b44b9d716e68a652d0eb94.jpg"></div><br><br><h2>  What is streaming? </h2><br>  Streaming has been around Rails since version 3.2, but it was limited solely to <a href="http://apidock.com/rails/ActionController/Streaming">streaming templates</a> .  Rails 4 came out with more mature streaming functionality in real time.  In essence, this means that Rails is now capable of natively processing I / O objects and sending data to the client in real time. <br><br>  Streaming and Live are two separate modules implemented inside ActionController.  Streaming is enabled by default, while Live must be explicitly added directly to the controller. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The main api streaming uses the Fiber class (available from ruby ‚Äã‚Äãversion 1.9.2).  Fayber provide tools for thread-like concurrency in ruby.  Fiber allows threads to pause and resume work at the request of the programmer, and not to be essentially proactive. <br><a name="habracut"></a><br><h2>  Streaming templates </h2><br>  Streaming reverses the usual layout and template rendering.  By default, Rails renders a template first, and then a layout.  The first thing he does is run <code>yield</code> and load the template.  After this, asses and layout are rendered. <br><br>  Consider an action that makes many requests, for example: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TimelineController</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">users</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">all</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tickets</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ticket</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">all</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attachments</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Attachment</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">all</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br>  In this case streaming is well suited.  This is a common situation for Rails, the page loads longer than usual, because you need to get all the data first. <br><br>  Let's add streaming: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TimelineController</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">users</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">all</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tickets</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ticket</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">all</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attachments</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Attachment</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">all</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">render</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  The <code>render stream: true</code> method will lazily load all requests and allow them to be executed after the assets and layout have been rendered.  Streaming works with templates and only with them (but not with json or xml).  This provides a good way to transfer priority to templates based on the type of page and its content. <br><br><h2>  Add something inside </h2><br>  Streaming changes the way in which the template and layout are rendered, which leads to the logical question: what about the use of instance variables in templates? <br><br>  After all, since the database has not yet returned an answer at the time of rendering templates, an attempt to access instance variables will result in an error. <br><br>  Consequently, in order to load attributes such as title and meta, you need to use <code>content_for</code> instead of the usual <code>yield</code> .  However, <code>yield</code> will still work for body. <br><br>  Previously, our method looked something like this: <br><br><pre> <code class="ruby hljs">&lt;%= <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:title</span></span> %&gt;</code> </pre><br>  Now it will look like this: <br><br><pre> <code class="ruby hljs">&lt;%= content_for <span class="hljs-symbol"><span class="hljs-symbol">:title</span></span>, <span class="hljs-string"><span class="hljs-string">"My Awesome Title"</span></span> %&gt;</code> </pre><br><h2>  Getting Alive with the Live API </h2><br>  Live is a special module included in ActionController.  It allows Rails to explicitly open and close streams.  Let's write a simple application and see how it works and how to access the stream from the outside. <br><br>  Since we work in the context of streaming and parallelism, WEBrick is not a friend to us here.  We will use Puma for it can work with threads. <br><br>  Add the cougar to the Gemfile and run the bundle. <br><br><pre> <code class="ruby hljs">gem <span class="hljs-string"><span class="hljs-string">"puma"</span></span></code> </pre><br><pre> <code class="bash hljs">:~/testapp$ bundle install</code> </pre><br>  Puma integrates well with Rails, so if you now run <code>rails s</code> , Puma will run on the same port as WEBRick. <br><br><pre> <code class="bash hljs">:~/testapp$ rails s =&gt; Booting Puma =&gt; Rails 4.0.0 application starting <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> development on http://0.0.0.0:3000 =&gt; Run `rails server -h` <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> more startup options =&gt; Ctrl-C to shutdown server Puma 2.3.0 starting... * Min threads: 0, max threads: 16 * Environment: development * Listening on tcp://0.0.0.0:3000</code> </pre><br>  Let's quickly generate a controller to send messages. <br><br><pre> <code class="bash hljs">:~/testapp$ rails g controller messaging</code> </pre><br>  And add a simple method for streaming them. <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessagingController</span></span></span><span class="hljs-class"> &lt; ApplicationController </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ActionController::Live</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send_message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">headers</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Content</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Type</span></span></span><span class="hljs-class">'] = '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class">' 10.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">times</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">write</span></span></span><span class="hljs-class"> "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">This</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">test</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Message</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">n</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sleep</span></span></span><span class="hljs-class"> 1 } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">close</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Add a route in routes.rb: <br><br><pre> <code class="ruby hljs">get <span class="hljs-string"><span class="hljs-string">'messaging'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'messaging#send_message'</span></span></code> </pre><br>  Now we can access stream for example using curl: <br><br><pre> <code class="bash hljs">:~/testapp$ curl -i http://localhost:3000/messaging HTTP/1.1 200 OK X-Frame-Options: SAMEORIGIN X-XSS-Protection: 1; mode=block X-Content-Type-Options: nosniff X-UA-Compatible: chrome=1 Content-Type: text/event-stream Cache-Control: no-cache Set-Cookie: request_method=GET; path=/ X-Request-Id: 68c6b7c7-4f5f-46cc-9923-95778033eee7 X-Runtime: 0.846080 Transfer-Encoding: chunked This is a <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> message This is a <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> message This is a <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> message This is a <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> message</code> </pre><br>  Each time the <code>send_message</code> method is <code>send_message</code> , Puma creates a new stream, in which it streams the data for an individual client.  By default, Puma is configured to handle up to 16 parallel threads, which means 16 simultaneously connected clients.  Of course, this number can be increased, but this will slightly increase the memory consumption. <br><br>  Let's create a form and see if we can send any data to the view: <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_message</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">response</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">headers</span></span></span><span class="hljs-function">['</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Content</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">-</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Type</span></span></span><span class="hljs-function">'] = '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">text</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">/</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">event</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">-</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stream</span></span></span><span class="hljs-function">' 10.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">times</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">response</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stream</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-function"> "</span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">#{params[:message]}\n" sleep 1 } response.stream.close end</span></span></span></span></code> </pre><br>  We make a form to send data to the stream: <br><br><pre> <code class="ruby hljs">&lt;%= form_tag messaging_path, <span class="hljs-symbol"><span class="hljs-symbol">:method</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'get'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> %&gt; &lt;%= text_field_tag <span class="hljs-symbol"><span class="hljs-symbol">:message</span></span>, params[<span class="hljs-symbol"><span class="hljs-symbol">:message</span></span>] %&gt; &lt;%= submit_tag <span class="hljs-string"><span class="hljs-string">"Post Message"</span></span> %&gt; &lt;% <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> %&gt;</code> </pre><br>  And configure the route: <br><br><pre> <code class="ruby hljs">get <span class="hljs-string"><span class="hljs-string">'messaging'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'messaging#send_message'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:as</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'messaging'</span></span></code> </pre><br>  As soon as you enter the message and click ‚ÄúPost Message‚Äù, the browser will receive a streaming response in the form of a downloadable text file that contains your message, logged 10 times. <br><br><img src="https://habrastorage.org/storage2/78d/b70/7c1/78db707c19ffc5ed582391145ba31e2b.png"><br><br>  Here, however, the stream does not know where to send the data and in what format, so he writes them to a text file on the server. <br><br>  You can also check work with curl by passing parameters: <br><br><pre> <code class="ruby hljs"><span class="hljs-symbol"><span class="hljs-symbol">:~/testapp</span></span>$ curl -i <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/localhost:3000/messaging</span></span>?message=<span class="hljs-string"><span class="hljs-string">"awesome"</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK X-Frame-<span class="hljs-symbol"><span class="hljs-symbol">Options:</span></span> SAMEORIGIN X-XSS-<span class="hljs-symbol"><span class="hljs-symbol">Protection:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; mode=block X-Content-Type-<span class="hljs-symbol"><span class="hljs-symbol">Options:</span></span> nosniff X-UA-<span class="hljs-symbol"><span class="hljs-symbol">Compatible:</span></span> chrome=<span class="hljs-number"><span class="hljs-number">1</span></span> Content-<span class="hljs-symbol"><span class="hljs-symbol">Type:</span></span> text/event-stream Cache-<span class="hljs-symbol"><span class="hljs-symbol">Control:</span></span> no-cache Set-<span class="hljs-symbol"><span class="hljs-symbol">Cookie:</span></span> request_method=GET; path=<span class="hljs-regexp"><span class="hljs-regexp">/ X-Request-Id: 382bbf75-7d32-47c4-a767-576ec59cc364 X-Runtime: 0.055470 Transfer-Encoding: chunked awesome awesome</span></span></code> </pre><br><h2>  Server Side Events </h2><br>  HTML5 provides a method called Server Side Events (SSE).  SSE is a method available to the browser that recognizes and triggers events each time the server sends data. <br><br>  We can use SSE in conjunction with the Live API to establish a two-way server connection with the client. <br><br>  By default, Rails provides only one-way communication ‚Äî it allows you to stream data to a client as soon as it becomes available.  However, if we add SSE, we can use the events and responses in two-way mode. <br><br>  A simple SSE looks like this: <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'json'</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerSide</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SSE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">io</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">io</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">io</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">write</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">options</span></span></span><span class="hljs-class"> = {} </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">options</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">each</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v</span></span></span><span class="hljs-class">| @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">io</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">write</span></span></span><span class="hljs-class"> "</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{k}: #{v}\n" end </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@io</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.write "data: #{object}\n\n" end def close </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@io</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.close end end end</span></span></span></span></code> </pre><br>  This module receives an I / O stream object in a hash and converts it into a key-value pair so that it can be easily read, stored and sent back in JSON format. <br><br>  Now we can wrap our stream object in SSE.  First, we connect the SSE module to the controller.  Now the opening and closing of the stream is regulated by the SSE module.  Also, if you do not complete it explicitly, the loop will repeat indefinitely and the connection will always be open, so we will add a <code>ensure</code> condition to make sure that the stream is closed. <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'server_side/sse'</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessagingController</span></span></span><span class="hljs-class"> &lt; ApplicationController </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ActionController::Live</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">headers</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Content</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Type</span></span></span><span class="hljs-class">'] = '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sse</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerSide::SSE</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">begin</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loop</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sse</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">write</span></span></span><span class="hljs-class">({ :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> =&gt; "</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{params[:message]}" }) sleep 1 end rescue IOError ensure sse.close end end end</span></span></span></span></code> </pre><br>  This code will give an answer like this: <br><br><pre> <code class="bash hljs">:~/testapp$ curl -i http://localhost:3000/messaging?message=<span class="hljs-string"><span class="hljs-string">"awesome"</span></span> HTTP/1.1 200 OK X-Frame-Options: SAMEORIGIN X-XSS-Protection: 1; mode=block X-Content-Type-Options: nosniff X-UA-Compatible: chrome=1 Content-Type: text/event-stream Cache-Control: no-cache Set-Cookie: request_method=GET; path=/ X-Request-Id: b922a2eb-9358-429b-b1bb-015421ab8526 X-Runtime: 0.067414 Transfer-Encoding: chunked data: {:message=&gt;<span class="hljs-string"><span class="hljs-string">"awesome"</span></span>} data: {:message=&gt;<span class="hljs-string"><span class="hljs-string">"awesome"</span></span>}</code> </pre><br><h2>  Underwater rocks </h2><br>  Be careful, there are a couple of pitfalls (where do without them): <br><br><ol><li>  All streams must be closed explicitly, otherwise they will always be open. </li><li>  You must make sure that your code is thread-safe, since the controller always spawns a new thread when the method starts. </li><li>  After the first portion of the response, heders cannot be changed in <code>write</code> or <code>close</code> </li></ol><br><br><h2>  Conclusion </h2><br>  This is an opportunity that many people have been looking for in Rails for a long time, because it can significantly increase application performance (streaming templates) and seriously compete with node.js (Live). <br><br>  Some are already conducting benchmarks, comparing, but I think that this is only the very beginning and time must pass (read a few releases) for this feature to mature, so to speak.  Now it is a good start and an exciting opportunity to try everything in action. <br><br>  PS: this is my first translation experience, I will be very grateful for the comments in PM.  Thank. <br><br>  The original is <a href="http://rubysource.com/streaming-with-rails-4/">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/187994/">https://habr.com/ru/post/187994/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../187980/index.html">Speaker hacker at Black Hat Jack Barnaby died a few days before the conference</a></li>
<li><a href="../187982/index.html">Free Software Foundation begins fundraising for Replicant</a></li>
<li><a href="../187986/index.html">Ineffective programmer or how to hack your brain in 2 days</a></li>
<li><a href="../187988/index.html">Overview of the Chinese DPSS laser 532nm</a></li>
<li><a href="../187992/index.html">American agents "lucky" in the pursuit of Russian hackers</a></li>
<li><a href="../188002/index.html">Interrupts in pipelined processors</a></li>
<li><a href="../188010/index.html">Know the complexity of the algorithms</a></li>
<li><a href="../188012/index.html">Sort in .NET</a></li>
<li><a href="../188014/index.html">Twitter Bootstrap 3 RC Released 1</a></li>
<li><a href="../188016/index.html">The court forbade the publication of launch codes for luxury cars</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>