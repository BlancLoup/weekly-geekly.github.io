<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to start using User Mode in Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction from the translator: Against the background of the mass entry into our life, various kinds of containers can be quite interesting and use...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to start using User Mode in Linux</h1><div class="post__text post__text-html js-mediator-article">  <i>Introduction from the translator: Against the background of the mass entry into our life, various kinds of containers can be quite interesting and useful to find out with what technology it all began sometime.</i>  <i>Some of them can be usefully applied to this day, but not all of these methods are remembered (or know, if they did not find it during their rapid development).</i>  <i>One of these technologies is User Mode Linux.</i>  <i>The original author pretty much rummaged, figuring out that the old developments still work, and which is not very good, and collected something like step-by-step instructions on how to get homegrown UML in 2K19 to yourself.</i>  <i>And yes, we invited the author of the original post of <a href="https://habr.com/ru/users/cadey/" class="user_link">Cadey</a> to Habr, so if you have questions, ask in English in the comments.</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/480/b5e/ecc/480b5eeccd71ac8e098a9e7b3b8bedb6.jpg" alt="image"><br><br>  Linux user mode is, in fact, the port of the Linux kernel itself.  This mode allows you to run a full-fledged Linux kernel as a user process and is usually used by developers to test drivers.  But this mode is also useful as a tool for general isolation, the principle of which is similar to the work of virtual machines.  This mode provides greater isolation than Docker, but less than a full-fledged virtual machine like KVM or Virtual Box. <br><a name="habracut"></a><br>  In general, User Mode may seem strange and difficult to use tool, but it still has its own areas of application.  After all, this is a full-fledged Linux-kernel, working from an unprivileged user.  This feature allows you to run potentially unreliable code without any threats to the host machine.  And since this is a full-fledged kernel, its processes are isolated from the host machine, that is, <b>processes running inside User Mode will not be visible to the host</b> .  This is not similar to the usual Docker-container, in which case the host machine always sees the processes inside the repository.  Look at this piece of pstree from one of my servers: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="xml hljs">containerd‚îÄ‚î¨‚îÄcontainerd-shim‚îÄ‚î¨‚îÄtini‚îÄ‚î¨‚îÄdnsd‚îÄ‚îÄ‚îÄ19*[{dnsd}] ‚îÇ ‚îÇ ‚îî‚îÄs6-svscan‚îÄ‚îÄ‚îÄs6-supervise ‚îÇ ‚îî‚îÄ10*[{containerd-shim}] ‚îú‚îÄcontainerd-shim‚îÄ‚î¨‚îÄtini‚îÄ‚î¨‚îÄaerial‚îÄ‚îÄ‚îÄ21*[{aerial}] ‚îÇ ‚îÇ ‚îî‚îÄs6-svscan‚îÄ‚îÄ‚îÄs6-supervise ‚îÇ ‚îî‚îÄ10*[{containerd-shim}] ‚îú‚îÄcontainerd-shim‚îÄ‚î¨‚îÄtini‚îÄ‚î¨‚îÄs6-svscan‚îÄ‚îÄ‚îÄs6-supervise ‚îÇ ‚îÇ ‚îî‚îÄsurl ‚îÇ ‚îî‚îÄ9*[{containerd-shim}] ‚îú‚îÄcontainerd-shim‚îÄ‚î¨‚îÄtini‚îÄ‚î¨‚îÄh‚îÄ‚îÄ‚îÄ13*[{h}] ‚îÇ ‚îÇ ‚îî‚îÄs6-svscan‚îÄ‚îÄ‚îÄs6-supervise ‚îÇ ‚îî‚îÄ10*[{containerd-shim}] ‚îú‚îÄcontainerd-shim‚îÄ‚î¨‚îÄgoproxy‚îÄ‚îÄ‚îÄ14*[{goproxy}] ‚îÇ ‚îî‚îÄ9*[{containerd-shim}] ‚îî‚îÄ32*[{containerd}]</code> </pre> <br>  And compare this with the pstree of the Linux kernel in User Mode: <br><br><pre> <code class="xml hljs">linux‚îÄ‚î¨‚îÄ5*[linux] ‚îî‚îÄslirp</code> </pre> <br>  When working with Docker containers, I can see from the host the names of the processes that are running in the guest system.  With Linux User Mode, this is not possible.  What does it mean?  This means that monitoring tools that work through the Linux audit system (Linux's auditing subsystem) <b>do not see the</b> processes that are running in the guest system.  But in some situations, this feature can become a double-edged sword. <br><br>  In general, the whole post below is a set of research and crude attempts to achieve the desired result.  To do this, I had to use different ancient tools, read the kernel sources, intensively debug code written in the days when I still went to primary school, and also poke around in the Heroku builds using a special binary to find the tools I needed.  All this work led to the fact that the guys in my IRC began to call me a sorceress (magic).  I hope that this post will serve someone with reliable documentation in order to do the same thing, but with newer kernels and OS versions. <br><br><h3>  Customization </h3><br>  Setting up a Linux User Mode is done in several steps: <br><br><ul><li>  installing dependencies on the host; </li><li>  Linux kernel download; </li><li>  kernel build setup; </li><li>  kernel assembly; </li><li>  installation of a binary; </li><li>  setting up the guest file system; </li><li>  selection of kernel startup parameters; </li><li>  guest network setup; </li><li>  launch guest core. </li></ul><br>  I assume that if you decide to do it all yourself, you will most likely do everything described in some Ubuntu or Debian-like system.  I tried to implement all of the above in my favorite distribution, Alpine, but it didn‚Äôt work, apparently due to the fact that the Linux kernel has a hard glibc-isms binding for drivers in User Mode.  I plan to report this to upstream after I finally deal with the problem. <br><br><h3>  Installing dependencies on a host </h3><br>  Ubuntu requires at least the following packages to build the Linux kernel (assuming a clean installation): <br><br> <code>- 'build-essential' <br> - 'flex' <br> - 'bison' <br> - 'xz-utils' <br> - 'wget' <br> - 'ca-certificates' <br> - 'bc' <br> - 'linux-headers'</code> <br> <br>  You can install them using the following command (as root or using sudo): <br><br><pre> <code class="xml hljs">apt-get -y install build-essential flex bison xz-utils wget ca-certificates bc \ linux-headers-$(uname -r)</code> </pre> <br>  Please note that running the menu customization program for the Linux kernel will require installing <code>libncurses-dev</code> .  Please ensure that it is installed using the following command (as root or using sudo): <br><br><pre> <code class="xml hljs">apt-get -y install libncurses-dev</code> </pre> <br><h3>  Kernel download </h3><br>  Determine the place to boot and build the kernel.  For this operation, you need to allocate about 1.3 GB of hard disk space, so make sure you have it. <br><br>  Then go to <a href="https://www.kernel.org/">kernel.org</a> and get the URL to download the latest stable version of the kernel.  At the time of writing this post is: <a href="">https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.1.16.tar.xz</a> <br><br>  Download this file using <code>'wget'</code> : <br><br><pre> <code class="xml hljs">wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.1.16.tar.xz</code> </pre> <br>  And extract it using <code>'tar'</code> : <br><br><pre> <code class="xml hljs">tar xJf linux-5.1.16.tar.xz</code> </pre> <br>  Now we enter the directory created when unpacking the tarball: <br><br><pre> <code class="xml hljs">cd linux-5.1.16</code> </pre> <br><h3>  Kernel build setup </h3><br>  The kernel build system is a set of <a href="https://en.wikipedia.org/wiki/Makefile">Makefiles</a> with <b>many</b> custom tools and scripts to automate the process.  To get started, open the online setup program: <br><br><pre> <code class="xml hljs">make ARCH=um menuconfig</code> </pre> <br>  It will partially build and bring you a dialog box.  When ' <code>[Select]</code> ' is displayed at the bottom of the window, you can do the adjustment with the Spacebar or the Enter key.  Navigating through the window, as usual, the keyboard arrows "up" and "down", and the selection of elements - "left" or "right". <br><br>  The view index ---&gt; means that you are in a submenu, which you can enter using the Enter key.  Exit from it, obviously, through ' <code>[Exit]</code> '. <br><br>  Include the following parameters in ' <code>[Select]</code> ' and make sure that next to them is the symbol '[*]': <br><br><pre> <code class="xml hljs">UML-specific Options: - Host filesystem Networking support (enable this to get the submenu to show up): - Networking options: - TCP/IP Networking UML Network devices: - Virtual network device - SLiRP transport</code> </pre> <br>  Everything, from this window it is possible to leave, consistently selecting ' <code>[Exit]</code> '.  Just make sure that at the end you are prompted to save the configuration and select ' <code>[Yes]</code> '. <br><br>  I recommend that you play around with the kernel build options after reading this post.  Thanks to these experiments, you can learn a lot in terms of understanding the work of low-level kernel mechanics and the effect of various flags on its assembly. <br><br><h3>  Kernel build </h3><br>  The Linux kernel is a large program that does a lot of things.  Even with such a minimal configuration on old equipment, its assembly may take a long time.  Therefore, build the kernel with the following command: <br><br><pre> <code class="xml hljs">make ARCH=um -j$(nproc)</code> </pre> <br>  What for?  This command will tell our builder to use all available cores and processor threads during the build process.  The <code>$(nproc)</code> at the end of Build substitutes the output of the <code>nproc</code> , which is part of <code>coreutils</code> in the standard Ubuntu build. <br><br>  After some time, our kernel will be compiled into a <code>./linux</code> executable file. <br><br><h3>  Binary installation </h3><br>  Since the Linux User Mode creates a regular binary, you can install it just like any other utility.  Here's how I did it: <br><br><pre> <code class="xml hljs">mkdir -p ~/bin cp linux ~/bin/linux</code> </pre> <br>  You should also make sure that <code>~/bin</code> is in your <code>$PATH</code> : <br><br><pre> <code class="xml hljs">export PATH=$PATH:$HOME/bin</code> </pre> <br><h3>  Setting up the guest file system </h3><br>  Create a directory for the guest file system: <br><br><pre> <code class="xml hljs">mkdir -p $HOME/prefix/uml-demo cd $HOME/prefix</code> </pre><br>  Open alpinelinux.org and in <a href="https://alpinelinux.org/downloads">the download section,</a> find the current download link for <code>MINI ROOT FILESYSTEM</code> .  At the time of writing this was: <br><br><pre> <code class="xml hljs">http://dl-cdn.alpinelinux.org/alpine/v3.10/releases/x86_64/alpine-minirootfs-3.10.0-x86_64.tar.gz</code> </pre> <br>  Download this tarball using wget: <br><br><pre> <code class="xml hljs">wget -O alpine-rootfs.tgz http://dl-cdn.alpinelinux.org/alpine/v3.10/releases/x86_64/alpine-minirootfs-3.10.0-x86_64.tar.gz</code> </pre> <br>  Now enter the directory of the guest file system and unpack the archive: <br><br><pre> <code class="xml hljs">cd uml-demo tar xf ../alpine-rootfs.tgz</code> </pre> <br>  The steps described will create a small file system template.  Due to the nature of the system, installing packages through the apk Alpine manager will be extremely difficult.  But this FS will be enough to evaluate the general idea. <br><br>  We will also need the <a href="https://github.com/krallin/tini">tini</a> tool to prevent the <a href="https://en.wikipedia.org/wiki/Zombie_process">zombie processes from</a> using our guest kernel. <br><br><pre> <code class="xml hljs">wget -O tini https://github.com/krallin/tini/releases/download/v0.18.0/tini-static chmod +x tini</code> </pre> <br><h3>  Creating a kernel command line </h3><br>  In the Linux kernel, as in most other programs, there are command line arguments that can be viewed by specifying the key <code>--help</code> . <br><br><div class="spoiler">  <b class="spoiler_title">Himself - help</b> <div class="spoiler_text"><pre> <code class="xml hljs">linux --help User Mode Linux v5.1.16 available at http://user-mode-linux.sourceforge.net/ --showconfig Prints the config file that this UML binary was generated from. iomem=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>,<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">file</span></span></span><span class="hljs-tag">&gt;</span></span> Configure <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">file</span></span></span><span class="hljs-tag">&gt;</span></span> as an IO memory region named <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>. mem=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Amount</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">desired</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ram</span></span></span><span class="hljs-tag">&gt;</span></span> This controls how much "physical" memory the kernel allocates for the system. The size is specified as a number followed by one of 'k', 'K', 'm', 'M', which have the obvious meanings. This is not related to the amount of memory in the host. It can be more, and the excess, if it's ever used, will just be swapped out. Example: mem=64M --help Prints this message. debug this flag is not needed to run gdb on UML in skas mode root=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">file</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">containing</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">root</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fs</span></span></span><span class="hljs-tag">&gt;</span></span> This is actually used by the generic kernel in exactly the same way as in any other kernel. If you configure a number of block devices and want to boot off something other than ubd0, you would use something like: root=/dev/ubd5 --version Prints the version number of the kernel. umid=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> This is used to assign a unique identity to this UML machine and is used for naming the pid file and management console socket. con[0-9]*=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">description</span></span></span><span class="hljs-tag">&gt;</span></span> Attach a console or serial line to a host channel. See http://user-mode-linux.sourceforge.net/old/input.html for a complete description of this switch. eth[0-9]+=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transport</span></span></span><span class="hljs-tag">&gt;</span></span>,<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">options</span></span></span><span class="hljs-tag">&gt;</span></span> Configure a network device. aio=2.4 This is used to force UML to use 2.4-style AIO even when 2.6 AIO is available. 2.4 AIO is a single thread that handles one request at a time, synchronously. 2.6 AIO is a thread which uses the 2.6 AIO interface to handle an arbitrary number of pending requests. 2.6 AIO is not available in tt mode, on 2.4 hosts, or when UML is built with /usr/include/linux/aio_abi.h not available. Many distributions don't include aio_abi.h, so you will need to copy it from a kernel tree to your /usr/include/linux in order to build an AIO-capable UML nosysemu Turns off syscall emulation patch for ptrace (SYSEMU). SYSEMU is a performance-patch introduced by Laurent Vivier. It changes behaviour of ptrace() and helps reduce host context switch rates. To make it work, you need a kernel patch for your host, too. See http://perso.wanadoo.fr/laurent.vivier/UML/ for further information. uml_dir=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">directory</span></span></span><span class="hljs-tag">&gt;</span></span> The location to place the pid and umid files. quiet Turns off information messages during boot. hostfs=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dir</span></span></span><span class="hljs-tag">&gt;</span></span>,<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">flags</span></span></span><span class="hljs-tag">&gt;</span></span>,... This is used to set hostfs parameters. The root directory argument is used to confine all hostfs mounts to within the specified directory tree on the host. If this isn't specified, then a user inside UML can mount anything on the host that's accessible to the user that's running it. The only flag currently supported is 'append', which specifies that all files opened by hostfs will be opened in append mode.</code> </pre> <br></div></div><br>  This panel covers the main launch parameters.  Let's run the kernel with the minimum required set of options: <br><br><pre> <code class="xml hljs">linux \ root=/dev/root \ rootfstype=hostfs \ rootflags=$HOME/prefix/uml-demo \ rw \ mem=64M \ init=/bin/sh</code> </pre> <br>  The lines above tell our kernel the following: <br><br><ul><li>  Suppose the root filesystem is a pseudo-device <code>/dev/root</code> . </li><li>  Choose <a href="http://user-mode-linux.sourceforge.net/hostfs.html">hostfs</a> as the root filesystem driver. </li><li>  Mount the guest file system we created in the root device. </li><li>  And yes, in read-write mode. </li><li>  Use only 64 megabytes of RAM (you can use much less, depending on what you plan to do, but 64 MB seems to be the optimal amount). </li><li>  The kernel automatically starts the <code>/bin/sh</code> as an <code>init</code> process. </li></ul><br>  Run this command and you should get something like the following: <br><br><div class="spoiler">  <b class="spoiler_title">Another sheet</b> <div class="spoiler_text"><pre> <code class="xml hljs">Core dump limits : soft - 0 hard - NONE Checking that ptrace can change system call numbers...OK Checking syscall emulation patch for ptrace...OK Checking advanced syscall emulation patch for ptrace...OK Checking environment variables for a tempdir...none found Checking if /dev/shm is on tmpfs...OK Checking PROT_EXEC mmap in /dev/shm...OK Adding 32137216 bytes to physical memory to account for exec-shield gap Linux version 5.1.16 (cadey@kahless) (gcc version 7.4.0 (Ubuntu 7.4.0-1ubuntu1~18.04.1)) #30 Sun Jul 7 18:57:19 UTC 2019 Built 1 zonelists, mobility grouping on. Total pages: 23898 Kernel command line: root=/dev/root rootflags=/home/cadey/dl/uml/alpine rootfstype=hostfs rw mem=64M init=/bin/sh Dentry cache hash table entries: 16384 (order: 5, 131072 bytes) Inode-cache hash table entries: 8192 (order: 4, 65536 bytes) Memory: 59584K/96920K available (2692K kernel code, 708K rwdata, 588K rodata, 104K init, 244K bss, 37336K reserved, 0K cma-reserved) SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=1, Nodes=1 NR_IRQS: 15 clocksource: timer: mask: 0xffffffffffffffff max_cycles: 0x1cd42e205, max_idle_ns: 881590404426 ns Calibrating delay loop... 7479.29 BogoMIPS (lpj=37396480) pid_max: default: 32768 minimum: 301 Mount-cache hash table entries: 512 (order: 0, 4096 bytes) Mountpoint-cache hash table entries: 512 (order: 0, 4096 bytes) Checking that host ptys support output SIGIO...Yes Checking that host ptys support SIGIO on close...No, enabling workaround devtmpfs: initialized random: get_random_bytes called from setup_net+0x48/0x1e0 with crng_init=0 Using 2.6 host AIO clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 19112604462750000 ns futex hash table entries: 256 (order: 0, 6144 bytes) NET: Registered protocol family 16 clocksource: Switched to clocksource timer NET: Registered protocol family 2 tcp_listen_portaddr_hash hash table entries: 256 (order: 0, 4096 bytes) TCP established hash table entries: 1024 (order: 1, 8192 bytes) TCP bind hash table entries: 1024 (order: 1, 8192 bytes) TCP: Hash tables configured (established 1024 bind 1024) UDP hash table entries: 256 (order: 1, 8192 bytes) UDP-Lite hash table entries: 256 (order: 1, 8192 bytes) NET: Registered protocol family 1 console [stderr0] disabled mconsole (version 2) initialized on /home/cadey/.uml/tEwIjm/mconsole Checking host MADV_REMOVE support...OK workingset: timestamp_bits=62 max_order=14 bucket_order=0 Block layer SCSI generic (bsg) driver version 0.4 loaded (major 254) io scheduler noop registered (default) io scheduler bfq registered loop: module loaded NET: Registered protocol family 17 Initialized stdio console driver Using a channel type which is configured out of UML setup_one_line failed for device 1 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 2 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 3 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 4 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 5 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 6 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 7 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 8 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 9 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 10 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 11 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 12 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 13 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 14 : Configuration failed Using a channel type which is configured out of UML setup_one_line failed for device 15 : Configuration failed Console initialized on /dev/tty0 console [tty0] enabled console [mc-1] enabled Failed to initialize ubd device 0 :Couldn't determine size of device's file VFS: Mounted root (hostfs filesystem) on device 0:11. devtmpfs: mounted This architecture does not have kernel memory protection. Run /bin/sh as init process /bin/sh: can't access tty; job control turned off random: fast init done / #</code> </pre> <br></div></div><br>  The manipulations above will give us a <b>guest system at a</b> minimum rate, without such things as <code>/proc</code> or assigned to a hostname.  For example, try the following commands: <br><br> <code>- uname -av <br> - cat /proc/self/pid <br> - hostname</code> <br> <br>  To exit the guest system, type <code>exit</code> or press control-d.  This will fire the shell, followed by kernel panic: <br><br><pre> <code class="xml hljs">/ # exit Kernel panic - not syncing: Attempted to kill init! exitcode=0x00000000 fish: ‚Äú./linux root=/dev/root rootflag‚Ä¶‚Äù terminated by signal SIGABRT (Abort)</code> </pre> <br>  We got this kernel panic for the reason that the Linux kernel believes that the initialization process is always running.  Without it, the system can no longer function and shuts down.  But since this is a user mode process, the result is sent by itself to <code>SIGABRT</code> , which results in an exit. <br><br><h3>  Customize guest network </h3><br>  And here we all begin to go not according to plan.  Network in User Mode Linux is where the whole concept of limited ‚Äúuser mode‚Äù begins to fall apart.  After all, usually at the system level the network is limited to <b>privileged</b> execution modes for all of us understandable reasons. <br><br>  <i>Note</i>  <i>Lane: more about different ways of working with the network in the UML can be read <a href="http://user-mode-linux.sourceforge.net/old/networking.html">here</a> .</i> <br><br><h3>  Travel in slirp </h3><br>  However, there is an ancient and practically unsupported tool called <a href="https://en.wikipedia.org/wiki/Slirp">Slirp</a> , with which the Linux User Mode can interact with the network.  It works approximately like a TCP / IP stack at the user level and does not require any system permissions to run.  This tool was <b>released in 1995</b> , and the latest update dates back to <b>2006</b> .  Slirp is very old.  For a time without support and updates, compilers have gone so far that now this tool can only be described as <a href="https://en.wikipedia.org/wiki/Software_rot">‚Äúcode rot‚Äù</a> . <br><br>  So let's roll Slirp from the Ubuntu repositories and try to run it: <br><br><pre> <code class="xml hljs">sudo apt-get install slirp /usr/bin/slirp Slirp v1.0.17 (BETA) Copyright (c) 1995,1996 Danny Gasparovski and others. All rights reserved. This program is copyrighted, free software. Please read the file COPYRIGHT that came with the Slirp package for the terms and conditions of the copyright. IP address of Slirp host: 127.0.0.1 IP address of your DNS(s): 1.1.1.1, 10.77.0.7 Your address is 10.0.2.15 (or anything else you want) Type five zeroes (0) to exit. [autodetect SLIP/CSLIP, MTU 1500, MRU 1500, 115200 baud] SLiRP Ready ... fish: ‚Äú/usr/bin/slirp‚Äù terminated by signal SIGSEGV (Address boundary error)</code> </pre> <br>  Oh, gods.  Let's install the debugger for Slirp and see if we can figure out what's going on here: <br><br><pre> <code class="xml hljs">sudo apt-get install gdb slirp-dbgsym gdb /usr/bin/slirp GNU gdb (Ubuntu 8.1-0ubuntu3) 8.1.0.20180409-git Copyright (C) 2018 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">http:</span></span></span><span class="hljs-tag">//</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">gnu.org</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">licenses</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">gpl.html</span></span></span><span class="hljs-tag">&gt;</span></span> This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Type "show copying" and "show warranty" for details. This GDB was configured as "x86_64-linux-gnu". Type "show configuration" for configuration details. For bug reporting instructions, please see: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">http:</span></span></span><span class="hljs-tag">//</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">www.gnu.org</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">software</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">gdb</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bugs</span></span></span><span class="hljs-tag">/&gt;</span></span>. Find the GDB manual and other documentation resources online at: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">http:</span></span></span><span class="hljs-tag">//</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">www.gnu.org</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">software</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">gdb</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">documentation</span></span></span><span class="hljs-tag">/&gt;</span></span>. For help, type "help". Type "apropos word" to search for commands related to "word"... Reading symbols from /usr/bin/slirp...Reading symbols from /usr/lib/debug/.build-id/c6/2e75b69581a1ad85f72ac32c0d7af913d4861f.debug...done. done. (gdb) run Starting program: /usr/bin/slirp Slirp v1.0.17 (BETA) Copyright (c) 1995,1996 Danny Gasparovski and others. All rights reserved. This program is copyrighted, free software. Please read the file COPYRIGHT that came with the Slirp package for the terms and conditions of the copyright. IP address of Slirp host: 127.0.0.1 IP address of your DNS(s): 1.1.1.1, 10.77.0.7 Your address is 10.0.2.15 (or anything else you want) Type five zeroes (0) to exit. [autodetect SLIP/CSLIP, MTU 1500, MRU 1500, 115200 baud] SLiRP Ready ... Program received signal SIGSEGV, Segmentation fault. ip_slowtimo () at ip_input.c:457 457 ip_input.c: No such file or directory.</code> </pre> <br>  Error beats us in <a href="">this line</a> .  Let's look at stacktrace, maybe something will help us there: <br><br><pre> <code class="xml hljs">(gdb) bt full #0 ip_slowtimo () at ip_input.c:457 fp = 0x55784a40 #1 0x000055555556a57c in main_loop () at ./main.c:980 so = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optimized</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span><span class="hljs-tag">&gt;</span></span> so_next = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optimized</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span><span class="hljs-tag">&gt;</span></span> timeout = {tv_sec = 0, tv_usec = 0} ret = 0 nfds = 0 ttyp = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optimized</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span><span class="hljs-tag">&gt;</span></span> ttyp2 = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optimized</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span><span class="hljs-tag">&gt;</span></span> best_time = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optimized</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span><span class="hljs-tag">&gt;</span></span> tmp_time = <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">optimized</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out</span></span></span><span class="hljs-tag">&gt;</span></span> #2 0x000055555555b116 in main (argc=1, argv=0x7fffffffdc58) at ./main.c:95 No locals.</code> </pre> <br>  Here we see that a crash occurs during the start of the main loop, when slirp tries to check timeouts.  It was at this point that I had to give up debugging attempts.  But let's see if Slirp, assembled from sorts, works.  I re-uploaded the archive directly from the <a href="http://slirp.sourceforge.net/">Sourceforge</a> site, because dragging something from there via the command line is a pain: <br><br><pre> <code class="xml hljs">cd ~/dl wget https://xena.greedo.xeserv.us/files/slirp-1.0.16.tar.gz tar xf slirp-1.0.16.tar.gz cd slirp-1.0.16/src ./configure --prefix=$HOME/prefix/slirp make</code> </pre> <br>  Here we see alerts about undefined built-in functions, that is, about the impossibility of linking the resulting binary file.  It seems that between 2006 and this moment gcc stopped creating symbols used in built-in functions of intermediately compiled files.  Let's try replacing the <code>inline</code> with an empty comment and look at the result: <br><br><pre> <code class="xml hljs">vi slirp.h :6 a <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enter</span></span></span><span class="hljs-tag">&gt;</span></span> #define inline /**/ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">escape</span></span></span><span class="hljs-tag">&gt;</span></span> :wq make</code> </pre> <br>  Nah  That doesn't work either.  Still can not find the characters of these functions. <br><br>  At this stage, I gave up and started looking for <a href="https://devcenter.heroku.com/articles/buildpacks">Heroku build packages</a> on Github.  My theory was based on the fact that some Heroku package would contain the binaries I needed.  As a result, the search led me <a href="https://github.com/sleirsgoevy/heroku-buildpack-uml">here</a> .  I downloaded and unpacked <code>uml.tar.gz</code> and found the following: <br><br><pre> <code class="xml hljs">total 6136 -rwxr-xr-x 1 cadey cadey 79744 Dec 10 2017 ifconfig* -rwxr-xr-x 1 cadey cadey 373 Dec 13 2017 init* -rwxr-xr-x 1 cadey cadey 149688 Dec 10 2017 insmod* -rwxr-xr-x 1 cadey cadey 66600 Dec 10 2017 route* -rwxr-xr-x 1 cadey cadey 181056 Jun 26 2015 slirp* -rwxr-xr-x 1 cadey cadey 5786592 Dec 15 2017 uml* -rwxr-xr-x 1 cadey cadey 211 Dec 13 2017 uml_run*</code> </pre> <br>  This is a slirp binary file!  Does he work? <br><br><pre> <code class="xml hljs">./slirp Slirp v1.0.17 (BETA) FULL_BOLT Copyright (c) 1995,1996 Danny Gasparovski and others. All rights reserved. This program is copyrighted, free software. Please read the file COPYRIGHT that came with the Slirp package for the terms and conditions of the copyright. IP address of Slirp host: 127.0.0.1 IP address of your DNS(s): 1.1.1.1, 10.77.0.7 Your address is 10.0.2.15 (or anything else you want) Type five zeroes (0) to exit. [autodetect SLIP/CSLIP, MTU 1500, MRU 1500] SLiRP Ready ...</code> </pre><br>  It does not fall - so it should work!  Let's drop this binary in <code>~/bin/slirp</code> : <br><br><pre> <code class="xml hljs">cp slirp ~/bin/slirp</code> </pre> <br>  In case the creator of the package removes it, I <a href="https://git.xeserv.us/mirrors/heroku-buildpack-uml">made a mirror</a> . <br><br><h3>  Network configuration </h3><br>  Now let's configure the network on our guest core.  <a href="http://user-mode-linux.sourceforge.net/old/networking.html">Update startup parameters</a> : <br><br><pre> <code class="xml hljs">linux \ root=/dev/root \ rootfstype=hostfs \ rootflags=$HOME/prefix/uml-demo \ rw \ mem=64M \ eth0=slirp,,$HOME/bin/slirp \ init=/bin/sh</code> </pre> <br>  Now let's turn on the network: <br><br><pre> <code class="xml hljs">mount -t proc proc proc/ mount -t sysfs sys sys/ ifconfig eth0 10.0.2.14 netmask 255.255.255.240 broadcast 10.0.2.15 route add default gw 10.0.2.2</code> </pre> <br>  The first two configuration commands, <code>/proc</code> and <code>/sys</code> required for the operation of <code>ifconfig</code> , which sets up a network interface for communicating with Slirp.  The <code>route</code> command sets the kernel's routing table to force all traffic through the Slirp tunnel.  Let's check it with a DNS query: <br><br><pre> <code class="xml hljs">nslookup google.com 8.8.8.8 Server: 8.8.8.8 Address 1: 8.8.8.8 dns.google Name: google.com Address 1: 172.217.12.206 lga25s63-in-f14.1e100.net Address 2: 2607:f8b0:4006:81b::200e lga25s63-in-x0e.1e100.net</code> </pre> <br>  Works! <br><br>  <i>Note: The initial post seems to have been written on the desktop with a wired network card, or some other configuration that does not require additional drivers.</i>  <i>On a laptop with WiFi 8265 from Intel, an error occurs when you raise the network</i> <br><br><pre> <code class="bash hljs">/ <span class="hljs-comment"><span class="hljs-comment"># ifconfig eth0 10.0.2.14 netmask 255.255.255.240 broadcast 10.0.2.15 slirp_tramp failed - errno = 2 ifconfig: ioctl 0x8914 failed: No such file or directory / #</span></span></code> </pre> <br>  <i>Apparently, the kernel cannot communicate with the network driver.</i>  <i>Attempt to compile the firmware in the kernel situation, unfortunately, did not fix it.</i>  <i>At the time of publication, it was not possible to find a solution in this configuration.</i>  <i>On simpler configs (for example, in Virtualbox), the interface is raised correctly.</i> <br><br>  Let's automate redirection with the following shell script: <br><br><pre> <code class="xml hljs">#!/bin/sh # init.sh mount -t proc proc proc/ mount -t sysfs sys sys/ ifconfig eth0 10.0.2.14 netmask 255.255.255.240 broadcast 10.0.2.15 route add default gw 10.0.2.2 echo "networking set up" exec /tini /bin/sh</code> </pre> <br>  And we note its executable: <br><br><pre> <code class="xml hljs">chmod +x init.sh</code> </pre> <br>  And then we make changes to the kernel command line: <br><br><pre> <code class="xml hljs">linux \ root=/dev/root \ rootfstype=hostfs \ rootflags=$HOME/prefix/uml-demo \ rw \ mem=64M \ eth0=slirp,,$HOME/bin/slirp \ init=/init.sh</code> </pre><br>  And repeat: <br><br><pre> <code class="xml hljs">SLiRP Ready ... networking set up /bin/sh: can't access tty; job control turned off nslookup google.com 8.8.8.8 Server: 8.8.8.8 Address 1: 8.8.8.8 dns.google Name: google.com Address 1: 172.217.12.206 lga25s63-in-f14.1e100.net Address 2: 2607:f8b0:4004:800::200e iad30s09-in-x0e.1e100.net</code> </pre> <br>  The network is stable! <br><br><h3>  Docker file </h3><br>       ,   <a href="https://github.com/Xe/furry-happiness">Dockerfile</a> ,           .     <a href="https://github.com/Xe/furry-happiness/blob/master/uml.config">  </a> ,    ,    .   ,       . <br><br><hr><br>  ,      ,    .  - ,          ,    User Mode  Linux       .                .     Docker ‚Äî    tar-,         <code>docker export</code> ,            . ,    shell-. <br><br>   Rkeene  #lobsters  Freenode.      Slirp      .    ,    Slackware    slirp,    Ubuntu  Alpine   slirp    Rkeene .     ,      -. </div><p>Source: <a href="https://habr.com/ru/post/459558/">https://habr.com/ru/post/459558/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459544/index.html">Why the series "Chernobyl" so poorly described nuclear energy</a></li>
<li><a href="../45955/index.html">3g in the subway from MTS</a></li>
<li><a href="../459550/index.html">Backup Part 5: Testing Bacula and Veeam Backup for Linux</a></li>
<li><a href="../459552/index.html">How to lose access to the live system, simply by fumbling the source code</a></li>
<li><a href="../459554/index.html">Watch for file changes with Alerting OpenDistro for Elasticsearch</a></li>
<li><a href="../459560/index.html">Capabilities of container data centers: a ready switching node in Myanmar for 50 days</a></li>
<li><a href="../459562/index.html">Differentiable programming</a></li>
<li><a href="../459564/index.html">What developers need to know about business</a></li>
<li><a href="../459568/index.html">Vertical writing in modern IT</a></li>
<li><a href="../459570/index.html">Beeline shows ads Google bot. Bot displeased</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>