<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>BGP Inter-AS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we will talk about "inter-operator" interaction - BGP Inter-AS. These options are used when necessary to proxy L3vpn between PE routers located ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>BGP Inter-AS</h1><div class="post__text post__text-html js-mediator-article">  Today we will talk about "inter-operator" interaction - BGP Inter-AS.  These options are used when necessary to proxy L3vpn between PE routers located on different autonomous systems.  It should be clarified that these options are used mostly within companies when they take over / merge networks, for interaction between branches of one company if they have their own autonomous systems and their mpls domains. <br>  The article will cover the following topics: <br>  - BGP Inter-AS Option A <br>  - BGP Inter-AS Option B <br>  - BGP Inter-AS Option C <br>  - Features of setting these options on JunOS <br>  This article will draw a lot of insights from the Cisco and Juniper CLIs.  If you do not know the basics of mpls, the difference between bgp labeled-unicast and vpnv4 unicast, then you do not need to read this article.  If these concepts are familiar to you, then please under the cat. <a name="habracut"></a><br><br>  Note: In the diagrams below, the left side consists of routers running JunOS (except CE), on the right side of Cisco IOS15. <br><br>  Well, let's start with the most banal - <b>Option A.</b> <br>  The meaning of this option is that on ASBRs, VRFs are created for each VPN and separate subinterfaces from the neighboring AS are raised.  In this way, ASBRs interoperate as CE-PE routers, exchanging clear IP routes.  In this option, there is no MPLS between ASBRs - only pure IP traffic: <br><img src="https://habrastorage.org/files/0ab/6c1/337/0ab6c13373cc44c2876892fafec7fb63.jpg"><br>  <b>Let us examine in more detail how the control plane works:</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1. PE1 generates a vpnv4 route and sends it via MP-BGP to router reflector (RR1). <br><br>  2. Routereflector has a vpnv4 session with ASBR1, within which it gives it a route received from PE1 vpnv4. <br><br>  3. Since VRF was also created on ASBR1 (in our topology on ASBR1 CE1 and CE3, and on ASBR2, CE2 and CE4), it takes the route and installs it into the routing table of the corresponding vrf. <br><br>  4. ASBR1 transmits an already clear IP version to ASBR2 (the routing protocol can be any, from RIP to BGP).  Here, the interaction is of the type from CE to PE, where ASBR1 will act as the CE of the router, giving the IP prefix, and ASBR2 - the PE of the router, receiving the prefix and generating the vpnv4 prefix for its AS.  (routes are transmitted from both sides, therefore both ASBRs play the role of both CE and PE of the router). <br><br>  5. ASBR2, having received an IP prefix, generates a vpnv4 prefix and sends it to its router reflector (RR2). <br><br>  6. PE2 receives from the router a given vpnv4 session prefix and installs it into the routing table of the corresponding vrf, first checking the next-hop reachability and rt in the route configured on the vrf-import router. <br><br>  <b>Now for the data plane:</b> <b><br></b> <br>  1. PE1 receives a packet from CE1, sticks a tag (vrf tag) received from ASBR1, a transport tag to ASBR1 (received via ldp) and sends it to the appropriate interface. <br><br>  2. P1 receiving a packet from PE1 with a stack of 2-x tags removes the top transport tag (php) and sends the packet to ASBR1. <br><br>  3. ASBR1 receives a packet with a single label (vrf tag), and acts as a normal PE router, terminating the client CE router ‚Äî removes the label and sends the packet to the appropriate interface, but since the CE role of the router in this scenario is performed by ASBR2, the pure IP packet sent to the joint c ASBR2. <br><br>  4. ASBR2 receives this packet and works as a normal PE router ‚Äî adds a vrf tag (received from PE2), a transport tag to PE2 (obtained via ldp) and sends it to the appropriate interface. <br><br>  5. P2 removes the transport tag (php). <br><br>  6. PE2 receives a packet with a single tag (the vrf tag that it itself generated), removes it, does an ip lookup and sends the packet according to the routing table of the corresponding vrf. <br><br>  Now let's look in practice, what operations with labels will be made. <br>  Below are the BGP configurations on ASBRs: <br><pre><code class="cpp hljs">bormoglotx@ASBR1&gt; show configuration routing-instances CE1 instance-type vrf; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.0</span></span>; route-distinguisher <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>; vrf-target { <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> target:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> target:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span>; } vrf-table-label; protocols { bgp { group AS64999 { type external; local-address <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; peer-as <span class="hljs-number"><span class="hljs-number">64999</span></span>; local-as <span class="hljs-number"><span class="hljs-number">65000</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; } } }</code> </pre> <br><pre> <code class="cpp hljs">ASBR2<span class="hljs-meta"><span class="hljs-meta">#sh configuration | b ip vrf ip vrf CE2 rd 2:2 route-target export 2:100 route-target import 2:100 ASBR2#sh configuration | b address-family ipv4 address-family ipv4 vrf CE2 no synchronization neighbor 10.2.0.1 remote-as 65000 neighbor 10.2.0.1 local-as 64999 neighbor 10.2.0.1 activate exit-address-family</span></span></code> </pre><br>  Everything, as you can see, like a regular PE router, is nothing criminal. <br><br>  Note: There are several nuances with regards to routing protocols.  If you are using BGP, then you may have to use the loops 2 command, if you link two client sites with the same autonomous system numbers, and if you have, for example, OSPF everywhere, then you should not forget about the DN bit.  Each individual case must be considered separately. <br><img src="https://habrastorage.org/files/cce/f40/fba/ccef40fba98044d2b697d75f4a52a42a.jpg"><br>  So, we created vrf CE1 on PE1 and ASBR1, and vrf CE2 on PE2 and ASBR2, as shown in the diagram.  Export and import of vpnv4 routes is possible only between vrf-mi data within the autonomous system.  Only ASBRs (and ipv4 unicast) exchange routes between autonomous systems.  Check the connectivity between client routers CE1 and CE2: <br><pre> <code class="cpp hljs">R5<span class="hljs-meta"><span class="hljs-meta">#ping 10.0.1.2 Type escape sequence to abort. Sending 5, 100-byte ICMP Echos to 10.0.1.2, timeout is 2 seconds: !!!!! Success rate is 100 percent (5/5), round-trip min/avg/max = 60/70/84 ms</span></span></code> </pre><br>  Everything is fine, there is connectivity.  Now we will consider what operations with tags will occur in the course of package promotion. <br>  So, see the route on PE1: <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show route table CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span> destinations, <span class="hljs-number"><span class="hljs-number">7</span></span> routes (<span class="hljs-number"><span class="hljs-number">7</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, from <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> AS path: <span class="hljs-number"><span class="hljs-number">65000</span></span> <span class="hljs-number"><span class="hljs-number">64999</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ? &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">16</span></span>, Push <span class="hljs-number"><span class="hljs-number">299824</span></span>(top)</code> </pre><br>  PE1 sticks two tags: <br><br>  16 - vrf tag received via RR1 from ASBR1 <br>  299824 - transport label obtained by the ldp protocol <br><br>  and sends the packet to the interface ge-0/0 / 0.0 towards P1. <br>  P1 according to the table mpls.0 (since it is a transit router) removes the top label (works out the php mechanism) and sends this packet to ASBR1: <br><pre> <code class="cpp hljs">bormoglotx@P1&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> label <span class="hljs-number"><span class="hljs-number">299824</span></span> mpls<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span> destinations, <span class="hljs-number"><span class="hljs-number">9</span></span> routes (<span class="hljs-number"><span class="hljs-number">9</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">299824</span></span> *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>, Pop <span class="hljs-number"><span class="hljs-number">299824</span></span>(S=<span class="hljs-number"><span class="hljs-number">0</span></span>) *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>, Pop</code> </pre><br>  ASBR1 removes the vrf label and makes an ip lookup in the CE1.inet.0 table (do not forget to give the vrf-table-label command on JunOS): <br><pre> <code class="cpp hljs">bormoglotx@ASBR1&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> label <span class="hljs-number"><span class="hljs-number">16</span></span> mpls<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> destinations, <span class="hljs-number"><span class="hljs-number">10</span></span> routes (<span class="hljs-number"><span class="hljs-number">10</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">16</span></span> *[VPN/<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> to table CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>, Pop bormoglotx@ASBR1&gt; show route table CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span> destinations, <span class="hljs-number"><span class="hljs-number">7</span></span> routes (<span class="hljs-number"><span class="hljs-number">7</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span> AS path: <span class="hljs-number"><span class="hljs-number">64999</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ? &gt; to <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.0</span></span></code> </pre><br>  The packet from ASBR1 is transmitted via ge-0/0/3 interface to ASBR2 without mpls header ‚Äî only pure ip traffic (usually tagged, in our case only one vrf, so I did not make subinterfaces when you have several vrfs, you have to make a separate subinterface for each vpn and specify it in the vrf settings). <br>  ASBR2, having received an IP packet, looks for a route in the routing table of vrf CE2: <br><pre> <code class="cpp hljs">ASBR2<span class="hljs-meta"><span class="hljs-meta">#show ip route vrf CE2 10.0.1.0 Routing Table: CE2 Routing entry for 10.0.1.0/24 Known via </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"bgp 2"</span></span></span><span class="hljs-meta">, distance 200, metric 0, type internal Last update from 10.1.10.1 00:20:49 ago Routing Descriptor Blocks: * 10.1.10.1 (default), from 10.1.10.10, 00:20:49 ago Route metric is 0, traffic share count is 1 AS Hops 0 MPLS label: 22 MPLS Flags: MPLS Required</span></span></code> </pre><br><pre> <code class="cpp hljs">ASBR2<span class="hljs-meta"><span class="hljs-meta">#sh mpls forwarding-table 10.1.10.1 Local Outgoing Prefix Bytes Label Outgoing Next Hop Label Label or Tunnel Id Switched interface 21 18 10.1.10.1/32 0 Gi1/0 10.1.0.2 17 10.1.10.1/32 0 Gi2/0 10.1.2.2</span></span></code> </pre><br>  According to the route, ASBR2 hangs the vrf (22) tag received by bgp vpnv4 from PE2 and sends it to lsp to PE2 (10.1.10.1).  Next-hop in the route is P2 or RR2 (in our case the reflector works as a P-router).  We assume that the traffic will go through P2 and we will look at operations with labels on it.  P2 receives a packet with two labels 22 and 17, looks in mpls forwarding-table: <br><pre> <code class="cpp hljs">P1<span class="hljs-meta"><span class="hljs-meta">#sh mpls forwarding-table labels 17 Local Outgoing Prefix Bytes Label Outgoing Next Hop Label Label or Tunnel Id Switched interface 17 Pop Label 10.1.10.1/32 18542 Gi1/0 10.1.3.1</span></span></code> </pre><br>  According to mpls forwarding-table, P2 removes the top tag (php again) and sends the packet to PE2. <br><br>  PE2 sees that this label points to vrf CE2, produces an ip lookup in the vrf CE2 table and sends a clear ip packet to the client: <br><pre> <code class="cpp hljs">PE2<span class="hljs-meta"><span class="hljs-meta">#sh mpls forwarding-table labels 22 Local Outgoing Prefix Bytes Label Outgoing Next Hop Label Label or Tunnel Id Switched interface 22 No Label 10.0.1.0/24[V] 14450 aggregate/CE2 PE2#sh ip rou vrf CE2 10.0.1.0 Routing Table: CE2 Routing entry for 10.0.1.0/24 Known via </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"connected"</span></span></span><span class="hljs-meta">, distance 0, metric 0 (connected, via interface) Redistributing via bgp 2 Advertised by bgp 2 Routing Descriptor Blocks: * directly connected, via GigabitEthernet3/0.10 Route metric is 0, traffic share count is 1</span></span></code> </pre><br>  It is clear that this solution is quite difficult to scale.  If you connect a new client, then you will need to create vrf not only on the PE router, on which this client will be terminated, but also on the ASBR (and they will have to do the same on the other side).  Naturally, this solution does not satisfy today's requests of telecom operators, so we will move on to considering more interesting solutions - options B and C. <br><br>  <b>Option B.</b> <br><br>  Between the ASBR, a vpnv4 session is raised, within which vpnv4 routes are exchanged (of course, it is necessary to set up filtering on the ASBR of the given and received prefixes, so as not to give or not get something extra).  But we know that the router drops the vpnv4 routes (except Juniper routers) if it does not have a VRF to which (s) these routes are intended (if the target-target specified in the NLRI is not in any of the import vrfs).  To change this default behavior on the ASBR, you must enable all vpnv4 routes (keep all - Juniper, no bgp default route-target filter - IOS, retain route-target all - IOS XR, undo policy vpn-target - Huawei). <br><br>  Note: on Juniper routers, there is no need to keep all command, because when configuring an eBGP vpnv4 session, the router automatically considers itself an ASBR for option B, therefore it accepts and installs all routes received from peers of vpnv4 into the bgp.l3vpn.0 table and sends these routes to their feasts. <br><br>  <b>Let's start with the control plane:</b> <b><br></b> <img src="https://habrastorage.org/files/249/a35/aa9/249a35aa945a4a4b8e654132534af967.jpg"><br>  1. PE2 generates a vpnv4 route and sends it to the router reflector RR2. <br><br>  2. Route reflector RR2 forwards this route to all its clients. <br><br>  3. ASBR2, being a client of the reflector, receives the generated PE2 vpnv4 route.  Since the no bgp default route-target filter option is enabled on it, ASBR2 installs the received route into the routing table. <br><br>  4. ASBR2 changes the next-hop route received from the router reflector to itself, generates a new label (and the value of the label may not change) and sends this route to the ASBR1 via ebgp vpnv4 session. <br><br>  5. ASBR1 takes the vpnv4 route from ASBR2 and installs it in the routing table bgp.l3vpn.0. <br><br>  6. ASBR1 changes the next-hop route received from ASBR2 to itself, generates a new mpls tag and sends this route to RR1. <br><br>  7. RR1, having received this route, checks the availability of next-hop, as-path (the standard mechanism for choosing the best route bgp) and installs this route into its routing table. <br><br>  8. RR1 sends the route received from ASBR1 to PE1. <br><br>  9. PE1, having received the vpnv4 route from the router, checks the availability of the next-hop, checks whether extremity (rt) in the received route matches the configured vrf-import router and installs it into the routing table of the corresponding vrf. <br><br>  Transport tags to ASBR within AS are distributed in a standard way - LDP or RSVP-TE. <br><br>  Now let's look at the above with an example: <br><img src="https://habrastorage.org/files/34c/6f1/60f/34c6f160f6d8414f88b8689e488e121b.jpg"><br>  Consider how the label will be signaled for the client prefix 10.0.1.0/24, which is terminated on PE2 vrf CE2: <br><pre> <code class="cpp hljs">PE2<span class="hljs-meta"><span class="hljs-meta">#sh ip route vrf CE2 10.0.1.0 Routing Table: CE2 Routing entry for 10.0.1.0/24 Known via </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"connected"</span></span></span><span class="hljs-meta">, distance 0, metric 0 (connected, via interface) Redistributing via bgp 2 Advertised by bgp 2 Routing Descriptor Blocks: * directly connected, via GigabitEthernet3/0.10 Route metric is 0, traffic share count is 1</span></span></code> </pre><br>  PE2 generates a vpnv4 route and sends it via iBGP to the RR2 router: <br><pre> <code class="cpp hljs">PE2<span class="hljs-meta"><span class="hljs-meta">#sh ip bgp vpnv4 rd 2:1 10.0.1.0/24 BGP routing table entry for 2:1:10.0.1.0/24, version 2 Paths: (1 available, best #1, table CE2) Advertised to update-groups: 1 Local 0.0.0.0 from 0.0.0.0 (10.1.10.1) Origin incomplete, metric 0, localpref 100, weight 32768, valid, sourced, best Extended Community: RT:1:100 OSPF DOMAIN ID:0x0005:0x000000020200 OSPF RT:0.0.0.0:2:0 OSPF ROUTER ID:10.0.1.1:0 mpls labels in/out 17/nolabel(CE2)</span></span></code> </pre><br>  According to the above output, label 17 is generated for this prefix: mpls labels in / out 17 / nolabel (CE2) <br>  Next, PE2 sends vpnv4 routes to the router.  There are two routes, since one is the network between PE2 and CE2, and the second is a loopback client router CE2. <br><pre> <code class="cpp hljs">PE2<span class="hljs-meta"><span class="hljs-meta">#sh ip bgp vpnv4 all neighbors 10.1.10.10 advertised-routes BGP table version is 39, local router ID is 10.1.10.1 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale Origin codes: i - IGP, e - EGP, ? - incomplete Originating default network 0.0.0.0 Network Next Hop Metric LocPrf Weight Path Route Distinguisher: 2:1 (default for vrf CE1) *&gt; 10.0.1.0/24 0.0.0.0 0 32768 ? *&gt; 10.1.1.2/32 10.0.1.2 2 32768 ? Total number of prefixes 2</span></span></code> </pre><br>  Route reflector RR2 passes the route received from PE2 vpnv4 to its clients, including ASBR2: <br><pre> <code class="cpp hljs">RR2<span class="hljs-meta"><span class="hljs-meta">#sh ip bgp vpnv4 rd 2:1 neighbors 10.1.10.3 advertised-routes BGP table version is 21, local router ID is 10.1.10.10 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale Origin codes: i - IGP, e - EGP, ? - incomplete Originating default network 0.0.0.0 Network Next Hop Metric LocPrf Weight Path Route Distinguisher: 2:1 *&gt;i10.0.1.0/24 10.1.10.1 0 100 0 ? *&gt;i10.1.1.2/32 10.1.10.1 2 100 0 ? Total number of prefixes 2</span></span></code> </pre><br>  ASBR2 accepts this route and installs it into the routing table: <br><pre> <code class="cpp hljs">ASBR2<span class="hljs-meta"><span class="hljs-meta">#sh ip bgp vpnv4 rd 2:1 10.0.1.0/24 BGP routing table entry for 2:1:10.0.1.0/24, version 4 Paths: (1 available, best #1, no table) Advertised to update-groups: 1 Local 10.1.10.1 (metric 3) from 10.1.10.10 (10.1.10.10) Origin incomplete, metric 0, localpref 100, valid, internal, best Extended Community: RT:1:100 OSPF DOMAIN ID:0x0005:0x000000020200 OSPF RT:0.0.0.0:2:0 OSPF ROUTER ID:10.0.1.1:0 Originator: 10.1.10.1, Cluster list: 10.1.10.10 mpls labels in/out 26/17</span></span></code> </pre><br>  Pay attention to the line "mpls labels in / out 26/17".  ASBR2 generates a new label on in - 26 and sends all its existing vpnv4 routes (or not all if filtering is set to out) to the next AS on ASBR1: <br><pre> <code class="cpp hljs">ASBR2<span class="hljs-meta"><span class="hljs-meta">#sh ip bgp vpnv4 rd 2:1 neighbors 10.2.0.1 advertised-routes BGP table version is 13, local router ID is 10.1.10.3 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale Origin codes: i - IGP, e - EGP, ? - incomplete Originating default network 0.0.0.0 Network Next Hop Metric LocPrf Weight Path Route Distinguisher: 2:1 *&gt;i10.0.1.0/24 10.1.10.1 0 100 0 ? *&gt;i10.1.1.2/32 10.1.10.1 2 100 0 ? Total number of prefixes 2</span></span></code> </pre><br>  ASBR1 accepts these routes and installs to the routing table: <br><pre> <code class="cpp hljs">bormoglotx@ASBR1&gt; show route receive-protocol bgp <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> detail inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">13</span></span> destinations, <span class="hljs-number"><span class="hljs-number">13</span></span> routes (<span class="hljs-number"><span class="hljs-number">13</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> destinations, <span class="hljs-number"><span class="hljs-number">4</span></span> routes (<span class="hljs-number"><span class="hljs-number">4</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) * <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) Accepted Route Distinguisher: <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">26</span></span> Nexthop: <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> AS path: <span class="hljs-number"><span class="hljs-number">2</span></span> ? Communities: target:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> domain-id:<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">131584</span></span> route-type-vendor:<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> router-id-vendor:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Besides the fact that ASBR2 generated a new label, he also changed next-hop to himself (Nexthop: 10.2.0.2). <br>  ASBR1 generates a new label (VPN Label: 299888) to the prefix 10.0.1.0/24, changes the next-hop to itself (Nexthop: Self) and gives the route to the router-reflector RR1 <br><pre> <code class="cpp hljs">bormoglotx@ASBR1&gt; show route advertising-protocol bgp <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> detail bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> destinations, <span class="hljs-number"><span class="hljs-number">4</span></span> routes (<span class="hljs-number"><span class="hljs-number">4</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) * <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) BGP group RR type Internal Route Distinguisher: <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">299888</span></span> Nexthop: Self Flags: Nexthop Change Localpref: <span class="hljs-number"><span class="hljs-number">100</span></span> AS path: [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">2</span></span> ? Communities: target:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> domain-id:<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">131584</span></span> route-type-vendor:<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> router-id-vendor:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Route reflector RR1 gives the route to its customers, including PE1: <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show route receive-protocol bgp <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> detail inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span> destinations, <span class="hljs-number"><span class="hljs-number">11</span></span> routes (<span class="hljs-number"><span class="hljs-number">11</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> destinations, <span class="hljs-number"><span class="hljs-number">6</span></span> routes (<span class="hljs-number"><span class="hljs-number">6</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) * <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) Import Accepted Route Distinguisher: <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">299888</span></span> Nexthop: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> Localpref: <span class="hljs-number"><span class="hljs-number">100</span></span> AS path: <span class="hljs-number"><span class="hljs-number">2</span></span> ? (Originator) Cluster <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> AS path: Originator ID: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> Communities: target:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> domain-id:<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">131584</span></span> route-type-vendor:<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> router-id-vendor:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> destinations, <span class="hljs-number"><span class="hljs-number">2</span></span> routes (<span class="hljs-number"><span class="hljs-number">2</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) * <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">0</span></span> announced) Import Accepted Route Distinguisher: <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> VPN Label: <span class="hljs-number"><span class="hljs-number">299888</span></span> Nexthop: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> Localpref: <span class="hljs-number"><span class="hljs-number">100</span></span> AS path: <span class="hljs-number"><span class="hljs-number">2</span></span> ? (Originator) Cluster <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> AS path: Originator ID: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> Communities: target:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> domain-id:<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">131584</span></span> route-type-vendor:<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> router-id-vendor:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  We see the route in two tables: in the vrf CE1.inet.0 table and in the bgp vpnv4 table of the bgp.l3vpn.0 routes. <br>  When receiving vpnv4 routes, JunOS checks them for suitability (AS-PATH, next-hop availability), whether there is a routing instance for import specified in the vpnv4 route in the configuration, and if the route passes these checks and is selected by the best according to the bgp staff selection algorithm best path , it is installed on the bgp.l3vpn.0 table.  And already from this ip table, the prefix is ‚Äã‚Äãtransferred to the vrf table (CE1.inet.0 in our case). <br><br>  <b>Data-plane:</b> <br><img src="https://habrastorage.org/files/d5d/ee4/7d1/d5dee47d1d714636a1e25839d3b0bc5f.jpg"><br>  With the alarm tags, we figured out.  Now consider the data plane, that is, how the packet will be sent from CE1 (from 10.0.0.2) to CE2 (10.0.1.2) via the ‚Äúmpls cloud‚Äù. <br>  First, let's start ping between CE routers and make sure that there is connectivity between the hosts: <br><pre> <code class="cpp hljs">CE1<span class="hljs-meta"><span class="hljs-meta">#ping 10.0.1.2 Type escape sequence to abort. Sending 5, 100-byte ICMP Echos to 10.1.1.2, timeout is 2 seconds: !!!!! Success rate is 100 percent (5/5), round-trip min/avg/max = 52/91/132 ms</span></span></code> </pre><br>  Now we will do the trace: <br><pre> <code class="cpp hljs">R5<span class="hljs-meta"><span class="hljs-meta">#traceroute 10.0.1.2 numeric timeout 1 Type escape sequence to abort. Tracing the route to 10.0.1.2 1 10.0.0.1 32 msec 4 msec 12 msec 2 10.0.2.2 [MPLS: Labels 299792/299888 Exp 0] 48 msec 68 msec 52 msec 3 10.0.3.1 [MPLS: Label 299888 Exp 0] 48 msec 60 msec 52 msec 4 10.2.0.2 [MPLS: Label 26 Exp 0] 64 msec 52 msec 52 msec 5 10.1.0.2 [MPLS: Labels 19/17 Exp 0] 48 msec 60 msec 52 msec 6 10.0.1.1 52 msec 52 msec 56 msec 7 10.0.1.2 48 msec 64 msec 108 msec</span></span></code> </pre><br>  It is seen that the maximum number of tags - 2. <br><br>  Note: there may be more if you use traffic-engineereng.  In our case, the label distributes only ldp. <br><br>  Now let's deal with label operations when a packet is moving over the network. <br>  On PE1, a pure IP packet arrives from the CE1 client router (in our case with the vlan tag 10, but this does not matter, since this is l3vpn and the tag is removed).  The route to PE1 indicates that the packet must be sent to the mpls tunnel.  PE1 hangs two tags: the vrf tag is 299888 (which we received from ASBR1) and the transport tag to ASBR1 is 299792 (obtained via the ldp protocol): <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show route table CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> destinations, <span class="hljs-number"><span class="hljs-number">6</span></span> routes (<span class="hljs-number"><span class="hljs-number">6</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">32</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, from <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> AS path: <span class="hljs-number"><span class="hljs-number">2</span></span> ? to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">299888</span></span>, Push <span class="hljs-number"><span class="hljs-number">299792</span></span>(top) &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">299888</span></span>, Push <span class="hljs-number"><span class="hljs-number">299792</span></span>(top)</code> </pre><br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show interfaces descriptions Interface Admin Link Description ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> up up to P1 ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> up up to RR1 ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3</span></span> up up to SW1 lo0 up up router-id</code> </pre><br>  PE1 sends this packet to the interface ge-0/0/1 towards RR1 (in our case, the router also performs the function of the P-router). <br>  RR1 receives a packet with a stack of tags and analyzes the top tag 299792: <br><pre> <code class="cpp hljs">bormoglotx@RR1&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> label <span class="hljs-number"><span class="hljs-number">299792</span></span> mpls<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span> destinations, <span class="hljs-number"><span class="hljs-number">9</span></span> routes (<span class="hljs-number"><span class="hljs-number">9</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">299792</span></span> *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, Pop <span class="hljs-number"><span class="hljs-number">299792</span></span>(S=<span class="hljs-number"><span class="hljs-number">0</span></span>) *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, Pop</code> </pre><br>  According to the table mpls.0, RR1 removes the label (php) and sends the packet to the interface ge-0/0 / 0.0 towards ASBR2. <br>  ASBR2 receives a stake with only one mark 299888. We look at what it should do: <br><pre> <code class="cpp hljs">bormoglotx@ASBR1&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> label <span class="hljs-number"><span class="hljs-number">299888</span></span> mpls<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span> destinations, <span class="hljs-number"><span class="hljs-number">12</span></span> routes (<span class="hljs-number"><span class="hljs-number">12</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">299888</span></span> *[VPN/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.0</span></span>, Swap <span class="hljs-number"><span class="hljs-number">26</span></span></code> </pre><br>  ASBR1 swaps the tag 299888 to tag 26 and sends the packet through the junction with AS2 to ASBR2. <br><br>  Further, ASBR2 also produces a swap of the mark 26 on the mark 17 (he received it from PE2) <br><pre> <code class="cpp hljs">ASBR2<span class="hljs-meta"><span class="hljs-meta">#show ip bgp vpnv4 rd 2:1 10.0.1.0/24 BGP routing table entry for 2:1:10.0.1.0/24, version 4 Paths: (1 available, best #1, no table) Advertised to update-groups: 1 Local 10.1.10.1 (metric 3) from 10.1.10.10 (10.1.10.10) Origin incomplete, metric 0, localpref 100, valid, internal, best Extended Community: RT:1:100 OSPF DOMAIN ID:0x0005:0x000000020200 OSPF RT:0.0.0.0:2:0 OSPF ROUTER ID:10.0.1.1:0 Originator: 10.1.10.1, Cluster list: 10.1.10.10 mpls labels in/out 26/17</span></span></code> </pre><br>  So, as the next-hop route is 10.1.10.1, then ASBR2 must also add a transport label (19) to PE2: <br><pre> <code class="cpp hljs">ASBR2<span class="hljs-meta"><span class="hljs-meta">#sh mpls forwarding-table 10.1.10.1 Local Outgoing Prefix Bytes Label Outgoing Next Hop Label Label or Tunnel Id Switched interface 23 19 10.1.10.1/32 0 Gi1/0 10.1.0.2 19 10.1.10.1/32 0 Gi2/0 10.1.2.2</span></span></code> </pre><br>  The packet is sent to RR2 or P2, since the paths are equivalent ... Let's see what it will do with this P2 packet: <br><pre> <code class="cpp hljs">P1<span class="hljs-meta"><span class="hljs-meta">#sh mpls forwarding-table labels 19 Local Outgoing Prefix Bytes Label Outgoing Next Hop Label Label or Tunnel Id Switched interface 19 Pop Label 10.1.10.1/32 1180 Gi1/0 10.1.3.1</span></span></code> </pre><br>  P2 removes the tag and sends a packet with one tag to PE2. <br><br>  PE2 receives a packet with a single tag 17, which is the vrf tag.  In this case, the distribution of labels on the prefix is ‚Äã‚Äãused (one label is one client prefix), which in real life is naturally too wasteful, therefore the distribution mode of the labels must be switched - per-vrf (one label per vrf).  Unlike Cisco, JunOS default label distribution mechanism is per-next-hop.  If the client has an Ethernet link, which is natural in the overwhelming majority of cases, then it is necessary to enable per-vrf tag generation with the vrf-table-label command.  The principle of packet processing in this case is changing, and is worthy of a separate article. <br><pre> <code class="cpp hljs">PE2<span class="hljs-meta"><span class="hljs-meta">#show mpls forwarding-table labels 17 Local Outgoing Prefix Bytes Label Outgoing Next Hop Label Label or Tunnel Id Switched interface 17 No Label 10.0.1.0/24[V] 0 aggregate/CE1 PE2#sh ip bgp vpnv4 rd 2:1 10.0.1.0/24 BGP routing table entry for 2:1:10.0.1.0/24, version 2 Paths: (1 available, best #1, table CE1) Advertised to update-groups: 1 Local 0.0.0.0 from 0.0.0.0 (10.1.10.1) Origin incomplete, metric 0, localpref 100, weight 32768, valid, sourced, best Extended Community: RT:1:100 OSPF DOMAIN ID:0x0005:0x000000020200 OSPF RT:0.0.0.0:2:0 OSPF ROUTER ID:10.0.1.1:0 mpls labels in/out 17/nolabel(CE1)</span></span></code> </pre><br>  According to the above information, PE2 removes the label 17, does an ip lookup in the vrf CE1 table and sends the packet to the client. <br><br>  ASBR configurations: <br><pre> <code class="cpp hljs">bormoglotx@ASBR1<span class="hljs-meta"><span class="hljs-meta"># show keep all; group RR { type internal; local-address 10.0.10.3; family inet-vpn { unicast; } export NHS; neighbor 10.0.10.10; } group ASBR-AS2 { type external; local-address 10.2.0.1; family inet-vpn { unicast; } peer-as 2; neighbor 10.2.0.2; }</span></span></code> </pre><br><pre> <code class="cpp hljs">ASBR2<span class="hljs-meta"><span class="hljs-meta">#sh configuration | b router bgp router bgp 2 no synchronization no bgp default route-target filter bgp log-neighbor-changes neighbor 10.1.10.10 remote-as 2 neighbor 10.1.10.10 description RR2 neighbor 10.1.10.10 update-source Loopback0 neighbor 10.2.0.1 remote-as 1 neighbor 10.2.0.1 description ASBR1 | AS2 neighbor 10.2.0.1 update-source GigabitEthernet3/0 no auto-summary ! address-family vpnv4 neighbor 10.1.10.10 activate neighbor 10.1.10.10 send-community extended neighbor 10.1.10.10 next-hop-self neighbor 10.2.0.1 activate neighbor 10.2.0.1 send-community extended exit-address-family ASBR2#sh run int gi3/0 Building configuration... Current configuration : 143 bytes ! interface GigabitEthernet3/0 description to ASBR1 | AS1 ip address 10.2.0.2 255.255.255.252 negotiation auto mpls bgp forwarding ! end</span></span></code> </pre><br>  I would like to add that there are two types of Option B. We have considered the first method - the most common - the ASBR performs the substitution of the next-hop when passing a route inside an autonomous system (when passing a route to a reflector).  The second way is that the ASBR, as expected for the ibgp session, when announcing the route to the reflector did not replace the next-hop to its address.  But then the network between the ASBRs should be announced in the IGP (you can link between the ASBRs to make a passive interface or prescribe statics on the ASBRs and redistribute it into the IGPs).  This is necessary so that the PE routers can set the BGP route to their tables (next-hop availability check) and ldp generates a label to this prefix. <br><br>  With Option B I think sorted out.  We turn to Option C. <br><br>  <b>Option C</b> <br><br>  The vpnv4 routes are exchanged between different AS router-reflectors directly through the ebgp-multihop session, and the ASBR-ry has the task of distributing routes with mpls tags to the loopbacks of the router and PE routers of the neighboring autonomous system. <br><br>  <b>Consider how the control plane works:</b> <br><img src="https://habrastorage.org/files/7f9/26f/738/7f926f7388d144d08708a242b119c164.jpg"><br>  <i>Distribution of transport tags:</i> <br><br>  1. ASBR2 protocol ldp receives from its neighbors label to PE2. <br><br>  2. ASBR2, according to the configured policy, generates routes with labels to the Lubeks of its autonomous system and sends these routes to ASBR1 via bgp labeled-unicast, indicating itself in the next-hop route. <br><br>  3. ASBR1 takes the labeled-unicast route from ASBR2 and installs them in mpls forwarding table. <br><br>  4. ASBR1 generates labels for routes received from ASBR2, points itself to next-hop and gives routes to RR1. <br><br>  5. RR1, having received these routes, checks the route for validity, installs it in its routing table and sends it to all the rest of its customers. <br><br>  6. PE1, after receiving the labeled-unicast route from the router, performs its validation and installs the route into the routing table. <br><br>  <i>Vrf label distribution:</i> <br><br>  1. PE2 generates a vpnv4 route and sends it to the router reflector RR2. <br><br>  2. Route reflector RR2 forwards this route to all its clients and RR1 via eBGP multihop session without changing the next-hop and label values. <br><br>  3. RR1 transmits the route received from RR2 to all its customers, including PE1. <br><br>  4. PE1 checks the route for suitability and sets the corresponding vrf in the routing table. <br><br>  The vrf and transport labels are distributed. <br><br>  Now let's see how this all works in practice.  First, we need to distribute the loopback routes between autonomous systems, since our vpnv4 session between the router reflexors does not rise due to the lack of a route to the remote router reflector.  We will distribute routes with labels at once between autonomous systems, so there will only be a labeled-unicast session between ASBRs (we don‚Äôt need ipv4 prefixes without tags).  But if you need both address families, you will need to specify that the labeled-unicast routes need to be installed in inet.3 (otherwise, on JunOS you don‚Äôt raise the two ibv4 and ipv4 labeled-unicast address families in one session). <br><img src="https://habrastorage.org/files/880/493/da8/880493da8cd542beb5e8c2722c0414d3.jpg"><br>  Bgp configuration on ASBR1 (session with ASBR2): <br><pre> <code class="cpp hljs">bormoglotx@ASBR1&gt; show configuration protocols bgp group ASBR-AS2 type external; local-address <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; family inet { labeled-unicast; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> Lo-<span class="hljs-keyword"><span class="hljs-keyword">export</span></span>; peer-as <span class="hljs-number"><span class="hljs-number">2</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>;</code> </pre><br><pre> <code class="cpp hljs">bormoglotx@ASBR1&gt; show configuration policy-options policy-statement Lo-<span class="hljs-keyword"><span class="hljs-keyword">export</span></span> term <span class="hljs-number"><span class="hljs-number">1</span></span> { from { protocol isis; route-filter <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> prefix-length-range /<span class="hljs-number"><span class="hljs-number">32</span></span>-/<span class="hljs-number"><span class="hljs-number">32</span></span>; } then accept; } term <span class="hljs-number"><span class="hljs-number">2</span></span> { then reject;</code> </pre><br>  Let's see how the signaling of the tag to the loopback PE2 will work. <br><br>  So, inside the autonomous system, we run ldp and the tags to the loopbacks automatically fly throughout the AS.  Naturally, ASBR2 has tags up to the loopbacks of all AS2 routers.  Now ASBR2 should generate routes with labels to the loopbacks of its AS and transfer them to ASBR1.  We'll see: <br><pre> <code class="cpp hljs">ASBR2<span class="hljs-meta"><span class="hljs-meta">#sh ip bgp 10.1.10.1/32 BGP routing table entry for 10.1.10.1/32, version 2 Paths: (1 available, best #1, table default) Advertised to update-groups: 1 2 Local 10.1.0.2 from 0.0.0.0 (10.1.10.3) Origin incomplete, metric 3, localpref 100, weight 32768, valid, sourced, best mpls labels in/out 22/nolabel</span></span></code> </pre><br>  As can be seen from the output, ASBR2 generated a label before the prefix 10.1.10.1 to in, equal to 22. <br><br>  Let's see this route on ASBR1: <br><pre> <code class="cpp hljs">bormoglotx@ASBR1&gt; show route receive-protocol bgp <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> detail inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">17</span></span> destinations, <span class="hljs-number"><span class="hljs-number">20</span></span> routes (<span class="hljs-number"><span class="hljs-number">17</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) * <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) Accepted Route Label: <span class="hljs-number"><span class="hljs-number">22</span></span> Nexthop: <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> MED: <span class="hljs-number"><span class="hljs-number">3</span></span> AS path: <span class="hljs-number"><span class="hljs-number">2</span></span> ?</code> </pre><br>  We are interested in the output label: 22 and next-hop: 10.2.0.2 (address of the ASBR2 interface).  Now ASBR1 knows how to get to PE2. <br><br>  Further, this route through the labeled -unicast session is transmitted to the reflector and distributed from it inside the autonomous system between the PE routers.  But there is one thing: if ASBR1 passes the route in the same form as it received from ASBR2, it will not work, because there is no route to the network 10.2.0.0/30 (the network between ASBRs) inside the autonomous system.  Therefore, ASBR1 changes the next-hop to itself and generates a new label: <br><pre> <code class="cpp hljs">bormoglotx@ASBR1&gt; show route advertising-protocol bgp <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> detail inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">17</span></span> destinations, <span class="hljs-number"><span class="hljs-number">20</span></span> routes (<span class="hljs-number"><span class="hljs-number">17</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) * <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) BGP group RR type Internal Route Label: <span class="hljs-number"><span class="hljs-number">299920</span></span> Nexthop: Self Flags: Nexthop Change MED: <span class="hljs-number"><span class="hljs-number">3</span></span> Localpref: <span class="hljs-number"><span class="hljs-number">100</span></span> AS path: [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">2</span></span> ?</code> </pre><br>  Now let's see this route on PE1: <br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show route protocol bgp <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span> destinations, <span class="hljs-number"><span class="hljs-number">15</span></span> routes (<span class="hljs-number"><span class="hljs-number">15</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>, MED <span class="hljs-number"><span class="hljs-number">3</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, from <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> AS path: <span class="hljs-number"><span class="hljs-number">2</span></span> ? &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">299920</span></span>, Push <span class="hljs-number"><span class="hljs-number">299776</span></span>(top) to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">299920</span></span>, Push <span class="hljs-number"><span class="hljs-number">299776</span></span>(top) inet<span class="hljs-number"><span class="hljs-number">.3</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span> destinations, <span class="hljs-number"><span class="hljs-number">7</span></span> routes (<span class="hljs-number"><span class="hljs-number">7</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>, MED <span class="hljs-number"><span class="hljs-number">3</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, from <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> AS path: <span class="hljs-number"><span class="hljs-number">2</span></span> ? &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">299920</span></span>, Push <span class="hljs-number"><span class="hljs-number">299776</span></span>(top) to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">299920</span></span>, Push <span class="hljs-number"><span class="hljs-number">299776</span></span>(top)</code> </pre><br>  That's right, label 299920 is used to get to PE2.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the output, we also see another label 299776, that is, we have a stack of labels. </font><font style="vertical-align: inherit;">On the appointment of the second (299776) will be written below). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Great, now we have end-to-end lsp between PE1 and PE2. </font><font style="vertical-align: inherit;">As a matter of fact, there is also lsp between the reflectors now, as the routes to RR1 and RR2 are also given with labels. </font><font style="vertical-align: inherit;">After we have distributed the lupbek routes between autonomous systems, the neighborhood rises between the router reflectors:</font></font><br><pre> <code class="cpp hljs">bormoglotx@RR1&gt; show bgp neighbor <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> Peer: <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>+<span class="hljs-number"><span class="hljs-number">34875</span></span> AS <span class="hljs-number"><span class="hljs-number">2</span></span> Local: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>+<span class="hljs-number"><span class="hljs-number">179</span></span> AS <span class="hljs-number"><span class="hljs-number">1</span></span> Type: External State: Established Flags: &lt;Sync&gt; Last State: OpenConfirm Last Event: RecvKeepAlive Last Error: None Options: &lt;Multihop NoNextHopChange Preference LocalAddress Ttl AddressFamily PeerAS Rib-group Refresh&gt; Address families configured: inet-vpn-unicast Local Address: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> Holdtime: <span class="hljs-number"><span class="hljs-number">90</span></span> Preference: <span class="hljs-number"><span class="hljs-number">170</span></span> Number of flaps: <span class="hljs-number"><span class="hljs-number">0</span></span> Peer ID: <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> Local ID: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> Active Holdtime: <span class="hljs-number"><span class="hljs-number">90</span></span> Keepalive Interval: <span class="hljs-number"><span class="hljs-number">30</span></span> Peer index: <span class="hljs-number"><span class="hljs-number">0</span></span> BFD: disabled, down NLRI <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> restart configured on peer: inet-vpn-unicast NLRI advertised by peer: inet-unicast inet-vpn-unicast NLRI <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> session: inet-vpn-<span class="hljs-function"><span class="hljs-function">unicast Peer supports Refresh </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">capability</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Stale routes from peer are kept </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">for</span></span></span><span class="hljs-function">: 300 Peer does </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">not</span></span></span><span class="hljs-function"> support Restarter functionality Peer does </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">not</span></span></span><span class="hljs-function"> support Receiver functionality Peer supports 4 byte AS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">extension</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(peer-as </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Peer does </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">not</span></span></span><span class="hljs-function"> support Addpath Table bgp.l3vpn.0 Bit: 20001 RIB State: BGP restart is complete RIB State: VPN restart is complete Send state: in sync Active prefixes: 2 Received prefixes: 2 Accepted prefixes: 2 Suppressed due to damping: 0 Advertised prefixes: 2 Last </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">traffic</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(seconds)</span></span></span><span class="hljs-function">: Received 20 Sent 13 Checked 68 Input messages: Total 210 Updates 3 Refreshes 0 Octets 4222 Output messages: Total 212 Updates 2 Refreshes 0 Octets 4205 Output Queue[1]: 0</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vpnv4 routes are distributed between reflectors: NLRI for this session: inet-vpn-unicast. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We accept 2 prefixes from the neighbor: Accepted prefixes: 2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And give the same amount: Advertised prefixes: 2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I think this is understandable. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reflector settings:</font></font><br><pre> <code class="cpp hljs">bormoglotx@RR1<span class="hljs-meta"><span class="hljs-meta"># show protocols bgp group RR-AS2 type external; multihop { ttl 5; no-nexthop-change; } local-address 10.0.10.10; family inet-vpn { unicast; } peer-as 2; neighbor 10.1.10.10;</span></span></code> </pre><br><br><pre> <code class="cpp hljs">RR2<span class="hljs-meta"><span class="hljs-meta">#sh configuration | b router bgp router bgp 2 bgp log-neighbor-changes neighbor 10.0.10.10 remote-as 1 neighbor 10.0.10.10 ebgp-multihop 5 neighbor 10.0.10.10 update-source Loopback0 ! address-family vpnv4 neighbor 10.0.10.10 activate neighbor 10.0.10.10 send-community extended neighbor 10.0.10.10 next-hop-unchanged exit-address-family</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note: In the RR2 configuration (Cisco IOS15), some of the lines not related to 10.0.10.10 are removed to reduce the size of the output. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we can see how the distribution of vrf tags works: </font></font><br><img src="https://habrastorage.org/files/cb0/d89/6fe/cb0d896fe94c4ca08a5ea601404be986.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PE2 generates a route to the network 10.0.1.0/24, which is terminated in vrf CE1</font></font><br><pre> <code class="cpp hljs">PE2<span class="hljs-meta"><span class="hljs-meta">#sh ip bgp vpnv4 rd 2:1 10.0.1.0/24 BGP routing table entry for 2:1:10.0.1.0/24, version 2 Paths: (1 available, best #1, table CE1) Advertised to update-groups: 1 Local 0.0.0.0 from 0.0.0.0 (10.1.10.1) Origin incomplete, metric 0, localpref 100, weight 32768, valid, sourced, best Extended Community: RT:1:100 OSPF DOMAIN ID:0x0005:0x000000020200 OSPF RT:0.0.0.0:2:0 OSPF ROUTER ID:10.0.1.1:0 mpls labels in/out 22/nolabel(CE1)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, label 22 was generated. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, the route is sent to RR2:</font></font><br><pre> <code class="cpp hljs">PE2<span class="hljs-meta"><span class="hljs-meta">#sh ip bgp vpnv4 all neighbors 10.1.10.10 advertised-routes BGP table version is 7, local router ID is 10.1.10.1 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale Origin codes: i - IGP, e - EGP, ? - incomplete Originating default network 0.0.0.0 Network Next Hop Metric LocPrf Weight Path Route Distinguisher: 2:1 (default for vrf CE1) *&gt; 10.0.1.0/24 0.0.0.0 0 32768 ? *&gt; 10.1.1.2/32 10.0.1.2 2 32768 ? Total number of prefixes 2</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Route reflector gives this route to all its customers, as well as on RR1: </font></font><br><pre> <code class="cpp hljs">RR2<span class="hljs-meta"><span class="hljs-meta">#sh ip bgp vpnv4 rd 2:1 neighbors 10.0.10.10 advertised-routes BGP table version is 5, local router ID is 10.1.10.10 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale Origin codes: i - IGP, e - EGP, ? - incomplete Originating default network 0.0.0.0 Network Next Hop Metric LocPrf Weight Path Route Distinguisher: 2:1 *&gt;i10.0.1.0/24 10.1.10.1 0 100 0 ? *&gt;i10.1.1.2/32 10.1.10.1 2 100 0 ? Total number of prefixes 2</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's see the resulting route on RR1: </font></font><br><pre> <code class="cpp hljs">bormoglotx@RR1&gt; show route table bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> destinations, <span class="hljs-number"><span class="hljs-number">4</span></span> routes (<span class="hljs-number"><span class="hljs-number">2</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">2</span></span> hidden)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The route hit the hidden and nowhere else spreads. </font><font style="vertical-align: inherit;">The question arises - why? </font><font style="vertical-align: inherit;">(And Cisco has no such trouble)</font></font><br><pre> <code class="cpp hljs">bormoglotx@RR1&gt; show route table bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> hidden bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> destinations, <span class="hljs-number"><span class="hljs-number">4</span></span> routes (<span class="hljs-number"><span class="hljs-number">2</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">2</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> [BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span>:<span class="hljs-number"><span class="hljs-number">12</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, from <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> AS path: <span class="hljs-number"><span class="hljs-number">2</span></span> ? Unusable</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's see the reason: </font></font><br><pre> <code class="cpp hljs">bormoglotx@RR1&gt; show route table bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> hidden detail bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> destinations, <span class="hljs-number"><span class="hljs-number">4</span></span> routes (<span class="hljs-number"><span class="hljs-number">2</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">2</span></span> hidden) <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">0</span></span> announced) BGP Preference: <span class="hljs-number"><span class="hljs-number">170</span></span>/<span class="hljs-number"><span class="hljs-number">-101</span></span> Route Distinguisher: <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> Next hop type: Unusable Address: <span class="hljs-number"><span class="hljs-number">0x8f3c5a4</span></span> Next-hop reference count: <span class="hljs-number"><span class="hljs-number">2</span></span> State: &lt;Hidden Ext&gt; Local AS: <span class="hljs-number"><span class="hljs-number">1</span></span> Peer AS: <span class="hljs-number"><span class="hljs-number">2</span></span> Age: <span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> Task: BGP_2<span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>+<span class="hljs-number"><span class="hljs-number">34875</span></span> AS path: <span class="hljs-number"><span class="hljs-number">2</span></span> ? Communities: target:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">100</span></span> domain-id:<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">131584</span></span> route-type-vendor:<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> router-id-vendor:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> Accepted VPN Label: <span class="hljs-number"><span class="hljs-number">22</span></span> Localpref: <span class="hljs-number"><span class="hljs-number">100</span></span> Router ID: <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the output opposite Next hop type is Unusable. </font><font style="vertical-align: inherit;">Routreflector checked the route for the availability of next-hop, but did not find a route to the specified next-hop in the routing table. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's look at the routing table:</font></font><br><pre> <code class="cpp hljs">bormoglotx@RR1&gt; show route <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span> destinations, <span class="hljs-number"><span class="hljs-number">15</span></span> routes (<span class="hljs-number"><span class="hljs-number">15</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>, MED <span class="hljs-number"><span class="hljs-number">3</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, from <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> AS path: <span class="hljs-number"><span class="hljs-number">2</span></span> ? &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">299920</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a route and even with a label (it is logical, we distributed it from ASBR1 to labeled-unicast). </font><font style="vertical-align: inherit;">The fact is that in JunOS (unlike other vendors) there are several routing tables. </font><font style="vertical-align: inherit;">Now we are interested in the inet.0 and inet.3 tables. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inet.0 is a routing table in which ipv4 unicast routes are stored. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inet.3 is the routing table in which ipv4 mpls routes are stored. </font><font style="vertical-align: inherit;">This table is used by the router if it is an ingress LSR.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BGP, getting vpnv4 routes, tries to split the next-hop in the inet table 3. By default, bgp labeled unicast routes are installed in the inet.0 table and they do not fall into inet.3. That is, the router-reflector received the vpnv4 route and tries to split the next-hop, but does not find the route to it in the inet.3 table and marks the vpnv4 route as hidden due to unusable next-hop. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Need to change this behavior. There are several levers for it: </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resolve-vpn</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - this command changes the JunOS standard behavior regarding the installation of labeled-unicast routes into the routing table. Now JunOS will install routes received by bgp labeled-unicast into both inet.0 and inet.3. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rib-groups</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- a very flexible mechanism, you can use the policy to drag certain routes (into the flesh to the / 32 prefix) from one routing table to another (in our case from inet.0 to inet.3) But with rib-groups you need to be careful, because you can break firewood without clearly understanding what you are doing (the possibilities of rib-groups are very large). </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resolution rib bgp.l3vpn.0 resolution-ribs inet.0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - this command allows you not to transfer anything anywhere, but only causes the router to resolve the vpnv4 routes in the inet.0 table. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the routerfleetor, give the resolution rib command, and on the PE router resolve-vpn:</font></font><br><pre> <code class="cpp hljs">bormoglotx@RR1<span class="hljs-meta"><span class="hljs-meta"># show routing-options router-id 10.0.10.10; autonomous-system 1; resolution { rib bgp.l3vpn.0 { resolution-ribs inet.0; } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now the routes on the reflector have appeared and can be distributed inside the autonomous system: </font></font><br><pre> <code class="cpp hljs">bormoglotx@RR1&gt; show route receive-protocol bgp <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span> destinations, <span class="hljs-number"><span class="hljs-number">15</span></span> routes (<span class="hljs-number"><span class="hljs-number">15</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) inet<span class="hljs-number"><span class="hljs-number">.3</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> destinations, <span class="hljs-number"><span class="hljs-number">3</span></span> routes (<span class="hljs-number"><span class="hljs-number">3</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) iso<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> destinations, <span class="hljs-number"><span class="hljs-number">1</span></span> routes (<span class="hljs-number"><span class="hljs-number">1</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) mpls<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span> destinations, <span class="hljs-number"><span class="hljs-number">9</span></span> routes (<span class="hljs-number"><span class="hljs-number">9</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> destinations, <span class="hljs-number"><span class="hljs-number">4</span></span> routes (<span class="hljs-number"><span class="hljs-number">4</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) Prefix Nexthop MED Lclpref AS path <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> * <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ? <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> * <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ?</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's see the route itself with the details: </font></font><br><pre> <code class="cpp hljs">bormoglotx@RR1&gt; show route protocol bgp rd-prefix <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> detail bgp.l3vpn<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> destinations, <span class="hljs-number"><span class="hljs-number">4</span></span> routes (<span class="hljs-number"><span class="hljs-number">4</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) *BGP Preference: <span class="hljs-number"><span class="hljs-number">170</span></span>/<span class="hljs-number"><span class="hljs-number">-101</span></span> Route Distinguisher: <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> Next hop type: Indirect Address: <span class="hljs-number"><span class="hljs-number">0x934d6d8</span></span> Next-hop reference count: <span class="hljs-number"><span class="hljs-number">1</span></span> Source: <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> Protocol next hop: <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Push <span class="hljs-number"><span class="hljs-number">22</span></span> Indirect next hop: <span class="hljs-number"><span class="hljs-number">2</span></span> no-forward State: &lt;Active Ext&gt; Local AS: <span class="hljs-number"><span class="hljs-number">1</span></span> Peer AS: <span class="hljs-number"><span class="hljs-number">2</span></span> Age: <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span> Metric2: <span class="hljs-number"><span class="hljs-number">1</span></span> Task: BGP_2<span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>+<span class="hljs-number"><span class="hljs-number">34875</span></span> <span class="hljs-function"><span class="hljs-function">Announcement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bits</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: 0-BGP_RT_Background AS path: 2 ? Communities: target:1:100 domain-id:0:131584 route-type-vendor:0.0.0.0:2:0 router-id-vendor:10.0.1.1:0 Accepted VPN Label: 22 Localpref: 100 Router ID: 10.1.10.10</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The output shows that the next-hop remained unchanged when crossing the border of the autonomous system, which is not typical of ebgp. The fact is that in the configuration (shown above) there is the no-nexthop-change command - JunOS, next-hop-unchanged - Cisco, which changes the standard behavior of ebgp and does not allow changing the next-hop when crossing the border of an autonomous system. What is it for. If you do not give this command, then in all vpnv4 routes the router will put itself next-hop, that is, all vpn traffic will climb through the router, which is not so sweet in life. Now, in addition to digesting heaps of routes (especially if it has FV), it will have to handle a huge amount of traffic. Actually, the end will always be the same - this scheme will fail, or to be more precise, the fall of the router with all the consequences.And even the presence of two backup reflectors will not help you. But let's return to our topology and see the vpnv4 route on PE1 (don't forget that we have already given the command resolve-vpn, otherwise the routes will fall into hidden):</font></font><br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show configuration protocols bgp group RR type internal; local-address <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; family inet { labeled-unicast { resolve-vpn; } } family inet-vpn { unicast; } neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>;</code> </pre><br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show route table CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> detail CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> destinations, <span class="hljs-number"><span class="hljs-number">6</span></span> routes (<span class="hljs-number"><span class="hljs-number">6</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span> entry, <span class="hljs-number"><span class="hljs-number">1</span></span> announced) *BGP Preference: <span class="hljs-number"><span class="hljs-number">170</span></span>/<span class="hljs-number"><span class="hljs-number">-101</span></span> Route Distinguisher: <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> Next hop type: Indirect Address: <span class="hljs-number"><span class="hljs-number">0x934d2e8</span></span> Next-hop reference count: <span class="hljs-number"><span class="hljs-number">3</span></span> Source: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> Next hop type: Router, Next hop index: <span class="hljs-number"><span class="hljs-number">608</span></span> Next hop: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, selected Label operation: Push <span class="hljs-number"><span class="hljs-number">22</span></span>, Push <span class="hljs-number"><span class="hljs-number">299920</span></span>, Push <span class="hljs-number"><span class="hljs-number">299776</span></span>(top) Label TTL action: prop-ttl, prop-ttl, prop-ttl(top) Protocol next hop: <span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Push <span class="hljs-number"><span class="hljs-number">22</span></span> Indirect next hop: <span class="hljs-number"><span class="hljs-number">94</span></span>a0658 <span class="hljs-number"><span class="hljs-number">262151</span></span> State: &lt;Secondary Active Int Ext&gt; Local AS: <span class="hljs-number"><span class="hljs-number">1</span></span> Peer AS: <span class="hljs-number"><span class="hljs-number">1</span></span> Age: <span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">28</span></span> Metric2: <span class="hljs-number"><span class="hljs-number">1</span></span> Task: BGP_1<span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>+<span class="hljs-number"><span class="hljs-number">179</span></span> <span class="hljs-function"><span class="hljs-function">Announcement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bits</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: 0-CE1-OSPF 1-KRT AS path: 2 ? Communities: target:1:100 domain-id:0:131584 route-type-vendor:0.0.0.0:2:0 router-id-vendor:10.0.1.1:0 Import Accepted VPN Label: 22 Localpref: 100 Router ID: 10.0.10.10 Primary Routing Table bgp.l3vpn.0</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We are interested in the lines: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protocol next hop: 10.1.10.1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Push 22 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPN Label: 22 The </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alarm has worked, now we have lsp between the PE routers and the vrf tags. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data-plane:</font></font></b> <br><img src="https://habrastorage.org/files/3f9/d4f/93b/3f9d4f93b7a14c63a5dff502061e7ebe.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now let's see how traffic will be transmitted along a signaling path. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, check the connectivity between CE:</font></font><br><pre> <code class="cpp hljs">CE1<span class="hljs-meta"><span class="hljs-meta">#ping 10.0.1.2 Type escape sequence to abort. Sending 5, 100-byte ICMP Echos to 10.0.1.2, timeout is 2 seconds: !!!!! Success rate is 100 percent (5/5), round-trip min/avg/max = 48/57/68 ms</span></span></code> </pre><br>  Fine.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now you can make a trace: </font></font><br><pre> <code class="cpp hljs">R5<span class="hljs-meta"><span class="hljs-meta">#traceroute 10.0.1.2 Type escape sequence to abort. Tracing the route to 10.0.1.2 1 10.0.0.1 4 msec 4 msec 8 msec 2 10.0.2.2 [MPLS: Labels 299776/299920/22 Exp 0] 48 msec 48 msec 12 msec 3 10.0.3.1 [MPLS: Labels 299920/22 Exp 0] 76 msec 56 msec 36 msec 4 10.2.0.2 [MPLS: Labels 22/22 Exp 0] 48 msec 12 msec 76 msec 5 10.1.2.2 [MPLS: Labels 17/22 Exp 0] 40 msec 52 msec 44 msec 6 10.0.1.1 44 msec 60 msec 48 msec 7 10.0.1.2 44 msec 56 msec 56 msec</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Visible stack of three tags. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And so, we see the route on PE1 to the client prefix 10.0.1.0/24:</font></font><br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show route table CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> CE1.inet<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> destinations, <span class="hljs-number"><span class="hljs-number">6</span></span> routes (<span class="hljs-number"><span class="hljs-number">6</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> *[BGP/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">25</span></span>, localpref <span class="hljs-number"><span class="hljs-number">100</span></span>, from <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> AS path: <span class="hljs-number"><span class="hljs-number">2</span></span> ? &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>, Push <span class="hljs-number"><span class="hljs-number">22</span></span>, Push <span class="hljs-number"><span class="hljs-number">299920</span></span>, Push <span class="hljs-number"><span class="hljs-number">299776</span></span>(top)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PE1 hangs three tags: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22-vrf tag, received via reflectors from PE2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">299920 - tag to the PE2 loopback, received via the reflector from ASBR1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">299776 - tag to ASBR1, received via the LDP protocol </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and sends this packet to P1: Next hop: 10.0. 2.2 via ge-0/0 / 0.0</font></font><br><pre> <code class="cpp hljs">bormoglotx@PE1&gt; show interfaces descriptions Interface Admin Link Description ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> up up to P1 ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> up up to RR1 ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3</span></span> up up to SW1 lo0 up up router-id</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note: since we distributed the label to PE2 over labeled-unicast, then P1 does not have a label to lubek PE2. </font><font style="vertical-align: inherit;">If we send a package with two labels, then P1 will not know what to do with this label. </font><font style="vertical-align: inherit;">Therefore, we need to add one more tag to ASBR1, then P1 will process this traffic without suspecting that this is traffic to the next AS (it only works with the top tag). </font><font style="vertical-align: inherit;">In other words, we in lsp to ASBR1 tunnel lsp to PE2. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's see what P1 does with the received package:</font></font><br><pre> <code class="cpp hljs">bormoglotx@P1&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> label <span class="hljs-number"><span class="hljs-number">299776</span></span> mpls<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span> destinations, <span class="hljs-number"><span class="hljs-number">9</span></span> routes (<span class="hljs-number"><span class="hljs-number">9</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">299776</span></span> *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>, Pop <span class="hljs-number"><span class="hljs-number">299776</span></span>(S=<span class="hljs-number"><span class="hljs-number">0</span></span>) *[LDP/<span class="hljs-number"><span class="hljs-number">9</span></span>] <span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>, metric <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>, Pop</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Everything is logical, P1 removes the top tag (the php mechanism) and sends the packet already with a stack of two tags to ASBR1. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASBR1 swaps the top tag (tags up to PE2) to the tag that ASBR2 reported to it:</font></font><br><pre> <code class="cpp hljs">bormoglotx@ASBR1&gt; show route table mpls<span class="hljs-number"><span class="hljs-number">.0</span></span> label <span class="hljs-number"><span class="hljs-number">299920</span></span> mpls<span class="hljs-number"><span class="hljs-number">.0</span></span>: <span class="hljs-number"><span class="hljs-number">19</span></span> destinations, <span class="hljs-number"><span class="hljs-number">19</span></span> routes (<span class="hljs-number"><span class="hljs-number">19</span></span> active, <span class="hljs-number"><span class="hljs-number">0</span></span> holddown, <span class="hljs-number"><span class="hljs-number">0</span></span> hidden) + = Active Route, - = Last Active, * = Both <span class="hljs-number"><span class="hljs-number">299920</span></span> *[VPN/<span class="hljs-number"><span class="hljs-number">170</span></span>] <span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">3.0</span></span>, Swap <span class="hljs-number"><span class="hljs-number">22</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note: it turned out very clearly - label 22 was generated by ASBR2 to achieve PE2, while label 22 was generated by PE2 as a vrf label. </font><font style="vertical-align: inherit;">Therefore, we have a package between ASBR1 and ASBR2 will come with a stack of two identical labels 22/22. </font><font style="vertical-align: inherit;">In reality, these are two different labels (by purpose) and the fact that they are the same in this case - an accident. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further the packet gets on ASBR2.</font></font><br><pre> <code class="cpp hljs">ASBR2<span class="hljs-meta"><span class="hljs-meta">#sh mpls forwarding-table labels 22 Local Outgoing Prefix Bytes Label Outgoing Next Hop Label Label or Tunnel Id Switched interface 22 18 10.1.10.1/32 0 Gi1/0 10.1.0.2 17 10.1.10.1/32 13378 Gi2/0 10.1.2.2</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASBR2 swaps the top label in the stack to the 18 or 17 label (we have equivalent paths). </font><font style="vertical-align: inherit;">He received these tags from the ldp protocol:</font></font><br><pre> <code class="cpp hljs">ASBR2<span class="hljs-meta"><span class="hljs-meta">#show mpls ldp bindings 10.1.10.1 32 lib entry: 10.1.10.1/32, rev 18 local binding: label: 22 remote binding: lsr: 10.1.10.2:0, label: 17 remote binding: lsr: 10.1.10.10:0, label: 18</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assume that the packet goes to P2, then ASBR2 swaps the top tag to tag 17. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">See what P2 will do:</font></font><br><pre> <code class="cpp hljs">P1<span class="hljs-meta"><span class="hljs-meta">#sh mpls forwarding-table labels 17 Local Outgoing Prefix Bytes Label Outgoing Next Hop Label Label or Tunnel Id Switched interface 17 Pop Label 10.1.10.1/32 12936 Gi1/0 10.1.3.1</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P2 removes the tag and sends the packet with one tag (vrf tag) to PE2. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It remains only to check what PE2 will do with a packet with a label of 22. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PE1 looks into mpls forwarding-table, removes the label, makes an ip lookup in table CE1 and sends the packet to the GigabitEthernet3 / 0.10 interface, which looks to SW2 to which the client router is connected CE2:</font></font><br><pre> <code class="cpp hljs">PE2<span class="hljs-meta"><span class="hljs-meta">#sh mpls forwarding-table labels 22 Local Outgoing Prefix Bytes Label Outgoing Next Hop Label Label or Tunnel Id Switched interface 22 No Label 10.0.1.0/24[V] 3296 aggregate/CE1</span></span></code> </pre><br><pre> <code class="cpp hljs">PE2<span class="hljs-meta"><span class="hljs-meta">#sh ip route vrf CE1 10.0.1.0 Routing Table: CE1 Routing entry for 10.0.1.0/24 Known via </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"connected"</span></span></span><span class="hljs-meta">, distance 0, metric 0 (connected, via interface) Redistributing via bgp 2 Advertised by bgp 2 Routing Descriptor Blocks: * directly connected, via GigabitEthernet3/0.10 Route metric is 0, traffic share count is 1</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this example, I used a scheme with a stack of three labels. There is an option using a stack of 2 labels. The difference is that routes received by ASBRs must be redistributed to the IGP protocol. Then ldp will start distributing tags to the lupbacks of the neighboring autonomous system, but personally I don‚Äôt like this option, at least because we put bgp routes in igp, which is not very good. Otherwise, everything is the same as described above. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I hope I have conveyed to the reader the principle of how these options work and this article will be useful to you when troubleshooting faults on l3vpn. The article turned out to be very large and was written more than one day, if someone wants to add something or notice some flaw (I‚Äôm all the same person), please write to the PM - we‚Äôll fix it and add it. If you have questions - write in the comments, if possible answer.</font></font> Thanks for attention! <br><br> <i>       AllTheThingsUndone.</i> <br><br></div><p>Source: <a href="https://habr.com/ru/post/302600/">https://habr.com/ru/post/302600/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302576/index.html">Tony Robbins seminar review ‚ÄúFree your inner strength‚Äù. Day 2: Turning dreams into reality (part 2)</a></li>
<li><a href="../302580/index.html">How I caught a Wi-Fi printer via OSPF, corporate network on MikroTik part 2</a></li>
<li><a href="../302590/index.html">Launch queues and the Laravel scheduler in the Elastic Beanstalk environment</a></li>
<li><a href="../302594/index.html">Client-side Linq to NHibernate</a></li>
<li><a href="../302598/index.html">SMS as a secret weapon</a></li>
<li><a href="../302602/index.html">Creating a blog on symfony 2.8 lts [Part 4]</a></li>
<li><a href="../302606/index.html">About the three-dimensional Z-order put in a word</a></li>
<li><a href="../302608/index.html">Create a secure IP messenger with Virgil and Twilio in 30 minutes</a></li>
<li><a href="../302610/index.html">How have the career ladders and elevators in the IT industry changed over the past week?</a></li>
<li><a href="../302612/index.html">A simple and free way to make payments with Payoneer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>