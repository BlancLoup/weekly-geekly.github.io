<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Five years of using C ++ for projects for microcontrollers in production</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will tell you how for five years I translated the enterprises I worked with from managing projects for microcontrollers in C to C ++...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Five years of using C ++ for projects for microcontrollers in production</h1><div class="post__text post__text-html js-mediator-article">  In this article I will tell you how for five years I translated the enterprises I worked with from managing projects for microcontrollers in C to C ++ and what came of it (spoiler: everything is bad). <br><a name="habracut"></a><br><h2>  A little bit about yourself </h2><br>  I started writing under C microcontrollers, having only school experience with Pascal, then I studied assembler and spent about 3 years studying various microcontroller architectures and their peripherals.  Then there was the experience of real work in C # and C ++ with their parallel study, which took several years.  After this period, I again and for a long time returned to programming microcontrollers, already having the necessary theoretical basis for working on real projects. <br><br><h2>  First year </h2><br>  I had nothing against the procedural style of C, however, the enterprise that started my real practice on real projects used "C programming in an object-oriented style."  It looked something like this. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uart_init</span></span></span><span class="hljs-class"> {</span></span> USART_TypeDef *USARTx; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> baudrate; ... } <span class="hljs-keyword"><span class="hljs-keyword">uart_cfg_t</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uart_init</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uart_cfg_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *cfg)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uart_start_tx</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *d, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> l)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uart_tx</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *d, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> l, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout)</span></span></span></span>;</code> </pre> <br>  This approach had the following advantages: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  the code continued to be C code. The following advantages follow from this: <ul><li>  it‚Äôs easier to control ‚Äúobjects‚Äù, because it is easy to track who and where what causes and in what sequence (with the exception of interruptions, but not in this article); </li><li>  to store the "pointer to the object" it is enough to remember the returned fd; </li><li>  if the ‚Äúobject‚Äù was deleted, then when you try to use it, you will receive the corresponding error in the return value of the function; </li></ul></li><li>  the abstraction of such objects over the HAL used there made it possible to write objects customizable for the task from its own initialization structure (and in the case of a lack of HAL functionality, one could hide the access to the registers inside the "objects"). </li></ol><br>  Minuses: <br><br><ol><li>  if someone deleted the ‚Äúobject‚Äù, and then created a new one of a different type, it may happen that the new one gets the fd of the old one and further behavior will not be determined.  This behavior could be easily changed at the expense of a small memory consumption for a linked list instead of using an array with a ‚Äúkey-value‚Äù (an array for each index fd stored a pointer to the structure of the object). </li><li>  it was impossible to statically mark memory under "global objects".  Since in most applications ‚Äúobjects‚Äù were created once and were not deleted further, it looked like a ‚Äúcrutch‚Äù.  Here, when creating an object, it would be possible to pass a pointer to its internal structure, which was allocated statically during layout, but this would confuse the initialization code even more and break encapsulation. </li></ol><br>  When asked about why C ++ was not selected when building the entire infrastructure, they answered something like the following: ‚ÄúWell, C ++ leads to strong additional costs, uncontrolled memory costs, as well as a bulky executable firmware file.‚Äù  Perhaps they were right.  Indeed, at the time of the beginning of designing, there was only GCC 3.0.5, which did not shine with special friendliness to C ++ (it is still necessary to work with it to write programs under QNX6).  There was no constexpr and C ++ 11/14, allowing you to create global objects, which in essence were data in the .data area, calculated at the compilation stage and methods for them. <br><br>  To the question, why not write on the registers - I got a clear answer that the use of "objects" allows you to configure the same type of application "in a day". <br><br>  Realizing all this and realizing that now C ++ is not the same as it was with GCC 3.0.5, I began to rewrite the main part of the functionality in C ++.  To get started, work with the hardware peripherals of the microcontroller, then the peripherals of external devices.  In fact, this was only a more convenient shell over what was available at that time. <br><br><h2>  Year two and three </h2><br>  I rewrote everything I needed for my C ++ projects and continued to write new modules right away in C ++.  However, these were just shells over C. Realizing that I was not using C ++ enough, I started using its strengths: templates, header-only classes, constexpr, and more.  Everything was going well. <br><br><h2>  Fourth and Fifth Year </h2><br><ul><li>  all objects are global and include links to each other at the compilation stage (according to the architecture of the project); </li><li>  all objects are allocated memory at the stage of layout; </li><li>  by class object for each pin; </li><li>  an object that encapsulates all pins for their initialization in one method; </li><li>  an RCC control object that encapsulates all objects that are on the hardware buses; </li><li>  CAN &lt;-&gt; RS485 converter project according to customer protocol contains 60 objects; </li><li>  in case something is at that level at the HAL or class level of some object, you have to not just ‚Äúfix the problem‚Äù, but also think how to fix it so that this fix works on all possible configurations of this module ; </li><li>  the used templates and constexpr cannot be calculated before viewing the map, asm and bin files of the final firmware (or starting debugging in the microcontroller); </li><li>  in case of an error in the template, a message with a length of one third of the project configuration from GCC is output.  To read and understand something from it is a separate achievement. </li></ul><br><h2>  Summary </h2><br>  Now I understand the following: <ol><li>  the use of "universal module constructors" only complicates the program unnecessarily.  It is much easier to adjust the configuration registers for a new project than to delve into the relationships between objects, and then also in the HAL library; </li><li>  don't be afraid to use C ++ for fear that it will ‚Äúgobble up a lot of memory‚Äù or ‚Äúbe less optimized than C‚Äù.  No, it is not.  You need to be afraid that using objects and many layers of abstraction will make the code unreadable, and debugging it will be a heroic feat; </li><li>  if you don‚Äôt use anything ‚Äúcomplicating‚Äù like templates, inheritance and other attractive charms of C ++, then why use C ++ at all?  Just for the sake of objects?  Is it worth it?  And for the sake of static global objects without using new / delete prohibited on some projects? </li></ol><br>  Summing up, we can say that the apparent simplicity of using C ++ turned out to be just an excuse to repeatedly increase the complexity of the project without any gain in speed or memory. </div><p>Source: <a href="https://habr.com/ru/post/461113/">https://habr.com/ru/post/461113/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461093/index.html">News from the world of OpenStreetMap No. 469 (07/09/2019 - 07/07/2019)</a></li>
<li><a href="../461099/index.html">Game AirAttack! - our first VR development experience</a></li>
<li><a href="../4611/index.html">US Consumer Associations to Fight Media Sharks</a></li>
<li><a href="../461101/index.html">Android Jetpack Compose First Impression</a></li>
<li><a href="../46111/index.html">Zend_Form and ini files</a></li>
<li><a href="../461121/index.html">Small multitasking experiments in a microcontroller</a></li>
<li><a href="../461123/index.html">Welcome to the Medium Summer Meetup on August 3</a></li>
<li><a href="../461125/index.html">The task of creating sequential numeric codes for numbering messages in the source code in Visual Studio (ex. C #)</a></li>
<li><a href="../461127/index.html">VM performance analysis in VMware vSphere. Part 3: Storage</a></li>
<li><a href="../461129/index.html">About kote, wife, two sons, the idea ... and not only. Story with continuation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>