<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Conflict Resolution in Transitive Dependencies - Good, Bad, Angry</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Instead of the preface 
 Next Saturday, we will be performing in St. Petersburg on JUG.ru with EvgenyBorisov . There will be a lot of fun trash and in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Conflict Resolution in Transitive Dependencies - Good, Bad, Angry</h1><div class="post__text post__text-html js-mediator-article"><h4>  Instead of the preface </h4><br>  <a href="https://habrahabr.ru/users/evgenyborisov/" class="user_link">Next</a> Saturday, we will be <a href="http://jugru.timepad.ru/event/72119/">performing in St. Petersburg on JUG.ru with EvgenyBorisov</a> .  There will be a lot of fun trash and interesting information (sometimes you can‚Äôt figure out where the border is), and one of my speeches will be devoted to the WTF nude of modular program development.  I will tell a few horror films, one of which will be about how everyone is trying to quickly, flexibly and correctly describe the dependencies in the project, and what usually comes out of it.  Interesting?  Then welcome to hell! <br><br><img src="https://habrastorage.org/storage2/3c3/efb/872/3c3efb87250af61ae63d856fbb345560.png"><br>  Rather, of course, ‚ÄúGood, Convenient and WTF‚Äù. <br><a name="habracut"></a><br><br><h4>  A little bit of theory ... </h4><br><h6>  What is a dependency manager and why is it needed? </h6><br>  Any modern build tool (especially in the JVM world) includes (or has an easy-to-connect) dependency manager (aka dependency manager).  The most famous are, of course, <a href="http://maven.apache.org/">Apache Maven</a> , <a href="http://ant.apache.org/ivy">Apache Ivy</a> (dependency manager for Apache Ant), and <a href="http://gradle.org/">Gradle</a> . <br>  One of the main functions of the build tools in the JVM world is to create classpaths.  They are used during the build process in many places - to compile code, to run tests, to build archives (war, ear, distributives and installers) and even to set up projects in the IDE. <br>  To facilitate the process of finding online, downloading, storing and configuring dependencies and there are dependency managers.  You declare that you need, for example, <code>commons-lang</code> , and voila, you have it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  What are transitive dependencies? </h6><br>  Transitive dependency is the artifact on which the direct dependence of the project depends.  Imagine the following situation: <br><img src="https://habrastorage.org/storage2/a1c/c02/2eb/a1cc022ebe7c047f49453a46b0012a1e.png"><br>  Our project <code>A</code> depends on two artifacts - <code>E</code> and <code>B</code>  At this direct dependencies end and begin <a href="http://ru.wikipedia.org/wiki/%25D0%25A2%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B7%25D0%25B8%25D1%2582%25D0%25B8%25D0%25B2%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">transitive</a> ( <code>C, D</code> ).  As a result, we get dependency chains, artifacts in which can be repeated ( <code>D</code> , in our example) <br><br><h6>  Why do we need transitive dependencies? </h6><br>  Obviously not to compile.  But, for the rest, perhaps, they are needed - these artifacts must be in the archives builds, they must be in the classpath to run tests, and the paths to them must be given through the API for integration with the IDE. <br><br><h6>  How can a conflict arise? </h6><br>  If we look at the diagram above, we will see the same conflict.  The classpath of project <code>A</code> must contain both artifact <code>D</code> version 1 (E depends on it) and artifact <code>D</code> version 2 ( <code>C</code> depends on it)! <br><br><h6>  Why is that bad? </h6><br>  The JVM (and javac) defines the uniqueness of a class by its name (and classloader, but in our simple example, all classes are loaded with one classloader).  In the case when there are two classes with the same name in the classpath, only the first one will be loaded.  If we assume that there are classes with the same name in <code>D1</code> and <code>D2</code> (you will agree, most likely, it is), then the class from the jar, which will be registered in the second generated classpath, will simply not be loaded.  Which one will be the first?  It depends on the logic of the dependency manager and, in general, is unknown. <br>  As you understand, this is a conflict: <br><img src="https://habrastorage.org/storage2/a46/e0e/4ce/a46e0e4ce47b15e6ecd71a5c95e8966f.png"><br><br><h4>  What to do? </h4><br>  Who is to blame is clear (Java, not those whom you thought about), but what can be done? <br>  There are several strategies for resolving conflicts in transitive dependencies (some of them are logical, others are absurd), but, naturally, there is no silver bullet.  Let's look at some of them: <br><ul><li>  <b>Latest</b> .  The ‚ÄúNewest‚Äù strategy implies backward compatibility.  If D2 is fully compatible with D1, then leaving only the newer artifact (D2) in the classpath will get the correct operation of C (after all, it is written under D2), but also the correct operation of E (after all, if D2 is backward compatible, then it works exactly same as D1, under which is written E).  This strategy is of two subspecies - the newest version, and the newest by date.  Most often, they will work the same way (except in cases where there is none). <br>  <i>In the case of our example, using the latest in the classpath will be D2.</i> </li><li>  <b>Fail</b> (aka Strict).  With this strategy, the build will fail when the dependency manager detects a conflict.  Naturally, the safest, but also the most time-consuming strategy. <br>  <i>In the case of our example, when using fail, the build will fail.</i> </li><li>  <b>All</b> (aka No-conflict).  ‚ÄúThe one and the other, and it is possible without bread‚Äù means that both D1 and D2 from our example will be in the classpath (in arbitrary order).  Hell?  Hell!  But in the case of using classpath isolation technologies (by loading different modules with different classloaders), it may well be not only useful, but also necessary. <br>  <i>In the case of our example, when using all in the classpath, both D1 and D2 will appear.</i> </li><li>  <b>Nearest</b> .  The ‚ÄúNearest‚Äù strategy is a completely and completely magnificent WTF, which I will gladly discuss below.  Stay tuned. </li><li>  <b>Custom</b> .  In this case, the dependency manager will ask you what the master will do.  This, of course, is ‚Äúmanual control‚Äù, but can sometimes be quite useful.  Here is an example of pseudocode on pseudo-gruvi: <br><pre> <code class="hljs pgsql">coflictManager = {artifact, versionA, versionB -&gt; //,        Apache,    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(artifact.org.startsWith (<span class="hljs-string"><span class="hljs-string">'org.apache'</span></span>)){ [versionA, versionB].max() } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { fail() } }</code> </pre><br>  <i>In the case of our example, when using this custom implementation, assuming that the org of D1 and D2 starts with 'org.apache', then the classpath will have D2, otherwise, the build will fall.</i> <br></li></ul><br><h4>  Who is that much </h4><br>  Now let's see which of the <a href="http://youtu.be/Bxhs8jMnC7w">Der Grosse Troika</a> mentioned above that he can. <br><br><h5>  Apache ivy </h5><br>  In terms of <a href="http://ant.apache.org/ivy/history/latest-milestone/settings/conflict-managers.html">conflict managers,</a> Ivy is beautiful.  They are connected, both are the latest, as well as fail and all go in the box.  With custom, too, everything is beautiful.  You can fully implement your logic, or you can use a half-finished product and only come up with a suitable regex.  By default, the latest (version) works. <br><br><h5>  Gradle </h5><br>  In the first versions of Gradle (up to 0.6, if memory serves me) Ivy was used as a dependency manager.  Accordingly, all of the above was true for Gradle too, but the guys from Gradleware wrote their dependency manager (mainly because of problems with the local Ivy storage with a parallel build, one of the main advantages of Gradle).  In the process of releasing their manager, such ‚Äúminor‚Äù features as a replacement for the conflict manager were pushed far into the roadmap, and for a long time Gradle existed only with the latest.  Do not like the latest - disable transitive dependencies, and go ahead, list everything manually.  But today everything is in order.  Starting from 1.0, there is <a href="http://www.gradle.org/docs/current/dsl/org.gradle.api.artifacts.ResolutionStrategy.html">fail</a> , and from 1.4, there is also <a href="http://www.gradle.org/docs/current/userguide/userguide_single.html">custom</a> . <br><br><h5>  Apache maven </h5><br>  <s>Well, for the sake of the next picture, the whole post was conceived.</s> <br>  Which version of D will you find in the classpath?  D1?  D2?  both?  none?  assembly will fall? <br><img src="https://habrastorage.org/storage2/e6b/842/f79/e6b842f7940ba9e4359bac72f36b5177.jpg"><br>  As you have probably already guessed, <b>D1 gets into the classpath</b> (which is very likely to lead to problems, because all the code in C written for new functionality that does not exist in D1 will simply fall).  This is the most wonderful WTF that I promised you.  Maven works with the unique <a href="http://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html">nearest</a> strategy, which selects in the classpath that artifact that is closer to the root of the project (A) in the project tree. <br><img src="https://habrastorage.org/storage2/5d3/41e/157/5d341e157fcd63117ef85e015abd7dd9.jpg"><br><br><h6>  How so?  What kind of nonsense? </h6><br>  The root of the problem lies in the difficulty of eliminating dependency in Maven.  If, for example, you want to use D2, not D1, then, for good, you should say to Maven: Dear Maven, never use D1.  Just for example, in Gradle we would write this: <br><pre> <code class="hljs pgsql">configurations {<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>*.<span class="hljs-keyword"><span class="hljs-keyword">exclude</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: <span class="hljs-string"><span class="hljs-string">'mygroup'</span></span>, module: <span class="hljs-string"><span class="hljs-string">'D'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'1'</span></span>}</code> </pre> <br>  The problem is that expressing it in Maven is impossible.  (An experienced, and therefore attentive and thoughtful user of Maven will exclaim here, "But what about the enforcer-plugin ?!" And it will be <a href="http://habrahabr.ru/company/codefreeze/blog/191246/">wrong</a> ).  You can say specifically to module E: ‚Äúdid you think you have a dependency on D?  So, it is not.  This is a good way out, there is no more conflict, D2 in the classpath, win.  But this solution is not scalable at all.  What if dozens of artifacts depend on D1?  At different levels of transitivity? <br><br><h6>  Well, and where does the nearest? </h6><br>  The problem of lack of global exclude was solved in Maven in a very ‚Äúinteresting‚Äù way.  It was decided that if you declared in your project A a dependency with a certain version, then only this version will fall into the classpath.  That is, in practice, this is the ultimated nearest - it cannot be closer than to A (this is root), so the conflict is resolved, we don‚Äôt need to look for all the places where we need to exclude D. On the way, however, we got very strange and hardly predictable behavior in those when A does not declare D directly (see our example), but what is, that is. <br><br>  Interestingly enough, the idea that ‚Äúwhat the user himself declared is law‚Äù is used in Gradle too, and this does not prevent them from using sane strategies like latest and fail for everything else. <br><br>  Update: several people in the comments reminded that the <a href="http://habrahabr.ru/company/codefreeze/blog/191246/%3Freply_to%3D6649496">enforcer-plugin has the functionality of fail.</a> This partially solves the problem.  Remains: 1. wild nearest by default.  2. solutions to the problem - to register all conflicting dependencies in your project (tolerably), or infinite exclude (hell). <br><br><h6>  And if the same depth? </h6><br>  This wonderful question (what to do if in our example B depended on D2) did not occur to the guys from Maven for two and a half years (from the 2.0 release in October 2005 to the version 2.0.9 in April 2008) and which artifact will be in the classpath was just <i>vague</i> .  In Maven 2.0.9, a willful decision was made - it will be the first! <br><img src="https://habrastorage.org/storage2/df5/7e1/4a7/df57e14a7e85edd9f7c0e4cf288bd295.png"><br>  How does this help us?  Right, no way.  Because we generally do not know which of them will be the first, because transitive dependencies do not manifest themselves until a conflict occurs (or until we begin to investigate this riddle).  Thank you guys! <br><br><h4>  Instead of an epilogue </h4><br>  Maven's WTF nude is, of course, not limited to the miraculous creation of the alternative mind ‚Äî the nearest strategy.  But today, I think, that's enough.  Holivary in the comments are welcome in every way (if anything, I‚Äôll follow the Gradle), and all St. Petersburg people come to JUG on Saturday, the 31st in PetroCongress to continue the banquet. </div><p>Source: <a href="https://habr.com/ru/post/191246/">https://habr.com/ru/post/191246/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191232/index.html">Google is working on unmanned vehicles of its own production</a></li>
<li><a href="../191234/index.html">Ranking algorithm changes in App Store</a></li>
<li><a href="../191236/index.html">How to start developing games even if you were an accountant before</a></li>
<li><a href="../191240/index.html">Elliptical cryptography: practice</a></li>
<li><a href="../191242/index.html">Programmer's brain</a></li>
<li><a href="../191248/index.html">ASP.NET MVC client-side routing</a></li>
<li><a href="../191250/index.html">Internal device llst, part 2 or Little Smalltalk + LLVM =</a></li>
<li><a href="../191252/index.html">Parsing and building syntax trees with PLY. The basics</a></li>
<li><a href="../191254/index.html">The German government warns the country's authorities against using Windows 8</a></li>
<li><a href="../191256/index.html">Features parsing block HTML-code screen access programs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>