<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating plug-ins for AutoCAD using the .NET API (part 3 - working with layers)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is another article from the series on the development of plug-ins for AutoCAD. It will be about basic operations with layers in the document. 


...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating plug-ins for AutoCAD using the .NET API (part 3 - working with layers)</h1><div class="post__text post__text-html js-mediator-article">  This is another article from the <u><a href="http://habrahabr.ru/post/235723/">series</a></u> on the development of plug-ins for AutoCAD.  It will be about basic operations with layers in the document. <br><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> disclaimer = <span class="hljs-string"><span class="hljs-string">"          AutoCAD.   ‚Äì      ."</span></span>;</code> </pre> <a name="habracut"></a><br><h4>  1. General information </h4><br>  All readers of this article are probably familiar with what a layer is.  At the primitive level, it can be considered a container for drawing elements that have some common feature that is important for the developer. <br><br>  Layers can greatly simplify the life of not only the engineer who creates the drawing, but also the programmer.  For example, all elements located on one layer can be hidden very quickly, if necessary, and then re-displayed on the workspace. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the framework of this article, we will need some basic information, which can basically be gathered <u><a href="http://knowledge.autodesk.com/support/autocad/getting-started/caas/CloudHelp/cloudhelp/2015/ENU/AutoCAD-Core/files/GUID-FA005756-B8F5-4A78-988F-31335A68D77C-htm.html">from here</a></u> ( <u><a href="http://help.autodesk.com/view/ACD/2015/ENU/%3Fguid%3DGUID-FA005756-B8F5-4A78-988F-31335A68D77C">mirror</a></u> ) <br><br><h5>  1.1.  Layer number zero </h5><br>  Any AutoCAD document always contains at least one layer ‚Äî zero (with the name ‚Äú0‚Äù) that cannot be deleted.  This layer is often very useful - for example, when removing other layers. <br><br><h5>  1.2.  Current layer </h5><br>  One of the document layers must be current.  All the objects added to the drawing are placed on it (at least primitive ones - things are somewhat more complicated with blocks). <br><br><h5>  1.3.  Layer Properties </h5><br>  Any (including zero) layer in AutoCAD has three properties: <br><ul><li>  on (" <b>on</b> "); </li><li>  frozen (" <b>freeze</b> "); </li><li>  locked (" <b>lock</b> "). </li></ul><br>  All these properties are binary (each of them can be considered a ‚Äúyes / no‚Äù flag). <br><br>  The " <b>on</b> " flag <b>is</b> responsible for the visibility of the layer.  If this flag is cleared, then all elements located on the layer are no longer displayed in the drawing. <br><br>  The flag " <b>frozen</b> " is also responsible for the visibility of the layer.  In its action, it is similar to the "on" flag.  As stated in the documentation, this property improves performance on very large drawings. <br><div class="spoiler">  <b class="spoiler_title">Nb:</b> <div class="spoiler_text">  Personally, I have never worked with large drawings and never used this property. </div></div><br>  The " <b>locked</b> " flag is responsible for the ability to edit the layer.  If this flag is set, then all elements located on the layer become inaccessible for any changes (move, delete, etc.).  In addition, new items cannot be added to the locked layer. <br><br>  Layer properties can be controlled from AutoCAD.  On the below picture is poisonous green, the Layers panel is highlighted, and the drop-down list of layers is highlighted in purple, on the left side of which are the property switches (light, sun, open lock ‚Äî on, freeze, and lock, respectively ). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c14/8da/8ae/c148da8aecf94e79b18967870ef89cd1.PNG"></div><br><div class="spoiler">  <b class="spoiler_title">Nb:</b> <div class="spoiler_text">  You really should pay attention to these switches: when writing a plug-in, everything does not always work out the first time, and sometimes you have to use ‚Äúmanual control‚Äù. <br><div class="spoiler">  <b class="spoiler_title">Nb:</b> <div class="spoiler_text">  <u><a href="http://colorscheme.ru/color-names.html">Some sites</a></u> claim that this picture shows not green and purple, but lime and heliotrope. <br>  ... <br>  I guess I am a <u><a href="">dog</a></u> . </div></div></div></div><br><h5>  1.4.  Layer management </h5><br>  The simplest actions with layers were considered in the previous paragraph.  For more complex operations (for example, creating or deleting a layer), use the Layer Properties panel, which is invoked by the <b>LAYER</b> command or by clicking on the corresponding icon in the Layers panel (indicated in orange in the figure in the previous section).  This is what this panel looks like: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5c5/8e7/ba2/5c58e7ba273b4631ac61c164b83949e7.png"></div><br>  Of particular interest is the box section with buttons.  The first button in it creates a new layer, the third - deletes the existing one, if possible. <br><br>  Cannot be deleted: <br><ul><li>  zero layer; </li><li>  current layer; </li><li>  a layer containing at least one object; </li><li>  layer referenced in the block definition. </li></ul><br>  Before removing a layer, you must ensure that these conditions are met. <br><br><div class="spoiler">  <b class="spoiler_title">Nb:</b> <div class="spoiler_text">  In fact, the list of forbidden to delete layers is somewhat longer: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ef3/f98/aa9/ef3f98aa95244e0d8e835dda75b3dc85.png"></div><br><br>  <s>Unfortunately, the</s> author of this post did not have to deal with either <i>Defpoints</i> or <i>Xref-dependent layers</i> , so <i>we‚Äôll leave the reader to work out these basic questions as a simple homework assignment.</i>  ^ __ ^ </div></div><br>  At the theory of everything, you can begin to practice. <br><br><h4>  2. Writing a plugin </h4><br><h5>  2.1.  Creating a new plugin project </h5><br>  This was the <u><a href="http://habrahabr.ru/post/235723/">first article of the</a></u> cycle.  The following examples specify <b>.NET Framework 3.5</b> as the required version of the .NET Framework. <br><br><div class="spoiler">  <b class="spoiler_title">You can immediately add a code framework:</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.Runtime; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.Windows; namespace MyAutoCADDll { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Commands : IExtensionApplication { //        AutoCAD  "TestCommand" [CommandMethod("TestCommand")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MyCommand() { } //  Initialize()  Terminate() ,    IExtensionApplication <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Initialize() { } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Terminate() { } } }</code> </pre></div></div><br><h5>  2.2.  Adding links to the necessary libraries </h5><br>  In this example, we will need two AutoCAD .NET API libraries: <b>AcMgd.dll</b> and <b>AcDbMgd.dll</b> (as always, do not forget to disable <code>CopyLocal</code> ). <br><br><h5>  2.3.  Adding a new layer </h5><br>  All layers present in the document are stored in the layer list.  To add a new layer to the drawing, it is enough to add a new element to this list. <br><br>  However, despite the simplicity of the operation, the code is quite a lot. <br><br><div class="spoiler">  <b class="spoiler_title">Code:</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.Runtime; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.ApplicationServices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.DatabaseServices; namespace HabrPlug_Layers { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Commands : IExtensionApplication { //        AutoCAD  "TestCommand" [CommandMethod("TestCommand")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MyCommand() { //       Document acDoc = Autodesk.AutoCAD.ApplicationServices.Application.DocumentManager.MdiActiveDocument; <span class="hljs-keyword"><span class="hljs-keyword">Database</span></span> acCurDb = acDoc.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>; //   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (DocumentLock docloc = acDoc.LockDocument()) { //   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Transaction</span></span> tr = acCurDb.TransactionManager.StartTransaction()) { //     LayerTable acLyrTbl = tr.GetObject(acCurDb.LayerTableId, OpenMode.ForWrite) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LayerTable; //        LayerTableRecord acLyrTblRec = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> LayerTableRecord(); acLyrTblRec.Name = "HabrLayer"; //       acLyrTbl.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(acLyrTblRec); //      tr.AddNewlyCreatedDBObject(acLyrTblRec, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); //   tr.<span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span>(); } } } //  Initialize()  Terminate() ,    IExtensionApplication <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Initialize() { } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Terminate() { } } }</code> </pre></div></div><br>  After loading the plugin and executing the ‚ÄúTestCommand‚Äù command, a new layer should appear in the drawing: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/25c/84b/19c/25c84b19c83b4af099e6878b8d069e6e.png"></div><br><br>  In the above code, two important constructions were used that are often encountered when working with drawing objects: <br><div class="spoiler">  <b class="spoiler_title">a) blocking the document;</b> <div class="spoiler_text"><pre> <code class="hljs lisp">using (<span class="hljs-name"><span class="hljs-name">DocumentLock</span></span> docloc = acDoc.LockDocument())</code> </pre><br>  Autocad documentation says that requests to change objects or to access AutoCAD can be executed in any context and from any number of applications.  To prevent conflicts with other requests, the programmer must ensure that the document is locked before it is changed.  Failure to comply with this requirement in some cases leads to an error when changing the document database. <br><br>  After making all the necessary changes to the database, it should be unlocked using the <code>DocumentLock</code> object's <code>Dispose()</code> method.  You can also use a <code>using</code> block with declaring a <code>DocumentLock</code> object in it - in this case, when you exit the block, the database is unlocked automatically.  ( <u><a href="https://sites.google.com/site/bushmansnetlaboratory/translate-manual/upravlenie-sredoj-autocad/blokirovka-i-razblokirovka-dokumenta">source</a></u> , <u><a href="http://docs.autodesk.com/ACD/2010/ENU/AutoCAD%2520.NET%2520Developer%2527s%2520Guide/index.html%3Furl%3DWS1a9193826455f5ff-e569a0121d1945c0831d.htm,topicNumber%3Dd0e8508">mirror</a></u> ) <br><br><div class="spoiler">  <b class="spoiler_title">Nb:</b> <div class="spoiler_text">  In my experience, using the using construct is much more convenient, since it reduces the probability of forgetting to call the <code>Dispose()</code> method to zero. </div></div></div></div><div class="spoiler">  <b class="spoiler_title">b) call the transaction.</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Transaction</span></span> tr = acCurDb.TransactionManager.StartTransaction()) ‚Ä¶ tr.GetObject(acCurDb.LayerTableId, OpenMode.ForWrite) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LayerTable; ‚Ä¶ tr.AddNewlyCreatedDBObject(acLyrTblRec, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); ‚Ä¶ tr.<span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span>();</code> </pre><br>  The <u><a href="https://sites.google.com/site/bushmansnetlaboratory/translate-manual/sozdanie-i-redaktirovanie-obektov-autocad/otkrytie-i-zakrytie-obektov">documentation</a></u> ( <u><a href="http://docs.autodesk.com/ACD/2010/ENU/AutoCAD%2520.NET%2520Developer%2527s%2520Guide/index.html%3Furl%3DWS73099cc142f48755f2fc9df120970276f77e6.htm,topicNumber%3Dd0e11751">mirror</a></u> ) indicates that when working with objects, such as segments, circles and polylines, or with the table of identifiers and its records, it is necessary to open the object for reading or writing. <br><br>  Attempts to ignore this requirement will not lead to anything good - quite unpleasant (including debugging point of view) errors can occur. <br><br>  There are several basic steps to working with a transaction: <br><ol><li>  the beginning of a new transaction; </li><li>  opening an object for reading or writing; </li><li>  if the object is created for the first time (it is not yet in the document) - adding it to the document database; </li><li>  commit transaction; </li><li>  completion of the transaction. </li></ol><br>  All these points are discussed in detail in the documentation for the links above. <br><br>  As in the case of <code>DocumentLock</code> , you must either call the <code>Dispose()</code> method after you finish working with a transaction, or use the using construct. <br></div></div><br>  Now that we have dealt with the document lock and transactions, we can proceed to the analysis of the rest of the code. <br><br>  <u>First</u> , we include the necessary namespaces: <br><br>  <code>Autodesk.AutoCAD.Runtime</code> - to use the <code>IExtensionApplication</code> type and the <code>CommandMethod</code> construction; <br>  <code>Autodesk.AutoCAD.DatabaseServices</code> - to use the <code>Document</code> and <code>DocumentLock</code> types; <br>  <code>Autodesk.AutoCAD.Runtime</code> - to use the <code>Database</code> , <code>Transaction</code> , <code>LayerTable</code> , <code>OpenMode</code> and <code>LayerTableRecord</code> . <br><br>  <u>Second</u> , we block the document and start the transaction: <br><br><pre> <code class="hljs pgsql">//       Document acDoc = Autodesk.AutoCAD.ApplicationServices.Application.DocumentManager.MdiActiveDocument; <span class="hljs-keyword"><span class="hljs-keyword">Database</span></span> acCurDb = acDoc.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>; //   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (DocumentLock docloc = acDoc.LockDocument()) { //   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Transaction</span></span> tr = acCurDb.TransactionManager.StartTransaction()) {</code> </pre><br>  <u>Thirdly</u> , we get a link to the document's layer table: <br><br><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">LayerTable</span></span> acLyrTbl = tr.<span class="hljs-type"><span class="hljs-type">GetObject</span></span>(acCurDb.<span class="hljs-type"><span class="hljs-type">LayerTableId</span></span>, <span class="hljs-type"><span class="hljs-type">OpenMode</span></span>.<span class="hljs-type"><span class="hljs-type">ForWrite</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-type"><span class="hljs-type">LayerTable</span></span>;</code> </pre><br>  The <code>GetObject()</code> method takes as input two parameters: the Id of the object to be opened and the access level.  You can find the Id of the document's layers table using the <code>LayerTableId</code> property of the database of this document.  Since we need to change the layer table (add a new layer to it), we use the write access level ( <code>OpenMode.ForWrite</code> ).  Finally, the <code>GetObject()</code> method returns a value of type ‚Äúobject‚Äù ( <code>object</code> ), which must be explicitly cast to the type we need ( <code>LayerTable</code> ). <br><br>  <u>Fourth</u> , we create a new layer: <br><br><pre> <code class="hljs pgsql">LayerTableRecord acLyrTblRec = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> LayerTableRecord(); acLyrTblRec.Name = "HabrLayer";</code> </pre><br>  A layer (or rather, the corresponding entry in the table of document layers) has the type <code>LayerTableRecord</code> .  Its constructor takes no values, so all initialization has to be done after creation. <br><br>  In this example, we changed only the name of the new layer, but if necessary we can set other parameters, such as visibility ( <code>IsOff</code> property) or accessibility for editing ( <code>IsLocked</code> property). <br><br>  <u>Fifth</u> , we add a new layer to the document's layer table: <br><br><pre> <code class="hljs pgsql">acLyrTbl.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(acLyrTblRec);</code> </pre><br>  The layer table is the class for which the <code>IEnumerable</code> interface is implemented.  To add a new element, use the <code>Add()</code> method. <br><br>  <u>Sixth</u> , we add a new layer to the document database: <br><br><pre> <code class="hljs objectivec">tr.AddNewlyCreatedDBObject(acLyrTblRec, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>  Since this layer did not exist before the start of a transaction, we must explicitly indicate that it should be added to the document database.  If you do not, the entry will not be added. <br><br>  An important detail: the <code>AddNewlyCreatedDBObject</code> function should not be called before, but after adding a layer to the table of document layers.  If you try to swap these operations, the layer will not be added.  I have no coherent logical explanation for this;  I will be glad if knowledgeable people will share a clue in the comments. <br><br>  <u>Seventh</u> , we commit the transaction: <br><br><pre> <code class="hljs pgsql">tr.<span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span>();</code> </pre><br>  If any elements opened during a transaction using the <code>GetObject()</code> method <code>GetObject()</code> been changed, then to save these changes in the document database, you need to commit the transaction by calling the <code>Commit()</code> method.  Otherwise, no changes will be saved, and the document will remain in the state that existed at the time of the start of the transaction. <br><br>  <u>Finally</u> , we end the transaction and unlock the document: <br><br><pre> <code class="hljs"> } }</code> </pre><br>  Here it is, an important plus of using a using construct!  Without it, it is very easy to forget to call the <code>Dispose()</code> method, especially since you need to do it twice - to commit the transaction and unlock the document.  And when using the using construct, the <code>Dispose()</code> method is called automatically. <br><br><h5>  2.4.  Setting the current layer </h5><br>  You can get the current document layer and set a new one using the <code>Clayer</code> property of the <code>Clayer</code> database. <br><br><div class="spoiler">  <b class="spoiler_title">Code:</b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">acCurDb</span></span> .Clayer = acLyrTbl[<span class="hljs-string"><span class="hljs-string">"HabrLayer"</span></span>];</code> </pre><br>  It is enough to insert this line in the previous example, right before committing the transaction. </div></div><br><h5>  2.5.  Changing properties and renaming a layer </h5><br>  To change the layer properties, open the corresponding entry in the layer table. <br><br><div class="spoiler">  <b class="spoiler_title">Code:</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.Runtime; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.ApplicationServices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.DatabaseServices; namespace HabrPlug_Layers { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Commands : IExtensionApplication { //        AutoCAD  "TestCommand" [CommandMethod("TestCommand")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MyCommand() { //       Document acDoc = Autodesk.AutoCAD.ApplicationServices.Application.DocumentManager.MdiActiveDocument; <span class="hljs-keyword"><span class="hljs-keyword">Database</span></span> acCurDb = acDoc.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>; //   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (DocumentLock docloc = acDoc.LockDocument()) { //   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Transaction</span></span> tr = acCurDb.TransactionManager.StartTransaction()) { //     LayerTable acLyrTbl = tr.GetObject(acCurDb.LayerTableId, OpenMode.ForWrite) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LayerTable; //        LayerTableRecord acLyrTblRec = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> LayerTableRecord(); acLyrTblRec.Name = "HabrLayer"; //       acLyrTbl.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(acLyrTblRec); //      tr.AddNewlyCreatedDBObject(acLyrTblRec, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); //   tr.<span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span>(); } } } //        AutoCAD  "NewCommand" [CommandMethod("NewCommand")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> NewCommand() { //       Document acDoc = Autodesk.AutoCAD.ApplicationServices.Application.DocumentManager.MdiActiveDocument; <span class="hljs-keyword"><span class="hljs-keyword">Database</span></span> acCurDb = acDoc.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>; //   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (DocumentLock docloc = acDoc.LockDocument()) { //   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Transaction</span></span> tr = acCurDb.TransactionManager.StartTransaction()) { //     LayerTable acLyrTbl = tr.GetObject(acCurDb.LayerTableId, OpenMode.ForWrite) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LayerTable; //        -    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (acLyrTbl.Has("HabrLayer") == <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } //      LayerTableRecord acLyrTblRec = tr.GetObject(acLyrTbl["HabrLayer"], OpenMode.ForWrite) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LayerTableRecord; //     acLyrTblRec.Name = "test"; acLyrTblRec.IsOff = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; acLyrTblRec.IsLocked = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; //   tr.<span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span>(); } } } //  Initialize()  Terminate() ,    IExtensionApplication <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Initialize() { } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Terminate() { } } }</code> </pre></div></div><br>  Before an operation with a layer, it will be useful to verify its existence using the <code>Has()</code> method of the document's layer table. <br><br>  If we load the plugin, execute the TestCommand command, and then the NewCommand command, we will see that the layer we created has become hidden, blocked and changed its name.  <s>Now no one will find him.</s> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e75/f35/859/e75f35859e664e2098a53005c099c5de.png"></div><br><br><h5>  2.6.  Deleting a layer </h5><br>  Deleting a layer is much the same as changing.  For the corresponding entry in the layer table, the <code>Erase()</code> method is called as follows: <br><br><pre> <code class="hljs vbscript">acLyrTblRec.<span class="hljs-keyword"><span class="hljs-keyword">Erase</span></span>(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>  However, it is important to remember the limitations that were discussed in the first section.  I can not delete: <br><ul><li>  zero layer; </li><li>  current layer; </li><li>  a layer containing at least one object; </li><li>  layer referenced in the block definition. </li></ul><br>  If you need to delete a layer that is currently the current layer, then before deleting, you need to make some other layer current ‚Äî for example, zero. <br><br>  If it is necessary to remove a layer on which any objects are present, then before deleting a layer, it is necessary to delete all these objects or transfer them to another layer. <br><br>  You can read more about deleting layers in the documentation (section " <u><a href="http://docs.autodesk.com/ACD/2010/ENU/AutoCAD%2520.NET%2520Developer%2527s%2520Guide/index.html%3Furl%3DWS1a9193826455f5ff2566ffd511ff6f8c7ca-3cee.htm,topicNumber%3Dd0e30962">Create and Edit AutoCAD Entities&gt; Use Layers, Colors, Linetypes&gt; Work with Layers&gt; Erase Layers</a></u> "). <br><br>  And in Kean Walmsley's blog, there is a <u><a href="http://through-the-interface.typepad.com/through_the_interface/2008/05/finding-all-the.html">template</a></u> for finding all the objects placed on a layer.  Based on this example, you can write a function that removes all objects from the layer. <br><br>  In any case, before removing a layer, it will not be superfluous to make sure that the operation is correct, and to frame the deletion itself with the <code>try ... catch</code> construction. <br><br><div class="spoiler">  <b class="spoiler_title">Code:</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.Runtime; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.ApplicationServices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.DatabaseServices; namespace HabrPlug_Layers { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Commands : IExtensionApplication { //        AutoCAD  "TestCommand" [CommandMethod("TestCommand")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MyCommand() { //       Document acDoc = Autodesk.AutoCAD.ApplicationServices.Application.DocumentManager.MdiActiveDocument; <span class="hljs-keyword"><span class="hljs-keyword">Database</span></span> acCurDb = acDoc.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>; //   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (DocumentLock docloc = acDoc.LockDocument()) { //   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Transaction</span></span> tr = acCurDb.TransactionManager.StartTransaction()) { //     LayerTable acLyrTbl = tr.GetObject(acCurDb.LayerTableId, OpenMode.ForWrite) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LayerTable; //        LayerTableRecord acLyrTblRec = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> LayerTableRecord(); acLyrTblRec.Name = "HabrLayer"; //       acLyrTbl.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(acLyrTblRec); //      tr.AddNewlyCreatedDBObject(acLyrTblRec, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); //   tr.<span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span>(); } } } //        AutoCAD  "TestCommand" [CommandMethod("NewCommand")] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> NewCommand() { //       Document acDoc = Autodesk.AutoCAD.ApplicationServices.Application.DocumentManager.MdiActiveDocument; <span class="hljs-keyword"><span class="hljs-keyword">Database</span></span> acCurDb = acDoc.<span class="hljs-keyword"><span class="hljs-keyword">Database</span></span>; //   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (DocumentLock docloc = acDoc.LockDocument()) { //   <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Transaction</span></span> tr = acCurDb.TransactionManager.StartTransaction()) { //     LayerTable acLyrTbl = tr.GetObject(acCurDb.LayerTableId, OpenMode.ForWrite) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LayerTable; //        -    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (acLyrTbl.Has("HabrLayer") == <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } //       acCurDb.Clayer = acLyrTbl["0"]; // ,         ObjectIdCollection acObjIdColl = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ObjectIdCollection(); acObjIdColl.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(acLyrTbl["HabrLayer"]); acCurDb.Purge(acObjIdColl); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (acObjIdColl.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { //      LayerTableRecord acLyrTblRec = tr.GetObject(acObjIdColl[<span class="hljs-number"><span class="hljs-number">0</span></span>], OpenMode.ForWrite) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LayerTableRecord; try { //   acLyrTblRec.Erase(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); //   tr.<span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span>(); } catch (Autodesk.AutoCAD.Runtime.<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> Ex) { //    - ,    Application.ShowAlertDialog(":\n" + Ex.Message); } } } } } //  Initialize()  Terminate() ,    IExtensionApplication <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Initialize() { } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Terminate() { } } }</code> </pre></div></div><br>  In this code, we already know everything except the <code>Purge()</code> method.  The principle of its operation is described in the <u><a href="http://help.autodesk.com/view/ACD/2015/ENU/%3Fguid%3DGUID-288B4394-C51F-48CC-8B8C-A27873CFFDC1">documentation</a></u> : it analyzes the collection of objects and, at its output, leaves only those objects to which no one refers. <br><br>  In the above example, the <code>Purge()</code> method is called for a collection in which there is only one object ‚Äî the layer to be deleted.  If no one references this layer, then after calling the <code>Purge()</code> method, it will remain in the collection, and then you can proceed to delete.  If the call to the <code>Purge()</code> method returns an empty collection, then there are references to the layer to be removed - probably, the objects placed on it. <br><br>  If we load the plugin and execute the ‚ÄúTestCommand‚Äù command, and then the ‚ÄúNewCommand‚Äù command, we will see that the layer we created will be removed from the drawing. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4b9/e46/4b8/4b9e464b834d4264b0e7231acf50f26c.png"></div><br><br><h5>  2.7.  Prevent darkening of blocked layers </h5><br>  In conclusion, I would like to talk about one more parameter related to the layers. <br><br>  By default, locked layers in AutoCAD are displayed as blacked out.  The maximum possible blackout is 90% (like the rectangle in the image below). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c19/fe4/0ea/c19fe40ea52547dda01e9f22c7d09d3f.png"></div><br><br>  To change the degree of darkening is the variable <b>LAYLOCKFADECTL</b> .  Its value is set by the corresponding slider on the layers control panel (circled in green in the figure). <br><br>  To change the value of the <b>LAYLOCKFADECTL</b> variable inside the plugin, you can use the <code>SetSystemVariable</code> function: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Autodesk</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.AutoCAD</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ApplicationServices</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Application</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.SetSystemVariable</span></span>("<span class="hljs-selector-tag"><span class="hljs-selector-tag">LAYLOCKFADECTL</span></span>", 0);</code> </pre><br>  As a result of executing this code, the darkening of locked layers will be disabled. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before changing the variable </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LAYLOCKFADECTL, you</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> should save its current value in order to return the variable to its original state after the plugin finishes its work.</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Code:</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.Runtime; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.ApplicationServices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Autodesk.AutoCAD.DatabaseServices; namespace HabrPlug_Layers { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Commands : IExtensionApplication { //         <span class="hljs-type"><span class="hljs-type">int</span></span> old_LAYLOCKFADECTL = <span class="hljs-number"><span class="hljs-number">0</span></span>; //     <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Initialize() { //       old_LAYLOCKFADECTL = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Convert.ToInt32(Autodesk.AutoCAD.ApplicationServices.Application.GetSystemVariable("LAYLOCKFADECTL")); //        <span class="hljs-number"><span class="hljs-number">0</span></span> Autodesk.AutoCAD.ApplicationServices.Application.SetSystemVariable("LAYLOCKFADECTL", <span class="hljs-number"><span class="hljs-number">0</span></span>); } //    AutoCAD <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Terminate() { //      ,       Autodesk.AutoCAD.ApplicationServices.Application.SetSystemVariable("LAYLOCKFADECTL", old_LAYLOCKFADECTL); } } }</code> </pre> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unfortunately, the method </font></font><code>Terminate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">does not always work correctly, and the original value may not be restored. </font><font style="vertical-align: inherit;">But at least we tried.) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That's all for now. </font><font style="vertical-align: inherit;">Next time I will write about creating simple objects and blocks.</font></font></div><p>Source: <a href="https://habr.com/ru/post/249015/">https://habr.com/ru/post/249015/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249001/index.html">New Flash Player vulnerabilities are exploited in-the-wild</a></li>
<li><a href="../249005/index.html">Attention, application ideas contest for Microsoft and Mojio</a></li>
<li><a href="../249007/index.html">Ghost - gethostbyname () vulnerability in glibc</a></li>
<li><a href="../249009/index.html">How we won the Intel RealSense Hackathon</a></li>
<li><a href="../249011/index.html">New heart for Chinese lantern</a></li>
<li><a href="../249017/index.html">Surface mounting: stencil and reflow oven at home</a></li>
<li><a href="../249021/index.html">The evolution of SAAS website designers</a></li>
<li><a href="../249023/index.html">Candelabrum vs Lollipop</a></li>
<li><a href="../249025/index.html">Announcement of the JPoint 2015 Java Conference</a></li>
<li><a href="../249027/index.html">Procedural generation of planetary textures based on the Diamond-Square algorithm, part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>