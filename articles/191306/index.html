<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About InfiniBand: how we reduced ping from 7 Œºs to 2.4 Œºs (and test results)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="InfiniBand switch SX6005. 12 FDR 56Gb / s ports per unit, switching 1.3Tb / s. 

 Many people believe that InfiniBand is ‚Äúspace‚Äù. That is, it is belie...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About InfiniBand: how we reduced ping from 7 Œºs to 2.4 Œºs (and test results)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/332/35e/c34/33235ec342a1ef877245e7d3c5cb5e98.jpg"><br>  <sup>InfiniBand switch SX6005.</sup>  <sup>12 FDR 56Gb / s ports per unit, switching 1.3Tb / s.</sup> <br><br>  Many people believe that InfiniBand is ‚Äúspace‚Äù.  That is, it is believed that it is expensive and necessary only for ‚Äúsupercomputers‚Äù (HPC) with a capacity of 1-2 Petaflops and with huge volumes of processed data.  However, using this technology, you can organize not only the fastest interconnects in clusters, but also drastically reduce delays in critical applications.  Specifically - <b>to do something that can be solved using Ethernet</b> , but more economical and faster.  Here is an example. <br><br><h4>  Task </h4><br>  One of our major customers from the financial sector had a problem with the speed of the two applications.  The specifics of the application was that it was necessary to process a large number of transactions with minimal delay.  6-7 Œºs latency - this is the best results that they achieved by upgrading servers and maximum software refinement.  Further possible optimizations promised improvements of 0.3-0.5 ¬µs.  We came and said that we could reduce the delays in half. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Decision </h4><br>  We suggested making communication between servers using InfiniBand.  Of course, the customer‚Äôs specialists had heard about this technology, but they needed specific tests on the site to check everything personally.  To do this, we prepared a set of demo equipment, and they allocated several servers for it.  "Battle" server did not want to touch for obvious reasons.  So, we built a fragment of a live network using IB connections at the customer‚Äôs site. <br><br>  To solve this problem, we took the equipment manufactured by Mellanox.  The main criteria for choosing this particular manufacturer was that the Mellanox switches have ‚Äúuniversal ports‚Äù, which are programmatically defined either as an InfiniBand port or as regular Ethernet ‚Äî which will then allow seamless integration into the customer's existing Ethernet network.  In addition, Mellanox produces a full range of equipment (including switches, network cards for any servers, interface cables, and so on), which in the future will make it possible to assemble the entire solution regardless of the type and manufacturer of the servers available to the customer. <br><br>  Customers installed their applications on servers and rolled tests (it seems, using real tasks of almost the previous financial day) and testing began. <br><br><h4>  Test results </h4><br>  First Test Architecture: <br><img src="https://habrastorage.org/storage2/09c/013/198/09c0131983462b06dd6c11fbd5c1b457.jpg"><br>  <sup>IB equipment: ConnectX-3 HCA, SX6025 FDR switch, HP Proliant DL380 G7 server, RHEL OS 6.4 MRG 2.2.</sup> <br><br>  <b>Testing steps:</b> <br><br><blockquote> Run IB Read latency test: <br>  On the 1st node: <code>ib_read_lat -a</code> <br>  On the 2nd node: <code>ib_read_lat ‚Äìa &lt;node1_ip&gt;</code> <br><br>  Run IB Write latency test: <br>  On the 1st node: <code>ib_write_lat -a -R</code> <br>  On the 2nd node: <code>ib_write_lat ‚Äìa -R &lt;node1_ip&gt;</code> <br><br>  Run the IB Send latency test: <br>  On the 1st node: <code>ib_send_lat -a -R</code> <br>  On the 2nd node: <code>ib_send_lat ‚Äìa -R &lt;node1_ip&gt;</code> </blockquote><br><br><div class="spoiler">  <b class="spoiler_title">results</b> <div class="spoiler_text"><blockquote>  ib_read_lat - <br>  #bytes #iterations t_min [usec] t_max [usec] t_typical [usec] <br>  2 1000 2.34 9.90 2.36 <br>  4 1000 2.34 95.75 2.37 <br>  8 1000 2.34 14.15 2.37 <br>  16 1000 2.35 14.27 2.37 <br>  32 1000 2.37 12.02 2.40 <br>  64 1000 2.38 15.85 2.42 <br>  128 1000 2.49 14.03 2.52 <br>  256 1000 2.67 11.69 2.69 <br>  512 1000 2.98 15.09 3.02 <br>  1024 1000 3.62 14.01 3.66 <br>  2048 1000 4.90 94.37 4.95 <br>  4096 1000 6.09 16.45 6.13 <br>  8192 1000 8.42 14.42 8.47 <br>  16384 1000 13.10 20.04 13.15 <br>  32768 1000 22.44 26.07 22.98 <br>  65536 1000 41.66 53.00 41.72 <br>  131072 1000 79.52 82.96 79.65 <br>  262144 1000 155.42 160.17 155.51 <br>  524288 1000 307.13 372.69 307.26 <br>  1048576 1000 610.54 619.63 610.89 <br>  2097152 1000 1217.37 1305.74 1217.84 <br>  4194304 1000 2431.34 2466.40 2431.94 <br>  8388608 1000 4859.15 4928.79 4860.07 <br><br>  ib_write_lat - <br>  #bytes #iterations t_min [usec] t_max [usec] t_typical [usec] <br>  2 1000 1.26 6.29 1.28 <br>  4 1000 1.26 7.44 1.28 <br>  8 1000 1.27 5.87 1.28 <br>  16 1000 1.27 47.73 1.29 <br>  32 1000 1.34 5.79 1.35 <br>  64 1000 1.34 5.25 1.36 <br>  128 1000 1.48 5.36 1.50 <br>  256 1000 2.22 7.44 2.26 <br>  512 1000 2.94 47.86 2.98 <br>  1024 1000 3.58 7.95 3.63 <br>  2048 1000 4.88 8.22 4.91 <br>  4096 1000 6.06 9.99 6.09 <br>  8192 1000 8.39 11.21 8.43 <br>  16384 1000 13.07 15.25 13.48 <br>  32768 1000 22.82 27.43 22.89 <br>  65536 1000 41.95 45.60 42.04 <br>  131072 1000 79.88 85.01 79.93 <br>  262144 1000 155.75 160.06 155.84 <br>  524288 1000 307.50 332.07 307.65 <br>  1048576 1000 610.99 628.83 611.27 <br>  2097152 1000 1218.10 1227.02 1218.48 <br>  4194304 1000 2432.72 2475.44 2433.46 <br>  8388608 1000 4989.11 5025.70 4991.06 <br><br>  ib_send_lat - <br>  #bytes #iterations t_min [usec] t_max [usec] t_typical [usec] <br>  2 1000 1.32 5.74 1.34 <br>  4 1000 1.32 5.18 1.34 <br>  8 1000 1.32 5.33 1.34 <br>  16 1000 1.33 5.40 1.35 <br>  32 1000 1.35 5.79 1.37 <br>  64 1000 1.40 5.43 1.42 <br>  128 1000 1.53 5.52 1.55 <br>  256 1000 2.28 5.60 2.31 <br>  512 1000 2.92 7.45 2.95 <br>  1024 1000 3.56 7.79 3.59 <br>  2048 1000 4.85 8.94 4.88 <br>  4096 1000 6.03 13.98 6.07 <br>  8192 1000 8.36 16.11 8.40 <br>  16384 1000 13.02 20.84 13.09 <br>  32768 1000 22.39 30.22 23.21 <br>  65536 1000 41.93 66.03 42.02 <br>  131072 1000 79.84 92.94 79.92 <br>  262144 1000 155.72 164.96 155.81 <br>  524288 1000 307.49 321.99 307.68 <br>  1048576 1000 610.97 626.82 611.27 <br>  2097152 1000 1218.05 1241.91 1218.48 <br>  4194304 1000 2432.68 2473.29 2433.54 <br>  8388608 1000 4968.03 4994.76 4991.17 </blockquote></div></div><br><br>  <b>The following test (IPoIB performance):</b> <br><blockquote>  1. Run the Sockperf UDP test: <br>  On the 1st node: <code><code><code><code>sockperf sr -i <br>  2- : sockperf pp -t 10 ‚Äìi <br> <br> 2.   Sockperf TCP: <br>  1- : sockperf sr -i --tcp <br>  2- : sockperf pp -t 10 ‚Äìi --tcp <br> <br></code></code></code></code> <code><code><code><code>sockperf sr -i <br>  2- : sockperf pp -t 10 ‚Äìi <br> <br> 2.   Sockperf TCP: <br>  1- : sockperf sr -i --tcp <br>  2- : sockperf pp -t 10 ‚Äìi --tcp</code> <br> <br></code></code></code> <div class="spoiler">  <b class="spoiler_title">Second test results</b> <div class="spoiler_text"><blockquote>  Test Sockperf UDP: <br>  For a packet of 16 bytes: avg-lat = 9.133 (std-dev = 1.226) <br>  For a 64 byte packet: avg-lat = 9.298 (std-dev = 1.268) <br>  For a packet of 256 bytes: avg-lat = 9.605 (std-dev = 1.031) <br>  For a packet of 1024 bytes: avg-lat = 10.791 (std-dev = 1.066) <br>  For a packet of 4096 bytes: avg-lat = 17.107 (std-dev = 1.548) <br>  For packet 16384 bytes: avg-lat = 34.512 (std-dev = 2.098) <br>  For a packet of 65506 bytes: avg-lat = 96.502 (std-dev = 3.181) <br><br>  Test Sockperf TCP: <br><br>  For a packet of 16 bytes: avg-lat = 10.509 (std-dev = 1.185) <br>  For a 64 byte packet: avg-lat = 10.506 (std-dev = 1.154) <br>  For a packet of 256 bytes: avg-lat = 11.552 (std-dev = 1.128) <br>  For a packet of 1024 bytes: avg-lat = 12.409 (std-dev = 1.168) <br>  For a packet of 4096 bytes: avg-lat = 18.991 (std-dev = 1.506) <br>  For packet 16384 bytes: avg-lat = 32.937 (std-dev = 1.952) <br>  For a packet of 65506 bytes: avg-lat = 76.926 (std-dev = 3.066) </blockquote></div></div><br><br>  <b>The final result is 2.36 - 2.37 Œºs.</b>  The best results are about 2 ¬µs.  It was possible to achieve more than the customer required. <br><br>  And even after the tests, I saw the very feeling of deep moral satisfaction experienced by people who know that now their system will work more efficiently.  Without replacing servers. <br><br><h4>  Ethernet and InfiniBand </h4><br>  I must say: one thing is not a replacement for another.  It's like comparing a passenger car with a tank: one is convenient and fast, and on the second one you can go to Europe.  It is important that from IB you should not expect a large number of services and the possibility of building a complex routing scheme - this is an absolute lot of Ethernet.  The IB architecture is ‚Äúflat‚Äù. <br><br>  In this case, as a result of simplicity - InfiniBand is very easy to upgrade and scale.  Our practice of deploying local networks after installing the equipment is to go through and plug in the contacts, and then sit for an hour at the terminal, and from this hour, 40 minutes will go to check the ready-made solution.  In the case of Ethernet rebuilding, architecture changes are required where there are so many steps ‚Äî and because of the flexibility and some kind of vindictiveness of the technology in relation to those who do not know all the subtleties, the procedure is similar to signing a contract with a bunch of items in small print.  And there are some chances that complex architecture will bring surprises in the future. <br><br>  Rebuilding an Ethernet network with parameters like IB will take 3-4 times longer on average.  The speed of solving problems of restoring the IB network is a maximum of 4 hours at any time of the day.  This indicator can be easily registered in the SLA - we have never been faced with the fact that even in difficult cases, time at least somehow crushed.  Of course, you can register the same time for Ethernet - but then an entire team of system administrators must go to the site. <br><br>  <b>Well, the main difference is speed.</b> <br>  Ethernet, like FibreChannel, is a "limited" technology.  Of course, you can provide 100Gb bandwidth on Ethernet by aggregating an unlimited number of 10Gb links.  But!  First is the limit.  Secondly - what will be the cost of this solution?  And if you add the cost of operation?  We still need to understand how much space, electricity and the cost of heat removal in the data center will require a 100 Gb core-level switch, but they need more than one.  At IB - 100 Gb / s is not the limit, and the cost of this solution (both CAPEX and OPEX) will be several times less, since there is less space, less loss, fewer cables, less electricity and air conditioning costs, less man hours. on operation and so on.  In general, IB is sick simply faster and cheaper for tasks of this class. <br><br>  <b>Need a practical example?</b> <br>  You are welcome.  Our cloudy data center at some point demanded high speeds.  At the same time, the architecture should be very flexible, quickly and painlessly modernized, reconfigured for specific individual client requirements (this is one of the CRIC‚Äôs cloud trumps).  Having calculated the rate of change, we certainly chose IB. <br><br><h4>  Manufacturers </h4><br>  There used to be four main manufacturers - Qlogic, Mellanox, Voltaire and Topspin.  Mellanox bought Voltaire about 3 years ago.  Topspin became part of Cisco in 2005, and Intel acquired Qlogic in 2012 (now the equipment is mainly OEP).  As a result, there is now a profile player - Mellanox, providing the most complete range.  Its OEM is HP, IBM, Violin and so on. <br><br><h4>  Perspectives </h4><br>  Among the ‚Äúspace-based‚Äù high-speed solutions, InfiniBand turns out to be very economical both in implementation costs and in service.  Only 2-3 years ago such solutions were needed only for very serious tasks with industry significance, but now there are more and more enterprise-class projects.  Everything is very simple: the amount of data increases, the load from applications grows, server performance grows and, as a result, other data exchange speeds between servers and application speeds are required. <br><br>  Customers say this: ‚ÄúWe are not losing anything, we are not changing the technology, we are not throwing out Ethernet, but we want to complement our InfiniBand infrastructure.‚Äù <br><br><h4>  Why come to us with such questions? </h4><br>  Many customers are very pleased that, firstly, you can look at the equipment live (we are constantly working on our projects and in our data centers), do tests on our sites (as I gave the example above), introduce a pilot system and then everything to introduce.  We also have people who can optimize software for specific large-scale tasks taking into account all the features of networks - this is the next round of work with highload.  And we try to tell as much as possible in a professional manner about all the possible technological options for solving the problem, without imposing anything on anyone. <br><br>  <b>UPD.</b>  Judging by the comments, it is not entirely clear why such a decision was chosen.  Summarizing: the customer had to solve the problem of reducing delays from 7 Œºs to 3 Œºs on specific applications.  It was possible to solve this by installing low-latency Ethernet equipment, which the customer was able to calculate himself.  At the same time, the technical specialists of the customer decided to compare IB with their version. <br><br>  We conducted tests at the customer‚Äôs site, and its specialists confirmed the following: <br><ul><li>  IB fully solves the problem and even exceeds customer expectations. </li><li>  The solution is very easy to deploy on combat servers with continuous services. </li><li>  The solution is convenient to operate. </li><li>  The cost of implementation and maintenance costs are much lower than for Ethernet solutions. </li></ul><br>  In this case, the customer used IB-compatible modules, which determined the choice of vendor. <br><br>  PS If you are interested in this topic, then on September 12 I will conduct a webinar, <a href="http://www.croc.ru/action/detail/23033/">connect</a> .  If you need to immediately calculate something or understand whether it is possible to conduct tests directly on your site, write to AFrolov@croc.ru. </blockquote></div><p>Source: <a href="https://habr.com/ru/post/191306/">https://habr.com/ru/post/191306/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191290/index.html">Locating a user using Google Play Services</a></li>
<li><a href="../191296/index.html">We write backend for a mobile application in a few minutes</a></li>
<li><a href="../191298/index.html">How to generate random bracket sequences</a></li>
<li><a href="../191302/index.html">What happens after buying a startup?</a></li>
<li><a href="../191304/index.html">Caliber 1.0 released</a></li>
<li><a href="../191308/index.html">Browsers and the frequency of their fall</a></li>
<li><a href="../191310/index.html">Motorola Wireless Networks Based on WING5 Architecture</a></li>
<li><a href="../191312/index.html">Many free books on programming</a></li>
<li><a href="../191314/index.html">HTC Radar C110. Review article about the modern gadget and its applications</a></li>
<li><a href="../191316/index.html">Pros and cons of various approaches to anonymity in the network</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>