<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We saw our Windows service - a guide for ‚Äúnot real programmers‚Äù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One day you will think how to turn a script or application into a Windows service. Most likely, the task will not be so trivial - the application will...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We saw our Windows service - a guide for ‚Äúnot real programmers‚Äù</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/j3/j5/7b/j3j57big8bze9751j7_frrcjc7q.jpeg"></p><br><p>  One day you will think how to turn a script or application into a Windows service.  Most likely, the task will not be so trivial - the application will need at least a special interface to receive commands from the system.  And since there are requirements and limitations, there are scripts and sweethearts to overcome. </p><br><p>  The article will be useful to those who, like me - "the programmer is not real." <a name="habracut"></a></p><br><h1 id="zachem-nuzhna-sluzhba-esli-est-naznachennye-zadaniya">  Why do I need a service if there are scheduled tasks </h1><br><p>  Unlike scheduled tasks, the service runs continuously, starts at the start of the PC, and can be controlled by Windows tools.  Also, a regularly running script may need data from a previous launch, and it may be useful to get data from external sources - for example, in the case of TCP or Web server. </p><br><p>  Personally, over the past five years I have had to create a service three and a half times: </p><br><ul><li>  It was necessary to create a service for <strong>fail2ban for Windows 2003.</strong> , which worked with the FileZilla and Apache logs, and if it was suspected, brute-force blocked IP by standard Windows tools ‚Äî ipsec. </li><li>  Analogue telnet server for home versions of Windows.  It took to execute commands on remote workstations that were running Windows 7 Home.  In fact, the second attempt to play in the service. </li><li>  Music player for the trading floor under Windows.  The task of the TZ could be solved with the help of <strong><a href="https://www.musicpd.org/">mpd</a></strong> and packs of scripts, but I decided - if you do scripts, then why not ‚Äúpile‚Äù the player yourself.  Based on the library <a href="http://www.un4seen.com/">BASS.dll</a> . </li><li>  When choosing a web server with support for downloading files under Windows, one option was <strong><a href="http://www.rejetto.com/hfs/">HFS</a></strong> .  By itself, he can not work, so I had to "shove" him into the service.  As a result, the decision was not pleasant, and they simply installed the <a href="https://oupala.github.io/apaxy/">Apaxy</a> ‚Äútheme‚Äù on the Apache web server. </li></ul><br><p>  To create a service, you can use adult programming languages ‚Äã‚Äãlike C. But if you don‚Äôt want to contact Visual Studio, then get ready-made utilities.  There are paid solutions like <a href="http://www.firedaemon.com/products">FireDaemon Pro</a> or <a href="https://www.coretechnologies.com/products/AlwaysUp/">AlwaysUp</a> , but we traditionally focus on free ones. </p><br><h1 id="sposob-pervyy-ot-microsoft">  Method one.  From Microsoft </h1><br><p>  This is a middle-aged mechanism consists of two components: <strong>instsrv.exe</strong> utilities for installing the service and <strong>srvany.exe</strong> , a process for running any executable files.  Suppose we created a web server on PowerShell using the <a href="https://github.com/powershell/Polaris">Polaris</a> module.  The script will be extremely simple: </p><br><pre><code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-PolarisGetRoute -Path <span class="hljs-string"><span class="hljs-string">'/helloworld'</span></span> -Scriptblock { $Response.Send(<span class="hljs-string"><span class="hljs-string">'Hello World!'</span></span>) } Start-Polaris -Port <span class="hljs-number"><span class="hljs-number">8080</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>($true) { Start-Sleep -Milliseconds <span class="hljs-number"><span class="hljs-number">10</span></span> }</code> </pre> <br><p><img src="https://habrastorage.org/webt/im/br/xz/imbrxzpsqml1osyityi0k1nwe1w.jpeg"><br>  <em>The work of the so-called "server".</em> </p><br><p>  Now we will try to turn the script into a service.  To do this, download the <a href="https://www.microsoft.com/en-us/download/details.aspx%3Fid%3D17657">Windows Resource Kit Tools</a> , where our utilities will be.  Let's start by installing an empty service with the command: </p><br><pre> <code class="hljs tex">instsrv WebServ C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">temp</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rktools</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">srvany</span></span></span></span>.exe</code> </pre><br><p>  Where WebServ is the name of our new service.  If necessary, using the <strong>services.msc</strong> snap-in, you can specify the user under which the service will run, and allow interaction with the desktop. </p><br><p>  Now let's write the path to our script with the help of registry magic.  The service settings are in the registry key <strong>HKLM \ SYSTEM \ CurrentControlSet \ Services \ WebServ</strong> .  In it, we need to add a new <strong>Parameters</strong> section and create an <strong>Application</strong> string parameter there, indicating in it the path to the executable file.  In the case of the PowerShell script, it will look like this: </p><br><pre> <code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">System</span></span></span></span>32<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WindowsPowerShell</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">v</span></span></span></span>1.0<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">powershell</span></span></span></span>.exe -ExecutionPolicy Bypass -NoProfile -File C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">temp</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Polaris</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">server</span></span></span></span>.ps1</code> </pre><br><p><img src="https://habrastorage.org/webt/2c/9a/zw/2c9azwf_tlvz6cs2ez4jlw7pl58.jpeg"><br>  <em>Customized service.</em> </p><br><p>  You can run and enjoy. </p><br><p><img src="https://habrastorage.org/webt/4j/qh/kd/4jqhkdbgssb6gv8el-qpnfn4wea.jpeg"><br>  <em>Running service</em> </p><br><p>  However, this method has disadvantages: </p><br><ul><li>  The utilities are old, developed before the invention of PowerShell, UAC and other things. </li><li>  <strong>Srvany</strong> does not control the operation of the application.  Even if it falls into error, the service will continue its work as if nothing had happened. </li><li>  We'll have to tune in and dig into the registry.  You remember that it is not safe to dig in the registry? </li></ul><br><p>  Therefore, we turn to the method, partially devoid of these problems. </p><br><h1 id="sposob-vtoroy-pochti-vzroslyy">  Method two, almost adult </h1><br><p>  There is a utility called <a href="https://nssm.cc/">NSSM</a> - <strong>Non-Sucking Service Manager</strong> , which can be translated as a <em>non-bad service manager</em> .  Unlike the previous one, it is supported by the developer, and the source code is published on the site.  In addition to the usual method, installation is also available through the <a href="http://chocolatey.org/packages/NSSM">Chocolately</a> package manager. </p><br><p>  You can create a service from the usual command line, armed with <a href="https://nssm.cc/usage">documentation</a> on the developer's site.  But we will use PowerShell.  Because we can, of course. </p><br><pre> <code class="hljs perl">$nssm = (Get-Command ./nssm).Source $serviceName = <span class="hljs-string"><span class="hljs-string">'WebServ'</span></span> $powershell = (Get-Command powershell).Source $scriptPath = <span class="hljs-string"><span class="hljs-string">'C:\temp\Polaris\server.ps1'</span></span> $arguments = <span class="hljs-string"><span class="hljs-string">'-ExecutionPolicy Bypass -NoProfile -File "{0}"'</span></span> -f $scriptPath &amp; $nssm install $serviceName $powershell $arguments &amp; $nssm status $serviceName Start-Service $serviceName Get-Service $serviceName</code> </pre> <br><p><img src="https://habrastorage.org/webt/nn/gf/xz/nngfxzjxsimbi2srebmcwjzioie.jpeg"><br>  <em>Installation via PowerShell.</em> </p><br><p>  For a change, we‚Äôll check the operation of the service not with a browser, but also through PowerShell with the <strong>Invoke-RestMethod command.</strong> </p><br><p><img src="https://habrastorage.org/webt/b-/wg/17/b-wg17nhhlesw6xon8sdv9c0hks.png"><br>  <em>It really works.</em> </p><br><p>  Unlike <strong>srvany</strong> , this method allows you to restart the application at startup, redirect <strong>stdin</strong> and <strong>stdout,</strong> and more.  In particular, if you do not want to write commands on the command line, then it is enough to launch the GUI and enter the necessary parameters through a convenient interface. </p><br><p>  The GUI is started with the command: </p><br><pre> <code class="hljs sql">nssm.exe <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> ServiceName</code> </pre> <br><p><img src="https://habrastorage.org/webt/ji/rg/6i/jirg6iwexgpn_3zun4ich0zgepo.jpeg"><br>  <em>You can even adjust the priority and use of processor cores.</em> </p><br><p>  Indeed, the possibilities are much greater than those of <strong>srvany</strong> and a number of other <a href="https://alternativeto.net/software/nssm--the-non-sucking-service-manager/">analogues</a> .  Of the minuses is the lack of control over the whole process. </p><br><p>  There is a lack of "tin".  Therefore, I turn to the most hardcore method of all tested. </p><br><h1 id="sposob-tretiy-autoit">  The third way.  Autoit </h1><br><p>  Since I am a longtime lover of this scripting language, I could not pass by a library called <a href="https://www.autoitscript.com/forum/topic/80201-_service_udf-v4-build-your-own-service-with-autoit-code/">_Services_UDF v4</a> .  It is equipped with rich documentation and examples, so under the spoiler I will immediately give the full text of the resulting script. </p><br><div class="spoiler">  <b class="spoiler_title">Listing script</b> <div class="spoiler_text"><p>  So, let's try to ‚Äúwrap‚Äù our web service in it: </p><br><pre> <code class="hljs mel">#NoTrayIcon #RequireAdmin #Region #AutoIt3Wrapper_Version=Beta #AutoIt3Wrapper_UseUpx=n #AutoIt3Wrapper_Compile_Both=y #AutoIt3Wrapper_UseX64=y #EndRegion Dim $MainLog = @ScriptDir &amp; <span class="hljs-string"><span class="hljs-string">"\test_service.log"</span></span> #include &lt;services.au3&gt; #include &lt;WindowsConstants.au3&gt; $sServiceName=<span class="hljs-string"><span class="hljs-string">"WebServ"</span></span> If $cmdline[<span class="hljs-number"><span class="hljs-number">0</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> Then Switch $cmdline[<span class="hljs-number"><span class="hljs-number">1</span></span>] Case <span class="hljs-string"><span class="hljs-string">"install"</span></span>, <span class="hljs-string"><span class="hljs-string">"-i"</span></span>, <span class="hljs-string"><span class="hljs-string">"/i"</span></span> InstallService() Case <span class="hljs-string"><span class="hljs-string">"remove"</span></span>, <span class="hljs-string"><span class="hljs-string">"-u"</span></span>, <span class="hljs-string"><span class="hljs-string">"/u"</span></span>, <span class="hljs-string"><span class="hljs-string">"uninstall"</span></span> RemoveService() Case Else ConsoleWrite(<span class="hljs-string"><span class="hljs-string">" - - - Help - - - "</span></span> &amp; @CRLF) ConsoleWrite(<span class="hljs-string"><span class="hljs-string">"params : "</span></span> &amp; @CRLF) ConsoleWrite(<span class="hljs-string"><span class="hljs-string">" -i : install service"</span></span> &amp; @CRLF) ConsoleWrite(<span class="hljs-string"><span class="hljs-string">" -u : remove service"</span></span> &amp; @CRLF) ConsoleWrite(<span class="hljs-string"><span class="hljs-string">" - - - - - - - - "</span></span> &amp; @CRLF) Exit EndSwitch Else _Service_init($sServiceName) Exit EndIf Func _main($iArg, $sArgs) If Not _Service_ReportStatus($SERVICE_RUNNING, $NO_ERROR, <span class="hljs-number"><span class="hljs-number">0</span></span>) Then _Service_ReportStatus($SERVICE_STOPPED, _WinAPI_GetLastError(), <span class="hljs-number"><span class="hljs-number">0</span></span>) Exit EndIf $bServiceRunning = True $PID=Run(<span class="hljs-string"><span class="hljs-string">"C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -ExecutionPolicy Bypass -NoProfile -File C:\temp\Polaris\server.ps1"</span></span>) While $bServiceRunning _sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>) WEnd ProcessClose($PID) _Service_ReportStatus($SERVICE_STOP_PENDING, $NO_ERROR, <span class="hljs-number"><span class="hljs-number">1000</span></span>) DllCallbackFree($tServiceMain) DllCallbackFree($tServiceCtrl) _Service_ReportStatus($SERVICE_STOPPED, $NO_ERROR, <span class="hljs-number"><span class="hljs-number">0</span></span>) DllClose($hAdvapi32_DLL) DllClose($hKernel32_DLL) EndFunc Func _Sleep($delay) Local $result = DllCall($hKernel32_DLL, <span class="hljs-string"><span class="hljs-string">"none"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sleep"</span></span>, <span class="hljs-string"><span class="hljs-string">"dword"</span></span>, $delay) EndFunc Func InstallService() #RequireAdmin Local $bDebug = True If $cmdline[<span class="hljs-number"><span class="hljs-number">0</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> Then $sServiceName = $cmdline[<span class="hljs-number"><span class="hljs-number">2</span></span>] EndIf If $bDebug Then ConsoleWrite(<span class="hljs-string"><span class="hljs-string">"InstallService("</span></span>&amp;$sServiceName &amp;<span class="hljs-string"><span class="hljs-string">"): Installing service, please wait"</span></span>) _Service_Create($sServiceName, $sServiceName, $SERVICE_WIN32_OWN_PROCESS, $SERVICE_AUTO_START, $SERVICE_ERROR_SEVERE, <span class="hljs-string"><span class="hljs-string">'"'</span></span> &amp; @ScriptFullPath &amp; <span class="hljs-string"><span class="hljs-string">'"'</span></span>);,<span class="hljs-string"><span class="hljs-string">""</span></span>,False,<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">"NT AUTHORITY\NetworkService"</span></span>) If @error Then Msgbox(<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">"InstallService(): Problem installing service, Error number is "</span></span> &amp; @error &amp; @CRLF &amp; <span class="hljs-string"><span class="hljs-string">" message : "</span></span> &amp; _WinAPI_GetLastErrorMessage()) Else If $bDebug Then ConsoleWrite(<span class="hljs-string"><span class="hljs-string">"InstallService(): Installation of service successful"</span></span>) EndIf Exit EndFunc Func RemoveService() _Service_Stop($sServiceName) _Service_Delete($sServiceName) If Not @error Then EndIf Exit EndFunc Func _exit() _Service_ReportStatus($SERVICE_STOPPED, $NO_ERROR, <span class="hljs-number"><span class="hljs-number">0</span></span>); EndFunc Func StopTimer() _Service_ReportStatus($SERVICE_STOP_PENDING, $NO_ERROR, $iServiceCounter) $iServiceCounter += <span class="hljs-number"><span class="hljs-number">-100</span></span> EndFunc Func _Stopping() _Service_ReportStatus($SERVICE_STOP_PENDING, $NO_ERROR, <span class="hljs-number"><span class="hljs-number">3000</span></span>) EndFunc</code> </pre> </div></div><br><p>  I will analyze in more detail the moment you start the application  It starts after the operation <strong>$ bServiceRunning = True</strong> and turns into a seemingly infinite loop.  In fact, this process will be interrupted as soon as the service receives a signal for termination - be it to log out or stop manually. </p><br><p>  Since the script program is external (powershell.exe), after exiting the loop we need to finish its work using <strong>ProcessClose</strong> . </p><br><p>  To do this, the script must be compiled into <strong>.exe</strong> , and then install the service by running exe with the <strong>-i</strong> key <strong>.</strong> </p><br><p><img src="https://habrastorage.org/webt/wl/xp/ph/wlxpphvp20lakbyd2wii7ssytle.jpeg"><br>  <em>It is working!</em> </p><br><p>  Of course, this method is not the most convenient, and all additional features will have to be implemented independently, whether it be a restart of the application in case of failure or log rotation.  But then he gives full control over what is happening.  Yes, and in the end you can do much more - from the <a href="https://habr.com/company/pc-administrator/blog/353652/">notice</a> in the Telegram about the failure of the service to IPC-interaction with other programs.  And in addition - in the scripting language, without installing and learning Visual Studio. </p><br><p>  Tell me, did you have to turn scripts and applications into services? </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/421019/">https://habr.com/ru/post/421019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../421005/index.html">REST-assured: useful tips</a></li>
<li><a href="../421007/index.html">Tape recorder - a tool for recording autotests</a></li>
<li><a href="../421009/index.html">August 25 and 26: Online Operational Management Conference</a></li>
<li><a href="../421011/index.html">The interview questions you think are stupid. But really not</a></li>
<li><a href="../421015/index.html">Study of the sustainability of national segments of the Internet for 2018</a></li>
<li><a href="../421021/index.html">Google Hadoop Review (dataproc)</a></li>
<li><a href="../421023/index.html">Corporate Schizophrenia</a></li>
<li><a href="../421025/index.html">7 effective managed firewalls to protect your cloud infrastructure</a></li>
<li><a href="../421027/index.html">International Standard Data Exchange SDMX (Statistical Data and Metadata eXchange)</a></li>
<li><a href="../421029/index.html">How to increase the capacity of stores and get rid of queues</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>