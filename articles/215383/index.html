<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>My implementation of the automatic inclusion of light in the toilet (and without Arduino)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 On Habr√© appear and appear articles on the implementation of the Smart Home. The most important problem (or just for me) is turning on / off ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>My implementation of the automatic inclusion of light in the toilet (and without Arduino)</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br>  On Habr√© appear and appear articles on the implementation of the Smart Home.  The most important problem (or just for me) is turning on / off the light in the bathroom.  It seems that the thing is not tricky - but how many options are there.  After reading the articles, including <a href="http://habrahabr.ru/post/191092/">here</a> and <a href="http://habrahabr.ru/post/210664/">here</a> , I thought, "But it could have been easier." <br><a name="habracut"></a><br>  This worm sharpened me about six months.  And when it became freer with work, I matured. <br>  I say that I like to do programming and radio design from school.  Microcontrollers gave real joy - all at once.  And Arduino is not here, not because <s>I hate</s> him for this task is redundant, or because I want to be not like everyone else, I just have not gotten to him (or he to me). <br>  Let us return to our sheep (well, either to our light, or to our toilet).  For me personally, drawing in the head TZ (yes, draw, this is when you can‚Äôt even articulate, not what you write on paper) is much more difficult than it is to realize.  After weeks of thinking, this is what I got about: <br><ul><li>  the light should turn on when I open the door (I go for example); </li><li>  the light should turn on when I close the door (went into the bathroom with the door open and closed behind me); </li><li>  the light should turn on when I enter without touching the door (I looked into the hands to wash); </li><li>  auto light off after a certain time; </li><li>  <b>the light should not turn off when I'm inside and do not even move.</b> </li></ul><br>  It seems that everything is logical and simple, but I have not found a beautiful solution in any of the articles I have met.  The simplest is the motion sensor.  It turns on the light when someone is there and turns it off after a while.  For my purposes, he lacks only a reed switch a couple - to follow, the door is open or closed. <br>  I do not understand why, until now, manufacturers have not reached this point.  Or reached, but did not reach me? <br>  The algorithm is simple: <br><ul><li>  if the motion sensor has triggered - turn on the light; </li><li>  if the state of the reed switch has changed (door opened / closed) - turn on the light; </li><li>  <b>if the motion sensor has triggered when the door is closed (the reed switch is closed) - do not turn off the light until the door is opened;</b> </li><li>  Well, turn off the light after a while. </li></ul><br>  Now TZ is clear, I need: <br><ul><li>  Motion Sensor; </li><li>  reed switch; </li><li>  MK to control this mess. </li></ul><br>  The cheapest DD (infrared), some kind of reed switch was bought, ATTiny2313. <br><img src="https://habrastorage.org/getpro/habr/post_images/d4f/4cd/113/d4f4cd11327d15323754bcb2ba682ef5.jpg"><br>  We disassemble the motion sensor, we see inside: <br><img src="https://habrastorage.org/getpro/habr/post_images/e97/724/226/e97724226d2bf79181d50ada76fcae03.jpg"><br>  control board with an infrared receiver and a mirror in the middle and: <br><img src="https://habrastorage.org/getpro/habr/post_images/7b5/e27/468/7b5e274682062f2f9ff93068241577b2.jpg"><br>  BP and relay.  I was lucky, in DD there is everything you need: a relay, a transistor for matching, the rest of the harness (even the diode).  When the sensor is triggered, a TTL signal is issued, it is enough to intercept it, and the signal from my MC is transmitted instead. <br>  In ISIS drew a diagram (if done, then beautifully) <br><div class="spoiler">  <b class="spoiler_title">Scheme</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/bd4/4e3/db8/bd44e3db819c87a9eb20d0a1788ac7a1.png"></div></div><br>  in BASCOM-AVR wrote a program: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text">  $ regfile = "attiny2313.dat" <br>  $ crystal = 4000000 <br>  $ hwstack = 40 <br>  $ swstack = 16 <br>  $ framesize = 32 <br><br>  Config Porta = Output <br>  Config Portb = Output <br>  Config Portd = Output <br>  Config Portd.2 = Input <br>  Config Portd.3 = Input <br>  Config Int0 = Rising <br>  Config Int1 = Change <br>  Enable Interrupts <br>  Enable Int0 <br>  Enable Int1 <br>  Config Debounce = 300 <br>  On Int0 Dd <br>  On Int1 Gerkon <br>  Dim Timecount As Integer <br>  Dim Timelock As Bit <br><br>  Timecount = 0 <br>  Timelock = 0 <br>  Portb.0 = 0 <br>  Portb.1 = 0 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Do <br>  If Timecount &lt;200 Then <br>  Portb.0 = 1 <br>  Else <br>  Portb.0 = 0 <br>  End if <br>  If Timelock = 0 Then <br>  Timecount = Timecount + 1 <br>  End if <br>  If Timecount&gt; 250 Then <br>  Timecount = 250 <br>  End if <br>  Waitms 100 <br>  Loop <br><br>  Dd: <br>  Disable interrupts <br>  Timecount = 0 <br>  If Pind.3 = 1 Then <br>  Timelock = 1 <br>  End if <br>  Enable Interrupts <br>  Return <br><br>  Gerkon: <br>  Disable interrupts <br>  Timecount = 0 <br>  If Pind.4 = 0 Then <br>  Timelock = 0 <br>  End if <br>  Enable Interrupts <br>  Return <br></div></div><br>  Made emulation, it seems like everything works (after debugging, of course).  I collected the layout and checked it (it‚Äôs not so difficult to assemble such layouts, the main thing is to start): <br><img src="https://habrastorage.org/getpro/habr/post_images/636/007/758/636007758e4a6009ee1951145d1d7bad.jpg"><br>  We cut the roads in DD and connect them according to the <s>inflamed imagination of the</s> concept: <br><img src="https://habrastorage.org/getpro/habr/post_images/9c0/586/e83/9c0586e8320a1a21b4b59eb3b71d4bc8.jpg"><br>  Checked - earned.  Automatic shutdown after about 1 min 20 sec (not for some reason, it just happened right away, but I was satisfied), the rest of the work is according to a preconceived logic. <br>  Here I will make a retreat.  The fact is that I solder from the time when the transistors MP39 and MP42 were in use.  Soldered and written was a lot.  When the scheme I developed (and especially the program) starts working the first time - I feel discomfort, so rarely does this happen to me.  A couple of hours were killed for testing, I did not find any bugs, I continued to work. <br>  Collected in the working version (LUT was not useful): <br><img src="https://habrastorage.org/getpro/habr/post_images/b0d/281/269/b0d281269614baea56f5bf22410e94dd.png"><br><br>  With the help of scotch tape and someone's mother, all this insulated and secured in the case.  As a result, the received copy does not appear to be different from the original one; even the wiring diagram has not changed (unless a pair of wires was added for the reed switch): <br><img src="https://habrastorage.org/getpro/habr/post_images/c21/b01/0e3/c21b010e3bbb62150cb344180e78eb4c.jpg"><br><br>  The main thing - after each step to check the performance, floated - we know. <br>  Installation and other commonplace miss. <br>  The wife took without enthusiasm and called "garbage" (nonsense, still appreciate - and where to go). <br>  Budget: <br>  - DD - 250 p.  (I did not find cheaper) <br>  - reed switch - 38 p., <br>  - ATTiny2313 - 140 p.  (horse price, but you wanted yesterday). <br><br>  For constructive criticism thanks in advance. </div><p>Source: <a href="https://habr.com/ru/post/215383/">https://habr.com/ru/post/215383/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215369/index.html">TFS Build Sequences</a></li>
<li><a href="../215371/index.html">Pitfalls of technology company</a></li>
<li><a href="../215373/index.html">Make life easier</a></li>
<li><a href="../215375/index.html">StarCraft disassembled and launched on ARM</a></li>
<li><a href="../215381/index.html">How to take back music and video from VC using Chrome browser using its extension</a></li>
<li><a href="../215385/index.html">The prosecutor's office of Surgut is preparing materials to convict a person for 4 years for the purchase of smart watches</a></li>
<li><a href="../215387/index.html">Timekeeping on Mars</a></li>
<li><a href="../215389/index.html">Simple proxy DLL do it yourself</a></li>
<li><a href="../215391/index.html">OpenFOAM in practice</a></li>
<li><a href="../215395/index.html">Accounting expiration dates in warehouses. Variants of implementations</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>