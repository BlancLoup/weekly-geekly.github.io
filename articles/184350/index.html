<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Networks for the smallest. Part Eight BGP and IP SLA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All issues  8. Networks for the smallest. Part Eight BGP and IP SLA 
 7. Networks for the smallest. Part Seven. VPN 
 6. Networks for the smallest. Pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Networks for the smallest. Part Eight BGP and IP SLA</h1><div class="post__text post__text-html js-mediator-article"><div class="spoiler">  <b class="spoiler_title">All issues</b> <div class="spoiler_text">  <a href="http://linkmeup.ru/blog/65.html">8. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/65.html">Part Eight</a>  <a href="http://linkmeup.ru/blog/65.html">BGP and IP SLA</a> <br>  <a href="http://linkmeup.ru/blog/50.html">7. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/50.html">Part Seven.</a>  <a href="http://linkmeup.ru/blog/50.html">VPN</a> <br>  <a href="http://linkmeup.ru/blog/33.html">6. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/33.html">Part six.</a>  <a href="http://linkmeup.ru/blog/33.html">Dynamic routing</a> <br>  <a href="http://linkmeup.ru/blog/16.html">5. Networks for the smallest: Part Five.</a>  <a href="http://linkmeup.ru/blog/16.html">NAT and ACL</a> <br>  <a href="http://linkmeup.ru/blog/15.html">4. Networks for the smallest: Part Four.</a>  <a href="http://linkmeup.ru/blog/15.html">STP</a> <br>  <a href="http://linkmeup.ru/blog/14.html">3. Networks for the smallest: Part Three.</a>  <a href="http://linkmeup.ru/blog/14.html">Static routing</a> <br>  <a href="http://linkmeup.ru/blog/13.html">2. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/13.html">Part two.</a>  <a href="http://linkmeup.ru/blog/13.html">Switching</a> <br>  <a href="http://linkmeup.ru/blog/12.html">1. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/12.html">Part one.</a>  <a href="http://linkmeup.ru/blog/12.html">Connection to the equipment cisco</a> <br>  <a href="http://linkmeup.ru/blog/11.html">0. Networks for the smallest.</a>  <a href="http://linkmeup.ru/blog/11.html">Part zero.</a>  <a href="http://linkmeup.ru/blog/11.html">Planning</a> <br></div></div><br><br>  Until now, we have been cooking in our own juice - VLANs, static routes, OSPF.  They grew smoothly above themselves from green students into strong engineers. <br>  Now we set aside these toys, it's BGP time. <br><br>  Today we <br><ul><li>  We deal with the BGP protocol: types, attributes, principles of operation, configuration </li><li>  Connecting to BGP provider </li><li>  We organize the reservation and load distribution between several links. </li><li>  Consider a backup option without using BGP - IP SLA </li></ul><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/xjEV8I7Aowo%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700253&amp;usg=ALkJrhgECaoklypvggjMxr_PlIpezWssSg" frameborder="0" allowfullscreen=""></iframe><a name="habracut"></a><br>  First, let's refresh the basics of dynamic routing protocols. <br>  There are two types of protocols: IGP (internal to your autonomous system) and EGP (external). <br>  Both those and others rely on one of two algorithms: DV (Distance Vector) and LS (Link State). <br>  Internal we have already <a href="http://habrahabr.ru/post/156695/">considered</a> .  These include ISIS / OSPF / RIP / EIGRP.  They are needed in order to ensure the distribution of routing information <b>within</b> your network. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      EGP represents only one protocol - BGP - Border Gateway Protocol.  It is designed to ensure the transfer of routes between different networks (autonomous systems). <br>  Roughly speaking, the joint between Balagan Telecom and its uplink provider will be precisely organized through BGP. <br>  That is, the application scheme is approximately as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4c0/b55/055/4c0b55055e8c2f088461e6b9cf258739.png"><h1>  Autonomous systems - AS </h1><br>  BGP is inextricably linked with the concept of the Autonomous System (AS - Autonomous System), which has repeatedly met in our cycle. <br>  According to the definition of a wiki, an AS is a system of IP networks and routers managed by one or several operators with a single routing policy with the Internet. <br><br>  To make it a little clearer, you can, for example, imagine that a city is an autonomous system.  And as the two cities are interconnected by highways, so the two AUs communicate with each other BGP.  In addition, within each city has its own road system - IGP. <br><br>  Here is how it looks from a short distance: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4cf/45a/48d/4cf45a48dc9e529b679f9b6433d57739.png"><br><br>  In BGP AS, this is not just some abstract thing for convenience.  This thing is very formalized, there are special windows in the network where you can get an autonomous system number on weekdays from 9 to 6.  The issue of these numbers are engaged in RIR (Regional Internet Reistry) or LIR (Local Internet Registry). <br><br>  In general, <a href="http://ru.wikipedia.org/wiki/IANA">IANA</a> is doing this globally.  But in order not to burst, it delegates its tasks to the RIR - these are regional organizations, each of which is responsible for a certain part of the planet (For Europe and Russia, this is the RIPE NCC) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/379/dad/77a/379dad77ab2bf6071a7a77935c2dfdcd.png"><br><br>  LIR <a href="http://www.ripe.net/lir-services/member-support/info/faqs/faq-joining">can be</a> almost any organization with the necessary documents.  They are needed so that the RIR does not have to strain with requests from such small offices as LinkMiAp. <br><br>  Well, for example, Balagan Telecom could be LIR.  And we took ASN (AC number) from him - 64500, for example.  And he himself has AS 64501. <br><br>  Until 2007, only 16-bit AS numbers were possible, that is, a total of 65536 numbers were available.  0 and 65535 are reserved. <br>  Numbers 64512 to 65534 are for private ASs that are not routed globally ‚Äî something like private IP addresses. <br>  Numbers 64496-64511 - for use in examples and documentation, which we will use. <br><br>  Now it is possible to use 32bit AS numbers.  This transition is much easier than IPv4-&gt; IPv6. <br><br>  Again, you can not talk about autonomous systems without reference to blocks of IP-addresses.  In practice, each AS should be associated with a block of addresses. <br><br><h1>  PI and PA addresses </h1><br><blockquote>  At the time of my professional youth, while reading the contract with our LIR, I laughed at the managers who could not write the IP-address correctly: the word ‚ÄúPI-address‚Äù was encountered in the text. <br>  Thank God it was enough then mind google this question <br></blockquote><br>  In fact, PI is a Provider Independent. <br><br>  In a normal situation, when you connect to the provider, it gives you a range of public addresses - the so-called PA addresses (Provider Aggregatable). <br>  To get them is to spit once, but if you are not an LIR, then when changing providers, you will have to return PA addresses.  Moreover, it is actually allowed to connect to only one provider. <br>  And if you decide to change the provider, the old addresses will go along with it, and the new provider will issue new ones.  So where is the flexibility? <br><br>  From LIR, you can purchase a custom-independent address block (PI) and <b>necessarily an</b> ASN.  In our case, let it be a block 100.0.0.0/23, which we will announce on BGP to our neighbors.  And these addresses are purely ours and we are not afraid of any providers: we didn‚Äôt like one ‚Äî went to another with the preservation of our addresses. <br><br>  Getting PI addresses was never easy.  You need to prepare a lot of documents, justify the need for such a unit, and <a href="http://www.ripe.net/lir-services/resource-management/independent-resources/requesting-independent-resources">so on</a> . <br>  Now with the exhaustion of IPv4, getting big blocks is getting harder.  The RIR no longer issues them, and the LIR distributes the latter. <br><br>  Thus, both AS numbers and PI addresses can be obtained in the same offices. <br><blockquote>  After receiving all this farming, you will need to make more changes to the RIPE database.  The case is troublesome, difficult and have a long time to understand. <br>  <a href="http://subnets.ru/blog/%3Fp%3D24">Here is a</a> brief tutorial on RIPE database objects. <br></blockquote><br>  Suppose that in our case LinkMiAp received a block of addresses 100.0.0.0/23 and AS 64500. Returning to our analogy, we gave the city a name and supplied it with a range of indices. <br><br>  <a href="http://habrahabr.ru/post/55181/">Another article on this topic</a> . <br>  <a href="http://www.ripn.net/nic/IP-reg/FAQ.html">Short FAQ</a> <br><br><h1>  Bgp </h1><br>  So, in order for us from our AS to transfer information about these public addresses to another AS (read on the Internet), BGP is used.  And if you think that Yandex or Microsoft is using some kind of heavenly technology to connect their data centers to the Internet, then you are mistaken - all the same BGP. <br><br>  Now the main question that is always interested in newbies: why BGP, why not take the notorious OSPF or even static? <br><br>  Perhaps the great uncles can explain this in great detail and thoroughly, but we will try to give a superficial understanding. <br><br>  - If we talk about OSPF / IS-IS, then these are Link-State algorithms, which imply (attention!) That every router knows the topology of the <b>entire</b> network.  We imagine millions of routers on the Internet and discard the idea of ‚Äã‚Äãusing Link State for this purpose in general. <br><blockquote>  In general, OSPF for routing between areas is actually a distance vector protocol.  Hypothetically, it would be possible to replace ‚ÄúAS‚Äù with ‚ÄúArea‚Äù in terms of global routing, but OSPF is simply not designed to digest such volumes of routing information, and it is impossible to select Area 0 on the Internet. <br></blockquote><br><br>  RIP, EIGRP ... Khe-khe.  Well, everything is clear. <br><br>  - IGP is something intimate and it‚Äôs not worth showing it to every oncoming ISP.  Even without AS, the situation when a client picks up an IGP with a provider is extremely rare (with the exception of L3VPN).  The fact is that IGPs do not have a sufficiently flexible route management system - for LS protocols, it is generally known to know <i>all or nothing</i> (again, you can filter on the border of the zone, but there is no flexibility). <br>  As a result, it turns out that you have to open to someone else's hidden parts of your private network or set up tricky import policies between different IGP processes. <br>  ‚ÄúThere are currently over 450,000 routes on the Internet.  If even OSPF / ISIS could store the entire topology of the Internet, imagine how long the SPF algorithm would take. <br>  Here is a <a href="http://habrahabr.ru/company/yandex/blog/126709/">good example of</a> how dangerous it is to use IGP where something global is being suggested. <br><br>  Therefore, we need our own special protocol for communication between ASs. <br>  Firstly, it must be <b>vector-distant</b> - this is unambiguous.  The router should not calculate the route to each network on the Internet, it only has to choose one of several proposed ones. <br>  Secondly, it must have a very <b>flexible route filtering system</b> .  We must easily determine what to shine neighbors, and what should not be taken out of the hut. <br>  Thirdly, it should be <b>easily scalable</b> , have <b>loops protection</b> and <b>a route priority management system</b> . <br>  Fourth, it must be <b>highly stable</b> .  Since route data will be transmitted through an environment that may not always have guaranteed quality (at least two organizations are responsible for the junction), it is necessary to exclude possible losses of route information. <br>  Well and logical, fifthly, he should understand what an AS is, distinguish one's AS from others. <br><br>  Meet the: <b>BGP</b> . <br><br>  In general, the description of the work of this truly ambitious protocol will be divided into two parts.  And today we consider the fundamental points. <br><br>  BGP is divided into IBGP and EBGP. <br><br>  <b>IBGP is</b> required to transfer BGP routes within a single autonomous system.  Yes, BGP is often launched <b>inside the</b> AS, but we'll talk about it another time. <br>  <b>EBGP</b> is a common BGP between autonomous systems.  On it and stop. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8a0/5fe/608/8a05fe6087750c0264b54ce90c0ed4a3.png"><h2>  Establishing a BGP session and route exchange procedure </h2><br>  Let's take a typical situation when we have a connection to the provider gateway organized directly. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1dc/dab/e94/1dcdabe94715c82c7ccec4182cc74a8e.jpg"><br><br>  The devices between which a BGP session is established are called BGP peers or BGP neighbors. <br><br>  BGP does not automatically detect neighbors ‚Äî each neighbor is configured manually. <br>  The process of establishing neighborhood relations is as follows: <br><br>  <b>I) The</b> initial state of the BGP neighborhood is <b>IDLE</b> .  Nothing happens. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4d3/679/25e/4d367925e712b7aaa232aaff6ea3b68f.png"><br><br>  BGP is at IDLE if there is no route to the BGP neighbor. <br><br>  <b>Ii)</b> To ensure reliability, BGP uses TCP. <br>  This means that theoretically BGP peers can be connected not directly, but, for example, <a href="">like this</a> . <br><br>  But in the case of connecting to the provider, as a rule, a direct connection is taken, so there is always a route to the neighbor, as connected directly. <br><br>  The BGP router (also called BGP speakers / speaker or BGP speakers) listens and sends packets to the 179th TCP port. <br>  When listening, this is a <b>CONNECT</b> state.  In this state, BGP is very short. <br><br>  When sent and waiting for a response from a neighbor - this is the <b>ACTIVE</b> state. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c8c/8e5/a0b/c8c8e5a0b7ad8ebe3bbbfb190228fc90.png"><br><br>  R1 sends TCP SYN to neighbor port 179, initiating a TCP session. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1d6/5bb/c54/1d65bbc542f26233d6efef3dd7be4ab6.png"><br><br>  R2 returns TCP ACK, they say, everything is received, I agree with your TCP SYN. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f28/ef9/251/f28ef925135e56a9bbb06a5669ec36f2.png"><br><br>  R1 also reports that it received a SYN from R2. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e04/8b6/b14/e048b6b1428e815c9dc799ad1cc8f3e7.png"><br><br>  After this, the TCP session is established. <br><br>  In the ACTIVE state, the BGP may hang if <br><ul><li>  no IP connectivity with R2 </li><li>  BGP not running on R2 </li><li>  port 179 closed ACL </li></ul><br>  Here is an example of a failed TCP session establishment.  BGP will be able to ACTIVE, sometimes switching to IDLE and back again. <br>  TCP SYN sent from R1 to R2. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/95a/ec3/dd2/95aec3dd2159f0596d68e570ed4a04c6.png"><br><br>  BGP is not running on R2, and R2 returns an ACK that a SYN is received from R1 and RST, meaning that you need to reset the connection. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f28/c0a/8c7/f28c0a8c7fde5ff6375faf1c13f247f9.png"><br><br>  Periodically, R1 will try to set up a TCP session again. <br><blockquote>  When I was a green boy, I, for the first time setting up BGP peering with a provider, spent half a day searching for a problem.  I really didn‚Äôt know how to configure BGP and was looking for a configuration error, I thought that there were some subtleties for my situation, I already started reading about the community.  But at last a bright thought came to mind - check the ACL at the entrance to the network.  Yes, TCP requests from the provider fell into deny and the session was not established. <br>  Be careful.  Ordinary practice for the provider to hang on all of its external interfaces, sticking into the "world" ACL. <br></blockquote><br><br>  <b>III)</b> After a TCP session is established, BGP speakers begin exchanging <i><b>OPEN</b></i> messages. <br><blockquote>  OPEN is the first type of BGP message.  They are sent only at the very beginning of the BGP session to agree on the parameters. <br></blockquote><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c1d/314/2a8/c1d3142a890bab2f4f43e90ebf6058b1.png"><br><br>  It transmits the protocol version, AS number, Hold Timer and Router ID.  For a BGP session to rise, the following conditions must be met: <br><ul><li>  Protocol versions must be the same.  It is unlikely that it will be different </li><li>  AS numbers in the OPEN message must match the settings on the remote side </li><li>  Router ID must be different </li></ul><br>  Also below you can see if the router supports additional protocol features. <br><br>  After receiving OPEN from R1, R2 sends its OPEN, as well as KEEPALIVE, indicating that OPEN is received from R1 - this is a signal for R1 to move to the next state - Established. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f32/60d/2d5/f3260d2d5c2bc0e279c8de936591ca23.png"><br><br>  Here are examples of inconsistency parameters: <br><br>  <b>a) incorrect AS</b> (AS 300 is configured with AS 300, whereas, as with R1, it is considered that this neighbor is in AS 200): <br><br>  R2 sends normal OPEN <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3e1/a2c/87c/3e1a2c87c770edfd4fea16ce2cd32e43.png"><br><br>  R1 notices that the AS in the message does not match the configured one, and resets the session by sending a <b><i>NOTIFICATION message</i></b> .  They are sent in case of any problems in order to break the session. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8dc/ac6/5e3/8dcac65e37ae8a528f5c463841831534.png"><br><br>  In this case, the following messages appear in the R1 console: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a36/9bd/818/a369bd818e5d0d671d6ecc3d19be62a6.png"><img src="https://habrastorage.org/getpro/habr/post_images/f00/19c/8cf/f0019c8cf66c24c88e445758074e13f4.png">  <b>b) the same Router ID</b> <br>  R2 sends to OPEN Router ID, which is the same as R1 ID: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ccc/f8a/08c/cccf8a08c70e4be271063a1a67877cc4.png"><br><br>  R1 returns NOTIFICATION supposedly swollen ?! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e0e/fa6/5ea/e0efa65ea1efe9f51d88ffbd59a37f62.png"><br><br>  In this case, the console will have the following message plan: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/742/5f6/4f1/7425f64f1284819b5c0f056fa928d88a.png"><img src="https://habrastorage.org/getpro/habr/post_images/041/3c2/67c/0413c267c61915dddc70e7f5baf1c325.png"><br><br>  After such errors, BGP goes to IDLE first, and then to ACTIVE, trying to re-establish a TCP session and then exchange OPEN messages again, what if something has changed? <br>  When an Open message is sent, this is the <b>OPEN SENT</b> state. <br>  When it is received - this is <b>OPEN CONFIRM</b> . <br><br><blockquote>  If Hold Timer is different, then the smallest will be selected.  Since the Keepalive Timer is not transmitted in the OPEN message, it will be automatically calculated (Hold Timer / 3).  That is keepalive may vary on neighbors <br>  Here's an example: on R2, the timers are configured like this: Keepalive 30, Hold 170. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/97f/42f/e9b/97f42fe9b98a0c3bfb32679e5183997f.png"><br><br>  R2 sends these parameters in an OPEN message.  R1 gets it and compares: the resulting value is 170, its 180. Choose the smaller one - 170 and calculate the Keepalive timer: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4e2/598/5f5/4e25985f5aa7dfc505bd09b478ac87b6.png"><br><br>  This means that R2 will keep its keepalives every 30 seconds, and R1 - 56. But the main thing is that they have the same Hold Timer, and none of them will terminate the session ahead of time. <br></blockquote><br><br>  It is almost impossible to see the status of OPENSENT or OPENCONFIRM - BGP does not linger on them. <br><br>  <b>Iv)</b> After all these steps, they become stable in <b>ESTABLISHED</b> . <br>  This means that the correct version of BGP is running and all settings are consistent. <br><br>  For each neighbor, you can watch Uptime - how long is it in the ESTABLISHED state. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/224/aa0/f96/224aa0f96f14f61577cc54021ec65f49.png">  <b>V)</b> In the first moments after setting up a BGP session in the BGP table, only information about local routes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9e8/3e0/0d9/9e83e00d96943a4d793a4fbdb3e59e6c.png"><br><br>  You can proceed to the exchange of route information. <br>  <i><b>UPDATE</b></i> messages are used for this. <br><blockquote>  Each UPDATE message can carry information about <b>one</b> new route or about deleting a group of old ones.  And at the same time. <br></blockquote><br><br><img src="https://habrastorage.org/getpro/habr/post_images/29c/69a/39f/29c69a39f26efbf19a81ec72f966afda.png"><br><br>  Let us examine them in more detail. <br>  R1 sends routing information to R2. <br>  The first plus sign in the UPDATE message is the path attributes.  We will look at them in detail later, but you should already understand two of them.  <i>AS_PATH</i> means that the route came from AS with the number 100. <br>  NEXT_HOP - which is logical, information for R2, what to specify as a gateway for this route.  Theoretically, this may not necessarily be the address R1. <br><br>  The <i>ORIGIN</i> attribute reports the origin of the route: <br><ul><li>  <b>IGP</b> - manually set with the network command or received via BGP !!!!!!!!!!!!!!!! </li><li>  <b>EGP</b> - this code you will never meet, means that the route is derived from the obsolete protocol, which was called ‚ÄúEGP‚Äù, and was completely replaced by BGP </li><li>  <b>Incomplete</b> - most often means that the route is obtained through redistribution </li></ul><br><br>  The second plus sign is the route information itself - NLRI - Network Layer Reachability Information.  Actually, our network 100.0.0.0/23 is here indicated. <br><br>  Well, UPDATE from R2 to R1. <br><img src="https://habrastorage.org/getpro/habr/post_images/fc1/6ec/99c/fc16ec99c4fddb4d8bee30713f16bdbb.png"><br><br>  The following KEEPALIVIE is a kind of confirmation that the information has been received. <br><br>  Network information now appears in the BGP table: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/22f/991/511/22f9915112d052163b9fe6e91bca2b6c.png"><br><br>  And in the routing table: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1fa/36a/2de/1fa36a2de4731ffa637be43ec9928801.png"><br><br>  UPDATE is transmitted for every change in the network for as long as the BGP session lasts.  Note that there are no synchronization of the routing tables, in contrast to any OSPF.  That would be technically stupid - a complete table of BGP routes weighs several tens of megabytes on each neighbor. <br><br>  <b>VI)</b> Now that everything is fine, each BGP router will regularly send <b>KEEPALIVE messages</b> .  As in any other protocol, this means: "I am still alive."  This happens when the keepalive timer expires - the default is 60 seconds. <br><blockquote>  If the BGP session is established normally, but then it breaks and it repeats with a certain periodicity - a sure sign that keepalive does not pass.  Most likely, the cycle period is 3 minutes (the default HOLD timer).  Look for the problem on L2.  For example, it may be poor communication quality, overload on the interface or CRC errors. <br></blockquote><br><br>  Another type of BGP message - <b><a href="http://jaluther.blogspot.ru/2012/04/bgp-route-refresh-capability.html">ROUTE REFRESH</a></b> - allows you to request from your neighbors all routes again without restarting the BGP process. <br><br>  <a href="http://www.freesoft.org/CIE/RFC/1771/9.htm">Read more</a> about all types of BGP messages. <br><br>  The full <a href="https://en.wikipedia.org/wiki/Finite-state_machine">FSM</a> ( <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25B2%25D1%2582%25D0%25BE%25D0%25BC%25D0%25B0%25D1%2582">state machine</a> ) for BGP looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/442/780/549/442780549c2f45cdda10773121b2800d.png"><img src="https://habrastorage.org/storage2/cf6/d8d/248/cf6d8d248695d2ced39ba70ebff5f3f9.gif">  <i>Found in the network a detailed <a href="http://ts71.org.ua/wp-content/uploads/2010/11/%25D0%259B%25D0%25B5%25D0%25BA%25D1%2586%25D0%25B8%25D1%258F-21.-%25D0%25A0%25D0%25B0%25D1%2581%25D1%2588%25D0%25B8%25D1%2580%25D0%25B5%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5-%25D0%25BA%25D0%25BE%25D0%25BD%25D1%2584%25D0%25B8%25D0%25B3%25D1%2583%25D1%2580%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5-%25D0%25BF%25D1%2580%25D0%25BE%25D1%2582%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25BB%25D0%25B0-BGP.doc">description of</a> each step.</i> <br><br>  <b>Backfill question:</b> Suppose that the Uptime BGP session is 24 hours.  What messages are guaranteed not passed between neighbors last 12 hours? <br><br>  Now let's expand our horizons to this network: <br>  Pictures without subnets <br><img src="https://habrastorage.org/getpro/habr/post_images/fd0/6f1/123/fd06f11239704b83acb288eb47b4a233.png"><br><br>  And let's see what the BGP route table on R1 is: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d2a/700/7d1/d2a7007d1f1eec74aaba2f16bb3ff5e8.png"><br><br>  As you can see, the route is not only NextHop or just a list of devices to the desired subnet.  This is an AS list.  Otherwise, it is called AS-Path. <br>  That is, to get into the network 123.0.0.0/24 we have to send the packet out, overcome AS 200 and AS 300. <br><br>  AS-path is formed as follows: <br>  a) while the route is walking inside the AS, the list is empty.  All routers understand that the received route is from the same AS. <br>  b) As soon as the router announces a route to its external neighbor, it adds its AS number to the AS-path list. <br><img src="https://habrastorage.org/getpro/habr/post_images/f8e/fac/4e0/f8efac4e05a28a5e1257ebd403c6cc05.png"><br><br>  c) inside the neighboring AS, the list does not change and contains only the number of the original AS <br>  d) when the route is transferred further from the neighbor AS to the top of the list, the current AS number is added. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cda/a4d/42f/cdaa4d42fd56904a5f158d19756e95b7.png"><br><br>  And so on.  When a route is transmitted to an external neighbor, the AS number is always added to the top of the AS-path list.  That is actually a stack. <br><br>  The AS-path is needed not just for the R1 router to know the path to the destination network - after all, essentially Next Hop is enough - each router still takes a decision based on the routing table.  In fact, there are two more important goals: <br>  1) Prevent routing loops.  There should be no duplicate numbers in AS-Path <br><blockquote>  In fact, the ASN can be repeated in the AS-Path in two cases. <br>  a) When you use AS-Path Prepend, which is described below. <br>  b) When you want to connect two pieces of one AS that do not have a direct connection with each other. <br></blockquote><br>  2) Choosing the best route.  The shorter the AS-Path, the more preferable the route, but more on that <a href="https://habr.com/ru/post/184350/">later.</a> <br><br><h1>  BGP setup and practice </h1><br>  In this issue, we mix theory with practice, because it will be the easiest to understand.  Actually now we turn to our network LinkMiAp. <br>  As usual, cut off all unnecessary and add the necessary: <br><img src="https://habrastorage.org/getpro/habr/post_images/bc6/42a/4e5/bc642a4e5e47733bc8da790eccd980dc.png"><br><br>  Below is our main msk-arbat-gw1 router.  To simplify the settings and understanding, we will abandon all the old settings and free interfaces. <br><br>  Above are two of our old providers - Balagan Telecom and Filkin Certificate. <br><br>  Of course, each provider has its own AS.  We have added another dead-end AS - before it and we will check, let it be, for example, a data center on the Internet. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For simplicity, we assume that each AS is represented by only one router, no ACLs, no intermediate devices. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We are raising a BGP session with both providers. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The following information is important to us: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) Our AS number and block of IP addresses. We have already received them: AS64500 and block: 100.0.0.0/23. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) AS ‚ÄúBalagan Telecom‚Äù number and link subnet with it. AS64501 and link network: 101.0.0.0/30. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3) AS "Filkin Certificate" and link subnet with it. AS64502 and link network: 102.0.0.0/30.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When connecting via BGP, the public addresses with a subnet mask / 30 are usually used as link addresses, and the superior provider issues them to us. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is done for the simple reason that your traffic everywhere goes to public addresses and in the middle of the trace does not appear every 10.H.H.H. </font><font style="vertical-align: inherit;">Not that this is something forbidden, but usually still adhere to this rule.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/67f/05c/214/67f05c214a17e41a157ddffa14e0b0ae.png"><br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's start with the banal. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interface configuration:</font></font><br><pre><script type="text/javascript">function gtElInit() {var lib = new google.translate.TranslateService();lib.translatePage('ru', 'en', function () {});}</script><script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=gtElInit&amp;client=wt"></script><code class="hljs lua">msk-arbat-gw1 R1(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>)#int fa0/<span class="hljs-number"><span class="hljs-number">0</span></span> R1(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#ip address <span class="hljs-number"><span class="hljs-number">101.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> R1(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#no shutdown R1(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>)#int fa0/<span class="hljs-number"><span class="hljs-number">1</span></span> R1(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#ip address <span class="hljs-number"><span class="hljs-number">102.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> R1(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>)#no shutdown</code> </pre> <img src="https://habrastorage.org/getpro/habr/post_images/5d4/e4c/d78/5d4e4cd78bf56c4e0b60fe5f9778369a.png"><img src="https://habrastorage.org/getpro/habr/post_images/8e9/b81/b2c/8e9b81b2c510ac124bba4ab8aebaa812.png"><br><br>  Now let's assign some address to the Loopback interface, then check the connectivity: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">R1</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#int</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loopback</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">R1</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-if</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 100<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span></code> </pre><br><br>  BGP turn.  Here we will focus on each line. <br><pre> <code class="hljs lisp">R1(<span class="hljs-name"><span class="hljs-name">config</span></span>)#router bgp <span class="hljs-number"><span class="hljs-number">64500</span></span></code> </pre><br><br>  First we start the BGP process and specify the AS number.  That is the number that issued the LIR.  This is not OSPF for you - liberties are not allowed. <br><br>  Now raise the peering. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">R1</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-router</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#neighbor</span></span> 101<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">remote-as</span></span> 64501</code> </pre><br><br>  With the neighbor command, we specify with whom to establish the session.  The router will send TCP-SYN first, and then OPEN to the address 101.0.0.1.  We must also indicate the number of the remote Autonomous System - 64501. <br><br>  The configuration on the reverse side is symmetrical: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">R2</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#router</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bgp</span></span> 64501 <span class="hljs-selector-tag"><span class="hljs-selector-tag">R2</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-router</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#neighbor</span></span> 101<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">remote-as</span></span> 64500</code> </pre><br><br>  Already on one message <br><pre> <code class="hljs css">*<span class="hljs-selector-tag"><span class="hljs-selector-tag">Mar</span></span> 1 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:11</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:12.203</span></span>: %<span class="hljs-selector-tag"><span class="hljs-selector-tag">BGP-5-ADJCHANGE</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 101<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Up</span></span></code> </pre> <br><br>  it can be judged that the BGP has risen, but let's check its condition: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f97/a7e/559/f97a7e559b486564aa508342464b485b.png"><br><br>  Here they ran through all the states and now their status is Established. <br>  Our router received and sent one OPEN one at a time and during this time managed to send and receive 2 KEEPALIVE. <br><br>  With the command <b>sh ip bgp</b> you can see which networks are known to BGP: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/84e/1fc/b4c/84e1fcb4c9e157d32e8a05c4f3043899.png"><br><br>  Is empty.  It is necessary to indicate that we have this grid here 100.0.0.0/23 and transfer it to providers? <br><br>  There are three options for this: <br>  - define network with network command <br>  - import from another source (direct, static, IGP) <br>  - create an aggregated route using the aggregate-address command <br><br>  Looking ahead, we note that the network has a higher priority, and with the import you need to be careful not to grab the surplus. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">R1</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#router</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bgp</span></span> 64500 <span class="hljs-selector-tag"><span class="hljs-selector-tag">R1</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-router</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#network</span></span> 100<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mask</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.254</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span></code> </pre><br><br>  See if our network appeared in the table: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/84e/1fc/b4c/84e1fcb4c9e157d32e8a05c4f3043899.png"><br><br>  Strange, but no, nothing appeared.  On R2 too. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/76b/3fd/b7c/76b3fdb7c8daba1e66fc2e97bf4380e7.png"><br><br>  But the point here is that the exact <b>network</b> has to be in the network that you registered with the <b>network</b> command, otherwise it will not be added to the BGP table - this is a mandatory condition.  Of course, there is no such route.  Where did he come from: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a6a/ce2/211/a6ace22116bd98af3b559381da7e4fec.png"><br><br>  Since we really have nowhere to register such a route - except for one Loopback interface, nowhere is this network anywhere, we can do the following: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">R1</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 100<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.254</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Null</span></span> 0</code> </pre><br><br>  This route indicates that all packets in this subnet will be dropped.  But do not worry, normal work will not be disrupted.  If you have more accurate routes (with a mask greater than / 23, for example, / 24, / 30, / 32), then they will be preferable according to the Longest Prefix Match rule. <br><br>  And now in the BGP table there is our local route: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/72c/1db/cf0/72c1dbcf0eca686d1490f17d48c2f65a.png"><br><br>  If you configure BGP and the necessary routes on all devices of our scheme, then the BGP and routing tables on our border (border - router on the edge of the network) will look like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4b3/6b0/e15/4b36b0e1531894f7ed360e932ce95241.png"><img src="https://habrastorage.org/getpro/habr/post_images/2de/8c2/d70/2de8c2d70cb64dfb4fb8a80d0f8a3a96.png"><br><br>  Note that there are 2 routes to some networks in the BGP table, and only one in the routing table.  The router selects the best of all and only transfers it to the routing table.  We will talk about this <a href="https://habr.com/ru/post/184350/">later</a> . <br>  This is a necessary minimum, after which there will already be a little happiness. <br><br>  ===================== <br> <a href="http://linkmeup.ru/blog/55.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"></a>  <a href="http://linkmeup.ru/blog/55.html"><b>Problem number 1</b></a> <br><br>  Scheme: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ec4/9ee/503/ec49ee503f6af0053a0f6aa9d7582f70.jpg"><br><br>  Condition: <br>  Router settings are irrelevant.  No route filters are configured.  Why on one of the neighbors there is no alternative route to the network 195.12.0.0/16 through AS400? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ea3/182/ebd/ea3182ebd6c320fe1c08e6e803201490.jpg"><br><br>  Details of the task on the <a href="http://linkmeup.ru/blog/55.html">site</a> <br>  ===================== <br><br><h1>  Full View and Default Route </h1><br>  Speaking of BGP and connecting to providers, one can not touch on this topic.  When LinkMiAp, having already AS and PI-addresses, will make a joint with Balagan Telecom, one of the first questions from them will be: ‚ÄúFull view or Default?‚Äù.  The main thing is not to get confused and not to blink nonsense. <br><br>  What you have seen so far is the so-called Full View - the router studies <b>absolutely all the</b> routes of the Internet, even if in our case it‚Äôs five or six pieces.  In reality, there are now more than 400,000 of them. Accordingly, you will receive 400k routes from one provider, the same from the second.  Sometimes there is a third backup - plus another 400k.  Total more than a million. <br>  Well, not to buy now a little underinterpreting a tsiska of the senior series just for this? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a33/5ee/9f9/a335ee9f9c24ec1e564978c4cc54bf18.png">  <i>* output of the routing table from one of the public servers (accessible via telnet route-server.ip.att.net)</i> <br><br>  In fact, not everyone who has AS, needs Full View.  Usually for such companies as ours, it is quite enough for Default Route, by names it‚Äôs quite clear how they differ.  In the latter case, there is only one default route from each provider, instead of hundreds of thousands of specific ones (although, in general, it may be together). <br><br>  Let me give a small argument for both. <br><ul><li>  <b>Full View</b> .  You have a complete knowledge of the structure of the Internet.  To any Internet address, you can view the path from yourself: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ee6/46a/d3c/ee646ad3c4456b554e3075ee722267f6.png"><br><br>  You know what AS leads to it.  Through the <a href="https://stat.ripe.net/13238">RIPE</a> website you can see which providers provide transit.  You follow all the changes.  If suddenly someone drops something through the first link (not even from you or the provider, but somewhere else, further on), BGP will track this and rebuild its routing table to transfer data through the second provider. <br>  At the same time, you can manage routes very flexibly, interfering with the standard procedure for choosing the best path. <br>  For example, you will start all traffic on Yandex through Balagan Telecom, and on Google through Filkin Certificate.  This is called <b>load distribution</b> . <br>  This is achieved by configuring, for example, route priorities for certain prefixes. <br><br>  Full View is required if your speaker system is transit, that is, you are going to connect other clients to yourself via BGP. <br>  You have to pay for all these advantages with performance: high utilization of RAM and a very long study of routing information after establishing a BGP session.  For example, after a link with a higher provider is jerked, a full recovery may take several minutes. <br></li><li>  <b>Default route</b> <br>  Well, first of all, this, of course, greatly saves the resources of your equipment. <br>  Secondly, easier to maintain, it can be said.  No need to drive hundreds of thousands of routes throughout your AS. <br>  Thirdly, there is no idea about the status of the Internet and the real availability of recipients - you just blindly trust in the default received from upstream.  That is, in the event of a problem above, you will not know about it and some services may fall.  But here we hope that the higher-level providers have a higher network reliability and we have nothing to worry about. <br><br>  Balancing and distribution of incoming traffic when receiving the default route is not affected in any way - the problems are the same.  But with the outgoing, of course, everything is a little different, the former flexibility will not be here. <br></li></ul><br><br>  In general, very rude advice will sound like this: <br>  If you are not going to organize transit through yourself (connect customers with your speakers) and there is no need for a fine distribution of outgoing traffic, then you will have enough Default Route. <br><br>  But it certainly does not make sense to receive from one provider Full View, and from another Default - in this case, one link will always be idle for outgoing traffic, because the router will choose a more specific path. <br><br>  In this case, from all providers, you can take Default plus certain prefixes (for example, it is this provider).  Thus, to the necessary resources you will have specific routes without Full View. <br><br>  Here is an example of setting the Default Route transmission to a downstream router: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">balagan-router</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-router</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#neighbor</span></span> 101<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">default-originate</span></span></code> </pre><br>  And this is how the route table on our border looks after this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b30/04e/081/b3004e0815b35908d39aa6317426be81.png"><br><br>  That is, in addition to the normal routes (Full View), the default route is also transmitted. <br><br><blockquote>  Now you should start to guess that the Default Route is not the opposite of Full View.  It is not necessarily worth ‚Äúeither one or the other‚Äù (one should introduce the concept of healers or xyls, like the English XOR), you can easily use the Default Route in addition to the Full View or Default Route and some of some other routes. <br></blockquote><br><br>  ===================== <br> <a href="http://linkmeup.ru/blog/56.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"></a>  <a href="http://linkmeup.ru/blog/56.html"><b>Problem number 2</b></a> <br><br>  Scheme: General Network Diagram <br>  The task: <br>  Set up filtering by the provider so that it passes us <b>only the</b> default route and nothing superfluous. <br>  That is, to make the BGP table look like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/0b4/93c/9d4/0b493c9d494bd894fa9bf17d1180d165.png"><br><br>  Details of the task on the <a href="http://linkmeup.ru/blog/56.html">site</a> <br>  ===================== <br><br>  <a href="http://telekomza.ru/2011/02/28/o-polze-i-vrede-polnoj-bgp-tablicy/">The benefits and harms of the complete BGP table</a> <br><br><h1>  Looking Glass and other tools </h1><br>  One of the very powerful tools for working with BGP is Looking Glass.  These are servers located on the Internet that allow you to look at the network from the outside: check availability, view through which AS the path to your autonomous system lies, start tracing to your internal addresses. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/080/c9f/139/080c9f139de638c9fc6d6b92b6a5e06f.png"><img src="https://habrastorage.org/getpro/habr/post_images/407/685/99b/40768599b4283b74caca7535b0bf7915.png"><br><br>  It‚Äôs as if you asked someone to ‚Äúlisten, but see how my announcements are seen there?‚Äù, But you don‚Äôt need to ask anyone. <br><blockquote>  Do not underestimate the power of external tools.  Once I had a problem with a very low rate of return to the outside.  She barely passed for a few megabits.  After a rather lengthy troubling event, I decided to take a look at Looking Glass.  What was my surprise when I discovered that the traffic was coming to me through a VPN channel to a branch in another city, with which IBGP is installed.  Naturally, the width of the channel was small and was utilized almost completely. <br></blockquote><br><br>  There are also special organizations that track BGP announcements on the Internet and, if something unexpected happens, can notify the network owner - <a href="http://www.bgpmon.net/">BGPMon</a> , <a href="http://www.renesys.com/">Renesys</a> , <a href="http://www.routeviews.org/">RouterViews</a> . <br>  Thanks to them, several global accidents were prevented. <br><br>  Using the <a href="http://xgu.ru/wiki/BGPlay">BGPlay</a> service, <a href="http://xgu.ru/wiki/BGPlay">you</a> can visualize route propagation information. <br><br>  On <a href="">nag.ru</a> you can read about the most striking cases when incorrect BGP announcements caused global problems on the Internet, such as ‚ÄúAS 7007 Incident‚Äù and ‚ÄúGoogle's May 2005 Outage‚Äù. <br><br>  Very good <a href="http://nt.ua/aboutcenter/articles/Pages/samoilenko_bgp_2013.aspx">article</a> on a variety of great tools for working with BGP. <br>  <a href="http://www.bgp4.as/looking-glasses">The list of servers Looking Glass</a> . <br><br><h1>  Control Plane and Data Plane </h1><br>  Before plunging into the deep pool of route management, let's make the last lyrical digression.  It is necessary to understand the concepts in the title of the chapter. <br>  At one time, while reading the <a href="http://www.amazon.com/MPLS-Enabled-Applications-Emerging-Developments-Technologies/dp/0470014539">MPLS Enabled Application</a> , I broke my brain on them.  Just could not figure out what the authors are talking about. <br>  So, so that there is no confusion with you. <br>  These are not model levels, environment levels, or data transfer moments ‚Äî this is a very abstract division. <br>  The control level ( <b>Control Plane</b> ) is the work of service protocols providing conditions for data transfer. <br>  For example, when BGP is launched, it runs through all its states, exchanges route information, and so on. <br>  Or, in an MPLS network, LDP distributes labels to prefixes. <br>  Or STP, exchanging BPDUs, builds an L2 topology. <br><br>  These are all examples of Control Plane processes.  That is, it is the preparation of the network for transmission - organization of switching, filling in the routing table. <br><br>  Transmitting level ( <b>Data Plane</b> ) - the actual transfer of useful customer data. <br><br>  It often happens that the data of two levels go in different directions, ‚Äútowards each other‚Äù.  So, BGP routes are sent from AS100 to AS200 so that AS200 can transfer data to AS100. <br><br><img src="https://habrastorage.org/storage2/d7c/9fb/f7d/d7c9fbf7dfcbe6bd3e11c29512f7853a.gif"><br><br>  Moreover, at different levels there may be different paradigms of work.  For example, in MPLS Data Plane is focused on creating a connection, that is, the data there is transmitted along a predetermined path - the LSP. <br>  But this path itself is prepared according to standard IP laws - from host to host. <br><br>  It is important to understand the purpose of levels and what is the difference. <br><br>  For BGP this is a matter of principle.  When you announce your routes, you are actually creating a path for <i>incoming traffic</i> .  That is, routes come from you, and traffic to you. <br><br><a name="Only_Best"></a><h1>  Route selection </h1><br>  The situation with the routes we have this. <br>  There is a BGP table in which absolutely all routes received from neighbors are stored. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b3b/89c/780/b3b89c78046cd714c114fd468fad2e24.png">  <i>That is, if we have several routes to the network 100.0.0.0/23, then all of them will be in the BGP table, regardless of the ‚Äúbadness‚Äù of these:</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/98e/a48/baf/98ea48baf27b85bd476f07da14b4713b.png"><br><br>  And there is a routing table familiar to us, storing only the best of the best.  Likewise, BGP announces not all incoming routes, but only the best ones.  That is, from one neighbor you will never get two routes to one network. <br><br><a name="Route_Selection"></a><br>  So, the criteria for choosing the best: <br><ol><li>  Maximum Weight (local to router, for Cisco only) </li><li>  Maximum value of Local Preference (for the whole AS) </li><li>  Prefer local router route (next hop = 0.0.0.0) </li><li>  The shortest path through autonomous systems.  (shortest AS_PATH) </li><li>  Minimum Origin Code (IGP <br></li><li>  The minimum value of MED (distributed between autonomous systems) </li><li>  EBGP path is better than iBGP path </li><li>  Choose a path through the nearest IGP neighbor <br><br>  If this condition is met, the load is balanced between several equivalent links. <br><br>  The following conditions may vary from vendor to vendor. <br></li><li>  Choose the oldest route for the eBGP path </li><li>  Choose a path through the neighbor with the lowest BGP router ID </li><li>  Choose the path through the neighbor with the smallest IP address </li></ol><br><br>  As you can see, there are a lot of selection criteria.  Moreover, they are quite complex and it is not easy to understand everything on the fly.  Get involved slowly. <br>  We will talk about some of the attributes mentioned below, and specifically on the choice of routes we will focus on a separate article. <br><br>  ===================== <br> <a href="http://linkmeup.ru/blog/57.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"></a>  <a href="http://linkmeup.ru/blog/57.html"><b>Problem number 3</b></a> <br><br>  Scheme: General Network Diagram <br>  Condition: Full View on all routers <br><br>  If you now look at the BGP table on the router of the provider Balagan Telecom, you will see 3 routes to the network 102.0.0.0/21 - the Filkin Certificate network.  And one of the routes leads through our LinkMiAp network. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a9c/e73/e38/a9ce73e38ec4bff8fd946e8265a27fd6.png"><br><br>  This suggests that our border announces other people's routes further, in other words, our AS is a transit one. <br><br>  The task: <br>  Set up filtering so that our AS64500 is no longer transit. <br><br>  Details of the task on the <a href="http://linkmeup.ru/blog/57.html">site</a> <br>  ===================== <br><br><h1>  Route management </h1><br>  Before moving on to the big topic of load sharing with BGP, it‚Äôs just necessary to figure out how we can manage routes in this protocol in general. <br>  It is the ability of such management of routing information exchange that makes BGP so flexible and suitable for interaction between several different providers, unlike any IGP. <br><br>  And we have a lot of tools for this: <br><ul><li>  AS-Path ACL </li><li>  Prefix-list </li><li>  Weight </li><li>  Local Preference </li><li>  MED </li></ul><br><br>  But only the first two of them allow filtering routes that are advertised or accepted, the rest only set priorities. <br><br><h2>  AS-Path ACL </h2><br>  Very powerful, but not the most popular mechanism. <br><br>  Using the AS-Path ACL, you can, for example, prohibit taking announcements of routes belonging to AS 200. Well, you just don‚Äôt want to - let them be known through another provider, but not through it. <br><br>  The most difficult thing in this approach is to remember all regular expressions and learn how to use them.  First, the head of them around: <br><br><table border="1"><tbody><tr><th>  Sign </th><th>  Value </th></tr><tr><td>  . </td><td>  any character including space </td></tr><tr><td>  * </td><td>  zero or more matches with expression </td></tr><tr><td>  + </td><td>  one or more matches with the expression </td></tr><tr><td>  ? </td><td>  zero or one match with expression </td></tr><tr><td>  ^ </td><td>  beginning of line </td></tr><tr><td>  $ </td><td>  end of line </td></tr><tr><td>  _ </td><td>  any separator (including, start, end, space) </td></tr><tr><td>  \ </td><td>  don't take the next character as special </td></tr><tr><td>  [] </td><td>  match one of the characters in the range </td></tr><tr><td>  | </td><td>  logical or </td></tr></tbody></table><br><br>  To make it a little more clear, here are some examples: <br><br>  <b>one</b> <br><table border="1"><tbody><tr><td>  _200_ </td><td>  Routes going through AS 200 </td></tr></tbody></table><br><br>  Before and after the AS number there are ‚Äú_‚Äù signs, meaning that the AS-path number 200 can stand at the beginning, middle or end, as long as it is. <br><br>  <b>2</b> <br><table border="1"><tbody><tr><td>  ^ 200 $ </td><td>  Routes from the neighboring AS 200 </td></tr></tbody></table><br><br>  ‚Äú^‚Äù Means the beginning of the list, and ‚Äú$‚Äù - the end.  That is, in the AS-path there is only one AS number - this means that the route was originated in AS 200 and from there it was immediately transferred to us. <br><br>  <b>3</b> <br><table border="1"><tbody><tr><td>  _200 $ </td><td>  Routes sent from AS 200 </td></tr></tbody></table><br><br>  ‚Äú$‚Äù Means the end of the list, that is, this is the very first AS, the route from it originated, the ‚Äú_‚Äù sign says that it does not matter what is next, at least nothing, at least 7 other AS. <br><br>  <b>four</b> <br><table border="1"><tbody><tr><td>  ^ 200_ </td><td>  Networks behind AS 200 </td></tr></tbody></table><br><br>  The ‚Äú^‚Äù sign means that the ASN 200 was last added, that is, the route came to us from AS 200, but this does not mean that he was born in it - the ‚Äú_‚Äù sign indicates that this may be the end of the list, and maybe a space before the next AS. <br><br>  <b>five</b> <br><table border="1"><tbody><tr><td>  ^ $ </td><td>  Local AS Routes </td></tr></tbody></table><br><br>  The AS-path list is empty, so the route is local, generated inside our AS. <br><br><h3>  Example </h3><br>  Here in our network we will filter the routes that originated in AS 64501. That is, we will receive all Internet routes from our neighbor 101.0.0.1, but we will not receive their local ones. <br><br><pre> <code class="hljs pgsql">ip <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-<span class="hljs-type"><span class="hljs-type">path</span></span> <span class="hljs-keyword"><span class="hljs-keyword">access</span></span>-list <span class="hljs-number"><span class="hljs-number">100</span></span> deny ^<span class="hljs-number"><span class="hljs-number">64501</span></span>$ ip <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-<span class="hljs-type"><span class="hljs-type">path</span></span> <span class="hljs-keyword"><span class="hljs-keyword">access</span></span>-list <span class="hljs-number"><span class="hljs-number">100</span></span> permit .* router bgp <span class="hljs-number"><span class="hljs-number">64500</span></span> neighbor <span class="hljs-number"><span class="hljs-number">101.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>-list <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span></code> </pre><img src="https://habrastorage.org/getpro/habr/post_images/4a4/77a/3dc/4a477a3dca84ff5207ac2dbada6f9a04.png">  <a href="https://docs.google.com/document/d/1IBQaTWj8u-NoJ0ecsh9vC9EHpYRoT5AWxCpPgaV8Nps/edit%3Fusp%3Dsharing%250A">Device configuration</a> <br><br>  <a href="http://img.nag.ru/projects/setup/bd7/83a2a1b381320918ced29331a0dfd53b.pdf">Instructions for using regular expressions</a> <br><br><h2>  Prefix-list </h2><br>  Everything is simple and logical.  Almost. <br><br>  The prefix lists are simply the network / mask we are used to, and we specify to allow such routes or not. <br><br>  Command syntax: <br><pre> <code class="hljs perl">ip prefix-list {list-name} [se<span class="hljs-string"><span class="hljs-string">q {value}</span></span>] {deny|permit} {network/<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>} [ge <span class="hljs-string"><span class="hljs-string">{value}</span></span>] [le <span class="hljs-string"><span class="hljs-string">{value}</span></span>]</code> </pre>  <b>list-name</b> - the name of the list.  Your co.  Usually specified as <i>name_in</i> or <i>name_out</i> .  This <b>prompts</b> us to incoming or outgoing routes will act (but, of course, at this stage does not determine). <br>  <b>seq</b> - the ordinal number of the rule (as in the ACL) to make it easier to operate with them. <br>  <b>deny / permit</b> - determine whether to allow such a route or not <br>  <b>network / length</b> - the usual record for us, like, 192.168.14.0/24. <br>  But further, attention is more complicated - two more parameters are possible: <b>ge</b> and <b>le</b> .  As with the configuration of NAT (or in the FORP), this means " <b>g</b> reater or <b>e</b> qual" and " <b>l</b> ess or <b>e</b> qual". <br>  That is, you can specify not only one specific prefix, but also their range. <br><br>  For example, such a record <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ip</span></span> prefix-list NetDay permit <span class="hljs-number"><span class="hljs-number">10.0.0.0</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span> ge <span class="hljs-number"><span class="hljs-number">10</span></span> le <span class="hljs-number"><span class="hljs-number">16</span></span></code> </pre><br>  will mean that the following routes will be chosen. <br><br>  10.0.0.0/10, 10.0.0.0/11, 10.0.0.0/12, 10.0.0.0/13, 10.0.0.0/14, 10.0.0.0/15, 10.0.0.0/16 <br><br><h3>  Example </h3><br>  Now we will forbid accepting the announcement of the network 120.0.0.0/24 through the provider of the Filkin Certificate, and allow all others.  A record of <i>0.0.0.0/0 le 32</i> means any subnets with any mask length (less <i>than</i> or equal to 32 (0-32)). <br><br><pre> <code class="hljs swift">ip <span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>-list <span class="hljs-type"><span class="hljs-type">TEST_PL_IN</span></span> seq <span class="hljs-number"><span class="hljs-number">5</span></span> deny <span class="hljs-number"><span class="hljs-number">120.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> ip <span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>-list <span class="hljs-type"><span class="hljs-type">TEST_PL_IN</span></span> seq <span class="hljs-number"><span class="hljs-number">10</span></span> permit <span class="hljs-number"><span class="hljs-number">0.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> le <span class="hljs-number"><span class="hljs-number">32</span></span> router bgp <span class="hljs-number"><span class="hljs-number">64500</span></span> neighbor <span class="hljs-number"><span class="hljs-number">102.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>-list <span class="hljs-type"><span class="hljs-type">TEST_PL_IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span></code> </pre><img src="https://habrastorage.org/getpro/habr/post_images/14b/921/7e3/14b9217e34043b366d2c669a3202f220.png"><blockquote>  Let's make a reservation just in case: the last example does not mean that the neighboring provider will not transfer them to you - of course it will, because it knows nothing about your policies - but your router, having received such an announcement, will not add a route to its BGP - table. <br></blockquote><br><br>  <a href="https://docs.google.com/document/d/1EXKvsrapWcM3e1pfFwqs_kF08v00TY49_eN-R69GfAw/edit%3Fusp%3Dsharing">Device configuration</a> <br><br><h2>  Route map </h2><br>  Until now, all the rules were applied unconditionally - for all announcements from a feast or feast. <br>  With the help of route maps (for other vendors, they may be called routing policies) we can apply the rules very flexibly, differentiating the announcements. <br><br>  The command syntax is as follows: <br><pre> <code class="hljs mel">route-map {map_name} {permit|deny} {seq} [<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">expression</span></span>}] [set {<span class="hljs-keyword"><span class="hljs-keyword">expression</span></span>}]</code> </pre>  <b>map_name</b> - map name <br>  <b>permit / deny</b> - allow or not the passage of data falling under the route-map conditions <br>  <b>seq</b> - rule number in route-map <br>  <b>match</b> - condition of traffic falling under this rule. <br><br>  <b>expression</b> : <br><table border="1"><tbody><tr><th>  Criterion </th><th>  Configuration command </th></tr><tr><td>  Network / mask </td><td>  match ip address prefix-list </td></tr><tr><td>  AS-path </td><td>  match as-path </td></tr><tr><td>  BGP community </td><td>  match community </td></tr><tr><td>  Route originator </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> match ip route-source </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> BGP next-hop address </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> match ip next-hop </font></font></td></tr></tbody></table><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - what to do with filtered </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">expression</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> routes </font><font style="vertical-align: inherit;">:</font></font><br><table border="1"><tbody><tr><th>  Options </th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configuration command </font></font></th></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> AS path prepend </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> set as-path prepend </font></font></td></tr><tr><td>  Weight </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> set weight </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Local Preference </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> set local-preference </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> BGP community </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> set community </font></font></td></tr><tr><td>  MED </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> set metric </font></font></td></tr><tr><td>  Origin </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> set origin </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bgp next-hop </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> set next-hop </font></font></td></tr></tbody></table><br><a name="Local_Preference"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Application example </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We indicate that it is preferable to go to the 120.0.0.0/24 subnet through the Filkin Certificate, and to 103.0.0.0/22 ‚Äã‚Äãthrough the Balagan Telecom. To do this, use the attribute Local Preference. The higher the value of this parameter, the higher the priority of the route.</font></font><br><br><pre> <code class="hljs sql">ip prefix-list TEST1_IN seq 5 permit 120.0.0.0/24 ip prefix-list TEST2_IN seq 5 permit 103.0.0.0/22 route-map BGP1_IN permit 10 match ip address prefix-list TEST1_IN <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span>-preference <span class="hljs-number"><span class="hljs-number">50</span></span> route-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span> BGP1_IN permit <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span>-preference <span class="hljs-number"><span class="hljs-number">100</span></span> route-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span> BGP2_IN permit <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> ip address prefix-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> TEST2_IN <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span>-preference <span class="hljs-number"><span class="hljs-number">50</span></span> route-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span> BGP2_IN permit <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span>-preference <span class="hljs-number"><span class="hljs-number">100</span></span> router bgp <span class="hljs-number"><span class="hljs-number">64500</span></span> neighbor <span class="hljs-number"><span class="hljs-number">101.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> route-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span> BGP2_IN <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> neighbor <span class="hljs-number"><span class="hljs-number">102.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> route-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span> BGP1_IN <span class="hljs-keyword"><span class="hljs-keyword">in</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, we created in the usual way the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prefix-list</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which was allocated the 120.0.0.0/24 subnet. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> means that route-map rules will be applied to this prefix in the future. As with ordinary ACLs, there is an implicit deny rule for everything else. In this case, it means that only 120.0.0.0/24 and nothing else will fall under the route-map action. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the BGP1_IN route map we created, we allowed the passage of route information ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) falling under the created prefix-list ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">match ip address prefix-list TEST1_IN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For these announcements, set the local preference to 50 - lower than the standard 100 ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set local-prefernce 50</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). That is, they will be less "interesting."</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And in the end, we will bind the map to a specific BGP neighbor ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neighbor 102.0.0.1 route-map BGP1_IN in</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is the result? </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e16/90b/d81/e1690bd81018cdef3634a18dea0b0ae1.png"> <a href="https://docs.google.com/document/d/12xNI1OWSEVB6WRQF2nurKgun71z5JHOE8BJQESAMI8A/edit%3Fusp%3Dsharing"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Device Configuration</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Other examples will be discussed in the next section. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">===================== </font></font><br> <a href="http://linkmeup.ru/blog/58.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task number 4</font></font></b></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Scheme: General network diagram </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Condition: LinkMiAp receives Full View from both providers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Subject: Troubleshooting. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From providers: complete BGP route table</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the msk-arbat-gw1 router, the distribution of outgoing traffic between providers of Balagan Telecom and Filkin Certificate is configured. </font><font style="vertical-align: inherit;">The traffic going to the network of the provider of the Filkin Certificate must go through it if it is available. </font><font style="vertical-align: inherit;">The rest of the outgoing traffic must be transmitted through the provider Balagan Telecom, when it is available. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When checking outgoing traffic, it turned out that when Balagan Telecom disconnects, outgoing traffic to the data center (103.0.0.1) does not go through the Filkin Certificate.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration:</font></font></b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> neighbor <span class="hljs-number"><span class="hljs-number">102.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> route-map OUTBOUND <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> auto-<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span> ! route-map OUTBOUND permit <span class="hljs-number"><span class="hljs-number">10</span></span> match <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-<span class="hljs-type"><span class="hljs-type">path</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> weight <span class="hljs-number"><span class="hljs-number">1000</span></span> ! ip prefix-list LAN permit <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">23</span></span> ! ip <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-<span class="hljs-type"><span class="hljs-type">path</span></span> <span class="hljs-keyword"><span class="hljs-keyword">access</span></span>-list <span class="hljs-number"><span class="hljs-number">10</span></span> permit ^<span class="hljs-number"><span class="hljs-number">64502</span></span>$ ! ip route <span class="hljs-number"><span class="hljs-number">100.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Null0</code> </pre></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The rest of the configuration is standard. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Correct the settings so that the outgoing traffic on the ISP2 network of the provider, to its client and to the network of the remote office of the company, goes through the ISP2 provider. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Details of the tasks on the </font></font><a href="http://linkmeup.ru/blog/58.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> =====================</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Balancing and load balancing </font></font></h1><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúAnd how do you know how to balance traffic in BGP?‚Äù</font></font></i> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This is a question that people like to ask during interviews. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Starting to prepare for this article, I had a conversation with our Natasha, from whom it became clear that in BGP, balancing and distribution are two big differences.</font></font><br><blockquote> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><a href="http://wiki.answers.com/Q/Difference_between_load_sharing_and_load_balancing"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">division</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> considered further </font><a href="http://wiki.answers.com/Q/Difference_between_load_sharing_and_load_balancing"><font style="vertical-align: inherit;">is</font></a><font style="vertical-align: inherit;"> conditional and there are </font></font><a href="http://routing-bits.com/2009/06/03/load-sharing-vs-load-balancing/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alternative views.</font></font></a> <br></i> </blockquote><br><br><a name="Load_Balancing"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Load balancing </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Balancing is usually understood as the distribution between several links of traffic directed to a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">single</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> network. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ecc/500/f11/ecc500f113e216cf346ea7e11b5b9073.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It just turns on</font></font><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">router</span></span> bgp <span class="hljs-number"><span class="hljs-number">100</span></span> maximum-paths <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The following conditions must be met: </font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> At least two routes in the BGP table for this network. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Both routes go through the same provider. </font></font></li><li>  Weight, Local Preference, AS-Path, Origin, MED,  IGP . </li><li>  Next Hop      . </li></ul><br><blockquote>      <br><pre> <code class="hljs pgsql">router bgp <span class="hljs-number"><span class="hljs-number">64500</span></span> bgp bestpath <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-<span class="hljs-type"><span class="hljs-type">path</span></span> multipath-relax</code> </pre><br>         AS-path,     - . <br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How can we check it on our network? </font><font style="vertical-align: inherit;">We need to make sure that balancing works. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Balancing is usually carried out on the basis of flows (IP address / port of the sender and IP address / port of the receiver) so that the packets arrive in the correct order. </font><font style="vertical-align: inherit;">Therefore, we need to create two streams. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is nothing simpler: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) ping directly from msk-arbat-gw1 to 103.0.0.1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) connect via telnet to msk-arbat-gw1 (remember to configure the parameters) from any other router and start ping with indication of the source (so that the streams will differed from each other) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After that, one ping will go through one link, and the second through another.</font></font> <b>Verified by</b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By default, the bandwidth of external channels is not taken into account. </font><font style="vertical-align: inherit;">This feature is, however, implemented and launched by commands.</font></font><br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">router</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bgp</span></span> 64500 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bgp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dmzlink-bw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 101<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dmzlink-bw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 102<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dmzlink-bw</span></span></code> </pre> <a href="https://docs.google.com/document/d/12p772mrL1RXtG5miFkBCnhsmAvs9e6FGB_1bxpHFZXI/edit%3Fusp%3Dsharing"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Device configuration</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ===================== </font></font><br> <a href="http://linkmeup.ru/blog/59.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task number 5</font></font></b></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Scheme: General network diagram </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Condition: LinkMiAp receives the default route from both providers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure outgoing traffic balancing between default routes from Balagan Telecom and Filkin providers in the proportion of 3 to 1. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Details of the task on the </font></font><a href="http://linkmeup.ru/blog/59.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> =====================</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Load distribution </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A completely different song with distribution is more fine-tuning the paths of outgoing and incoming traffic. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Outgoing </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outgoing traffic is sent in accordance with the routes received from above. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accordingly, they should be managed. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recall the scheme of our network. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ecb/74c/12b/ecb74c12b6348666c84cd98825ee4f18.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, there are the following ways: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) Setting Weight. </font><font style="vertical-align: inherit;">This is a tsiskovsky internal parameter ‚Äî it is not transmitted anywhere ‚Äî it works within the router. </font><font style="vertical-align: inherit;">Other vendors also often have analogues (for example, Huawei's PreVal). </font><font style="vertical-align: inherit;">There is nothing specific - we will not even stop. </font><font style="vertical-align: inherit;">(default - 0) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application to all routes received from a neighbor:</font></font><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">weight</span></span> 500</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Application via route-map: </font></font><br><pre> <code class="hljs swift">route-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> <span class="hljs-type"><span class="hljs-type">SET_WEIGHT</span></span> permit <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> weight <span class="hljs-number"><span class="hljs-number">500</span></span> ! router bgp <span class="hljs-number"><span class="hljs-number">64500</span></span> neighbor <span class="hljs-number"><span class="hljs-number">102.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> route-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> <span class="hljs-type"><span class="hljs-type">SET_WEIGHT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span></code> </pre><img src="https://habrastorage.org/getpro/habr/post_images/9b4/c27/c3e/9b4c27c3e5493d74f904beeff9d64fc7.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) Local Preference. </font><font style="vertical-align: inherit;">This parameter is standard. </font><font style="vertical-align: inherit;">The default is 100 for all routes. </font><font style="vertical-align: inherit;">If you want to send traffic to certain subnets to certain links, then Local Preference is irreplaceable. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Above, we have already </font></font><a href="https://habr.com/ru/post/184350/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">considered</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> an example of using this parameter. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3) The aforementioned balancing with the </font></font><a href="https://habr.com/ru/post/184350/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maximum-paths</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ====================== </font></font><br> <a href="http://linkmeup.ru/blog/60.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task number 6</font></font></b></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Scheme: General network diagram </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Condition: LinkMiAp receives Full View from both providers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Without using the weight, local preference or filtering attributes, configure the msk-arbat-gw1 router so that Balagan Telecom is the primary for outgoing traffic, and Filkin the Backup certificate. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Details of the task on the </font></font><a href="http://linkmeup.ru/blog/60.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ===================== </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Incoming </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It's all complicated. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The fact is that even with large providers, the outgoing traffic is insignificant in comparison with the incoming traffic. </font><font style="vertical-align: inherit;">And there is so badly not noticed uneven distribution. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But if we are talking about Data Processing Centers or hosting providers, then the situation is reversed and the issue of balancing is very serious. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we are extremely constrained in the means:</font></font><br><br><a name="AS-Path_prepend"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1) AS-Path Prepend </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One of the most frequent tricks is the ‚Äúdeterioration‚Äù of the path. It often happens that through one provider your routes will be transferred with an AS-path length longer than through the other. Of course, BGP chooses the first, categorically, and only through it will transmit traffic. To even out the situation when announcing routes, you can add an extra ‚Äúhop‚Äù to the AS-Path. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And there is such a situation that one provider provides a wider channel for little money, but the path through it is longer and all traffic goes to the other - expensive and narrow. This situation is unprofitable for us and we would like the narrow channel to become a backup one. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here it is and analyze. But you have to take a completely degenerate situation. For example, access from Balagan Telecom to LikMiAp network.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is how the BGP table and routing on the Balagan Telecom provider usually look like: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/801/cb2/6ee/801cb26eea9c51369c2c5db67d34dc22.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we want to worsen the main path (a direct link between them), then we need to add AS to the AS-Path list:</font></font><br><br><pre> <code class="hljs swift">router bgp <span class="hljs-number"><span class="hljs-number">64500</span></span> neighbor <span class="hljs-number"><span class="hljs-number">101.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> route-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> <span class="hljs-type"><span class="hljs-type">AS_PATH_PREP</span></span> out route-<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> <span class="hljs-type"><span class="hljs-type">AS_PATH_PREP</span></span> permit <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>-path prepend <span class="hljs-number"><span class="hljs-number">64500</span></span> <span class="hljs-number"><span class="hljs-number">64500</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then the picture will look like this. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fde/545/df3/fde545df36746aaeae990edfa292345b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, a path is chosen with a shorter AS-Path length, that is, via Filkin Certificate (AS6502) </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a1d/2a0/561/a1d2a05618c952c16405aff8d78c2197.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This route is added to the routing table. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note that it is usual to add your AS number to AS-Path. </font><font style="vertical-align: inherit;">You can, of course, and someone else, but you will not understand in a decent society. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, we have ensured that the traffic will go the way we planned. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Naturally, when one of the channels drops, the traffic will switch to the second, regardless of the AS-Path Prepend set up. </font></font><br><br> <a href="https://docs.google.com/document/d/1zWClzNHuSTBm49GPPGGKbol4TH_lwtRy_mJN5xBzpLI/edit%3Fusp%3Dsharing"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Device configuration</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2) MED </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multiexit Discriminator. </font><font style="vertical-align: inherit;">In cisco, it is called a metric (Inter-AS metric). </font><font style="vertical-align: inherit;">MED is a weak attribute. </font><font style="vertical-align: inherit;">Weak, because it is checked only at the sixth step when choosing a route and has essentially a weak effect. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the Local Preference affects the choice of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> path of </font><b><font style="vertical-align: inherit;">the</font></b><font style="vertical-align: inherit;"> traffic from the Autonomous System, then the MED is transmitted to the neighboring AS and thus affects the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entry</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> path of </font><b><font style="vertical-align: inherit;">the</font></b><font style="vertical-align: inherit;"> traffic. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, MED and Local Preference are often confused by beginners, so we will describe the difference in the table.</font></font><br><br><table border="1"><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Local Preference </font></font></th><th>  MED </th></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Defines the priority of the path for </font><font style="vertical-align: inherit;">traffic </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exit.</font></font></b><font style="vertical-align: inherit;"></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Defines the priority of the path for </font><font style="vertical-align: inherit;">traffic </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entry.</font></font></b><font style="vertical-align: inherit;"></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Valid only within AS. </font><font style="vertical-align: inherit;">It is not transmitted to other AS.</font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It is transmitted to other AS and hints through which path to transmit traffic is preferable. </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It can work when connecting to different AS </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It works only with multiple connections to one AS. </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The higher the value, the higher the priority. </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The higher the value, the lower the priority. </font></font></td></tr></tbody></table><br><img src="https://habrastorage.org/getpro/habr/post_images/fd8/8ef/8f8/fd88ef8f882417af30d1a187f58186b8.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We will not dwell on it, because they rarely use it, and our network is not suitable for this - there should be several connections between two AS, and we only have one in each. </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3) Announcement of different prefixes through different ISPs </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another way to distribute the load is to distribute different networks to different providers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now in the data center network, our announcements look like this: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a72/0d7/cff/a720d7cffcb4df23303081142bdff1ac.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, our network 100.0.0.0/23 is known through two paths, but only one will be added to the routing table. </font><font style="vertical-align: inherit;">Accordingly, all traffic back will go one - the best way.</font></font><br><br>  But! <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We can divide it into two / 24 subnets and send one to Balagan Telecom, and another to Filkin Certificate. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accordingly, the data center will know about these subnets through different paths: It is </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/bf3/09c/7af/bf309c7af3dd55779e856bfe1daa7a63.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configured this way. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, we register </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> our subnets - all 3: one large / 23 and two small / 24:</font></font><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">router</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bgp</span></span> 64500 <span class="hljs-selector-tag"><span class="hljs-selector-tag">network</span></span> 100<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mask</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.254</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">network</span></span> 100<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mask</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">network</span></span> 100<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mask</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In order for them to be announced, you need to create routes to these subnets. </font></font><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 100<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.254</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Null0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 100<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Null0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 100<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Null0</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And now we create prefix-lists, which allow each only one subnet / 24 and common / 23. </font></font><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ip</span></span> prefix-list LIST_OUT1 seq <span class="hljs-number"><span class="hljs-number">5</span></span> permit <span class="hljs-number"><span class="hljs-number">100.0.0.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> ip prefix-list LIST_OUT1 seq <span class="hljs-number"><span class="hljs-number">10</span></span> permit <span class="hljs-number"><span class="hljs-number">100.0.0.0</span></span>/<span class="hljs-number"><span class="hljs-number">23</span></span> ! ip prefix-list LIST_OUT2 seq <span class="hljs-number"><span class="hljs-number">5</span></span> permit <span class="hljs-number"><span class="hljs-number">100.0.1.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> ip prefix-list LIST_OUT2 seq <span class="hljs-number"><span class="hljs-number">10</span></span> permit <span class="hljs-number"><span class="hljs-number">100.0.0.0</span></span>/<span class="hljs-number"><span class="hljs-number">23</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It remains to attach the prefix lists to the neighbors. </font></font><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">router</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bgp</span></span> 64500 <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 101<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">remote-as</span></span> 64501 <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 101<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">prefix-list</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">LIST_OUT1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">out</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 102<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">remote-as</span></span> 64502 <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 102<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">prefix-list</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">LIST_OUT2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">out</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We tie them to OUT - to outgoing, because we are talking about routes that we send outside. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, we will announce the neighbor 101.0.0.1 (Balagan Telecom) networks 100.0.0.0/24 and 100.0.0.0/23. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And the neighbor 102.0.0.1 (Filkin Certificate) - networks 100.0.1.0/24 and 100.0.0.0/23. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The result will be: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c6c/b3b/f30/c6cb3bf3046233f0ea2d453ccdf41cac.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It seems to be wrong, because we have two routes to each network / 24 - through Balagan Telecom and through the Filkin Certificate. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But if you look closely, you will see that according to AS-Path we have such routes: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/901/7e8/407/9017e84079e8949105d63782a4eabae7.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, in fact, everything is correct. Yes, and in the routing table, everything fits correctly:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b5e/e8a/f4f/b5ee8af4fd23aa34effa4ee9c757ca82.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now it remains to answer the question of the devil, we dragged a large subnet / 23? </font><font style="vertical-align: inherit;">After all, according to the rule of Longest prefix match, more accurate routes are preferable, that is / 23, as if not needed when there is / 24. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But let us imagine a situation when the Balagan Telecom network falls. </font><font style="vertical-align: inherit;">What happens? </font><font style="vertical-align: inherit;">Subnet 100.0.0.0/24 will cease to be known on the Internet - after all, only Balagan Telecom knew something about it thanks to our configuration. </font><font style="vertical-align: inherit;">Accordingly, part of our network will fall.</font></font> But!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We are saved by a more general route 100.0.0.0/23. </font><font style="vertical-align: inherit;">Filkin Certificate knows about it and announces it on the Internet. </font><font style="vertical-align: inherit;">Accordingly, although the data center does not know about the network 100.0.0.0/24, it knows about 100.0.0.0/23 and will allow traffic in the direction of the Filkin Certificate. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/bdf/baa/d29/bdfbaad2917cc470b0361414b3a1c06c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, thank Leibniz, we are insured against such a situation.</font></font><br><br><blockquote>   ,              RIPE.       /24   /23. <br></blockquote><br><br> <a href="https://docs.google.com/document/d/1MkA5_S6bc4JEDdpWiLBkEuqMN52-nh2PrzUC2f3UHjM/edit%3Fusp%3Dsharing"> </a> <br><br><h2> 4) BGP Community </h2><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With the help of the BGP Community, you can give the provider instructions on what to do with the prefix, to whom to transfer, to whom it is not, what local preference to set, and so on. </font><font style="vertical-align: inherit;">We will not consider this option now, because we will move the topic of the community to the next issue. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">===================== </font></font><br> <a href="http://linkmeup.ru/blog/61.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task number 7</font></font></b></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Scheme: General network diagram </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Condition: The router msk-arbat-gw1 is configured to control incoming and outgoing traffic. </font><font style="vertical-align: inherit;">The main provider Balagan Telecom, reserve - Filkin Certificate. </font><font style="vertical-align: inherit;">When checking the settings, it turned out that the outgoing traffic is transmitted correctly. </font><font style="vertical-align: inherit;">When checking incoming traffic, it turned out that incoming traffic also goes through the provider Balagan Telecom, but when Balagan Telecom is disconnected, the incoming traffic does not go through the Filkin Certificate. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task: Correct the settings.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration:</font></font></b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">hostname</span></span> msk-arbat-gw1 ! interface Loopback0 ip address <span class="hljs-number"><span class="hljs-number">100.0.0.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255.255.255</span></span> ! interface FastEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> description Balagan_Telecom_Internet ip address <span class="hljs-number"><span class="hljs-number">101.0.0.2</span></span> <span class="hljs-number"><span class="hljs-number">255.255.255.252</span></span> duplex auto speed auto ! interface FastEthernet0/<span class="hljs-number"><span class="hljs-number">1</span></span> description Philkin_Certificate_Internet ip address <span class="hljs-number"><span class="hljs-number">102.0.0.2</span></span> <span class="hljs-number"><span class="hljs-number">255.255.255.252</span></span> speed <span class="hljs-number"><span class="hljs-number">100</span></span> full-duplex ! router bgp <span class="hljs-number"><span class="hljs-number">64500</span></span> <span class="hljs-literal"><span class="hljs-literal">no</span></span> synchronization bgp log-neighbor-changes network <span class="hljs-number"><span class="hljs-number">100.0.0.0</span></span> mask <span class="hljs-number"><span class="hljs-number">255.255.254.0</span></span> neighbor <span class="hljs-number"><span class="hljs-number">101.0.0.1</span></span> remote-as <span class="hljs-number"><span class="hljs-number">64501</span></span> neighbor <span class="hljs-number"><span class="hljs-number">101.0.0.1</span></span> prefix-list LAN out neighbor <span class="hljs-number"><span class="hljs-number">101.0.0.1</span></span> weight <span class="hljs-number"><span class="hljs-number">500</span></span> neighbor <span class="hljs-number"><span class="hljs-number">102.0.0.1</span></span> remote-as <span class="hljs-number"><span class="hljs-number">64502</span></span> neighbor <span class="hljs-number"><span class="hljs-number">102.0.0.1</span></span> prefix-list LAN out neighbor <span class="hljs-number"><span class="hljs-number">102.0.0.1</span></span> route-map INBOUND out <span class="hljs-literal"><span class="hljs-literal">no</span></span> auto-summary ! route-map INBOUND permit <span class="hljs-number"><span class="hljs-number">10</span></span> set as-path prepend <span class="hljs-number"><span class="hljs-number">64502</span></span> <span class="hljs-number"><span class="hljs-number">64502</span></span> <span class="hljs-number"><span class="hljs-number">64502</span></span> ! ip prefix-list LAN permit <span class="hljs-number"><span class="hljs-number">100.0.0.0</span></span>/<span class="hljs-number"><span class="hljs-number">23</span></span> ! ip route <span class="hljs-number"><span class="hljs-number">100.0.0.0</span></span> <span class="hljs-number"><span class="hljs-number">255.255.254.0</span></span> Null0</code> </pre></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Details of the tasks on the </font></font><a href="http://linkmeup.ru/blog/61.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ===================== </font></font><br><br> <a href="http://img.nag.ru/projects/setup/cac/b32d96aedb57366ac833bc92008bb6e2.pdf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instructions on the types of balancing and load distribution</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Natasha Samoylenko - the author of </font></font><a href="http://xgu.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xgu.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> prepared a presentation for us.</font></font><br><br><div class="slideshow"><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.slideshare.net/slideshow/embed_code/23374914&amp;xid=17259,15700022,15700186,15700191,15700253&amp;usg=ALkJrhjliXgGZbSSqkeYcB9lc8DxB7kzNA" width="425" height="355" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe></div> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can download it and use it as you wish, indicating the authorship.</font></font></i> <br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PBR </font></font></h1><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All the routing technologies that we used up to this point in our articles, whether static routing, dynamic routing (IGP or EGP), took into account only one sign of the packet: the destination address. All of them, simply, acted on the same principle: they looked where the packet went, found the most specific route to the destination (longest match) in the routing table, and forwarded the packet to the interface that was recorded in the table opposite this very route. This, in general, is the essence of routing. And what if this order of things does not suit us? What if we want to route a packet, starting from the source address? Or do we need the </font><font style="vertical-align: inherit;">HTTP </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">boys to the</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> right, the </font><font style="vertical-align: inherit;">SNMP </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">girls to the</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> left?</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In such a situation, policy-based routing aka PBR (Policy based routing) comes to the rescue. </font><font style="vertical-align: inherit;">This technology allows us to manage traffic based on the following features of the package:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Source address (or a combination of source address and recipient address) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Information level 7 (applications) OSI </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The interface to which the packet came </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> QoS tags </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Generally speaking, any information used in the extended-ACL (source / destination port, protocol, etc., in any combination). </font></font> Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> if we can isolate the traffic we are interested in using an extended ACL, we will be able to route it as we please. </font></font></li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The benefits of using PBR are obvious: incredible routing flexibility. </font><font style="vertical-align: inherit;">But the minuses are also present:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> All you need to write with your hands, hence a lot of work and the risk of error </font></font></li><li>  Performance.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> On most hardwares, PBR is slower than regular routing (with the exception of Catalysts 6500, they have a supervisor with iron support for PBR) </font></font></li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The policy based on which PBR is implemented is created with the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">route map </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POLICY_NAME command</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and contains two sections:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Allocation of the necessary traffic. </font><font style="vertical-align: inherit;">It is carried out either by means of ACL, or depending on the interface in which the traffic came. </font><font style="vertical-align: inherit;">The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">match</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> command </font><font style="vertical-align: inherit;">in the route map configuration mode </font><font style="vertical-align: inherit;">is responsible for this.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apply action to this traffic. </font><font style="vertical-align: inherit;">The </font><b><font style="vertical-align: inherit;">set</font></b><font style="vertical-align: inherit;"> command is responsible for this.</font></font><b><font style="vertical-align: inherit;"></font></b> <br></li></ul><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have a </font><font style="vertical-align: inherit;">bit of practice to do </font><font style="vertical-align: inherit;">this. We have this topology: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/6cd/e91/320/6cde913208a33c35fc330dccc692ed77.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the moment, R1-R5 traffic and back goes along the route R1-R2-R4-R5, for convenience, the addresses are assigned so that the last digit of the address is the router number:</font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R1 # traceroute 192.168.100.5 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 192.168.0.2 20 msec 36 msec 20 msec </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 192.168.2.4 40 msec 44 msec 16 msec </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 192.168.100.5 56 msec * 84 msec</font></font><br></blockquote><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R5 # traceroute 192.168.0.1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 192.168.100.4 56 msec 40 msec 8 msec </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 192.168.2.2 20 msec 24 msec 16 msec </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 192.168.0.1 64 msec * 84 msec</font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, suppose we need to return traffic from R5 (with its source address) along the route R5-R4- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -R1 </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">According to the scheme, it is obvious that the decision on this should take R4. </font><font style="vertical-align: inherit;">On it, we first create an ACL that selects the packets we need:</font></font><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#access-list</span></span> 100 <span class="hljs-selector-tag"><span class="hljs-selector-tag">permit</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">any</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Then create a routing policy with the name ‚ÄúBACK‚Äù: </font></font><br><pre> <code class="hljs lisp">R4(<span class="hljs-name"><span class="hljs-name">config</span></span>)#route-map BACK</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inside it we say what traffic we are interested in: </font></font><br><pre> <code class="hljs lisp">R4(<span class="hljs-name"><span class="hljs-name">config-route-map</span></span>)#match ip address <span class="hljs-number"><span class="hljs-number">100</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And what to do with it: </font></font><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-route-map</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#set</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">next-hop</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> After that we go to the interface that looks towards R5 (PBR works with incoming traffic!) And apply the resulting policy on it: </font></font><br><pre> <code class="hljs lisp">R4(<span class="hljs-name"><span class="hljs-name">config</span></span>)#int fa1/0 R4(<span class="hljs-name"><span class="hljs-name">config-if</span></span>)#ip policy route-map BACK</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Checking: </font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R5 # traceroute 192.168.0.1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 192.168.100.4 40 msec 40 msec 16 msec </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 192.168.3.3 52 msec 52 msec 44 msec </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 192.168.1.1 56 msec * 68 msec</font></font><br></blockquote><br>  Works!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And now let's look carefully at the scheme and think: is everything ok? </font></font><br><br>  And no! <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Following this ACL, at us all traffic with a source of R5 is turned on R3. </font><font style="vertical-align: inherit;">This means that if, for example, R5 wants to get to R2, it will, instead of the short and obvious route R5-R4-R2, be sent along the route R5-R4-R3-R1-R2. </font><font style="vertical-align: inherit;">Therefore, it is necessary very carefully and thoughtfully to make ACL for PBR, making it as specific as possible. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this example, we have chosen to redefine the nextop (the network node where the packet will go further) as the action applied to the traffic. </font><font style="vertical-align: inherit;">What else can you do with PBR? </font><font style="vertical-align: inherit;">Available commands:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> set ip next-hop </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> set interface </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> set ip default next-hop </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> set default interface </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With the first two, everything is relatively clear - they override the nextop and the interface from which the packet will exit (most often the set interface is used for point-to-point links). And if we use the set ip </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">default</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> next-hop or set </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">default</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> interface </font><font style="vertical-align: inherit;">commands </font><font style="vertical-align: inherit;">, the router first looks at the routing table, and if there is a route for the packet being checked, sends it accordingly to the table. If there is no route, the packet is sent as stated in the policy. For example, if we in our topology instead of set ip next-hop 192.168.3.3 had commanded set ip default next-hop 192.168.3.3, nothing would have changed, since R4 has a route to R1 (via R2). But if he was absent, the traffic would be directed to R3.</font></font><br><br><blockquote>  ,    <b>set</b>       :    QoS  MPLS    BGP </blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">===================== </font></font><br> <a href="http://linkmeup.ru/blog/67.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task number 8</font></font></b></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Condition: LinkMiAp uses static routes to providers (not BGP). </font></font><br><br> <a href="https://docs.google.com/document/d/1bH7FdkcQ4HYRDYKph5qp0mC_xBbMnlPL1ETlTxB2s_E/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scheme and configuration</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Provider routers also do not use BGP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task: Set up switching between providers. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The default route to Balagan Telecom should be used as long as the icmp responses to google ping (103.0.0.10) OR yandex (103.0.0.20) arrive. Requests should be sent via Balagan Telecom. If none of the specified resources responds, the default route should switch to the provider of the Filkin Certificate. In order for switching not to occur due to the temporary loss of individual icmp responses, it is necessary to set a switching delay of at least 5 seconds. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Details of the task</font></font><a href="http://linkmeup.ru/blog/67.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> =====================</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IP SLA </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And now the tastiest: imagine that in our scheme, the main path R4-R2-R1 is served by one provider, and the spare one R4-R3-R1 is another. Sometimes the first provider has load problems that cause our voice traffic to start to suffer. At the same time, another route is not loaded and it would be good to transfer the voice to it at this moment. Ok, we write route map, as we did above, which allocates voice traffic and directs it through a normally working provider. And then - op, the situation has changed to the opposite - again, everything has to be changed back. Weekdays technical support: "And such rubbish all day: either a seal calls, or a deer." But it would be cool if we could track the characteristics of the main channel we need (for example, delay or jitter), and, depending on their value,automatically send voice or video on the main or backup channel, right? So, miracles happen. In our case, the miracle is called IP SLA.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This technology, in fact, is active network monitoring, i.e. </font><font style="vertical-align: inherit;">generating some traffic in order to evaluate one or another characteristic of the network. </font><font style="vertical-align: inherit;">But monitoring does not end there - the router can, using the data obtained, influence the decision making on routing, thus reacting and solving the problem. </font><font style="vertical-align: inherit;">For example, unload the busy channel, distributing the load on others. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Without further ado, immediately to the setting. </font><font style="vertical-align: inherit;">First, we need to say that we want to monitor. </font><font style="vertical-align: inherit;">Create a monitoring object, assign it a number:</font></font><br><pre> <code class="hljs lisp">R4(<span class="hljs-name"><span class="hljs-name">config</span></span>)#ip sla <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> So, what can we monitor here? </font></font><br><blockquote> R4(config-ip-sla)#? <br> IP SLAs entry configuration commands: <br> dhcp DHCP Operation <br> dns DNS Query Operation <br> exit Exit Operation Configuration <br> frame-relay Frame-relay Operation <br> ftp FTP Operation <br> http HTTP Operation <br> icmp-echo ICMP Echo Operation <br> icmp-jitter ICMP Jitter Operation <br> mpls MPLS Operation <br> path-echo Path Discovered ICMP Echo Operation <br> path-jitter Path Discovered ICMP Jitter Operation <br> slm SLM Operation <br> tcp-connect TCP Connect Operation <br> udp-echo UDP Echo Operation <br> udp-jitter UDP Jitter Operation <br> voip Voice Over IP Operation <br></blockquote><br><br><blockquote>  ,   ,   IP SLA,   :   IOS 12.4(4)T  ,   ,       . ,  ip sla 1  rtr 1   ip sla responder ‚Äì rtr responder </blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, the list is impressive, so we will not stop, for those interested, there is a detailed </font></font><a href="http://www.cisco.com/en/US/technologies/tk648/tk362/tk920/technologies_white_paper09186a00802d5efe_ps6602_Products_White_Paper.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on tsisko.com. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">===================== </font></font><br> <a href="http://linkmeup.ru/blog/68.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task number 9</font></font></b></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Condition: LinkMiAp uses static routes to providers (not BGP). </font></font><br><br> <a href="https://docs.google.com/document/d/1bH7FdkcQ4HYRDYKph5qp0mC_xBbMnlPL1ETlTxB2s_E/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scheme and configuration</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Provider routers also do not use BGP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure routing so that HTTP traffic from the local 10.0.1.0 network goes through Balagan Telecom, and all traffic from the 10.0.2.0 network through the Filkin Certificate. If any other address appears in the sender's address, the traffic should be dropped, and not routed through the standard routing table (the task must be completed without filtering using ACLs applied on the interface).</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Additional condition: PBR rules should work this way only if the relevant provider is available (for this task, it is sufficient to check the availability of the nearest provider device). Otherwise, a standard routing table should be used. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Details of the task </font></font><a href="http://linkmeup.ru/blog/68.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ===================== </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usually, IP SLA work is considered on the simplest example </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">icmp-echo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . That is, in case we can ping that end of the line, the traffic goes on it, if we cannot, on the other. But we will go a little more difficult. So, we are interested in the characteristics of the channel, important for voice traffic, for example, jitter. More specifically, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">udp-jitter</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so we write</font></font><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-ip-sla</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#udp-jitter</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.200</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> 55555</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this command, after specifying the type of verification ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">udp-jitter</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), the ip address goes to where the samples will be sent (ie, we measure from us to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.200.1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - this is a loopback on R1) and the port (from bald </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">55555</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Then you can set the check frequency (by default 60 seconds):</font></font><br><pre> <code class="hljs lisp">R4(<span class="hljs-name"><span class="hljs-name">config-ip-sla-jitter</span></span>)#frequency <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the limit value, above which the ip sla 1 object reports unavailability: </font></font><br><pre> <code class="hljs lisp">R4(<span class="hljs-name"><span class="hljs-name">config-ip-sla-jitter</span></span>)#threshold <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some types of measurements in IP SLA require the presence of a so-called ‚Äúresponder‚Äù on the ‚Äúother side‚Äù (responder), some (for example, FTP, HTTP, DHCP, DNS) do not. </font><font style="vertical-align: inherit;">Our </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">udp-jitter</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> requires, therefore, before you run the measurements, you need to prepare R1:</font></font><br><pre> <code class="hljs lisp">R1(<span class="hljs-name"><span class="hljs-name">config</span></span>)#ip sla responder</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now we need to start collecting statistics. </font></font> Commanding <br><pre> <code class="hljs pgsql">R4(config)#ip sla schedule <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>-<span class="hljs-type"><span class="hljs-type">time</span></span> now life forever</code> </pre><br>  Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We start the monitoring object 1 right now and until the end of days. </font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We cannot change object parameters if statistics collection is running. </font></font> Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to change, for example, the frequency of samples, we need to first turn off the collection of information from it: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no ip sla schedule 1</font></font></b> <br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now we can see what we have there going: </font></font><br><blockquote> R4#sh ip sla statistics 1 <br><br> Round Trip Time (RTT) for Index 1 <br> Latest RTT: 36 milliseconds <br> Latest operation start time: *00:39:01.531 UTC Fri Mar 1 2002 <br> Latest operation return code: OK <br> RTT Values: <br> Number Of RTT: 10 RTT Min/Avg/Max: 19/36/52 milliseconds <br> Latency one-way time: <br> Number of Latency one-way Samples: 0 <br> Source to Destination Latency one way Min/Avg/Max: 0/0/0 milliseconds <br> Destination to Source Latency one way Min/Avg/Max: 0/0/0 milliseconds <br> Jitter Time: <br> Number of SD Jitter Samples: 9 <br> Number of DS Jitter Samples: 9 <br> Source to Destination Jitter Min/Avg/Max: 0/5/20 milliseconds <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jitter Min / Avg / Max: 0/16/28 milliseconds </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Packet Loss Values: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loss Source to Destination: 0 Loss Destination to Source: 0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Out Of Sequence: 0 Tail Drop: 0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Packet Late Arrival: 0 Packet Skipped: 0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voice Score Values: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculated Planning Impairment Factor (ICPIF): 0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mean Opinion Score (MOS): 0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Number of successes: 12 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Number of failures: 0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Operation time to live: Forever</font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and what we have configured there </font></font><br><blockquote> R4#sh ip sla conf <br> IP SLAs Infrastructure Engine-II <br> Entry number: 1 <br> Owner: <br> Tag: <br> Type of operation to perform: udp-jitter <br> Target address/Source address: 192.168.200.1/0.0.0.0 <br> Target port/Source port: 55555/0 <br> Request size (ARR data portion): 32 <br> Operation timeout (milliseconds): 5000 <br> Packet Interval (milliseconds)/Number of packets: 20/10 <br> Type Of Service parameters: 0x0 <br> Verify data: No <br> Vrf Name: <br> Control Packets: enabled <br> Schedule: <br> Operation frequency (seconds): 10 (not considered if randomly scheduled) <br> Next Scheduled Start Time: Pending trigger <br> Group Scheduled: FALSE <br> Randomly Scheduled: FALSE <br> Life (seconds): 3600 <br> Entry Ageout (seconds): never <br> Recurring (Starting Everyday): FALSE <br> Status of entry (SNMP RowStatus): Active <br> Threshold (milliseconds): 10 <br> Distribution Statistics: <br> Number of statistic hours kept: 2 <br> Number of statistic distribution buckets kept: 1 <br> Statistic distribution interval (milliseconds): 4294967295 <br> Enhanced History: <br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we are setting up the so-called </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">track</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (incorrect but understandable translation ‚Äútracker‚Äù). </font><font style="vertical-align: inherit;">It is to his condition that actions in route map are subsequently attached. </font><font style="vertical-align: inherit;">In the track, you can set the delay of switching between states, which allows you to solve the problem, when we have the routing change for one unsuccessful sample, and the next, already successful one, changes back. </font><font style="vertical-align: inherit;">We specify the track number and to which ip sla object number we connect it (rtr 1):</font></font><br><pre> <code class="hljs lisp">R4(<span class="hljs-name"><span class="hljs-name">config</span></span>)#track <span class="hljs-number"><span class="hljs-number">1</span></span> rtr <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configuring the delay: </font></font><br><pre> <code class="hljs lisp">R4(<span class="hljs-name"><span class="hljs-name">config-track</span></span>)#delay up <span class="hljs-number"><span class="hljs-number">10</span></span> down <span class="hljs-number"><span class="hljs-number">15</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This means: if the monitoring object fell and did not rise within 15 seconds, we move the track to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">down</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> state </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If the object was able to down, but rose and is in the raised state for at least 10 seconds, we translate the track into the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">up</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> state </font><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next step is to link the track to our route map. </font><font style="vertical-align: inherit;">Let me remind you that the standard path from R5 to R1 goes through R2, but we have a route-map </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BACK</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reassigning the standard state of affairs in case the source is R5:</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R4 # sh run | </font><font style="vertical-align: inherit;">sec route-map </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ip policy route-map BACK </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">route-map BACK permit 10 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">match ip address 100 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set ip next-hop 192.168.3.3</font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we tie our monitoring to this map, replacing the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set ip next-hop 192.168.3.3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> command </font><font style="vertical-align: inherit;">with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set ip next-hop </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verify-availability</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 192.168.3.3 </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 track 1</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , we get the opposite effect: in case of a fall of the track (due to jitter in sla 1), the map will not be processed (everything will go according to the routing table), and vice versa, in the case of normal values, the track will be up, and traffic will go through R3. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How it works: the router sees that the packet falls under the match conditions, but then does not immediately set, as in the previous example with PBR, and first checks the status of track 1, and then, if it is raised (up), set is already done if not, go to the next line of the route map.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order for our map to work as it should, we need to somehow invert the value of the track, i.e. </font><font style="vertical-align: inherit;">when jitter is big, our track should be UP, and vice versa. </font><font style="vertical-align: inherit;">This will help us such a thing as track list. </font><font style="vertical-align: inherit;">In IP SLA, it is possible to combine in the track a list of other tracks (which, in essence, give 1 or 0 at the output) and perform logical operations OR or AND on them, and the result of these operations will be the status of this track. </font><font style="vertical-align: inherit;">In addition, we can apply logical negation to the state of the track. </font><font style="vertical-align: inherit;">Create a track list:</font></font><br><pre> <code class="hljs pgsql">R4(config)#track <span class="hljs-number"><span class="hljs-number">2</span></span> list <span class="hljs-type"><span class="hljs-type">boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The only thing in this ‚Äúlist‚Äù will be the logical negation of the value of track 1: </font></font><br><pre> <code class="hljs pgsql">R4(config-track)#<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now we attach a route map to this track. </font></font><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#route-map</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BACK</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-route-map</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#no</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">set</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">next-hop</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-route-map</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#set</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">next-hop</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">verify-availability</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> 10 <span class="hljs-selector-tag"><span class="hljs-selector-tag">tr</span></span> 2</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The number 10 after the address of the nextop is its sequence number. </font><font style="vertical-align: inherit;">We can, for example, use it like this:</font></font><br><pre> <code class="hljs sql">route-map BACK permit 10 match ip address 100 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ip <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop <span class="hljs-keyword"><span class="hljs-keyword">verify</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">availability</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> &lt;b&gt;<span class="hljs-number"><span class="hljs-number">10</span></span>&lt;/b&gt; track <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ip <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop <span class="hljs-keyword"><span class="hljs-keyword">verify</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">availability</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> &lt;b&gt;<span class="hljs-number"><span class="hljs-number">20</span></span>&lt;/b&gt; track <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is such logic: choose the traffic falling under ACL 100, then there is an intermediate test of track 1, if it is up, we set the package to a nextop 192.168.3.3, if down, we go to the next sequence number (20 in this case), again we check the status track (already another, 2), depending on the result, set a nextop 192.168.2.2 or send with the world (routed on a common basis).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's now talk a little bit about what we have done: so, jitter measurements go from source R4 to responder R1 along the route through R2. The maximum permissible jitter value on this route is 10. In case jitter exceeds this value and stays at this level for 15 seconds, we switch traffic generated by R5 to route through R3. If the jitter falls below 10 and stays there for at least 10 seconds, let the traffic from R5 follow the standard route. Try to fix the material to find which commands specify all these values. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, we have reached the goal: now, in case of deterioration in the quality of the main channel (well, at least, the values ‚Äã‚Äãof udp-jitter), we are switching to the backup one. But what if there is also </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not very</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">Maybe try using IP SLA to solve this problem? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's try to build the logic of what we want to do. </font><font style="vertical-align: inherit;">Before switching to the backup channel, we want to check how we deal with jitter on it. </font><font style="vertical-align: inherit;">To do this, we need to have an additional monitoring object that will consider the jitter on the path R4-R3-R1, let it be 2. Let's make it similar to the first one, with the same values. </font><font style="vertical-align: inherit;">The condition for switching to the backup channel will then be: object 1 down </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> object 2 up. </font><font style="vertical-align: inherit;">To measure non-mainstream jitter, you will have to use a trick: make loopback interfaces on R1 and R4, set up static routes through R3 back and forth, and use these addresses for the SLA 2 object.</font></font><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">R1</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#int</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lo1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R1</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-if</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.30</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R1</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-if</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#exit</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R1</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.31</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R3</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.30</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R3</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.31</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#int</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lo0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-if</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.31</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-ip-sla-jitter</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#exit</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sla</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-ip-sla</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#udp-jitter</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.30</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> 55555 <span class="hljs-selector-tag"><span class="hljs-selector-tag">source-ip</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.31</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-ip-sla-jitter</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#threshold</span></span> 10 <span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-ip-sla-jitter</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#frequency</span></span> 10 <span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config-ip-sla-jitter</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#exit</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.30</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sla</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">schedule</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">start-time</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">now</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">life</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">forever</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">R4</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>)<span class="hljs-selector-id"><span class="hljs-selector-id">#track</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">rtr</span></span> 2</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now we change the condition of track 2, to which the route map is attached: </font></font><br><pre> <code class="hljs lisp">R4(<span class="hljs-name"><span class="hljs-name">config</span></span>)#track <span class="hljs-number"><span class="hljs-number">2</span></span> list boolean and R4(<span class="hljs-name"><span class="hljs-name">config-track</span></span>)#object <span class="hljs-number"><span class="hljs-number">1</span></span> not R4(<span class="hljs-name"><span class="hljs-name">config-track</span></span>)#object <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voila, now R5-&gt; R1 traffic switches to the spare route only if the jitter of the main channel is more than 10 and, at the same time, the spare jitter is less than 10. In case high jitter is observed on both channels, the traffic goes through the main and silently suffers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The state of the track can also be tied to a static route: for example, we can use ip route 0.0.0.0 0.0.0.0 192.168.1.1 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">track 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to make the default gateway 192.168.1.1, which will be associated with track 1 (which, in turn, can check the presence of this very 192.168.1.1 in the network or measure any important characteristics of the quality of communication with it). In case the connected track falls, the route is removed from the routing table.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It will also be useful to mention that the information received via IP SLA can be pulled out via SNMP so that it can be stored and analyzed somewhere in your monitoring system later. You can even configure </font></font><a href="http://www.cisco.com/en/US/docs/ios/12_4/ip_sla/configuration/guide/hsthresh.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SNMP traps.</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ===================== </font></font><br> <a href="http://linkmeup.ru/blog/70.html"><img src="https://habrastorage.org/getpro/habr/post_images/298/063/27d/29806327db155363023118ca212fbb1d.png" align="left" hspace="20"> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task number 10</font></font></b></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Scheme: as in other tasks for PBR. Configuration below. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Condition: LinkMiAp uses static routes to providers (not BGP). </font><font style="vertical-align: inherit;">PBR is configured </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">msk-arbat-gw1 router</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : HTTP traffic must go through the provider Filkin Certificate, and traffic from the 10.0.2.0 network must go through Balagan Telecom. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The specified traffic is transmitted correctly, but the rest of the traffic from the local network, which must be transmitted through the provider Balagan Telecom, is not routed.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Correct the settings so that they meet the conditions.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration:</font></font></b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">hostname</span></span> msk-arbat-gw1 interface Loopback1 ip address <span class="hljs-number"><span class="hljs-number">10.0.1.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255.255.0</span></span> ip nat inside ! interface Loopback2 ip address <span class="hljs-number"><span class="hljs-number">10.0.2.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255.255.0</span></span> ip nat inside ! interface FastEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> description Balagan_Telecom_Internet ip address <span class="hljs-number"><span class="hljs-number">101.0.0.2</span></span> <span class="hljs-number"><span class="hljs-number">255.255.255.252</span></span> ip nat outside duplex auto speed auto ! interface FastEthernet0/<span class="hljs-number"><span class="hljs-number">1</span></span> description Philkin_Certificate_Internet ip address <span class="hljs-number"><span class="hljs-number">102.0.0.2</span></span> <span class="hljs-number"><span class="hljs-number">255.255.255.252</span></span> ip nat outside speed <span class="hljs-number"><span class="hljs-number">100</span></span> full-duplex ! ! ip access-list extended LAN permit ip <span class="hljs-number"><span class="hljs-number">10.0.1.0</span></span> <span class="hljs-number"><span class="hljs-number">0.0.0.255</span></span> any permit ip <span class="hljs-number"><span class="hljs-number">10.0.2.0</span></span> <span class="hljs-number"><span class="hljs-number">0.0.0.255</span></span> any ! route-map BALAGAN permit <span class="hljs-number"><span class="hljs-number">10</span></span> match ip address LAN match interface FastEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> route-map PH_CERT permit <span class="hljs-number"><span class="hljs-number">10</span></span> match ip address LAN match interface FastEthernet0/<span class="hljs-number"><span class="hljs-number">1</span></span> ! ip nat inside source route-map BALAGAN interface Fa0/<span class="hljs-number"><span class="hljs-number">0</span></span> overload ip nat inside source route-map PH_CERT interface Fa0/<span class="hljs-number"><span class="hljs-number">1</span></span> overload ! ip access-list extended HTTP permit tcp any any eq <span class="hljs-number"><span class="hljs-number">80</span></span> ! ip access-list extended LAN2 permit ip <span class="hljs-number"><span class="hljs-number">10.0.2.0</span></span> <span class="hljs-number"><span class="hljs-number">0.0.0.255</span></span> any ! route-map PBR permit <span class="hljs-number"><span class="hljs-number">10</span></span> match ip address HTTP set ip next-hop <span class="hljs-number"><span class="hljs-number">102.0.0.1</span></span> route-map PBR permit <span class="hljs-number"><span class="hljs-number">20</span></span> match ip address LAN2 set ip next-hop <span class="hljs-number"><span class="hljs-number">101.0.0.1</span></span> ! ip local policy route-map PBR</code> </pre><br><br>   <a href="http://linkmeup.ru/blog/70.html"></a> <br> ===================== <br><br><h1>  useful links </h1><br><br><h2>  Bgp </h2><br><ul><li> <a href="http://xgu.ru/wiki/BGP"> </a> </li><li> <a href="http://img.nag.ru/projects/setup/bd7/83a2a1b381320918ced29331a0dfd53b.pdf">    BGP</a> </li><li> <a href="http://img.nag.ru/projects/setup/cac/b32d96aedb57366ac833bc92008bb6e2.pdf">,       </a> </li><li> <a href="http://telekomza.ru/2011/02/28/o-polze-i-vrede-polnoj-bgp-tablicy/">      BGP</a> </li><li> <a href="http://habrahabr.ru/post/55181/">LIR, RIR  </a> </li><li> <a href="http://www.ripn.net/nic/IP-reg/FAQ.html">FAQ    </a> </li><li> <a href="http://nag.ru/articles/article/23270/uyazvimost-bgp.html">    BGP</a> </li><li> <a href="https://docs.google.com/document/d/1IBQaTWj8u-NoJ0ecsh9vC9EHpYRoT5AWxCpPgaV8Nps/pub">AS-PATH ACL</a> , <a href="https://docs.google.com/document/d/1zWClzNHuSTBm49GPPGGKbol4TH_lwtRy_mJN5xBzpLI/pub">AS-PATH Prepend</a> , <a href="https://docs.google.com/document/d/12p772mrL1RXtG5miFkBCnhsmAvs9e6FGB_1bxpHFZXI/pub">Load Balancing</a> , <a href="https://docs.google.com/document/d/12p772mrL1RXtG5miFkBCnhsmAvs9e6FGB_1bxpHFZXI/pub">Load Sharing   Prefix List</a> , <a href="https://docs.google.com/document/d/1EXKvsrapWcM3e1pfFwqs_kF08v00TY49_eN-R69GfAw/pub">Prefix List</a> , <a href="https://docs.google.com/document/d/1EXKvsrapWcM3e1pfFwqs_kF08v00TY49_eN-R69GfAw/pub">Route Map</a> <br></li></ul><br><h2> IP SLA </h2><br><ul><li> <a href="http://www.cisco.com/en/US/technologies/tk648/tk362/tk920/technologies_white_paper09186a00802d5efe_ps6602_Products_White_Paper.html"> IP SLA</a> </li><li> <a href="http://www.cisco.com/en/US/docs/ios/12_4/ip_sla/configuration/guide/hsthresh.html">SNMP-traps</a> </li></ul><br><br>     <a href="http://eucariot.livejournal.com/">eucariot</a>  <a href="https://habrahabr.ru/users/thegluck/" class="user_link">thegluck</a> </div></div>  . <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thanks for the help </font></font><a href="https://habrahabr.ru/users/jdima/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JDima</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problems we wrote an incomparable </font></font><a href="http://xgu.ru/wiki/%25D0%259A%25D0%25B0%25D1%2582%25D0%25B5%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%258F:%25D0%2590%25D0%25B2%25D1%2582%25D0%25BE%25D1%2580_%25D0%259D%25D0%25B0%25D1%2582%25D0%25B0%25D1%2588%25D0%25B0_%25D0%25A1%25D0%25B0%25D0%25BC%25D0%25BE%25D0%25B9%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25BA%25D0%25BE"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Natasha Samoilenko</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The cycle ‚ÄúNetworks for the smallest‚Äù has its own website: </font></font><a href="http://linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">linkmeup.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , where you can find all the issues neatly folded and ready for thoughtful reading.</font></font></div><p>Source: <a href="https://habr.com/ru/post/184350/">https://habr.com/ru/post/184350/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../184338/index.html">Writing asynchronous module for node.js using C ++</a></li>
<li><a href="../184342/index.html">A new look at the vote, or popular about the Condorcet Paradox</a></li>
<li><a href="../184344/index.html">CoffeeScript in the examples. Validation</a></li>
<li><a href="../184346/index.html">Lady checked in baggage</a></li>
<li><a href="../184348/index.html">At Stanford University created a new type of "bionic eyes"</a></li>
<li><a href="../184352/index.html">The digest of news from the world of mobile development for the last week ‚Ññ17 (June 17 - 23, 2013)</a></li>
<li><a href="../184354/index.html">Google was forced to hand over to the US authorities the correspondence of two Wikileaks volunteers</a></li>
<li><a href="../184356/index.html">IconBIT FTB5200U Rechargeable Battery Pack. Mobile Battery Review</a></li>
<li><a href="../184360/index.html">Blackberry Q10 Review and Impressions</a></li>
<li><a href="../184362/index.html">17th edition 01 of the season. Practice using Rails enviroments, Melkman's Ruby implementation algorithm, AngularJS vs Ember, etc.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>