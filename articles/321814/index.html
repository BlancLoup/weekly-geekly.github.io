<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Check the open-source server World of Warcraft CMaNGOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I would like to share the results of the verification with the PVS-Studio static analyzer of the open implementation of the World of W...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Check the open-source server World of Warcraft CMaNGOS</h1><div class="post__text post__text-html js-mediator-article">  In this article I would like to share the results of the verification with the PVS-Studio static analyzer of the open implementation of the World of Warcraft game server - CMaNGOS. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ed9/a82/0f9/ed9a820f991d458b8aeec1cbbf7c61c7.png"></div><br><h2>  Introduction </h2><br>  C (ontinued) MaNGOS is an actively developing branch of the old project MaNGOS (Massive Network Game Object Server), designed to create a free alternative server for the game World of Warcraft.  Most of the MaNGOS developers continue working in the CMaNGOS project. <br><br>  As the developers themselves write, their goal is to create an open ‚Äúwell written server in C ++‚Äù for one of the best MMORPGs.  I will try to help them a little with this, and check CMaNGOS with the help of the PVS-Studio static analyzer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Note: The CMaNGOS-Classic server available in <a href="https://github.com/cmangos/mangos-classic">the project repository on github was</a> used for verification <a href="https://github.com/cmangos/mangos-classic">.</a> <br><a name="habracut"></a><br><h2>  Test results </h2><br><h2>  Error in the priority of operations </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V593/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V593/">V593</a> Consider reviewing the expression A = B &lt;C 'kind.  The expression is calculated as the following: 'A = (B &lt;C)'.  SpellEffects.cpp 473 <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Spell::EffectDummy(SpellEffectIndex eff_idx) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (uint32 roll = urand(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>) &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... else if (roll &lt; 6) .... else if (roll &lt; 9) .... .... }</span></span></code> </pre> <br>  The author assumed that the variable <i>roll</i> will be assigned a random value, and then a comparison of this value with <i>3</i> will occur.  However, the priority of the comparison operation is higher than the priority of the assignment operation (see the <a href="http://www.viva64.com/ru/t/0064/">priority table of operations</a> ), so in reality the random number will first be compared with <i>3</i> , and then the result of this comparison ( <i>0</i> or <i>1</i> ) will be written to the <i>roll</i> variable. <br><br>  This error can be fixed this way: <br><br><pre> <code class="cpp hljs"> uint32 roll = urand(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (roll &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//.... }</span></span></code> </pre> <br><h2>  Same actions in if and else blocks </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V523/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V523/">V523</a> The 'then' statement is equivalent to the 'else' statement.  SpellAuras.cpp 1537 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Aura::HandleAuraModShapeshift(<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> apply, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Real) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (form) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FORM_CAT: .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FORM_TRAVEL: .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FORM_AQUA: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Player::TeamForRace(target-&gt;getRace()) == ALLIANCE) modelid = <span class="hljs-number"><span class="hljs-number">2428</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= else modelid = 2428; // &lt;= .... } .... }</span></span></code> </pre> <br>  In both blocks, the <i>modelid</i> variable <i>is</i> assigned the same value; most likely, this is an error, and the constant in one of the blocks needs to be replaced with some other one. <br><br><h2>  Indefinite behavior </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V567/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V567/">V567</a> Undefined behavior.  The m_uiMovePoint variable is variable  boss_onyxia.cpp 405 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateAI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> uint32 uiDiff)</span></span></span><span class="hljs-function"> override </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (urand(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: { <span class="hljs-comment"><span class="hljs-comment">// C++ is stupid, so add -1 with +7 m_uiMovePoint += NUM_MOVE_POINT - 1; m_uiMovePoint %= NUM_MOVE_POINT; break; } case 2: ++m_uiMovePoint %= NUM_MOVE_POINT; // &lt;= break; } .... }</span></span></code> </pre> <br>  In the specified line, the variable <i>m_uiMovePoint</i> changes twice within one <a href="https://en.wikipedia.org/wiki/Sequence_point">point of the sequence</a> , which leads to undefined program behavior.  More details about this can be found in the diagnostic description <a href="http://www.viva64.com/ru/w/V567/">V567</a> . <br><br>  Similar error: <br><br><ul><li>  V567 Undefined behavior.  The 'm_uiCrystalPosition' variable is modified while being used between sequence points.  boss_ossirian.cpp 150 </li></ul><br><h2>  Error in condition </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V547/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V547/">V547</a> Expression is always false.  Probably the '||'  operator should be used here.  SpellEffects.cpp 2872 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Spell::EffectEnchantItemTmp(SpellEffectIndex eff_idx) { .... <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Strange stuff in following code // shaman family enchantments if (....) duration = 300; else if (m_spellInfo-&gt;SpellIconID == 241 &amp;&amp; m_spellInfo-&gt;Id != 7434) duration = 3600; else if (m_spellInfo-&gt;Id == 28891 &amp;&amp; m_spellInfo-&gt;Id == 28898) // &lt;= duration = 3600; .... }</span></span></code> </pre> <br>  In this condition, the equality of the variable <i>m_spellInfo-&gt; Id to</i> two different values ‚Äã‚Äãat the same time is checked.  The result of such a check, of course, is always <i>false</i> .  Most likely, the author made a mistake and instead of the operator '||'  used the operator '&amp;&amp;'. <br><br>  It is noteworthy that the comments noted the strange behavior of this block of code and, perhaps, that it is just caused by this error. <br><br>  The project found several more similar errors; here is a complete list of them: <br><br><ul><li>  V547 Expression is always false.  Probably the '||'  operator should be used here.  SpellEffects.cpp 2872 </li><li>  V547 Expression is always true.  Probably the '&amp;&amp;' operator should be used here.  genrevision.cpp 261 </li><li>  V547 Expression is always true.  Probably the '&amp;&amp;' operator should be used here.  vmapexport.cpp 361 </li><li>  V547 Expression is always true.  Probably the '&amp;&amp;' operator should be used here.  MapTree.cpp 125 </li><li>  V547 Expression is always true.  Probably the '&amp;&amp;' operator should be used here.  MapTree.cpp 234 </li></ul><br><h2>  Suspicious formatting </h2><br>  <b>PVS-Studio Warning:</b> <a href="http://www.viva64.com/ru/w/V640/">V640</a> The code's operational logic does not correspond with its formatting.  The statement is indented.  It is possible that curly brackets are missing.  instance_blackrock_depths.cpp 111 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> instance_blackrock_depths::OnCreatureCreate(Creature* pCreature) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (pCreature-&gt;GetEntry()) { .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> NPC_HAMMERED_PATRON: .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_auiEncounter[<span class="hljs-number"><span class="hljs-number">11</span></span>] == DONE) pCreature-&gt;SetFactionTemporary(....); pCreature-&gt;SetStandState(UNIT_STAND_STATE_STAND); <span class="hljs-comment"><span class="hljs-comment">// &lt;= break; case NPC_PRIVATE_ROCKNOT: case NPC_MISTRESS_NAGMARA: .... } }</span></span></code> </pre> <br>  Here, most likely, the author forgot to put curly braces after the <i>if statement</i> , as a result of which the call to <i>pCreature-&gt; SetStandState (UNIT_STAND_STATE_STAND)</i> will be executed regardless of the condition in <i>if</i> . <br><br>  If this behavior was intended, then it is worth correcting the code alignment: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_auiEncounter[<span class="hljs-number"><span class="hljs-number">11</span></span>] == DONE) pCreature-&gt;SetFactionTemporary(....); pCreature-&gt;SetStandState(UNIT_STAND_STATE_STAND);</code> </pre> <br><h2>  Identical Operands in the Ternary Operator </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V583/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V583/">V583</a> The '?:' Operator, regardless of the conditional expression, always returns the same value: SAY_BELNISTRASZ_AGGRO_1.  razorfen_downs.cpp 104 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AttackedBy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Unit* pAttacker)</span></span></span><span class="hljs-function"> override </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!m_bAggro) { DoScriptText(urand(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) ? SAY_BELNISTRASZ_AGGRO_1 : <span class="hljs-comment"><span class="hljs-comment">// &lt;= SAY_BELNISTRASZ_AGGRO_1, // &lt;= m_creature, pAttacker); m_bAggro = true; } .... }</span></span></code> </pre> <br>  The second and third operands of the ternary operator are identical, most likely this is a mistake.  Judging by the project code, one can assume that one of the operands should be <i>SAY_BELNISTRASZ_AGGRO_2</i> . <br><br><h2>  Integer division </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V674/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V674/">V674</a> The '0.1f' literal of the 'float' type is compared to the value of the 'unsigned int' type.  item_scripts.cpp 44 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ItemUse_item_orb_of_draconic_energy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-comment"><span class="hljs-comment">// If Emberstrife is already mind controled or above 10% HP: // force spell cast failure if (pEmberstrife &amp;&amp; pEmberstrife-&gt;HasAura(SPELL_DOMINION_SOUL) || pEmberstrife-&gt;GetHealth() / pEmberstrife-&gt;GetMaxHealth() &gt; 0.1f) // &lt;= { .... return true; } return false; }</span></span></code> </pre> <br>  The <i>Unit :: GetHealth ()</i> method returns a value of type <i>uint32_t</i> , and the <i>Unit :: GetMaxHealth ()</i> method also returns a value of type <i>uint32_t</i> , so the result of their division is integer and it <i>makes</i> no sense to compare it with <i>0.1f</i> . <br><br>  To correctly determine the 10% health limit, this code can be rewritten, for example, as follows: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// If Emberstrife is already mind controled or above 10% HP: // force spell cast failure if (pEmberstrife &amp;&amp; pEmberstrife-&gt;HasAura(SPELL_DOMINION_SOUL) || ((float)pEmberstrife-&gt;GetHealth()) / ((float)pEmberstrife-&gt;GetMaxHealth()) &gt; 0.1f) { .... return true; }</span></span></code> </pre> <br><h2>  Unconditional exit from the for loop </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V612/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V612/">V612</a> An unconditional 'break' within a loop.  Pet.cpp 1956 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Pet::InitPetCreateSpells() { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (SkillLineAbilityMap::const_iterator _spell_idx = bounds.first; _spell_idx != bounds.second; ++_spell_idx) { usedtrainpoints += _spell_idx-&gt;second-&gt;reqtrainpoints; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= } .... }</span></span></code> </pre> <br>  It is not quite clear what was meant here, but the unconditional <i>break</i> statement in the body of the <i>for</i> loop looks very suspicious.  Even if there is no error, it is worth refactoring the code and getting rid of the unnecessary loop, because the <i>_spell_idx</i> iterator takes one single value. <br><br>  Similar warning: <br><br><ul><li>  V612 An unconditional 'break' within a loop.  Pet.cpp 895 </li></ul><br><h2>  Excess condition </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V728/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V728/">V728 Alert</a> check can be simplified.  The '||'  operator is surrounded by opposite expressions '! realtimeonly' and 'realtimeonly'.  Player.cpp 10536 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Player::UpdateItemDuration(uint32 time, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> realtimeonly) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((realtimeonly &amp;&amp; (....)) || !realtimeonly) <span class="hljs-comment"><span class="hljs-comment">// &lt;= item-&gt;UpdateDuration(this, time); .... }</span></span></code> </pre> <br>  Type checking ( <i>a</i> &amp;&amp; <i>b</i> ) ||  !  <i>a</i> can be simplified to!  <i>a</i> ||  <i>b</i> , which is clearly seen on the truth table: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/32e/2a4/dad/32e2a4dad17e486db8f180f6a6c103dd.png"></div><br>  Thus, the original expression is simplified to: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Player::UpdateItemDuration(uint32 time, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> realtimeonly) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(realtimeonly) || (....)) item-&gt;UpdateDuration(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, time); .... }</code> </pre> <br><h2>  This check for null </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V704/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V704/">V704</a> '! This ||! PVictim' expression should be avoided: 'this' pointer can never be NULL on newer compilers.  Unit.cpp 1417 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Unit::CalculateSpellDamage(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> || !pVictim) <span class="hljs-comment"><span class="hljs-comment">// &lt;= return; .... }</span></span></code> </pre> <br>  According to the modern standard C ++, the <i>this</i> pointer can never be null.  Often, using <i>this</i> with a null comparison can lead to unexpected errors.  Read more about this in the diagnostic description of the <a href="http://www.viva64.com/ru/w/V704/">V704</a> . <br><br>  Similar checks: <br><br><ul><li>  V704 '! This ||! PVictim' expression should be avoided: 'this' pointer can never be NULL on newer compilers.  Unit.cpp 1476 </li><li>  V704 '! This ||! PVictim' expression should be avoided: 'this' pointer can never be NULL on newer compilers.  Unit.cpp 1511 </li><li>  V704 '! This ||! PVictim' expression should be avoided: 'this' pointer can never be NULL on newer compilers.  Unit.cpp 1797 </li></ul><br><h2>  Unjustified transfer by reference </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V669/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V669/">V669</a> The 'uiHealedAmount' argument is a non-constant reference.  The analyzer is unable to determine where this argument is being modified.  It is possible that the function contains an error.  boss_twinemperors.cpp 109 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HealedBy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Unit* pHealer, uint32&amp; uiHealedAmount)</span></span></span><span class="hljs-function"> override </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">// &lt;= { if (!m_pInstance) return; if (Creature* pTwin = m_pInstance-&gt;GetSingleCreatureFromStorage( m_creature-&gt;GetEntry() == NPC_VEKLOR ? NPC_VEKNILASH : NPC_VEKLOR)) { float fHealPercent = ((float)uiHealedAmount) / ((float)m_creature-&gt;GetMaxHealth()); uint32 uiTwinHeal = (uint32)(fHealPercent * ((float)pTwin-&gt;GetMaxHealth())); uint32 uiTwinHealth = pTwin-&gt;GetHealth() + uiTwinHeal; pTwin-&gt;SetHealth(uiTwinHealth &lt; pTwin-&gt;GetMaxHealth() ? uiTwinHealth : pTwin-&gt;GetMaxHealth()); } }</span></span></span></span></code> </pre> <br>  The variable <i>uiHealedAmount</i> is passed by reference, but does not change in the function body.  This can be misleading, because it seems that the function <i>HealedBy ()</i> is writing something to <i>uiHealedAmount</i> .  It is better to pass a variable by a constant reference or by value. <br><br><h2>  Reassignment </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V519/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V519/">V519</a> The 'stat' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 1776, 1781. DetourNavMeshQuery.cpp 1781 <br><br><pre> <code class="cpp hljs">dtStatus dtNavMeshQuery::findStraightPath(....) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) { stat = appendPortals(apexIndex, i, closestEndPos, <span class="hljs-comment"><span class="hljs-comment">// &lt;= path, straightPath, straightPathFlags, straightPathRefs, straightPathCount, maxStraightPath, options); } stat = appendVertex(closestEndPos, 0, path[i], // &lt;= straightPath, straightPathFlags, straightPathRefs, straightPathCount, maxStraightPath); .... }</span></span></code> </pre> <br>  The analyzer detected a suspicious place where the <i>stat</i> variable is assigned two different values ‚Äã‚Äãtwo times in a row.  Definitely worth checking out this code section for errors. <br><br><h2>  Check pointer to null after new </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V668/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V668/">V668 pm mer mer mer mer</a> mer pointer pointer pointer pointer pointer allocated...  The exception will be generated in the case of memory allocation error.  MapBuilder.cpp 553 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MapBuilder::buildMoveMapTile(....) { .... rcPolyMesh** pmmerge = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> rcPolyMesh*[TILES_PER_MAP * TILES_PER_MAP]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!pmmerge) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { printf("%s alloc pmmerge FIALED! \r", tileString); return; } .... }</span></span></code> </pre> <br>  Checking a pointer to zero after using the <i>new</i> operator is meaningless.  If memory cannot be allocated, the <i>new</i> operator throws an exception <i>std :: bad_alloc ()</i> , and does not return <i>nullptr</i> .  Accordingly, the program will never enter the block after the condition. <br><br>  To correct this error, you can make a memory allocation in a <i>try {....} catch (const std :: bad_alloc &amp;) {....} block</i> , or use the <i>new (std :: nothrow) construction</i> , which will not generate an exception in case of failure. <br><br>  Similar pointer tests: <br><br><ul><li>  V668 allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated  The exception will be generated in the case of memory allocation error.  loadlib.cpp 36 </li><li>  V668 has been set using the 'new' operator.  The exception will be generated in the case of memory allocation error.  MapBuilder.cpp 560 </li><li>  V668 using _ allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated  The exception will be generated in the case of memory allocation error.  WorldSocket.cpp 426 </li></ul><br><h2>  Wrong order of arguments </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V764/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V764/">V764.</a> Possible incorrect order of arguments passed to 'loadVMap' function: 'tileY' and 'tileX'.  MapBuilder.cpp 279 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MapBuilder::buildTile(uint32 mapID, uint32 tileX, uint32 tileY, dtNavMesh* navMesh, uint32 curTile, uint32 tileCount) { .... <span class="hljs-comment"><span class="hljs-comment">// get heightmap data m_terrainBuilder-&gt;loadMap(mapID, tileX, tileY, meshData); // get model data m_terrainBuilder-&gt;loadVMap(mapID, tileY, tileX, // &lt;= meshData); .... }</span></span></code> </pre> <br>  The analyzer detected a suspicious transfer of arguments to a function ‚Äî the <i>tileX</i> and <i>tileY</i> arguments were mixed up. <br><br>  If you look at the prototype of the <i>loadVMap ()</i> function, it becomes obvious that this is really a mistake. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadVMap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint32 mapID, uint32 tileX, uint32 tileY, MeshData&amp; meshData)</span></span></span></span>;</code> </pre> <br><h2>  Two identical code blocks </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V760/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V760/">V760</a> Two blocks of text were found.  The second block begins from line 213. BattleGround.cpp 210 <br><br><pre> <code class="cpp hljs">BattleGround::BattleGround() : m_BuffChange(<span class="hljs-literal"><span class="hljs-literal">false</span></span>), m_StartDelayTime(<span class="hljs-number"><span class="hljs-number">0</span></span>), m_startMaxDist(<span class="hljs-number"><span class="hljs-number">0</span></span>) { .... m_TeamStartLocO[TEAM_INDEX_ALLIANCE] = <span class="hljs-number"><span class="hljs-number">0</span></span>; m_TeamStartLocO[TEAM_INDEX_HORDE] = <span class="hljs-number"><span class="hljs-number">0</span></span>; m_BgRaids[TEAM_INDEX_ALLIANCE] = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; m_BgRaids[TEAM_INDEX_HORDE] = <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; m_PlayersCount[TEAM_INDEX_ALLIANCE] = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= m_PlayersCount[TEAM_INDEX_HORDE] = 0; // &lt;= m_PlayersCount[TEAM_INDEX_ALLIANCE] = 0; // &lt;= m_PlayersCount[TEAM_INDEX_HORDE] = 0; // &lt;= m_TeamScores[TEAM_INDEX_ALLIANCE] = 0; m_TeamScores[TEAM_INDEX_HORDE] = 0; .... }</span></span></code> </pre> <br>  Here the same actions are performed twice in a row.  Most likely, such code appeared as a result of Copy-Paste. <br><br><h2>  Duplicate condition </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V571/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V571/">V571</a> Recurring check.  The 'isDirectory' condition was already verified in line 166. FileSystem.cpp 169 <br><br><pre> <code class="cpp hljs">FileSystem::Dir&amp; FileSystem::getContents(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; path, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> forceUpdate) { <span class="hljs-comment"><span class="hljs-comment">// Does this path exist on the real filesystem? if (exists &amp;&amp; isDirectory) // &lt;= { // Is this path actually a directory? if (isDirectory) // &lt;= { .... } .... } .... }</span></span></code> </pre> <br>  The <i>isDirectory</i> condition is checked twice.  You can remove duplicate checks. <br><br><h2>  Bitwise And with a zero constant </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V616/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V616/">V616</a> The 'SPELL_DAMAGE_CLASS_NONE' is not used in the bitwise operation.  Spell.cpp 674 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Spell::prepareDataForTriggerSystem() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsPositiveSpell(m_spellInfo-&gt;Id)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_spellInfo-&gt;DmgClass &amp; SPELL_DAMAGE_CLASS_NONE) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { m_procAttacker = PROC_FLAG_DONE_SPELL_NONE_DMG_CLASS_POS; m_procVictim = PROC_FLAG_TAKEN_SPELL_NONE_DMG_CLASS_POS; } } .... }</span></span></code> </pre> <br>  The constant <i>SPELL_DAMAGE_CLASS_NONE</i> has a zero value, and the bitwise AND of any number and zero is zero, hence the condition will always be <i>false</i> , and the block following it will never be executed. <br><br>  Similar error: <br><br><ul><li>  V616 The 'SPELL_DAMAGE_CLASS_NONE' named after it is used in the bitwise operation.  Spell.cpp 692 </li></ul><br><h2>  Potential null pointer dereference </h2><br>  <b>PVS-Studio</b> <a href="http://www.viva64.com/ru/w/V595/">warning</a> <b>:</b> <a href="http://www.viva64.com/ru/w/V595/">V595</a> The 'model' pointer was used before it was verified against nullptr.  Check lines: 303, 305. MapTree.cpp 303 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> StaticMapTree::InitMap(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; fname, VMapManager2* vm) { .... WorldModel* model = vm-&gt;acquireModelInstance(iBasePath, spawn.name); model-&gt;setModelFlags(spawn.flags); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... if (model) // &lt;= { .... } .... }</span></span></code> </pre> <br>  The <i>model</i> pointer is checked for <i>null</i> , i.e.  its equality to zero is allowed, however, the above pointer is already used and without any checks.  There is a potential null pointer dereference. <br><br>  To correct this error, you should check the value of the <i>model</i> pointer before calling the <i>model-&gt; setModelFlags (spawn.flags) method</i> . <br><br>  Similar warnings: <br><br><ul><li>  V595  Check lines: 374, 375. MapTree.cpp 374 </li><li>  V595  Check lines: 272, 290. Object.cpp 272 </li><li>  V595 The 'updateMask' pointer was used before it was verified against nullptr.  Check lines: 351, 355. Object.cpp 351 </li><li>  V595 The 'dbcEntry1' pointer was used before it was verified against nullptr.  Check lines: 7123, 7128. ObjectMgr.cpp 7123 </li></ul><br><h2>  Conclusion </h2><br>  PVS-Studio as always found many suspicious places and errors in the code.  I hope the CMaNGOS developers will correct all the shortcomings, as well as begin to constantly use static analysis in their project, since a one-time check is not so effective. <br><br>  I also remind you that now anyone can take advantage of the <a href="http://www.viva64.com/ru/b/0457/">free</a> use of PVS-Studio subject to the conditions described by the link. <br><br>  PS You can offer to check with our analyzer any project that is interesting for you via the feedback form or using GitHub.  Details on the <a href="http://www.viva64.com/ru/b/0473/">link</a> . <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0476/"><img src="https://habrastorage.org/getpro/habr/post_images/35e/064/ddf/35e064ddf91f5d99b620384893909ff7.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Bredikhin Egor.  <a href="http://www.viva64.com/en/b/0476/">Checking the World of Warcraft CMaNGOS open source server</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/321814/">https://habr.com/ru/post/321814/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321802/index.html">Dmitry Sorin, Senior Software Engineer at Atlassian, shared his impressions of five years of work at Yandex</a></li>
<li><a href="../321804/index.html">Acquaintance with Styled components</a></li>
<li><a href="../321808/index.html">Webinar: Introduction to Singularity</a></li>
<li><a href="../321810/index.html">The best architecture based on Docker and Kubernetes - myth or reality?</a></li>
<li><a href="../321812/index.html">Welcome to Tarantool Meetup March 2</a></li>
<li><a href="../321816/index.html">Practical techniques for using multi-thread computing when working with the Revit API</a></li>
<li><a href="../321818/index.html">Online store at 1C-Bitrix and box office: the requirements of the law 54-FZ</a></li>
<li><a href="../321820/index.html">Has MVC died for the frontend?</a></li>
<li><a href="../321822/index.html">Web animation: where, why and why</a></li>
<li><a href="../321824/index.html">The refactoring of the J.Money payment process - the awakening of force</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>