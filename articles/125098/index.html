<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostSharp. Delayed dependency loading</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="You probably have written more than one piece of code below. And what is more likely - dozens of times. This is usually written when you need to use s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostSharp. Delayed dependency loading</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/d0ce3ca2/c668557b/136b280e/8a771525.png" align="left">  You probably have written more than one piece of code below.  And what is more likely - dozens of times.  This is usually written when you need to use some kind of repository that will provide data for your application.  If you have little time and you are in a hurry, this is a great way to get something in such a way that it will be loaded into memory only when you need it, but not earlier (for example, the save operation entailed a call to the serialization subsystem, however, before that, it was not needed).  And in fact, it turns out that on the one hand this piece of code is the same, and on the other, it has to be written more than once. <br>  As a rule, I and many programmers prefer to use an IoC container in this place to solve problems of this kind.  However, it is not always so easy to do, especially when I program in the absence of Dependency Injection in the library I use (WinForms, WebForms, ...).  Let's <a href="http://sharpcrafters.com/">see</a> why solving this problem without using <a href="http://sharpcrafters.com/">PostSharp</a> , you will spend much more time and do more work. <br><a name="habracut"></a><br><img src="https://habrastorage.org/getpro/habr/post_images/afa/19d/045/afa19d045b2bce238895a5f2856f9174.gif"><br>  So, how often did you come across such code: <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">private</font> IProductRepository _productRepository; <br> <font color="#0000ff">private</font> IProductRepository ProductRepository <br> { <br> <font color="#0000ff">get</font> <br> { <br> <font color="#0000ff">if</font> (_productRepository == <font color="#0000ff">null</font> ) <br> { <br> _productRepository = <font color="#0000ff">new</font> ProductRepository(); <br> } <br> <font color="#0000ff">return</font> _productRepository; <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  While the property is of type IPropertyRepository, the getter of this property is still tightly bound to the ProductRepository type.  If you need to change ‚Äúnew ProductRepository ()‚Äù to ‚Äúnew RevisedProductRepository ()‚Äù or to ‚Äúnew ProductRepository (2011)‚Äù, you will need to go through all places of the template code and update it.  Of course, the hands immediately reach for Find-&gt; Replace, Copy-&gt; Paste ... However, you all know this situation, right?  Firstly, you will spend a lot of time on replacements, and secondly, almost every member of your team will have to do this (when you have to make regular replacements).  And, since everyone is already actively using IoC containers, you might think that this example is exaggerated.  But believe me, such examples are very common!  Anyway, using the IoC container, we get the following code: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">private</font> IProductRepository _productRepository; <br> <font color="#0000ff">private</font> IProductRepository ProductRepository <br> { <br> <font color="#0000ff">get</font> <br> { <br> <font color="#0000ff">if</font> (_productRepository == <font color="#0000ff">null</font> ) <br> { <br> _productRepository = ObjectFactory.GetInstance&lt;IProductRepository&gt;(); <br> } <br> <font color="#0000ff">return</font> _productRepository; <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Now, as you can see, ObjectFactory takes care of creating new instances.  If you need to create new instances of the class, add parameters to the designer and perform other operations during the creation of your object, you can do it in one place without affecting other parts of the program (I‚Äôll just note that ‚ÄúObjectFactory‚Äù is a static class in <a href="http://structuremap.net/">StructureMap</a> . However, you can use absolutely any IoC container which one you like best).  Now our code looks much better, and the development team doesn't have to worry much about implementation: only about the interface.  This is the real inversion of dependence, since  Now the class depends only on the interface, not on the implementation. <br>  The code has become much cleaner, but still contains ‚Äúnull‚Äù checks and lazy initialization that will be found throughout our application (if we use lazy loading quite often, of course).  Also, it‚Äôs not so easy for us to change the same IoC container, if it stopped arranging us.  And if at some point you decided that checking for null is not enough (for example, your program has become multitask), you will again have to crawl all over the code and change, change, change ... Let's see how you can finally solve this problem using <a href="http://sharpcrafters.com/">PostSharp</a> : <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[LoadDependency] <font color="#0000ff">private</font> IProductRepository _productRepository; <br> <br> [ <font color="#2B91AF">Serializable</font> ] <br> <font color="#0000ff">public</font> <font color="#0000ff">sealed</font> <font color="#0000ff">class</font> LoadDependencyAttribute : LocationInterceptionAspect <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> OnGetValue(LocationInterceptionArgs args) <br> { <br> args.ProceedGetValue(); <font color="#008000">// fetches the field and populates the args.Value</font> <br> <font color="#0000ff">if</font> (args.Value == <font color="#0000ff">null</font> ) <br> { <br> <font color="#0000ff">var</font> locationType = args.Location.LocationType; <br> <font color="#0000ff">var</font> instantiation = ObjectFactory.GetInstance(locationType); <br> <br> <font color="#0000ff">if</font> (instantiation != <font color="#0000ff">null</font> ) <br> { <br> args.SetNewValue(instantiation); <br> } <br> args.ProceedGetValue(); <br> } <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Now we have a declarative approach to using dependencies.  You just mark any field with the attribute ‚ÄúLoadDependency‚Äù, and it will be initialized by the IoC container during the first call (see the first line).  Thus, you protected yourself from constantly writing template code for each property that would use lazy-loading, null checks, thread-safety, and other other changes that you would have to do, write each property separately.  Now all your actions will be in the same class. <br>  Using a very simple and small (only 19 lines) aspect, we compressed the resulting code from 12 lines to one.  We removed a lot of senselessly repeating code ( <a href="http://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a> ) and replaced hard dependencies with clean interfaces ( <a href="http://en.wikipedia.org/wiki/Dependency_inversion_principle">DIP</a> ).  We brought the lazy-loading to our own class, and the resolution of dependencies to our own ( <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">SRP</a> ).  Reducing, thus, the number of dependencies to a minimum. <br>  This very simple example actually helps a lot in my daily development and makes it much easier. <br>  Now, let's assume that all dependencies are known at the compilation stage.  Also assume that the dependencies will not change while the application is running.  In this case, we no longer need the Service Locator.  We can override the CompileTimeInitialize method from LocationInterceptionAspect to resolve dependencies at compile time and save the type to some field.  Then, while the application is running, you can use Activator.CreateInstance to create the desired object. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[ <font color="#2B91AF">Serializable</font> ] <br> <font color="#0000ff">public</font> <font color="#0000ff">sealed</font> <font color="#0000ff">class</font> LoadDependencyAttribute : LocationInterceptionAspect <br> { <br> <font color="#0000ff">private</font> Type _type; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">bool</font> CompileTimeValidate(PostSharp.Reflection.LocationInfo locationInfo) <br> { <br> _type = DependencyMap.GetConcreteType(locationInfo.LocationType); <br> <font color="#0000ff">if</font> (_type == <font color="#0000ff">null</font> ) <br> { <br> Message.Write(SeverityType.Error, <font color="#A31515">"002"</font> , <br> <font color="#A31515">"A concrete type was not found for {0}.{1}"</font> , <br> locationInfo.DeclaringType, locationInfo.Name); <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> OnGetValue(LocationInterceptionArgs args) <br> { <br> args.ProceedGetValue(); <br> <font color="#0000ff">if</font> (args.Value == <font color="#0000ff">null</font> ) <br> { <br> form.LogListBox.Items.Add( <font color="#A31515">"Instantiating UserService"</font> ); <br> args.SetNewValue(Activator.CreateInstance(_type)); <br> args.ProceedGetValue(); <br> } <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  If you have not configured any type, then you will get an error at the compilation stage, and not at the application operation stage, which is very convenient.  I hope that you are already beginning to understand that PostSharp is a very powerful tool.  Of course, I am not interested in using this method everywhere, where it is necessary or not necessary.  However, I am sure that it is useful in many circumstances. <br>  Another way to improve the resulting aspect is to make a check at compile time that the aspect is correctly used.  For example, it makes no sense to use the LoadDependency aspect for applied to a field if this field is not an interface.  Because it would mean that our dependencies are hard-coded and it is necessary to change everything again!  :) So let's add a couple of extra checks: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">bool</font> CompileTimeValidate(PostSharp.Reflection.LocationInfo locationInfo) <br> { <br> <font color="#0000ff">if</font> (!locationInfo.LocationType.IsInterface) <br> { <br> Message.Write(SeverityType.Error, <font color="#A31515">"001"</font> , <br> <font color="#A31515">"LoadDependency can only be used on Interfaces in {0}.{1}"</font> , <br> locationInfo.DeclaringType, locationInfo.Name); <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> <br> _type = DependencyMap.GetConcreteType(locationInfo.LocationType); <br> <font color="#0000ff">if</font> (_type == <font color="#0000ff">null</font> ) <br> { <br> Message.Write(SeverityType.Error, <font color="#A31515">"002"</font> , <br> <font color="#A31515">"A concrete type was not found for {0}.{1}"</font> , <br> locationInfo.DeclaringType, locationInfo.Name); <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  To get compilation errors, set the ‚ÄúLoadDependency‚Äù attribute for a field that is of any type, but not an interface: <br><br><img src="https://habrastorage.org/storage1/a6e07413/f4b7fd35/0fa4075f/9f7a05f1.png"><br><br>  So, with a simple aspect coupled with an IoC container, we got rid of hard dependencies and sample code and made our application easy to maintain, easy to test and read the source code.  And now, no less important, our application fully follows the principles of SOLID.  Now you save a lot of time, not only at the stages of development and testing, but also at the support stage. <br><br>  Other translations and links: <br><ul><li>  <a href="http://www.sharpcrafters.com/">Official site</a> </li><li>  <a href="http://habrahabr.ru/blogs/net/124860/">PostSharp.</a>  <a href="http://habrahabr.ru/blogs/net/124860/">Problem solving logging and auditing</a> </li><li>  <a href="http://habrahabr.ru/blogs/net/123480/">We solve the problem of caching</a> </li><li>  <a href="http://software.intel.com/ru-ru/blogs/2010/03/09/postsharp-i/">Intel blogs: PostSharp.</a>  <a href="http://software.intel.com/ru-ru/blogs/2010/03/09/postsharp-i/">Part 1</a> </li><li>  <a href="http://software.intel.com/ru-ru/blogs/2010/03/16/postsharp/">Intel blogs: PostSharp.</a>  <a href="http://software.intel.com/ru-ru/blogs/2010/03/16/postsharp/">Alternatives</a> </li><li>  <a href="http://habrahabr.ru/blogs/net/123186/">Aspect-oriented programming vs Dependency Injection</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/125098/">https://habr.com/ru/post/125098/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125091/index.html">When, where and how to run</a></li>
<li><a href="../125094/index.html">IBM's electric typewriter turns 50</a></li>
<li><a href="../125095/index.html">Especially for the participants of the contest "System administrator 2011"</a></li>
<li><a href="../125096/index.html">How to teach Wordpress engine to be friends with Proxy? Easy!</a></li>
<li><a href="../125097/index.html">Visual Studio LightSwitch tutorials published</a></li>
<li><a href="../125099/index.html">Keyboard overview for PS3 controller</a></li>
<li><a href="../125100/index.html">Today July 28 Online dismantled on screws: iOs and Android, AppStore and Android Market</a></li>
<li><a href="../125101/index.html">Jelastic is a new kind of Java hosting platform</a></li>
<li><a href="../125102/index.html">Toodledo updated its design</a></li>
<li><a href="../125103/index.html">Should I use Russian letters in the writing of CNC - human-readable URLs?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>