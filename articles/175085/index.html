<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Judy arrays in php</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Badoo uses many services in C and C ++, most of which work with huge amounts of data. As a rule, services act as a ‚Äúfast cache‚Äù or ‚Äúfast database‚Äù, i....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Judy arrays in php</h1><div class="post__text post__text-html js-mediator-article"> <a href=""><img src="https://habrastorage.org/storage2/62d/f97/936/62df979364091283db537371e21842fd.jpg" align="left"></a>  Badoo uses many services in C and C ++, most of which work with huge amounts of data.  As a rule, services act as a ‚Äúfast cache‚Äù or ‚Äúfast database‚Äù, i.e.  perform various operations with arrays of the same type.  For quick access to data, we have long and successfully used Judy arrays (eng. Judy arrays).  But once we wanted a strange one: to process large arrays of integers in PHP, and we immediately remembered Judy. <br><br><h5>  A bit of history </h5><br>  Judy arrays were invented by Douglas Baskins in the early 2000s.  The project of their development was funded by HP, but after about two years it was closed.  During this time, four versions were released, and the development of the latter took more than a year, and in it the developers were able to double the speed of Judy, reduce memory consumption by half, although it was a difficult price: the amount of code increased 5 times and its complexity - on order. <br><a name="habracut"></a><br>  The algorithm of the Judy-arrays is <a href="http://www.google.com/patents/US6735595">patented</a> , but the original implementation in C is available on the <a href="http://judy.sourceforge.net/">official site</a> under the LGPL license. <br>  The project was named after the sister of Baskins, because the developers could not come up with a better option. <br><br><h5>  Tree-trees </h5><br>  In truth, Judy arrays are not actually arrays.  Judy is the development of <a href="http://en.wikipedia.org/wiki/Trie">trie</a> , i.e.  prefix tree, using different compression techniques.  Judy arrays compare favorably with C arrays and standard implementations of hash arrays: sparse Judy arrays use memory efficiently and scale well, while showing comparable read and write speeds (see <a href="http://www.nothings.org/computer/judy/">benchmarks</a> ). <br>  A detailed description of Judy‚Äôs work algorithm is unlikely to fit into the article format for Habr, so we‚Äôll just leave the links to the official documentation: <a href="http://judy.sourceforge.net/doc/10minutes.htm">1</a> and <a href="http://judy.sourceforge.net/doc/shop_interm.pdf">2</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are several types of judy arrays: <br><ul><li>  Judy1 - bitmap (bitmap), the index is an integer (integer-&gt; bit); </li><li>  JudyL - an array with an integer as an index (integer-&gt; integer / pointer); </li><li>  JudySL - an array of pointers with a string as an index (string-&gt; integer / pointer); </li><li>  JudyHS is an array of pointers with a byte set as an index (array of bytes-&gt; integer / pointer). </li></ul><br>  Judy arrays do not require initialization, and an empty array is a simple NULL pointer.  The consequence of this is that Judy arrays are conveniently nested.  So convenient that JudySL and JudyHS are actually nested arrays of JudyL. <br><br><h5>  Benchmarks </h5><br>  Embedded <a href="http://php.net/array">arrays in PHP</a> are universal and, as a result, extremely inefficient in some cases.  Compared to Judy, they are rather trivially implemented: these are hash arrays with a doubly linked list inside each element in case of hash collisions.  PHP arrays are stored in PHP variables, i.e.  pointers to <a href="http://php.net/manual/ru/features.gc.refcounting-basics.php">zval</a> structures.  In most cases, this is exactly what is required of them, but there are exceptions. <br>  To demonstrate why we decided to use Judy, we will conduct comparative testing of Judy and PHP arrays.  As an interface to Judy from PHP, we use the <a href="http://pecl.php.net/package/Judy">php-judy module</a> , which implements the Judy class with the implementation of the ArrayAccess interface.  In the test, create arrays of the form integer -&gt; integer (array (), Judy :: INT_TO_INT, Judy :: INT_TO_MIXED) or integer-&gt; boolean (Judy :: BITSET) and fill them with elements with sequential keys. <br>  To begin, measure the write speed to arrays with the help of a similar code: <br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $arr = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">10000000</span></span>; $i++) {  $arr[] = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br> <a href="http://daylessday.org/graph/judy_writes.html"><img src="https://habrastorage.org/storage2/cc0/14b/7dc/cc014b7dcd9593ec2da72d3556ea29e5.png" alt="image"></a> <br><br>  See interactive schedule <a href="http://daylessday.org/graph/judy_writes.html">here</a> . <br>  Peaks when writing array () are caused by doubling the size of the array and rebuilding it when filling all the elements of the hash.  The small elevations in the Judy graphs can be explained by the measurement error. <br>  From the graph it is clear that different types of judy are approximately equal in speed to the built-in array.  The only exception is BITSET (Judy1), which is slightly faster. <br><br>  Then measure the sequential read speed from arrays: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   ,        */</span></span> $arr = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">10000000</span></span>; $i++) { $val = $arr[$i]; } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br> <a href="http://daylessday.org/graph/judy_reads.html"><img src="https://habrastorage.org/storage2/eaa/c49/cdc/eaac49cdcf76d1b110ad803e57b64df3.png" alt="image"></a> <br><br>  See interactive schedule <a href="http://daylessday.org/graph/judy_reads.html">here</a> . <br>  It can be seen from the graph that when reading Judy :: BITSET and Judy :: INT_TO_INT, they slightly lose to the built-in PHP array.  This is because these arrays store bits and integers, respectively, and not PHP variables (i.e., zval).  It is the overhead of creating and filling out variables that robs us of the performance gain. <br>  On the other hand, array () and Judy :: INT_TO_MIXED both have PHP variables inside, and they don‚Äôt have to waste time creating them, so they are roughly equal in speed. <br><br>  Finally, measure the memory consumption when filling in arrays and get the following graph: <br> <a href="http://daylessday.org/graph/judy_memory.html"><img src="https://habrastorage.org/storage2/b74/1a5/6d6/b741a56d6e1c90b308c1f7712e655af7.png" alt="image"></a> <br><br>  See interactive schedule <a href="http://daylessday.org/graph/judy_memory.html">here</a> . <br>  As you can see from the graph, the difference in memory consumption between PHP arrays and Judy1 / JudyL is huge, and for us this is the main criterion in this case, because  we can easily sacrifice some of the speed when reading from the array, having received in return the opportunity to work with much larger arrays that previously did not fit into the server‚Äôs RAM at all. <br>  Thus, the use of Judy-arrays in PHP is justified when solving problems associated with processing large data arrays, especially integers and bits.  In terms of read and write speeds, Judy arrays are not too different from the built-in arrays, but because of the differences in implementation, they use memory much more efficiently. <br>  Anticipating your questions, we note that, despite its clear advantages, Judy arrays are unlikely to be able to replace regular arrays in PHP, if only because the latter can contain both integer indices and lowercase ones, while in Judy this is implemented using two different types of arrays. </div><p>Source: <a href="https://habr.com/ru/post/175085/">https://habr.com/ru/post/175085/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../175073/index.html">Evernote has been speaking Russian for 4 years!</a></li>
<li><a href="../175075/index.html">Squeezing maximum performance out of the keyboard</a></li>
<li><a href="../175077/index.html">The Ministry of Communications prepared SORM equipment requirements for Internet providers</a></li>
<li><a href="../175081/index.html">How much is the active user?</a></li>
<li><a href="../175083/index.html">WEB DESIGN: Personalization</a></li>
<li><a href="../175087/index.html">Why MineCraft is worth using in education</a></li>
<li><a href="../175089/index.html">Order ready meals and any ingredients from "Chefmarket" can be paid using PayOnline</a></li>
<li><a href="../175093/index.html">The third conference for Scala-developers in Petersburg</a></li>
<li><a href="../175095/index.html">As I developed the security system for the airline and I myself was in danger</a></li>
<li><a href="../175097/index.html">The Pirate Bay has become the most popular file sharing service.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>