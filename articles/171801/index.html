<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimize the build of a large project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The problem of increasing the project build time is faced by almost all developers at least once a year. Assembly is not a quick job, which is especia...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimize the build of a large project</h1><div class="post__text post__text-html js-mediator-article">  The problem of increasing the project build time is faced by almost all developers at least once a year.  Assembly is not a quick job, which is especially unpleasant when using the practice of Continuous Integration with its constant reassembly and related activities.  A lengthy build negates all the benefits of continuous integration, and a simple increase in computing power does not always produce the desired effect. <br><br>  In the process of developing and further developing a large heterogeneous project, we also faced optimization problems.  But there must be ways to reduce build time?  We decided to find a way to solve this problem.  Collect in 60 seconds! .. <br><br> <a href="http://habrahabr.ru/company/pt/blog/171801/"><img src="https://habrastorage.org/storage2/6aa/edb/457/6aaedb45776610e7b0c968a8b80dbcab.jpg"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      About what eventually managed to achieve, and will be discussed in our topic. <a name="habracut"></a><br><br><h4>  Start </h4><br>  The key to successful project optimization is its automation.  We used the well-known automation system CMake, on which, as on the foundation of a house, various technologies were built on. <br><br>  Here is what we had at the beginning of the journey: <br><br><ul><li>  176 projects of C ++ and C # (in a ratio of approximately 60% to 40%); </li><li>  100 MB of sources; </li><li>  18,000 files (&gt; 3 million lines); </li><li>  MSVS; </li><li>  server (8 CPU, normal disk on 10 HDD roads, 12 GB of RAM); </li><li>  virtual machine. </li></ul><br>  All this was going for 12 minutes. <br><br>  After optimizing the code based on the results of static analysis, removing unnecessary #include directives, rebuilding executable modules, dynamic and static libraries, the build time was reduced to 8 minutes.  The following discussion focuses on optimizing the build process, when all possible code improvements have already been implemented. <br><br>  To achieve maximum speed, we used two approaches to optimization: hardware and software.  As we show below, the first does not exclude the second at all, but complements it. <br><br><h4>  Program method </h4><br><h5>  Typical methods </h5><br>  <i>About typical customization methods VisualStudio is written a lot on the Internet, so let's touch them casually.</i> <br><br><ul><li>  Key / MP, which allows you to run multiple compilation processes simultaneously. </li><li>  The / Z7 key, which disables the generation of debug information, resulting in compilation is faster. </li></ul><br>  More interesting is the technology known as <b>UnityBuild</b> .  This is one of the most effective software optimization methods, accelerating the assembly by 30%.  In the course of work, we slightly improved this technology and called a new, improved version of Smart UnityBuild. <br><br>  The standard technology works as follows: in each * .cmake file of each project, the module unity_build.cmake is used, which is directed to the folder containing all * .cpp files, processes them and combines them into a new ‚Äúcommon‚Äù file * .cpp.  Next, a * .vcproj file is created that contains this single * .cpp. <br><br>  Our option does not work quite like that.  In some cases (in particular, when working with a large project), creating one common * .cpp-file is not the best option.  Therefore, we decided to generate several files instead of one large one. <br><br>  Schematically it looks like this: <br><br><img src="https://habrastorage.org/storage2/2ac/edc/958/2acedc9587e13251bb92cbf387442f90.png"><br><br>  As a result, the use of our technology Smart UnityBuild allowed us to speed up the assembly to 4 minutes.  40 seconds <br><br><img src="https://habrastorage.org/storage2/fc6/afe/411/fc6afe411c853b079cae0852f7244567.png"><br><br><h5>  UnityBuild + PCH (Incredibuild) </h5><br>  It is obvious that the use of PCH in conjunction with the UnityBuild technology, which is called in the forehead, will not give anything.  But still there is a way to trick VisualStudio.  To do this, you need to artificially bring the files used in the project several times (we have * .boost and * .spl) into a separate project, assemble Precompiled Headers from it and put them into the main project, as a result VisualStudio will ‚Äúthink‚Äù that these are real PCH.  When using Unity Build technology with Precompiled Headers and the LP key, you can achieve a significant reduction in build time: in our case, from 12 minutes.  up to 4 min.  38 seconds  (without LP key - 5 min. 53 sec.). <br><br><h4>  Hardware method </h4><br>  Reduce the time to build a project can, of course, not only by combining different technologies.  The process can also be significantly accelerated by optimizing the operation of server hardware. <br><br><h5>  SSD RAID0 x 7 </h5><br>  The best result in terms of assembly time was achieved with the use of 7 SSD drives in the Raid0 array and RAMDisk: the duration of the project assembly was about 6 minutes. <br><br><h5>  32 CPU x 3 GHz </h5><br>  The increase in speed more than doubled compared with the standard time value (7 min. 45 sec.) Gives the use of 32 processors with Hyper Threading technology (3 min. 22 sec.). <br><br><img src="https://habrastorage.org/storage2/5d8/93a/47e/5d893a47ec3a348da26e1f2cdf69aa14.png"><br><br><h4>  Total </h4><br>  By combining all means from Visual Studio options to using SSD drives, we were able to reduce the project build time from 12 minutes to 1 minute.  45 seconds  Thus, the stated goal - to keep within 60 seconds - remained unfulfilled, but we were not upset :) Reducing the time spent on assembling a project by more than 6 times is a good result. <br><br>  Here is the progress of the assembly of our project: <br><br><img src="https://habrastorage.org/storage2/6c0/b16/a95/6c0b16a95da6fd569d17e0a8ffcd94d8.jpg"><br><br>  From the diagram it is clear that several time-consuming processes interfere with the achievement of even greater speed.  This is a linkage of large modules, which cannot be parallelized (only a partial attempt to do this in MSVS 2012), but you can programmatically break them into several small ones, reduce the number and size of static libraries. <br><br>  That's all.  We did not have a goal to embrace the immense, and some technical aspects of optimization were not included in the article.  We are ready to reveal the details and answer all the questions (including cmake source code) in the comments.  Thank you for your attention! <br><br>  PS The thoughts expressed in this topic formed the basis for the presentation, which Viktor Strelkov (Head of Research and Quality Control at Positive Technologies) presented at the CEE-SECR conference in November 2012.  A recording of the broadcast of this speech can be viewed on <a href="http://www.secr.ru/talks/comprehensive-approach-to-optimizing-large-project-compilation">the event website</a> . </div><p>Source: <a href="https://habr.com/ru/post/171801/">https://habr.com/ru/post/171801/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171785/index.html">And again the same question: laser or inkjet printing?</a></li>
<li><a href="../171787/index.html">My sales experience on the App Store. $ 29K for 15 months</a></li>
<li><a href="../171793/index.html">Surfingbird Pro, PostgreSQL Weird Sites</a></li>
<li><a href="../171795/index.html">Question to IT departments: how would you like to see a service for BYOD?</a></li>
<li><a href="../171799/index.html">The first wireless implantable computer-brain interface</a></li>
<li><a href="../171805/index.html">Abstraction Generator - Video Review</a></li>
<li><a href="../171807/index.html">Why do people call the Internet</a></li>
<li><a href="../171809/index.html">Microsoft contest for BizSpark startups</a></li>
<li><a href="../171813/index.html">A bug with position: fixed and backface-visibility in Firefox</a></li>
<li><a href="../171815/index.html">VMware vSphere VAAI - who is he?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>