<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Homemade USB whistle with microphone, STM32 and ESP8266 on board</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to tell about my small project of the day off, highlight the difficulties that I had to face, further plans and get advice from more experience...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Homemade USB whistle with microphone, STM32 and ESP8266 on board</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/8d5/2d1/45a/8d52d145aa4741d5bcbf46bb18f7845c.JPG" alt="image" align="left" width="320">  I want to tell about my small project of the day off, highlight the difficulties that I had to face, further plans and get advice from more experienced Habrayusers.  The format of the article survey, so to speak, at a gallop across Europe.  If there is interest, I will go more in detail on separate parts. <br><br>  <b>Briefly describe the operation of the device can be as follows:</b> <br><br>  Electret Microphone ‚Üí Max9812 Amplifier ‚Üí STM32F103 Microcontroller ‚Üí Software Detection of Audio Presence ‚Üí Audio Encoding in Speex ‚Üí Sending to ESP8266 to Server ‚Üí PHP Data Acquisition Script and Formatting in Ogg Audio Container.  Who cares, I ask under the cat. <br><a name="habracut"></a><br>  <b>Why is all this necessary?</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The very idea of ‚Äã‚Äãthe device I came to the birth of a daughter.  In the future, I want to make some kind of baby monitor: I plug it into the outlet next to the baby cot, and you watch the TV serial in another room, then the hop - a notification message came to the phone and you can listen to what is happening there.  But on the implementation of the last points I have more questions than answers.  More on that later. <br><br>  Perhaps someone will see another use for such an article, but I assure you that the <b>device is not created for the purpose of secretly obtaining information (Art.138.1 of the Criminal Code of the Russian Federation) and any such attempt will be prosecuted by law</b> . <br><br>  I‚Äôll ask you not to criticize the idea right away, I need to work with sound and Wi-Fi in another project that I‚Äôm just thinking about.  And this is a separate piece, implemented into an independent device. <br><br>  <b>Housing</b> <br><br><img src="https://habrastorage.org/files/581/9ee/29d/5819ee29d1c141d299561b73811ea6c1.jpg" alt="image" align="right" width="320">  According to the ‚ÄúDesign first‚Äù principle, I began to think about how to make a device.  In search of ready-made cases, Ali stumbled upon cases for usb with a cable hole and thought to himself that this was an ideal option - a microphone would take up a hole, and let us stick the rest somehow. <br><br>  Only here I did not want to order 10pcs for $ 5 and started looking for options.  As a result, I ordered the USB-RS485 adapter in exactly this package for $ 0.84.  And the adapter itself is useful at work, and then the Bolids, worth 1.5 thousand rubles, go as an expendable material. <br><br>  <b>We buy everything you need</b> <br><br>  First, when I got acquainted with the subject area of ‚Äã‚Äãthe upcoming crafts, I came across the article <a href="https://geektimes.ru/post/257382/">Speech Recognition on STM32F4-Discovery</a> .  There I read about the Speex codec and its application on microcontrollers.  I admit, this is my first experience with STM microcontrollers. <br><br><img src="https://habrastorage.org/files/daa/439/cbb/daa439cbb9c54349b41db5802cd6ca58.jpg" alt="image" align="right" width="320">  So, we order the most common debugging with the STM32F103C8T6 microcontroller, the St-link v2 debugger to it, we finish it on the knee and we can already live.  According to rough estimates, the resources of the STM32F103C8T6 should have been enough, but speex is very voracious, and the HAL drivers themselves are not that compact, in general the memory for all libraries was not enough.  The final device is STM32F103CBT6 with double the number of flash. <br><br>  Secondly, you need a microphone.  We take the max9812 microphone module with the first line in the search, and in the appendage there is a handful of more miniature microphones of the standard size 6050 (after all, we already have a case with an opening where this microphone should go). <br><br>  Thirdly, you need to pick up the module wi-fi, but such that got into the purchased case.  The choice was made on a miniature ESP-03 with a ceramic antenna and a few pieces of ESP-12 for prototyping. <br><br>  <b>Layout and programming</b> <br><br><img src="https://habrastorage.org/files/e12/7b3/ff9/e127b3ff9c7c445eaa03211cda89c6e3.jpg" alt="image" align="left" width="290">  In STM32CubeMX, we quickly assemble the necessary peripherals and move on; in the process, we still often have to go back to Cuba.  The main thing here is to write code in specially designated places / * USER CODE * / and then the new generation of the project will not affect the already written one. <br><br>  Sampling of the ADC goes through the DMA on the timer trigger at a frequency of 8 kHz into two circular buffers with a size of 160 samples, one buffer is obtained equal to 20 ms.  Faced a moment that I did not know and lost time on it: DMA continues to work on the debugger breakpoint, with both the HT (half transfer) and TC (transfer complete) flags set, and the buffers are always full. <br><br>  Speex did not immediately understand the library, the controller constantly flew to HardFault.  It turned out just not enough stack sizes and heaps.  Found Application Note from Silicon Labs with a description of the necessary resources for encoding / decoding, at the end of the article there is a link.  Set values ‚Äã‚Äãwith a small margin of CSTACK 0x800 and HEAP 0x1600.  At the coding output, we get a frame size of 20 bytes.  We collect them in packages for sending. <br><br>  The Esp8266 module can accept no more than 2048 bytes of data at a time.  Send command format: POST header + data.  I limited the size of the data packet to 1,800 bytes (90 frames by 20 ms). <br><br>  Received data made in PHP.  I was ashamed to upload the code, especially since this is my first experience of the PLO in life.  Please do not heytit, this is not my area, better teach how to properly.  The essence of the script is to take data from php: // input, form a header, calculate the necessary checksums and save everything to the Ogg file (either finish the old one or create a new one).  But I have a terrible premonition that it is very stupid to receive audio through POST requests ... <br><br>  Question to the community: what do you recommend for the server part?  In the future, I want to receive stream audio in real time.  I personally have a slight desire to get acquainted with Node.js. <br><br>  And on github there is a speex <a href="">JS</a> decoding library on the fly, but I don‚Äôt know how to use it yet.  Maybe someone will tell you how to work with it.  But here's another question: will iOS play it?  An example of a recorded sound is in <a href="https://github.com/oWartForHabr/AudioWiFi">the project repository on Github</a> . <br><br>  <b>Schematic diagram and PCB layout</b> <br><br>  I drew the scheme and layout in the free version of Eagle CAD, since the board size is small.  Here they are.  No comments. <br><br><img src="https://habrastorage.org/files/38e/410/922/38e410922af7469e860003051bda9305.jpg" alt="image"><br><br><img src="https://habrastorage.org/files/0bc/272/c8d/0bc272c8d9b0495b952181b8f64e0ec2.jpg" alt="image"><br><br>  <b>Order boards</b> <br><br><img src="https://habrastorage.org/files/b14/22a/121/b1422a12164944efa6bd4a6c419d32d3.jpg" alt="image" align="right" width="250">  Boards ordered in American <a href="https://geektimes.ru/post/259706/">OSH Park</a> .  What is remarkable about this service is the fact that the price is based on the size of the board ($ 5 per square inch), and the delivery is free.  On top of that, you can load the .brd file itself from the Eagle to the site and there is a preview, you do not need to overtake it in Gerber. <br><br>  It turned out 3 fees for $ 3.35.  For the mock-up sample, it is more profitable than to overpay the Chinese for $ 15 for unnecessary 10pcs.  Until now, houses are lying mountains of unnecessary fees from other projects.  And besides, it all came in a corporate package with candies inside.  Trifle, but nice.  The track number was not reached 40 days from the date of order.  There were 10 days in production (from December 29 to January 9, perhaps the holidays somehow affected the timing). <br><br>  I was pleased with the quality of the boards.  Tracks 8 mil.  Transient 13 mil.  The boards came with gilding, the layer of the mask relative to the sites is flat everywhere. <br><br>  <b>Build and configure</b> <br><br>  I still do not understand what is the matter, but the Esp-03 module practically does not catch the signal, which is strange in the presence of a ceramic antenna and the distance to the phone (which at work acts as a wi-fi distributor) within half a meter, while the module heats up noticeably.  When you bring the phone close starts to detect the network and connects to it.  Order a new or what could be the case? <br><br><img src="https://habrastorage.org/files/875/0dd/1e1/8750dd1e1039437da33b9fb4705b3015.jpg" alt="image"><br><br>  <b>Future plans</b> <br><br>  1. Modify the VAD algorithm (Voice Activity Detection, recording when sound is detected) to a more adequate one. <br>  2. Check the ability to play sound on the phone. <br>  3. Make it possible to configure remotely.  Now it is implemented by a server response (Settings = 40.2000.10,), where the sensitivity of the current VAD algorithm is set (the signal should exceed 2000 bubook 40 times) and the recording duration in seconds. <br><br>  <b>Final option</b> <br><br><img src="https://habrastorage.org/files/2d5/a5c/987/2d5a5c987de1453083d04c5955b4f8a0.jpg" alt="image"><br><br>  <b>Costing</b> <br>  $ 2.03 - ESP-03 Module <br>  $ 2.13 - STM32F103CBT6 microcontroller <br>  $ 0.39 - Microphones size 6050 <br>  $ 1.12 - microphone module with MAX9812 and strapping <br>  $ 0.84 - USB-RS485 converter (case + usb type A male) <br>  $ 0.50 - NCP3335A 3.3V Stabilizer <br><br>  Total: $ 7.01 (~ 420 rubles) for one device. <br><br>  Prices may vary due to the latest developments on Ali.  The cost does not include the programmer and spreading. <br><br>  <b>Materials</b> <br><br>  1. <a href="https://github.com/xDWart/AudioWiFi">The repository with the project on Github</a> <br>  There are projects CubeMX, IAR, Eagle, PHP, as well as an example of recorded sound.  You may need drivers for playback, but I don‚Äôt remember what I put in what order, look on the Internet. <br>  2. <a href="https://speex.org/docs/manual/speex-manual.pdf">Speex Codec Manual</a> <br>  3. <a href="https://www.silabs.com/documents/public/application-notes/AN0055.pdf">Application Note from Silicon Labs</a> <br><br>  <b>Thanks for attention!</b> <br><br>  Questions and suggestions write to the comments.  Also contact or telegram is allowed, there is only one nickname. <br><br>  <b>Continued:</b> <a href="https://habrahabr.ru/post/323598/">Audio digitization on STM32 (ADC + DMA) and Speex encoding for transmission</a> </div><p>Source: <a href="https://habr.com/ru/post/373235/">https://habr.com/ru/post/373235/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../373223/index.html">Universe Female Geek</a></li>
<li><a href="../373225/index.html">How Beeline networks have become a headache for installers</a></li>
<li><a href="../373227/index.html">Ask Ethan: Is it true that there is a hole in the universe?</a></li>
<li><a href="../373231/index.html">AI becomes an insurance agent</a></li>
<li><a href="../373233/index.html">Inception neural network saves women's breasts by gigapixel photos</a></li>
<li><a href="../373237/index.html">Overview of the new Aftershokz Sportz Titanium: another bone conduction headset that can be tied into a knot</a></li>
<li><a href="../373239/index.html">Why translators do not need to be afraid of Google‚Äôs neural networks</a></li>
<li><a href="../373241/index.html">AMD announced a 32-core server processor Naples</a></li>
<li><a href="../373243/index.html">Scientists have confirmed the possibility of growing potatoes on Mars</a></li>
<li><a href="../373245/index.html">Google introduced the cloud API for object recognition on video</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>