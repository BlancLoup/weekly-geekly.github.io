<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Push non-ASCII to inappropriate locations.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I was sitting at home in the evening, thinking what to do. BUT! Python has a debugger, but it has a completely ugly prompt for input. Let me get the p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Push non-ASCII to inappropriate locations.</h1><div class="post__text post__text-html js-mediator-article">  I was sitting at home in the evening, thinking what to do.  BUT!  Python has a debugger, but it has a completely ugly prompt for input.  Let me get the powerline in there.  The case would seem quite trivial: you just need to create your own subclass of <a href="https://docs.python.org/2.7/library/pdb.html">pdb.Pdb</a> with your <a href="https://docs.python.org/2.7/library/functions.html">property</a> , right? <pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use_powerline_prompt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">'''Decorator that installs powerline prompt to the class '''</span></span> @property <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prompt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: powerline = self.powerline <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> AttributeError: powerline = PDBPowerline() powerline.setup(self) self.powerline = powerline <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> powerline.render(side=<span class="hljs-string"><span class="hljs-string">'left'</span></span>) @prompt.setter <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prompt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, _)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> cls.prompt = prompt <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cls</code> </pre> <a name="habracut"></a>  Not.  On Python-3, such code can still work, but on Python-2, the problem is already waiting for us: for output, it is necessary to turn the <a href="https://docs.python.org/2.7/library/functions.html">Unicode string</a> into a <a href="https://docs.python.org/2.7/library/functions.html">set of bytes</a> , which requires an indication of the encoding.  Well, it's simple: <pre> <code class="python hljs">encoding = get_preferred_output_encoding() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prompt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> ‚Ä¶ ret = powerline.render(side=<span class="hljs-string"><span class="hljs-string">'left'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(ret, str): <span class="hljs-comment"><span class="hljs-comment"># Python-2 ret = ret.encode(encoding) return ret</span></span></code> </pre>  .  It's simple and it works ... until the user installs <a href="">pdbpp</a> .  Now we are greeted by a number of errors related to the fact that pdbpp can use pyrepl, and pyrepl does not work with Unicode (and whether pyrepl will be used somehow depends on the value of <code>$TERM</code> ).  Errors related to the fact that in the invitation someone does not want to see Unicode are not new - even IPython tried to disable Unicode in the rewrite prompt¬≤.  But here everything is much worse: pyrepl uses <a href="https://docs.python.org/2.7/library/__future__.html"><code>from __future__ import unicode_literals</code></a> , while doing using ordinary strings (turned by this import into Unicode) various operations on the prompt string, which is explicitly convertible into <code>str</code> at the very beginning. <br><br>  So, this is what we need: <ol><li>  A <code>unicode</code> descendant class that would be converted to <code>str</code> without throwing errors on non-ASCII characters (conversion is carried out simply in the form of <code>str(prompt)</code> ).  This part is very simple: you need to override the <code>__str__</code> and <code>__new__</code> <code>__str__</code> (you can do without the second, in principle, but it‚Äôs more convenient when converting to this class from the following and to be able to explicitly specify the encoding to be used). </li><li>  A class-successor <code>str</code> , in which the previous class would be converted.  Here redefinition of two methods is categorically insufficient: <ol><li>  <code>__new__</code> needed to easily save the encoding and there is no need for explicit conversion <code>unicode</code> ‚Üí <code>str</code> . </li><li>  <code>__contains__</code> and several other methods should work with unicode arguments as if the current class is <code>unicode</code> (for non- <code>unicode</code> arguments, nothing needs to be changed).  The fact is that if unicode_literals are <code>unicode_literals</code> <code>'\n' in prompt</code> throws an exception if the <code>prompt</code> is a byte string with non-ASCII characters, as Python tries to bring the <code>prompt</code> to <code>unicode</code> , and not vice versa. </li><li>  <code>find</code> and similar functions should work with unicode arguments as if they were byte strings in the current encoding.  It is necessary that they give out the correct indexes, but at the same time they do not fail with errors due to the conversion of a byte string to a unicode one (and here, why is the conversion not the inverse?). </li><li>  <code>__len__</code> should give the length of the string in unicode codepoints.  This part is needed so that pyrepl, which considers where the invitation ends (and sets the cursor accordingly), is not mistaken and does not make a giant space between the invitation and the cursor.  I suspect that you need to actually use not codepoints, but the width of the line in the screen cells (what, for example, <a href="http://vimpluginloader.sourceforge.net/doc/eval.txt.html">strdisplaywidth () does</a> in Vim). </li><li>  <code>__add__</code> should return our first class, the <code>unicode</code> heir, when added to the Unicode string.  <code>__radd__</code> should do the same.  The addition of byte strings should be given by our class- <code>str</code> .  More in the next paragraph. </li><li>  Well, finally, <code>__getslice__</code> (note: <code>__getitem__</code> does not roll, <code>str</code> uses deprecated <code>__getslice__</code> for slices) should return an object of the same class, because pyrepl at the very end adds the empty Unicode string, the slice from the current class and another slice from it.  And if we ignore this part, we again get some <a href="https://docs.python.org/2.7/library/exceptions.html">UnicodeError</a> . </li></ol></li></ol>  The result will be the following two freaks: <pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PowerlineRenderBytesResult</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(bytes)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, s, encoding=None)</span></span></span><span class="hljs-function">:</span></span> encoding = encoding <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> s.encoding self = bytes.__new__(cls, s.encode(encoding) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(s, unicode) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> s) self.encoding = encoding <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> meth <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( <span class="hljs-string"><span class="hljs-string">'__contains__'</span></span>, <span class="hljs-string"><span class="hljs-string">'partition'</span></span>, <span class="hljs-string"><span class="hljs-string">'rpartition'</span></span>, <span class="hljs-string"><span class="hljs-string">'split'</span></span>, <span class="hljs-string"><span class="hljs-string">'rsplit'</span></span>, <span class="hljs-string"><span class="hljs-string">'count'</span></span>, <span class="hljs-string"><span class="hljs-string">'join'</span></span>, ): exec(( <span class="hljs-string"><span class="hljs-string">'def {0}(self, *args):\n'</span></span> <span class="hljs-string"><span class="hljs-string">' if any((isinstance(arg, unicode) for arg in args)):\n'</span></span> <span class="hljs-string"><span class="hljs-string">' return self.__unicode__().{0}(*args)\n'</span></span> <span class="hljs-string"><span class="hljs-string">' else:\n'</span></span> <span class="hljs-string"><span class="hljs-string">' return bytes.{0}(self, *args)'</span></span> ).format(meth)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> meth <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( <span class="hljs-string"><span class="hljs-string">'find'</span></span>, <span class="hljs-string"><span class="hljs-string">'rfind'</span></span>, <span class="hljs-string"><span class="hljs-string">'index'</span></span>, <span class="hljs-string"><span class="hljs-string">'rindex'</span></span>, ): exec(( <span class="hljs-string"><span class="hljs-string">'def {0}(self, *args):\n'</span></span> <span class="hljs-string"><span class="hljs-string">' if any((isinstance(arg, unicode) for arg in args)):\n'</span></span> <span class="hljs-string"><span class="hljs-string">' args = [arg.encode(self.encoding) if isinstance(arg, unicode) else arg for arg in args]\n'</span></span> <span class="hljs-string"><span class="hljs-string">' return bytes.{0}(self, *args)'</span></span> ).format(meth)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__len__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> len(self.decode(self.encoding)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__getitem__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PowerlineRenderBytesResult(bytes.__getitem__(self, *args), encoding=self.encoding) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__getslice__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PowerlineRenderBytesResult(bytes.__getslice__(self, *args), encoding=self.encoding) @staticmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(encoding, *args)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> any((isinstance(arg, unicode) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> arg <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> args)): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>.join(( arg <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(arg, unicode) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> arg.decode(encoding) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> arg <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> args )) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PowerlineRenderBytesResult(<span class="hljs-string"><span class="hljs-string">b''</span></span>.join(args), encoding=encoding) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__add__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, other)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.add(self.encoding, self, other) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__radd__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, other)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.add(self.encoding, other, self) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__unicode__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PowerlineRenderResult(self) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PowerlineRenderResult</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(unicode)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, s, encoding=None)</span></span></span><span class="hljs-function">:</span></span> encoding = ( encoding <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> getattr(s, <span class="hljs-string"><span class="hljs-string">'encoding'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> get_preferred_output_encoding() ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(s, unicode): self = unicode.__new__(cls, s) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self = unicode.__new__(cls, s, encoding, <span class="hljs-string"><span class="hljs-string">'replace'</span></span>) self.encoding = encoding <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__str__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PowerlineRenderBytesResult(self)</code> </pre>  (in Python2 <code>bytes is str</code> ). <br><br>  The result on github while is only in <a href="https://github.com/ZyX-I/powerline/blob/pdb/powerline/bindings/pdb/__init__.py">my branch</a> , will later <code>develop</code> main repository. <br>  Of course, the result is not limited only to pyrepl, but can be used in various places where you can not slip a non-ASCII string, but you really want to. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <br>  ¬π With <code>TERM=xterm-256color</code> I get errors from pyrepl, and with <code>TERM=</code> or <code>TERM=konsole-256color</code> - no, and everything works fine. <br>  ¬≤ What you will see if you enable autocall in IPython and type <code>int 42</code> : <img src="https://habrastorage.org/getpro/habr/post_images/13a/c4f/858/13ac4f858b90a459e7da7b21a0dc7bfa.png" alt="Powerline IPython in and rewrite prompt">  (bottom line). </div><p>Source: <a href="https://habr.com/ru/post/249129/">https://habr.com/ru/post/249129/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249115/index.html">How we made a mod under the Oculus Rift for World of Tanks</a></li>
<li><a href="../249117/index.html">Proxy server for free internet</a></li>
<li><a href="../249119/index.html">Xclaim - ‚Äúnoisy‚Äù * Wi-Fi invasion of small business</a></li>
<li><a href="../249123/index.html">Upgrade from Windows 7 / 8.1 to Windows 10 TP via Windows Update</a></li>
<li><a href="../249127/index.html">Practice "Intel IoT". Galileo Gen2 - Eclipse & libmraa + UPM</a></li>
<li><a href="../249131/index.html">Three words that can change the world</a></li>
<li><a href="../249135/index.html">CLR bug: how to drag an object into a sandbox without marshalling and call a callback</a></li>
<li><a href="../249137/index.html">GHOST (dot) WEB: First Blood</a></li>
<li><a href="../249139/index.html">A brief course of computer graphics: we write a simplified OpenGL do it yourself, article 6 of 6</a></li>
<li><a href="../249141/index.html">Building crosswords using the Wolfram Language (Mathematica)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>