<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using the Yandex Direct service using the GetRegions method (WCF client)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Yandex.Direct does not work correctly using the SOAP protocol, because the actual data scheme used in answering requests does not coincide with the sc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using the Yandex Direct service using the GetRegions method (WCF client)</h1><div class="post__text post__text-html js-mediator-article">  Yandex.Direct does not work correctly using the SOAP protocol, because the actual data scheme used in answering requests does not coincide with the scheme from the WSDL description provided by the service.  Namely, the namespace does not match (instead of ‚ÄúAPI‚Äù comes ‚Äú <a href="http://namespaces.soaplite.com/perl">namespaces.soaplite.com/perl</a> ‚Äù and ‚Äú <a href="http://xml.apache.org/xml-soap">xml.apache.org/xml-soap</a> ‚Äù), as well as the names of the parameters (for example, in the GetRegions method instead of the name ‚Äúreturn‚Äù comes "ArrayOfRegionInfo"). <br><a name="habracut"></a><br>  To resolve the first problem, intercepting messages from the service and updating the namespace was implemented. <br>  To fix the second problem, the WSDL autogenerate file for Reference.cs was simply corrected. <br>  Officially, with the Yandex.Direct service, applications developed in C # using WCF are not implemented. <br>  Yandex.Direct provides an example of how to interact with the service using the JSON data storage format and a simple WebClient.  This example works correctly, unlike SOAP, but it has several disadvantages, such as: you need to de-serialize the received object yourself, there is no support for contracts between the service and the client. <br><br><h5>  Training </h5><br>  Service documentation is available <a href="http://api.yandex.ru/direct/">here</a> . <br>  To work with the service you need: <br>  1. register (for transmission in the login authentication parameter), <br>  2. create a client application (for transmission in the application_id authentication parameter), <br>  3. get a test token (for transmission in the token authentication parameter), <br>  4. can be used to send the value ‚Äúru‚Äù in the authentication parameter locale. <br>  More details can be found in the documentation for the service, you should not rewrite it here. <br><br><h5>  Create application </h5><br>  1. Create a new application in MS Visual Studio. <br>  2. Add a new link to the service, specify wsdl: ‚Äú <a href="http://api.direct.yandex.ru/wsdl/v4">api.direct.yandex.ru/wsdl/v4</a> ‚Äù, namespace, for example, YandexAPIService (well, or whatever you like). <br>  3. In the file Reference.cs, the type System.Nullable &lt;System.DateTime&gt; is replaced by System.DateTime <br>  4. In the file Reference.cs in the description of the YandexAPIService.APIPort.GetRegions method, the name of the parameter ‚Äúreturn‚Äù is replaced by ‚ÄúArrayOfRegionInfo‚Äù. <br>  5. Create a MessageInspector in which messages from the service will be intercepted and the ‚Äúwrong‚Äù namespace will be replaced with the ‚Äúcorrect‚Äù one. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel.Channels; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel.Description; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel.Dispatcher; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Xml; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">YandexDirectRegions</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Client message inspector public class YandexDirectMessageInspector : IClientMessageInspector { public void AfterReceiveReply(ref Message reply, object correlationState) { XmlDocument doc = new XmlDocument(); MemoryStream ms = new MemoryStream(); XmlWriter writer = XmlWriter.Create(ms); reply.WriteMessage(writer); writer.Flush(); ms.Position = 0L; doc.Load(ms); foreach (XmlAttribute attr in doc.DocumentElement.Attributes) if (attr.Value == "http://namespaces.soaplite.com/perl" || attr.Value == "http://xml.apache.org/xml-soap") attr.Value = "API"; ms.Position = 0L; ms.SetLength(0); writer = XmlWriter.Create(ms); doc.WriteTo(writer); writer.Flush(); ms.Position = 0L; XmlReader reader = XmlReader.Create(ms); Message newReply = Message.CreateMessage(reader, int.MaxValue, reply.Version); newReply.Properties.CopyProperties(reply.Properties); newReply.Headers.CopyHeadersFrom(reply); reply = newReply; } public object BeforeSendRequest(ref System.ServiceModel.Channels.Message request, IClientChannel channel) { return null; } } // Endpoint behavior public class YandexDirectEndpointBehavior : IEndpointBehavior { public void AddBindingParameters(ServiceEndpoint endpoint, System.ServiceModel.Channels.BindingParameterCollection bindingParameters) { // No implementation necessary } public void ApplyClientBehavior(ServiceEndpoint endpoint, ClientRuntime clientRuntime) { clientRuntime.MessageInspectors.Add(new YandexDirectMessageInspector()); } public void ApplyDispatchBehavior(ServiceEndpoint endpoint, EndpointDispatcher endpointDispatcher) { // No implementation necessary } public void Validate(ServiceEndpoint endpoint) { // No implementation necessary } } // Configuration element public class YandexDirectBehaviorExtension : BehaviorExtensionElement { public override Type BehaviorType { get { return typeof(YandexDirectEndpointBehavior); } } protected override object CreateBehavior() { // Create the endpoint behavior that will insert the message // inspector into the client runtime return new YandexDirectEndpointBehavior(); } } }</span></span></code> </pre> <br><br>  6. Configure endpoint in the [app | web] .config configuration file <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.serviceModel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bindings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">basicHttpBinding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">binding</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"YandexDirectSoapBinding"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxReceivedMessageSize</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100000"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Transport"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">binding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">basicHttpBinding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bindings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">client</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">endpoint</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://soap.direct.yandex.ru/v4/soap/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">binding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"basicHttpBinding"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bindingConfiguration</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"YandexDirectSoapBinding"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">contract</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"YandexAPIService.APIPort"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">behaviorConfiguration</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"YandexDirectBehavior"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"APIPort"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">client</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behaviors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">endpointBehaviors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behavior</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"YandexDirectBehavior"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">YandexDirectBehaviorExtension</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behavior</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">endpointBehaviors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behaviors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behaviorExtensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"YandexDirectBehaviorExtension"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"YandexDirectRegions.YandexDirectBehaviorExtension, YandexDirectRegions"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behaviorExtensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.serviceModel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  7. Implement the method call <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ServiceModel.Channels; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> YandexDirectRegions.YandexAPIService; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">YandexDirectRegions</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     ,       -  / "" public class Region { public int RegionID { get; set; } public int? ParentID { get; set; } public string RegionName { get; set; } } public class UnitOfWork { YandexAPIService.APIPortClient yandexAPIPortClient; #region Singleton private static volatile UnitOfWork instance; private static object syncRoot = new Object(); private UnitOfWork() { yandexAPIPortClient = new YandexAPIService.APIPortClient(); System.Net.ServicePointManager.ServerCertificateValidationCallback = delegate { return true; }; } public static UnitOfWork Instance { get { if (instance == null) { lock (syncRoot) { if (instance == null) instance = new UnitOfWork(); } } return instance; } } #endregion public Region[] GetRegions(string application_id, string token, string login, string locale) { Region[] regions = null; var applicationIdHeader = MessageHeader.CreateHeader("application_id", "ns", application_id); var tokenHeader = MessageHeader.CreateHeader("token", "ns", token); var loginHeader = MessageHeader.CreateHeader("login", "ns", login); var localeHeader = MessageHeader.CreateHeader("locale", "ns", locale); using (var scope = new OperationContextScope(yandexAPIPortClient.InnerChannel)) { OperationContext.Current.OutgoingMessageHeaders.Add(applicationIdHeader); OperationContext.Current.OutgoingMessageHeaders.Add(tokenHeader); OperationContext.Current.OutgoingMessageHeaders.Add(loginHeader); OperationContext.Current.OutgoingMessageHeaders.Add(localeHeader); var regionsInfo = yandexAPIPortClient.GetRegions(); if (regionsInfo != null) { regions = regionsInfo.Select&lt;RegionInfo, Region&gt;((regionInfo) =&gt; { return new Region() { RegionID = regionInfo.RegionID, ParentID = regionInfo.ParentID, RegionName = regionInfo.RegionName }; } ).ToArray(); } } return regions; } } }</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/201746/">https://habr.com/ru/post/201746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../201736/index.html">After Reset - a game in which it is difficult to believe even after seeing (Kickstarter Campaign)</a></li>
<li><a href="../201738/index.html">COLT. What language to add Livecoding?</a></li>
<li><a href="../201740/index.html">TOP-100 Adjayl books of all time (at the end of 2013)</a></li>
<li><a href="../201742/index.html">Thematic content generation on the Internet. A look into the future</a></li>
<li><a href="../201744/index.html">Sense 3D portable 3D scanner can ‚Äúscan‚Äù a person</a></li>
<li><a href="../201750/index.html">The Simpsons on pure CSS</a></li>
<li><a href="../201752/index.html">Turn a static website into a mobile application using jQuery Mobile and PhoneGap</a></li>
<li><a href="../201754/index.html">Short version of the Social Network</a></li>
<li><a href="../201756/index.html">Save us from Google. Insanity was strong, ideas descended from the tops. Google</a></li>
<li><a href="../201758/index.html">What to look for when choosing an Electronic Document Management on MS Sharepoint 2013 platform in the first place. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>