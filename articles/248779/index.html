<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>When data is really a lot: Vowpal Wabbit</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 



 In the previous two posts ( one , two ), we reviewed the basic algorithms and techniques used by the participants of the Kaggle competi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>When data is really a lot: Vowpal Wabbit</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br><img src="https://habrastorage.org/files/c7d/347/66a/c7d34766a2074fe48515fe66d2c6484c.png"><br><br>  In the previous two posts ( <a href="http://habrahabr.ru/post/247751/">one</a> , <a href="http://habrahabr.ru/post/248129/">two</a> ), we reviewed the basic algorithms and techniques used by the participants of the <a href="http://www.kaggle.com/">Kaggle</a> competition.  Today I would like to go further and talk about the difficulties that researchers encounter in developing algorithms in the case when there is a lot of data and learning comes from samples that do not fit in memory.  Immediately it should be noted that this happens quite often, <a href="http://www.kaggle.com/c/avazu-ctr-prediction">even at Kaggle itself</a> (in this task, the training sample has a volume of several gigabytes and the beginner may simply not understand what to do with this).  Below we will look at machine learning algorithms and tools that can handle this problem. <br><a name="habracut"></a><br>  Many who are familiar with machine learning know that quite often good quality can be obtained thanks to simple linear models, provided that the signs have been well selected and generated ( <a href="http://habrahabr.ru/post/248129/">which we discussed earlier</a> ).  These models are also pleased with their simplicity and often even clarity (for example, SVM, which maximizes the width of the dividing strip).  However, there is another very important advantage of linear methods - during training, it is possible to ensure that the algorithm parameters are set (ie, the weights update stage) is performed each time a new object is added.  These methods of machine learning in literature are often also called <b>Online Machine Learning</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If you don‚Äôt go into details, in a nutshell it looks like this: in order to select the parameters of a particular linear method (for example, weights in the logistic regression), some initial value of these parameters is initialized, and then getting the next object from the training sample as input , weights are updated.  So linear methods allow just this kind of training.  At the same time, it is clear that it is simply not necessary to store all objects simultaneously in memory. <br><br>  To date, one of the most famous implementations of such methods is the <a href="https://github.com/JohnLangford/vowpal_wabbit">Vowpal Wabbit</a> package, which can be briefly described in several points: <br><br><ul><li>  It <b>can train only linear models</b> .  At the same time, <a href="http://habrahabr.ru/post/248129/">as we already know,</a> it is possible to increase the quality of the methods themselves by adding new features, by fitting the loss function, and also by using low-rank expansions (we will talk more about this in the next articles) </li><li>  The training set is processed using a stochotic optimizer, which <b>allows learning on samples that do not fit into memory.</b> </li><li>  <b>You can handle a large number of features</b> by hashing them (the so-called hashing trick), which can train models even in cases where the full set of scales simply does not fit in memory </li><li>  <b>Active learning mode is supported</b> , in which training sample objects can be submitted even from several machines over the network. </li><li>  <b>Training can be parallelized across multiple machines.</b> </li></ul><br>  So, let us dwell on how to work in practice with this tool and what results can be obtained with it.  As an example, consider the well-known task of <a href="http://www.kaggle.com/c/titanic-gettingStarted">Titanic: Machine Learning from Disaster</a> .  Probably, this is not the best example due to the fact that there is little data in this problem.  However, since  The article is intended primarily for newcomers to machine learning - this post will be an excellent continuation of the <a href="http://www.kaggle.com/c/titanic-gettingStarted/details/">official Tutorial</a> .  In addition, it will be quite easy to later rewrite the code used in this post for the real (and actual at the time of the writing of the post) <a href="http://www.kaggle.com/c/avazu-ctr-prediction">Click-Through Rate Prediction</a> task - the training sample in it has a size larger than 5 GB. <br><br>  Before starting the description of specific steps, we note that the code described below was run for a long time (even before Vawpal Wabbit became popular), and the project itself has been actively updated lately, therefore all the sources are correct with some accuracy - the author leaves it to check to the reader. <br><br>  Recall that in the task at hand it is proposed to build a classifier that would predict for a specific person (a passenger of the Titanic) whether he will drown or not.  We will not describe in detail the condition of the problem and the characteristics given to us.  Those interested can familiarize themselves with this information on the competition page. <br><br>  So let's start with the fact that Vowpal Wabbit accepts input in a certain format: <br><br>  <b>label | A feature1: value1 | B feature2: value2</b> <br><br>  Which as a whole is no different from the familiar object-feature matrix, except that the signs can be categorized so that, in the course of training, some of them can be turned off.  Thus, after we have downloaded the training and test samples, the first step is to convert the data into a format that would read Vowpal Wabbit <br><br><h3>  Preparation of training and test samples </h3><br>  To do this, you can take a simple script (or you can simply use the excellent <a href="https://github.com/zygmuntz/phraug2">phraug2</a> library), which reads the <b>train.csv</b> file line by line and convert each object of the training set to the desired format.  It should be noted that in the case of a two-class classification, the <b>label</b> takes the values ‚Äã‚Äã+1 or -1 <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> csv <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clean</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">" "</span></span>.join(re.findall(<span class="hljs-string"><span class="hljs-string">r'\w+'</span></span>, s,flags = re.UNICODE | re.LOCALE)).lower() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"train_titanic.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"r"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> infile, open(<span class="hljs-string"><span class="hljs-string">"train_titanic.vw"</span></span>, <span class="hljs-string"><span class="hljs-string">"wb"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> outfile: reader = csv.reader(infile) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> reader: i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> i &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>: vw_line = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> str(line[<span class="hljs-number"><span class="hljs-number">1</span></span>]) == <span class="hljs-string"><span class="hljs-string">"1"</span></span>: vw_line += <span class="hljs-string"><span class="hljs-string">"1 '"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: vw_line += <span class="hljs-string"><span class="hljs-string">"-1 '"</span></span> vw_line += str(line[<span class="hljs-number"><span class="hljs-number">0</span></span>]) + <span class="hljs-string"><span class="hljs-string">" |f "</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"passenger_class_"</span></span>+str(line[<span class="hljs-number"><span class="hljs-number">2</span></span>])+<span class="hljs-string"><span class="hljs-string">" "</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"last_name_"</span></span> + clean(line[<span class="hljs-number"><span class="hljs-number">3</span></span>].split(<span class="hljs-string"><span class="hljs-string">","</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]).replace(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"_"</span></span>) + <span class="hljs-string"><span class="hljs-string">" "</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"title_"</span></span> + clean(line[<span class="hljs-number"><span class="hljs-number">3</span></span>].split(<span class="hljs-string"><span class="hljs-string">","</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>]).split()[<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-string"><span class="hljs-string">" "</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"sex_"</span></span> + clean(line[<span class="hljs-number"><span class="hljs-number">4</span></span>]) + <span class="hljs-string"><span class="hljs-string">" "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(str(line[<span class="hljs-number"><span class="hljs-number">5</span></span>])) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: vw_line += <span class="hljs-string"><span class="hljs-string">"age:"</span></span> + str(line[<span class="hljs-number"><span class="hljs-number">5</span></span>]) + <span class="hljs-string"><span class="hljs-string">" "</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"siblings_onboard:"</span></span> + str(line[<span class="hljs-number"><span class="hljs-number">6</span></span>]) + <span class="hljs-string"><span class="hljs-string">" "</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"family_members_onboard:"</span></span> + str(line[<span class="hljs-number"><span class="hljs-number">7</span></span>]) + <span class="hljs-string"><span class="hljs-string">" "</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"embarked_"</span></span> + str(line[<span class="hljs-number"><span class="hljs-number">11</span></span>]) + <span class="hljs-string"><span class="hljs-string">" "</span></span> outfile.write(vw_line[:<span class="hljs-number"><span class="hljs-number">-1</span></span>] + <span class="hljs-string"><span class="hljs-string">"\n"</span></span>)</code> </pre> <br>  Similarly, we proceed with the test sample: <br><br><pre> <code class="python hljs">i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"test_titanic.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"r"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> infile, open(<span class="hljs-string"><span class="hljs-string">"test_titanic.vw"</span></span>, <span class="hljs-string"><span class="hljs-string">"wb"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> outfile: reader = csv.reader(infile) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> reader: i += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> i &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>: vw_line = <span class="hljs-string"><span class="hljs-string">""</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"1 '"</span></span> vw_line += str(line[<span class="hljs-number"><span class="hljs-number">0</span></span>]) + <span class="hljs-string"><span class="hljs-string">" |f "</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"passenger_class_"</span></span>+str(line[<span class="hljs-number"><span class="hljs-number">1</span></span>])+<span class="hljs-string"><span class="hljs-string">" "</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"last_name_"</span></span> + clean(line[<span class="hljs-number"><span class="hljs-number">2</span></span>].split(<span class="hljs-string"><span class="hljs-string">","</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]).replace(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"_"</span></span>) + <span class="hljs-string"><span class="hljs-string">" "</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"title_"</span></span> + clean(line[<span class="hljs-number"><span class="hljs-number">2</span></span>].split(<span class="hljs-string"><span class="hljs-string">","</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>]).split()[<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-string"><span class="hljs-string">" "</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"sex_"</span></span> + clean(line[<span class="hljs-number"><span class="hljs-number">3</span></span>]) + <span class="hljs-string"><span class="hljs-string">" "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(str(line[<span class="hljs-number"><span class="hljs-number">4</span></span>])) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: vw_line += <span class="hljs-string"><span class="hljs-string">"age:"</span></span> + str(line[<span class="hljs-number"><span class="hljs-number">4</span></span>]) + <span class="hljs-string"><span class="hljs-string">" "</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"siblings_onboard:"</span></span> + str(line[<span class="hljs-number"><span class="hljs-number">5</span></span>]) + <span class="hljs-string"><span class="hljs-string">" "</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"family_members_onboard:"</span></span> + str(line[<span class="hljs-number"><span class="hljs-number">6</span></span>]) + <span class="hljs-string"><span class="hljs-string">" "</span></span> vw_line += <span class="hljs-string"><span class="hljs-string">"embarked_"</span></span> + str(line[<span class="hljs-number"><span class="hljs-number">10</span></span>]) + <span class="hljs-string"><span class="hljs-string">" "</span></span> outfile.write(vw_line[:<span class="hljs-number"><span class="hljs-number">-1</span></span>] + <span class="hljs-string"><span class="hljs-string">"\n"</span></span>)</code> </pre><br>  At the output we get 2 files <b>train_titanic.vw</b> and <b>test_titanic.vw,</b> respectively.  It is worth noting that this is often the most difficult and long stage - sample preparation.  In fact, then we will only run several times the machine learning methods on this sample and immediately get the result <br><br><h3>  Training linear models in Vowpal Wabbit </h3><br>  Work comes from the command line by running the <b>vw</b> utility with the parameters passed to it.  To start it.  We will not focus on the detailed description of all parameters, but run only one of the examples: <br><br>  <b>vw train_titanic.vw -f model.vw --binary --passes 20 -c -q ff --adaptive --normalized --l1 0.00000001 --l2 0.0000001 -b 24</b> <br><br>  Here we report that we want to solve the binary classification problem ( <b>--binary</b> ), we want to make 20 passes in the training set ( <b>--passes 20</b> ) we want to make L1 and L2 regularization ( <b>--l1 0.00000001 --l2 0.0000001</b> ), normalization, and the model itself is saved in <b>model.vw</b> .  The <b>-b 24</b> parameter is used to specify the hash function (as was stated at the beginning, all attributes are hashed, and the hashes themselves take values ‚Äã‚Äãfrom 0 to 2 ^ b-1).  Also, it is important to note the <b>-q ff</b> parameter, which indicates that we also want to add paired signs to the model (this is a very useful feature of VW, sometimes allowing to significantly increase the quality of algorithms) <br><br>  After some time we will get a trained model.  It remains only to run the algorithm on the test sample. <br><br>  <b>vw -d test_titanic.vw -t -i model.vw -p preds_titanic.txt</b> <br><br>  And convert the result to be sent to the <b>kaggle.com</b> system: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> csv <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"preds_titanic.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"r"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> infile, open(<span class="hljs-string"><span class="hljs-string">"kaggle_preds.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"wb"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> outfile: outfile.write(<span class="hljs-string"><span class="hljs-string">"PassengerId,Survived\n"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> infile.readlines(): kaggle_line = str(line.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>]).replace(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> str(int(float(line.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]))) == <span class="hljs-string"><span class="hljs-string">"1"</span></span>: kaggle_line += <span class="hljs-string"><span class="hljs-string">",1\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: kaggle_line += <span class="hljs-string"><span class="hljs-string">",0\n"</span></span> outfile.write(kaggle_line)</code> </pre><br>  This simple solution shows a fairly good quality - more than <b>0.79 AUC</b> .  We applied a rather trivial model.  By optimizing the parameters and ‚Äúplaying‚Äù with the signs, the result can be slightly improved (the reader is invited to do this as an exercise).  I hope this introduction will help beginners to cope with the volume of data in machine learning competitions! </div><p>Source: <a href="https://habr.com/ru/post/248779/">https://habr.com/ru/post/248779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248765/index.html">Microsoft has joined the Student Developer Pack and some other GitHub Education news.</a></li>
<li><a href="../248767/index.html">The digest of interesting materials for the mobile developer # 87 (on January 19-25)</a></li>
<li><a href="../248769/index.html">Wordpress</a></li>
<li><a href="../248775/index.html">Age of JIT compiling. Part I. Genesis</a></li>
<li><a href="../248777/index.html">Patent Wars. Episode 1. Hidden threat</a></li>
<li><a href="../248783/index.html">HTML5 canvas karaoke</a></li>
<li><a href="../248785/index.html">Fundamentals of graphics programming on Apple Metal: Getting started</a></li>
<li><a href="../248787/index.html">WRL and BindableAttribute</a></li>
<li><a href="../248789/index.html">Developer Stories: Microblink PhotoMath</a></li>
<li><a href="../248793/index.html">Review of the most interesting materials on data analysis and machine learning ‚Ññ32 (January 19 - 25, 2015)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>