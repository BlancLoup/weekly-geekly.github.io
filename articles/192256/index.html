<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Building a full MVC website on ExpressJS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="NB: This is material for those who have already familiarized themselves with the theoretical basis of node.js and want, as they say, right off the bat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Building a full MVC website on ExpressJS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/4cf/018/d13/4cf018d13e00510b24cd7e9a31f607b8.jpg" align="left">  NB: This is material for those who have already familiarized themselves with the theoretical basis of node.js and want, as they say, right off the bat, to quickly plunge into development using this tool.  No deduction, only coding.  If interested, do not be shy, we pass under the cat. <br><br><a name="habracut"></a><br>  <i>From the translator: I myself began to learn node.js more recently.</i>  <i>Undoubtedly, on the Internet there are many good (!) Manuals for beginners, in particular, and here, in Habr√© (for example, <a href="http://habrahabr.ru/post/146983/">here</a> and <a href="http://habrahabr.ru/post/132745/">here</a> ).</i>  <i>However, <a href="http://net.tutsplus.com/tutorials/javascript-ajax/build-a-complete-mvc-web-site-with-expressjs/">this manual</a> from the author Krasimir Tsonev (I also advise you to take a look at his multifaceted <a href="http://krasimirtsonev.com/blog">blog</a> ) seemed especially remarkable, since it describes the process of building a full-fledged node.js application based on the Express module using the MVC pattern and base in a reasonably short and understandable form. MongoDB data.</i>  <i>Also, the author pays attention to such an important thing as testing.</i> <br><br><h4>  Transfer </h4><br>  In this article we will build a full-fledged website with a client part, as well as a control panel for the site content.  As you can guess, the final working version of the program contains a large number of different files.  I wrote this manual step by step, fully tracking the development of the process, but I did not include every single file in it, as this would make the reading long and boring.  However, the source code is available <a href="https://github.com/tutsplus/build-complete-website-expressjs">on GitHub</a> , and I highly recommend that you watch it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Introduction </h4><br>  <a href="http://expressjs.com/">Express</a> is one of the best <a href="http://nodejs.org/">Node</a> frameworks.  It has excellent developer support and a bunch of useful features.  There are many great articles on Express that cover all the basics of working with it.  But now I want to dig a little deeper and share my experience in creating a full-fledged website.  In general, this article is not only about Express itself, but also about its combination with other, no less remarkable tools that are available to developers. <br>  I suppose that you are familiar with Node.js, installed it on your system, and that you have already created some applications on it. <br>  At the core of the Express framework is <a href="http://www.senchalabs.org/connect/">Connect</a> .  This is a set of middleware-functions, which comes with a lot of useful things.  If you are wondering what the middleware function is, here is a small example: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connect = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'connect'</span></span>), http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> app = connect() .use(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"That's my first middleware"</span></span>); next(); }) .use(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"That's my second middleware"</span></span>); next(); }) .use(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"end"</span></span>); res.end(<span class="hljs-string"><span class="hljs-string">"hello world"</span></span>); }); http.createServer(app).listen(<span class="hljs-number"><span class="hljs-number">3000</span></span>);</code> </pre> <br>  A middleware function is basically a function that accepts request parameters and responce objects as well as a callback function that will be called next.  Each middleware-function decides: either to answer, using a responce-object, or to transmit a stream to the next callback-function.  In the example above, if you remove the <b>next ()</b> method call in the second function, the string ‚Äúhello world‚Äù will never be sent to the client.  In general, exactly how Express works.  It has several predefined middleware functions that will surely save you a lot of time.  Such, for example, is the <i>Body</i> Parser, which parses the request body and supports the types of content <i>application / json</i> , <i>application / x-www-form-urlencoded</i> and <i>multipart / form-data</i> .  Or a <i>cookie, a</i> parser that parses cookies and fills the <b>req.cookies</b> field <b>with an</b> object whose key is the name of the cookie. <br>  In fact, Express wraps the Connect framework, complementing it with some functionality, such as, for example, routing logic, which makes the routing process more smooth.  Below is an example of processing a GET request: <br><br><pre> <code class="javascript hljs">app.get(<span class="hljs-string"><span class="hljs-string">'/hello.txt'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> body = <span class="hljs-string"><span class="hljs-string">'Hello World'</span></span>; res.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>); res.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Length'</span></span>, body.length); res.end(body); });</code> </pre> <br><br><h4>  Installation </h4><br>  There are two options for installing Express.  The first is to place its description in the <i>package.json</i> file and execute the <i>npm install</i> command (such a joke goes that the name of this package manager is decoded as ‚Äúno problem man‚Äù :)). <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"MyWebSite"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"My website"</span></span>, <span class="hljs-string"><span class="hljs-string">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"dependencies"</span></span>: { <span class="hljs-string"><span class="hljs-string">"express"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.x"</span></span> } }</code> </pre> <br>  The framework code will be placed in the <i>node_modules</i> directory and you will have the opportunity to create an instance of it.  I prefer the alternative: command line.  Just install Express by running the <i>npm install -g express</i> command.  By doing this, you will have a new CLI tool.  For example, if you run: <br><br><pre> <code class="bash hljs">express --sessions --css less --hogan app</code> </pre> <br>  Express will generate the configured application framework for you.  The following is a list of parameters for the <i>express (1)</i> command: <br><br><pre> <code class="bash hljs">Usage: express [options] Options: -h, --<span class="hljs-built_in"><span class="hljs-built_in">help</span></span> output usage information -V, --version output the version number -s, --sessions add session support -e, --ejs add ejs engine support (defaults to jade) -J, --jshtml add jshtml engine support (defaults to jade) -H, --hogan add hogan.js engine support -c, --css add stylesheet support (less|stylus) (defaults to plain css) -f, --force force on non-empty directory</code> </pre> <br>  As you can see, the list of available parameters is small, but this is enough for me.  As a rule, I use the <a href="http://lesscss.org/">less</a> library as a CSS preprocessor, as well as the <a href="http://twitter.github.io/hogan.js/">hogan</a> templating <a href="http://twitter.github.io/hogan.js/">engine</a> .  In our example, we need session support, and the <i>--sessions option</i> will solve this problem.  When the command is completed, the structure of our project will look like this: <br><br><pre> <code class="bash hljs">/public /images /javascripts /stylesheets /routes /index.js /user.js /views /index.hjs /app.js /package.json</code> </pre> <br>  If you look in the <i>package.json</i> file, you will see that all the dependencies that we need are added here.  But they have not yet been established.  To do this, simply execute the npm install command, after which the <i>node_modules</i> directory will appear. <br>  I understand that the approach described above is not worthy of being called universal.  For example, you may need to place route handlers in a different directory, or something else.  But, as will be shown in the next few chapters, I will make changes to the generated structure, which is quite simple.  Based on this, I advise you to use the <i>express (1)</i> command simply as a template generator. <br><br><h4>  FastDelivery </h4><br>  For this tutorial, I created a simple web site of a fictional company called FastDelivery.  Here is a screenshot of the finished design: <br><img src="https://habrastorage.org/storage3/297/10a/078/29710a07849d9ad20abc3f4543c11a4b.jpg"><br><br>  At the end of this guide, we will have a complete web application with a working control panel.  The idea is to create the ability to manage each part of the site in separate areas for each part.  The layout was created in Photoshop and cut into CSS (less) and HTML (hogan) files.  I will not describe here the process of cutting, as this is not the subject of discussion in this article, but if you have any questions on this part, do not hesitate to ask.  Having finished cutting, we get the following structure of the application files: <br><br><pre> <code class="bash hljs">/public /images (there are several images exported from Photoshop) /javascripts /stylesheets /home.less /inner.less /style.css /style.less (imports home.less and inner.less) /routes /index.js /views /index.hjs (home page) /inner.hjs (template <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> every other page of the site) /app.js /package.json</code> </pre> <br>  Here is a list of site elements that we will be able to administer: <br><ul><li>  Homepage (banner in the center - title and text) </li><li>  Blog (add, delete and edit articles) </li><li>  Services page </li><li>  Quarry page (professional growth, not sand pit :)) </li><li>  Contact Page </li></ul><br><h4>  Configuration </h4><br>  There are a few things we need to do before we get started.  Configuring is one of those things.  Let's imagine that our small stey will be deployed on three different servers - on the local, on the intermediate and on the battle.  Naturally, the settings of all three environments are different, and therefore we need to implement a mechanism that is flexible enough for such conditions.  As you know, each nodejs script runs as a console application.  This means that we can easily attribute to the command the parameters in which the current environment will be defined.  I wrapped this part in a separate module so that it would be convenient to write tests for it later.  File <i>/config/index.js</i> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = { <span class="hljs-attr"><span class="hljs-attr">local</span></span>: { <span class="hljs-attr"><span class="hljs-attr">mode</span></span>: <span class="hljs-string"><span class="hljs-string">'local'</span></span>, <span class="hljs-attr"><span class="hljs-attr">port</span></span>: <span class="hljs-number"><span class="hljs-number">3000</span></span> }, <span class="hljs-attr"><span class="hljs-attr">staging</span></span>: { <span class="hljs-attr"><span class="hljs-attr">mode</span></span>: <span class="hljs-string"><span class="hljs-string">'staging'</span></span>, <span class="hljs-attr"><span class="hljs-attr">port</span></span>: <span class="hljs-number"><span class="hljs-number">4000</span></span> }, <span class="hljs-attr"><span class="hljs-attr">production</span></span>: { <span class="hljs-attr"><span class="hljs-attr">mode</span></span>: <span class="hljs-string"><span class="hljs-string">'production'</span></span>, <span class="hljs-attr"><span class="hljs-attr">port</span></span>: <span class="hljs-number"><span class="hljs-number">5000</span></span> } } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">mode</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> config[mode || process.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>] || <span class="hljs-string"><span class="hljs-string">'local'</span></span>] || config.local; }</code> </pre> <br>  At the moment we have only two parameters - mode (mode) and port (port).  As you might expect, the application uses different ports on different servers.  That is why we need to update the entry point of our site, in the file <i>app.js.</i> <br><br><pre> <code class="javascript hljs">... var config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./config'</span></span>)(); ... http.createServer(app).listen(config.port, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Express server listening on port '</span></span> + config.port); });</code> </pre> <br>  To switch between configurations, simply add the name of the environment in the first parameter of the command.  For example: <br><br><pre> <code class="bash hljs">node app.js staging</code> </pre> <br>  Displays: <br><br><pre> <code class="bash hljs">Express server listening on port 4000</code> </pre> <br>  Now all our settings are stored in one place, they are easy to manage. <br><br><h4>  Tests </h4><br>  I'm a big <a href="http://en.wikipedia.org/wiki/Test-driven_development">TDD</a> fan.  I will try to cover all base classes with tests that will be mentioned in this article.  I agree, writing tests absolutely takes a lot of time for everything, but in general, this is how you should create your applications.  One of my favorite testing frameworks is <a href="http://pivotal.github.io/jasmine/">jasmine</a> .  Of course, it is also available in the <i>npm</i> package manager: <br><br><pre> <code class="bash hljs">npm install -g jasmine-node</code> </pre> <br>  Let's create an office for storing our tests.  The first thing we will test is our configuration file.  Test file names must end with <i>.spec.js</i> , so we will name the file <i>config.spec.js</i> . <br><br><pre> <code class="javascript hljs">describe(<span class="hljs-string"><span class="hljs-string">"Configuration setup"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ it(<span class="hljs-string"><span class="hljs-string">"should load local configurations"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../config'</span></span>)(); expect(config.mode).toBe(<span class="hljs-string"><span class="hljs-string">'local'</span></span>); next(); }); it(<span class="hljs-string"><span class="hljs-string">"should load staging configurations"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../config'</span></span>)(<span class="hljs-string"><span class="hljs-string">'staging'</span></span>); expect(config.mode).toBe(<span class="hljs-string"><span class="hljs-string">'staging'</span></span>); next(); }); it(<span class="hljs-string"><span class="hljs-string">"should load production configurations"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../config'</span></span>)(<span class="hljs-string"><span class="hljs-string">'production'</span></span>); expect(config.mode).toBe(<span class="hljs-string"><span class="hljs-string">'production'</span></span>); next(); }); });</code> </pre> <br>  Run the <i>jasmine-node ./tests command</i> and you will see the following: <br><br><pre> <code class="bash hljs">Finished <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.008 seconds 3 tests, 6 assertions, 0 failures, 0 skipped</code> </pre> <br>  Now I wrote the implementation first, and only then the tests.  This is not a TDD approach, but in the following chapters I will do the opposite. <br><br>  I highly recommend spending enough time writing tests.  There is nothing better than a fully test-covered app. <br>  A few years ago, I realized something very important, something that can help you create better applications.  Every time you start writing a new class, a new module, or just a piece of logic, ask yourself: <br><br><h5>  How can I test this? </h5><br>  The answer to this question will help you write code more efficiently, create good APIs, and divide everything into beautifully separated blocks.  You cannot write tests for spaghetti code.  For example, in the configuration file mentioned above ( <i>/config/index.js</i> ), I added the ability to send mode (mode) to the module constructor.  You may well wonder: why did I do this, because the main idea is to get the value for the mode from the command line arguments?  It's simple: because I need to test it.  Let's imagine that a month later I would need to test something using the configuration for the combat server, and the node script runs with a substitute parameter.  And I will not have the opportunity to make a change without this little improvement.  This previous small step will prevent possible problems with application deployment in the future. <br><br><h4>  Database </h4><br>  If we are building a dynamic website, we need a database to store information in it.  I chose <a href="http://mongodb.org/">mongodb</a> for this instruction.  Mongo is a NoSQL database.  You will find the installation instructions <a href="http://docs.mongodb.org/manual/installation/">here</a> , and since I am a Windows user, I followed <a href="http://docs.mongodb.org/manual/tutorial/install-mongodb-on-windows/">the installation instructions for Windows</a> .  After you finish the installation, start the MongoDB daemon, which by default listens on port 27017. So, in theory, we have the opportunity to connect to this port and exchange messages with the mongodb server.  To do this through the node script, we need a <a href="https://github.com/mongodb/node-mongodb-native">mongodb module / driver</a> .  If you downloaded the <a href="https://github.com/tutsplus/build-complete-website-expressjs">source files</a> for this instruction, then the module has already been added to the <i>package.json</i> file.  If not, just add ‚Äúmongodb‚Äù: ‚Äú1.3.10‚Äù to the <b>dependencies</b> property and execute the <i>npm install</i> command.  Next, we will write a test that will check if the mongodb server is running. <br><br>  File /tests/mongodb.spec.js: <br><br><pre> <code class="javascript hljs">describe(<span class="hljs-string"><span class="hljs-string">"MongoDB"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ it(<span class="hljs-string"><span class="hljs-string">"is there a server running"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> MongoClient = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mongodb'</span></span>).MongoClient; MongoClient.connect(<span class="hljs-string"><span class="hljs-string">'mongodb://127.0.0.1:27017/fastdelivery'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, db</span></span></span><span class="hljs-function">) </span></span>{ expect(err).toBe(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); next(); }); }); });</code> </pre> <br>  The callback function in the mongodb client <b>method .connect</b> receives a <b>db</b> object.  Later we will use it to manage our data.  This means that we need access to it within our models.  Creating a new <b>MongoClient</b> object every time you query the database is not a good idea.  That is why I transferred the launch of the Express server to the callback function of connecting to the database: <br><br><pre> <code class="javascript hljs">MongoClient.connect(<span class="hljs-string"><span class="hljs-string">'mongodb://127.0.0.1:27017/fastdelivery'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, db</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Sorry, there is no mongo db server running.'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> attachDB = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ req.db = db; next(); }; http.createServer(app).listen(config.port, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Express server listening on port '</span></span> + config.port); }); } });</code> </pre> <br>  Since we have the environment configuration settings file, it would be a good idea to put the hostname and port of the mongodb server here and change the connection URL to: <br><br>  'mongodb: //' + config.mongo.host + ':' + config.mongo.port + '/ fastdelivery' <br><br>  Pay particular attention to the middleware-function <b>attachDB</b> , which I added right before calling the function <b>http.createServer</b> .  Thanks to this small addition, we will populate the <b>.db</b> property of the request object.  The good news is that we can define several functions during route determination.  For example: <br><br><pre> <code class="javascript hljs">app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, attachDB, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ ... })</code> </pre> <br>  Thus, Express calls the <b>attachDB</b> function <b>in</b> advance so that it gets into our route handler.  When this happens, the request object will have the <b>.db</b> property and we will be able to use it to access the database. <br><br><h4>  MVC </h4><br>  We all know the <a href="http://en.wikipedia.org/wiki/Model%25E2%2580%2593view%25E2%2580%2593controller">MVC pattern</a> .  The question is how to apply it in Express.  One way or another, this is a matter of interpretation.  In the next few chapters, I will create modules that will work as a model, view, and controller. <br><br><h5>  Model </h5><br>  A model is what will process our application data.  It must have access to the <b>db</b> object returned by the <b>MongoClient</b> object.  Our model should also have a method for expanding it, since we may need different types of models.  For example, we may want to create a <b>BlogModel</b> or <b>ContactsModel</b> model.  To do this, we first need to create a test: <i>/tests/base.model.spec.js</i> .  And remember: creating these tests, we can guarantee that our models will do only what we want, and nothing else. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Model = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"../models/Base"</span></span>), dbMockup = {}; describe(<span class="hljs-string"><span class="hljs-string">"Models"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ it(<span class="hljs-string"><span class="hljs-string">"should create a new model"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Model(dbMockup); expect(model.db).toBeDefined(); expect(model.extend).toBeDefined(); next(); }); it(<span class="hljs-string"><span class="hljs-string">"should be extendable"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Model(dbMockup); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> OtherTypeOfModel = model.extend({ <span class="hljs-attr"><span class="hljs-attr">myCustomModelMethod</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ } }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OtherTypeOfModel(dbMockup); expect(model2.db).toBeDefined(); expect(model2.myCustomModelMethod).toBeDefined(); next(); }) });</code> </pre> <br>  Instead of a real <b>db</b> object, I decided to pass a mock object.  This is done for the case, if later I want to test something specific that will depend on the data coming from the database.  It will be much easier to determine this data manually. <br>  Implementing the method extension is a bit of an easy task, since we have to change the prototype of the <b>module.exports</b> , but leave the original constructor intact.  Fortunately, we have already written a test that checks the performance of our code.  The version of the above code snippet looks like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">db</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.db = db; }; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.prototype = { <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">properties</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Child = <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports; Child.prototype = <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.prototype; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> properties) { Child.prototype[key] = properties[key]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Child; }, <span class="hljs-attr"><span class="hljs-attr">setDB</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">db</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.db = db; }, <span class="hljs-attr"><span class="hljs-attr">collection</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._collection) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._collection; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._collection = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.db.collection(<span class="hljs-string"><span class="hljs-string">'fastdelivery-content'</span></span>); } }</code> </pre> <br>  Two auxiliary methods are defined here.  Setter for <b>db</b> object and getter for collection from our database. <br><br><h5>  Representation </h5><br>  The view will display information on the screen.  In simple terms, a view is a class that sends a response to the browser.  Express provides an easy way to do this: <br><br><pre> <code class="javascript hljs">res.render(<span class="hljs-string"><span class="hljs-string">'index'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">'Express'</span></span> });</code> </pre> <br>  The response object is a wrapper that has a good API that makes our lives easier.  However, I would prefer to create my own module into which its functionality will be rolled up.  The standard presentation directory will be replaced with templates, and the old views directory will give us the presentation class <i>Base</i> . <br>  This small change now requires another change.  We must notify Express that our template files are now in a different directory: <br><br><pre> <code class="javascript hljs">app.set(<span class="hljs-string"><span class="hljs-string">'views'</span></span>, __dirname + <span class="hljs-string"><span class="hljs-string">'/templates'</span></span>);</code> </pre> <br>  First of all, I will determine everything I need, write tests, and then begin implementation.  We need a module that meets the following requirements: <br><br><ul><li>  Its constructor should receive the response object and the name of the template. </li><li>  It must have a template output (rendering) method that accepts a <b>data</b> object </li><li>  It must be expandable. </li></ul><br>  You might be surprised: why did I need to expand the presentation class?  Doesn't he just call the <b>response.render</b> method?  Well, in practice there are times when you need to send a different header, or you can manipulate a response object.  For example, process the data that came in JSON: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = {<span class="hljs-string"><span class="hljs-string">"developer"</span></span>: <span class="hljs-string"><span class="hljs-string">"Krasimir Tsonev"</span></span>}; response.contentType(<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>); response.send(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(data));</code> </pre> <br>  Instead of doing this every time, it would be great to have the <b>HTMLView</b> and <b>JSONView classes</b> .  Alternatively, the <b>XMLView</b> class to send XML data to the browser.  It will simply be better if you create a large web application that already has this functionality implemented than if you copy and paste the same code over and over again. <br>  Below is a test for the <i>/views/Base.js</i> class: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> View = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"../views/Base"</span></span>); describe(<span class="hljs-string"><span class="hljs-string">"Base view"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ it(<span class="hljs-string"><span class="hljs-string">"create and render new view"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> responseMockup = { <span class="hljs-attr"><span class="hljs-attr">render</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">template, data</span></span></span><span class="hljs-function">) </span></span>{ expect(data.myProperty).toBe(<span class="hljs-string"><span class="hljs-string">'value'</span></span>); expect(template).toBe(<span class="hljs-string"><span class="hljs-string">'template-file'</span></span>); next(); } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> v = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View(responseMockup, <span class="hljs-string"><span class="hljs-string">'template-file'</span></span>); v.render({<span class="hljs-attr"><span class="hljs-attr">myProperty</span></span>: <span class="hljs-string"><span class="hljs-string">'value'</span></span>}); }); it(<span class="hljs-string"><span class="hljs-string">"should be extendable"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> v = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> OtherView = v.extend({ <span class="hljs-attr"><span class="hljs-attr">render</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ expect(data.prop).toBe(<span class="hljs-string"><span class="hljs-string">'yes'</span></span>); next(); } }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> otherViewInstance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OtherView(); expect(otherViewInstance.render).toBeDefined(); otherViewInstance.render({<span class="hljs-attr"><span class="hljs-attr">prop</span></span>: <span class="hljs-string"><span class="hljs-string">'yes'</span></span>}); }); });</code> </pre> <br>  In order to test the rendering (rendering), I had to create a layout.  For such a case, in the first part of the test, I created an object that simulates the response object of the Express framework.  In the second part of the test, I created another <i>View</i> class that inherits the base class and uses its own rendering method. <br>  Class code <i>/views/Base.js</i> : <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response, template</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response = response; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.template = template; }; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.prototype = { <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">properties</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Child = <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports; Child.prototype = <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.prototype; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> properties) { Child.prototype[key] = properties[key]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Child; }, <span class="hljs-attr"><span class="hljs-attr">render</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.template) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response.render(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.template, data); } } }</code> </pre> <br>  Now we have three tests in our test directory, and if you run the <i>jasmine-node ./tests command</i> , the result should be as follows: <br><br><pre> <code class="bash hljs">Finished <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.009 seconds 7 tests, 18 assertions, 0 failures, 0 skipped</code> </pre> <br><h5>  Controller </h5><br>  Remember, we talked about routes and how they were determined? <br><br><pre> <code class="javascript hljs">app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, routes.index);</code> </pre> <br>  The symbol '/' after the route in the example above is the controller.  This is the same middleware function that accepts <b>request</b> , <b>response</b> and <b>next ()</b> callback functions. <br><br><pre> <code class="javascript hljs">exports.index = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ res.render(<span class="hljs-string"><span class="hljs-string">'index'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">'Express'</span></span> }); };</code> </pre> <br>  The above describes what your controller should look like in the context of using Express.  The <i>express (1)</i> command creates a directory under the <i>routes</i> name, but in our case it would be better if it is called <i>controllers</i> .  I renamed it to match the file structure to this scheme. <br>  Since we are building not just a tiny tiny application, it would be advisable to create a base class that can be extended.  If we ever need to add functionality to all our controllers, this base class would be an ideal place to implement add-ons.  I write the test again first, so let's define what we need for the base class: <br><ul><li>  It must have an extensible method that accepts an object and returns a new child instance. </li><li>  The child must have a run method, which is the good old middleware function </li><li>  There must be a name property that identifies the controller. </li><li>  We should be able to create independent objects inherited from the base class. </li></ul><br>  Just a few items, but we can add more functionality later. <br>  The test will look something like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> BaseController = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"../controllers/Base"</span></span>); describe(<span class="hljs-string"><span class="hljs-string">"Base controller"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ it(<span class="hljs-string"><span class="hljs-string">"should have a method extend which returns a child instance"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function">) </span></span>{ expect(BaseController.extend).toBeDefined(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> child = BaseController.extend({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"my child controller"</span></span> }); expect(child.run).toBeDefined(); expect(child.name).toBe(<span class="hljs-string"><span class="hljs-string">"my child controller"</span></span>); next(); }); it(<span class="hljs-string"><span class="hljs-string">"should be able to create different childs"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> childA = BaseController.extend({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"child A"</span></span>, <span class="hljs-attr"><span class="hljs-attr">customProperty</span></span>: <span class="hljs-string"><span class="hljs-string">'value'</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> childB = BaseController.extend({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"child B"</span></span> }); expect(childA.name).not.toBe(childB.name); expect(childB.customProperty).not.toBeDefined(); next(); }); });</code> </pre> <br>  And below is the implementation of <i>/controllers/Base.js</i> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"underscore"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"base"</span></span>, <span class="hljs-attr"><span class="hljs-attr">extend</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">child</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.extend({}, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, child); }, <span class="hljs-attr"><span class="hljs-attr">run</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ } }</code> </pre> <br>  Of course, each descendant class must have its own <i>run</i> method that implements its own logic. <br><br><h4>  FastDelivery website </h4><br>  Well, we have a good set of classes for our MVC architecture, we also covered all the modules with tests.  Now we are ready to continue to work on the site for our fictional company FastDelivery.  Let's imagine that the site will consist of two parts - the user part and the administration panel.  The user part will be intended for the presentation of information stored in the database to the end user.  The administration panel will be to manage this information.  Let's start with the last one. <br><br><h5>  Control Panel </h5><br>     ,     -. <br>  <i>/controllers/Admin.js</i> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> BaseController = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"./Base"</span></span>), View = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"../views/Base"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = BaseController.extend({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Admin"</span></span>, <span class="hljs-attr"><span class="hljs-attr">run</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> v = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View(res, <span class="hljs-string"><span class="hljs-string">'admin'</span></span>); v.render({ <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">'Administration'</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: <span class="hljs-string"><span class="hljs-string">'Welcome to the control panel'</span></span> }); } });</code> </pre> <br>         ,         .  <i>View</i>    .   ,     <i>admin.hjs</i>       <i>/templates</i> .      : <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>{{ title }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'stylesheet'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'/stylesheets/style.css'</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>{{ content }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br> (           ,        .   ,    <a href="https://github.com/tutsplus/build-complete-website-expressjs"> </a>  GitHub.) <br> ,     ,      <i>app.js</i> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Admin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./controllers/Admin'</span></span>); ... var attachDB = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ req.db = db; next(); }; ... app.all(<span class="hljs-string"><span class="hljs-string">'/admin*'</span></span>, attachDB, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ Admin.run(req, res, next); });</code> </pre> <br> ,      <b>Admin.run</b>  middleware- .  ,     .    : <br><br><pre> <code class="javascript hljs">app.all(<span class="hljs-string"><span class="hljs-string">'/admin*'</span></span>, Admin.run);</code> </pre> <br>  <i>this</i>   <b>Admin</b>      . <br><br><h6>  - </h6><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each page that starts with </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ admin</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> must be protected. </font><font style="vertical-align: inherit;">To achieve this, we will use the </font></font><a href="http://www.senchalabs.org/connect/middleware-session.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sessions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> built-in middleware function in Express </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It simply adds an object to the request, which is called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">session</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Now we need to change our </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Admin</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> controller </font><font style="vertical-align: inherit;">to do the following two things:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">He should check if the session is available. </font><font style="vertical-align: inherit;">If not, display authorization form.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It must accept the data sent from the authorization form and authorize the user if the username and password match the username and password from the database </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Below is a small helper function that will satisfy the requirements described above: </font></font><br><br><pre> <code class="javascript hljs">authorize: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( req.session &amp;&amp; req.session.fastdelivery &amp;&amp; req.session.fastdelivery === <span class="hljs-literal"><span class="hljs-literal">true</span></span> ) || ( req.body &amp;&amp; req.body.username === <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.username &amp;&amp; req.body.password === <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.password ); }</code> </pre> <br>   ,       <b>session</b> .   ,       .  ,        <b>request.body,</b>     middleware- <b>bodyParser</b> .    ,     . <br>       <i>run</i>  ,      (    ).  :   ,    ,      : <br><br><pre> <code class="javascript hljs">run: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.authorize(req)) { req.session.fastdelivery = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; req.session.save(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> v = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View(res, <span class="hljs-string"><span class="hljs-string">'admin'</span></span>); v.render({ <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">'Administration'</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: <span class="hljs-string"><span class="hljs-string">'Welcome to the control panel'</span></span> }); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> v = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View(res, <span class="hljs-string"><span class="hljs-string">'admin-login'</span></span>); v.render({ <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">'Please login'</span></span> }); } }</code> </pre> <br><br><h6>  Content Management </h6><br>        ,     ,    .   ,        .      : , ,   .     .  ,         ‚Äúcontacts‚Äù,         . ,      ,  ,    .  ,      ,       ,       ,     MongoDB-   , , ,    API. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// /models/ContentModel.js var Model = require("./Base"), crypto = require("crypto"), model = new Model(); var ContentModel = model.extend({ insert: function(data, callback) { data.ID = crypto.randomBytes(20).toString('hex'); this.collection().insert(data, {}, callback || function(){ }); }, update: function(data, callback) { this.collection().update({ID: data.ID}, data, {}, callback || function(){ }); }, getlist: function(callback, query) { this.collection().find(query || {}).toArray(callback); }, remove: function(ID, callback) { this.collection().findAndModify({ID: ID}, [], {}, {remove: true}, callback); } }); module.exports = ContentModel;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The model takes care of generating a unique ID for each entry. We need it to update the information later. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we need to add a new entry to the contact page, we can write the following:</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"../models/ContentModel"</span></span>)); model.insert({ <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">"Contacts"</span></span>, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"contacts"</span></span> });</code> </pre> <br> ,     API       mongodb.      UI,     .     <i>Admin</i>    .    ,         / .       ,      ,   ‚Äî  . <br><img src="https://habrastorage.org/storage3/85a/a4e/96c/85aa4e96c85cf660c6ec30fc6b1c1eab.jpg"><br>        ,       ,    , ,    ,  ,     .       ,   : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; ... var v = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View(res, <span class="hljs-string"><span class="hljs-string">'admin'</span></span>); self.del(req, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ self.form(req, res, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">formMarkup</span></span></span><span class="hljs-function">) </span></span>{ self.list(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">listMarkup</span></span></span><span class="hljs-function">) </span></span>{ v.render({ <span class="hljs-attr"><span class="hljs-attr">title</span></span>: <span class="hljs-string"><span class="hljs-string">'Administration'</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: <span class="hljs-string"><span class="hljs-string">'Welcome to the control panel'</span></span>, <span class="hljs-attr"><span class="hljs-attr">list</span></span>: listMarkup, <span class="hljs-attr"><span class="hljs-attr">form</span></span>: formMarkup }); }); }); });</code> </pre> <br> ,   ,     ,   .   ‚Äî  <i>del</i> ,    GET-, ,    <i>action=delete&amp;id=[id of the record]</i> ,      .    <i>form</i> ,           .  ,              .    <i>list</i>     HTML-,      .         <a href="https://github.com/tutsplus/build-complete-website-expressjs"> </a>   . <br>   ,    : <br><br><pre> <code class="javascript hljs">handleFileUpload: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!req.files || !req.files.picture || !req.files.picture.name) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.body.currentPicture || <span class="hljs-string"><span class="hljs-string">''</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = fs.readFileSync(req.files.picture.path); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fileName = req.files.picture.name; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uid = crypto.randomBytes(<span class="hljs-number"><span class="hljs-number">10</span></span>).toString(<span class="hljs-string"><span class="hljs-string">'hex'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dir = __dirname + <span class="hljs-string"><span class="hljs-string">"/../public/uploads/"</span></span> + uid; fs.mkdirSync(dir, <span class="hljs-string"><span class="hljs-string">'0777'</span></span>); fs.writeFileSync(dir + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + fileName, data); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'/uploads/'</span></span> + uid + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + fileName; }</code> </pre> <br>     ,  <b>.files</b> request-    .       HTML-: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"picture"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  ,          <b>req.files.picture</b> .     , <b>req.files.picture.path</b>     ()  . ,        ,    ,   URL   .    ,           <i>readFileSync</i> , <i>mkdirSync</i>  <i>writeFileSync</i> . <br><br><h5>   </h5><br>     . - ,      <b>ContentModel</b> ,      ,   .     ,            .      ‚Äì <i>/controllers/Home.js</i> <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = BaseController.extend({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Home"</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">run</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ model.setDB(req.db); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getContent(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> v = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View(res, <span class="hljs-string"><span class="hljs-string">'home'</span></span>); v.render(self.content); }) }, <span class="hljs-attr"><span class="hljs-attr">getContent</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.content = {}; model.getlist(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, records</span></span></span><span class="hljs-function">) </span></span>{ ... storing data to content object model.getlist(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, records</span></span></span><span class="hljs-function">) </span></span>{ ... storing data to content object callback(); }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'blog'</span></span> }); }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'home'</span></span> }); } });</code> </pre> <br>        ‚Äúhome‚Äù      ‚Äúblog‚Äù. <br>     ,          <i>app.js</i> : <br><br><pre> <code class="javascript hljs">app.all(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, attachDB, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ Home.run(req, res, next); });</code> </pre> <br>     <b>db</b>  request-.      ,      -. <br>         ,     ,       , , ,  .    ,       .     .      ,    .   : <br><br><pre> <code class="javascript hljs">app.all(<span class="hljs-string"><span class="hljs-string">'/blog/:id'</span></span>, attachDB, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ Blog.runArticle(req, res, next); }); app.all(<span class="hljs-string"><span class="hljs-string">'/blog'</span></span>, attachDB, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ Blog.run(req, res, next); });</code> </pre> <br>        : <i>Blog</i> ,      <i>run</i> .     <i>/blog/:id</i> .       URL', : <i>/blog/4e3455635b4a6f6dccfaa1e50ee71f1cde75222b</i> ,         <b>req.params.id</b> .  ,     .      ID  (). ,     ,        . <br>     ,      ,   . ,          .          ,                <b>type</b> .     ,   ,         <i>run</i> .  : <br><br><pre> <code class="javascript hljs">app.all(<span class="hljs-string"><span class="hljs-string">'/services'</span></span>, attachDB, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ Page.run(<span class="hljs-string"><span class="hljs-string">'services'</span></span>, req, res, next); }); app.all(<span class="hljs-string"><span class="hljs-string">'/careers'</span></span>, attachDB, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ Page.run(<span class="hljs-string"><span class="hljs-string">'careers'</span></span>, req, res, next); }); app.all(<span class="hljs-string"><span class="hljs-string">'/contacts'</span></span>, attachDB, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ Page.run(<span class="hljs-string"><span class="hljs-string">'contacts'</span></span>, req, res, next); });</code> </pre> <br>      : <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = BaseController.extend({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Page"</span></span>, <span class="hljs-attr"><span class="hljs-attr">content</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">run</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type, req, res, next</span></span></span><span class="hljs-function">) </span></span>{ model.setDB(req.db); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getContent(type, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> v = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View(res, <span class="hljs-string"><span class="hljs-string">'inner'</span></span>); v.render(self.content); }); }, <span class="hljs-attr"><span class="hljs-attr">getContent</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.content = {} model.getlist(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, records</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(records.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { self.content = records[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } callback(); }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: type }); } });</code> </pre> <br><br><h4>  Deployment </h4><br>  -   Express,  ,          Node.js: <br><ul><li>     </li><li> Node-    (  ) </li><li>        <i>npm install</i> </li><li>  node-   </li></ul><br>  ,  Node ‚Äî   ,      ,   ,       . ,  <a href="https://github.com/nodejitsu/forever">forever</a>     Node.js.    ,   : <br><br><pre> <code class="bash hljs">forever start yourapp.js</code> </pre> <br>  ,      .       .       <i>node yourapp.js</i> ,       ,  ,     forever   . <br>    ,        node-  <a href="http://www.apache.org/">Apache</a>  <a href="http://wiki.nginx.org/Main">Nginx</a> ,   ,      .   , Apache     80,  ,         <a href="http://localhost/">localhost</a>  <a href="http://localhost/">localhost</a> :80,   ,  Apache-, ,  ,  node-   .      ,          . ,    ,     ,    Apache-,   <a href="http://expresscompletewebsite.dev/">expresscompletewebsite.dev</a> .  ,    ,       hosts. <br><br><pre> <code class="bash hljs">127.0.0.1 expresscompletewebsite.dev</code> </pre> <br>       httpd-vhosts.conf,     Apache-: <br><br><pre> <code class="apache hljs"><span class="hljs-comment"><span class="hljs-comment"># expresscompletewebsite.dev &lt;VirtualHost *:80&gt; ServerName expresscompletewebsite.dev ServerAlias www.expresscompletewebsite.dev ProxyRequests off &lt;Proxy *&gt; Order deny,allow Allow from all &lt;/Proxy&gt; &lt;Location /&gt; ProxyPass http://localhost:3000/ ProxyPassReverse http://localhost:3000/ &lt;/Location&gt; &lt;/VirtualHost&gt;</span></span></code> </pre> <br><br>        80,      3000,      node-. <br>  Nginx  , ,  ,         Node.js.  ,     Apache,       <i>hosts</i> .        <i>/sites-enabled</i> ,   ,   Nginx.      : <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> expresscompletewebsite.dev location / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://127.0.0.1:3000; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$http_host</span></span>; } }</code> </pre> <br><br> ,       Apache  Nginx       .  ,      80.  ,            ,           .    ,      . <br><br><h4>  Conclusion </h4><br> Express ‚Äî   ,        -.      ,    ,             .    ,    middleware'       . <br><br><h5>  Source </h5><br>   -,      ,  GitHub ‚Äì <a href="https://github.com/tutsplus/build-complete-website-expressjs">https://github.com/tutsplus/build-complete-website-expressjs</a> .     .      -: <br><ul><li>  <a href="https://github.com/tutsplus/build-complete-website-expressjs"> </a> </li><li>      </li><li>  npm install </li><li>   mongodb </li><li>  node app.js </li></ul><br></div><p>Source: <a href="https://habr.com/ru/post/192256/">https://habr.com/ru/post/192256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192244/index.html">Amazon opened the delivery of electronics in Russia</a></li>
<li><a href="../192248/index.html">Summer alarm: we are looking for cloud CRM</a></li>
<li><a href="../192250/index.html">We fasten SMS to cacti</a></li>
<li><a href="../192252/index.html">How to connect to Hyperboria</a></li>
<li><a href="../192254/index.html">Mini-study, improvement and bot for the game Shadow Worlds</a></li>
<li><a href="../192258/index.html">Connecting the accelerometer to the Raspberry Pi using the Pi4J library</a></li>
<li><a href="../192262/index.html">GWT-Platform basics of working with presenters</a></li>
<li><a href="../192266/index.html">Perfect migration using Catch-> Evernote</a></li>
<li><a href="../192268/index.html">Gradle and Automation Solution</a></li>
<li><a href="../192270/index.html">If programming languages ‚Äã‚Äãwere child constructors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>