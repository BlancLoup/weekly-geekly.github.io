<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Once again about encryption GOST 28147-89</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="FTM has already talked about the implementation of this encryption algorithm: both in general and about the simple replacement mode . After studying t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Once again about encryption GOST 28147-89</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/users/ftm/" class="user_link">FTM</a> has already talked about the implementation of this encryption algorithm: <a href="http://habrahabr.ru/post/80967/">both in general</a> and about <a href="http://habrahabr.ru/post/81032/">the simple replacement mode</a> .  After studying the existing libraries and individual implementations of this GOST in C #, I decided to write my bicycle, first of all, for the sake of interest and experience.  I would like to share the results of this work with a respected community. <br><a name="habracut"></a><br>  GOST 28147-89 is a symmetric block encryption algorithm with a 256-bit key, operates with data blocks of 64 bits each. <br>  One of its modes of operation, gamming with feedback, is the stream mode of the block cipher. <br><br><h2>  Algorithm Description </h2><br><ol><li>  The original message is divided into blocks of 64 bits. </li><li>  Each block XOR'om "superimposed" gamma, also a length of 64 bits </li><li>  Gamma is generated by encrypting a 64-bit ‚Äústate‚Äù block using a key in the simple replacement mode <br><ul><li>  At the time of the beginning of the message encryption, the block is assumed to be equal to the sync send or initialization vector </li><li>  In the next iteration, the encrypted block of text from the previous one is used instead of the sync package. </li></ul></li></ol><br>  Please note that the above sequence of actions is valid for both encryption and decryption.  The difference is where the encrypted text block comes from to process the next block, this is best seen in the picture: <br><br><img src="https://habrastorage.org/files/56d/e5f/d8e/56de5fd8ead7450d873e4bc1f1ee0f4f.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Implementation </h2><br>  This algorithm was implemented in the form of a plug-in to the KeePass password manager. <br>  <a href="https://github.com/yaruson/GostPlugin">Sources</a> are available on GitHub. <br><br><h3>  Feedback Gamming </h3><br>  Below is a code snippet of a class that implements the standard <b>ICryptoTransform</b> interface, which actually performs cryptographic data transformation block by block.  When creating an instance, the <b>value of synchrumming is</b> recorded in the <b>_state</b> attribute, <b>then the</b> next block of encrypted data is entered into it from the direction of work (encryption or decryption). <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TransformBlock</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] inputBuffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> inputOffset, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> inputCount, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] outputBuffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> outputOffset</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] dataBlock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[inputCount]; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] gamma = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[GostECB.BlockSize]; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[inputCount]; Array.Copy(inputBuffer, inputOffset, dataBlock, <span class="hljs-number"><span class="hljs-number">0</span></span>, inputCount); gamma = GostECB.Process(_state, _key, GostECB.SBox_CryptoPro_A, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); result = XOr(dataBlock, gamma); Array.Copy(result, <span class="hljs-number"><span class="hljs-number">0</span></span>, outputBuffer, outputOffset, inputCount); Array.Copy(_encrypt ? result : dataBlock, _state, inputCount); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> inputCount; }</code> </pre> <br><h3>  Simple replacement mode </h3><br>  <b>GostECB.Process</b> - implementation of the same GOST in the simple replacement mode, or ‚Äúelectronic code book‚Äù.  A good description of the algorithm is in the <a href="https://ru.wikipedia.org/wiki/%25D0%2593%25D0%259E%25D0%25A1%25D0%25A2_28147-89">corresponding section of the Wikipedia article</a> , as well as in the article <a href="http://habrahabr.ru/post/81032/">GOST 28147-89 (Part 2. Simple replacement mode)</a> in Habrahabr. <br><br>  The size of the snooze, gamma and ‚Äústate‚Äù is 64 bytes, so encryption in the simple replacement mode can be considered within one block.  However, there would be several - they would simply be encrypted in turn. <br><br><div class="spoiler">  <b class="spoiler_title">The source code of the GostECB.Process method</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Process</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[][] sBox, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> encrypt</span></span></span><span class="hljs-function">)</span></span> { Debug.Assert(data.Length == BlockSize, <span class="hljs-string"><span class="hljs-string">"BlockSize must be 64-bit long"</span></span>); Debug.Assert(key.Length == KeyLength, <span class="hljs-string"><span class="hljs-string">"Key must be 256-bit long"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = BitConverter.ToUInt32(data, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b = BitConverter.ToUInt32(data, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subKeys = GetSubKeys(key); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">8</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> keyIndex = GetKeyIndex(i, encrypt); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subKey = subKeys[keyIndex]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fValue = F(a, subKey, sBox); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> round = b ^ fValue; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &lt; <span class="hljs-number"><span class="hljs-number">31</span></span>) { b = a; a = round; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { b = round; } } Array.Copy(BitConverter.GetBytes(a), <span class="hljs-number"><span class="hljs-number">0</span></span>, result, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>); Array.Copy(BitConverter.GetBytes(b), <span class="hljs-number"><span class="hljs-number">0</span></span>, result, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br></div></div><br>  To work with 32-bit parts of the source block it is very convenient to use the <b>uint</b> type. <br>  So, in the <b>F ()</b> function, the addition modulo the key and the part of the block, as well as the cyclic shift by 11 bits, is written simply and concisely: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">uint</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">F</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> block, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> subKey, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[][] sBox</span></span></span><span class="hljs-function">)</span></span> { block = (block + subKey) % <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>.MaxValue; block = Substitute(block, sBox); block = (block &lt;&lt; <span class="hljs-number"><span class="hljs-number">11</span></span>) | (block &gt;&gt; <span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> block; }</code> </pre><br>  The substitution method on S-blocks works with 4-bit pieces of a 32-bit sub-block, it is quite convenient to separate them with a bitwise shift and further multiplication by <b>0x0f</b> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">uint</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Substitute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[][] sBox</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> index, sBlock; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; i++) { index = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &gt;&gt; (<span class="hljs-number"><span class="hljs-number">4</span></span> * i) &amp; <span class="hljs-number"><span class="hljs-number">0x0f</span></span>); sBlock = sBox[i][index]; result |= (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)sBlock &lt;&lt; (<span class="hljs-number"><span class="hljs-number">4</span></span> * i); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br>  Encryption from decryption in simple replacement mode differs in the order in which keys are used.  Actually, with reference to the gamma-linking mode with feedback, we do not need to decipher anything, however, for completeness of the implementation, this possibility can be foreseen: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetKeyIndex</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> encrypt</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> encrypt ? (i &lt; <span class="hljs-number"><span class="hljs-number">24</span></span>) ? i % <span class="hljs-number"><span class="hljs-number">8</span></span> : <span class="hljs-number"><span class="hljs-number">7</span></span> - (i % <span class="hljs-number"><span class="hljs-number">8</span></span>) : (i &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) ? i % <span class="hljs-number"><span class="hljs-number">8</span></span> : <span class="hljs-number"><span class="hljs-number">7</span></span> - (i % <span class="hljs-number"><span class="hljs-number">8</span></span>); }</code> </pre><br><h2>  Sources </h2><br><ul><li>  Article <a href="https://ru.wikipedia.org/wiki/%25D0%2593%25D0%259E%25D0%25A1%25D0%25A2_28147-89">GOST 28147-89 on Wikipedia</a> </li><li>  Description of the modes of operation of block ciphers in the English-language Wikipedia <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation">Block cipher mode of operation</a> </li><li>  Sources of GOST 28147-89 <a href="https://github.com/Gromila/CryptoAlgorithms">Gromila / CryptoAlgorithms implementation</a> on GitHub </li><li>  Sources of the implementation of GOST 28147-89 <a href="https://github.com/sftp/gost28147">sftp / gost28147</a> on GitHub <br></li></ul></div><p>Source: <a href="https://habr.com/ru/post/256843/">https://habr.com/ru/post/256843/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256829/index.html">Features of the introduction of DLL and installation of hooks in Modern-applications Windows 8/10</a></li>
<li><a href="../256831/index.html">As we thought out the designer for children's robotics. #one</a></li>
<li><a href="../256835/index.html">Fans of Chinese pioneers</a></li>
<li><a href="../256839/index.html">Remote control of lighting on standard wiring</a></li>
<li><a href="../256841/index.html">The Telecommunications Regulatory Authority of India (TRAI) leaked more than 2 million email addresses; revenge on Anonymous India</a></li>
<li><a href="../256845/index.html">Anarchy and Data Storage: Does SAN Have a Future?</a></li>
<li><a href="../256849/index.html">SAFEDATA data center: three in one. Migration Chronicles</a></li>
<li><a href="../256851/index.html">Implementation of interval-associative array in Cach√© DBMS</a></li>
<li><a href="../256853/index.html">Layout of responsive emails: a detailed guide (part 1)</a></li>
<li><a href="../256855/index.html">The future of Linux file systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>