<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manage Windows computers from the Linux console</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here the task of managing a computer on Windows from Linux was considered. Solved using winexe. 

 The similar problem of remote installation of softw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Manage Windows computers from the Linux console</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/post/181103/">Here</a> the task of managing a computer on Windows from Linux was considered.  Solved using winexe. <br><br>  The similar problem of remote installation of software, checking the status, remote shutdown / reboot of a large group of Windows computers (classrooms) below is solved using <a href="http://www.freesshd.com/%3Fctt%3Ddownload">freeSSHd</a> - ssh server for Windows. <br><br>  The site is only the latest version of freeSSHd - 1.3.1.  It works for me unstable (sometimes the service drops).  The previous version - 1.2.4 - works fine from XP to Win8.1, although there is a <a href="https://www.exploit-db.com/exploits/11842/">small exploit</a> - but it seems like nothing except how to fill up the FreeSSHDService service, so you can close your eyes to this.  Just in case, put this version <a href="https://drive.google.com/file/d/0B85Eryrj4yxZTXpQWElfNTVnVzQ/view%3Fusp%3Dsharing">here</a> (size - 782456) <br><a name="habracut"></a><br>  Run the installer, in the process we change the installation path ("C: \ Program Files (x86) \ FreeSSHD") to C: \ bin \ FreeSSHD - it is easier to find it on systems with different architecture and the config will be the same everywhere.  (C: \ bin must first be created.) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Then everything is by default - at the end of the FreeSSHDService service starts.  It can be configured by clicking the tray icon, but it is easier to copy the finished settings to the C: \ bin \ FreeSSHD \ FreeSSHDService.ini settings file and restart the service. <br><div class="spoiler">  <b class="spoiler_title">Example FreeSSHDService.ini:</b> <div class="spoiler_text"><pre><code class="hljs tex">[Telnet server] TelnetListenAddress=0.0.0.0 TelnetListenPort=23 TelnetMaxConnections=0 TelnetTimeout=0 TelnetBanner= TelnetCMD=C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system</span></span></span></span>32<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cmd</span></span></span></span>.exe TelnetRun=0 TelnetNewConsole=1 [SSH server] SSHListenAddress=0.0.0.0 SSHListenPort=22 SSHMaxConnections=0 SSHTimeout=0 SSHBanner= SSHCMD=C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system</span></span></span></span>32<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cmd</span></span></span></span>.exe SSHRun=1 SSHNewConsole=1 SSHCiphers=0 SSHMACs=65535 SSHPasswordAuth=0 SSHPublickeyAuth=0 SSHPublickeyPath=C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bin</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">freeSSHd</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>RSAKeyPath=C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bin</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">freeSSHd</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RSAKey</span></span></span></span>.cfg DSAKeyPath=C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bin</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">freeSSHd</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DSAKey</span></span></span></span>.cfg [SSH tunneling] SSHLocalTunnel=0 SSHLocalTunnelOnly=0 SSHRemoteTunnel=0 SSHRemoteTunnelOnly=0 [SFTP] SFTPHomePath=<span class="hljs-formula"><span class="hljs-formula">$HOME</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span><span class="hljs-string"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-string">[Access filtering]</span></span></span></span></span><span class="hljs-formula"> HostRestrictions= HostRestrictionsAllow=0 [Logging] LogEvents=0 LogFilePath=C:</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">bin</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">freeSSHd</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">freesshd</span></span></span></span></span><span class="hljs-formula">.log LogResolveIP=0 [Automatic updates] UpdateCheckOnStartup=0 UpdateDontPrompt=0 UpdateShowMessages=1 UpdateLastMessageID=0 [Users] UserCount=1 [User0] Name=admin Auth=2 Password=000000000000000000000000000000000000000000 Domain= Shell=1 SFTP=1 Tunnel=1</span></span></code> </pre> </div></div><br>  Now it is necessary to complete the announced user admin - create the file C: \ bin \ FreeSSHD \ admin and write the public key there. <br><br>  Either use the existing id_dsa.pub, or in <b>the Linux console,</b> type <br><pre> <code class="hljs objectivec">/<span class="hljs-meta"><span class="hljs-meta"># ssh-keygen -t dsa</span></span></code> </pre> <br>  and get a pair of keys - id_dsa and id_dsa.pub <br>  On Windows, copy id_dsa.pub to the C: \ bin \ FreeSSHD directory and rename it to C: \ bin \ FreeSSHD \ admin <br><br>  Restarting FreeSSHDService service: <br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">net</span></span> stop FreeSSHDService &amp; <span class="hljs-built_in"><span class="hljs-built_in">net</span></span> <span class="hljs-built_in"><span class="hljs-built_in">start</span></span> FreeSSHDService</code> </pre> <br><br>  On Linux, we check the connection (listing the root C: \): <br><pre> <code class="hljs objectivec">/<span class="hljs-meta"><span class="hljs-meta"># ssh -2q -i </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;my_key_files_path&gt;</span></span></span><span class="hljs-meta">/id_dsa -ladmin -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Win_Host_IP&gt;</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cmd /c dir c:\\"</span></span></span></span></code> </pre> <br>  If the host rejects the connection (on win7-win8 probably), configure the Firewall in the "Network Control Center ...": <br>  <i>Windows Firewall -&gt; network troubleshooting -&gt; incoming connections -&gt; something else -&gt; review -&gt; C: \ bin \ FreeSSHD \ FreeSSHDService.exe</i> <br><br>  If everything worked out, copy the directory C: \ bin \ FreeSSHD \ to all the other computers - then during the installation FreeSSHD will ask far fewer questions and the already configured will start.  Of course, you can implement all this and configure the Firewall through Group Policy, but I did not bother with this - all the computers were cloned from one successful image. <br><br>  Now you can execute any (almost) command on any computer. <br>  For example, reboot: <br><pre> <code class="hljs objectivec">/<span class="hljs-meta"><span class="hljs-meta"># ssh -2q -i </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;my_key_files_path&gt;</span></span></span><span class="hljs-meta">/id_dsa -ladmin -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Win_Host_IP&gt;</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cmd /c shutdown /r /t 1"</span></span></span></span></code> </pre> <br><br>  Installation 1s (silent): <br><pre> <code class="hljs tex">/# ssh -2q -i &lt;my_key_files_path&gt;/id_dsa -ladmin -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>&lt;Win_Host_IP&gt; "cmd /c start <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>&lt;Server_IP&gt;<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>buh<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>1Ccurrent<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>setup /s"</code> </pre> <br>  Since the access is console, then when you try to start the program from the GUI, you must use the start from the new window - ‚Äústart‚Äù.  Although silent installation of 1C and does not require a GUI. <br><br>  When there are many computers, the launch of commands in turn is ineffective, it is necessary to fork sessions. <br>  A Python demo program that polls computers in the 192.168.0.210-192.168.0.220 range and writes their names to the /tmp/rexec.log log.  Those who do not answer are marked as NA, and hung sessions -? T: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python # -*- coding: utf-8 -*- log = '/tmp/rexec.log' host_range = range(210,220) ip_first_3 = '192.168.0' my_key = '/root/.ssh/id_dsa' my_cmd = 'hostname' #  #my_cmd = 'shutdown /s /t 10' # #my_cmd = r'\\\\srv1\\shar1\\mycmd.bat' #       import os,sys,time,subprocess from datetime import datetime try: cmd = '/usr/bin/ssh -2q -oBatchMode=yes -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null -i%s -ladmin %s.%%d "cmd /c %s " ' % (my_key,ip_first_3,my_cmd) procs,out,err = [],[],[] for x in host_range: xcmd = cmd % x procs.append([x,subprocess.Popen(xcmd,stdout=subprocess.PIPE,stderr=subprocess.STDOUT,shell=True,bufsize=4096,executable='/bin/bash')]) for i in range(0,20): #20   1  stop = True for proc in procs: # print i, proc[0] if proc[0] == 0: continue try: res = proc[1].poll() if res == None: stop = False continue if res == 0: out.append("%d:%s" % (proc[0],proc[1].stdout.read().splitlines()[0])) #  1   ! else: err.append("%d:NA" % proc[0]) except: err.append("%d:EX" % proc[0]) proc[0]=0 if stop: break time.sleep(1) if not stop: #   for proc in procs: if proc[0] != 0: proc[1].terminate() err.append("%d:?T" % proc[0]) s = "%s|%s" % ('; '.join(out),'; '.join(err)) except: s = "!!! Error" print s with open(log, "ab") as fp: fp.write("--- %s cmd=%s\n" % (datetime.strftime(datetime.now(), "%Y.%m.%d %H:%M:%S"),my_cmd)) fp.write(" Result: %s\n" % s)</span></span></code> </pre> <br>  (The source program was a CGI script, hence the minimalism of the output) <br><br>  Difficult and long teams are better arranged in a batch file and placed in an accessible network path.  On a Samba resource, you must give the file permissions to execute and arrange line ends in the style of Windows. </div><p>Source: <a href="https://habr.com/ru/post/259469/">https://habr.com/ru/post/259469/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259457/index.html">How did jQuery start</a></li>
<li><a href="../259459/index.html">Understanding x64 support in WPE Pro</a></li>
<li><a href="../259463/index.html">We calculate gamemasters characters in World of Warcraft using Python</a></li>
<li><a href="../259465/index.html">Modeling objects for animation on Canvas</a></li>
<li><a href="../259467/index.html">How to write your NIF in Elixir</a></li>
<li><a href="../259471/index.html">API Jellyfish: write full text RSS</a></li>
<li><a href="../259473/index.html">Compass with PWM on the stm32f3discovery debug board</a></li>
<li><a href="../259475/index.html">Another language recognizer 4</a></li>
<li><a href="../259477/index.html">That the new versions of the UEFI standards are prepared for us, part two, ACPI 6.0</a></li>
<li><a href="../259479/index.html">Configure OpenSWAN IPsec PSK using NAT Traversal (NAT-T)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>