<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a pivot table of attendance of several sites using Yandex.Metrics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The task was to create a visitor registration system for a couple of dozen sites. Sites belong to gaming associations (clans) of a single gaming commu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a pivot table of attendance of several sites using Yandex.Metrics</h1><div class="post__text post__text-html js-mediator-article"> The task was to create a visitor registration system for a couple of dozen sites.  Sites belong to gaming associations (clans) of a single gaming community.  So to say, you need a pivot table in which you will immediately see which site is more popular.  The customer approved the counting of unique visitors. <br><br>  Since the customer had no solid idea of ‚Äã‚Äãwhat and how, I could do anything (technical specifications were not available either).  Wrote the accounting system (PHP, MySQL).  Unique hosts were identified by IP, cookie entries and entries in the DOM storage.  In fact, it was an experiment that was not completed.  The new version of the accounting system had to use the counters of a ready-made system, such as Yandex.Metrica, Google Analytics, LiveInternet, and the like.  I chose Yandex, because there is an API and a sensible reference.  The use example peeped on Habr√©.  To work with the metrics API, you need an OAuth token.  I will not describe the procedure for obtaining it, everything is in the certificate. <br><a name="habracut"></a><br>  A bit of specifics. <br>  First we get a list of counters: <i><code><a href=""></a> api-metrika.yandex.ru/counters.json?oauth_token=000000000000000000000000000000&amp;pretty=1</code></i>  <i><code><a href=""></a> api-metrika.yandex.ru/counters.json?oauth_token=000000000000000000000000000000&amp;pretty=1</code></i> Token, of course, each developer has a unique one. <br>  Next, for each counter from the resulting list, we get the number of visitors for the reporting period, say, January 2013: <i><code><a href=""></a> api-metrika.yandex.ru/stat/traffic/summary.json?id=12345678&amp;oauth_token=000000000000000000000000000000&amp;pretty=1&amp;date1=20130101&amp;date2=20130131&amp;group=month&amp;per_page=1</code></i>  <i><code><a href=""></a> api-metrika.yandex.ru/stat/traffic/summary.json?id=12345678&amp;oauth_token=000000000000000000000000000000&amp;pretty=1&amp;date1=20130101&amp;date2=20130131&amp;group=month&amp;per_page=1</code></i> Where id = 12345678, this is the <i><code><a href=""></a> api-metrika.yandex.ru/stat/traffic/summary.json?id=12345678&amp;oauth_token=000000000000000000000000000000&amp;pretty=1&amp;date1=20130101&amp;date2=20130131&amp;group=month&amp;per_page=1</code></i> id = <i><code><a href=""></a> api-metrika.yandex.ru/stat/traffic/summary.json?id=12345678&amp;oauth_token=000000000000000000000000000000&amp;pretty=1&amp;date1=20130101&amp;date2=20130131&amp;group=month&amp;per_page=1</code></i> <br>  The obtained data is shown in the pivot table. <br><br>  It would seem that the task is completed, but it was not there!  There were malicious elements that wanted to distort the indicators.  These unscrupulous comrades contact the traffic exchange and buy referrals to a site from the group, or to several at once.  Traffic does not bring such benefits to the site, people working on these exchanges will not remain on the site in more than 99% of cases.  Another point is that in the settings of the traffic exchange there can be such an item - ‚Äúdo not send the referrer‚Äù.  In this case, the transitions to the site look as if they hit the site using a bookmark in the browser.  I came up with three solutions to the problem, but as long as none have been submitted to work, I can‚Äôt choose the best one. <br><ol><li>  Count the visits that lasted more than 30 seconds. </li><li>  Count the visits that were visited two or more pages. </li><li>  Create a goal for each counter of a metric - a visit to two pages and count how many times the goal was achieved at a given visit time, for example, more than 30 seconds.  Hybrid first two options. </li></ol><br>  For the first two options, we obtain the data as follows: <i><code><a href=""></a> api-metrika.yandex.ru/stat/traffic/deepness.json?id=12345678&amp;oauth_token=000000000000000000000000000000&amp;pretty=1&amp;date1=20130101&amp;date2=20130131&amp;group=month&amp;per_page=1</code></i>  <i><code><a href=""></a> api-metrika.yandex.ru/stat/traffic/deepness.json?id=12345678&amp;oauth_token=000000000000000000000000000000&amp;pretty=1&amp;date1=20130101&amp;date2=20130131&amp;group=month&amp;per_page=1</code></i> Then we <i><code><a href=""></a> api-metrika.yandex.ru/stat/traffic/deepness.json?id=12345678&amp;oauth_token=000000000000000000000000000000&amp;pretty=1&amp;date1=20130101&amp;date2=20130131&amp;group=month&amp;per_page=1</code></i> up the visits to <i><code><a href=""></a> api-metrika.yandex.ru/stat/traffic/deepness.json?id=12345678&amp;oauth_token=000000000000000000000000000000&amp;pretty=1&amp;date1=20130101&amp;date2=20130131&amp;group=month&amp;per_page=1</code></i> Then we <i><code><a href=""></a> api-metrika.yandex.ru/stat/traffic/deepness.json?id=12345678&amp;oauth_token=000000000000000000000000000000&amp;pretty=1&amp;date1=20130101&amp;date2=20130131&amp;group=month&amp;per_page=1</code></i> up visits to <i><code><a href=""></a> api-metrika.yandex.ru/stat/traffic/deepness.json?id=12345678&amp;oauth_token=000000000000000000000000000000&amp;pretty=1&amp;date1=20130101&amp;date2=20130131&amp;group=month&amp;per_page=1</code></i> , 3 ... 14, 15+, according to the number of pages viewed).  Or, we add visits in which the <i>name</i> is equal to the required visit time (the <i>name</i> has the values ‚Äã‚Äã"0 - 10 sec.", "11 - 30 sec." And so on to "10 - 30 min.", "More than 30 min.").  The third option is to count targeted visits, for it you need to know the goal id (goal_id) for each counter: <i><code><a href=""></a> api-metrika.yandex.ru/counter/12345678/goals.json?pretty=1&amp;oauth_token=000000000000000000000000000000</code></i>  <i><code><a href=""></a> api-metrika.yandex.ru/counter/12345678/goals.json?pretty=1&amp;oauth_token=000000000000000000000000000000</code></i> And then, as in the first version, we add the necessary data (for example, more than 30 seconds per session). <br>  I don't like these ways.  Still, I want to count, not visits, but visitors.  There is also a way in which you need to add a couple of lines to the javascript code of the metric counters.  Changing the code will affect the accounting system.  The visitor will be counted not immediately, but after a specified time.  That is, if the user leaves the site before the timer is triggered, his visit will not be taken into account (the defer property and the hit method).  The option is also not very convenient - to change the counters on a heap of sites, then follow, so that the counters do not change again (each site has its own owner).  Inconvenient.  The administration of the metric promised to create a tool for filtering out "bots", but when it will be done is unknown. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a result, we got an almost working system.  I myself tend to use the third, combined method of recording visits.  Let's see what the customer will say ... <br><br>  Maybe someone from reading this article has already struggled with the "cheating" and won them?  It would be very interesting to know how. <br><br>  Help on the metric <a href="http://help.yandex.ru/metrika">http://help.yandex.ru/metrika</a> <br>  API help on metrics <a href="http://api.yandex.ru/metrika">http://api.yandex.ru/metrika</a> </div><p>Source: <a href="https://habr.com/ru/post/166433/">https://habr.com/ru/post/166433/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../166419/index.html">No need to make promises or vice versa</a></li>
<li><a href="../166421/index.html">We understand the development of Windows 8 applications on XAML / –° #, implementing a simple RSS Reader. Part 3</a></li>
<li><a href="../166425/index.html">Opera Ice: New browser for mobile platforms on WebKit</a></li>
<li><a href="../166427/index.html">Triac power controller with microcontroller control</a></li>
<li><a href="../166429/index.html">Competition for students and supervisors: "Microsoft UniApps Challenge"</a></li>
<li><a href="../166435/index.html">What nobody told you about z-index</a></li>
<li><a href="../166439/index.html">Usability Hint: The scroll bar on the comment page should display the actual position in the text.</a></li>
<li><a href="../166441/index.html">We program AGC (auto volume control) on VB.Net</a></li>
<li><a href="../166443/index.html">An app that overtakes Instagram</a></li>
<li><a href="../166451/index.html">International Web Camp will come to Russia as part of Windows Azure Summit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>