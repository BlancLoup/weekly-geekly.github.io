<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introduction to cycle optimization techniques</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most of the program execution time falls on cycles: it can be calculations, reception and processing of information, etc. Proper application of optimi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introduction to cycle optimization techniques</h1><div class="post__text post__text-html js-mediator-article">  Most of the program execution time falls on cycles: it can be calculations, reception and processing of information, etc.  Proper application of optimization techniques cycles will increase the speed of the program.  But before embarking on optimizations, it is necessary to identify the ‚Äúnarrow‚Äù places of the program and try to find the reasons for the drop in performance. <br><a name="habracut"></a><br>  The execution time of the code in cycles depends on the organization of the memory, the processor architecture, including the supported set of instructions, pipelines, caches and programmer's experience. <br>  Consider some methods of loop optimization: loop unrolling, loop fusion, loop distribution, loop alignment, loop interchange, loop blocking. <br>  Before applying any optimization, do the simplest thing: <b>remove all variables from the loop that do not change in it</b> . <br><br><h5>  What reasons can lead to a decrease in the speed of the program in cycles? </h5><ol><li>  Loop iterations are dependent and cannot be executed in parallel. </li><li>  The loop body is large and too many registers are required. </li><li>  The body of the cycle or the number of iterations is small and profitable to completely abandon the use of the cycle. </li><li>  The loop contains calls to functions and procedures from third-party libraries. </li><li>  The loop intensively uses any one processor execution unit. </li><li>  In the loop there are conditional transitions. </li></ol><h5>  Sweep cycles </h5><br>  This optimization is performed when the body of the loop is small.  It is necessary to more effectively use executing devices at each iteration.  Therefore, repeatedly duplicate the body of the cycle, depending on the number of performing devices.  But such optimization can cause a data dependency, in order to get rid of it, additional variables are introduced. <br><table><tbody><tr><td>  Before </td><td>  After </td><td>  After # 2 </td></tr><tr><td><code><font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; iN; i++){ <br> res *= a[i]; <br> }</font></code> </td> <td> <code><font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; iN; i+=3){ <br> res *= a[i]; <br> res *= a[i+1]; <br> res *= a[i+2]; <br> }</font></code> </td> <td> <code><font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; iN; i+=3){ <br> res1 *= a[i]; <br> res2 *= a[i+1]; <br> res3 *= a[i+2]; <br> } <br> res = res1 * res2 * res3;</font></code> </td> </tr></tbody></table>  The following keys can be used in gcc: <i>-funroll-all-loops -funroll-loops</i> . <br><br><h5>  Cycle integration </h5><br>  The loop can have long-running instructions, for example, extracting square roots.  Or there are several cycles that run on the same interval of indices.  Therefore, it is advisable to combine cycles for a more balanced load of performing devices. <br><table><tbody><tr><td>  Before </td><td>  After </td></tr><tr><td> <code><font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; iN; i++){ <br> a[i] = b[i] - 5; <br> } <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; iN-1; i++){ <br> d[i] = e[i] * 3; <br> }</font></code> </td> <td> <code><font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; iN-1; i++){ <br> a[i] = b[i] - 5; <br> d[i] = e[i] * 3; <br> } <br> a[iN-1] = b[iN-1] - 5;</font></code> </td> </tr></tbody></table><br><h5>  Cutting cycles </h5><br>  This optimization is used when the loop body is large and the variables are not enough registers.  Therefore, the data is first pushed into the cache, and if absolutely everything is bad, then in the RAM.  <b>And access to RAM takes about 300 processor cycles, and access to L2 is only ~ 10.</b>  Access to memory with a big step slows down the program even more.  It is optimal to ‚Äúwalk‚Äù in memory in increments of <i>2 <sup>n</sup></i> , where n is a rather small number (&lt;7). <br><table><tbody><tr><td>  Before </td><td>  After </td></tr><tr><td> <code><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> j = 0; j &lt; jN; j++){ <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> k = 0; k &lt; kN; k++){ <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> m = 0; m &lt; mN; m++){ <br> i = j * k + m; <br> a[i] = b[i] * c[i] + f[i]/e[i]+ x[i] - y[i] + <br> z[i]/r[i] + d[i] * x[i]; <br> } <br> } <br> }</code> </td> <td> <code><font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> j = 0; j &lt; jN; j++){ <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> k = 0; k &lt; kN; k++){ <br> <font color="#0000ff">double</font> tmp; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> m = 0; m &lt; mN; m++){ <br> i = j * k + m; <br> tmp = b[i] * c[i] + f[i]/e[i]; <br> a[i] = tmp - y[i] + z[i]/r[i] + <br> (d[i] + 1) * x[i]; <br> } <br> } <br> }</font></code> </td> </tr></tbody></table><br><h5>  Swap cycles </h5><br>  In nested loops, the order of nesting is important.  Therefore, it is necessary to remember how arrays are stored in memory.  A classic example: c / c ++ store matrices line by line, and fortran - column by column. <br><table><tbody><tr><td>  Before </td><td>  After </td></tr><tr><td> <code><font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; iN; i++){ <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> j = 0; j &lt; jN; j++){ <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> k = 0; k &lt; kN; k++){ <br> c[i][j] = c[i][j] + a[i][k] * b[k][j]; <br> } <br> } <br> }</font></code> </td> <td> <code><font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; iN; i++){ <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> k = 0; k &lt; kN; k++){ <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> j = 0; j &lt; jN; j++){ <br> c[i][j] = c[i][j] + a[i][k] * b[k][j]; <br> } <br> } <br> }</font></code> </td> </tr></tbody></table>  Now calls to the array <i>a</i> go sequentially. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Splitting cycles into blocks </h5><br>  If the loop body is complex, then this optimization can be applied to better locate the data in memory and improve the use of caches.  The result of the optimization depends heavily on the processor architecture. <br><table><tbody><tr><td>  Before </td><td>  After </td></tr><tr><td> <code><font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; iN; i++){ <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> j = 0; j &lt; jN; j++){ <br> a[i][j] = a[i][j] + b[i][j]; <br> } <br> }</font></code> </td> <td> <code><font color="black"><font color="#008000">//       </font> <br> <font color="#0000ff">int</font> iBlk, jBlk; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> k = 0; k &lt; iN/iBlk; k++){ <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> m = 0; m &lt; jN/jBlk; m++){ <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = k * iBlk; i &lt; ((k + 1) * iBlk); i++){ <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> j = m * jBlk; j &lt; ((m + 1) * jBlk); j++){ <br> a[i][j] = a[i][j] + b[i][j]; <br> } <br> } <br> } <br> } <br></font></code> </td></tr></tbody></table>  About this principle, MPI technology works: divides large arrays into blocks and sends them to individual processors. <br><br><h5>  Dependency resolution </h5><br>  The best solution is to get rid of.  But not with all dependencies it will turn out. <br><blockquote> <code><font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 1; i &lt; N; i++){ <br> a[i] = a[i-1] + 1; <br> }</font></code> </blockquote>  For this example, it is better to apply the scan, because  the result of the calculation will remain on the registers.  But the majority of such cycles cannot be fully optimized (or parallelized), the result still depends on the previous round of the cycle. <br>  <b>To check the cycle for independence, reverse the direction of motion in the cycle.</b>  <b>If the result of the calculations has not changed, then the iterations of the cycle are independent.</b> <b><br></b> <br><h5>  Regarding conditional transitions </h5><br>  Loss of time occurs due to errors in the prediction of transitions, because you have to roll back the pipeline.  Therefore, it is best to abandon the conventional structures.  But, if this is impossible, you need to try to facilitate the work of the transition prediction module.  To do this, <b>place the most likely branches at the beginning of the branch</b> and, if possible, move the conditional constructions beyond the cycle. <br><br><h5>  Instead of conclusion </h5><br>  If you create a complex program that will take a lot of CPU time, then <ol><li>  Familiarize yourself with the processor architecture (find out how many and what execution devices it has, how many pipelines, L1 and L2 cache sizes). </li><li>  Try compiling a program with different compilers and with different keys. </li><li>  Consider the impact of the operating system. </li></ol>  I also advise you to read this <a href="http://habrahabr.ru/blogs/hi/111021/">article</a> . <br>  From my own experience, I can say that the proper application of optimizations can improve the speed of the program at times. <br><br>  If you want to practice optimization yourself, then try to calculate the number Pi: <br><img src="https://habrastorage.org/getpro/habr/conversation/5fc/732/2a3/5fc7322a3f6a80cf22ce3bdbe8549e24.png" alt="integral for calculating the number Pi"><br><br>  Below is the ‚Äúbad‚Äù code. <br><blockquote> <code><font color="black"><font color="#0000ff">long</font> N = 10000000; <br> <font color="#0000ff">double</font> dx, sum, x; <br> sum = 0.0; <br> x = 0.0; <br> dx = 1.0 / ( <font color="#0000ff">double</font> ) N; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">long</font> i = 0; i &lt; N; i++){ <br> sum += 4.0 / (1.0 + x * x); <br> x += dx; <br> } <br> <font color="#0000ff">double</font> pi = dx * sum;</font></code> </blockquote> <br>  What I didn‚Äôt tell about: vectorization of calculations (SSE instructions);  about prefetchs that make it easier to work with memory.  If there are people ‚Äúwho are interested‚Äù, I will write a separate article about the vectorization of cycles. <br><br><blockquote>  <font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="gray">Source Code Highlighter</font></a> source code <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font color="gray">highlights</font></a> .</font> </blockquote></div><p>Source: <a href="https://habr.com/ru/post/124910/">https://habr.com/ru/post/124910/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../124902/index.html">Dark color scheme for Netbeans</a></li>
<li><a href="../124904/index.html">Ideas for the future: a wrist PC</a></li>
<li><a href="../124905/index.html">Invitation to international research for gamers</a></li>
<li><a href="../124907/index.html">World of Warcraft - a game or a digital drug?</a></li>
<li><a href="../124909/index.html">Comparison of memory consumption for different data storage structures</a></li>
<li><a href="../124911/index.html">Imperavi: a convenient and really beautiful JS WYSIWYG editor</a></li>
<li><a href="../124912/index.html">Chosen drop-down list widget: implement dynamic position adding</a></li>
<li><a href="../124913/index.html">MLAA morphological smoothing algorithm for CPU</a></li>
<li><a href="../124915/index.html">Runkit + PHPUnit = 100% test coverage</a></li>
<li><a href="../124916/index.html">GarageBand - What an almost amateur can ‚Äúwrite‚Äù in 8 minutes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>