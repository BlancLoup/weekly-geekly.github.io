<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How not to use the Node.js Stream API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On the Internet, again, someone is wrong - in yesterday's Node Weekly there was a link to a post in which the author tries to measure and compare the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How not to use the Node.js Stream API</h1><div class="post__text post__text-html js-mediator-article"><p>  On the Internet, again, someone is wrong - in yesterday's <a href="https://nodeweekly.com/issues/261">Node Weekly there</a> was a link <a href="https://itnext.io/streams-for-the-win-a-performance-comparison-of-nodejs-methods-for-reading-large-datasets-pt-2-bcfa732fa40e">to a post</a> in which the author tries to measure and compare the performance of the Stream API in Node.js with its peers.  Sadness causes, how the author works with streams and what conclusions he is trying to do on the basis of this: </p><br><blockquote>  ... this worked out pretty well.  Although it has been streaming its memory </blockquote><p>  Let's try to figure out what is wrong with the conclusions and code of the author. </p><a name="habracut"></a><br><p>  From my point of view, the problem is that the author of the article does not know how to use the Stream and this is a problem with which one has to face quite often.  This phenomenon, in my opinion, has three reasons: </p><br><ol><li>  The complex story of Node.js Stream API - <a href="https://stackoverflow.com/questions/21538812/what-is-streams3-in-node-js-and-how-does-it-differ-from-streams2">pain and suffering are described here.</a> </li><li>  Not the most intuitive API if you try to use it without any wrappers. </li><li>  Rather strange documentation that presents the Stream as something very complex and low-level. </li></ol><br><p>  Together, this leads to the fact that developers often do not know how and do not want to use the Stream API. </p><br><p>  What is wrong with <a href="https://github.com/paigen11/file-read-challenge">the author's code</a> ? <br>  To begin, we will repeat the task here (the original is in English and the link to the file can be found in the post): <br>  There is a certain 2.5 GB file with lines of the form: </p><br><pre><code class="hljs ruby">C00084871<span class="hljs-params"><span class="hljs-params">|N|</span></span>M3<span class="hljs-params"><span class="hljs-params">|P|</span></span><span class="hljs-number"><span class="hljs-number">201703099050762757</span></span><span class="hljs-params"><span class="hljs-params">|15|</span></span>IND<span class="hljs-params"><span class="hljs-params">|COLLINS, DARREN ROBERT|</span></span>SOUTHLAKE<span class="hljs-params"><span class="hljs-params">|TX|</span></span><span class="hljs-number"><span class="hljs-number">760928782</span></span><span class="hljs-params"><span class="hljs-params">|CELANESE|</span></span>VPCHOP&amp;TECH<span class="hljs-params"><span class="hljs-params">|02282017|</span></span><span class="hljs-number"><span class="hljs-number">153</span></span><span class="hljs-params"><span class="hljs-params">||</span></span>PR2552193345215<span class="hljs-params"><span class="hljs-params">|1151824|</span></span><span class="hljs-params"><span class="hljs-params">|P/R DEDUCTION ($76.92 BI-WEEKLY)|</span></span><span class="hljs-number"><span class="hljs-number">4030920171380058715</span></span></code> </pre> <br><p>  You need to parse it and find out the following information: </p><br><ul><li>  Number of lines in the file </li><li>  Names on the 432nd and 43243rd lines (does the question really arise how to count, with 0 or 1?) </li><li>  The most common name and how many times it is found </li><li>  The number of contributions for each month </li></ul><br><p>  What is the problem?  - The author honestly says that he loads the entire file into memory and because of this Node ‚Äúhangs up‚Äù and the author brings us an interesting fact. </p><br><blockquote>  Fun fact: Node.js can only hold up to 1.67GB in memory at any one time </blockquote><p>  The author makes a strange conclusion from this fact that it is the Stream that loads the entire file into memory, and it was not he who wrote the wrong code. <br>  Let's refute the thesis: " <em>Although Node.js was streaming the whole file,</em> " writing a small program that counts the number of lines in a file of any size: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Writable } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'stream'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> split = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'split'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> linecounter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Writable({ write(chunk, encoding, callback) { counter = counter + <span class="hljs-number"><span class="hljs-number">1</span></span> callback() }, writev(chunks, callback) { counter = counter + chunks.length callback() } }) fs.createReadStream(<span class="hljs-string"><span class="hljs-string">'itcont.txt'</span></span>) .pipe(split()) .pipe(linecounter) linecounter.on(<span class="hljs-string"><span class="hljs-string">'finish'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(counter) })</code> </pre> <br><p>  <em>NB</em> : the code is intentionally written as simple as possible.  Global variables are bad! </p><br><p>  What you should pay attention to: </p><br><ul><li>  split - npm package that accepts a stream of strings at the ‚Äúinput‚Äù - returns the stream of rowsets with a split line break to the ‚Äúexit‚Äù.  Most likely done as an implementation of Transformation stream.  We pipe it to our ReadStream with a file, and its pipe in ... </li><li>  linecounter - WritableStream implementation.  In it, we implement two methods: for processing one piece (chunk) and several.  A ‚Äúpiece‚Äù in this situation is the line of code.  The return is the addition of the desired number to the counter.  It is important to understand - we will not load the entire file into memory in this situation, and the API will divide everything for us into the most convenient ‚Äúpieces‚Äù for processing. </li><li>  'finish' - events that ‚Äúhappen‚Äù when the ‚Äúdata‚Äù coming to our ReadableStream ‚Äúend‚Äù.  When this happens, we will log the data counter </li></ul><br><p>  Well, let's test our creation on a large file: </p><br><pre> <code class="hljs markdown"><span class="hljs-quote"><span class="hljs-quote">&gt; node linecounter.js 13903993</span></span></code> </pre> <br><p>  As we see, everything works.  From which we can conclude that the Stream API does an excellent job with files of any size and the statement of the author of the post, to put it mildly, is not true.  Approximately also we can calculate any other value required in the task. </p><br><p>  Tell us: </p><br><ul><li>  Is it interesting for you to read how to solve the problem completely and how to bring the resulting code into a convenient form for tracking? </li><li>  Do you use the Stream API and what difficulties did you encounter? </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/427901/">https://habr.com/ru/post/427901/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../427889/index.html">Wrong, wrong, WRONG! methods of DDoS mitigation</a></li>
<li><a href="../427891/index.html">Millions of people can be attacked through a vulnerability in the Cisco WebEx conferencing platform.</a></li>
<li><a href="../427893/index.html">Bloody Lola on Omega 2 or stifle a python on Halloween</a></li>
<li><a href="../427895/index.html">Deleting data from the shardirovanny base</a></li>
<li><a href="../427899/index.html">JsonWriterSax - a library for creating JSON</a></li>
<li><a href="../427905/index.html">Mining food or "Crossroads" through the eyes of a hacker</a></li>
<li><a href="../427907/index.html">Drone shooting, ‚Äúrakes‚Äù, life hacking, self-development and a photographer / videographer career: a new podcast ‚ÄúGLPH‚Äù</a></li>
<li><a href="../427909/index.html">Python: how to reduce memory consumption by half by adding just one line of code?</a></li>
<li><a href="../427911/index.html">Office passions</a></li>
<li><a href="../427913/index.html">Entertaining prologue # 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>