<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Two-dimensional segment tree (with group modification of elements)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Preface and Problem Statement 
 I think many readers of this site have heard of such a useful structure as a segment tree. And if not, then about him ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Two-dimensional segment tree (with group modification of elements)</h1><div class="post__text post__text-html js-mediator-article"><h4>  Preface and Problem Statement </h4><br>  I think many readers of this site have heard of such a useful structure as a segment tree.  And if not, then about him on the Internet you can find a lot of interesting material ( <a href="http://e-maxx.ru/algo/segment_tree">here</a> , articles on Habr√©: <a href="http://habrahabr.ru/blogs/algorithm/115026/">one</a> and <a href="http://habrahabr.ru/blogs/algorithm/128787/">two</a> <a href="http://habrahabr.ru/blogs/algorithm/115026/">times</a> , google, finally). <br>  Here I will analyze the generalization of the tree of segments into a two-dimensional case, and (unlike <a href="http://e-maxx.ru/algo/segment_tree">this article</a> ) I will consider the implementation of the tree with the support of group modification of elements. <br><a name="habracut"></a><br>  In general, in many cases it is possible to do without a tree of segments in general, for example, to use <a href="http://e-maxx.ru/algo/fenwick_tree">the Fenwick tree</a> ‚Äî it is written much lighter than the tree of segments, it has a smaller constant, and obviously extends to larger dimensions.  But it has at least two minuses: it implements only reversible operations (to make it count the minimum / maximum will have to be considerably distorted, and even then it will not give full freedom of action (in the modification with the maximum - only increase the value, not decrease, with the minimum - on the contrary )) and does not support group modification of elements. <br><br>  A good <a href="http://e-maxx.ru/algo/sqrt_decomposition">SQRT decomposition</a> with a tricky selection of the block length will also sometimes help, but still you can‚Äôt compare it with the power of the segment tree. <br><br>  So, the task. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There is an NxM field, you need to perform two types of queries: <ol><li>  Change cell values ‚Äã‚Äãwith coordinates that satisfy the conditions x1 &lt;= x &lt;= x2, y1 &lt;= y &lt;= y2 to val </li><li>  Calculate the value of a certain function (associative binary operation) from cells with coordinates that satisfy the conditions x1 &lt;= x &lt;= x2, y1 &lt;= y &lt;= y2 </li></ol><br>  Here I will describe the implementation of the solution to the problem, where the function is the sum.  I will say right away that I reached this decision myself (for about 15 hours), so I do not rule out the existence of a simpler one, and I will even be happy to hear it. <br><br><h4>  Tree structure </h4><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a6c/7d0/925/a6c7d092567541c9f536a8157f3222bd.png" alt="image"><br><br>  According to the structure, a two-dimensional segment tree represents a segment tree of segment trees (at each node of a tree of depth X_DEPTH there is an ‚Äúnested‚Äù tree of depth Y_DEPTH).  Hereafter, the depth of the tree is the binary logarithm of the number of elements it can accommodate.  For example, the figure shows a tree of depth 1, each node of which contains a tree of depth 2. Such a tree can process requests of the form [x1; x2] ‚äÜ [0; 1], [y1; y2] ‚äÜ [0; 3]. <br><br>  We enumerate the vertices of these trees (both external and all nested) as ordinary one-dimensional trees. <br>  Then each vertex of the nested one will be characterized by the coordinate [x] [y], x is the number of the vertex of the outer tree in which it is located, y is the inner one. <br><br>  By sector we mean a rectangle formed by the cells x1 &lt;= x &lt;= x2, y1 &lt;= y &lt;= y2.  Then each vertex of the nested subtree is responsible for a certain sector. <br><br>  In each node of the ‚Äúnested‚Äù tree, we will store four parameters: <br><ul><li>  add - the amount by which the result should be increased when requesting an amount on nested sectors (descendants along the xth and yth coordinates) </li><li>  add_x - the value by which the result should be increased when requesting a sum on incompletely nested segments (descendants along the y-th coordinate, but with the same x-th) </li><li>  add_y - the value by which the result should be increased when requesting a sum on incompletely nested segments (descendants of the xth coordinate, but from the same yth) </li><li>  value - the sum in the subtree of the vertex (not counting the additions listed above) </li></ul><br>  In computer memory, as it is easy to understand, this information will be represented by four two-dimensional arrays. <br><br><h4>  Preprocessing operations </h4><br>  When we perform a modification operation, as in the one-dimensional case, we will only change the values ‚Äã‚Äãof the list of vertices defined for this sector.  When summing up on the same sector, we will turn to the same vertices. <br><br>  If we change the value of the vertex [x0] [y0], which is responsible for the sector [x0_1; x0_2] [y0_1; y0_2], it is not difficult to understand that all sectors that include this sector can be found as pairs (x; y): x1 &lt;= x0_1 AND x0_2 &lt;= x2 AND y1 &lt;= y0_1 AND y0_2 &lt;= y2.  that is, it suffices to collect a set of X x-s, Y for y-s, and then iterate through all pairs from XxY. <br>  Well, to collect these same lists, you need to go through the vertices, as is the case with a query on a one-dimensional tree. <br><br>  Considering a particular pair (x; y), one can easily calculate xl, xr, yl, yr ‚Äî the boundaries of the section of the current vertex, and also xc and yc ‚Äî the numbers of elements at the intersections along the x-axis and y-axis axes. <br><br><h4>  Modification operation </h4><br><ol><li>  If the request completely includes the sector of the current vertex, then you need to add to the add vertices a change val (to all descendants both on the x-th and y-th you need to add val): <br>  add + = val; <br></li><li>  If the request includes the current sector only on the xth coordinate, change the add_y: <br>  add_y + = val * xc; <br></li><li>  If the request includes the current sector only for the y-th coordinate, change the add_x: <br>  add_x + = val * yc; <br></li><li>  If the request does not include a sector at all: <br>  value + = val * xc * yc; <br></li></ol><br>  With add, I think everything is clear (see the one-dimensional case). <br><br>  When the request includes the current sector in the y-th coordinate, then in the y-th there may be descendants that will not be affected in this request, but will be in the future if the amount is requested.  That's why we increase add_x. <br>  Similar with add_y. <br><br>  And, finally, if none of the three previous conditions is met, then the environments of direct descendants of a given vertex will change, and the second will not.  Consequently, this change should be taken into account, but not spread further.  Increase value. <br><br><h4>  Summation operation </h4><br>  Let us denote by res the result of the query, which we will calculate.  In addition to preprocessing, let's calculate the bounds of that part of the query that we are looking for at a given vertex (the bounds of the required part): <br><br>  xvl = max (xl, x1), xvr = min (xr, x2), yvl = max (yl, y1), yvr = min (yr, y2) <br><ol><li>  We need to add to all the request cells in the current sector add the current vertex: <br>  res + = add * xc * yc; <br></li><li>  If the sought-for part is equal to the vertex sector in the x-th range: <br>  res + = add_x * yc; <br></li><li>  If the required part is equal to the vertex sector in the y-range: <br>  res + = add_y * xc; <br></li><li>  If the sector of the current vertex is entirely in the query (we will not go down below): <br>  res + = value; <br></li></ol><br><br><h4>  Asymptotics </h4><br>  As can be seen from the description, this solution will work for O (N * X_DEPTH * Y_DEPTH), where N is the number of requests. <br><br><h4>  Implementation </h4><br>  The implementation of this solution can be found at <a href="">http://dl.dropbox.com/u/3693476/articles/segtree2d/segtree2d.cpp</a> (the file is a solution to the Farm problem, D from the file <a href="http://dl.dropbox.com/u/3693476/articles/segtree2d/problems01.pdf">http://dl.dropbox.com/u/ 3693476 / articles / segtree2d / problems01.pdf</a> ).  If you want to get tests for this problem, in order to debug your decision, write your request to my mailbox george.agapov@gmail.com. <br><br>  PS Thank you all for your attention, I hope this article will be useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/131072/">https://habr.com/ru/post/131072/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../131064/index.html">Droider Show # 12. Dmitry Anatolyevich's secret</a></li>
<li><a href="../131065/index.html">How I put together the first analog client for twitter</a></li>
<li><a href="../131067/index.html">We are glad to meet you! ... gY ... gYpost</a></li>
<li><a href="../131068/index.html">Overview of the OS Symbian Belle</a></li>
<li><a href="../131071/index.html">Rules of ant battles</a></li>
<li><a href="../131073/index.html">Interaction of managed and unmanaged code</a></li>
<li><a href="../131074/index.html">PhpBB3 trap system</a></li>
<li><a href="../131076/index.html">New app - Friday - another step towards Siri</a></li>
<li><a href="../131077/index.html">ZF2 EventManager</a></li>
<li><a href="../131078/index.html">CAD consolidation. Remote work on professional graphic stations</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>