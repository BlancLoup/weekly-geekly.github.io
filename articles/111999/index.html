<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Statistics for users using Piwik</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After we brought our users to subdomains , we wanted to have detailed statistics for each subdomain separately, and also to be able to provide these s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Statistics for users using Piwik</h1><div class="post__text post__text-html js-mediator-article">  After we <a href="http://habrahabr.ru/blogs/webdev/101585/">brought our users to subdomains</a> , we wanted to have detailed statistics for each subdomain separately, and also to be able to provide these statistics to the user.  Of course, you can manually connect all subdomains to Google Analytics / Ya.Metrika, but when there are a lot of subdomains, this task starts to look unnecessarily difficult. <br><br>  I wanted some kind of automated solution, and it was found in the form of a statistics system with open source <a href="http://piwik.org/">Piwik</a> .  This system can be installed on your server, add your site to it and use it.  It provides functionality, mostly similar to GA and J.Metrika, + you can write your own plug-ins (for example, I developed a yesterday-today-forecast widget for myself, similar in functionality to the same block from Yandex.metrics). <br><br>  First, for tests, the system kept statistics on 1 domain and 1 subdomain, and coped with it quite successfully, completely replacing Ya.metrika and GA for me.  Accordingly, it was decided to use the Piwik API to implement automatic connection of statistics to user subdomains.  The following was required: <br><ol><li>  Create a user in the Piwik system </li><li>  Create a site in Pivik </li><li>  Give user rights to view site statistics </li><li>  Get the site id to set the counter </li></ol><br><a name="habracut"></a><br>  I will tell you a little about Piwik API.  It works in this way: the whole Piwik consists of modules, and some modules provide API functions.  Any developer can write a module and implement some API function in it, which can then be called. <br>  The call of API functions is easiest to implement by calling to a specific address, like this: <br>  <a href="http://example.com/piwik/index.php%3Fmodule%3DAPI%26method%3DUsersManager.getUsersLogin%26format%3DPHP%26prettyDisplay%3Dtrue%26token_auth%3D14e1b600b1fd579f47433b88e8d85291">example.com/piwik/index.php?module=API&amp;method=UsersManager.getUsersLogin&amp;format=PHP&amp;prettyDisplay=true&amp;token_auth=14e1b600b1fd579f47433b88e8d85291</a> <br>  In this line, <i><a href="http://example.com/piwik/index.php">example.com/piwik/index.php</a></i> is the path to our installed pivik, <i>method = UsersManager.getUsersLogin</i> is a module and function that we call, <i>format = PHP</i> means that we need to get data in the form of a serialized array for use in PHP , <i>prettyDisplay = true</i> is a parameter that accepts an API function and <i>token_auth</i> is our token, which we can get in our pivik on the user management page or on the page with a list of API functions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Accordingly, the easiest way to access the Piwik API from PHP looks like this: <br><pre><code class="hljs perl">$url = <span class="hljs-string"><span class="hljs-string">'http://example.com/piwik/index.php?module=API&amp;method=UsersManager.getUsersLogin&amp;format=PHP&amp;prettyDisplay=true&amp;token_auth=14e1b600b1fd579f47433b88e8d85291'</span></span> $tmp = file_get_contents($url); $response = unserialize($tmp);</code> </pre> <br>  As a result, we get an array of $ response with all the data that Piwik returned to us. <br><br>  We now return to our problem with user statistics.  For all our tasks, the Piwik API has corresponding functions: <br>  <i>UsersManager.addUser</i> to create a new user accepts username, password and user e-mail as parameters <br>  <i>SitesManager.addSite</i> to create a site, takes in the form of parameters the name and url of the site, returns the id of the site in the system <br>  <i>UsersManager.setUserAccess</i> for issuing permissions, accepts user login, site id and access rights as parameters (no-access / view / admin) <br><br>  I didn‚Äôt want to manually execute file_get_contents and unserialize for each request, so I wrote a small wrapper class for Piwik API, in which I implemented methods for creating a user / site and issuing rights. <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">Class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Piwik_api</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $sAuthToken; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $sPiwikUrl; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sAuthToken, $sPiwikUrl)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sPiwikUrl = $sPiwikUrl; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sAuthToken = $sAuthToken; } <span class="hljs-comment"><span class="hljs-comment">/** *   Piwik API * */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sMethodName, $arData, $sFormat = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"PHP"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $url = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sPiwikUrl; $url .= <span class="hljs-string"><span class="hljs-string">"?module=API&amp;method="</span></span> . $sMethodName; $url .= <span class="hljs-string"><span class="hljs-string">'&amp;'</span></span>.http_build_query($arData); $url .= <span class="hljs-string"><span class="hljs-string">"&amp;format=$sFormat"</span></span>; $url .= <span class="hljs-string"><span class="hljs-string">"&amp;token_auth="</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sAuthToken; $tmp = file_get_contents($url); $response = unserialize($tmp); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $response; } <span class="hljs-comment"><span class="hljs-comment">/** *   * */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sUserName, $sUserPassword, $sUserEmail)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;execute(<span class="hljs-string"><span class="hljs-string">'UsersManager.addUser'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">"userLogin"</span></span> =&gt; $sUserName, <span class="hljs-string"><span class="hljs-string">"password"</span></span> =&gt; $sUserPassword, <span class="hljs-string"><span class="hljs-string">"email"</span></span> =&gt; $sUserEmail )); } <span class="hljs-comment"><span class="hljs-comment">/** *   * */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addSite</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sSiteName, $sUrl)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;execute(<span class="hljs-string"><span class="hljs-string">'SitesManager.addSite'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">"siteName"</span></span> =&gt; $sSiteName, <span class="hljs-string"><span class="hljs-string">"urls"</span></span> =&gt; $sUrl )); } <span class="hljs-comment"><span class="hljs-comment">/** *    * */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUserAccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sUserLogin, $sAccess, $iSiteId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;execute(<span class="hljs-string"><span class="hljs-string">'UsersManager.setUserAccess'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">"userLogin"</span></span> =&gt; $sUserLogin, <span class="hljs-string"><span class="hljs-string">"access"</span></span> =&gt; $sAccess, <span class="hljs-string"><span class="hljs-string">"idSites"</span></span> =&gt; $iSiteId )); } }</code> </pre><br>  The addSite method returns a number - this is the site id in the pivik system. <br><br>  Accordingly, using this class, the original problem is solved trivially: just simultaneously with the generation of a user subdomain, we create a user in the Piwik system, create a website and issue rights, and then the user already issues a link to Piwik and his login and password to view the statistics.  Like that: <br><pre> <code class="hljs php"> $oPiwikApi = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Piwik_api(PIWIK_AUTH_TOKEN, PIWIK_URL); $oPiwikApi-&gt;addUser($sLogin, $sPassword, $sEmail); $iPiwikSiteId = $oPiwikApi-&gt;addSite($sSiteName, $sUrl); $oPiwikApi-&gt;setUserAccess($sLogin, <span class="hljs-string"><span class="hljs-string">"view"</span></span>, $iPiwikSiteId);</code> </pre><br><br>  There may be a question of confidence in the statistics - for completely untrusting users, we left the ability to manually connect the GA and Ya. Metrics, and Piwik was made the system for everyone by default. <br><br>  After all these manipulations, users received statistics for their subdomains, completely similar in functionality to GA / Ya. Metric systems, including the entire conversion history, visitors, etc., and each user only sees statistics for his or her domain. <br><br>  <b>UPD:</b> <br>  A review article about the Pivik himself is <a href="http://habrahabr.ru/blogs/personal/76791/">already</a> in Habr√©, this article is rather intended to show how easy and convenient it is to work with it.  By the way, now I discovered that my problem was discussed <a href="http://habrahabr.ru/blogs/personal/76791/">in the comments</a> to that article. <br><br>  The execute method is rewritten using http_build_query. </div><p>Source: <a href="https://habr.com/ru/post/111999/">https://habr.com/ru/post/111999/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111990/index.html">When the router fails to handle the load</a></li>
<li><a href="../111992/index.html">The final version of the open source development environment SharpDevelop 4.0 has been released.</a></li>
<li><a href="../111994/index.html">Do you use the www prefix in the addresses of your sites?</a></li>
<li><a href="../111995/index.html">qrTip: plugin for displaying QR codes for links</a></li>
<li><a href="../111998/index.html">How to spend less time watching videos and listening to audiobooks</a></li>
<li><a href="../112001/index.html">Using bulkloader to backup, restore and migrate data</a></li>
<li><a href="../112002/index.html">A major reorganization awaits Skype this year.</a></li>
<li><a href="../112004/index.html">Jim Collins book abstract ‚ÄúFrom Good to Great‚Äù</a></li>
<li><a href="../112008/index.html">Increase your choice of IT partners with erumpo</a></li>
<li><a href="../112009/index.html">Facebook offers limited access to phone and home address of users to third-party applications.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>