<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring Minio and Nginx for the RoR application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Minio - what is it 


 Minio is a simple, fast and AWS S3 compatible object storage. Minio is designed to accommodate unstructured data, such as photo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring Minio and Nginx for the RoR application</h1><div class="post__text post__text-html js-mediator-article"><h1 id="minio---chto-eto">  Minio - what is it </h1><br><p>  Minio is a simple, fast and AWS S3 compatible object storage.  Minio is designed to accommodate unstructured data, such as photos, videotapes, log files, backup copies, as well as images of virtual machines and containers.  Its small size allows it to be included in the stack of applications similar to Node.js, Redis, and MySQL.  Minio also supports distributed mode (distributed mode), which provides the ability to connect multiple disk objects to a single storage server, including those located on different machines. </p><a name="habracut"></a><br><h1 id="ustanovka-minio">  Install minio </h1><br><h2 id="ustanovka-servera">  Server installation </h2><br><p>  Putting and running Minio is easy </p><br><pre><code class="bash hljs">brew install minio/stable/minio minio server ~/data</code> </pre> <br><p>  As the documentation advises, if the previous version was previously installed without specifying stability, it must be removed and new stable installed </p><br><pre> <code class="bash hljs">brew uninstall minio brew install minio/stable/minio</code> </pre> <br><p>  The server command help will show the basic ways to launch and configure it.  I run it locally </p><br><pre> <code class="bash hljs">minio server --address localhost:9000 ~/data</code> </pre> <br><p>  After starting the server, he will write to what address it can be found, as well as a key with a secret password to access it.  This is basically enough to get started with Minio, for details see the <a href="https://docs.minio.io/">official documentation.</a> </p><br><h2 id="ustanovka-klienta-i-osnovnye-komandy">  Client installation and basic commands </h2><br><p>  With the Minio client, you can work with the repository just like a Unix command line.  Put the client and see the commands </p><br><pre> <code class="bash hljs">brew install minio/stable/mc mc --<span class="hljs-built_in"><span class="hljs-built_in">help</span></span></code> </pre> <br><p>  from useful: </p><br><pre> <code class="bash hljs">mc mb minio/my-uploads-store <span class="hljs-comment"><span class="hljs-comment">#   mc policy -r public minio/my-uploads-store #      mc ls minio/my-uploads-store #      </span></span></code> </pre> <br><p>  The <a href="https://docs.minio.io/docs/minio-client-complete-guide">official reference manual</a> describes everything in some detail. </p><cut></cut><br><h1 id="nginx">  Nginx </h1><br><h2 id="bazovye-nastroyki">  Basic settings </h2><br><p>  Nginx will do a lot of useful things, for example: </p><br><ul><li>  Hide storage on intranet </li><li>  Organize caching </li><li>  Organize load balancing for distributed storage </li><li>  Well, a single entry point for your applications, which will allow you to change the storage without any serious consequences. </li></ul><br><p>  The simplest setup for Nginx to use Minio </p><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> minio.dev; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$http_host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://localhost:9000; } }</code> </pre> <br><p>  Now we can access our repository at minio.dev </p><br><h2 id="keshirovanie">  Caching </h2><br><p>  With caching Minio in Nginx as described in the <a href="https://blog.minio.io/enterprise-grade-cloud-storage-with-nginx-plus-and-minio-e708fb4cb3e8">article</a> I had problems.  As <a href="https://github.com/minio/minio/issues/4120">it turned out</a> - not just me.  Unscrew as follows: </p><br><ul><li>  We write to the repository via a direct link to the repository past Nginx (or through it but without caching) </li><li>  Reading from the repository takes place on another link with caching </li><li>  Correspondingly, in our RoR application the link changes - when writing one, when reading - the other with caching </li></ul><br><div class="spoiler">  <b class="spoiler_title">Nginx config for storage</b> <div class="spoiler_text"><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_path</span></span> /var/cache/nginx/minio_cache levels=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span> keys_zone=minio_cache:<span class="hljs-number"><span class="hljs-number">10m</span></span> max_size=<span class="hljs-number"><span class="hljs-number">10m</span></span> inactive=<span class="hljs-number"><span class="hljs-number">60m</span></span> use_temp_path=<span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> minio_servers { <span class="hljs-comment"><span class="hljs-comment">#       Load Balancing server localhost:9000; } server { listen 80; server_name minio.dev; location / { proxy_cache minio_cache; add_header X-Cache-Status $upstream_cache_status; proxy_cache_revalidate on; proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504; proxy_cache_lock on; proxy_ignore_headers Set-Cookie; proxy_cache_valid 1m; proxy_set_header Host $http_host; proxy_pass http://minio_servers; } }</span></span></code> </pre> </div></div><cut></cut><br><h1 id="ror-prilozhenie">  RoR application </h1><br><h2 id="obschie-nastroyki">  General settings </h2><br><p>  Pictures in Minio are loaded using <a href="http://shrinerb.com/">Shrine</a> (all the details of the work are in good official documentation and articles attached to the documentation, here are just features for Minio).  Directly to work with Minio you need to add to the Gemfile </p><br><pre> <code class="ruby hljs">gem <span class="hljs-string"><span class="hljs-string">'shrine-fog'</span></span> gem <span class="hljs-string"><span class="hljs-string">'fog-aws'</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">config / initializers / shrine.rb</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'shrine/storage/fog'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'fog/aws'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'image_processing/mini_magick'</span></span> minio = Fog::Storage.new( <span class="hljs-symbol"><span class="hljs-symbol">provider:</span></span> <span class="hljs-string"><span class="hljs-string">'AWS'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">aws_access_key_id:</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;key&gt;'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">aws_secret_access_key:</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;secret&gt;'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">region:</span></span> <span class="hljs-string"><span class="hljs-string">'us-east-1'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">endpoint:</span></span> <span class="hljs-string"><span class="hljs-string">'http://localhost:9000/'</span></span>, <span class="hljs-comment"><span class="hljs-comment">#     path_style: true, ) Shrine.storages[:cache] = Shrine::Storage::Fog.new( connection: minio, directory: '&lt;cache-directory&gt;', public: true, ) Shrine.storages[:store] = Shrine::Storage::Fog.new( connection: minio, directory: '&lt;store-directory&gt;', public: true, )</span></span></code> </pre> </div></div><br><p>  It goes without saying that you need to create the appropriate folders through the Minio client and give them full access (see the section above ‚Äî the Minio client). </p><br><div class="spoiler">  <b class="spoiler_title">app / models / avatar_uploader.rb</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AvatarUploader</span></span></span><span class="hljs-class"> &lt; Shrine </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImageProcessing::MiniMagick</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">activerecord</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">determine_mime_type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">analyzer</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mime_types</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">logging</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">logger</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Rails</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">logger</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">remove_attachment</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">store_dimensions</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">remote_url</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">max_size</span></span></span><span class="hljs-class">: 20*1024*1024 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">versions</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default_url</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">processing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host_url</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">minio</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">port</span></span></span><span class="hljs-class">: '80' </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#   ,    Attacher.default_url do |options| #  ,   '/images/default.svg' end process(:cache) do |io, context| #  ,         resize_to_fill!(io.to_io, 300, 300) end end</span></span></span></span></code> </pre> </div></div><br><p>  Actually, most plugins are optional.  For details, see the official shrine documentation.  Treatment as usual: </p><br><pre> <code class="ruby hljs">User.find(<span class="hljs-number"><span class="hljs-number">1</span></span>).avatar_url</code> </pre> <br><h2 id="zamena-ssylki">  Link replacement </h2><br><p>  I had to tinker with the replacement of the link.  Shrine has enough different plug-ins that can be used for most tasks.  There is a plugin for replacing the host with <a href="http://shrinerb.com/rdoc/classes/Shrine/Plugins/DefaultUrlOptions.html">default_url_options</a> , but in this particular case it did not help - it changes the host and ignores the port.  Hm, what to do?  And let's write your own Shrine plugin.  The code of the plugin is lower, as it is connected - in the previous listing (the 80th port by default does not register in the final link, all the rest will appear. You can not write it, by the way). </p><br><div class="spoiler">  <b class="spoiler_title">Plug code</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Shrine</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Plugins</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HostUrl</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">configure</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uploader</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">options</span></span></span><span class="hljs-class"> = {}) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uploader</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host_url</span></span></span><span class="hljs-class">] = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uploader</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host_url</span></span></span><span class="hljs-class">] || {}).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">merge</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">options</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileMethods</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">(**</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">options</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new_uri</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URI</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parse</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">super</span></span></span><span class="hljs-class">), </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uploader</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host_url</span></span></span><span class="hljs-class">][:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host</span></span></span><span class="hljs-class">], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uploader</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opts</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host_url</span></span></span><span class="hljs-class">][:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">port</span></span></span><span class="hljs-class">] ) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new_uri</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new_host</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new_port</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">URI::HTTP</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scheme</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">userinfo</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new_host</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new_port</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">registry</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">path</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opaque</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">query</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uri</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fragment</span></span></span><span class="hljs-class"> ).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to_s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">register_plugin</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host_url</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HostUrl</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> </div></div><br><p>  The code for the new plug-in is set in lib / shrine / plugins / host_url.rb </p><br><h2 id="migraciya-dannyh">  Data migration </h2><br><p>  In the <a href="http://shrinerb.com/rdoc/files/doc/migrating_storage_md.html">official instructions</a> , in principle, everything is described in detail.  There are, however, a few nuances - well, there if ((attacher = user.avatar_attacher) .stored?  for some reason, it returns false and in small detail - you need to add a new storage with the existing old one, make a migration and then cut the old one ... <br>  But in this particular case, everything can be done much easier: </p><br><pre> <code class="bash hljs">rsync -zavP &lt;&gt;@&lt;.&gt;:/&lt;___&gt; ~/data/&lt;store-directory&gt;</code> </pre> <br><p>  Actually, everything out of the box works with the new code. </p><br><h2 id="prochee">  Other </h2><br><p>  Yes, when moving to Minio in the next application, I moved this plugin to <a href="https://github.com/domido-com/shrine-host-url/tree/master">gem</a> . </p><br><h1 id="ispolzovannye-istochniki">  Used sources </h1><br><p>  <a href="https://blog.minio.io/enterprise-grade-cloud-storage-with-nginx-plus-and-minio-e708fb4cb3e8">Enterprise-Grade Cloud Storage with NGINX Plus and Minio</a> and <a href="https://habrahabr.ru/company/southbridge/blog/324086/">Russian translations</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/342640/">https://habr.com/ru/post/342640/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342628/index.html">Tutu.ru: How to spend the IT Day on their own and inexpensively</a></li>
<li><a href="../342632/index.html">Optimize the speed of rendering web pages</a></li>
<li><a href="../342634/index.html">Take care of revision: code analysis automation techniques</a></li>
<li><a href="../342636/index.html">From Kotlin to whip: how did Mobius 2017 Moscow go</a></li>
<li><a href="../342638/index.html">How we created a new type of tariff "Turn on"</a></li>
<li><a href="../342644/index.html">Gorgeous assholes in the making</a></li>
<li><a href="../342654/index.html">Self-oscillations and resonance</a></li>
<li><a href="../342658/index.html">What happens in Kubernetes when starting the kubectl run? Part 1</a></li>
<li><a href="../342660/index.html">UniRx - Rx for Unity3d</a></li>
<li><a href="../342666/index.html">Facebook or Google? Where it is more profitable to advertise in 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>