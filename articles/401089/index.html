<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Expansion card for modeling on Raspberry Pi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A long time ago, the Raspberry Pi microcomputer entered the life of geeks, system administrators, programmers and electronics engineers. Inexpensive a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Expansion card for modeling on Raspberry Pi</h1><div class="post__text post__text-html js-mediator-article">  A long time ago, the Raspberry Pi microcomputer entered the life of geeks, system administrators, programmers and electronics engineers.  Inexpensive and relatively powerful for its class, with built-in I / O ports, it can handle various tasks and meet the needs of the user.  Having bought a Raspberry Pi, I wanted to include, measure, manage external devices.  At the moment, a large number of expansion cards are sold, <a href="https://www.element14.com/community/designcenter/%3FICID%3Dmenubar_designcenter_allhardware%26">for example, as here</a> , you can use the Breadboard with wires for quick prototyping, but I prefer to make the devices myself, for specific tasks.  For the first time, I didn‚Äôt use a double-row comb for all the outputs, but limited myself to several I / O ports, an SPI, I2C and UART bus.  Connect Raspberry Pi with target wires for prototyping "mother-mother." <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/eef/18f/ae2/eef18fae242d47dab3f10bb6a4cfb21b.jpg" alt="image"><br><br>  In this regard, a series of three prototyping boards was developed; I will tell you about the simplest one in this article. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, what was necessary for me: <br><br><ul><li>  Work with GPIO with both inputs and outputs; </li><li>  Load management; </li><li>  Connection of temperature sensors via 1-Wire bus; </li><li>  Voltage measurement; </li><li>  Real time clock; </li><li>  Control and management of external device via RS485 bus; </li><li>  Separate power supply for expansion card; </li></ul><br>  According to the above list, an electrical circuit was developed: <br><img src="https://habrastorage.org/files/cc4/136/432/cc41364328f3449094dc0b05a940a987.jpg" alt="image"><br>  ‚Üí <a href="">Scheme from high-resolution storage</a> <br><br>  The circuit uses a transformer power supply with two output windings.  The first winding works on a linear voltage regulator with an output of 5V, for powering the RS485 driver chip and a real-time clock.  The second winding is used to power the electromagnetic relays and assembly with Darlington transistors. <br><br>  The DS18B20 temperature sensor is powered by + 3.3V from the Raspberry Pi board, there is a connector on the board for connecting external DS18B20 sensors, the same voltage is taken for the ADC and for matching the levels with the real-time clock.  In the scheme, four buttons S1-S4 are used to control any actions that operate on a low logic level.  To control the load transistor assembly is used DD1 ULN2003 with built-in protective diodes.  Relays K1 and K2 are connected to pins 16, 15 of the transistor assembly, LEDs for indication are connected to pins 14-12, pins 11, 10 are intended for connection to external devices according to the scheme with a common collector or additional relays with a winding voltage of + 12V. <br><br>  To measure the voltage, two channels of 10 bit ADC DD3 MCP3008 with SPI interface are used, with an input low-pass filter.  Analog node is made primitively, for academic purposes or quick debugging.  If the question arises about the qualitative measurement of the analog signal, it is necessary to untie the digital and analog ground, use an external source of the reference voltage.  Alternatively, the analog part can be done like this: <br><br><img src="https://habrastorage.org/files/d8d/148/dee/d8d148deee074957a46ab433620aea05.jpg"><br><br>  You only need to use the TTL ‚Üí LVTTL level converter on the SPI bus. <br><br>  The real-time clock DD4 is made on the DS1307 microcircuit; the Q1 crystal at 32.768 KHz is used for clocking.  To power the RAM of the microcircuit of the clock, a 3-volt lithium battery soldered into the board is used.  The microcircuit is connected via a 5V-3.3V level converter made on VT2, VT3 MOSFETs to Raspberry Pi via the I2C bus (In CAD, the connection to the lines without explicit communication was used). <br><br>  As a driver UART ‚Üí RS485, the chip DD2 ST485 is used.  Circuit solutions using the transistor VT1 allowed to abandon a separate output to control the transceiver.  It switches to the transfer mode only when the UART transmits data, the rest of the time ST485 is in receive mode.  The control command transceiver is removed from the collector of the transistor VT1. <br><br>  In addition to interface conversion, this scheme also performs the function of matching the LVTTL levels of the UART Raspberry Pi interface with the TTL levels of the ST485 driver.  The signal taken from the collector of the transistor VT1 tightens the level at the DI input to 5V, and the resistor R16 and the zener diode VD8 limit the level from the output R0 to 3.3V.  Do not pay attention to the resistor R11, it remained in the circuit when debugging.  RS485 is tested with the ModBus RTU protocol at a speed of 115200 baud. <br><br>  Accordingly, a printed circuit board was further developed: <br><br><img src="https://habrastorage.org/files/2ca/501/7a8/2ca5017a8cba4f22b49cb6c8ea588855.png"><br><br><div class="spoiler">  <b class="spoiler_title">3D models of the PCB</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/0d3/058/62d/0d305862d003420aa0dfaa41f5a57d78.png"><br><img src="https://habrastorage.org/files/cbc/3d6/3b3/cbc3d63b39b44d2aa22887874155660c.bmp"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Photos of the finished device and work with the expansion card:</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e60/3b4/9d7/e603b49d769b4fc1888d7350b9dbe63f.jpg"><br><br><img src="https://habrastorage.org/files/2fb/710/6e3/2fb7106e3cec47ea9de5b947ebc091ed.jpg"><br><br><img src="https://habrastorage.org/files/132/e3e/4d0/132e3e4d025a47ebb5a982e69ed7c213.jpg"><br></div></div><br><br>  Variant of connection scheme with external devices: <br><img src="https://habrastorage.org/files/4bb/b2f/c3c/4bbb2fc3c13849398f32165e87ce506f.JPG"><br><br>  To check the nodes of the expansion card, I used a couple of scripts in the python language (I don‚Äôt know this language, I wrote it by trial and error, while peeping at specialists' codes) <br>  To measure the voltage from the potentiometer connected to the ADC channels, I wrote a simple script: <br><br><div class="spoiler">  <b class="spoiler_title">MCP3008 python source</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python # Example program to read data from MCP3008 10 bit ADC import spidev import time import os # Open SPI bus spi = spidev.SpiDev() spi.open(0,0) # Function to read SPI data from MCP3008 chip # Channel must be an integer 0-7 def ReadChannel(channel): adc = spi.xfer2([1,(8+channel)&lt;&lt;4,0]) data = ((adc[1]&amp;3) &lt;&lt; 8) + adc[2] return data # Function to convert data to voltage level, # rounded to specified number of decimal places. def ConvertVolts(data,places): volts = (data * 3.3) / float(1023) volts = round(volts,places) return volts # Define sensor channels first_channel = 0 second_channel = 1 # Define delay between readings delay = 5 print "------------------------------------------------------" while True: # Read the first channel data first_level = ReadChannel(first_channel) first_channel_volts = ConvertVolts(first_level,2) # Read the second channel data second_level = ReadChannel(second_channel) second_channel_volts = ConvertVolts(second_level,2) # Print out results print "------------------------------------------------------" print("First ADC channel: {} ({}V)".format(first_level,first_channel_volts)) print("Second ADC channel : {} ({}V)".format(second_level,second_channel_volts)) # Wait before repeating loop time.sleep(delay)</span></span></code> </pre> <br></div></div><br><br>  The following script was used to work with DS18B20 thermometers: <br><br><div class="spoiler">  <b class="spoiler_title">DS18B20 python source</b> <div class="spoiler_text">  Code is used from the <a href="https://kropochev.com/">site</a> <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># Example program to read data from DS18B20 # This code taken from # https://kropochev.com/?go=all/raspberry-pi-and-onewire-sensor/ import os import glob import time os.system('modprobe w1-gpio') os.system('modprobe w1-therm') base_dir = '/sys/bus/w1/devices/' device_folder = glob.glob(base_dir + '10*')[0] device_file = device_folder + '/w1_slave' def read_temp_raw(): f = open(device_file, 'r') lines = f.readlines() f.close() return lines def read_temp(): lines = read_temp_raw() while lines[0].strip()[-3:] != 'YES': time.sleep(0.2) lines = read_temp_raw() equals_pos = lines[1].find('t=') if equals_pos != -1: temp_string = lines[1][equals_pos+2:] temp_c = float(temp_string) / 1000.0 temp_f = temp_c * 9.0 / 5.0 + 32.0 return temp_c, temp_f while True: print(read_temp()) time.sleep(1)</span></span></code> </pre><br></div></div><br>  I also documented the settings in Raspbian: <br><br><div class="spoiler">  <b class="spoiler_title">Configure devices</b> <div class="spoiler_text"><blockquote>  - 1 Wire settings: <br>  - Raspbian wheezy <br><br>  Enter command in console: <br>  pi @ raspberrypi ~ $ sudo modprobe w1-gpio <br>  pi @ raspberrypi ~ $ sudo modprobe w1_therm <br><br>  Then check sensor in system: <br>  pi @ raspberrypi ~ $ sudo ls / sys / bus / w1 / devices / w1_bus_master1 / <br><br>  You can see the tabel below comman and <br>  there you should find HEX like 28-000002da8328; <br>  This is DS18B20 address; <br><br>  Next read the data from DS18B20 sensor using command: <br>  pi @ raspberrypi ~ $ cat / sys / bus / w1 / devices / w1_bus_master1 / 28-000002da8328 / w1_sla <br><br>  Like this: <br>  6f 01 4b 46 7f ff 01 10 67: crc = 67 YES <br>  6f 01 4b 46 7f ff 01 10 67 t = 22937 <br><br>  t = 22937 - you should divide this number in 1000 and you will have temperature in Celsius; <br><br>  - Raspbian Jezzy <br><br>  Enter command: <br>  pi @ raspberrypi ~ $ sudo nano /boot/config.txt <br><br>  On next step you should write in config file <br>  dtoverlay = w1-gpio, gpiopin = 4 <br>  dtoverlay = w1-gpio-pullup <br><br>  Then you should not reboot your raspberry Pi; <br><br>  - I2C Real Time Clock settings: <br>  - Update your system if it needed and install i2c-tools: <br>  pi @ raspberrypi ~ $ sudo apt-get update <br>  pi @ raspberrypi ~ $ sudo apt-get -y upgrade <br>  pi @ raspberrypi ~ $ sudo apt-get i2c-tools: <br><br>  Enter command: <br>  pi @ raspberrypi ~ $ sudo nano / etc / modules <br>  Add these lines: <br>  i2c-bcm2708 <br>  i2c-dev <br>  rtc_ds1307 <br><br>  Comment one line in file: <br>  pi @ raspberrypi ~ $ sudo nano /etc/modprobe.d/raspi-blacklist.conf <br>  Add # Symbol in beginning of line <br><br>  blacklist i2c-bcm2708 <br>  ________________________________________________________ <br>  Reboot system; <br>  Enter command: <br>  pi @ raspberrypi ~ $ sudo lsmod <br><br>  You will see lines like: <br>  rtc_ds1307 7715 0 <br>  i2c_dev 5277 0 <br>  i2c_bcm2708 4719 0 <br>  ________________________________________________________ <br><br>  Get DS1307 address: <br>  pi @ raspberrypi ~ $ sudo i2cdetect-y 1 <br><br>  You will see table in console: <br><br>  0 1 2 3 4 5 6 7 8 9 abcdef <br>  00: - - - - - - - - - - - - - 10: - - - - - - - - - - - - - - - - <br>  20: - -- - -- - -- - -- - -- - -- - -- - -- <br>  30: - - - - - - - - - - - UU - - - - <br>  40: - - - - - - - - - - - - - - - - <br>  50: - -- - -- - -- - -- - -- - -- - -- - -- <br>  60: - - - - - - - - 68 - - - - - - - 70: - - - - - - - - <br><br>  In this case, the DS1307 clock address is 0x3b. <br><br>  Enter command: <br>  echo ds1307 0x68&gt; / sys / class / i2c-adapter / i2c-1 / new_device <br><br>  Read clock: <br>  pi @ raspberrypi ~ $ sudo hwclock -r <br><br>  Set time: <br>  pi @ raspberrypi ~ $ sudo hwclock -w <br>  Set system time from RTC: <br>  pi @ raspberrypi ~ $ sudo hwclock -s <br><br>  Automatic RTC start; <br>  Add lines in /etc/rc.local file <br><br>  echo ds1307 0x68&gt; / sys / class / i2c-adapter / i2c-1 / new_device <br>  sudo hwclock -s <br>  Before last line in file looks like: <br><br>  exit 0 <br>  - Uart settings: <br>  - Back up files: <br>  cp /boot/cmdline.txt /boot/cmdline.bak <br>  cp / etc / inittab /etc/inittab.bak <br><br>  Delete "console = ttyAMA0,115200" and "kgdboc = ttyAMA0,115200" lines from configuration file: <br>  pi @ raspberrypi ~ $ nano /boot/cmdline.txt <br><br>  Comment last line looks like "T0: 23: respawn: / sbin / getty -L ttyAMA0 115200 vt100: in / etc / inittab file: using # symbol: <br>  pi @ raspberrypi ~ $ nano / etc / inittab <br></blockquote><br></div></div><br>  The printed circuit board was needed urgently, so I made it myself using LUT technology and a couple of hours of free time.  In order to facilitate the work and save time, the PCB made one-sided with jumpers from MGSHV 0.5.  DipTrace circuit and circuit design, test source codes, component list and tutorial with commands for configuration in <br>  <a href="https://github.com/Ledrunning/RaspberryPi_expansion_card">repositories</a> <br><br>  <b>PS:</b> in the video below, the very first board is used for modeling, it was assembled on a breadboard with buttons and LEDs for 20 minutes, the following versions appeared on the basis of it: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/5uCV_gNWw2Q" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/401089/">https://habr.com/ru/post/401089/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../401079/index.html">Obvious: automatic control of bathroom lighting</a></li>
<li><a href="../401081/index.html">Ministry of Communications wants to ban government agencies to renew licenses of foreign software</a></li>
<li><a href="../401083/index.html">Retro-clocking: what will happen if you crush old iron with liquid nitrogen and helium?</a></li>
<li><a href="../401085/index.html">Lakhta Terra Incognita: The Battle for Sustainability of a Skyscraper</a></li>
<li><a href="../401087/index.html">AI: bluff, taking money from the population and the victory over uncertainty</a></li>
<li><a href="../401091/index.html">7 desktop digital production tools breaking into 2017</a></li>
<li><a href="../401093/index.html">Sony Xperia Ear Xea10: voice assistants climbed into the ears</a></li>
<li><a href="../401095/index.html">What to give you, my dear man?</a></li>
<li><a href="../401097/index.html">Meet the new Spectrum</a></li>
<li><a href="../401101/index.html">The deleted files began to return to the Dropbox folders. Bug fixed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>