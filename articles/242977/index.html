<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another simple state machine for Unity</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share another version of the implementation of the state machine (state machine) for Unity. There were already articles about state machines...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another simple state machine for Unity</h1><div class="post__text post__text-html js-mediator-article"><img width="370" height="601" src="https://habrastorage.org/files/472/b9d/b17/472b9db1715c45a8a0e18de9d69aac53.png"><br><br>  I want to share another version of the implementation of the state machine (state machine) for Unity.  There were already articles about state machines linked to Unity and / or C # on Habr√©, for example, <a href="http://habrahabr.ru/post/206120/">here</a> and <a href="http://habrahabr.ru/post/160105/">here</a> , but I want to demonstrate a slightly different approach based on the use of Unity components. <br><a name="habracut"></a><br>  Link to <a href="https://github.com/marked-one/EasyStateMachine/releases/download/v0.1/EasyStateMachine-v0.1.unitypackage">unitypackage with the code from the article</a> . <br><br><div class="spoiler">  <b class="spoiler_title">For those who still don't know what a state machine is</b> <div class="spoiler_text">  For eager definitions, I'll give links to Wikipedia: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25B2%25D1%2582%25D0%25BE%25D0%25BC%25D0%25B0%25D1%2582">State machine</a> (in Russian) <br>  <a href="http://en.wikipedia.org/wiki/Finite-state_machine">Finite-state machine</a> (in English) <br><br>  I myself will try to describe in simple language on the game example. <br><br>  <i>A state machine is a set of states</i> , for example, character states: <br><ul><li>  Idle (Rest) </li><li>  Run </li><li>  Jump </li><li>  Fight </li><li>  Dead </li></ul><br>  <i>of which only one can be actively active at the current time</i> ;  that is, according to the above list, the character can: <br><ul><li>  either rest </li><li>  either run </li><li>  either jump </li><li>  either fight </li><li>  either be dead </li></ul><br>  <i>and the transition between which is carried out by meeting predetermined conditions</i> , for example: <br><ul><li>  Rest-&gt; Running, if the key is pressed </li><li>  Rest-&gt; Jump, if the key is pressed jump </li><li>  Running-&gt; Fight if a collision with an opponent occurs </li><li>  Draka-&gt; Dead, if health ended </li><li>  ... </li></ul><br>  For clarity, we represent the above-described state machine in the form of a graph, where green is the initial state of the state machine, red is the final state. <br><br><img src="https://habrastorage.org/files/181/eb1/ab6/181eb1ab6c3e4fce96114d3560084a9b.png"><br></div></div><br><br><h3>  Implementation </h3><br>  The implementation of the state machine we will consist of three classes: <i>StateMachine</i> , <i>State</i> and <i>Transition</i> , located in the same files.  All three classes are inherited from <i>MonoBehaviour</i> .  The <i>StateMachine class is</i> used directly, but from the abstract <i>State</i> and <i>Transition it is</i> proposed to inherit specific states and transitions.  As a result, the state machine itself, as well as all its states and transitions, are components and must be assigned to an object in the scene.  Well, and to switch states, then you can use the already existing mechanism of switching components on / off (the <i>enabled</i> property).  This saves us from the need to create specialized callbacks for the state machine, checking for "on / off" and the like.  Instead, the usual Unity event functions are used: <i>OnEnable</i> , <i>OnDisable</i> , <i>Update</i> , <i>Awake,</i> and others.  True, there are two subtleties: <br><br><ol><li>  It is worth being careful with the <i>Start</i> event: initially, the state and transitions of the state machine must be ‚Äúturned off‚Äù, and for a component that is turned off, this event will occur not at the start of the scene, but when it is ‚Äúturned on‚Äù for the first time.  This is standard Unity behavior. </li><li>  When inheriting from <i>State, you</i> will have to override ( <i>override</i> ) the <i>FixedUpdate</i> method (if you need it, of course): it is implemented in the <i>State</i> class so that the Inspector always shows the checkbox ‚Äúon / off‚Äù for the state.  With this tick, you can watch the switching of states in real time, the most ‚Äúvisual debugging‚Äù. </li></ol><br><br>  Finally, let's turn to the code (with comments in Russian): <br><div class="spoiler">  <b class="spoiler_title">Transition</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      (disabled)  Inspector'. public abstract class Transition : MonoBehaviour { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   ( ). </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   Inspector'. [SerializeField] State targetState; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   State   . public State TargetState { get { return targetState; } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    ,   </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      true. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    State. public bool NeedTransit { get; protected set; } }</span></span></code> </pre> </div></div><div class="spoiler">  <b class="spoiler_title">State</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      (disabled)  Inspector'. public abstract class State : MonoBehaviour { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   Inspector'. [SerializeField, Tooltip("List of transitions from this state.")] List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Transition&gt;</span></span></span><span class="hljs-comment"> transitions = new List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Transition&gt;</span></span></span><span class="hljs-comment"> (); </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   ,    </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  ,   null. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   StateMachine. public virtual State GetNext() { foreach (var transition in transitions) { if (transition.NeedTransit ) return transition.TargetState; } return null; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   OnDisable,     . public virtual void Exit() { if(enabled) { foreach(var transition in transitions) { transition.enabled = false; } enabled = false; } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   OnEnable,     . public virtual void Enter() { if(!enabled) { enabled = true; foreach(var transition in transitions) { transition.enabled = true; } } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     ,   Inspector'  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   enabled/disabled  . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">       . protected virtual void FixedUpdate() { } }</span></span></code> </pre></div></div><div class="spoiler">  <b class="spoiler_title">Statemachine</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   . public class StateMachine : MonoBehaviour { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   Inspector'. [SerializeField] State startingState; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  . State current; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    . public State Current { get { return current; } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  (   ). void Start() { Reset(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      . public void Reset() { Transit(startingState); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    ,     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> .   - . void Update () { if(current == null) return; var next = current.GetNext(); if(next != null) Transit(next); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> , . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    , </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   . void Transit(State next) { if(current != null) current.Exit(); current = next; if(current != null) current.Enter(); } }</span></span></code> </pre></div></div><br><br><h3>  Use the resulting state machine </h3><br>  Let's create a small test project in which we will move the cube left-right across the screen.  The project can be created both in 2D and in 3D, the differences should be only visual.  Create a scene or use the default.  It will already have a camera, and now we will also add a cube using the <i>GameObject-&gt; Create Other-&gt; Cube</i> menu.  Cuba needs to set a position on the X axis equal to -4, since then it will move 8 units in each direction.  In addition to the cube, we will create a child empty object for our state machine.  To do this, select the cube in the Hierarchy and use the menu <i>GameObject-&gt; Create Empty Child</i> .  It will be clearer to rename it to StateMachine. <br><br>  Get <div class="spoiler">  <b class="spoiler_title">Something like this</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/67d/cd1/4da/67dcd14da8b14c2b8726a8f19f94cb57.png"></div></div><br>  The next step is to create scripts.  We will need 4 scripts, this is a timer transition class: <br><div class="spoiler">  <b class="spoiler_title">Timertransition</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections; <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   . public class TimerTransition : Transition { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   .   Inspector'. [SerializeField, Tooltip("Time in seconds.")] float time; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  "". </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      NeedTransit. void OnEnable() { NeedTransit = false; StartCoroutine("Timer"); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> ,    . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      NeedTransit  true. IEnumerator Timer() { yield return new WaitForSeconds(time); NeedTransit = true; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  "". </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  . void OnDisable() { StopCoroutine("Timer"); } }</span></span></code> </pre></div></div>  and 3 more classes for states.  The base class for motion states, moving an object using the <i>Translate</i> method of the <i>Transform</i> component: <br><div class="spoiler">  <b class="spoiler_title">TranslateState</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     Transform    Translate. public class TranslateState : State { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Transform,   Inspector'. [SerializeField] Transform transformToMove; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     .   Inspector'. [SerializeField, Tooltip("Speed in units per second.")] Vector3 speed; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   Transform. void Update () { var step = speed * Time.deltaTime; transformToMove.Translate(step.x, step.y, step.z); } }</span></span></code> </pre></div></div>  and classes of specific states inherited from it: <br><div class="spoiler">  <b class="spoiler_title">MoveRight</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     ,  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    "". public class MoveRight : TranslateState { }</span></span></code> </pre></div></div><div class="spoiler">  <b class="spoiler_title">Moveleft</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     ,  </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    "". public class MoveLeft : TranslateState { }</span></span></code> </pre></div></div><br>  Now that all the necessary classes are ready, you need to assemble a state machine from the components.  To do this, select in Hierarchy our object with the name StateMachine and hang all components on it as in the picture: <br><div class="spoiler">  <b class="spoiler_title">Picture</b> <div class="spoiler_text"><img width="392" height="571" src="https://habrastorage.org/files/140/2d2/83f/1402d283f08645c7bfe916fcf654ee56.png"></div></div>  Do not forget to "turn off" the state and transition components, but not the state machine itself. <br><br>  Fill our components as follows: <br><div class="spoiler">  <b class="spoiler_title">Ready state machine</b> <div class="spoiler_text"><img width="370" height="601" src="https://habrastorage.org/files/472/b9d/b17/472b9db1715c45a8a0e18de9d69aac53.png"></div></div>  Fields for states and transitions can be filled by dragging the corresponding components.  Do not forget to set the StartingState state machine and add transitions to the Transitions state list! <br><br>  Now you can run the scene.  If done correctly, the cube will move left and right across the screen.  If you select the StateMachine object in the Hierarchy, then in the inspector you can monitor the change of states in real time. <br><br><h3>  Conclusion </h3><br>  In conclusion, I want to note that, although this implementation of the state machine is not without flaws, it is quite suitable for use in small projects.  For larger projects, in my opinion, dragging the components in the inspector itself can be a rather unpleasant job. <br><br>  Constructive criticism is welcome. </div><p>Source: <a href="https://habr.com/ru/post/242977/">https://habr.com/ru/post/242977/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242965/index.html">Portable distribution of .Net applications with Microsoft Report Viewer and Oracle Instant Client reports</a></li>
<li><a href="../242967/index.html">Big little things: 7 UBANK features that will make your life easier and more fun</a></li>
<li><a href="../242969/index.html">Snippet msVendor for miniShop2</a></li>
<li><a href="../242971/index.html">Future Directory Services (in the clouds) - register for a webinar</a></li>
<li><a href="../242975/index.html">How have I been pwned? scaled under high load and how much it cost (<$ 25)</a></li>
<li><a href="../242979/index.html">How to make profitable design development sites (part 4)</a></li>
<li><a href="../242983/index.html">Advantages of a new backup method for virtual machines over classic schemes</a></li>
<li><a href="../242987/index.html">Wikipedia. Forbidden to donate from Russia?</a></li>
<li><a href="../242989/index.html">Run GWT Super Dev Mode for remote server</a></li>
<li><a href="../242991/index.html">High Frequency Trading Neighborhood - Part I</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>