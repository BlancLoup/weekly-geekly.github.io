<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>2D shadows on WebGL in 4 easy steps</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I‚Äôll tell you how to do 2DG shadows on WebGL with your own hands, with just a notebook and any web server. All steps lie on the githa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>2D shadows on WebGL in 4 easy steps</h1><div class="post__text post__text-html js-mediator-article">  In this article, I‚Äôll tell you how to do 2DG shadows on WebGL with your own hands, with just a notebook and any web server.  All steps lie on the githaba as branches and switch to git checkout stepN, so welcome even to those who are not configured to code. <br><br>  KDPV: <br><br><img src="https://habrastorage.org/files/9f3/a70/19a/9f3a7019ab2e4ddbb41aac47a960f62c.jpg"><br><a name="habracut"></a><br>  You can play with the finished project <a href="http://fen1kz.github.io/dung7">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, recently I wanted to write something with 2D shadows on javascript.  With a bunch of light sources and any (read: raster) obstacles for them.  Raytracing scared with complex relationships with geometry (especially when it does not fit on the screen), so my choice fell on WebGL shaders. <br><br>  TK: There is a picture on which obstacles are drawn, there are coordinates of light sources, you need to draw shadows. <br><br>  We will use pixi.js: a drawing framework, has a renderer displaying a certain scene (an instance of PIXI.Container) on the page.  Scene-Container may contain other containers, or already directly sprites / graphics (PIXI.Sprite / PIXI.Graphics, respectively).  PIXI.Graphics for drawing, Sprites contain a texture, either drawn too, or loaded from the outside.  Also Sprites can be applied filters (shaders). <br><br>  About Filters: special objects are entered into the filters variable <pre><code class="hljs swift">someGraphicObject.filters = [<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span>]</code> </pre> <br>  and perform any operations with the texture of this object, including the shader can be superimposed.  We will have a special filter consisting of two ‚Äúsubfilters‚Äù.  Such a "complex" structure is needed because of the method of drawing shadows: <br><br>  We generate a shadow map (for each light source), a one-dimensional texture depicting obstacles from the point of view of the source, where the X coordinate is the angle, and the alpha channel value is the distance to the obstacle.  However, since such a texture is only suitable for one light source, to save space and resources, the texture will still be two-dimensional, Y will mean the number of the source. <br><br>  Question for understanding: The texture is 256x256, a pixel with coordinates (x = 64, y = 8) is translucent, name the number of the light source, and the polar coordinates of the obstacle relative to the source. <br><br><div class="spoiler">  <b class="spoiler_title">Answer</b> <div class="spoiler_text">  The number is not greater than eight (the relationship between Y and the number may not be direct), the distance is half of a certain number (again, the dependence may not be direct), the angle is 90 degrees. <br></div></div><br>  Then, from the original image and the shadow map with the second shader, draw the shadows themselves and, at the same time, mix everything there. <br><br>  Hierarchy with tz.  PIXI will be like this: <br><br><pre> Scene (PIXI.Container)
 | - Lightbulbs (PIXI.Graphics pair)
 | - Sprite on which shadows will be drawn + lighted background (PIXI.Sprite)
 | - | - Texture (PIXI.RenderTexture)
 | - | - Filter (PIXI.AbstractFilter)
</pre><br><br>  And separately, outside the scene: <br><br><pre> | - Background (PIXI.Sprite)
 | - | - Texture Background
 | - Obstacle Container (PIXI.Container)
 | - | - Sprite with obstacles (PIXI.Sprite)
 | - | - | - Sprite texture
</pre><br><br>  Note that the background and the container will be passed to the filter that will figure out what to draw and how to draw it. <br>  That's the whole theory, now you can begin to practice: <br><br><h3>  Step 0: Create a project </h3><br>  Or download it <a href="">from here</a> , step0 branch. <br><br>  We need 3 files: <br><br><ul><li>  index.html c <br><br><div class="spoiler">  <b class="spoiler_title">the simplest content</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE HTML&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Deferred Example<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UTF-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/pixi.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/script.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br></li><li>  Obstacle picture - any PNG with transparency, I recommend this one. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/0a4/c73/c9b/0a4c73c9b4f2493c88208de1b0a71e10.png"><br></div></div><br></li><li>  Library <a href="">pixi.js</a> , you can download <a href="">from here</a> . <br></li></ul><br>  It is also a good idea to start any web server with a project folder right away. <br><br><h3>  Step 1: Create a Scene </h3><br>  Everything is created in the js / script.js file.  The code, I hope, is obvious even to those who are not familiar with PIXI: <br><br><div class="spoiler">  <b class="spoiler_title">js / script.js</b> <div class="spoiler_text"><pre> <code class="hljs matlab">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WIDTH</span></span></span><span class="hljs-function"> = 640; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HEIGHT</span></span></span><span class="hljs-function"> = 480; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderer</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PIXI</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WebGLRenderer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WIDTH, HEIGHT)</span></span></span><span class="hljs-function">; //  </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PIXI</span></span></span><span class="hljs-function">  </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">document</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addEventListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("DOMContentLoaded", function (event)</span></span></span><span class="hljs-function"> { //   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">html</span></span></span><span class="hljs-function">  </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">document</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">body</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">appendChild</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(renderer.view)</span></span></span><span class="hljs-function">; //    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PIXI</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loader</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('background', 'img/maze.png')</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">once</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('complete', setup)</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; }); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { //  ,  . </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lights</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[]</span></span></span><span class="hljs-function">; //  </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lights</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[0]</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PIXI</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Graphics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lights</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[0]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beginFill</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(0xFFFF00)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lights</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[0]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawCircle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(0, 0, 4)</span></span></span><span class="hljs-function">; // </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">y</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">radius</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lights</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[1]</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PIXI</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Graphics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lights</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[1]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beginFill</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(0xFFFF00)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lights</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[1]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawCircle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(0, 0, 4)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lights</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[1]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x</span></span></span><span class="hljs-function"> = 50; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lights</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[1]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">y</span></span></span><span class="hljs-function"> = 50; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">background</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PIXI</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Graphics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">background</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beginFill</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(0x999999)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">background</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawRect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(0, 0, WIDTH, HEIGHT)</span></span></span><span class="hljs-function">; // </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">y</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">width</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">height</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shadowCastImage</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PIXI</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sprite</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('img/maze.png')</span></span></span><span class="hljs-function">; //      </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shadowCasters</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PIXI</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Container</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; //   ,    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shadowCasters</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addChild</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(shadowCastImage)</span></span></span><span class="hljs-function">; //    . </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stage</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PIXI</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Container</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stage</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addChild</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(background)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stage</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addChild</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(shadowCasters)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stage</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addChild</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lights[0])</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stage</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addChild</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lights[1])</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(function animate()</span></span></span><span class="hljs-function"> { // </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lights</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[0]</span></span></span><span class="hljs-function">    . </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pointer</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">plugins</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interaction</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouse</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">global</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lights</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[0]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pointer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">x</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lights</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[0]</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">y</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pointer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">y</span></span></span><span class="hljs-function">; //  </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stage)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestAnimationFrame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(animate)</span></span></span><span class="hljs-function">; })</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; } })</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span></span></code> </pre><br></div></div><br>  As a result, you will get something intelligible, a picture, two light bulbs, and one will already be tied to the mouse: <br><br><img src="https://habrastorage.org/files/51d/9b0/20b/51d9b020bf37437aa8f4d4f5efbfd1e7.jpg"><br><br><h3>  Step 2: Add Shader </h3><br>  I'll start with a simple shader, he will paint the obstacles in red, and everything else in gray. <br><br><div class="spoiler">  <b class="spoiler_title">File glsl / smap-shadow-texture.frag:</b> <div class="spoiler_text"><pre> <code class="hljs ruby">precision mediump float; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    varying vec2 vTextureCoord; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    ( <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">1.0</span></span>)   uniform sampler2D uSampler; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,    . void main() { vec4 color = texture2D(uSampler, vTextureCoord); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (color.a == <span class="hljs-number"><span class="hljs-number">0</span></span>.) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  -  gl_FragColor = vec4(.<span class="hljs-number"><span class="hljs-number">5</span></span>, .<span class="hljs-number"><span class="hljs-number">5</span></span>, .<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>.); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ,  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    gl_FragColor = vec4(<span class="hljs-number"><span class="hljs-number">1</span></span>., <span class="hljs-number"><span class="hljs-number">0</span></span>., <span class="hljs-number"><span class="hljs-number">0</span></span>., <span class="hljs-number"><span class="hljs-number">1</span></span>.); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ,  } }</code> </pre><br></div></div><br>  We load it in loader'e: <br><br><pre> <code class="hljs cs"> PIXI.loader ... .<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-string"><span class="hljs-string">'glslShadowTexture'</span></span>, <span class="hljs-string"><span class="hljs-string">'glsl/smap-shadow-texture.frag'</span></span>) ...</code> </pre><br>  You cannot just take and apply the lighting shader directly to the scene, because then the shadows will be drawn on top of everything, so I will create a separate sprite into which I will draw the background and obstacles using RenderTexture (a special texture that allows you to draw any other PIXI object) same), then apply our filter to it. <br><br><pre> <code class="hljs swift"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lightingRT = new <span class="hljs-type"><span class="hljs-type">PIXI</span></span>.<span class="hljs-type"><span class="hljs-type">RenderTexture</span></span>(renderer, <span class="hljs-type"><span class="hljs-type">WIDTH</span></span>, <span class="hljs-type"><span class="hljs-type">HEIGHT</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lightingSprite = new <span class="hljs-type"><span class="hljs-type">PIXI</span></span>.<span class="hljs-type"><span class="hljs-type">Sprite</span></span>(lightingRT); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">filter</span></span> = createSMapFilter(); lightingSprite.filters = [<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span>]; ... stage.addChild(lightingSprite);</code> </pre><br>  Well, drawing, in the animate () function: <br><br><pre> <code class="hljs pgsql"> lightingRT.render(shadowCasters, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); // (shadowCasters   PIXI, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>    (), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>    )</code> </pre><br>  It remains only to declare the function createSMapFilter: <br><br><pre> <code class="hljs actionscript"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createSMapFilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> SMapFilter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PIXI.AbstractFilter(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, PIXI.loader.resources.glslShadowTexture.data, {}); <span class="hljs-comment"><span class="hljs-comment">// (  ,    ,      (uniforms)) return SMapFilter; }</span></span></code> </pre><br>  All obstacles will be painted in red: <br><br><img src="https://habrastorage.org/files/b71/414/40c/b7141440c87d4917b30ba3368b316640.jpg"><br><br><h3>  Step 3: Create a shadow map </h3><br>  Now that the filter is working, it can be rewritten and expanded.  First of all, from a simple shader it should be turned into a ‚Äúcombo filter‚Äù, which will contain other shaders.  For this stage, you will need two - one empty, outputting the texture as it is and one for the shadow map.  Also, it will contain a shadow map and another texture where we will render the shadowCasters container (for those who are lost, this is a container with obstacles.) Perhaps, I will simply introduce a new function ‚ÄúcreateSMapFilter ()‚Äù in its entirety: <br><br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> createSMapFilter() { var CONST_LIGHTS_COUNT = <span class="hljs-number"><span class="hljs-number">2</span></span>; var SMapFilter = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PIXI.AbstractFilter(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, { // ,    ,   "" viewResolution: {<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-string"><span class="hljs-string">'2fv'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: [WIDTH, HEIGHT]} //     <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> , rtSize: {<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-string"><span class="hljs-string">'2fv'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: [<span class="hljs-number"><span class="hljs-number">1024</span></span>, CONST_LIGHTS_COUNT]} //    . , uAmbient: {<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-string"><span class="hljs-string">'4fv'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: [<span class="hljs-number"><span class="hljs-number">.0</span></span>, <span class="hljs-number"><span class="hljs-number">.0</span></span>, <span class="hljs-number"><span class="hljs-number">.0</span></span>, <span class="hljs-number"><span class="hljs-number">.0</span></span>]} //   " "   . }); //     /  : <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; CONST_LIGHTS_COUNT; ++i) { SMapFilter.uniforms[<span class="hljs-string"><span class="hljs-string">'uLightPosition['</span></span> + i + <span class="hljs-string"><span class="hljs-string">']'</span></span>] = {<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-string"><span class="hljs-string">'4fv'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: [<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-number"><span class="hljs-number">.3</span></span>]}; // , ,     "falloff"    SMapFilter.uniforms[<span class="hljs-string"><span class="hljs-string">'uLightColor['</span></span> + i + <span class="hljs-string"><span class="hljs-string">']'</span></span>] = {<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-string"><span class="hljs-string">'4fv'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">.3</span></span>]}; // r, g, b,       . } //   PIXI ,      SMapFilter.renderTarget = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PIXI.RenderTarget( renderer.gl , SMapFilter.uniforms.rtSize.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>] , SMapFilter.uniforms.rtSize.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>] , PIXI.SCALE_MODES.LINEAR , <span class="hljs-number"><span class="hljs-number">1</span></span>); SMapFilter.renderTarget.<span class="hljs-keyword"><span class="hljs-keyword">transform</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PIXI.Matrix() .scale(SMapFilter.uniforms.rtSize.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>] / WIDTH , SMapFilter.uniforms.rtSize.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>] / HEIGHT); //       : SMapFilter.shadowCastersRT = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PIXI.RenderTexture(renderer, WIDTH, HEIGHT); SMapFilter.uniforms.uShadowCastersTexture = { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-string"><span class="hljs-string">'sampler2D'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: SMapFilter.shadowCastersRT }; //    : SMapFilter.render = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>) { SMapFilter.shadowCastersRT.render(<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); }; //  ,   ; SMapFilter.testFilter = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PIXI.AbstractFilter(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, "precision highp float;" + "varying vec2 vTextureCoord;" + "uniform sampler2D uSampler;" + "void main(void) {gl_FragColor = texture2D(uSampler, vTextureCoord);}"); // ,   renderTarget  . var filterShadowTextureSource = PIXI.loader.resources.glslShadowTexture.data; // CONST_LIGHTS_COUNT            uniform. filterShadowTextureSource = filterShadowTextureSource.replace(/CONST_LIGHTS_COUNT/g, CONST_LIGHTS_COUNT); //       uniforms,   WebGL (       ,      ) var filterShadowTextureUniforms = <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>.keys(SMapFilter.uniforms).reduce(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (c, k) { c[k] = { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: SMapFilter.uniforms[k].<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: SMapFilter.uniforms[k].<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c; }, {}); SMapFilter.filterShadowTexture = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> PIXI.AbstractFilter( <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> , filterShadowTextureSource , filterShadowTextureUniforms ); SMapFilter.applyFilter = <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (renderer, <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>, output) { SMapFilter.filterShadowTexture.applyFilter(renderer, <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>, SMapFilter.renderTarget, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); SMapFilter.testFilter.applyFilter(renderer, SMapFilter.renderTarget, output); //     . }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SMapFilter; }</code> </pre><br>  It should be noted that filterShadowTexture does not use input.  Instead, it receives data through uniform uShadowCastersTexture.  I made it so as not to bother with another renderTarget. <br><br>  You can then update the interactive in the animate function: <br><br><pre> <code class="hljs pgsql"> //  uniforms   <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>.uniforms[<span class="hljs-string"><span class="hljs-string">'uLightPosition[0]'</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>] = lights[<span class="hljs-number"><span class="hljs-number">0</span></span>].x; <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>.uniforms[<span class="hljs-string"><span class="hljs-string">'uLightPosition[0]'</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>] = lights[<span class="hljs-number"><span class="hljs-number">0</span></span>].y; <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>.uniforms[<span class="hljs-string"><span class="hljs-string">'uLightPosition[1]'</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>] = lights[<span class="hljs-number"><span class="hljs-number">1</span></span>].x; <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>.uniforms[<span class="hljs-string"><span class="hljs-string">'uLightPosition[1]'</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>] = lights[<span class="hljs-number"><span class="hljs-number">1</span></span>].y; //      renderTexture  . <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>.render(shadowCasters);</code> </pre><br>  And finally, start writing the shader: <br><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/     : precision mediump float; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  uniform' varying vec2 vTextureCoord; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  uniform sampler2D uSampler; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      ( ) uniform vec2 viewResolution; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   uniform vec2 rtSize; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  renderTarget uniform vec4 uLightPosition[CONST_LIGHTS_COUNT]; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/x,y = , z =  uniform vec4 uLightColor[CONST_LIGHTS_COUNT]; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   uniform sampler2D uShadowCastersTexture; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      --    . const float PI = 3.14159265358979; const float STEPS = 256.0; const float THRESHOLD = .01; void main(void) { int lightnum = int(floor(vTextureCoord.y * float(CONST_LIGHTS_COUNT))); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      Y vec2 lightPosition; float lightSize; for (int i = 0; i &lt; CONST_LIGHTS_COUNT; i += 1) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/        if (lightnum == i) { lightPosition = uLightPosition[i].xy /</span></span> viewResolution; lightSize = uLightPosition[i].z / max(viewResolution.x, viewResolution.y); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } float dst = <span class="hljs-number"><span class="hljs-number">1.0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (float y = <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; STEPS; y += <span class="hljs-number"><span class="hljs-number">1.0</span></span>) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   (  (y / STEPS))      float distance = (y / STEPS); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    float angle = vTextureCoord.x * (<span class="hljs-number"><span class="hljs-number">2.0</span></span> * PI); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    /<span class="hljs-regexp"><span class="hljs-regexp">/        vec2 coord = vec2(cos(angle) * distance, sin(angle) * distance); coord *= (max(viewResolution.x, viewResolution.y) /</span></span> viewResolution); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  coord += lightPosition; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    coord = clamp(coord, <span class="hljs-number"><span class="hljs-number">0</span></span>., <span class="hljs-number"><span class="hljs-number">1</span></span>.); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      vec4 data = texture2D(uShadowCastersTexture, coord); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.a &gt; THRESHOLD) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ,     . dst = min(dst, distance); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } /<span class="hljs-regexp"><span class="hljs-regexp">/    ,     0..1 gl_FragColor = vec4(vec3(0.0), dst /</span></span> lightSize); }</code> </pre><br>  Especially there is nothing to comment on, maybe I will add something from the questions in the comments. <br><br>  Such a mysterious image should work out here, but this is exactly what our shadow map looks like, because it is recorded in the alpha channel and superimposed on the stage. <br><br><img src="https://habrastorage.org/files/6c5/30c/a60/6c530ca6089f4c70b7dbd8be23795aa0.jpg"><br><br><h3>  Step 4: Shadowing the Shadow Map </h3><br>  Add a new file to the preload, now it will look like this: <br><br><pre> <code class="javascript hljs"> PIXI.loader .add(<span class="hljs-string"><span class="hljs-string">'background'</span></span>, <span class="hljs-string"><span class="hljs-string">'img/maze.png'</span></span>) .add(<span class="hljs-string"><span class="hljs-string">'glslShadowTexture'</span></span>, <span class="hljs-string"><span class="hljs-string">'glsl/smap-shadow-texture.frag'</span></span>) .add(<span class="hljs-string"><span class="hljs-string">'glslShadowCast'</span></span>, <span class="hljs-string"><span class="hljs-string">'glsl/smap-shadow-cast.frag'</span></span>) .once(<span class="hljs-string"><span class="hljs-string">'complete'</span></span>, setup) .load();</code> </pre><br>  And, in the createSMapFilter function, copy uniforms again, this time for the second shader: <br><br><pre> <code class="hljs pgsql"> var filterShadowCastUniforms = <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>.keys(SMapFilter.uniforms).reduce(<span class="hljs-keyword"><span class="hljs-keyword">function</span></span> (c, k) { c[k] = { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: SMapFilter.uniforms[k].<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: SMapFilter.uniforms[k].<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c; }, {});</code> </pre><br>  Next we need to transfer to it the shadow map (which is contained in the renderTarget).  I did not find how to do this, so I use the hack, presenting the renderTarget as Texture: <br><br><pre> <code class="hljs pgsql"> filterShadowCastUniforms.shadowMapChannel = { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-string"><span class="hljs-string">'sampler2D'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: { baseTexture: { hasLoaded: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> , _glTextures: [SMapFilter.renderTarget.texture] } } };</code> </pre><br>  Creating a shader: <br><br><pre> <code class="hljs haskell"> <span class="hljs-type"><span class="hljs-type">SMapFilter</span></span>.filterShadowCast = new <span class="hljs-type"><span class="hljs-type">PIXI</span></span>.<span class="hljs-type"><span class="hljs-type">AbstractFilter</span></span>( null , <span class="hljs-type"><span class="hljs-type">PIXI</span></span>.loader.resources.glslShadowCast.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">.replace(/</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CONST_LIGHTS_COUNT</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CONST_LIGHTS_COUNT</span></span></span><span class="hljs-class">) , filterShadowCastUniforms );</span></span></code> </pre><br>  Modify applyFilter: <br><br><pre> <code class="hljs lua"> SMapFilter.applyFilter = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(renderer, input, output)</span></span></span></span> { SMapFilter.filterShadowTexture.applyFilter(renderer, <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>, SMapFilter.renderTarget, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); //SMapFilter.testFilter.applyFilter(renderer, SMapFilter.renderTarget, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>); //     . SMapFilter.filterShadowCast.applyFilter(renderer, <span class="hljs-built_in"><span class="hljs-built_in">input</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>); };</code> </pre><br>  Once again, so that everyone understands that where he is going: <br><br>  input is the texture of the entire scene that will be illuminated; <br>  output is the same; <br>  SMapFilter.renderTarget is a shadow map. <br><br>  The first shader does not use input and writes a shadow map from uniform, and the second shader uses both input and a shadow map (in the form of a uniform). <br><br>  Everything, it remains to deal with glsl / smal-shadow-cast.frag: <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">precision</span></span> mediump <span class="hljs-type"><span class="hljs-type">float</span></span>; uniform sampler2D uSampler; <span class="hljs-type"><span class="hljs-type">varying</span></span> vec2 vTextureCoord; uniform vec2 viewResolution; uniform sampler2D shadowMapChannel; uniform vec4 uAmbient; uniform vec4 uLightPosition[CONST_LIGHTS_COUNT]; uniform vec4 uLightColor[CONST_LIGHTS_COUNT]; const <span class="hljs-type"><span class="hljs-type">float</span></span> PI = <span class="hljs-number"><span class="hljs-number">3.14159265358979</span></span>; //    ()    vec4 takeSample(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sampler2D texture, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> vec2 coord, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> light) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> step(light, texture2D(texture, coord)); } //      ( !) vec4 blurFn(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sampler2D texture, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> vec2 tc, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> light, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> iBlur) { <span class="hljs-type"><span class="hljs-type">float</span></span> blur = iBlur / viewResolution.x; vec4 sum = vec4(<span class="hljs-number"><span class="hljs-number">0.0</span></span>); sum += takeSample(texture, vec2(tc.x - <span class="hljs-number"><span class="hljs-number">5.0</span></span>*blur, tc.y), light) * <span class="hljs-number"><span class="hljs-number">0.022657</span></span>; sum += takeSample(texture, vec2(tc.x - <span class="hljs-number"><span class="hljs-number">4.0</span></span>*blur, tc.y), light) * <span class="hljs-number"><span class="hljs-number">0.046108</span></span>; sum += takeSample(texture, vec2(tc.x - <span class="hljs-number"><span class="hljs-number">3.0</span></span>*blur, tc.y), light) * <span class="hljs-number"><span class="hljs-number">0.080127</span></span>; sum += takeSample(texture, vec2(tc.x - <span class="hljs-number"><span class="hljs-number">2.0</span></span>*blur, tc.y), light) * <span class="hljs-number"><span class="hljs-number">0.118904</span></span>; sum += takeSample(texture, vec2(tc.x - <span class="hljs-number"><span class="hljs-number">1.0</span></span>*blur, tc.y), light) * <span class="hljs-number"><span class="hljs-number">0.150677</span></span>; sum += takeSample(texture, vec2(tc.x, tc.y), light) * <span class="hljs-number"><span class="hljs-number">0.163053</span></span>; sum += takeSample(texture, vec2(tc.x + <span class="hljs-number"><span class="hljs-number">1.0</span></span>*blur, tc.y), light) * <span class="hljs-number"><span class="hljs-number">0.150677</span></span>; sum += takeSample(texture, vec2(tc.x + <span class="hljs-number"><span class="hljs-number">2.0</span></span>*blur, tc.y), light) * <span class="hljs-number"><span class="hljs-number">0.118904</span></span>; sum += takeSample(texture, vec2(tc.x + <span class="hljs-number"><span class="hljs-number">3.0</span></span>*blur, tc.y), light) * <span class="hljs-number"><span class="hljs-number">0.080127</span></span>; sum += takeSample(texture, vec2(tc.x + <span class="hljs-number"><span class="hljs-number">4.0</span></span>*blur, tc.y), light) * <span class="hljs-number"><span class="hljs-number">0.046108</span></span>; sum += takeSample(texture, vec2(tc.x + <span class="hljs-number"><span class="hljs-number">5.0</span></span>*blur, tc.y), light) * <span class="hljs-number"><span class="hljs-number">0.022657</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum; } // ,   : <span class="hljs-type"><span class="hljs-type">void</span></span> main() { //      vec4 color = vec4(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>); //      . <span class="hljs-type"><span class="hljs-type">float</span></span> lightLookupHalfStep = (<span class="hljs-number"><span class="hljs-number">1.0</span></span> / <span class="hljs-type"><span class="hljs-type">float</span></span>(CONST_LIGHTS_COUNT)) * <span class="hljs-number"><span class="hljs-number">.5</span></span>; //       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> lightNumber = <span class="hljs-number"><span class="hljs-number">0</span></span>; lightNumber &lt; CONST_LIGHTS_COUNT; lightNumber += <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-type"><span class="hljs-type">float</span></span> lightSize = uLightPosition[lightNumber].z / max(viewResolution.x, viewResolution.y); <span class="hljs-type"><span class="hljs-type">float</span></span> lightFalloff = min(<span class="hljs-number"><span class="hljs-number">0.99</span></span>, uLightPosition[lightNumber].a); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lightSize == <span class="hljs-number"><span class="hljs-number">0.</span></span>) { //   ,    . <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } vec2 lightPosition = uLightPosition[lightNumber].xy / viewResolution; vec4 lightColor = uLightColor[lightNumber]; //      vec3 lightLuminosity = vec3(<span class="hljs-number"><span class="hljs-number">0.0</span></span>); //  Y     . <span class="hljs-type"><span class="hljs-type">float</span></span> yCoord = <span class="hljs-type"><span class="hljs-type">float</span></span>(lightNumber) / <span class="hljs-type"><span class="hljs-type">float</span></span>(CONST_LIGHTS_COUNT) + lightLookupHalfStep; //       vec2 toLight = vTextureCoord - lightPosition; //  toLight /= (max(viewResolution.x, viewResolution.y) / viewResolution); toLight /= lightSize; //      <span class="hljs-type"><span class="hljs-type">float</span></span> light = length(toLight); //      (  ) <span class="hljs-type"><span class="hljs-type">float</span></span> angleToPoint = atan(toLight.y, toLight.x); <span class="hljs-type"><span class="hljs-type">float</span></span> angleCoordOnMap = angleToPoint / (<span class="hljs-number"><span class="hljs-number">2.0</span></span> * PI); vec2 samplePoint = vec2(angleCoordOnMap, yCoord); //     <span class="hljs-comment"><span class="hljs-comment">--   . float blur = smoothstep(0., 2., light); //  ,               float sum = blurFn(shadowMapChannel, samplePoint, light, blur).a; sum = max(sum, lightColor.a); lightLuminosity = lightColor.rgb * vec3(sum) * smoothstep(1.0, lightFalloff, light); //     ( ): color.rgb += lightLuminosity; } //   color = max(color, uAmbient); //     vec4 base = texture2D(uSampler, vTextureCoord); //      "" (     ) gl_FragColor = vec4(base.rgb * sqrt(color.rgb), 1.0); }</span></span></code> </pre><br>  We save and now, everything works: <br><br><img src="https://habrastorage.org/files/a6a/fb8/506/a6afb8506c3b45cca273163aa226e072.jpg"><br><br>  Well, or you can switch to the step4 branch. <br><br>  In conclusion, I want to say that I didn‚Äôt get what I wanted (I wanted cool and simple shadows, but I received an <em>invaluable experience of</em> writing shaders), but the result looks acceptable and can be used somewhere. </div><p>Source: <a href="https://habr.com/ru/post/272233/">https://habr.com/ru/post/272233/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272215/index.html">I believe - I do not believe in indie development. Part 1</a></li>
<li><a href="../272223/index.html">Google Chrome web browser provided another security enhancement</a></li>
<li><a href="../272227/index.html">Java 9 will be postponed for half a year</a></li>
<li><a href="../272229/index.html">Why are our high-level languages ‚Äã‚Äãstill not so high-level?</a></li>
<li><a href="../272231/index.html">Lori Timesheets - time tracking on the CUBA platform</a></li>
<li><a href="../272235/index.html">Data Modeling and Databases for a Freshman</a></li>
<li><a href="../272237/index.html">Master class by Boris Wolfson. Agile basics</a></li>
<li><a href="../272239/index.html">Bug with GPU and Canvas in Google Chrome under Windows</a></li>
<li><a href="../272241/index.html">Elasticweb - the first adaptive virtual hosting</a></li>
<li><a href="../272243/index.html">The most dangerous feature in the C / C ++ world</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>