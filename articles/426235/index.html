<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fiasco. The story of one homemade IoT</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most of the articles are written according to the principle ‚ÄúI / we did it / and look how cool!‚Äù. The same publication is dedicated to a failed projec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fiasco. The story of one homemade IoT</h1><div class="post__text post__text-html js-mediator-article">  Most of the articles are written according to the principle ‚ÄúI / we did it / and look how cool!‚Äù.  The same publication is dedicated to a failed project.  Welcome under the category‚Ä¶ <br><a name="habracut"></a><br><p>  This is a continuation of my publication <a href="https://habr.com/post/412889/">Developing smart devices on the example of a floor heating controller on ESP8266</a> </p><br><h1>  Let's start from afar </h1><br><p>  I live in a small house that is built according to my project.  Layout - eurotreshka, corridor, kitchen-living room on the first floor, bathroom, children's room and bedroom on the second.  Of non-standard - walls arbolit, foundation UWB, heating exclusively TP.  At the same time, the floors are wooden, on the second floor there is a floating floor, TP - in the slab GVL.  On the first floor there are 3 loops of TP pipes (actually one room), on the second one there are also three, but each loop is responsible for one room (bedroom, bathroom, children's room). A wall-mounted gas boiler of 14 kW is responsible for heat.  Controls the boiler Chinese programmable weekly wireless thermostat.  Every day of the week he has four periods, in each period you can set the desired temperature.  Brains on the battery, the relay is hidden.  Works great.  But I often need more than I have.  I wanted room temperature control.  I looked at the proposed solutions, I did not like anything.  And the word "Arduino" caught my eye.  And by specialty I am a programmer.  And it started ... <br></p><br><h1>  Iron </h1><br><p>  In iron I am not strong.  Soldering board is the height of my abilities.  But Arduino is such a simple thing that I understood - even with my knowledge of electronics, I am able to make a temperature controller in a house that suits me. <br></p><br><h2>  Temperature sensors </h2><br><p>  I have no love for wires in the interior.  I try to exclude or hide them, if it is impossible to exclude them.  And in a somewhat tortuous way, I came to use wireless sensors from Chinese weather stations as room temperature sensors.  The sensors operate on batteries for a long time and broadcast at 433 MHz.  It is quite nice, you can choose a different color, with the screen and no screen.  Looking ahead, I will say that each weather station manufacturer invents its own data transfer protocol with a sensor.  During the experiments, I analyzed the protocols of 5 types of sensors - they all have different data transfer formats.  I developed a library that accepts data from 4 types of sensors.  I didn‚Äôt bind with the fifth one - its protocol is not similar to the others by the absence of packet boundaries.  The main tool for data analysis has become the Chinese logic analyzer.  Without such a tool, it is practically impossible to perform protocol analysis.  It is worth quite a bit, it's easy to use - I recommend buying it to all arduinschiki. <br><br>  I implemented the library on the principle of sampling, frequency 10kHz.  This approach allowed to level the noise in the air and reduce the load on the processor, compared with the approach with interruptions when changing the level at the receiver pin.  Logic analyzer was used for debugging: <br><br></p><div class="spoiler">  <b class="spoiler_title">Signal with debug data</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/jv/b-/9x/jvb-9xsuwfff_jzqssndoueqtuy.png"><br>  3 ... 6 channels - data for debugging <br></div></div><br>  I will give examples of sensors and their features. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Type 1: Data transfer every 35 seconds.  The period does not change and this is a problem when using 3 or more sensors - the clock in the sensors go a little differently, the signals can sometimes overlap, and one or two sensors fall for an hour or two or three times a week or two.  6 data packets in 0.8 seconds.  Sensor ID changes each time it is turned on.  No data on battery status. <br><br><div class="spoiler">  <b class="spoiler_title">Appearance</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/73/q4/hq/73q4hqy2kt2e1g6kskwknlxqgog.jpeg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Data</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/s3/tv/li/s3tvlign-mrzalbwnxgpetpsuze.png"><br>  Above - receiver data, arrows indicate interference <br>  Below is the transmitter data. <br></div></div></li><li>  Type 2: Data transmission period - 40 ... 80 seconds, depending on the channel.  The best protocol in my opinion is 15 data packets for 0.6 seconds, there is a checksum.  Sensor ID changes when turned on, there is a transfer of battery status data.  The weakest transmitter - when I put the receiver in the box, the reception quality deteriorated markedly.  Probably being treated with an external antenna for the receiver. <br><br><div class="spoiler">  <b class="spoiler_title">Appearance</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/a-/74/mq/a-74mqp0kbs1rjamxutkfrch5ze.jpeg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Data</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/hs/ad/pi/hsadpizjgluvzpbbmatcs8uxd1k.png"><br>  no interference <br></div></div></li><li>  Type 3: The data transfer period is 50..55 seconds, depending on the channel.  7 packs for 0.6s.  ID changes when turned on, there is a transfer of battery status data.  Not a bad choice. <br><br><div class="spoiler">  <b class="spoiler_title">Appearance</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/s4/fe/qs/s4feqsvtxzspdzeh17diggowihi.jpeg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Data</b> <div class="spoiler_text">  Almost identical to type 1 <br></div></div></li><li>  Type 4: The data transfer period is 56 ... 76 seconds, depending on the channel.  There is no screen.  Changeable when enabled ID is not detected.  Are there any differences in the ID of different instances - I do not know, I have one such sensor.  Data on the status of the battery - is.  A powerful signal, the transmission pass was hardly observed. <br><br><div class="spoiler">  <b class="spoiler_title">Appearance</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/g0/_x/ox/g0_xoxr4b9alivfg0u0cnycmj2c.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Data</b> <div class="spoiler_text">  not preserved <br></div></div></li><li>  Type 5: The transmission period is not measured, there is no channel switch, the protocol is not deeply analyzed. <br><br><div class="spoiler">  <b class="spoiler_title">Appearance</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/6x/gl/gg/6xglggiwxyoraek8bzsfkwhn1bw.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Data</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/-d/ar/ak/-darakisubee19ofjj-ywhqukt0.png"><br></div></div></li></ul><br><p>  As a result, the receiver unit is implemented on the Arduino Pro Mini c output data on the i2c slave. <br></p><br><h2>  Arduino mega </h2><br><p>  This is the first platform on which I made the controller.  My controller had a command interface, was controlled by commands entered via UART.  At that stage, I planned to make the WEB-interface on ESP8266 and its communication with Mega on the UART.  I have a Mega board from Robotdyn, combined with ESP8266, and on this board I was planning to build my own development.  A special advantage of the board is a large number of external ports.  But in the process of exploring the ESP8266, I realized that this small chip is quite capable of combining the functions of a controller and an interface. <br></p><br><h2>  ESP8266 </h2><br><p> I used the WeMos D1 mini board option, it has a small size and a sufficient number of outputs for me - taking into account the use of the port expander.  There are a huge number of libraries for this board.  For example, me-no-dev / ESPAsyncWebServer is an excellent web server library with web socket support.  I gathered the controller on this board.  Developed a web interface.  Everything works beautifully.  But for some incomprehensible reason - uptime is not more than a day.  Either I did something crooked, or some of the libraries used is a curve.  In addition, there is a limit on 5 simultaneous connections.  When exceeded - restart or even hang (despite the existing watchdog. I struggled with hangs using an external watchdog).  Taking into account the fact that my web interface consists of almost a dozen files, and browsers load pages in 5 parallel streams - to achieve a restart is elementary.  For myself, I decided - this board can only be used as a client.  Began to look for other solutions. <br><br></p><div class="spoiler">  <b class="spoiler_title">Interface screenshots</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/1l/ou/xa/1louxawbn02i_s0bo29nkf3bf-y.png"><br><br><img src="https://habrastorage.org/webt/gt/rs/qv/gtrsqvdpsbhca9mhutpqqwj5fy4.png"><br><br><img src="https://habrastorage.org/webt/gc/4v/kq/gc4vkq-nvkjd8iqa8w3tsnhavlm.png"><br><br><img src="https://habrastorage.org/webt/vi/id/gk/viidgkepui5yqftwgqx3u_kshfy.png"><br><br><img src="https://habrastorage.org/webt/ka/qv/ul/kaqvultuwafymejfaaa_qk8wvg8.png"><br></div></div><br><br><h2>  ESP32 </h2><br><p>  This is sort of like the heir to ESP8266.  In ESP32, most of all - frequencies, memory, legs, ... But the trouble is that the me-no-dev / ESPAsyncWebServer library does not work on it in terms of web sockets.  Totally.  Flies out.  Something related to multithreading.  I did not find another web server library with web socket support. <br></p><br><h1>  SOC </h1><br><p>  At this stage, I decided to use a board with linux - I did not invent anything more suitable. <br></p><br><p>  My requirements for the board.  It seems there are not many of them: <br></p><br><br><ul><li>  I don't need a screen. </li><li>  Due to the lack of a screen for initial setup, the board should be able to work in the access point mode. </li><li>  I need a minimum of operating system functionality. </li></ul><br><h2>  Orange Pi i96 </h2><br><p>  This board was suitable in all respects - no video output, WiFi, built-in flash memory, SD card slot.  You can put Ubuntu or DietPi on the built-in memory.  But the trouble of this board is its software.  You can not make an access point.  Well, the biggest problem is that when the restart is changed, the MAC address changes and nothing happened with that.  In the furnace.  (At the time of writing, on w3bsit3-dns.com, in the branch dedicated to the analogue of this board (2g IOT), a message appeared that it is possible to defeat the MAC shift) <br></p><br><h2>  Onion Omega 2+ </h2><br><p>  Elegant documentation.  With the firmware out of the box, everything started up, the screen is not needed, the UART is optional.  SSH is enabled by default.  Node.js was installed (version 4.x, but it doesn't matter to me).  The sqlite and i2c libraries for Node.js were installed (using a tambourine). <br>  Besides i2c, I no longer need any hardware interfaces.  Compared to the version of my development on the ESP8266, a separate Arduino Pro Mini controller has been added to analyze the data of the temperature sensor receiver.  The receiver controller is connected to the Omega as an i2c slave.  Wired sensors with 1wire interface are connected via a 1wire &lt;-&gt; i2c bridge (DS2482-100).  For this bridge there is a library for node.js, but it did not work for me in the part of the search for sensors.  I did not understand, ported to DS library js that worked on ESP8266 on js. <br><br>  But the trouble is that WiFi on Omega-2 does not work stably, it does not reconnect after rebooting the router.  This problem is solved by firmware version 2, it is not in the release status, but it works.  It became much better.  But the problem was clarified - sometimes the board falls off the Zyxel router and connects again after rebooting the router or after an hour or two or three by itself without rebooting the router.  Or it starts terribly stupid - this problem went away after changing the power supply circuit (the board loves 3.3V or slightly higher) and adding an external antenna - the omega was very happy about it.  Thus, in principle I am satisfied with the board - something that is not available sometimes does not bother me very much - as the main interface I used an old smartphone in the dock connected to the Omega access point.  But remote access will be much needed - I can remotely restart the router.  It causes confusion - Omega-2 has two RST pins - one must be + to one, as I understand it, this is handled programmatically.  What to submit to the second and how to connect an external watchdog, which gives - I do not know yet. <br><br></p><div class="spoiler">  <b class="spoiler_title">Interface in the interior</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/vc/5c/ax/vc5caxnocdaa4-td43zrfjlp-qk.jpeg"><br></div></div><br><h1>  Controller logic </h1><p>  I have already described the software architecture of the controller ‚Äî it has not changed (i.e., control of text commands transmitted via a web socket).  The web interface migrated from ESP8266 with cosmetic changes.  Many procedures / functions of the controller code were simply translated from C ++ to JS.  Another thing is that the presence of linux (OpenWRT) gave me the opportunity to use a SQL database - sqlite.  Thus, I organized all the logic on SQL queries.  This is actually my first experience with sqlite.  I especially liked the possibility of using in-memory databases - I arranged all the temporary and current data in this database (for example, sensor data, data on the current required temperature, ...). <br><br></p><div class="spoiler">  <b class="spoiler_title">Sources</b> <div class="spoiler_text">  I usually share ideas, not source.  I think it stimulates mental activity, mine and readers.  Want to get the source - write in a personal. <br></div></div><br><h1>  Assembly </h1><p>  I collected everything in the gland, placed it in a box.  Next - life tests.  After a week of uptime - I decided that the test was passed.  You can install. <br><br></p><div class="spoiler">  <b class="spoiler_title">Box</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/0_/mh/xa/0_mhxabqxjznpida6ihqrktupby.jpeg"><br></div></div><br><h1>  Installation </h1><br><p>  This stage was very successful.  Hung a box next to the collector, installed and connected the thermal heads.  I was very happy with my idea of ‚Äã‚Äãstoring all data, settings and parameters in the database - on the fly I was able to configure the correspondence of the relays and zones in a way that was not planned, namely, three relays per zone, and all other relays to move (the original the idea was one zone - one relay).  The project included the use of a set of DS18B20 service sensors, to monitor the coolant temperature at the supply, in the return pipe of each loop of a warm floor, and the total return temperature - these sensors were also successfully connected and configured (all settings - to specify the clear name of the sensor). <br></p><br><p>  Connected the boiler relay. <br></p><br><h1>  Launch </h1><br><p>  The controller earned as planned. <br></p><br><p>  For the test, I decided to slightly raise the temperature in one of the rooms on the second floor. <br></p><br><p>  The boiler began to overheat and shut down. <br></p><br><p>  And here the service sensors came in handy.  It turned out that the water temperature at the exit from the loop of this room is only a couple of tenths of a degree less than at the entrance!  The water does not cool!  This means that it does not give off heat.  And in the whole house it is warm at any temperature overboard (the goal was to slightly lower the temperature on the second floor).  So everything gives warmth to the first floor, and the TP on the second floor barely heats the floor.  As a result, room-based regulation of heating in such conditions is not possible. <br></p><br><h1>  Conclusion </h1><br><p>  Thus, the influence of physics and the design features of my house put an end to my design.  Despite the fact that the controller itself works fine, I cannot use it in the heating system of my house.  Maybe I will make him a downgrade, so that he controls the climate in the house like a Chinese thermostat - according to a single sensor, but for now I see no reason. <br></p><br><p>  However, the project as a whole is not successful, in the process of development I became acquainted with many technologies with which I was practically unfamiliar: <br><br></p><ul><li>  Controller programming </li><li>  I learned about the data bus 1wire, i2c, uart, ... </li><li>  Gained some knowledge of the web server device </li><li>  It seems not bad understood in Web-frontend development: html, JavaScript, vue.js </li><li>  I mastered the Web-backend development: node.js </li></ul><br><br><p>  Thus, I got a great experience on a failed project, which may be useful on other projects. <br><br>  Those who read up to this place - can see what <a href="http://tco.vehs.ru/">happened</a> . <br>  (the last three settings are blocked) </p><br><h1>  PS Perfect Board for DIY </h1><br>  In the process of writing the article, another trouble with Omega-2 was discovered - the module began to hang.  Hard, reset does not help, just power off.  What is the problem - I do not know yet.  Maybe he doesn‚Äôt like high power - now he receives 3.8V.  I'll try to replace the power module.  Despite the fact that the project does not fulfill its functions, for the time being I will leave it in thermometer mode (as they say, do not do it on Arduino - you will get a weather station).  But in any case, the topic is interesting to me, I want to achieve 100% availability of the system 24/7.  If replacing the power supply doesn't help, I'll try the LinkIt Smart 7688 system. It seems to be hardware identical to Omega.  It may be more stable. <br>  Addition: after replacing the linear stabilizer 5-&gt; 3.3v with a pulsed problem with WiFi, Onion Omega 2+ was not noticed - stable work for a week.  Then he wrote this addition. <br><br>  Based on this - I have not yet found the ideal board for homemade products: ( <br><br>  Probably, as the next project‚Äôs brain, I‚Äôll try to use a smartphone on android - the sensors will have to be connected to it via wifi, but there are almost no problems with the stability of branded phones.  And node.js can be put on the phone. <br><br>  I would be grateful if you share your vision on choosing a board for DIY. </div><p>Source: <a href="https://habr.com/ru/post/426235/">https://habr.com/ru/post/426235/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../426223/index.html">Android development and problem solving related to development</a></li>
<li><a href="../426227/index.html">How to farm Kaggle</a></li>
<li><a href="../426229/index.html">Code of Conduct: why Linux kernel developers threatened to delete their code - we understand the conflict</a></li>
<li><a href="../426231/index.html">Britain wants to regulate the Internet - what will affect the new laws</a></li>
<li><a href="../426233/index.html">Study: large wind power stations can heat up the soil, which affects climate</a></li>
<li><a href="../426237/index.html">How to determine the minimum size required for a DFSR replication staging folder</a></li>
<li><a href="../426241/index.html">Conference BLACK HAT USA. A botnet of a million browsers. Part 1</a></li>
<li><a href="../426243/index.html">How to get to Hell because of Helm, but grab onto a straw</a></li>
<li><a href="../426245/index.html">Improving online programs</a></li>
<li><a href="../426249/index.html">Bluetooth device control</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>