<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Make your AngularJS: Part 1 - Scope and Digest</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Angular is a mature and powerful JavaScript framework. It is quite large and is based on a multitude of new concepts that you need to master in order ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Make your AngularJS: Part 1 - Scope and Digest</h1><div class="post__text post__text-html js-mediator-article">  Angular is a mature and powerful JavaScript framework.  It is quite large and is based on a multitude of new concepts that you need to master in order to work with it effectively.  Most developers, getting acquainted with Angular, face the same difficulties.  What exactly does the digest function do?  What are some ways to create directives?  What is the difference between service and provider? <br><br>  Despite the fact that Angular has pretty good <a href="http://docs.angularjs.org/">documentation</a> , and there are a lot of <a href="http://syntaxspectrum.com/tag/angularjs/">third-party resources</a> , there is no better way to learn the technology than to disassemble it in pieces and reveal its magic. <br><br>  In this series of articles, I <b>'m going to recreate AngularJS from scratch</b> .  We will do this together step by step, in the process of which you will understand the internal structure of Angular much deeper. <br><a name="habracut"></a><br>  In the first part of this series, we will consider the device scope, and how, in fact, <b>$ eval</b> , <b>$ digest,</b> and <b>$ apply work</b> .  Checking the data for change (dirty-checking) in Angular seems like magic, but it‚Äôs not - you will see for yourself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Training </h4><br>  <a href="">Project sources</a> are available on github, but I would not advise you to just copy them yourself.  Instead, I insist that you do everything yourself, step by step, playing around with the code and digging into it.  In the text I use <a href="http://jsbin.com/">JS Bin</a> , so you can work through the code without even leaving the page ( <b>note. Lane</b> - only references to JS Bin code will be translated). <br><br>  We will use <a href="http://lodash.com/">Lo-Dash</a> for some low-level operations with arrays and objects.  Angular itself does not use Lo-Dash, but for our purposes it makes sense to remove as much of the template low-level code as possible.  Wherever you meet in the code ( <b>_</b> ) (underscore character) - Lo-Dash functions are called. <br><br>  We will also use the <b>console.assert</b> function for the simplest checks.  It should be available in all modern JavaScript environments. <br><br>  Here is an example of Lo-Dash and assert in action: <br><br>  <a href="http://jsbin.com/UGOVUk/4/edit">JS Bin Code</a> <br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b = [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c = _.map(a, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i * <span class="hljs-number"><span class="hljs-number">2</span></span>; }); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.assert(a !== b); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.assert(_.isEqual(a, b)); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.assert(_.isEqual([<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>], c));</code> </pre> <br>  Console: <br><pre> true
 true
 true </pre><br></div></div><br><h4>  Objects - scope (s) </h4><br>  Objects of scope in Angular are regular JavaScript objects to which you can add properties in the standard way.  They are created using the <b>Scope</b> constructor.  Let's write its simplest implementation: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ }</code> </pre><br>  Now, using the <b>new</b> operator, you can create scope-objects and add properties to them. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> aScope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); aScope.firstName = <span class="hljs-string"><span class="hljs-string">'Jane'</span></span>; aScope.lastName = <span class="hljs-string"><span class="hljs-string">'Smith'</span></span>;</code> </pre><br>  These properties are nothing special.  No need to assign any special setters (setters), there are no restrictions on the types of values.  Instead, all the magic lies in two functions: <b>$ watch</b> and <b>$ digest</b> . <br><br><h4>  Monitoring object properties: $ watch and $ digest </h4><br>  <b>$ watch</b> and <b>$ digest</b> are two sides of the same coin.  Together they form the core of what scope objects are in Angular: the response to data changes. <br><br>  Using <b>$ watch</b> you can add to the scope of the ‚Äúobserver‚Äù.  The observer is what will be notified when a change occurs in the appropriate scope. <br><br>  An observer is created by passing two functions to <b>$ watch</b> : <br><br><ul><li>  <i>A watch function</i> that returns data that you are interested in changing. </li><li>  <i>listener function</i> that will be called when this data changes </li></ul><br><blockquote>  In Angular, instead of the watch functions, you usually used a watch expression.  This is a string (something like ‚Äúuser.firstName‚Äù) that you specified in html when linking, as an attribute of a directive, or directly from JavaScript.  This line was parsed and compiled by Angular in, similar to our watch-function.  We will look at how this is done in the next article.  In the same article, we will stick to the low-level approach using watch functions. </blockquote><br>  To implement <b>$ watch</b> , we need to store all registered observers somewhere.  Let's add an array for them to the <b>Scope</b> constructor: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; }</code> </pre><br>  The <b>$$</b> prefix means that the variable is private in the Angular framework and should not be called from the application code. <br><br>  Now you can define the function <b>$ watch</b> .  It will take two functions as arguments and store them in the <b>$$ watchers</b> array.  It is supposed that every scope-object needs this function, so let's put it into a prototype: <br><br><pre> <code class="javascript hljs">Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); };</code> </pre><br>  The downside is the <b>$ digest</b> function.  It launches all observers registered for a given scope.  Let us describe its simplest implementation, in which all observers simply move, and each of them has a listener function called: <br><br><pre> <code class="javascript hljs">Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ watch.listenerFn(); }); };</code> </pre><br>  Now you can register an observer, run <b>$ digest</b> , as a result, it will work out its listener function: <br><br>  <a href="http://jsbin.com/oMaQoxa/2/edit">JS Bin Code</a> <br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; } Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ watch.listenerFn(); }); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'watchFn'</span></span>); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'listener'</span></span>); } ); scope.$digest(); scope.$digest(); scope.$digest();</code> </pre><br>  Console: <br><pre> "listener"
 "listener"
 "listener" </pre><br></div></div><br>  By itself, this is not particularly useful.  What we would really like is for the handlers to be launched only if the data indicated in the watch functions really changed. <br><br><h4>  Data change detection </h4><br>  As mentioned earlier, the watch function of the observer must return the data, the change of which is interesting to it.  Usually this data is in scope, therefore, for convenience, the scope is passed to it as an argument.  A watch function that looks at the <b>firstName</b> of scope will look something like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.firstName; }</code> </pre><br>  In most cases, the watch function looks like this: retrieves the data that it is interested in from the scope and returns it. <br><br>  The function of <b>$ digest</b> is to call this watch-function and compare the value received from it with what it returned last time.  If the values ‚Äã‚Äãdiffer, then the data is ‚Äúdirty‚Äù and you need to call the appropriate listener function. <br><br>  To do this, <b>$ digest</b> must remember the last returned value for each watch function, and since we already have an object for each observer, it is most convenient to store this data in it.  Here is the new implementation of the <b>$ digest</b> function, which checks for change data for each observer: <br><br><pre> <code class="javascript hljs">Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newValue !== oldValue) { watch.listenerFn(newValue, oldValue, self); } watch.last = newValue; }); };</code> </pre><br>  For each observer, a watch function is called, passing the current scope as an argument.  Next, the resulting value is compared with the previous one, stored in the <b>last</b> attribute.  If the values ‚Äã‚Äãdiffer, the listener is called.  For convenience, both values ‚Äã‚Äãand scope are passed as arguments to the listener.  At the end, the <b>last</b> value of the observer has a new value written so that it can be compared next time. <br><br>  Let's take a look at how listeners are started in this implementation when <b>$ digest is</b> called: <br><br>  <a href="http://jsbin.com/OsITIZu/3/edit">JS Bin Code</a> <br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; } Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newValue !== oldValue) { watch.listenerFn(newValue, oldValue, self); } watch.last = newValue; }); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.firstName = <span class="hljs-string"><span class="hljs-string">'Joe'</span></span>; scope.counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.firstName; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, scope</span></span></span><span class="hljs-function">) </span></span>{ scope.counter++; } ); <span class="hljs-comment"><span class="hljs-comment">// We haven't run $digest yet so counter should be untouched: console.assert(scope.counter === 0); // The first digest causes the listener to be run scope.$digest(); console.assert(scope.counter === 1); // Further digests don't call the listener... scope.$digest(); scope.$digest(); console.assert(scope.counter === 1); // ... until the value that the watch function is watching changes again scope.firstName = 'Jane'; scope.$digest(); console.assert(scope.counter === 2);</span></span></code> </pre><br>  Console: <br><pre> true
 true
 true
 true </pre><br></div></div><br>  Now we have already implemented the core of the Angular-ovshe scope: registering observers and launching them in the <b>$ digest</b> function. <br><br>  We can also now draw a couple of conclusions regarding the performance of the scope in Angular: <br><br><ul><li>  Adding data to a scope does not in itself affect performance.  If there are no observers tracking the data, then it makes no difference whether the data is added to the scope or not.  Angular does not enumerate scope properties, it enumerates observers. </li><li>  Each watch-function is necessarily called during the operation of $ digest.  For this reason, it makes sense to pay attention to how many observers you have, as well as the performance of each watch function in itself. </li></ul><br><h4>  Alert about what is happening digest </h4><br>  If you need to receive notifications that <b>$ digest</b> is running, you can take advantage of the fact that each watch function, in the process of running $ digest, is sure to start.  You just need to register the watch-function without a listener. <br><br>  To take this into account, in the <b>$ watch</b> function, it is necessary to check whether the listener is missing or, if yes, to replace the stub function in its place: <br><br><pre> <code class="javascript hljs">Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ } }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); };</code> </pre><br>  If you use this template, keep in mind that Angular takes into account the value returned from the watch function, even if the listener function is not declared.  If you return any value, it will participate in the check for changes.  In order not to cause unnecessary work, just don‚Äôt return anything from the function, by default <b>undefined</b> will always be returned: <br><br>  <a href="http://jsbin.com/OsITIZu/4/edit">JS Bin Code</a> <br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; } Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ } }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newValue !== oldValue) { watch.listenerFn(newValue, oldValue, self); } watch.last = newValue; }); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.$watch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'digest listener fired'</span></span>); }); scope.$digest(); scope.$digest(); scope.$digest();</code> </pre><br>  Console: <br><pre> "digest listener fired"
 "digest listener fired"
 "digest listener fired" </pre><br></div></div><br>  The kernel is ready, but it‚Äôs still far from the end.  For example, a fairly typical scenario is not taken into account: listener functions themselves can change properties from scope.  If this happens, and another observer was following this property, it may happen that this observer will not receive notification of the change, at least during this <b>$ digest</b> pass: <br><br>  <a href="http://jsbin.com/eTIpUyE/2/edit">JS Bin Code</a> <br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; } Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{} }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newValue !== oldValue) { watch.listenerFn(newValue, oldValue, self); } watch.last = newValue; }); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.firstName = <span class="hljs-string"><span class="hljs-string">'Joe'</span></span>; scope.counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.counter; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, scope</span></span></span><span class="hljs-function">) </span></span>{ scope.counterIsTwo = (newValue === <span class="hljs-number"><span class="hljs-number">2</span></span>); } ); scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.firstName; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, scope</span></span></span><span class="hljs-function">) </span></span>{ scope.counter++; } ); <span class="hljs-comment"><span class="hljs-comment">// After the first digest the counter is 1 scope.$digest(); console.assert(scope.counter === 1); // On the next change the counter becomes two, but our other watch hasn't noticed this yet scope.firstName = 'Jane'; scope.$digest(); console.assert(scope.counter === 2); console.assert(scope.counterIsTwo); // false // Only sometime in the future, when $digest() is called again, does our other watch get run scope.$digest(); console.assert(scope.counterIsTwo); // true</span></span></code> </pre><br>  Console: <br><pre> true
 true
 false
 true </pre><br></div></div><br>  Let's fix it. <br><br><h4>  We execute $ digest as long as there is ‚Äúdirty‚Äù data </h4><br>  It is necessary to correct the <b>$ digest</b> so that it continues to do checks until the observed values ‚Äã‚Äãstop changing. <br><br>  First, let's rename the current $ digest function into <b>$$ digestOnce</b> , and change it so that, running all watch functions once, returns a boolean indicating whether there was at least one change in the values ‚Äã‚Äãof the observed fields or not: <br><br><pre> <code class="javascript hljs">Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newValue !== oldValue) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = newValue; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; };</code> </pre><br>  After that, we will re-declare the <b>$ digest</b> function so that it <b>runs $$ digestOnce</b> in the loop as long as there are changes: <br><br><pre> <code class="javascript hljs">Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); };</code> </pre><br>  <b>$ digest</b> now performs registered watch functions at least once.  If, in the first pass, any of the observed values ‚Äã‚Äãhas changed, the pass is marked as ‚Äúdirty‚Äù and the second pass is started.  This happens until no altered value is detected for the entire passage - the situation stabilizes. <br><blockquote>  Angular scope s do not really have the $$ digestOnce function.  Instead, this functionality is built into the loop directly in $ digest.  For our purposes, clarity and readability are more important than performance, so we did a little refactoring. </blockquote><br>  Here is the new implementation in action: <br><br>  <a href="http://jsbin.com/Imoyosa/3/edit">JS Bin Code</a> <br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; } Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn ||<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ } }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newValue !== oldValue) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = newValue; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.firstName = <span class="hljs-string"><span class="hljs-string">'Joe'</span></span>; scope.counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.counter; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, scope</span></span></span><span class="hljs-function">) </span></span>{ scope.counterIsTwo = (newValue === <span class="hljs-number"><span class="hljs-number">2</span></span>); } ); scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.firstName; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, scope</span></span></span><span class="hljs-function">) </span></span>{ scope.counter++; } ); <span class="hljs-comment"><span class="hljs-comment">// After the first digest the counter is 1 scope.$digest(); console.assert(scope.counter === 1); // On the next change the counter becomes two, and the other watch listener is also run because of the dirty check scope.firstName = 'Jane'; scope.$digest(); console.assert(scope.counter === 2); console.assert(scope.counterIsTwo);</span></span></code> </pre><br>  Console: <br><pre> true
 true
 true </pre><br></div></div><br>  You can make another important conclusion regarding the watch-functions: they can work several times in the process of $ digest.  That is why, it is often said that watch functions should be idempotent: there should be no side effects in the function, or there should be such side effects for which it will be normal to trigger several times.  If, for example, in a watch function, there is an AJAX request, there are no guarantees on how many times this request is executed. <br><br>  There is one big flaw in our current implementation: what happens if two observers watch each other's changes?  In this case, the situation never stabilizes?  A similar situation is implemented in the code below.  In the example, the call to <b>$ digest is</b> commented out. <br><br>  Uncomment it to find out what happens: <br><br>  <a href="http://jsbin.com/eKEvOYa/3/edit">JS Bin Code</a> <br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; } Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ } }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newValue !== oldValue) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = newValue; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.counter1 = <span class="hljs-number"><span class="hljs-number">0</span></span>; scope.counter2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.counter1; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, scope</span></span></span><span class="hljs-function">) </span></span>{ scope.counter2++; } ); scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.counter2; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, scope</span></span></span><span class="hljs-function">) </span></span>{ scope.counter1++; } ); <span class="hljs-comment"><span class="hljs-comment">// Uncomment this to run the digest // scope.$digest(); console.log(scope.counter1);</span></span></code> </pre><br>  Console: <br><pre> 0 </pre><br></div></div><br>  JSBin stops the function after a while (about 100,000 iterations occur on my machine).  If you run this code, for example, under node.js, it will run forever. <br><br><h4>  Getting rid of instability in $ digest </h4><br>  All we need is to limit the work of <b>$ digest to a</b> certain number of iterations.  If the scope still continues to change after the end of the iterations, we raise our hands and give up - probably the state never stabilizes.  In this situation, an exception could be thrown, since the state of the scope is clearly not what the user expected it to be. <br><br>  The maximum number of iterations is called TTL (abbreviation from time to live - life time).  By default, we set it to 10. This number may seem small (we just started the digest about 100,000 times), but note that this is a performance issue - the digest is performed frequently, and every time all watch functions are processed in it.  In addition, it seems unlikely that the user will have more than 10 watch-related functions. <br><blockquote>  In Angular TTL can be customized.  We will come back to this in the next articles, when we discuss providers and dependency injection. </blockquote><br>  Well, let's continue - let's add a counter to the digest loop.  If you reach the TTL - throw an exception: <br><br><pre> <code class="javascript hljs">Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); };</code> </pre><br>  An updated version of the previous example throws an exception: <br><br>  <a href="http://jsbin.com/uNapUWe/2/edit">JS Bin Code</a> <br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; } Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ } }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newValue !== oldValue) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = newValue; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.counter1 = <span class="hljs-number"><span class="hljs-number">0</span></span>; scope.counter2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.counter1; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, scope</span></span></span><span class="hljs-function">) </span></span>{ scope.counter2++; } ); scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.counter2; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, scope</span></span></span><span class="hljs-function">) </span></span>{ scope.counter1++; } ); scope.$digest();</code> </pre><br>  Console: <br><pre> "Uncaught 10 digest iterations reached (line 36)" </pre><br></div></div><br>  From obsession with digest got rid of. <br><br>  Now let's look at exactly <i>how</i> we determine that something has changed. <br><br><h4>  Check for change by value </h4><br>  At the moment, we compare the new values ‚Äã‚Äãwith the old ones, using the strict equality operator <b>===</b> .  In most cases it works: the change is normally determined for primitive types (numbers, strings, etc.), it is also determined if the object or array is replaced by another.  But in Angular, there is another way to identify changes, it allows you to find out if something has changed inside the array or object.  To do this, compare <i>by value</i> , not <i>by reference</i> . <br><br>  This type of check can be enabled by passing an optional third Boolean type parameter to the <b>$ watch</b> function.  If this flag is true, then check by value is used.  Let's modify the <b>$ watch</b> - we will receive the flag and store it in the observer ( <b>watcher</b> variable): <br><br><pre> <code class="javascript hljs">Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn, <span class="hljs-attr"><span class="hljs-attr">valueEq</span></span>: !!valueEq }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); };</code> </pre><br>  All we did was add a flag to the observer, forcing it to a boolean type, using double negation.  When the user calls <b>$ watch</b> without the third parameter, <b>valueEq</b> will be <b>undefined</b> , which is converted to <b>false</b> in the watcher object. <br><br>  Check by value implies that if the value is an object or an array, you will need to go over both the old and the new content.  If there are any differences, the observer is marked as ‚Äúdirty‚Äù.  The contents may contain nested objects or arrays, in which case they will also need to be recursively checked by value. <br><br>  Angular has its <a href="">own comparison function by value</a> , but we will use the one <a href="http://lodash.com/docs">in Lo-Dash</a> .  Let's write a comparison function that accepts a pair of values ‚Äã‚Äãand a flag: <br><br><pre> <code class="javascript hljs">Scope.prototype.$$areEqual = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (valueEq) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isEqual(newValue, oldValue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newValue === oldValue; } };</code> </pre><br>  In order to determine the changes ‚Äúby value‚Äù, it is also necessary for the friend to keep the ‚Äúold values‚Äù.  It is not enough just to keep references to current values, since any changes that are made will also get into the object that we stored.  We will not be able to determine whether something has changed or not if the <b>$$ areEqual</b> function always has two references to the same data.  Therefore, we will have to do a deep copy of the content, and save this copy. <br><br>  Just as in the case of the comparison <a href="">function</a> , Angular has <a href="">its own function of deep data copying</a> , but we use the <a href="http://lodash.com/docs">same from Lo-Dash</a> .  Let's modify <b>$$ digestOnce</b> to use <b>$$ areEqual</b> for comparison and make a copy in the <b>last</b> if needed: <br><br><pre> <code class="javascript hljs">Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$areEqual(newValue, oldValue, watch.valueEq)) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = (watch.valueEq ? _.cloneDeep(newValue) : newValue); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; };</code> </pre><br>  Now you can see the difference between the two ways of comparing values: <br><br>  <a href="http://jsbin.com/ARiWENO/3/edit">JS Bin Code</a> <br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; } Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ }, <span class="hljs-attr"><span class="hljs-attr">valueEq</span></span>: !!valueEq }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$$areEqual = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (valueEq) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isEqual(newValue, oldValue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newValue === oldValue; } }; Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$areEqual(newValue, oldValue, watch.valueEq)) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = (watch.valueEq ? _.cloneDeep(newValue) : newValue); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.counterByRef = <span class="hljs-number"><span class="hljs-number">0</span></span>; scope.counterByValue = <span class="hljs-number"><span class="hljs-number">0</span></span>; scope.value = [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, {<span class="hljs-attr"><span class="hljs-attr">three</span></span>: [<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>]}]; <span class="hljs-comment"><span class="hljs-comment">// Set up two watches for value. One checks references, the other by value. scope.$watch( function(scope) { return scope.value; }, function(newValue, oldValue, scope) { scope.counterByRef++; } ); scope.$watch( function(scope) { return scope.value; }, function(newValue, oldValue, scope) { scope.counterByValue++; }, true ); scope.$digest(); console.assert(scope.counterByRef === 1); console.assert(scope.counterByValue === 1); // When changes are made within the value, the by-reference watcher does not notice, but the by-value watcher does. scope.value[2].three.push(6); scope.$digest(); console.assert(scope.counterByRef === 1); console.assert(scope.counterByValue === 2); // Both watches notice when the reference changes. scope.value = {aNew: "value"}; scope.$digest(); console.assert(scope.counterByRef === 2); console.assert(scope.counterByValue === 3); delete scope.value; scope.$digest(); console.assert(scope.counterByRef === 3); console.assert(scope.counterByValue === 4);</span></span></code> </pre><br> : <br><pre> true
 true
 true
 true
 true
 true </pre><br></div></div><br>   , ,    ,    .     ,       .    Angular       .     . <br><blockquote>  Angular         : ‚Äú  ‚Äù.         ,      ,     ,        .   .        $watchCollection ‚Äî        . </blockquote><br>            JavaScript. <br><br><h4>  NaN </h4><br>   JavaScript  <b>NaN</b> (not a number ‚Äî  )    .    , ,      .    <b>NaN</b>        ,  watch-,   <b>NaN</b>    ,  ‚Äú‚Äù. <br><br>   ‚Äú ‚Äù       <b>isEqual</b>  Lo-Dash.   ‚Äú ‚Äù     .      <b>$$areEqual</b> : <br><br><pre> <code class="javascript hljs">Scope.prototype.$$areEqual = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (valueEq) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isEqual(newValue, oldValue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newValue === oldValue || (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> newValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> oldValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(newValue) &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(oldValue)); } };</code> </pre><br>    <b>NaN</b>    : <br><br> <a href="http://jsbin.com/ijINaRA/2/edit">  JS Bin</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; } Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{}, <span class="hljs-attr"><span class="hljs-attr">valueEq</span></span>: !!valueEq }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$$areEqual = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (valueEq) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isEqual(newValue, oldValue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newValue === oldValue || (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> newValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> oldValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(newValue) &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(oldValue)); } }; Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$areEqual(newValue, oldValue, watch.valueEq)) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = (watch.valueEq ? _.cloneDeep(newValue) : newValue); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.number = <span class="hljs-number"><span class="hljs-number">0</span></span>; scope.counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.number; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, scope</span></span></span><span class="hljs-function">) </span></span>{ scope.counter++; } ); scope.$digest(); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.assert(scope.counter === <span class="hljs-number"><span class="hljs-number">1</span></span>); scope.number = <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(<span class="hljs-string"><span class="hljs-string">'wat'</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Becomes NaN scope.$digest(); console.assert(scope.counter === 2);</span></span></code> </pre><br> : <br><pre> true
 true </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now let's shift the focus from checking the values ‚Äã‚Äãto how we can interact with the scope from the application code. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> $ eval - code execution in scope </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In Angular, there are several options for running code in the context scope. </font><font style="vertical-align: inherit;">The simplest of these is the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ eval</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It takes a function as an argument, and the only thing that does is call it immediately, passing it the current scope, as a parameter. </font><font style="vertical-align: inherit;">Well, and then it returns the result of the execution. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ eval</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> also accepts a second parameter, which it passes unchanged to the function being called. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The implementation of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ eval is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> very simple:</font></font><br><br><pre> <code class="javascript hljs">Scope.prototype.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr, locals</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expr(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, locals); };</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ eval</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is also quite simple: </font></font><br><br> <a href="http://jsbin.com/UzaWUC/1/edit"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JS Bin code</font></font></a> <br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View code</font></font></b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; } Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{}, <span class="hljs-attr"><span class="hljs-attr">valueEq</span></span>: !!valueEq }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$$areEqual = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (valueEq) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isEqual(newValue, oldValue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newValue === oldValue || (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> newValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> oldValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(newValue) &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(oldValue)); } }; Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$areEqual(newValue, oldValue, watch.valueEq)) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = (watch.valueEq ? _.cloneDeep(newValue) : newValue); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); }; Scope.prototype.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr, locals</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expr(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, locals); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.number = <span class="hljs-number"><span class="hljs-number">1</span></span>; scope.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">theScope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Number during $eval:'</span></span>, theScope.number); });</code> </pre><br> : <br><pre>"Number during $eval:"
 one </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So what's the use of such an elaborate way of calling a function? </font><font style="vertical-align: inherit;">One advantage is that </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ eval</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> makes the code that works with the contents of the scope a little more transparent. </font><font style="vertical-align: inherit;">Also </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ eval</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a building block for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ apply</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which we will deal with soon. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, the greatest benefit of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ eval</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will manifest itself only when we begin to discuss the use of ‚Äúexpressions‚Äù instead of functions. </font><font style="vertical-align: inherit;">As with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ watch</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">you can pass a string expression </font><font style="vertical-align: inherit;">to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ eval</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It will compile it and execute in the context scope. </font><font style="vertical-align: inherit;">Further in the series of articles, we will implement this.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> $ apply - integration of external code with the $ digest loop </font></font></h4><br> , <b>$apply</b>      <b>Scope</b> .  ,       c Angular.     . <br><br> $apply    ,   ,  <b>$eval</b> ,      <b>$digest</b> .    : <br><br><pre> <code class="javascript hljs">Scope.prototype.$apply = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(expr); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$digest(); } };</code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ digest</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is called in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finally</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> block </font><font style="vertical-align: inherit;">to update the dependencies, even if exceptions occurred in the function. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The idea is that using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ apply</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , we can execute code that is not familiar with Angular. </font><font style="vertical-align: inherit;">This code can change the data in the scope, and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ apply</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will ensure that the observers catch these changes. </font><font style="vertical-align: inherit;">This is what they mean when they talk about "integrating code into the Angular life cycle." </font><font style="vertical-align: inherit;">This is nothing more. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ apply</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in action: </font></font><br><br> <a href="http://jsbin.com/UzaWUC/2/edit"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JS Bin code</font></font></a> <br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View code</font></font></b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; } Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{}, <span class="hljs-attr"><span class="hljs-attr">valueEq</span></span>: !!valueEq }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$$areEqual = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (valueEq) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isEqual(newValue, oldValue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newValue === oldValue || (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> newValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> oldValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(newValue) &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(oldValue)); } }; Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$areEqual(newValue, oldValue, watch.valueEq)) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = (watch.valueEq ? _.cloneDeep(newValue) : newValue); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); }; Scope.prototype.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr, locals</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expr(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, locals); }; Scope.prototype.$apply = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(expr); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$digest(); } }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.aValue; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, scope</span></span></span><span class="hljs-function">) </span></span>{ scope.counter++; } ); scope.$apply(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ scope.aValue = <span class="hljs-string"><span class="hljs-string">'Hello from "outside"'</span></span>; }); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.assert(scope.counter === <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><br> : <br><pre> true </pre><br></div></div><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Delayed Execution - $ evalAsync </font></font></h4><br>  JavaScript       ¬´¬ª ‚Äî       ,        .     <b>SetTimeout()</b>   (   ) . <br><br>      Angular ,       <a href="http://docs.angularjs.org/api/ng.%24timeout"></a> <b>$timeout</b> ,          digest-   <b>$apply</b> . <br><br>          Angular ‚Äî   <b>$evalAsync</b> .      ,     ,       digest (   ),      digest-.  , ,   -    listener- , , ,   ,   ,       digest-. <br><br>      ,     ,   <b>$$evalAsync</b> .     ,     <b>Scope</b> : <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue = []; }</code> </pre><br>    <b>$evalAsync</b> ,      : <br><br><pre> <code class="javascript hljs">Scope.prototype.$evalAsync = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.push({<span class="hljs-attr"><span class="hljs-attr">scope</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-attr"><span class="hljs-attr">expression</span></span>: expr}); };</code> </pre><br><blockquote>        scope         (scope-),         . </blockquote><br>  ,      <b>$digest</b> ,    ,      ,   ,  <b>$eval</b> : <br><br><pre> <code class="javascript hljs">Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.length) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> asyncTask = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.shift(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(asyncTask.expression); } dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); };</code> </pre><br>   ,      ,  scope  ,  ‚Äú‚Äù ‚Äî    ,     digest-. <br><br>   ,  <b>$evalAsync</b>  : <br><br> <a href="http://jsbin.com/ilepOwI/1/edit">  JS Bin</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue = []; } Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{}, <span class="hljs-attr"><span class="hljs-attr">valueEq</span></span>: !!valueEq }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$$areEqual = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (valueEq) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isEqual(newValue, oldValue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newValue === oldValue || (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> newValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> oldValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(newValue) &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(oldValue)); } }; Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$areEqual(newValue, oldValue, watch.valueEq)) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = (watch.valueEq ? _.cloneDeep(newValue) : newValue); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.length) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> asyncTask = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.shift(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(asyncTask.expression); } dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); }; Scope.prototype.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr, locals</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expr(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, locals); }; Scope.prototype.$apply = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(expr); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$digest(); } }; Scope.prototype.$evalAsync = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.push({<span class="hljs-attr"><span class="hljs-attr">scope</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-attr"><span class="hljs-attr">expression</span></span>: expr}); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.asyncEvaled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.aValue; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, scope</span></span></span><span class="hljs-function">) </span></span>{ scope.counter++; scope.$evalAsync(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ scope.asyncEvaled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Evaled inside listener: "</span></span>+scope.asyncEvaled); } ); scope.aValue = <span class="hljs-string"><span class="hljs-string">"test"</span></span>; scope.$digest(); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Evaled after digest: "</span></span>+scope.asyncEvaled);</code> </pre><br> : <br><pre>"Evaled inside listener: false"<font></font>
"Evaled after digest: true" </pre><br></div></div><br><h4>   scope </h4><br>  <b>$evalAsync</b>   -,     digest,     .    ,       <b>$evalAsync</b> ,    ,      ¬´ ¬ª,   ,  -   digest. <br><br> <b>$evalAsync</b>  - ,   digest  .     Angular scope  ,  ¬´¬ª,       scope,      ,   . <br><br>    <b>$scope</b>  <b>$$phase</b> ,    <b>null</b> : <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, let's write a couple of functions to control the phase: one for installation, the other for cleaning. </font><font style="vertical-align: inherit;">We also add an additional check that no one is trying to establish a phase without completing the previous one:</font></font><br><br><pre> <code class="javascript hljs">Scope.prototype.$beginPhase = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">phase</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase + <span class="hljs-string"><span class="hljs-string">' already in progress.'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = phase; }; Scope.prototype.$clearPhase = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; };</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ digest</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function, </font><font style="vertical-align: inherit;">set the ‚Äú$ digest‚Äù phase, wrap the digest loop in it:</font></font><br><br><pre> <code class="javascript hljs">Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$beginPhase(<span class="hljs-string"><span class="hljs-string">"$digest"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.length) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> asyncTask = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.shift(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(asyncTask.expression); } dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); };</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">While we are here, let's finalize </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ apply</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at the same time </font><font style="vertical-align: inherit;">so that the phase is also prescribed here. </font><font style="vertical-align: inherit;">This will be useful during the debugging process:</font></font><br><br><pre> <code class="javascript hljs">Scope.prototype.$apply = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$beginPhase(<span class="hljs-string"><span class="hljs-string">"$apply"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(expr); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$digest(); } };</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, you can now schedule a call to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ digest</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ evalAsync</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Here you will need to check the phase, if it is empty (and no asynchronous tasks have yet been scheduled) - we plan to execute </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ digest</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="javascript hljs">Scope.prototype.$evalAsync = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$phase &amp;&amp; !self.$$asyncQueue.length) { setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self.$$asyncQueue.length) { self.$digest(); } }, <span class="hljs-number"><span class="hljs-number">0</span></span>); } self.$$asyncQueue.push({<span class="hljs-attr"><span class="hljs-attr">scope</span></span>: self, <span class="hljs-attr"><span class="hljs-attr">expression</span></span>: expr}); };</code> </pre><br>   ,  <b>$evalAsync</b> ,     ,  digest    ,    ,   : <br><br> <a href="http://jsbin.com/iKeSaGi/1/edit">  JS Bin</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Scope.prototype.$beginPhase = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">phase</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase + <span class="hljs-string"><span class="hljs-string">' already in progress.'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = phase; }; Scope.prototype.$clearPhase = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }; Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{}, <span class="hljs-attr"><span class="hljs-attr">valueEq</span></span>: !!valueEq }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$$areEqual = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (valueEq) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isEqual(newValue, oldValue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newValue === oldValue || (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> newValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> oldValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(newValue) &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(oldValue)); } }; Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$areEqual(newValue, oldValue, watch.valueEq)) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = (watch.valueEq ? _.cloneDeep(newValue) : newValue); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$beginPhase(<span class="hljs-string"><span class="hljs-string">"$digest"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.length) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> asyncTask = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.shift(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(asyncTask.expression); } dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); }; Scope.prototype.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr, locals</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expr(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, locals); }; Scope.prototype.$apply = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$beginPhase(<span class="hljs-string"><span class="hljs-string">"$apply"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(expr); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$digest(); } }; Scope.prototype.$evalAsync = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$phase &amp;&amp; !self.$$asyncQueue.length) { setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self.$$asyncQueue.length) { self.$digest(); } }, <span class="hljs-number"><span class="hljs-number">0</span></span>); } self.$$asyncQueue.push({<span class="hljs-attr"><span class="hljs-attr">scope</span></span>: self, <span class="hljs-attr"><span class="hljs-attr">expression</span></span>: expr}); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.asyncEvaled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; scope.$evalAsync(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ scope.asyncEvaled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Evaled after a while: "</span></span>+scope.asyncEvaled); }, <span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Check after a delay to make sure the digest has had a chance to run.</span></span></code> </pre><br> : <br><pre>"Evaled after a while: true" </pre><br></div></div><br><h4>    digest ‚Äî $$postDigest </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is another way to add your code to the execution stream of a digest loop - using the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$$ postDigest</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The double dollar at the beginning of the function name indicates that this is a deep Angular function that Angular application developers should not use. But it doesn‚Äôt matter to us, we still implement it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Like </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ evalAsync</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$$ postDigest</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> allows </font><b><font style="vertical-align: inherit;">you</font></b><font style="vertical-align: inherit;"> to postpone the launch of some code to ‚Äúlater‚Äù. More specifically, the deferred function will be executed immediately after the next digest is completed. Using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$$ postDigest</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> does not imply the launch of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ digest</font></font></b> ,         ,  -     digest.    , <b>$$postDigest</b> -      digest,     scope  ,   <b>$$postDigest</b> ,     <b>$digest</b>  <b>$apply</b> ,   . <br><br>  ,        <b>Scope</b> ,     <b>$$postDigest</b> : <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre><br> ,   <b>$$postDigest</b> .    ,      : <br><br><pre> <code class="javascript hljs">Scope.prototype.$$postDigest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue.push(fn); };</code> </pre><br>    ,   <b>$digest</b> ,          : <br><br><pre> <code class="javascript hljs">Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$beginPhase(<span class="hljs-string"><span class="hljs-string">"$digest"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.length) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> asyncTask = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.shift(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(asyncTask.expression); } dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue.length) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue.shift()(); } };</code> </pre><br>  ,     <b>$$postDigest</b> : <br><br> <a href="http://jsbin.com/IMEhowO/1/edit">  JS Bin</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Scope.prototype.$beginPhase = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">phase</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase + <span class="hljs-string"><span class="hljs-string">' already in progress.'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = phase; }; Scope.prototype.$clearPhase = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }; Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{}, <span class="hljs-attr"><span class="hljs-attr">valueEq</span></span>: !!valueEq }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$$areEqual = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (valueEq) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isEqual(newValue, oldValue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newValue === oldValue || (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> newValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> oldValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(newValue) &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(oldValue)); } }; Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$areEqual(newValue, oldValue, watch.valueEq)) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = (watch.valueEq ? _.cloneDeep(newValue) : newValue); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$beginPhase(<span class="hljs-string"><span class="hljs-string">"$digest"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.length) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> asyncTask = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.shift(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(asyncTask.expression); } dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue.length) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue.shift()(); } }; Scope.prototype.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr, locals</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expr(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, locals); }; Scope.prototype.$apply = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$beginPhase(<span class="hljs-string"><span class="hljs-string">"$apply"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(expr); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$digest(); } }; Scope.prototype.$evalAsync = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$phase &amp;&amp; !self.$$asyncQueue.length) { setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self.$$asyncQueue.length) { self.$digest(); } }, <span class="hljs-number"><span class="hljs-number">0</span></span>); } self.$$asyncQueue.push({<span class="hljs-attr"><span class="hljs-attr">scope</span></span>: self, <span class="hljs-attr"><span class="hljs-attr">expression</span></span>: expr}); }; Scope.prototype.$$postDigest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue.push(fn); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> postDigestInvoked = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; scope.$$postDigest(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ postDigestInvoked = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.assert(!postDigestInvoked); scope.$digest(); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.assert(postDigestInvoked);</code> </pre><br> : <br><pre> true
 true </pre><br></div></div><br><h4>   </h4><br>    <b>$scope</b>         Angular.     .  ,        . <br><br> Scope-  Angular    :     watch-, <b>$evalAsync</b>   <b>$$postDigest</b> ‚Äî    digest-.            digest. <br><br>     ,         <b>try‚Ä¶catch</b> <br><blockquote>  Angular       $exceptionHandler.     ,          . </blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exception handling for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ evalAsync</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$$ postDigest</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is done in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ digest</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In both cases, the exception is logged, and the digest continues normally:</font></font><br><br><pre> <code class="javascript hljs">Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$beginPhase(<span class="hljs-string"><span class="hljs-string">"$digest"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.length) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> asyncTask = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.shift(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(asyncTask.expression); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { (<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error || <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log)(e); } } dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue.length) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue.shift()(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { (<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error || <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log)(e); } } };</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The exception handling for the watch function is done in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ digestOnce</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="javascript hljs">Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$areEqual(newValue, oldValue, watch.valueEq)) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = (watch.valueEq ? _.cloneDeep(newValue) : newValue); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { (<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error || <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log)(e); } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; };</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now our digest loop is much safer to exceptions: </font></font><br><br> <a href="http://jsbin.com/IMEhowO/2/edit"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JS Bin code</font></font></a> <br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View code</font></font></b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Scope.prototype.$beginPhase = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">phase</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase + <span class="hljs-string"><span class="hljs-string">' already in progress.'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = phase; }; Scope.prototype.$clearPhase = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }; Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{}, <span class="hljs-attr"><span class="hljs-attr">valueEq</span></span>: !!valueEq }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers.push(watcher); }; Scope.prototype.$$areEqual = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (valueEq) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isEqual(newValue, oldValue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newValue === oldValue || (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> newValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> oldValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(newValue) &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(oldValue)); } }; Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$areEqual(newValue, oldValue, watch.valueEq)) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = (watch.valueEq ? _.cloneDeep(newValue) : newValue); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { (<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error || <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log)(e); } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$beginPhase(<span class="hljs-string"><span class="hljs-string">"$digest"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.length) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> asyncTask = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.shift(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(asyncTask.expression); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { (<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error || <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log)(e); } } dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue.length) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue.shift()(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { (<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error || <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log)(e); } } }; Scope.prototype.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr, locals</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expr(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, locals); }; Scope.prototype.$apply = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$beginPhase(<span class="hljs-string"><span class="hljs-string">"$apply"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(expr); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$digest(); } }; Scope.prototype.$evalAsync = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$phase &amp;&amp; !self.$$asyncQueue.length) { setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self.$$asyncQueue.length) { self.$digest(); } }, <span class="hljs-number"><span class="hljs-number">0</span></span>); } self.$$asyncQueue.push({<span class="hljs-attr"><span class="hljs-attr">scope</span></span>: self, <span class="hljs-attr"><span class="hljs-attr">expression</span></span>: expr}); }; Scope.prototype.$$postDigest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue.push(fn); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.aValue = <span class="hljs-string"><span class="hljs-string">"abc"</span></span>; scope.counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; scope.$watch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"Watch fail"</span></span>; }); scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ scope.$evalAsync(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"async fail"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.aValue; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, scope</span></span></span><span class="hljs-function">) </span></span>{ scope.counter++; } ); scope.$digest(); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.assert(scope.counter === <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><br> : <br><pre>"Watch fail"<font></font>
"async fail"<font></font>
"Watch fail"<font></font>
 true </pre><br></div></div><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Disable the observer </font></font></h4><br>  ,   ,  ,        scope-,       .        - ,   ,  scope   . <br><br>  <b>$watch</b>  Angular      ‚Äî ,  ,   .   ,    ,   <b>$watch</b>  ,        <b>$$watchers</b> : <br><br><pre> <code class="javascript hljs">Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn, <span class="hljs-attr"><span class="hljs-attr">valueEq</span></span>: !!valueEq }; self.$$watchers.push(watcher); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> index = self.$$watchers.indexOf(watcher); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (index &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { self.$$watchers.splice(index, <span class="hljs-number"><span class="hljs-number">1</span></span>); } }; };</code> </pre><br>      <b>$watch</b> ,    ,     : <br><br> <a href="http://jsbin.com/IMEhowO/4/edit">  JS Bin</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Scope.prototype.$beginPhase = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">phase</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase + <span class="hljs-string"><span class="hljs-string">' already in progress.'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = phase; }; Scope.prototype.$clearPhase = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$phase = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }; Scope.prototype.$watch = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watchFn, listenerFn, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = { <span class="hljs-attr"><span class="hljs-attr">watchFn</span></span>: watchFn, <span class="hljs-attr"><span class="hljs-attr">listenerFn</span></span>: listenerFn || <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ }, <span class="hljs-attr"><span class="hljs-attr">valueEq</span></span>: !!valueEq }; self.$$watchers.push(watcher); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> index = self.$$watchers.indexOf(watcher); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (index &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { self.$$watchers.splice(index, <span class="hljs-number"><span class="hljs-number">1</span></span>); } }; }; Scope.prototype.$$areEqual = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, valueEq</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (valueEq) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isEqual(newValue, oldValue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newValue === oldValue || (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> newValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> oldValue === <span class="hljs-string"><span class="hljs-string">'number'</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(newValue) &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(oldValue)); } }; Scope.prototype.$$digestOnce = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; _.forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$watchers, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">watch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newValue = watch.watchFn(self); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldValue = watch.last; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$areEqual(newValue, oldValue, watch.valueEq)) { watch.listenerFn(newValue, oldValue, self); dirty = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } watch.last = (watch.valueEq ? _.cloneDeep(newValue) : newValue); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { (<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error || <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log)(e); } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dirty; }; Scope.prototype.$digest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ttl = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dirty; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$beginPhase(<span class="hljs-string"><span class="hljs-string">"$digest"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.length) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> asyncTask = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$asyncQueue.shift(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(asyncTask.expression); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { (<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error || <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log)(e); } } dirty = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$digestOnce(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dirty &amp;&amp; !(ttl--)) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"10 digest iterations reached"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dirty); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue.length) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue.shift()(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { (<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error || <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log)(e); } } }; Scope.prototype.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr, locals</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expr(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, locals); }; Scope.prototype.$apply = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$beginPhase(<span class="hljs-string"><span class="hljs-string">"$apply"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(expr); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$clearPhase(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$digest(); } }; Scope.prototype.$evalAsync = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!self.$$phase &amp;&amp; !self.$$asyncQueue.length) { setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self.$$asyncQueue.length) { self.$digest(); } }, <span class="hljs-number"><span class="hljs-number">0</span></span>); } self.$$asyncQueue.push({<span class="hljs-attr"><span class="hljs-attr">scope</span></span>: self, <span class="hljs-attr"><span class="hljs-attr">expression</span></span>: expr}); }; Scope.prototype.$$postDigest = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$$postDigestQueue.push(fn); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scope(); scope.aValue = <span class="hljs-string"><span class="hljs-string">"abc"</span></span>; scope.counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> removeWatch = scope.$watch( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> scope.aValue; }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newValue, oldValue, scope</span></span></span><span class="hljs-function">) </span></span>{ scope.counter++; } ); scope.$digest(); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.assert(scope.counter === <span class="hljs-number"><span class="hljs-number">1</span></span>); scope.aValue = <span class="hljs-string"><span class="hljs-string">'def'</span></span>; scope.$digest(); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.assert(scope.counter === <span class="hljs-number"><span class="hljs-number">2</span></span>); removeWatch(); scope.aValue = <span class="hljs-string"><span class="hljs-string">'ghi'</span></span>; scope.$digest(); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.assert(scope.counter === <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-comment"><span class="hljs-comment">// No longer incrementing</span></span></code> </pre><br> : <br><pre> true
 true
 true </pre><br></div></div><br><h4>  What's next </h4><br>    ,     scope-,    Angular.   scope-  Angular ‚Äî  ,  ,    . <br><br>    ,  scope  Angular,     . , scope-    scope-,          scope,    ,      scope-.  ,     ‚Äî     .      (scope)       . <br><br>       ,     <b>Scope</b> . <br><br>  <b>From the translator:</b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The text is quite large, I think there are errors and typos. </font><font style="vertical-align: inherit;">Send them in a personal - I'll fix everything. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If someone knows how to select lines in the code in Habr√© - say, this will improve the readability of the code.</font></font></div><p>Source: <a href="https://habr.com/ru/post/201832/">https://habr.com/ru/post/201832/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../201820/index.html">Ciklum Speakers' Corner with Ahmed Sidki for the first time in Kiev on November 27</a></li>
<li><a href="../201824/index.html">Ciklum Kiev Java Saturday with guests from England and unusual completion of the presentation program</a></li>
<li><a href="../201826/index.html">Asynchrony: back to the future</a></li>
<li><a href="../201828/index.html">jor1k: Linux in a web-enabled browser</a></li>
<li><a href="../201830/index.html">Power of Community: New Attack Scenarios for PCS or Choo Choo PWN in Korea</a></li>
<li><a href="../201834/index.html">A Tale of the Present PRINTRBOT (Part 3: Trial by Fire)</a></li>
<li><a href="../201836/index.html">PDF generation from a WPF application ‚Äúfor everyone, for nothing, and let no one leave offended‚Äù</a></li>
<li><a href="../201838/index.html">Updates and plans</a></li>
<li><a href="../201840/index.html">CRON in the cloud: the complete guide to the new Windows Azure Scheduler task scheduler service</a></li>
<li><a href="../201844/index.html">Microsoft released a set of updates, November 2013</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>