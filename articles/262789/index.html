<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New DNS Server Features in Windows Server Technical Preview 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The author of the article is Andrey Kaptelin, a member of the IT community. 
 With the release of Windows Server Technical Preview 2, many services ha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New DNS Server Features in Windows Server Technical Preview 2</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  The author of the article is Andrey Kaptelin, a member of the IT community. </blockquote><br>  With the release of Windows Server Technical Preview 2, many services have received updates.  Not bypassed the party and honored DNS name server.  In addition to supporting DNS server management from PowerShell, there is a new feature - DNS policy. <br><br>  DNS policy is an extension of the DNS server to adapt its work depending on the content of incoming requests.  Due to the first application of policies on an incoming request, it is possible to significantly simplify the operation of the server, eliminating obviously unnecessary requests, or by specifying the server, change the content of the response in accordance with the described rules. <a name="habracut"></a><br><br><br><h1>  Principle of operation </h1><br>  Policies apply to three categories of requests: <br><ul><li>  <b>Request permission to write</b> .  All usual name resolution requests to an IP address, or getting TXT, MX, and SRV record values. </li><li>  <b>Request to transfer zones</b> .  Requests from your secondary servers to update zone information.  If such a request is made for a foreign server, it will receive all the contents of your zone. </li><li>  <b>The query for which you want to perform a recursive query</b> .  For example, a customer has requested a name that is not in your zones.  The server must re-ask the upstream server to get the result.  For external clients, it is not always necessary to process such requests. </li></ul><br>  The scope of the policy can be, both on the entire server and on a specific zone, if this zone is not integrated into Active Directory. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      DNS server policies allow you to implement the following actions: <br><ul><li>  Create a zone with a different set of records. </li><li>  Classify the client by its IP address and use it in the policy application rules. </li><li>  Apply policies for the entire server and for zones that are not integrated into AD. </li><li>  Apply different policies depending on the interface that received the request. </li><li>  Apply policies depending on the time of day. </li><li>  Apply policies by type of records requested. </li><li>  Responding to requests for data from different versions of a zone in given proportions is similar to a managed Round Robin. </li><li>  Apply policies to forward zones. </li><li>  Apply the required filter policy if you need to perform a recursion to complete the request. </li><li>  Put the policies in the right order of processing. </li></ul><br>  All created policies are saved in the registry in the following sections: <br><br>  Specified subnets used in policy enforcement rules are stored in the registry key. <br><pre><code class="javascript hljs">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\DNS Server\ClientSubnets</code> </pre> <br>  Policies applied to the server are stored in the registry key. <br><pre> <code class="javascript hljs">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\DNS Server\Policies</code> </pre> <br>  Policies applied to a specific zone are stored in the registry key. <br><pre> <code class="javascript hljs">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\DNS Server\Zones\{ }\Policies</code> </pre> <br>  Zones used in recursive query rules are stored in the registry key. <br><pre> <code class="javascript hljs">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\DNS\Parameters\ServerScopes</code> </pre> <br>  The value of the recursion state for the entire server (the zone is ".") Is stored in the <br><pre> <code class="javascript hljs">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\DNS\Parameters</code> </pre> <br>  The key <i>NoRecursion</i> is ‚Äú0‚Äù - recursion is enabled, ‚Äú1‚Äù is disabled.  Switching from on to off requires a restart of the DNS server service. <br><br>  If an alternative content ( <b>Add-DnsServerZoneScope</b> ) is created for a zone, it is placed in a file located in <br>  <b>C: \ Windows \ System32 \ dns \ {zone name}</b> <br>  And the configuration is written to the registry. <br><pre> <code class="javascript hljs">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\DNS Server\Zones\{_}\ZoneScopes\</code> </pre> <br>  If you delete an alternative version of a zone, the registry entry is deleted, and the alternative content file remains in place. <br><br>  Despite the abundance of settings locations, several PowerShell commands are enough to change them. <br><br>  To work with write permission and recursive query query policies: <br>  <b>Add-DnsServerQueryResolutionPolicy</b> <br>  <b>Get-DnsServerQueryResolutionPolicy</b> <br>  <b>Set-DnsServerQueryResolutionPolicy</b> <br>  <b>Remove-DnsServerQueryResolutionPolicy</b> <br><br>  To work with requests for zone transfer: <br>  <b>Add-DnsServerZoneTransferPolicy</b> <br>  <b>Get-DnsServerZoneTransferPolicy</b> <br>  <b>Set-DnsServerZoneTransferPolicy</b> <br>  <b>Remove-DnsServerZoneTransferPolicy</b> <br><br>  The steps to perform policies can be as follows: <br>  <b>-Action ALLOW</b> - the query is performed by the DNS server <br>  <b>-Action DENY</b> - the DNS server refuses <br>  <b>-Action IGNORE</b> - the request is not processed by the DNS server <br><br>  To understand the stages of policy processing, we have the following request flow diagrams. <br><br>  The scheme for processing write permission requests and recursive queries: <br><br><img src="https://habrastorage.org/files/b79/236/ce9/b79236ce964e4e009200c43b568a7355.png"><br><br>  The processing of requests for transfer of zones: <br><br><img src="https://habrastorage.org/files/e00/0f9/4ae/e000f94ae4c44a8e99e24e7a9d9fd3cb.png"><br><br><h1>  Examples </h1><br><h3>  Setting Restricting Recursive Queries </h3><br>  There is a task to configure the DNS server to perform recursive queries only for internal clients.  The server has two network interfaces.  The external IP address is 1.1.1.1, the internal interface has an IP address 10.0.0.39.  You can accomplish this task by limiting the execution of such requests to the internal interface only.  To do this, recursive queries at the server level should be disabled and allowed only for requests received by the internal interface. <br><pre> <code class="javascript hljs">#     ¬´.¬ª - ..    <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>-DnsServerRecursionScope -Name . -EnableRecursion $False #           Add-DnsServerRecursionScope -Name <span class="hljs-string"><span class="hljs-string">"InternalClients"</span></span> -EnableRecursion $True #  ,    Add-DnsServerQueryResolutionPolicy -Name <span class="hljs-string"><span class="hljs-string">"SplitBrainRecursionPolicy"</span></span> -Action ALLOW -ApplyOnRecursion -RecursionScope <span class="hljs-string"><span class="hljs-string">"InternalClients"</span></span> -ServerInterfaceIP <span class="hljs-string"><span class="hljs-string">"EQ,10.0.0.39"</span></span></code> </pre><br>  We will analyze the policy creation team in more detail. <br>  <b>Add-DnsServerQueryResolutionPolicy</b> is a cmdlet for creating a policy for processing requests for resolving records and recursive queries. <br>  <b>-Name "SplitBrainRecursionPolicy"</b> - the name of the policy <br>  <b>-Action ALLOW</b> - policy action - execute request <br>  <b>-ApplyOnRecursion</b> - the policy only processes requests for which you need to perform a recursive query <br>  <b>-RecursionScope "InternalClients</b> - gets the value of enabling or <b>disabling</b> recursion of a previously specified area <br>  <b>-ServerInterfaceIP ‚ÄûEQ, 10.0.0.39‚Äú</b> - the rule of applying the policy - only a request that came to the server interface with an IPv4-address equal to 10.0.0.39. <br><br><h3>  Modifying the response to the name resolution request </h3><br>  The company has a fault-tolerant web server hosted at two sites - in Europe and in Australia.  The speed of both sites is always the same, but at night the cost of rent is less.  The company decided to use the site depending on the time of day.  To do this, it was decided to distribute customer requests as a percentage of 80/20 at night and day data center. <br><pre> <code class="javascript hljs">#        Add-DnsServerZoneScope -ZoneName <span class="hljs-string"><span class="hljs-string">"testzone.z"</span></span> -Name <span class="hljs-string"><span class="hljs-string">"EuropeDC"</span></span> Add-DnsServerZoneScope -ZoneName <span class="hljs-string"><span class="hljs-string">"testzone.z"</span></span> -Name <span class="hljs-string"><span class="hljs-string">"AustralianDC"</span></span> #    -         Add-DnsServerResourceRecord -ZoneName <span class="hljs-string"><span class="hljs-string">"testzone.z"</span></span> -A -Name <span class="hljs-string"><span class="hljs-string">"www"</span></span> -IPv4Address <span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> -ZoneScope <span class="hljs-string"><span class="hljs-string">"EuropeDC"</span></span> Add-DnsServerResourceRecord -ZoneName <span class="hljs-string"><span class="hljs-string">"testzne.oz"</span></span> -A -Name <span class="hljs-string"><span class="hljs-string">"www"</span></span> -IPv4Address <span class="hljs-string"><span class="hljs-string">"2.2.2.2"</span></span> -ZoneScope <span class="hljs-string"><span class="hljs-string">"AustralianDC"</span></span> #        Add-DnsServerQueryResolutionPolicy -Name <span class="hljs-string"><span class="hljs-string">"www-6-18"</span></span> -Action ALLOW -ZoneScope <span class="hljs-string"><span class="hljs-string">"AustralianDC,4;EuropeDC,1"</span></span> ‚ÄìTimeOfDay ‚ÄúEQ,<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>‚Äù -ZoneName <span class="hljs-string"><span class="hljs-string">"testzone.z"</span></span> ‚ÄìProcessingOrder <span class="hljs-number"><span class="hljs-number">1</span></span> Add-DnsServerQueryResolutionPolicy -Name <span class="hljs-string"><span class="hljs-string">"www-0-6"</span></span> -Action ALLOW -ZoneScope <span class="hljs-string"><span class="hljs-string">"AustralianDC,1;EuropeDC,4"</span></span> ‚ÄìTimeOfDay ‚ÄúEQ,<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-number"><span class="hljs-number">-06</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>‚Äù -ZoneName <span class="hljs-string"><span class="hljs-string">"testzone.z"</span></span> ‚ÄìProcessingOrder <span class="hljs-number"><span class="hljs-number">2</span></span> Add-DnsServerQueryResolutionPolicy -Name <span class="hljs-string"><span class="hljs-string">"www-18-24"</span></span> -Action ALLOW -ZoneScope <span class="hljs-string"><span class="hljs-string">"AustralianDC,1;EuropeDC,4"</span></span> ‚ÄìTimeOfDay ‚ÄúEQ,<span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-number"><span class="hljs-number">-23</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>‚Äù -ZoneName <span class="hljs-string"><span class="hljs-string">"testzone.z"</span></span> ‚ÄìProcessingOrder <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br>  We will analyze the policy creation team in more detail. <br>  <b>Add-DnsServerQueryResolutionPolicy</b> - policy creation cmdlet <br>  <b>-Name "www-6-18"</b> - policy name <br>  <b>-Action ALLOW</b> - policy action - execute request <br>  <b>-ZoneScope ‚ÄûAustralianDC, 4; EuropeDC, 1‚Äú</b> - tells the policy to use two versions of the zone in 4 to 1 proportions, obtaining the required ratio of 80% to 20% in outputting data from the zone version for Europe and Australia <br>  <b>‚ÄìTimeOfDay ‚ÄúEQ, 06: 00-18: 00‚Äù</b> - Policy Duration <br>  <b>-ZoneName "testzone.z"</b> - the name of the zone for which the policy is valid <br>  <b>‚ÄìProcessingOrder 1</b> - the order of policy application for the policies of this zone <br><br><h3>  Limiting Zone Transfer Requests </h3><br>  The company has a primary DNS server for external zones and two secondary DNS servers hosted by different providers.  It is not possible to prohibit a firewall from accessing the main server using TCP protocol on port 53, since  zones have entries larger than the UDP packet size.  It was decided to use DNS policy for these purposes. <br><pre> <code class="javascript hljs">#      DNS- Add-DnsServerClientSubnet -Name <span class="hljs-string"><span class="hljs-string">"DNSsecondary1"</span></span> -IPv4Subnet <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> Add-DnsServerClientSubnet -Name <span class="hljs-string"><span class="hljs-string">"DNSsecondary2"</span></span> -IPv4Subnet <span class="hljs-number"><span class="hljs-number">5.5</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> #        Add-DnsServerZoneTransferPolicy -Name <span class="hljs-string"><span class="hljs-string">"Allow secondary DNS"</span></span> -ZoneName <span class="hljs-string"><span class="hljs-string">"testzone.z"</span></span> -Action IGNORE -ClientSubnet <span class="hljs-string"><span class="hljs-string">"ne,DNSsecondary1,DNSsecondary2"</span></span></code> </pre><br>  We will analyze the policy creation team in more detail. <br>  <b>Add-DnsServerZoneTransferPolicy</b> - create zone transfer request policy cmdlet <br>  <b>-Name "Allow secondary DNS"</b> - the name of the policy <br>  <b>-ZoneName "testzone.z"</b> - the name of the zone for which the policy will apply <br>  <b>-Action IGNORE</b> - Policy Action <br>  <b>-ClientSubnet "ne, DNSsecondary1, DNSsecondary2"</b> - the condition of use for all but our servers <br><br>  As you can see, to solve many problems, you can now use the DNS policy.  Having correctly described the rules for passing requests to the DNS server, you can not only optimize the services, but also reduce the load on the DNS server by filtering out unnecessary requests. <br><br><h1>  Related Links </h1><br>  <a href="https://technet.microsoft.com/en-US/library/mt169379.aspx">DNS Policies Overview</a> <br>  <a href="http://blogs.technet.com/b/askpfeplat/archive/2015/07/13/dns-policies-coming-in-windows-server-2016.aspx">Windows Networking Team [MSFT] Blog Articles</a> <a href="http://blogs.technet.com/b/askpfeplat/archive/2015/07/13/dns-policies-coming-in-windows-server-2016.aspx"><br></a> </div><p>Source: <a href="https://habr.com/ru/post/262789/">https://habr.com/ru/post/262789/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262775/index.html">South Korean chief intelligence officer: 35 intelligence agencies bought spyware from Hacking Team</a></li>
<li><a href="../262777/index.html">The next version of the browser Vivaldi TP4 is ready</a></li>
<li><a href="../262779/index.html">Why Go and Rust are not rivals</a></li>
<li><a href="../262781/index.html">"Moore's Law" at Risk - Intel Delays New Chips</a></li>
<li><a href="../262785/index.html">Breaking ETL Barriers With Spark Streaming by Concur. Meeting report</a></li>
<li><a href="../262791/index.html">Making the code cleaner: Nuances of debugging output in Linux drivers</a></li>
<li><a href="../262793/index.html">Tax gopher. Features of the simplified tax system when working under contracts with Apple, Google and others</a></li>
<li><a href="../262795/index.html">Are developers of a programming conference needed?</a></li>
<li><a href="../262797/index.html">Video of reports from the conference "Russian Internet Technologies 2015"</a></li>
<li><a href="../262801/index.html">Magic of tensor algebra: Part 9 - Derivation of the angular velocity tensor through the parameters of the final rotation. Apply Maxima</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>