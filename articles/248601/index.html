<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lovers of Ruby and Coffeescript - another bike?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have always been attracted to responsive, dynamic interfaces created in Javascript, but every time I tried to immerse myself in learning this langua...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Lovers of Ruby and Coffeescript - another bike?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/e29/6c2/2e4/e296c22e4e374ed59b25c4b0ea89e970.jpg" alt="image"><br><br>  I have always been attracted to responsive, dynamic interfaces created in Javascript, but every time I tried to immerse myself in learning this language, I turned my brain into a mess and <strike>ate it</strike> left for ‚Äúbetter‚Äù times, returning to static pages on the client and PHP on the server .  As time went. <br><br>  A year ago, stumbling through the pages of the network, I came across an article about Coffeescript.  Hmm, interesting ... Couples of code samples were enough to get the idea to apply it somewhere, but something bothered me - I wanted some kind of framework that would take care of compiling coffee in js myself.  So I found Rails, and with it ruby, gems, sass, and a bunch of things that brought me into <strike>ecstasy, the</strike> critical point of no return ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Good day, gentlemen!  My name is Denis, and in this article I want to share with you my views on the development of the front-end and a small history of the invention of one bicycle, but you can judge whether it is next or not. <br><a name="habracut"></a><br>  Why the invention of the bicycle?  Probably because no one has ever taught me programming and methods of learning languages, and the desire to ‚Äúget behind the wheel‚Äù always triumphs over the desire to ‚Äúget rights‚Äù, given the absence of a direct threat to the life and health of developers at the oncoming ‚Äúcounter‚Äù with the slogan - "we will understand on the way." <br><br>  By myself knowing that only by practice, by typing and googleing, I manage to learn the theory and understand in general what I started to develop, namely to create a Javascript MVC framework the way I see it, and by passing the languages ‚Äã‚ÄãI need for it. <br><br><h2>  Dreams come true, fairy tales come true <br></h2><br>  Since Javascript is a prototype-oriented language, I decided to abandon the class-oriented approach and master the power of the prototypes. <br><br>  Long thinking about the intricacies of the implementation of the client side, I came to the following conclusions: <br><br><ul><li>  each request to the application is a work with a certain collection of models, which ends with the display of the necessary representation of the form of these models on the page; <br></li><li>  the controller in its action must have a ready-made, selected collection of models and parameters for its work; <br></li><li>  Collections are sets of models filtered by certain parameters, constantly maintaining their set up to date; <br></li><li>  models are closely related to the species, all changes to the model should immediately be displayed in the view of the species; <br></li><li>  a view is an object that knows how to draw a template into the html representation in accordance with the parameters of its model, as well as where to show it, besides this, each piece of html page code must belong to some type; <br></li><li>  view is a view template drawn in html-code, intended for display on the page and user interaction; <br></li><li>  the user interacts with the views through views, views with models, and vice versa - models with views, views through views with the user. <br></li></ul><br>  After my thoughts, I began to develop and started it with the implementation of <strong>models</strong> .  Inspired by the capabilities of the ActiveRecord models, I tried to make client models similar to them.  As a result, validations, callbacks, relationships to, has one, has many, has one through, has many through, search methods, as well as creating, updating, deleting and saving to the server and many other things were implemented. <br><br>  I gave the <strong>views the</strong> ability to monitor the state of the models and respond quickly to their changes, created templates for them with preliminary compilation on the server, gave them a small client template engine and taught to redraw not completely, but only in those places (nodes) where it is necessary, depending on the state of models, their collections, or other elements of the system capable of generating change events.  In addition to the above, the binding of these form fields to model properties, direct calling of view methods or its model when clicking on a link or sending a form, as well as wrapping views of views into layouts was implemented. <br><br>  I tried to make the <strong>collections</strong> look like ordinary arrays with extended functionality for working with models, added in them the possibilities of sorting, filtering models and proxying their methods. <br><br>  I implemented the <strong>controllers</strong> so that the names of their actions are at the same time routes with the selection parameters of the displayed models, and also added the ability to define before and after filters. <br><br>  In addition to the above, a small object was created to work with cookies, another one that is responsible for working with the server via Websockets and a router for routing requests to controller actions using the Browser's History API.  To work with the DOM, the small <a href="https://github.com/kupriyanenko/jbone">jBone</a> library <a href="https://github.com/kupriyanenko/jbone">fits perfectly</a> .  Inside, of course, everything is maximally implemented by native means, it is used only for associating view methods with DOM events and for further developer convenience, if necessary, can be easily replaced with the beloved jQuery, since  has a similar syntax. <br><br>  As time went on, the basic client-side functionality was implemented, but I didn‚Äôt like the server room anymore - Rails did not suit me, well, it wasn‚Äôt for that, it needed something of its own ... <br><br>  Coffee, google, habr, articles, google - <strong>Sinatra</strong> !  What you need!  Add here sinarta-websockets, sprockets, active-record, thin, pinch of pepper settings, a bit of magic, mix thoroughly, dance with a tambourine and voila - your own synchronization server. <br><br>  Without thinking for a long time, I decided to pack this into a ruby ‚Äã‚Äãgem, I found an article here, a couple of trial attempts, and here it is <strong>nali-0.0.1.gem</strong> . <br><br>  Even at the stage of creating a heme, the idea arose of adding a generator of a new application to it, as well as models and types, which was immediately implemented. <br><br>  And a little later, I developed: <br><br><ul><li>  browser tab recognition system on the server, which allows you to find out, for example, which of the connected clients are different browsers, and which tabs are the same; <br></li><li>  the system of client access rights to model properties, which allows to easily break clients into groups by roles and strictly specify each interaction parameter; <br></li><li>  a model synchronization system that allows you to synchronize a model with dependent models, track customers following the model and promptly inform them about all its movements; <br></li><li>  a system of model selectors that allows you to easily download the necessary models to the client; <br></li><li>  the possibility of calling methods from the client on the server, and vice versa, from the server on the client with data transfer; <br></li><li>  a notification model that allows you to easily set up user notification with informational messages, launching them both from the client and from the server side. <br></li><li>  and much more‚Ä¶ <br></li></ul><br>  The more the framework began to look like something independent and complete, the more I was filled with pride for the work done and the desire to share it with the public.  For this, a repository was created on <a href="https://github.com/4urbanoff/nali">Github</a> , and documentation was published in the <a href="https://github.com/4urbanoff/nali/wiki">Wiki</a> section, and this article became the cry of the soul. <br><br><h2>  What is the result? <br></h2><br>  And in my opinion, it turned out to be a rather interesting thing that allows you to quickly, with the help of several console commands, deploy a working environment and start writing code, for example <br><br><pre><code class="hljs smalltalk"><span class="hljs-string"><span class="hljs-string">$ </span></span>gem install nali #  <span class="hljs-type"><span class="hljs-type">Nali</span></span>   <span class="hljs-string"><span class="hljs-string">$ </span></span>nali new gallery &amp;&amp; cd gallery #          <span class="hljs-string"><span class="hljs-string">$ </span></span>bundle install #   <span class="hljs-string"><span class="hljs-string">$ </span></span>bundle exec thin start #  - thin</code> </pre> <br>  After that, you can open the browser, go to <a href="http://localhost:3000/">http: // localhost: 3000 /</a> and see the first prepared <strong>Welcome to Nali page</strong> . <br><br>  The structure of the created files and directories is described in the <a href="https://github.com/4urbanoff/nali/wiki/%25D0%25A1%25D1%2582%25D1%2580%25D1%2583%25D0%25BA%25D1%2582%25D1%2583%25D1%2580%25D0%25B0-%25D0%25BF%25D1%2580%25D0%25B8%25D0%25BB%25D0%25BE%25D0%25B6%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F">documentation</a> , all application files are clearly divided into client and server.  A built-in generator makes it easy to generate new models, controllers and views, for example the following command <br><br><pre> <code class="hljs ruby">$ nali model Photo</code> </pre><br>  create client and server files of model and control controller <br><br><ul><li>  <em>app / client / javascript / models / photo.js.coffee</em> - client model <br></li><li>  <em>app / client / javascript / controllers / photos.js.coffee</em> - client controller <br></li><li>  <em>app / server / models / photo.rb</em> - server model <br></li><li>  <em>app / server / controllers / photos_controller.rb</em> - server controller <br></li></ul><br>  and also changes the <em>app / server / models / access.yml file</em> , adding to it a preset for setting client access levels to the model properties. <br><br><h3>  Consider the client controller <br></h3><br>  After generation, its code looks like this. <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># app/client/javascripts/controllers/photos.js.coffee Nali.Controller.extend Photos: actions: {}</span></span></code> </pre><br>  We define in it a method showing photos of a certain album. <br><br><pre> <code class="hljs kotlin">Nali.Controller.extend Photos: actions: before: # -,  <span class="hljs-meta"><span class="hljs-meta">@stop</span></span>  <span class="hljs-meta"><span class="hljs-meta">@redirect</span></span>   #    preview: -&gt; #    ,    <span class="hljs-meta"><span class="hljs-meta">@redirect</span></span> <span class="hljs-string"><span class="hljs-string">'home'</span></span> unless <span class="hljs-meta"><span class="hljs-meta">@collection</span></span>.length # <span class="hljs-meta"><span class="hljs-meta">@collection</span></span> -   ,   album_id <span class="hljs-string"><span class="hljs-string">'preview/album_id'</span></span>: -&gt; # preview -  , album_id -     <span class="hljs-meta"><span class="hljs-meta">@Model</span></span>.Photo.select album: id: <span class="hljs-meta"><span class="hljs-meta">@filters</span></span>.album_id #      <span class="hljs-meta"><span class="hljs-meta">@collection</span></span>.order <span class="hljs-keyword"><span class="hljs-keyword">by</span></span>: <span class="hljs-string"><span class="hljs-string">'created'</span></span>, desc: <span class="hljs-literal"><span class="hljs-literal">true</span></span> #        </code> </pre><br>  What have we written here? <br><br><ul><li>  First, we defined a router with a new <em>preview / album_id route</em> , which is the same as <em>/ photos / preview / 1</em> , where <em>1</em> is the album id, and <em>preview</em> is an action and at the same time the name of the type that the collection models should display; <br></li><li>  secondly, we defined a before-filter that runs before the action itself and, if the collection of selected photos is empty, will interrupt the further execution of the request and send the router to the home page; <br></li><li>  thirdly, in the action itself, we determined the sorting order of photos and sent a request to the server to receive them. <br></li></ul><br>  After performing the action, the controller will give the collection a command to display the <em>preview</em> view. <br><br><h3>  Server controller <br></h3><br>  Its code after generation looks like this <br><br><pre> <code class="hljs pgsql"># app/<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>/controllers/photos_controller.rb <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhotosController &lt; ApplicationController <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> Nali::Controller <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  In it we need to implement a selector for fetching photos of the album. <br><br><pre> <code class="hljs vbscript"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> PhotosController &lt; ApplicationController include Nali::Controller before_only :album <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> check_album <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> #     album     selector :album <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> @album.photos <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> #         <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> def check_album <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> unless @album = Album.find_by_id( params[ :id ] ) #  <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span>   ,      <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  In the body of the selector, we just need to return the collection of models, Nali takes over their synchronization with the client. <br><br>  The <strong>Nali :: Controller</strong> module extends the controller class with its own methods, here are some <br><br><ul><li>  <em>params</em> - a hash of parameters received from the client <br></li><li>  <em>client</em> - current client <br></li><li>  <em>clients</em> - a list of all <em>clients</em> connected to the server <br></li></ul><br><h3>  Client model <br></h3><br>  Its preparation, as well as the others, looks minimal. <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># app/client/javascripts/models/photo.js.coffee Nali.Model.extend Photo: attributes: {}</span></span></code> </pre><br>  Add the necessary attributes, validations, links and callbacks. <br><br><pre> <code class="hljs rust">Nali.Model.extend Photo: belongsTo: [ <span class="hljs-symbol"><span class="hljs-symbol">'user</span></span>', <span class="hljs-symbol"><span class="hljs-symbol">'album</span></span>' ] #    -    hasMany: [ <span class="hljs-symbol"><span class="hljs-symbol">'comments</span></span>' #  commentators: through: <span class="hljs-symbol"><span class="hljs-symbol">'comments</span></span>', key: <span class="hljs-symbol"><span class="hljs-symbol">'user</span></span>' # - <span class="hljs-string"><span class="hljs-string">""</span></span>  ] attributes: user_id: presence: <span class="hljs-literal"><span class="hljs-literal">true</span></span> format: <span class="hljs-symbol"><span class="hljs-symbol">'number</span></span>' #  ,  album_id: presence: <span class="hljs-literal"><span class="hljs-literal">true</span></span> format: <span class="hljs-symbol"><span class="hljs-symbol">'number</span></span>' #  ,  name: presence: <span class="hljs-literal"><span class="hljs-literal">true</span></span> length: <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: [<span class="hljs-number"><span class="hljs-number">5</span></span>..<span class="hljs-number"><span class="hljs-number">50</span></span>] #  ,   <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">50</span></span>  format: presence: <span class="hljs-literal"><span class="hljs-literal">true</span></span> inclusion: [ <span class="hljs-symbol"><span class="hljs-symbol">'jpg</span></span>', <span class="hljs-symbol"><span class="hljs-symbol">'gif</span></span>', <span class="hljs-symbol"><span class="hljs-symbol">'png</span></span>' ] #  ,       onCreate: -&gt; #      onUpdate: ( changed ) -&gt; #      # changed -    onUpdateName: -&gt; #     name onDestroy: -&gt; #    </code> </pre><br>  Immediately give some examples of working with models <br><br><pre> <code class="hljs pgsql">photo = Nali.Model.Photo.<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> user_id: <span class="hljs-number"><span class="hljs-number">1</span></span>, album_id: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>: <span class="hljs-string"><span class="hljs-string">'jpg'</span></span> #    photo.save() #    photo = Nali.Model.Photo.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> user_id: <span class="hljs-number"><span class="hljs-number">1</span></span>, album_id: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>: <span class="hljs-string"><span class="hljs-string">'jpg'</span></span> #        photo.<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'test_update_name'</span></span> #    photo.save() #    photo.upgrade <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'test_upgrade_name'</span></span> #        photo.remove() #     photo.destroy() #    ,    Nali.Model.Photo.find <span class="hljs-number"><span class="hljs-number">1</span></span> #    id == <span class="hljs-number"><span class="hljs-number">1</span></span> Nali.Model.Photo.<span class="hljs-keyword"><span class="hljs-keyword">where</span></span> id: [<span class="hljs-number"><span class="hljs-number">1.</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>], <span class="hljs-type"><span class="hljs-type">name</span></span>: /test/ #     id  <span class="hljs-number"><span class="hljs-number">1</span></span>  <span class="hljs-number"><span class="hljs-number">10</span></span>   "test"   Nali.Model.Photo.<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>() #    </code> </pre><br><h3>  Server model <br></h3><br>  To connect the model with the database, it is necessary to create an appropriate table, this can be done using migrations.  You can create a migration with the command <br><br><pre> <code class="hljs pgsql">$ bundle exec rake db:create_migration <span class="hljs-type"><span class="hljs-type">NAME</span></span>=create_photos</code> </pre><br>  As a result, we get the file <br><br><pre> <code class="hljs pgsql"># db/migrate/<span class="hljs-number"><span class="hljs-number">20150119080311</span></span>_create_photos.rb <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CreatePhotos &lt; ActiveRecord::Migration def change <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  in which you need to add the code that creates the table <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CreatePhotos &lt; ActiveRecord::Migration def change create_table :photos <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> |t| t.belongs_to :<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> #   t.belongs_to :album #   t.string :<span class="hljs-type"><span class="hljs-type">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span> #   t.string :<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> #  <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Then you need to start the migration command <br><br><pre> <code class="hljs perl">$ bundle <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> rake db:migrate</code> </pre><br>  Now you can begin to configure the server model by opening its file, we will see <br><br><pre> <code class="hljs pgsql"># app/<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>/models/photo.rb <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Photo &lt; ActiveRecord::Base <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> Nali::Model def access_level( client ) :<span class="hljs-type"><span class="hljs-type">unknown</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  This is the usual <strong>ActiveRecord</strong> model, extended by the <strong>Nali :: Model</strong> module, which adds several methods to it, some of which are: <br><br><ul><li>  <strong>sync (* watches)</strong> - synchronizes the model with all clients following it, plus those that are passed as arguments; <br></li><li>  <strong>call_method (name, params)</strong> - calls the <strong>name</strong> method with <strong>params</strong> parameters in all of its client copies; <br></li><li>  <strong>clients</strong> - returns an array of all clients connected to the server. <br></li></ul><br>  The <strong>access_level</strong> method <strong>is</strong> special, it is called by the model at the time of the attempt of a client to create, update, read, or delete it.  The object of this client is passed as an argument.  In the body of this method, you need to implement a mechanism, the essence of which is to determine the attitude of the client to the model and ‚Äútell‚Äù who it is - ‚Äúmaster‚Äù, ‚Äúmy host‚Äôs friend‚Äù or ‚ÄúI don‚Äôt know him‚Äù (or something else). ).  We realize it <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Photo &lt; ActiveRecord::Base <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> Nali::Model #  belongs_to :<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> belongs_to :album has_many :comments has_many :commentators, through: :comments, source: :<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> #  validates :user_id, numericality: { only_integer: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } validates :album_id, numericality: { only_integer: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } validates :<span class="hljs-type"><span class="hljs-type">name</span></span>, length: { <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: <span class="hljs-number"><span class="hljs-number">5.</span></span><span class="hljs-number"><span class="hljs-number">.50</span></span> } validates :<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>, inclusion: { <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: %w(jpg gif png) } #   def access_level( client ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">owner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> client[ :<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> ] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> self.<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> == client[ :<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> ] #   <span class="hljs-keyword"><span class="hljs-keyword">owner</span></span> (),       <span class="hljs-keyword"><span class="hljs-keyword">User</span></span> (, # ,   )       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> :commentator <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> client[ :<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> ] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> self.commentators.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?( client[ :<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> ] ) #   commentator (),       <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, #          :<span class="hljs-type"><span class="hljs-type">unknown</span></span> #  ,      <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Why do we need it?  We need this in order to determine which clients can create / receive / update / delete a model and with which properties and which cannot.  Open the file <em>app / server / models / access.yml</em> , here the generator has already prepared a pig for us <br><br><pre> <code class="hljs sql">Photo: <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">read</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>: destroy:</code> </pre><br>  In it, we need to define access parameters <br><br><pre> <code class="hljs sql">Photo: <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>: owner: [ user_id, album_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> ] <span class="hljs-keyword"><span class="hljs-keyword">read</span></span>: owner: [ user_id, album, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>, comments ] commentator: [ +owner ] <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>: owner: [ <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> ] destroy: owner:</code> </pre><br>  And now in order: <br><br><ul><li>  In the <strong>create</strong> section, we determined that creating a photo, or rather saving the client model to the server by calling <strong>new</strong> then <strong>save</strong> or immediately <strong>create,</strong> can only be a client with an <strong>owner</strong> level.  The list <em>[user_id, album_id, name, format]</em> defines the fields to be taken to create the model; <br></li><li>  In the <strong>read</strong> section, we determined that only owners and commentators can retrieve the model from the server, the <em>[user_id, album, name, format, comments]</em> list defines the properties to be received.  The sync feature is that if the property returns a model or models, they will also be synchronized with the client, moreover, if the model is a <em>belongs_to</em> connection, then the key for the connection will be automatically transferred, i.e.  the owner will receive an album model, models of all comments, and the model of the photo itself with fields <em>[user_id, album_id, name, format]</em> .  Another feature is mixing access levels, i.e.  if the commentators have the same synchronization parameters as the owners, then you do not need to ‚Äúcopy-paste‚Äù them, you just need to add them like this <em>[+ owner]</em> ; <br></li><li>  In the <strong>update</strong> section, we determined that only the owners (by calling <strong>update</strong> on the client, then <strong>save</strong> or immediately <strong>upgrade</strong> ) can change the properties of the model while being saved on the server, and only the <strong>name</strong> property can be saved; <br></li><li>  In the <strong>destroy</strong> section, we indicated that only the owner can delete a photo from the server by calling the <strong>destroy</strong> method on the client model. <br></li></ul><br><h3>  Kinds <br></h3><br>  A view is an object that parses the template in the html-code (view), fills it with data and places it at the destination on the application page.  The view is responsible for the timely rendering of the view when the data displayed in it changes, and also carries the logic of user interaction with the view.  The view always belongs to a particular model. <br><br>  Any view always has a reference to its model in the @model property (for brevity there is an alias property @my), and the <a href="http://habrahabr.ru/users/element/" class="user_link">element</a> property contains a view in the form of a jBone object (or jQuery if the application uses it as a library for DOM manipulations). <br><br>  You can create a new view through the terminal using the command <br><br><pre> <code class="hljs pgsql">$ nali <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> PhotoPreview</code> </pre><br>  where <em>Photo</em> is the model that owns the view, and <em>Preview</em> is the name of the view.  As a result of the command, we will get the following files. <br><br><ul><li>  <em>app / client / javascripts / views / photo / preview.js.coffee</em> - the view itself <br></li><li>  <em>app / client / stylesheets / photo / preview.css.sass</em> - his styles <br></li><li>  <em>app / client / templates / photo / preview.html</em> - template <br></li></ul><br>  Let's start their consideration with the template, its file after generation is empty, fill it <br><br><pre> <code class="hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- app/client/templates/photo/preview.html --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"name"</span></span></span><span class="hljs-tag">&gt;</span></span>{ @name }<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photo"</span></span></span><span class="hljs-tag">&gt;</span></span>{ +photoTag }<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   -    photoTag --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"autor"</span></span></span><span class="hljs-tag">&gt;</span></span>: { @user.name }<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   -  --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"album"</span></span></span><span class="hljs-tag">&gt;</span></span>: { @album.name }<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/comments/{ @id }"</span></span></span><span class="hljs-tag">&gt;</span></span>: { @comments.length }<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--        --&gt;</span></span></code> </pre><br>  On the client, this template will automatically turn into a <em>div.PhotoPreview</em> and will look like this. <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PhotoPreview"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"name"</span></span></span><span class="hljs-tag">&gt;</span></span>{ @name }<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ... --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  In Nali, views of the views are wrapped in a tag that has a class recorded in the CamelCase style, thanks to which they can be easily distinguished during debugging when viewing the source code of the page.  More information about the instructions of the templates and wrapping can be found on the <a href="https://github.com/4urbanoff/nali/wiki/%25D0%2592%25D0%25B8%25D0%25B4">documentation</a> page. <br><br>  If you need to precompile the template on the server before returning to the client, you can do this using the ERB template engine by simply renaming the template extension from <em>preview.html</em> to <em>preview.html.erb</em> and adding the appropriate instructions to it.  By the way, you can use other template engines, such as haml or slim, these features are provided by gem sprockets. <br><br>  When inserting data directly into the template, using the <em>{ <a href="http://habrahabr.ru/users/name/" class="user_link">name</a> }</em> instruction, the viewpoint is the point of reference, i.e.  @ Is a model, <em><a href="http://habrahabr.ru/users/name/" class="user_link">name</a></em> is the name of a photo, <em>@album</em> is her album, <em>@ album.name is</em> his name, etc., the chain can be as long as you want, when it is parsed, the view will get to the final property, insert its value into the view and subscribes to the event of its change. <br><br>  Default styling is handled by the SASS preprocessor and in our case will look something like this. <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># app/client/stylesheets/photo/preview.css.sass .PhotoPreview .name # ... .photo # ... .autor # ... .album # ...</span></span></code> </pre><br>  To use the SCSS preprocessor, it is necessary, by analogy with the template, to rename the style file extension in <em>preview.css.scss</em> , and for regular CSS in <em>preview.css</em> . <br><br>  The view itself after generation looks like this. <br><br><pre> <code class="hljs erlang-repl"># app/client/javascripts/views/photo/preview.js.coffee Nali.View.extend PhotoPreview: events: [] #         helpers: {} # ,     onDraw: -&gt; # ,     onShow: -&gt; # ,       onHide: -&gt; # ,      </code> </pre><br>  Edit it according to our requirements. <br><br><pre> <code class="hljs mel">Nali.View.extend PhotoPreview: events: <span class="hljs-string"><span class="hljs-string">'openFullSize on click at div.photo'</span></span> #      div.photo   openFullSize, #  : <span class="hljs-string"><span class="hljs-string">'[, ... ] on [, ...] at [  ]'</span></span> #          helpers: photoTag: -&gt; <span class="hljs-string"><span class="hljs-string">'&lt;img src="/photos/'</span></span> + @my.id + <span class="hljs-string"><span class="hljs-string">'.'</span></span> + @my.<span class="hljs-keyword"><span class="hljs-keyword">format</span></span> + <span class="hljs-string"><span class="hljs-string">'" alt="" /&gt;'</span></span> #       openFullSize: ( <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> ) -&gt; #     </code> </pre><br>  Now, to see the thumbnails of all the photos of the album, just go to the browser at the address, for example, <em>/ photos / preview / 1</em> , as a result, the page (by default, the body tag) will be inserted into the page <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PhotoPreview"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PhotoPreview"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PhotoPreview"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  To change the destination where thumbnails are inserted, it is enough to add a simple method in the form of <em>PhotoPreview</em> , which returns the selector of the DOM element or the element itself (at the moment of insertion it must exist in the DOM tree) <br><br><pre> <code class="hljs coffeescript">Nali.View.extend PhotoPreview: insertTo: <span class="hljs-function"><span class="hljs-function">-&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'div.photosContainer'</span></span> <span class="hljs-comment"><span class="hljs-comment"># ...</span></span></code> </pre><br>  then the result of the insertion will look like this <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photosContainer"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PhotoPreview"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PhotoPreview"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PhotoPreview"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Moreover, views can be inserted into layouts, i.e.  creating a simple view, for example <em>AlbumIndex</em> <br><pre> <code class="hljs coffeescript">Nali.View.extend AlbumIndex: insertTo: <span class="hljs-function"><span class="hljs-function">-&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'div.photosContainer'</span></span> <span class="hljs-comment"><span class="hljs-comment"># ...</span></span></code> </pre><br>  with template <br><br><pre> <code class="hljs scala">&lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"name"</span></span>&gt;: { <span class="hljs-meta"><span class="hljs-meta">@name</span></span> }&lt;/div&gt; &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"photos"</span></span>&gt;{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> }&lt;/div&gt;</code> </pre><br>  and replacing the <em>insertTo</em> method with the <em>layout</em> method in the <em>PhotoPreview</em> <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Nali</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.View</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.extend</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PhotoPreview</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">layout</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>&gt; @<span class="hljs-keyword"><span class="hljs-keyword">my</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">album</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">viewIndex</span></span>() #   index  # ...</code> </pre><br>  we will see thumbnails in the album view and on the page it will look like this <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photosContainer"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AlbumIndex"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"name"</span></span></span><span class="hljs-tag">&gt;</span></span>: { @name }<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photos"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PhotoPreview"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PhotoPreview"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PhotoPreview"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The key statement <em>{yield}</em> defines the place where they will be inserted.  I will also add that the nesting of views in layouts is not limited, because the layout is a normal view, so you can also define a parent layout for it - this allows you to conveniently split the html code of the page into components. <br><br>  Here, using examples, I described only some of the capabilities of the Nali species, in fact there are many more of them and they are described in detail on the <a href="https://github.com/4urbanoff/nali/wiki/%25D0%2592%25D0%25B8%25D0%25B4">documentation</a> page. <br><br><h3>  Another way <br></h3><br>  The task described above can be solved in a slightly different way, namely, having examined the photos from albums, you can add an action route to the <em>Albums</em> client controller <br><pre> <code class="hljs pgsql">Nali.Controller.extend Albums: actions: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-string"><span class="hljs-string">'index'</span></span> #   ,      /albums/<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>  /albums/<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">'index/id'</span></span>: -&gt; # <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> -  , id -     @Model.Photo.<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> album: id: @filters.id #     </code> </pre><br>  then add attributes to the <em>Album</em> client model, link to photos and sort them before showing the album <em>index</em> view <br><br><pre> <code class="hljs pgsql">Nali.Model.extend Album: hasMany: <span class="hljs-string"><span class="hljs-string">'photos'</span></span> attributes: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> beforeShow: <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>: -&gt; @photos.<span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span>: <span class="hljs-string"><span class="hljs-string">'created'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> </pre><br>  then slightly change the template of the <em>AlbumIndex view</em> <br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"name"</span></span></span><span class="hljs-tag">&gt;</span></span>: { @name }<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"photos"</span></span></span><span class="hljs-tag">&gt;</span></span>{ preview of @photos }<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--  { yield }  { preview of @photos } --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--      preview     @photos --&gt;</span></span></code> </pre><br>  and get the same result at <em>/ albums / 1</em> (by the way, the router will understand <em>/ album / 1</em> ). <br><br><h3>  Collections <br></h3><br>  A collection is a collection of models selected by a specific filter.  Whenever we use the <em>where</em> method to search for models, we get their collection.  The collection methods are described in detail in the <a href="https://github.com/4urbanoff/nali/wiki/%25D0%259A%25D0%25BE%25D0%25BB%25D0%25BB%25D0%25B5%25D0%25BA%25D1%2586%25D0%25B8%25D1%258F">documentation</a> . <br><br>  The features of the Nali collections are: <br><br><ul><li>  <strong>relevance</strong> - a once created collection will always carry only the current set of models in itself, if the model has changed and ceased to meet the requirements of the collection, it disappears from the set and vice versa, if the model begins to meet the requirements of the collection, it falls into the set; <br></li><li>  <strong>sorting</strong> - if the collection has sorting parameters, then the models in it are always ordered according to these parameters, in addition, if the collection was given the command to show views, then their views are arranged on the page according to the sorting, and if the collection is re-sorted, they will also be re-sorted; <br></li><li>  <strong>adaptation mechanism</strong> - the collection remembers what actions were carried out with its models and, when a new model is added to the collection, it will automatically undergo these actions in the order in which they were carried out, and if you remove it from the collection, the model will be reversed (let‚Äôs say the collection shows views, a new model, once in it, will also show the required view, if you remove a model from the collection, its view will disappear from the page); <br></li><li>  <strong>proxying model methods</strong> ‚Äî if a method is defined in a model, the name of which begins with a double underscore, then the collection of such models will have a method of the same name (without underscores) that calls it on all models. <br></li></ul><br>  A small example: <br><pre> <code class="hljs css">#    <span class="hljs-selector-tag"><span class="hljs-selector-tag">Nali</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Model</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.extend</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">User</span></span>: {} #   <span class="hljs-selector-tag"><span class="hljs-selector-tag">Nali</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.View</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.extend</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">UserIndex</span></span>: {}</code> </pre><br>  view template <br><pre> <code class="hljs pgsql">&lt;div&gt;<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>: { @<span class="hljs-type"><span class="hljs-type">name</span></span> }, Age: { @age }&lt;/div&gt;</code> </pre><br>  create local instances of models <br><pre> <code class="hljs pgsql">Nali.Model.<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>( <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Ted'</span></span>, age: <span class="hljs-number"><span class="hljs-number">20</span></span> ).<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>() Nali.Model.<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>( <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Bob'</span></span>, age: <span class="hljs-number"><span class="hljs-number">25</span></span> ).<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>() Nali.Model.<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>( <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Dan'</span></span>, age: <span class="hljs-number"><span class="hljs-number">30</span></span> ).<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>() #  <span class="hljs-type"><span class="hljs-type">name</span></span>  age  ,     # <span class="hljs-keyword"><span class="hljs-keyword">write</span></span>()      </code> </pre><br>  let's sample the collection of models and show on the screen a representation of their type index <br><pre> <code class="hljs pgsql">users = Nali.Model.<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">where</span></span>( age: [ <span class="hljs-number"><span class="hljs-number">20.</span></span><span class="hljs-number"><span class="hljs-number">.30</span></span> ] ).<span class="hljs-keyword"><span class="hljs-keyword">order</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">by</span></span>: <span class="hljs-string"><span class="hljs-string">'age'</span></span> ).<span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-string"><span class="hljs-string">'index'</span></span></code> </pre><br>  in the end we get <br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserIndex"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>User: Ted, Age: 20<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserIndex"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>User: Bob, Age: 25<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserIndex"</span></span></span><span class="hljs-tag">&gt;</span></span> div&gt;User: Dan, Age: 30<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  change the age of the last <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">users</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.last</span></span>()<span class="hljs-selector-class"><span class="hljs-selector-class">.update</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">age</span></span>: 23</code> </pre><br>  the collection is automatically re-sorted, views also <br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserIndex"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>User: Ted, Age: 20<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserIndex"</span></span></span><span class="hljs-tag">&gt;</span></span> div&gt;User: Dan, Age: 23<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserIndex"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>User: Bob, Age: 25<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  change the age of the first one to the value beyond the collection filter (age: [20..30]) <br><pre> <code class="hljs pgsql">user1 = users.first().<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> age: <span class="hljs-number"><span class="hljs-number">19</span></span></code> </pre><br>  the model disappears from the collection, hiding the view <br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserIndex"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>User: Dan, Age: 23<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserIndex"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>User: Bob, Age: 25<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  return it a value suitable for the collection filter <br><pre> <code class="hljs pgsql">user1.<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> age: <span class="hljs-number"><span class="hljs-number">27</span></span></code> </pre><br>  the model appears again in the collection and shows a view of the index view according to the sorting <br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserIndex"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>User: Dan, Age: 23<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserIndex"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>User: Bob, Age: 25<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserIndex"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>User: Ted, Age: 27<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  re-sort the entire collection and get an array of usernames <br><pre> <code class="hljs pgsql">users.<span class="hljs-keyword"><span class="hljs-keyword">order</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">by</span></span>: <span class="hljs-string"><span class="hljs-string">'name'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> ).pluck <span class="hljs-string"><span class="hljs-string">'name'</span></span> # &gt; [ <span class="hljs-string"><span class="hljs-string">'Ted'</span></span>, <span class="hljs-string"><span class="hljs-string">'Dan'</span></span>, <span class="hljs-string"><span class="hljs-string">'Bob'</span></span> ] #     users.hide <span class="hljs-string"><span class="hljs-string">'index'</span></span> #    </code> </pre><br><h3>  Customers <br></h3><br>  When a new client connects to the server, an object of the class <strong>EventMachine :: WebSocket :: Connection</strong> is created for it, to which Nali adds additional features.  In any controller, the current client can be obtained by the <em>client</em> method, and the list of all connected clients by the <em>clients</em> method. <br><br>  Each client has a personal repository, work with which is quite simple and fits into a small example. <br><br><pre> <code class="hljs pgsql">client[ :<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> ] = <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> #   client[ :<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> ] #   client[].<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>( :<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> ) #   client[] #    </code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To synchronize models with the client, there is a </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sync</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><em><font style="vertical-align: inherit;">(* models)</font></em><font style="vertical-align: inherit;"> , which is quite simple to use.</font></font><br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> city: <span class="hljs-string"><span class="hljs-string">'Moskow'</span></span> client.sync <span class="hljs-keyword"><span class="hljs-keyword">user</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For getting other clients, which are tabs of one browser, there are methods </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all_tabs</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">other_tabs</font></font></em> <br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.all_tabs <span class="hljs-meta"><span class="hljs-meta">#   ,  ,     client.other_tabs #   ,  ,    </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is convenient in cases when, for example, a user has several tabs with a site, then when you click "exit" on one of them, you can easily make an "exit" on the others, or when the user launches the player on one tab, and on others need to stop. </font><font style="vertical-align: inherit;">Each of these methods takes a block of code that runs separately for each client in the array. </font><font style="vertical-align: inherit;">Three methods are defined in the </font><em><font style="vertical-align: inherit;">app / server / clients.rb</font></em></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">that allow you to configure server responses to incoming messages and enable / disable clients.</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><br><br><pre> <code class="hljs scala">module <span class="hljs-type"><span class="hljs-type">Nali</span></span>::<span class="hljs-type"><span class="hljs-type">Clients</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client_connected</span></span></span></span>( client ) #      ,  #     client end <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_message</span></span></span></span>( client, message ) #  ,      #  client  message  -  #    end <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client_disconnected</span></span></span></span>( client ) #     ,  #     client end end</code> </pre><br><h3>  Notifications <br></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nali has a built-in </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notice</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> model </font><font style="vertical-align: inherit;">that has 3 types of </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">info</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">error</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , responsible for displaying notifications to the user. </font><font style="vertical-align: inherit;">The type and design of notifications is easily customized to the needs of the developer. </font><font style="vertical-align: inherit;">The display of notifications is elementary:</font></font><br><br><pre> <code class="hljs pgsql">@<span class="hljs-keyword"><span class="hljs-keyword">Notice</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> <span class="hljs-string"><span class="hljs-string">'Hello World'</span></span> #    <span class="hljs-keyword"><span class="hljs-keyword">info</span></span>,   Hello World #      <span class="hljs-number"><span class="hljs-number">3</span></span>  #     @<span class="hljs-keyword"><span class="hljs-keyword">Notice</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> message: <span class="hljs-string"><span class="hljs-string">'Hello World'</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is also easy to create your own type of notification, this process is described in detail in the </font></font><a href="https://github.com/4urbanoff/nali/wiki/Nali.Notice"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can initiate the notification from the server side as follows.</font></font><br><br><pre> <code class="hljs pgsql">client.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> message: <span class="hljs-string"><span class="hljs-string">'Hello World'</span></span> #     @<span class="hljs-keyword"><span class="hljs-keyword">Notice</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> message: <span class="hljs-string"><span class="hljs-string">'Hello World'</span></span></code> </pre><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Deployment </font></font><br></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nali allows you to compile, minify and merge client-side files with the command </font></font><br><br><pre> <code class="hljs axapta">$ bundle exec rake <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>:compile</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This team will collect </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all your javascript files in </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">public / client / application.js</font></font></em> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all your stylesheets files in </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">public / client / application.css</font></font></em> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all your html templates in </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">public / index.html</font></font></em> </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that will allow in the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">production</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> environment to give them ready. </font><font style="vertical-align: inherit;">In order to compile client files for the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">production</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> environment, while being in the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">development</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> environment </font><font style="vertical-align: inherit;">, you must explicitly set this environment in the command call</font></font><br><br><pre> <code class="hljs axapta">$ bundle exec rake <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>:compile RACK_ENV=production</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is useful when the file system on the destination server is in </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read-only</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mode </font><font style="vertical-align: inherit;">, like on </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Heroku</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, if you think about it, you can conclude that by placing these files in </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PhoneGap</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CocoonJS,</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you can easily and quickly get a cross-platform application client.</font></font><br><br><h2>  Let's sum up <br></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Looking back and remembering the moments of the past year, I believe that it was not for nothing that I spent this time, albeit idle, financially, but the baggage of the knowledge gained is much more valuable to me. </font><font style="vertical-align: inherit;">I cannot assess myself in terms of how high my level of knowledge and qualifications in the field of web development is now - I will draw these conclusions for myself based on your comments, in which, I hope, you answer the main question - is this another bike or is there anything worthy of attention? </font><font style="vertical-align: inherit;">I will be glad to your criticism, any help and just support. </font><font style="vertical-align: inherit;">To all readers who have found time to read this article, I want to say thank you and take a bow at this. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Battery links:</font></font><br><br><ul><li> <a href="https://github.com/4urbanoff/nali"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nali repository on github</font></font></a> </li><li> <a href="https://rubygems.org/gems/nali"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RubyGems page</font></font></a> </li><li> <a href="http://anonim.am/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">small anonymous chat as an example of the work of Nali</font></font></a> </li><li> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chat source code on github</font></font></a> </li><li> <a href="https://github.com/4urbanoff/anonim.am/wiki"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">huge article about its development</font></font></a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/248601/">https://habr.com/ru/post/248601/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248589/index.html">The first step on the path to daily planning, or where does the meat grinder?</a></li>
<li><a href="../248591/index.html">Using the DSP coprocessor DM8168 using the C6Accel framework</a></li>
<li><a href="../248593/index.html">Opensource lifeguard for cats, dogs and other animals in PHP</a></li>
<li><a href="../248597/index.html">Parsing the Microsoft Office localization file format</a></li>
<li><a href="../248599/index.html">"Durov, return the wall" or "Habrahabr + Geektimes + Megamind" in one tape</a></li>
<li><a href="../248605/index.html">Piloting cloud-based MongoDB via VanillaJS or how to make a private todo list for 15 minutes for free</a></li>
<li><a href="../248607/index.html">Data-mining in 40 lines or with whom and against whom you are at the same time</a></li>
<li><a href="../248609/index.html">Announced Zend Framework 3 Roadmap</a></li>
<li><a href="../248611/index.html">A brief course of computer graphics: we write a simplified OpenGL do it yourself, article 4a of 6</a></li>
<li><a href="../248613/index.html">We are speeding up the Yandex mobile browser for Android on WebKit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>