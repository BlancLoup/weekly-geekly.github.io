<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I added car functions on CAN bus, not being able to program</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The purpose of this article is to talk about my experience in modifying a car and experimenting with a CAN bus. 

 How it all started 
 At first, I de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I added car functions on CAN bus, not being able to program</h1><div class="post__text post__text-html js-mediator-article"> <a href=""><img src="https://habrastorage.org/webt/xo/k7/t2/xok7t2l-qmakairvtmxiduaj6pg.jpeg"></a> <br><br>  The purpose of this article is to talk about my experience in modifying a car and experimenting with a CAN bus. <br><br><h1>  How it all started </h1><br>  At first, I decided to add a front camera to my 2017 Chevrolet Cruze.  Since the car already has a factory rear view camera, two things needed to be clarified at a high level: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  The way to transfer video from the front camera, which I will add. <br></li><li>  A way to display images from the rear view camera on the screen at any time. </li></ol><a name="habracut"></a><br>  The video part was simple.  From previous experience, I knew that you can make a switcher on the relay. <br><br>  The launch on the screen turned out to be more difficult, and after some investigation I came to the conclusion that the car should give a signal from the rear-view camera to the screen via some kind of data bus. <br><br><h1>  CAN bus </h1><br>  Chevrolet has two different data buses.  The first is the standard CAN, fast (500 Kbps) and reliable, it is used for critical data.  The second is what GM calls the LAN (GMLAN), the older and slower bus (33.3 Kbps), which is used for non-security data. <br><br>  I needed a way to listen to traffic over CAN, that is, a sniffer.  For this purpose, the PCAN device is incredibly useful. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cf0/18f/db5/cf018fdb5119f22edb383bc4b77f92cd.jpg"><br>  <i><font color="gray">Peak can</font></i> <br><br>  Peak Can (PCAN) is a USB device capable of intercepting and transmitting messages.  Thanks to the Pcan View software, you can start working without much training. <br><br>  Since the rear view camera is less important for safety than other components, I assumed that the data sought would most likely be on the GMLAN bus. <br><br>  The simplest access point is the OBD2 connector.  I connected Peak Can to the GMLAN bus, launched the software, and immediately started listening to the traffic. <br><br><h1>  Integration </h1><br>  The goal was to redesign the rear view camera call.  To do this, with the sniffer turned on, I drove the car in reverse so that it turned on the display and then tried to park several times.  Throughout this process, I noticed one ID with messages that sequentially imitated my actions. <br><br>  Then I parked and through Pcan View I tried to transmit the same message that I saw when the display turned on and off.  In no time, I had interacted with the bus. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/333149439" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i><font color="gray">Send a message via PCAN</font></i> <br><br>  However, I did not plan to constantly ride with a laptop.  We needed a way to automate these functions - and Arduino came in handy here.  The ability to directly receive 12V power in combination with a lot of resources and online support has made this choice obvious. <br><br>  In addition to Arduino, I needed two components to complete the project: a CAN module and a relay module.  In essence, Arduino is the brain that runs and executes code.  The CAN module provides the ability to interact with the data bus, and the relay provides power to the front camera, and also acts as a video switcher between it and the rear view camera. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fd2/8b9/335/fd28b9335da54c5e1f490e0439bf6694.jpg"><br>  <i><font color="gray">Module mcp2515 (top), Arduino Uno (middle), relay module (bottom)</font></i> <br><br>  After adding and configuring the appropriate libraries, Arduino has established a connection with the car. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/333149432" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i><font color="gray">Listening to traffic through Arduino</font></i> <br><br>  Since I already knew that I could start the display, I started thinking about HOW to do it.  The initial idea was to install a special instant call button on the panel, but I started to think: ‚ÄúAnd what else can I use on the network as a trigger?‚Äù <br><br>  In the course of the experiments, I found that messages with an ID corresponding to the "Cancel Cruise Control" button are also sent over the GMLAN bus.  It was perfect because the cruise control turns on at speeds above 65 km / h when I use the front camera, and at speeds below 15 km / h the rear view camera will turn on to help with parking, so they will never overlap.  After writing some code, I was able to force the Arduino to recognize when the cruise control cancel button was pressed. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/333149460" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i><font color="gray">Recognition of a single button click</font></i> <br><br>  However, I didn‚Äôt want the camera to be activated every time I cancel the cruise control, so I decided that the best approach is to turn it (essentially) into a multifunction button.  The camera is activated only if the button is ‚Äúdouble pressed‚Äù. <br><br>  After a long weekend exploring the millis function and debugging the code, I successfully programmed double-click recognition. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/333149449" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i><font color="gray">Double click recognition</font></i> <br><br>  And when I tied it to my teams to control the display, I got a pretty cool small utility. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/333149421" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i><font color="gray">Double tap + command</font></i> <br><br><h1>  Functionality </h1><br>  Now I had the opportunity to turn the display on and off, but there was one problem - what about the rear view camera?  I needed them to work together with the front camera, as if they were set up in a factory like that. <br><br>  In the block diagram, I depicted how I represent it. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/771/63e/cca/77163ecca613e040e82d2aae9db9c511.jpg"><br><br>  I quickly realized that for such a system you need at any time to know the state of three variables: <br><br><ul><li>  Front camera module: did the driver turn it on or off? <br></li><li>  Camera display: is the display on or off? <br></li><li>  Reverse: is the car in reverse or not? </li></ul><br>  Having no programming experience, it was very difficult to do, and all my free time I was thinking about different approaches. <br><br>  In the end, I achieved success! <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/333149405" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i><font color="gray">Active monitoring</font></i> <br><br>  Now I was able to implement the operational logic that controls the relay. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/333149469" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i><font color="gray">Relay Control</font></i> <br><br>  Throughout the process, I learned more and more about the Arduino and noticed that the Nano version was able to do everything that was needed, while it had a smaller size and lower price.  It is ideal for permanent installation in the car.  I developed a model and printed out a case on a 3D printer to place the components as a compact unit for installation. <br><br><img src="https://habrastorage.org/webt/o9/dq/vd/o9dqvdst9apwqd3ufvmr-l7ppqy.png"><br>  <i><font color="gray">3D case</font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6af/bc4/e86/6afbc4e8629d4fd6255f6f79f8344b8d.png"></div><br><br><h1>  Together </h1><br>  Finally the day came when I saw the results.  Although you still need to tinker with the timing, but it was nice to see that the module works correctly. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/334454520" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <i><font color="gray">Turn on / off the parking mode, turn on / off the front camera, automatically switch to the rear view camera and automatically switch back</font></i> <br><br>  In general, this experience taught me a lot and opened my eyes to the possibility of integration directly with the CAN bus.  It is quite surprising what can be achieved by connecting two wires. <br><br><h1>  In future </h1><br>  In the future, I plan to write an in-depth tutorial on how to add additional functionality to existing buttons in your car using free software and components. </div><p>Source: <a href="https://habr.com/ru/post/451294/">https://habr.com/ru/post/451294/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451274/index.html">Perfect Weapon, Perspective War and Human Being Reaching the Ceiling</a></li>
<li><a href="../451278/index.html">Wavelet analysis. Part 1</a></li>
<li><a href="../451280/index.html">The most interesting metals</a></li>
<li><a href="../451282/index.html">Web analytics "black holes": how much data is lost in GA and why</a></li>
<li><a href="../451292/index.html">RxDart: magical stream transformations</a></li>
<li><a href="../451296/index.html">Announced ML.NET 1.0</a></li>
<li><a href="../451298/index.html">How to make a game console with the case, ordering a single PCB</a></li>
<li><a href="../4513/index.html">The founder of "MegaFon" asks for protection from the Russian minister</a></li>
<li><a href="../451300/index.html">How to solve the traveling salesman problem?</a></li>
<li><a href="../451304/index.html">The ‚Äútip‚Äù from Yandex: how to maximize profits on a paid subscription</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>