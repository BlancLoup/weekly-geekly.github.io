<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using the functionality of the MVC4 framework to authorize users and use the role-based model of access to the site</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings. 
 Today I would like to tell you in a very small lesson (the level is rather for very beginners) how you can quickly and easily set up user...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using the functionality of the MVC4 framework to authorize users and use the role-based model of access to the site</h1><div class="post__text post__text-html js-mediator-article">  Greetings. <br>  Today I would like to tell you in a very small lesson (the level is rather for very beginners) how you can quickly and easily set up user <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D1%2583%25D1%2582%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2584%25D0%25B8%25D0%25BA%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">authentication</a> , as well as <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B2%25D1%2582%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">authorization</a> when they access some functionality on your site, using standard means of the MVC framework (4). <br><br><h5>  Introductory </h5><br>  I am now writing a personal unpretentious website for recording and managing expenses, incomes, reminders about periodic payments (utilities, loans, school, etc.) + analytics (mainly charts), since Google and Docs have ceased to organize my wife‚Äôs functionality. <br>  Accordingly, the question arose of how <b>to close information</b> , in this case, the family‚Äôs financial condition from prying eyes for <b>authentication,</b> as well as to distribute <b>access roles (authorization)</b> - what can a wife, child, anonymous users, and what can an <s>administrator</s> head of a family. <br><br>  UPD: described ways to create users, roles in a more correct way (no need to go directly into the database) <br>  The code showing the menu should be translated into a more correct form, corresponding to the MVC ideology, since the current code is far from exemplary and written quickly, for demonstration, I am working on it. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Short introduction - The reasons that prompted me to write this article and some notes for beginners "&gt; <br><br>  The project was created in the framework of the study of C #, MVC4 - I'm new. <br>  I spent a few evenings searching, messing with user providers and setting them up, until I realized that I didn‚Äôt need all this code at this stage.  The result was the rewriting of an article on the principle I once had in my head - the less changes are made to any object, whether it is a configuration file, a document or code at the current level of my knowledge or ideas, the later it will be easier.  Perhaps I missed some important nuances (I am a beginner), so I will be glad both to criticism and to the hints of the audience. <br><br>  I believe that the user has already created at least one simple site on this framework, for example, <a href="http://www.asp.net/mvc/tutorials/mvc-4/getting-started-with-aspnet-mvc4/intro-to-aspnet-mvc-4">using the basic instructions for creating a simple catalog of your films on the MVC4 framework</a> (it took me about 20 minutes). <br>  Or studying MVC for the second, <a href="http://www.asp.net/mvc/tutorials/mvc-music-store/mvc-music-store-part-1">very good and more complex instruction on creating an online store for selling music albums</a> (it concerns MVC3, but, nevertheless, I recommend starting MVC with this instruction). <br><br>  In the process of studying the second instruction, I ran into problems related to the fact that some things in MVC4 changed compared to MVC3, and I consider taking outdated controller code from the previous framework model and model to be a bad idea, so I decided to deal with this problem. <br><br><h5>  Prerequisite: </h5><br>  When you create a new MVC4 project by default at the top, to the right when you open the site there is a small menu of two items - ‚ÄúRegistration‚Äù and ‚ÄúLog in‚Äù. <br><img src="https://habrastorage.org/storage2/d6b/a38/c29/d6ba38c294ed162933b2b946db637efd.jpg"><br><br><h5>  Technical task: </h5><br>  "Activate" and run on our website role-based access model with the distribution of functionality. <br><br>  By default, everything that we need is already there and it works, thanks to the developers, but we will have to add something ourselves. <br><br><h5>  Workspace: </h5><br>  I have the usual Russian versions of Visual Studio 2012 Express, .Net 4.5, SQL 2012 and MVC4 (as well as TFS2012 Express. All this lives on Windows 2008R2), if you install the English localization of the name, menu items and other interface elements will be called differently, so I abstract to the maximum from the screenshots of the screen. <br><br><h1>  The solution of the problem </h1><br><br><h5>  Storage preparation </h5><br>  I prefer to separate these applications from authorization, so I created a separate users database, <br><br><ol><li>  In the App_Data directory, you need to create a new, empty database, let's call it ‚Äúusers‚Äù to identify its contents. </li><li>  In our web application, you need to describe the connection to our new database; to do this, open the web.config file, which is located in the root directory of our application, find (usually at the very beginning of the file) the item describing connections to data sources.  (I took the config from an already working site, so you will only have the connection name DefaultConnection as the correct and matching item). <br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">connectionStrings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DefaultConnection"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">connectionString</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Data Source=(LocalDb)\v11.0;Initial Catalog=aspnet-MyMoney-2132141343;Integrated Security=SSPI;AttachDBFilename=|DataDirectory|\users.mdf"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">providerName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Data.SqlClient"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"payDBContext"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">connectionString</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Data Source=(LocalDb)\v11.0;Initial Catalog=aspnet-MyMoney-data;Integrated Security=SSPI;AttachDBFilename=|DataDirectory|\MyMoney.mdf"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">providerName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Data.SqlClient"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">connectionStrings</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  A little more detail: <br>  In this list of connections, we have the default connection ‚ÄúDefaultConnection‚Äù, we will only use it to store user information, so we will not change this, all application data will be stored in another database, payDBContext. <br>  In the DefaultConnection settings, we change: <br><ol><li>  The initial directory ‚ÄúInitial Catalog = aspnet-MyMoney-2132141343‚Äù is the name of the database at the moment of attachment of the database to the database server, therefore, if several databases work with this same name, there can be ambiguities </li><li>  the item ‚ÄúAttachDBFilename = | DataDirectory | \ users.mdf‚Äù, the name of the database file where users and roles will be stored.  The name of the database we created in the App_Data directory is "users.mdf". </li></ol><br></li><li>  Now you can start the site, log in and register, for example, two Admin and User users. </li><li>  After that, in the database browser, right in the studio, open the structure of our database <br><br>  And we get something like <br><img src="https://habrastorage.org/storage2/e30/138/641/e301386412cb5ea749615dc83a35fd6e.png"></li><li>  To add roles, you can add code like this in accountmodel.cs: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UsersContext</span></span> : <span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UsersContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"users"</span></span></span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;UserProfile&gt; UserProfiles { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;webpages_Roles&gt; webpages_Roles { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//    } //    [Table("webpages_Roles")] public class webpages_Roles { [Key] [DatabaseGeneratedAttribute(DatabaseGeneratedOption.Identity)] public int RoleId { get; set; } [Display(Name = " ")] public string RoleName { get; set; } }</span></span></code> </pre><br>  Then, after rebuilding the project, we can create a roles controller (don't forget to close it for users with an administrative role) <br><img src="https://habrastorage.org/storage2/58b/bdb/d2a/58bbdbd2ace25daeefa13a0bc7a5b55e.png"><br><br>  It is better to look at an example of adding users in the ‚ÄúAccount‚Äù controller, Register methods and modifying it to add a user to one or several roles using Roles.AddUserToRole (), for example, by closing it for an administrative role, or adding your controller.  which will add the user to the role. <br></li></ol><br><br>  I have several controllers responsible for working with financial information, so in the description of each controller (you can close or, on the contrary, open separate methods), you must insert the appropriate access setting: <pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Authorize(Roles = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Admin"</span></span></span><span class="hljs-meta">)</span></span>]</code> </pre><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyMoney.Controllers</span></span> { [Authorize(Roles = <span class="hljs-string"><span class="hljs-string">"Admin"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">catController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> {</code> </pre><br>  Or insert such a line to enter the methods of several roles <pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Authorize(Roles = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Admin, User"</span></span></span><span class="hljs-meta">)</span></span>]</code> </pre><br>  Now I want to change the menu list slightly depending on the role of the user. <br><ol><li>  In the / Views / Shared directory, I create a partial view (it‚Äôs also Partial View) with the name "_Menu" <br><div class="spoiler">  <b class="spoiler_title">the source code, by the way, who will tell you how to optimize it better, otherwise it</b> <div class="spoiler_text"><pre> <code class="cs hljs">@{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> menus = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { LinkText=<span class="hljs-string"><span class="hljs-string">" "</span></span>, ActionName=<span class="hljs-string"><span class="hljs-string">"Index"</span></span>,ControllerName=<span class="hljs-string"><span class="hljs-string">"Home"</span></span>,Roles=<span class="hljs-string"><span class="hljs-string">"All"</span></span> }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { LinkText=<span class="hljs-string"><span class="hljs-string">" "</span></span>, ActionName=<span class="hljs-string"><span class="hljs-string">"About"</span></span>,ControllerName=<span class="hljs-string"><span class="hljs-string">"Home"</span></span>,Roles=<span class="hljs-string"><span class="hljs-string">"All"</span></span> }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { LinkText=<span class="hljs-string"><span class="hljs-string">""</span></span>, ActionName=<span class="hljs-string"><span class="hljs-string">"Contact"</span></span>,ControllerName=<span class="hljs-string"><span class="hljs-string">"Home"</span></span>,Roles=<span class="hljs-string"><span class="hljs-string">"All"</span></span> }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { LinkText=<span class="hljs-string"><span class="hljs-string">""</span></span>, ActionName=<span class="hljs-string"><span class="hljs-string">"Index"</span></span>,ControllerName=<span class="hljs-string"><span class="hljs-string">"payments"</span></span>,Roles=<span class="hljs-string"><span class="hljs-string">"Admin,User"</span></span> }, }; } &lt;ul id=<span class="hljs-string"><span class="hljs-string">"menu"</span></span>&gt; @<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (HttpContext.Current.User.Identity.IsAuthenticated) { String[] roles = Roles.GetRolesForUser(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> links = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> menus <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> item.Roles.Split(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[] { <span class="hljs-string"><span class="hljs-string">","</span></span> }, StringSplitOptions.RemoveEmptyEntries) .Any(x =&gt; roles.Contains(x) || x == <span class="hljs-string"><span class="hljs-string">"All"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> item; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> link <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> links) { @: &lt;li&gt; @Html.ActionLink(link.LinkText, link.ActionName,link.ControllerName)&lt;/li&gt; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> links = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> menus <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> item.Roles.Split(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{<span class="hljs-string"><span class="hljs-string">","</span></span>},StringSplitOptions.RemoveEmptyEntries) .Any(x=&gt;<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{<span class="hljs-string"><span class="hljs-string">"All"</span></span>,<span class="hljs-string"><span class="hljs-string">"Anonymous"</span></span>}.Contains(x)) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> item; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> link <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> links){ @: &lt;li&gt; @Html.ActionLink(link.LinkText, link.ActionName, link.ControllerName)&lt;/li&gt; } } &lt;/ul&gt;</code> </pre><br></div></div><br></li><li>  Now you need to connect it to the markup /Views/Shared/_Layout.cshtml <br><br>  We are looking for this code in the _Layout.cshtml file <br><pre> <code class="cs hljs"> &lt;section id=<span class="hljs-string"><span class="hljs-string">"login"</span></span>&gt; @Html.Partial(<span class="hljs-string"><span class="hljs-string">"_LoginPartial"</span></span>) &lt;/section&gt; &lt;nav&gt; &lt;ul id=<span class="hljs-string"><span class="hljs-string">"navlist"</span></span>&gt; &lt;li <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"first"</span></span>&gt;&lt;a href=<span class="hljs-string"><span class="hljs-string">"@Url.Content("</span></span>~<span class="hljs-string"><span class="hljs-string">")"</span></span> id=<span class="hljs-string"><span class="hljs-string">"current"</span></span>&gt;Home&lt;/a&gt;&lt;/li&gt; &lt;li&gt;&lt;a href=<span class="hljs-string"><span class="hljs-string">"@Url.Content("</span></span>~/Store/<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt;Store&lt;/a&gt;&lt;/li&gt; &lt;li&gt;@{Html.RenderAction(<span class="hljs-string"><span class="hljs-string">"CartSummary"</span></span>, <span class="hljs-string"><span class="hljs-string">"ShoppingCart"</span></span>);}&lt;/li&gt; &lt;li&gt;&lt;a href=<span class="hljs-string"><span class="hljs-string">"@Url.Content("</span></span>~/StoreManager/<span class="hljs-string"><span class="hljs-string">")"</span></span>&gt;Admin&lt;/a&gt;&lt;/li&gt; &lt;/ul&gt; &lt;/nav&gt;</code> </pre><br><br>  and change the block <pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  on <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag">&gt;</span></span> @Html.Partial("~/Views/Shared/_Menu.cshtml") <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></li><li>  I have one controller with a short name, using one view as a menu, here‚Äôs the view code. <br>  Sketched a quick to show the work with roles. <br><div class="spoiler">  <b class="spoiler_title">presentation code</b> <div class="spoiler_text"><pre> <code class="html hljs xml">@{ var menus = new[] { new { LinkText="Home", ActionName="Index",ControllerName="Home",Roles="All" }, new { LinkText="About", ActionName="About",ControllerName="Home",Roles="Anonymous" }, new { LinkText="Contact", ActionName="Contact",ControllerName="Home",Roles="Anonymous" }, new { LinkText=" ", ActionName="Create",ControllerName="pay",Roles="Admin,User" }, new { LinkText=" ", ActionName="Index",ControllerName="pay",Roles="Admin,User" }, new { LinkText=" ", ActionName="Create",ControllerName="cat",Roles="Admin" }, new { LinkText=" ", ActionName="Index",ControllerName="cat",Roles="Admin,User" }, new { LinkText=" ", ActionName="Create",ControllerName="user",Roles="Admin" }, new { LinkText=" ", ActionName="Index",ControllerName="user",Roles="Admin" }, new { LinkText=" ", ActionName="Create",ControllerName="type",Roles="Admin" }, new { LinkText=" ", ActionName="Index",ControllerName="type",Roles="Admin" }, //new { LinkText="", ActionName="",ControllerName="",Roles="Administrator" }, }; } @{ ViewBag.Title = " "; } <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>: @User.Identity.Name<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>   :<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> @{ foreach (string item in Roles.GetRolesForUser()) { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>@item<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> } } <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"list"</span></span></span><span class="hljs-tag">&gt;</span></span> @if (HttpContext.Current.User.Identity.IsAuthenticated) { String[] roles = Roles.GetRolesForUser(); var links = from item in menus where item.Roles.Split(new String[] { "," }, StringSplitOptions.RemoveEmptyEntries) .Any(x =&gt; roles.Contains(x) || x == "All") select item; foreach (var link in links) { @: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> @Html.ActionLink(link.LinkText, link.ActionName, link.ControllerName)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>    } } else { var links = from item in menus where item.Roles.Split(new String[] { "," }, StringSplitOptions.RemoveEmptyEntries) .Any(x =&gt; new String[] { "All", "Anonymous" }.Contains(x)) select item; foreach (var link in links) { @: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> @Html.ActionLink(link.LinkText, link.ActionName, link.ControllerName)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span>     } } <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br></li></ol><br><br>  Now you need to clean, rebuild the application and you can run.  If you know the link to one of the controllers that are closed for anonymous login, try to log in - get an authorization form and then go back to the page that initiated the authorization. <br>  It looks like this: <br><br>  Anonymous login <br><img src="https://habrastorage.org/storage2/af2/7cc/da1/af27ccda1356ae83f15bfd3e307b8c2a.png"><br><br><br>  Login with administrative role <br><img src="https://habrastorage.org/storage2/281/0c0/544/2810c0544c4dae1b59419df04ffa93b5.png"><br><br><br>  Login with user role <br><img src="https://habrastorage.org/storage2/3fe/cbd/780/3fecbd7804507a2d3056f4c539f17d62.png"><br><br><div class="spoiler">  <b class="spoiler_title">Remarks at last</b> <div class="spoiler_text">  What I am thinking about now is that it is necessary to link in my finance database the receipt of the data of the current authorized user, since  Now, in Google Docs, you have to choose with your hands who was the initiator of the expense / income - and entering information twice is stupid.  And ideally, get authorization from a Windows session if the browser is IE. <br><br>  Yes, for some code snippets, I, as a beginner, have to hurt my hands, so I‚Äôm happy to accept corrections and improvements to this code. <br><br>  Thank you for your attention, I hope I helped someone. </div></div></div><p>Source: <a href="https://habr.com/ru/post/156443/">https://habr.com/ru/post/156443/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../156429/index.html">A Practical Guide to Collective Action</a></li>
<li><a href="../156433/index.html">Google Nexus 4 prototype forgotten in bar</a></li>
<li><a href="../156435/index.html">Evo, part 2 - about crossing</a></li>
<li><a href="../156437/index.html">IPhone 5 disassembly and some design differences from previous iPhone models</a></li>
<li><a href="../156441/index.html">Windows Azure PowerShell to work with IaaS</a></li>
<li><a href="../156445/index.html">Do you break a disk into sections? (The preinstalled recovery section does not count; forced splitting - multiple OS, swap - does not count)</a></li>
<li><a href="../156447/index.html">Calculation of trust rating in rubles of the Russian Federation (and other currencies). Society of trust and economy of trust</a></li>
<li><a href="../156449/index.html">Packages in Fuelphp</a></li>
<li><a href="../156455/index.html">Weekend Project: Imperial March on Servos and MSP430</a></li>
<li><a href="../156457/index.html">India builds a thorium nuclear reactor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>