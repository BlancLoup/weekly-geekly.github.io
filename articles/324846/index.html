<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We do a quick search on tours based on ClickHouse</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we will look at how to create a search for a database of tours (a tour of itself is a collection of a hotel and a flight) and conside...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We do a quick search on tours based on ClickHouse</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/626/562/a17/626562a17c194dcb84e075c423ef1003.png" align="right" width="320">  In this article, we will look at how to create a search for a database of tours (a tour of itself is a collection of a hotel and a flight) and consider two options - <a href="https://clickhouse.yandex/">ClickHouse</a> and MySQL (two engines - InnoDB and MyISAM). <br><br><h3>  What is the difficulty of searching for tours </h3><br>  Tour operators (TezTour, TUI, Natalie Tours, etc) sell their vouchers in an unobvious, at first glance, way: <br><br><ul><li>  A certain number of hotel rooms are reserved for a certain set of dates. </li><li>  Redeemed several aircraft. </li><li>  A new package of tours is issued, which contains combinations of all possible types of rooms, lengths of stay, cities and departure dates. </li></ul><br>  After that, such combinations (the number of which can amount to hundreds of millions or even billions) are searched.  An example of the search form can be seen in <a href="http://www.tez-tour.com/search.html">TezTour</a> - the user can select only one departure city, the type of accommodation and the country, and the user can select arbitrary parameters. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Despite the fact that the total number of tours (combinations) is in the hundreds of millions, for each fixed set of parameters (city of departure, type of accommodation, country) there are, in the worst case, tens of millions of options.  But even for such a number of tours it is not so easy to search, because you need to find records that meet free criteria that users specify, and sorting can be more or less arbitrary (as a rule, sorting is done by price, but this is not the only possible criterion ).  In this article, we will look at the simplified architecture of real-time search in MySQL and ClickHouse-based tours, without taking stops into account (a slang term that means that some options have run out of numbers or seats in the aircraft, and such tours should be excluded from the issue).  We will learn how to do a quick search and be able to show results with sorting by any field. <br><a name="habracut"></a><br><h3>  Where to get the data </h3><br>  Initially, I wanted to take a real base of some tour operator and load it as test data for our system - this would check the adequacy of our search by comparing our issuance and issuing a search on the tour operator‚Äôs website.  But, unfortunately, I did not manage to easily find a base of tours in the public domain, so instead I would have to limit myself to a set of pseudo-random data that will imitate real tours. <br><br><h3>  Fieldset </h3><br>  Since the search for a city, country, and type of accommodation is fixed, we can create tables with the names of the corresponding parameters, for example, tours_12_55_1001, where 12, 55 and 1001 are the IDs of the city, country and type of accommodation, respectively.  This allows us to dramatically reduce the number of records that we need to view and at the same time save space due to the fact that we will not store duplicate values ‚Äã‚Äãin tables. <br><br>  However, even for one such table there may be tens of millions of variants, and for the test sample we will generate exactly 10 million records with the following structure: <br><br><ul><li>  tour_id - uint64 - unique offer ID </li><li>  package_id - uint64 - ID of the corresponding package of tours (packages are added and revoked entirely) </li><li>  date_start - uint8 - arrival date - the number of days from a certain moment </li><li>  stars - uint8 - the number of stars near the hotel + special values, for example, for apartments </li><li>  pansion - uint8 - food type (Bed &amp; Breakfast, All Inclusive, etc) </li><li>  nights - uint8 - length of stay (number of nights) </li><li>  region_id - uint16 - hotel region ID </li><li>  hotel_id - uint32 - Hotel ID </li><li>  airport_id - uint8 - arrival airport ID </li><li>  price - uint16 - offer price, in dollars </li></ul><br>  For different countries and different tour operators, the list may differ (for example, the departure airport may also be present, or the price is in a different currency, and then it will not fit in uint16, etc.), but we will focus on this option as the most basic . <br><br>  The code for the generation is written in 10 minutes by any programmer, I will give an example on go: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"encoding/csv"</span></span> <span class="hljs-string"><span class="hljs-string">"flag"</span></span> <span class="hljs-string"><span class="hljs-string">"math/rand"</span></span> <span class="hljs-string"><span class="hljs-string">"os"</span></span> <span class="hljs-string"><span class="hljs-string">"strconv"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n = flag.Int(<span class="hljs-string"><span class="hljs-string">"n"</span></span>, <span class="hljs-number"><span class="hljs-number">10000000</span></span>, <span class="hljs-string"><span class="hljs-string">"How many entries to generate"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { wr := csv.NewWriter(os.Stdout) <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> wr.Flush() wr.Write([]<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{ <span class="hljs-string"><span class="hljs-string">"tour_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"package_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"date_start"</span></span>, <span class="hljs-string"><span class="hljs-string">"stars"</span></span>, <span class="hljs-string"><span class="hljs-string">"pansion"</span></span>, <span class="hljs-string"><span class="hljs-string">"nights"</span></span>, <span class="hljs-string"><span class="hljs-string">"region_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"hotel_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"airport_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"price"</span></span>, }) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; *n; i++ { wr.Write([]<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{ strconv.FormatInt(<span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>(i), <span class="hljs-number"><span class="hljs-number">10</span></span>), strconv.FormatInt(rand.Int63(), <span class="hljs-number"><span class="hljs-number">10</span></span>), strconv.FormatInt(rand.Int63n(<span class="hljs-number"><span class="hljs-number">90</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>), strconv.FormatInt(rand.Int63n(<span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>), strconv.FormatInt(rand.Int63n(<span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>), strconv.FormatInt(rand.Int63n(<span class="hljs-number"><span class="hljs-number">30</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>), strconv.FormatInt(rand.Int63n(<span class="hljs-number"><span class="hljs-number">1000</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>), strconv.FormatInt(rand.Int63n(<span class="hljs-number"><span class="hljs-number">1000000</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>), strconv.FormatInt(rand.Int63n(<span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>), strconv.FormatInt(rand.Int63n(<span class="hljs-number"><span class="hljs-number">10000</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>), }) } }</code> </pre> <br></div></div><br>  The received csv-file occupies about 500 MB and contains 10 million records in which tour_id monotonously increases, and the remaining fields have random values ‚Äã‚Äãin more or less approximate to reality ranges. <br><br><h3>  Search criteria </h3><br>  We need to be able to search for any sets of values ‚Äã‚Äãfor each of the fields and with any sorting, but, as a rule, the ranges of departure dates and duration are not very wide - people rarely look for tours with a range of departure dates, for example, from March 1 to May 1 .  We can assume that a search with a wide range of departure dates should also work, but optimize the response time and resource consumption is needed for the case when this range is significantly limited, for example, averages no more than 10 days.  This knowledge is useful to us when choosing indices. <br><br><h3>  MySQL implementation </h3><br>  I chose MySQL because I am well acquainted with this database, and also because it is relatively well suited for this task. <br><br>  Let's try to use 3 slightly different approaches: simple InnoDB, InnoDB + primary key (date_start, id) and MyISAM.  The structure of the table will be the same for all 3 approaches and the differences will be only in the engine and in what indexes we impose: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`tours`</span></span> ( <span class="hljs-string"><span class="hljs-string">`tour_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`package_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`date_start`</span></span> tinyint(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`stars`</span></span> tinyint(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`pansion`</span></span> tinyint(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`nights`</span></span> tinyint(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`region_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`hotel_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`airport_id`</span></span> tinyint(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`price`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> )</code> </pre><br><h3>  InnoDB </h3><br>  First, try using the standard InnoDB engine with standard indexes - <code>PRIMARY KEY (`tour_id`), KEY `date_start` (`date_start`)</code> .  The key for date_start is to speed up sampling over the range of departure dates, and PRIMARY KEY tour_id is made with the expectation that tour_id increases monotonically, which should give us the optimal insertion speed. <br><br>  Let's insert our data into the default installation of MySQL 5.7.17 (innodb_buffer_pool_size = 128 MB, the rest of the settings, see under the spoiler): <br><br><div class="spoiler">  <b class="spoiler_title">Default innodb settings</b> <div class="spoiler_text">  innodb_adaptive_flushing ON <br>  innodb_adaptive_flushing_lwm 10 <br>  innodb_adaptive_hash_index ON <br>  innodb_adaptive_hash_index_parts 8 <br>  innodb_adaptive_max_sleep_delay 150000 <br>  innodb_api_bk_commit_interval 5 <br>  innodb_api_disable_rowlock OFF <br>  innodb_api_enable_binlog OFF <br>  innodb_api_enable_mdl OFF <br>  innodb_api_trx_level 0 <br>  innodb_autoextend_increment 64 <br>  innodb_autoinc_lock_mode 1 <br>  innodb_buffer_pool_chunk_size 134217728 <br>  innodb_buffer_pool_dump_at_shutdown ON <br>  innodb_buffer_pool_dump_now OFF <br>  innodb_buffer_pool_dump_pct 25 <br>  innodb_buffer_pool_filename ib_buffer_pool <br>  innodb_buffer_pool_instances 1 <br>  innodb_buffer_pool_load_abort OFF <br>  innodb_buffer_pool_load_at_startup ON <br>  innodb_buffer_pool_load_now OFF <br>  innodb_buffer_pool_size 134217728 <br>  innodb_change_buffer_max_size 25 <br>  innodb_change_buffering all <br>  innodb_checksum_algorithm crc32 <br>  innodb_checksums ON <br>  innodb_cmp_per_index_enabled OFF <br>  innodb_commit_concurrency 0 <br>  innodb_compression_failure_threshold_pct 5 <br>  innodb_compression_level 6 <br>  innodb_compression_pad_pct_max 50 <br>  innodb_concurrency_tickets 5000 <br>  innodb_data_file_path ibdata1: 12M: autoextend <br>  innodb_data_home_dir <br>  innodb_deadlock_detect ON <br>  innodb_default_row_format dynamic <br>  innodb_disable_sort_file_cache OFF <br>  innodb_doublewrite ON <br>  innodb_fast_shutdown 1 <br>  innodb_file_format Barracuda <br>  innodb_file_format_check ON <br>  innodb_file_format_max Barracuda <br>  innodb_file_per_table ON <br>  innodb_fill_factor 100 <br>  innodb_flush_log_at_timeout 1 <br>  innodb_flush_log_at_trx_commit 1 <br>  innodb_flush_method <br>  innodb_flush_neighbors 1 <br>  innodb_flush_sync ON <br>  innodb_flushing_avg_loops 30 <br>  innodb_force_load_corrupted OFF <br>  innodb_force_recovery 0 <br>  innodb_ft_aux_table <br>  innodb_ft_cache_size 8000000 <br>  innodb_ft_enable_diag_print OFF <br>  innodb_ft_enable_stopword ON <br>  innodb_ft_max_token_size 84 <br>  innodb_ft_min_token_size 3 <br>  innodb_ft_num_word_optimize 2000 <br>  innodb_ft_result_cache_limit 2000000000 <br>  innodb_ft_server_stopword_table <br>  innodb_ft_sort_pll_degree 2 <br>  innodb_ft_total_cache_size 640000000 <br>  innodb_ft_user_stopword_table <br>  innodb_io_capacity 200 <br>  innodb_io_capacity_max 2000 <br>  innodb_large_prefix ON <br>  innodb_lock_wait_timeout 50 <br>  innodb_locks_unsafe_for_binlog OFF <br>  innodb_log_buffer_size 16777216 <br>  innodb_log_checksums ON <br>  innodb_log_compressed_pages ON <br>  innodb_log_file_size 50331648 <br>  innodb_log_files_in_group 2 <br>  innodb_log_group_home_dir ./ <br>  innodb_log_write_ahead_size 8192 <br>  innodb_lru_scan_depth 1024 <br>  innodb_max_dirty_pages_pct 75.000000 <br>  innodb_max_dirty_pages_pct_lwm 0.000000 <br>  innodb_max_purge_lag 0 <br>  innodb_max_purge_lag_delay 0 <br>  innodb_max_undo_log_size 1073741824 <br>  innodb_monitor_disable <br>  innodb_monitor_enable <br>  innodb_monitor_reset <br>  innodb_monitor_reset_all <br>  innodb_old_blocks_pct 37 <br>  innodb_old_blocks_time 1000 <br>  innodb_online_alter_log_max_size 134217728 <br>  innodb_open_files 2000 <br>  innodb_optimize_fulltext_only OFF <br>  innodb_page_cleaners 1 <br>  innodb_page_size 16384 <br>  innodb_print_all_deadlocks OFF <br>  innodb_purge_batch_size 300 <br>  innodb_purge_rseg_truncate_frequency 128 <br>  innodb_purge_threads 4 <br>  innodb_random_read_ahead OFF <br>  innodb_read_ahead_threshold 56 <br>  innodb_read_io_threads 4 <br>  innodb_read_only OFF <br>  innodb_replication_delay 0 <br>  innodb_rollback_on_timeout OFF <br>  innodb_rollback_segments 128 <br>  innodb_sort_buffer_size 1048576 <br>  innodb_spin_wait_delay 6 <br>  innodb_stats_auto_recalc ON <br>  innodb_stats_include_delete_marked OFF <br>  innodb_stats_method nulls_equal <br>  innodb_stats_on_metadata OFF <br>  innodb_stats_persistent ON <br>  innodb_stats_persistent_sample_pages 20 <br>  innodb_stats_sample_pages 8 <br>  innodb_stats_transient_sample_pages 8 <br>  innodb_status_output OFF <br>  innodb_status_output_locks OFF <br>  innodb_strict_mode ON <br>  innodb_support_xa ON <br>  innodb_sync_array_size 1 <br>  innodb_sync_spin_loops 30 <br>  innodb_table_locks ON <br>  innodb_temp_data_file_path ibtmp1: 12M: autoextend <br>  innodb_thread_concurrency 0 <br>  innodb_thread_sleep_delay 10000 <br>  innodb_tmpdir <br>  innodb_undo_directory ./ <br>  innodb_undo_log_truncate OFF <br>  innodb_undo_logs 128 <br>  innodb_undo_tablespaces 0 <br>  innodb_use_native_aio OFF <br>  innodb_version 5.7.17 <br>  innodb_write_io_threads 4 <br></div></div><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATA</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INFILE</span></span> <span class="hljs-string"><span class="hljs-string">'tours.csv'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> tours <span class="hljs-keyword"><span class="hljs-keyword">FIELDS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TERMINATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">','</span></span></code> </pre> <br>  During the upload, make sure that the MySQL server is the bottleneck, not the client (the client‚Äôs CPU usage should not be 100%) and look at the query execution time: <br><br><pre> <code class="hljs matlab">Query OK, <span class="hljs-number"><span class="hljs-number">10000000</span></span> rows affected, <span class="hljs-number"><span class="hljs-number">11</span></span> warnings (<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">min</span></span> <span class="hljs-number"><span class="hljs-number">35.09</span></span> <span class="hljs-built_in"><span class="hljs-built_in">sec</span></span>) Records: <span class="hljs-number"><span class="hljs-number">10000001</span></span> Deleted: <span class="hljs-number"><span class="hljs-number">0</span></span> Skipped: <span class="hljs-number"><span class="hljs-number">1</span></span> Warnings: <span class="hljs-number"><span class="hljs-number">11</span></span></code> </pre> <br>  It seems that 1.5 minutes to insert 10 million entries is ok for InnoDB.  Vorningi belong to the first line in the CSV-file, because the column names are written there. <br><br>  The resulting table size is 490 MB of data and 162 MB of indices.  In the process of executing the query, MySQL wrote 3.5 GB onto the disk and the CPU load was around 100% (1 of 4 cores were utilized on a test laptop). <br><br>  Before you do a search query, let's look at other possible data insertion options. <br><br><h3>  InnoDB + PRIMARY KEY (date_start, tour_id) </h3><br>  Since we know in advance that most requests will affect only a relatively small range of departure dates, you can cluster data by departure date instead of tour_id ‚Äî in this case, reading over the date_start range will give less random reading from the disk (or from buffer_pool), which means searching by such a table should be faster. <br><br>  Let's see how things go with the insert: <br><br><pre> <code class="hljs matlab">Query OK, <span class="hljs-number"><span class="hljs-number">10000001</span></span> rows affected, <span class="hljs-number"><span class="hljs-number">10</span></span> warnings (<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">min</span></span> <span class="hljs-number"><span class="hljs-number">13.34</span></span> <span class="hljs-built_in"><span class="hljs-built_in">sec</span></span>) Records: <span class="hljs-number"><span class="hljs-number">10000001</span></span> Deleted: <span class="hljs-number"><span class="hljs-number">0</span></span> Skipped: <span class="hljs-number"><span class="hljs-number">0</span></span> Warnings: <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br>  Contrary to expectations, inserting into such a table went even a little faster than into the ‚Äúnormal‚Äù structure.  This is probably due to the fact that we do not have an "extra" index on date_start, and it is included in the PRIMARY KEY.  The disc was recorded slightly less than last time - only 3 GB. <br><br>  The size of the table is 538 MB of data and 0 MB of index (there are no secondary indexes, and the PRIMARY KEY is recorded as part of the data in InnoDB) <br><br><h3>  MyISAM </h3><br>  In past years, MyISAM was the default engine in MySQL and was famous for its speed of insertion and execution of FULL SCAN.  What is not an ideal candidate for our task?  The structure of the table remains the same as in the case of the first InnoDB variant. <br><br><pre> <code class="hljs pgsql">Query OK, <span class="hljs-number"><span class="hljs-number">10000000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> affected, <span class="hljs-number"><span class="hljs-number">11</span></span> warnings (<span class="hljs-number"><span class="hljs-number">40.39</span></span> sec) Records: <span class="hljs-number"><span class="hljs-number">10000001</span></span> Deleted: <span class="hljs-number"><span class="hljs-number">0</span></span> Skipped: <span class="hljs-number"><span class="hljs-number">1</span></span> Warnings: <span class="hljs-number"><span class="hljs-number">11</span></span></code> </pre> <br>  The result is definitely better, although not by an order of magnitude.  Tuning settings can achieve better results for both MyISAM and InnoDB, but this is a topic for a separate large article.  350 MB was recorded on the disk, and the size of the table was 286 MB of data + 205 MB of index.  Why, according to the instruments, the disc was written less than the size of the table in MyISAM, I could not understand.  The reader can try to reproduce the experiment on his MySQL instance and compare the numbers. <br><br><h3>  Clickhouse </h3><br>  Well, the last option will be a database from Yandex called <a href="https://clickhouse.yandex/">ClickHouse</a> .  This is a column database with automatic parallelization of queries and a bunch of other nishtyakov.  There are binary builds for Linux and even Docker-containers and macOS support is claimed.  I could not find any binary builds for macOS, so I assembled and laid out: <a href="https://yadi.sk/d/RffdbxaM3GL7Ac">yadi.sk/d/RffdbxaM3GL7Ac</a> (the build requires gcc-6, several dozen gigabytes of space and about 2 hours on my laptop).  Tests I will drive on macOS. <br><br>  First create a table: <br><br><pre> <code class="hljs objectivec">CREATE TABLE tours ( tour_id <span class="hljs-built_in"><span class="hljs-built_in">UInt64</span></span>, package_id <span class="hljs-built_in"><span class="hljs-built_in">UInt64</span></span>, date_start <span class="hljs-built_in"><span class="hljs-built_in">UInt8</span></span>, stars <span class="hljs-built_in"><span class="hljs-built_in">UInt8</span></span>, pansion <span class="hljs-built_in"><span class="hljs-built_in">UInt8</span></span>, nights <span class="hljs-built_in"><span class="hljs-built_in">UInt8</span></span>, region_id <span class="hljs-built_in"><span class="hljs-built_in">UInt16</span></span>, hotel_id <span class="hljs-built_in"><span class="hljs-built_in">UInt32</span></span>, airport_id <span class="hljs-built_in"><span class="hljs-built_in">UInt8</span></span>, price <span class="hljs-built_in"><span class="hljs-built_in">UInt16</span></span>, date Date MATERIALIZED toDate(date_start) ) ENGINE = MergeTree(date, date_start, <span class="hljs-number"><span class="hljs-number">8192</span></span>)</code> </pre><br>  When creating a table of type MergeTree (recommended by default), you need to specify a column with a date (it is sharding).  Here I was a bit lazy and just made a MATERIALIZED date column with the value toDate (date_start).  In real data, it will be much easier to simply make a date_start column with a Date type - in clickhouse, the date does not take up much space due to column compression. <br><br><h3>  ClickHouse, insert data </h3><br>  Now insert the data: <br><br><pre> <code class="hljs ruby">$ cat tours.csv <span class="hljs-params"><span class="hljs-params">| pv |</span></span> clickhouse --client --query <span class="hljs-string"><span class="hljs-string">'INSERT INTO tours FORMAT CSVWithNames'</span></span> <span class="hljs-number"><span class="hljs-number">524</span></span>MiB <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">04</span></span> [ <span class="hljs-number"><span class="hljs-number">123</span></span>MiB/s]</code> </pre> <br>  If you have not yet installed the pv utility, I recommend to install it, it allows you to print the progress of execution of operations and shows how many bytes passed through the pipe. <br><br>  You can see that the insertion of the csv-file occurred in 4 seconds with an insertion speed of about 100 MB / s (as stated by the authors).  When inserted, the server spent 7 seconds of CPU time. <br><br>  The size of the data is 378 MB, and 378 MB was also recorded on the disk (apparently, the entire volume was sorted in memory and recorded in one piece). <br><br>  Unfortunately, since our test data is random, we did not manage to get significant benefits from column compression.  Real data should compress better, so the final size should be even smaller. <br><br><h3>  Data insertion times, comparison </h3><br>  Let's collect all inserts in one table: <br><table><tbody><tr><th>  Method </th><th>  Time </th><th>  Size table </th><th>  Written to disk </th></tr><tr><td>  InnoDB </td><td>  95 seconds </td><td>  652 MB </td><td>  3.5 GB </td></tr><tr><td>  InnoDB + PK </td><td>  73 seconds </td><td>  538 MB </td><td>  3.0 GB </td></tr><tr><td>  MyISAM </td><td>  40 seconds </td><td>  491 MB </td><td>  350 MB? </td></tr><tr><td>  Clickhouse </td><td>  4 seconds </td><td>  378 MB </td><td>  378 MB </td></tr></tbody></table><br><h3>  Sample </h3><br>  We will make several samples that correspond to more or less truthful types of queries that come in the search for tours: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- 1. ¬´ ¬ª SELECT * FROM tours ORDER BY price ASC LIMIT 20; -- 2. ¬´ ¬ª   10  (1/9  ) SELECT * FROM tours WHERE date_start BETWEEN 40 AND 50 ORDER BY price ASC LIMIT 20; -- 3. 5     500  600  SELECT * FROM tours WHERE nights = 5 AND price BETWEEN 500 AND 600 ORDER BY price ASC LIMIT 20; -- 4.   500  600 ,      SELECT * FROM tours WHERE price BETWEEN 500 AND 600 ORDER BY nights DESC, stars DESC LIMIT 20; -- 5.      SELECT * FROM tours WHERE date_start BETWEEN 10 AND 20 AND hotel_id = 767036 ORDER BY price LIMIT 20;</span></span></code> </pre><br>  For MyISAM, the request times are shown in parentheses if IGNORE INDEX (date_start) is specified. <br>  For ClickHouse, the brackets indicate the request times, if you choose not *, but only tour_id and price. <br><br>  So, the results: <br><table><tbody><tr><th>  Method </th><th>  1 ms </th><th>  2 ms </th><th>  3 ms </th><th>  4 ms </th><th>  5 ms </th></tr><tr><td>  <b>InnoDB</b> </td><td>  4300 </td><td>  <b>3800</b> </td><td>  3800 </td><td>  3800 </td><td>  3700 </td></tr><tr><td>  <b>InnoDB + PK</b> </td><td>  4600 </td><td>  <b>600</b> </td><td>  4,000 </td><td>  4,000 </td><td>  <b>540</b> </td></tr><tr><td>  <b>MyISAM</b> </td><td>  1300 </td><td>  <b>1600</b> (1000) </td><td>  800 </td><td>  700 </td><td>  1500 (670) </td></tr><tr><td>  <b>Clickhouse</b> </td><td>  120 (40) </td><td>  40 (14) </td><td>  150 (54) </td><td>  180 (80) </td><td>  14 (8) </td></tr></tbody></table><br>  And the same with the cold cache (on the laptop SSD): <br><table><tbody><tr><th>  Method </th><th>  1 ms </th><th>  2 ms </th><th>  3 ms </th><th>  4 ms </th><th>  5 ms </th></tr><tr><td>  <b>InnoDB</b> </td><td>  5500 </td><td>  5000 </td><td>  4800 </td><td>  4700 </td><td>  4700 </td></tr><tr><td>  <b>InnoDB + PK</b> </td><td>  <b>12,700</b> </td><td>  1960 </td><td>  <b>12,100</b> </td><td>  12,000 </td><td>  1720 </td></tr><tr><td>  <b>MyISAM</b> </td><td>  <b>14800</b> (1060) </td><td>  800 </td><td>  920 </td><td>  799 </td><td>  14900 (767) </td></tr><tr><td>  <b>Clickhouse</b> </td><td>  570 (188) </td><td>  177 (90) </td><td>  591 (224) </td><td>  608 (254) </td><td>  122 (55) </td></tr></tbody></table><br><h3>  Analysis </h3><br>  You can see that, without tuning, MyISAM is best suited for MySQL, and the index on date_start only makes us worse, especially in the case of a cold cache (this is because MyISAM doesn‚Äôt get random access to the rows too efficiently - it‚Äôs always read one by one a line with the read () system call, which in the case of a cold cache has disastrous consequences even on SSD).  Some queries are better executed faster on the InnoDB + PK scheme, but only on the heated cache.  In the case of a cold start, MyISAM is much more preferable, and without an index on date_start (you can instead spread the table over date ranges and start queries in parallel). <br><br>  Since ClickHouse is a column base, a query of the SELECT * type is not very convenient for it ‚Äî this can be seen from the query execution time.  If possible, you need to select only those columns that are needed (meta-information for tour_id should in any case be duplicated somewhere else in a safe repository, and you can get it from there instead of sampling directly from ClickHouse).  Also, ClickHouse automatically parallels the execution of requests for all available cores, and also scans only the necessary columns, so it works very quickly when the cache is hot.  In the case of a cold start, it is especially noticeable, why it is preferable to choose not all columns, but only the necessary ones. <br><br>  However, even with a cold start, ClickHouse leads in the execution time of requests in all cases, without exception. <br><br><h3>  Conclusion </h3><br>  In this article, we built a simplified model for searching by tours, excluding stops, based on MySQL (3 different approaches) and ClickHouse, and in all cases the database from Yandex showed a significant advantage in speed, sometimes by 2-3 orders of magnitude. <br><br>  I hope this article will help speed up and cheapen the search for those who do a tour search, as well as provide a basic understanding of what tasks ClickHouse is suitable for.  Thank you for reading to the end, I will be glad to hear comments. <br><br>  <b>Ps</b> .  If you can use MySQL and ClickHouse to make the results better and publish your benchmarks, please write in the comments, this will be a useful addition to the article, since my figures are only approximate, and the correct settings can change the results several times for some types of queries. <br><br><h3>  Links </h3><br><ol><li>  <a href="https://clickhouse.yandex/">Clickhouse</a> </li><li>  <a href="https://github.com/YuriyNasretdinov/tour-generator">Tour Data Generator</a> </li><li>  <a href="https://yadi.sk/d/RffdbxaM3GL7Ac">ClickHouse binaries compiled under macOS</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/324846/">https://habr.com/ru/post/324846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324824/index.html">IT tablets</a></li>
<li><a href="../324826/index.html">Weekend project by IBM employee and his son: Havyn's cybersecurity virtual assistant</a></li>
<li><a href="../324830/index.html">What's wrong with Mass Effect: Andromeda animations?</a></li>
<li><a href="../324840/index.html">DIY Robot Vacuum Cleaner - Part 2</a></li>
<li><a href="../324844/index.html">How much does a DDoS build? Counting the cost of DDoS attacks</a></li>
<li><a href="../324848/index.html">Top 7 DDoS Protection Services for Better Security</a></li>
<li><a href="../324850/index.html">Make your game easy? Or why dreams often remain dreams</a></li>
<li><a href="../324852/index.html">Pygest # 6. Releases, articles, interesting projects from the world of Python [March 14, 2017 - March 27, 2017]</a></li>
<li><a href="../324854/index.html">How to escape from the plane: a review of the book "Presentation of Information" by Edward Tufti (1990)</a></li>
<li><a href="../324856/index.html">The Pitch Canvas - template for short presentations.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>