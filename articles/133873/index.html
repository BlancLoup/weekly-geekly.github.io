<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The notification from Nagios by phone through Asterisk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I read the Google translate + Asterisk IVR article yesterday and thought, ‚ÄúCool! You can use it to quickly create sound files when making new hosts an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The notification from Nagios by phone through Asterisk</h1><div class="post__text post__text-html js-mediator-article">  I read the <a href="http://habrahabr.ru/blogs/sysadm/133782/">Google translate + Asterisk IVR</a> article yesterday and thought, ‚ÄúCool!  You can use it to quickly create sound files when making new hosts and services in Nagios! ‚Äù. <br><br>  Then I wondered if it was described somewhere how to set up phone alerts for Nagios?  Googling a bit I found a couple of articles, read them and realized that the solutions described there have a number of drawbacks: <ul><li>  Nagios and Asterisk must be installed on the same server. </li><li>  Requires local installation of the engine for speech synthesis. </li><li>  The admin phone is ‚Äúsewn up‚Äù in the script and it receives ALL notifications. </li></ul>  So I decided to share my decision, which I have been using for more than a year. <a name="habracut"></a>  In general, the solution is as follows.  In Nagios, <i>contact</i> objects are created with the phone number in the pager parameter and the <i>notify-by-phone</i> and <i>host-notify-by-phone</i> <i>commands</i> that run the <i>/etc/nagios3/notify_by_phone.sh</i> script with the parameters to whom to call and which service has dropped.  The script, in turn, via ssh sends the parameters to the Asterisk server. <br><br>  On the Asterisk side, instead of the BESH, the <i>/etc/asterisk/call_from_nagios.sh</i> script is <i>run</i> , which generates the <i>call files</i> for Asterisk with a variable containing a list of phrases to be voiced.  Here, in general, and everything, then it is described in detail. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will not describe here the installation process of Nagios and Asterisk, suppose that both of these services already work for you.  Let's start with the Asterisk server part.  Create the <i>/etc/asterisk/call_from_nagios.sh</i> script: <br><pre><code class="hljs kotlin">#!/bin/bash <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>=`cat &lt;&amp;<span class="hljs-number"><span class="hljs-number">0</span></span>` _TMP=/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/tmp callfile=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${_TMP}</span></span></span><span class="hljs-string">/nag_callfile_$$"</span></span> echo <span class="hljs-string"><span class="hljs-string">"`date '+%Y.%m.%d %H:%M:%S'` </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${data}</span></span></span><span class="hljs-string">"</span></span> &gt;&gt; ${_TMP}/nag.log number=`echo <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${data}</span></span></span><span class="hljs-string">"</span></span> | cut -f <span class="hljs-number"><span class="hljs-number">1</span></span> -d <span class="hljs-string"><span class="hljs-string">" "</span></span>` <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>=`echo ${<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>} | cut -f <span class="hljs-number"><span class="hljs-number">1</span></span> -d <span class="hljs-string"><span class="hljs-string">":"</span></span> | cut -d <span class="hljs-string"><span class="hljs-string">" "</span></span> -f <span class="hljs-number"><span class="hljs-number">2</span></span>-<span class="hljs-number"><span class="hljs-number">100</span></span> | tr <span class="hljs-string"><span class="hljs-string">"[:upper:]"</span></span> <span class="hljs-string"><span class="hljs-string">"[:lower:]"</span></span> | sed <span class="hljs-string"><span class="hljs-string">'s/ /\&amp;/g'</span></span> ` echo <span class="hljs-string"><span class="hljs-string">"Channel: Local/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${number}</span></span></span><span class="hljs-string">@from-internal Context: custom-nagios-say Extension: s Priority: 1 MaxRetries: 0 WaitTime: 40 Setvar: play=</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${data}</span></span></span><span class="hljs-string"> Account: NAGIOS CallerId: \"NAGIOS\" &lt;168&gt; "</span></span> &gt; $callfile chmod <span class="hljs-number"><span class="hljs-number">666</span></span> $callfile mv $callfile /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/spool/asterisk/outgoing/</code> </pre> <br>  Create a context in <i>extensions.conf</i> : <br><pre> <code class="hljs php">[custom-nagios-say] exten =&gt; s,<span class="hljs-number"><span class="hljs-number">1</span></span>,Answer() exten =&gt; s,n,Wait(<span class="hljs-number"><span class="hljs-number">1</span></span>) exten =&gt; s,n,Set(CHANNEL(language)=nag) exten =&gt; s,n,Playback(intro) exten =&gt; s,n,Playback(${play}) exten =&gt; s,n,Playback(${play}) exten =&gt; s,n,Playback(end) exten =&gt; s,n,Hangup()</code> </pre>  Create the <i>/ var / lib / asterisk / sounds / nag /</i> directory and put the following files into it: <br>  critical.mp3 - critical <br>  down.mp3 - not available <br>  end.mp3 - detailed information by email <br>  host.mp3 - server <br>  intro.mp3 - attention! <br>  problem.mp3 - problem <br>  service.mp3 - service <br>  status.mp3 - status <br>  warning.mp3 - warning <br>  As well as the names of servers and services.  The files themselves can be voiced by your voice or by the method described in the topic, which led me to the idea of ‚Äã‚Äãthis article: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">wget</span></span> -U <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.1.5) Gecko/20091102 Firefox/3.5.5"</span></span> <span class="hljs-string"><span class="hljs-string">"http://translate.google.com/translate_tts?q=&amp;tl=ru"</span></span> -O host.mp3</code> </pre>  Then there are two options: install the format_mp3 module in Asterisk or convert each file into a digestible asterisk format.  I preferred the first method, but for an example I will give the command for conversion: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">sox</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.mp3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r</span></span> 8000 <span class="hljs-selector-tag"><span class="hljs-selector-tag">-c</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wav</span></span></code> </pre>  Now you can run a test call with the command: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">echo</span></span> <span class="hljs-string"><span class="hljs-string">"168 PROBLEM Host ISP status DOWN"</span></span> | /etc/asterisk/call_from_nagios.sh</code> </pre>  After you caught all the shoals and got a call and pronouncing ‚ÄúAttention!  Problem.  Host - Internet service provider.  Status is unavailable, you can go to the next step and prepare the possibility of receiving alerts via ssh. <br><br>  We generate a separate ssh certificate without passphrase: <br><pre> <code class="hljs">ssh-keygen -t rsa -b 4096</code> </pre>  Now add the contents of <i>id_rsa.pub</i> to <i>/root/.ssh/authorized_keys</i> and add the <i>command</i> parameter to the beginning of the line.  Do not forget to do <br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">chmod</span></span> <span class="hljs-number"><span class="hljs-number">600</span></span> /root/.ssh/authorized_keys</code> </pre>  The file will look like this: <br><pre> <code class="hljs scala">command=<span class="hljs-string"><span class="hljs-string">"/etc/asterisk/call_from_nagios.sh"</span></span> ssh-rsa <span class="hljs-type"><span class="hljs-type">AAAAB3N</span></span><span class="hljs-type"><span class="hljs-type">A0PCGAC</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>kZU= root<span class="hljs-meta"><span class="hljs-meta">@nagios</span></span></code> </pre>  Again, check the next command and go on. <br><pre> <code class="hljs matlab">echo <span class="hljs-string"><span class="hljs-string">"168 PROBLEM Host ISP status DOWN"</span></span> | ssh -l root -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> id_rsa localhost</code> </pre><br>  Now let's work with the Nagios server.  Suppose we have some contact: <br><pre> <code class="hljs pgsql">define contact{ contact_name vasea <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Vasea Pupkin service_notification_period <span class="hljs-number"><span class="hljs-number">24</span></span>x7 host_notification_period <span class="hljs-number"><span class="hljs-number">24</span></span>x7 service_notification_options w,u,c,r host_notification_options d,r service_notification_commands <span class="hljs-keyword"><span class="hljs-keyword">notify</span></span>-service-<span class="hljs-keyword"><span class="hljs-keyword">by</span></span>-email host_notification_commands <span class="hljs-keyword"><span class="hljs-keyword">notify</span></span>-host-<span class="hljs-keyword"><span class="hljs-keyword">by</span></span>-email email vasea@mydoamin.ru }</code> </pre>  Copy it and modify it a bit: <br><pre> <code class="hljs pgsql">define contact{ contact_name vasea_phone <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Vasea Pupkin phone service_notification_period dayhours host_notification_period dayhours service_notification_options w,c,r host_notification_options d,r service_notification_commands <span class="hljs-keyword"><span class="hljs-keyword">notify</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">by</span></span>-phone host_notification_commands host-<span class="hljs-keyword"><span class="hljs-keyword">notify</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">by</span></span>-phone pager <span class="hljs-number"><span class="hljs-number">163</span></span> }</code> </pre>  Here I replaced the notification period with a <i>daytime</i> (previously described with the directive <i>define timeperiod</i> ), which corresponds to the time from 7 to 22 o'clock.  If Vasya is ready to receive calls at night, you can leave 24x7.  Well, in fact, I added the phone number 168. I use the internal phones, and the redirection to the mobile is already configured in the asterisk itself.  But, in principle, you can immediately specify the mobile number. <br><br>  We add the vasea_phone contact to the list of responsible persons for the corresponding service or to the corresponding <i>contactgroup</i> .  Further we create teams: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">define</span></span> command{ <span class="hljs-attribute"><span class="hljs-attribute">command_name</span></span> notify-by-phone command_line [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NOTIFICATIONTYPE</span></span></span><span class="hljs-string">$"</span></span> = <span class="hljs-string"><span class="hljs-string">"PROBLEM"</span></span> ] &amp;&amp; /etc/nagios3/notify_by_phone.sh <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CONTACTPAGER</span></span></span><span class="hljs-string">$ </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NOTIFICATIONTYPE</span></span></span><span class="hljs-string">$ Host </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOSTNAME</span></span></span><span class="hljs-string">$ Service </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SERVICEDESC</span></span></span><span class="hljs-string">$ status </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SERVICESTATE</span></span></span><span class="hljs-string">$ : </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SERVICEOUTPUT</span></span></span><span class="hljs-string">$"</span></span> } define command{ <span class="hljs-attribute"><span class="hljs-attribute">command_name</span></span> host-notify-by-phone command_line [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NOTIFICATIONTYPE</span></span></span><span class="hljs-string">$"</span></span> = <span class="hljs-string"><span class="hljs-string">"PROBLEM"</span></span> ] &amp;&amp; /etc/nagios3/notify_by_phone.sh <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CONTACTPAGER</span></span></span><span class="hljs-string">$ </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$NOTIFICATIONTYPE</span></span></span><span class="hljs-string">$ Host </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOSTNAME</span></span></span><span class="hljs-string">$ status </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOSTSTATE</span></span></span><span class="hljs-string">$ : </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOSTOUTPUT</span></span></span><span class="hljs-string">$"</span></span> }</code> </pre>  And the script itself <i>/etc/nagios3/notify_by_phone.sh read as</i> follows: <br><pre> <code class="hljs kotlin">#!/bin/bash <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>=$@ date=`/bin/date <span class="hljs-string"><span class="hljs-string">'+%Y.%m.%d %H:%M:%S'</span></span>` echo <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${date}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${data}</span></span></span><span class="hljs-string">"</span></span> &gt;&gt; /tmp/nag.log echo <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${data}</span></span></span><span class="hljs-string">"</span></span> | ssh -i /etc/nagios3/id_rsa <span class="hljs-symbol"><span class="hljs-symbol">root@</span></span><span class="hljs-number"><span class="hljs-number">10.1</span></span>.5.61</code> </pre>  10.1.5.61 is the IP address of my Asterisk server.  And the file <i>/ etc / nagios3 / id_rsa</i> is the one that we generated on the Asterisk server.  The first time you connect to a new ssh server, it asks for confirmation before entering its fingerprint into known_hosts.  Therefore, we need to become a nagios user (if the Nagios daemon is working under this user, this is usually the case) and manually run the <i>/etc/nagios3/notify_by_phone.sh</i> script: <br><pre> <code class="hljs lua">su - nagios /etc/nagios3/notify_by_phone.sh <span class="hljs-number"><span class="hljs-number">168</span></span> PROBLEM Host ISP <span class="hljs-built_in"><span class="hljs-built_in">status</span></span> DOWN</code> </pre>  Before that, you may need to replace <i>/ bin / false</i> with <i>/ bin / bash</i> in <i>/ etc / password</i> for user nagios.  After executing the above command, it can be returned. <br><br>  That's all!  Maybe some details I missed.  If so - write in the comments and I will update the article. <br><br>  Now you will be the first to know that a problem has arisen and to fix it before any of the clients or management noticed it. </div><p>Source: <a href="https://habr.com/ru/post/133873/">https://habr.com/ru/post/133873/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133864/index.html">The evening school of Windows Phone returns in a new format</a></li>
<li><a href="../133866/index.html">Report on the First Kiev Habravstreche</a></li>
<li><a href="../133869/index.html">Synthesis and Speech Recognition from Google for Asterisk</a></li>
<li><a href="../133870/index.html">Canobuvosti, 120th edition</a></li>
<li><a href="../133871/index.html">FPGA programming. The study of the phenomenon of "bounce of contacts" and the method of getting rid of it</a></li>
<li><a href="../133874/index.html">Electronic cards for citizens of the Russian Federation</a></li>
<li><a href="../133875/index.html">Reduced matrix multiplication exponent</a></li>
<li><a href="../133876/index.html">Red Hat, HP and the new virtualization speed record</a></li>
<li><a href="../133877/index.html">From Google+ Hangouts you can now make calls to phone numbers.</a></li>
<li><a href="../133878/index.html">Sony made its own Holodeck</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>