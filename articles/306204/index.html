<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Compare the implementation of the languages ‚Äã‚Äãof Python and Ruby by the density of errors</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Which programming language to start learning: Python or Ruby? Which one is better? Django or Ruby on Rails? Such questions can often be found in IT fo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Compare the implementation of the languages ‚Äã‚Äãof Python and Ruby by the density of errors</h1><div class="post__text post__text-html js-mediator-article">  Which programming language to start learning: Python or Ruby?  Which one is better?  Django or Ruby on Rails?  Such questions can often be found in IT forums around the world.  I propose to compare not the languages ‚Äã‚Äãthemselves, but their reference implementations: CPython and MRI.  About what errors in their interpreters could be found by PVS-Studio, and will be discussed in this article. <br><br><img src="https://habrastorage.org/files/600/377/31a/60037731a3ee4b1481dee18f380705ad.png"><br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Introduction </h2><br>  The latest sources from the main repositories ( <a href="https://github.com/ruby/ruby">Ruby</a> , <a href="https://hg.python.org/cpython">Python</a> ) were taken for analysis.  The check was performed using the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> static code analyzer version 6.06.  Python is great at Visual Studio, and for Ruby you can use the Standalone version in compiler call monitoring mode. <br><br>  There were not so many overt errors in the projects: most of the positives are related to the use of macros, which are revealed to extremely suspicious code from the point of view of the analyzer, but harmless from the point of view of the developer.  You can debate for a long time on whether macros are evil or not, but you can say for sure that the analyzer does not like them.  To get rid of some annoying macro, there is an option to suppress false positives.  It is enough to write: <br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//-V:RB_TYPE_P:501</span></span></code> </pre> <br>  And all the V501 diagnostic triggers, in which the <i>RB_TYPE_P</i> macro <i>appears,</i> will disappear. <br><br><h2>  Python </h2><br><img src="https://habrastorage.org/files/571/dfc/bac/571dfcbac6e44ab29562bc3595f9e85d.png"><br><br><h3>  Fragment N1 </h3><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> MS_WINDOWS typedef SOCKET SOCKET_T; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> typedef int SOCKET_T; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> typedef struct { PyObject_HEAD SOCKET_T sock_fd; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Socket file descriptor */</span></span></span><span class="hljs-meta"> .... } PySocketSockObject; static int internal_select(PySocketSockObject *s, int writing, _PyTime_t interval, int connect) { .... </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (s-&gt;sock_fd &lt; 0) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// &lt;= return 0; .... }</span></span></span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 's-&gt; sock_fd &lt;0' is always false.  Unsigned type value is never &lt;0. socketmod.c 655 <br><br>  The Windows <i>SOCKET</i> type is unsigned, so comparing it with zero is meaningless.  In order to check whether the <i>socket ()</i> function returned a valid handle, you need to compare its value with <i>INVALID_SOCKET</i> .  It is worth noting that in Linux this comparison would work correctly, since the signed type <i>int</i> is used as the socket type and the value -1 is signaled to the error.  However, for testing, it is better to use special macros or constants. <br><br>  Similar checks for which a warning was issued: <ul><li>  V547 Expression 's-&gt; sock_fd &lt;0' is always false.  Unsigned type value is never &lt;0. _ssl.c 1702 </li><li>  V547 Expression 'sock-&gt; sock_fd &lt;0' is always false.  Unsigned type value is never &lt;0. _ssl.c 2018 </li></ul><br><h3>  Fragment N2 </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ASN1_PRINTABLE_type</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *s, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ia5 = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(((c &gt;= <span class="hljs-string"><span class="hljs-string">'a'</span></span>) &amp;&amp; (c &lt;= <span class="hljs-string"><span class="hljs-string">'z'</span></span>)) || ((c &gt;= <span class="hljs-string"><span class="hljs-string">'A'</span></span>) &amp;&amp; (c &lt;= <span class="hljs-string"><span class="hljs-string">'Z'</span></span>)) || (c == <span class="hljs-string"><span class="hljs-string">' '</span></span>) || <span class="hljs-comment"><span class="hljs-comment">// &lt;= ((c &gt;= '0') &amp;&amp; (c &lt;= '9')) || (c == ' ') || (c == '\'') || // &lt;= (c == '(') || (c == ')') || (c == '+') || (c == ',') || (c == '-') || (c == '.') || (c == '/') || (c == ':') || (c == '=') || (c == '?'))) ia5 = 1; .... }</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical sub-expressions '(c ==' ')' to the left  operator.  a_print.c 77 <br><br>  A typical example of an error resulting from Copy-Paste.  Often, with a large number of copied blocks, the programmer loses attention and forgets to change one variable or constant in one of them.  So in this case, in a large conditional expression, the values ‚Äã‚Äãwith which the variable <i>c is</i> compared are confused.  It is impossible to say exactly, but it seems that the double quotation mark character "" "was forgotten. <br><br><h3>  Fragment N3 </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> PyObject * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">semlock_acquire</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SemLockObject *self, PyObject *args, PyObject *kwds)</span></span></span><span class="hljs-function"> </span></span>{ .... HANDLE handles[<span class="hljs-number"><span class="hljs-number">2</span></span>], sigint_event; .... <span class="hljs-comment"><span class="hljs-comment">/* prepare list of handles */</span></span> nhandles = <span class="hljs-number"><span class="hljs-number">0</span></span>; handles[nhandles++] = self-&gt;handle; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_PyOS_IsMainThread()) { sigint_event = _PyOS_SigintEvent(); assert(sigint_event != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); handles[nhandles++] = sigint_event; } <span class="hljs-comment"><span class="hljs-comment">/* do the wait */</span></span> <span class="hljs-function"><span class="hljs-function">Py_BEGIN_ALLOW_THREADS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sigint_event != </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">NULL</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">//&lt;= ResetEvent(sigint_event); .... }</span></span></span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0230/">V614</a> Potentially uninitialized pointer 'sigint_event' used.  semaphore.c 120 <br><br>  In the case where the <i>_PyOS_IsMainThread ()</i> function returns <i>false</i> , the <i>sigint_event</i> pointer will remain uninitialized.  This will lead to undefined behavior.  This error can be easily overlooked in the debug version, where the pointer is likely to be initialized to zero. <br><br><h3>  Fragment N4 </h3><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BN_MASK2 (0xffffffffffffffffLL) int BN_mask_bits(BIGNUM *a, int n) { .... a-&gt;d[w] &amp;= ~(BN_MASK2 &lt;&lt; b); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//&lt;= .... }</span></span></span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0225/">V610</a> Undefined behavior.  Check the shift operator '&lt;&lt;'.  The left operand '(0xffffffffffffffffffLL)' is negative.  bn_lib.c 796 <br><br>  Despite the fact that the code works in most cases, this standard expression is an undefined behavior.  You can read more about the shifts of negative numbers in the article by Andrei Karpov " <a href="http://www.viva64.com/ru/b/0142/">Without knowing the ford, do not climb into the water. Part Three</a> ".  Should you avoid constructions, the result of which is not guaranteed by the standard, you decide, but it is better to refuse from such, what the analyzer warns us about. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> PyObject * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binascii_b2a_qp_impl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PyModuleDef *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Py_buffer *data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> quotetabs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> istext, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> header)</span></span></span><span class="hljs-function"> </span></span>{ Py_ssize_t in, out; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *databuf; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((databuf[in] &gt; <span class="hljs-number"><span class="hljs-number">126</span></span>) || (databuf[in] == <span class="hljs-string"><span class="hljs-string">'='</span></span>) || (header &amp;&amp; databuf[in] == <span class="hljs-string"><span class="hljs-string">'_'</span></span>) || ((databuf[in] == <span class="hljs-string"><span class="hljs-string">'.'</span></span>) &amp;&amp; (linelen == <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; (databuf[in+<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-string"><span class="hljs-string">'\n'</span></span> || databuf[in+<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-string"><span class="hljs-string">'\r'</span></span> || databuf[in+<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-number"><span class="hljs-number">0</span></span>)) || (!istext &amp;&amp; ((databuf[in] == <span class="hljs-string"><span class="hljs-string">'\r'</span></span>) || (databuf[in] == <span class="hljs-string"><span class="hljs-string">'\n'</span></span>))) || ((databuf[in] == <span class="hljs-string"><span class="hljs-string">'\t'</span></span> || databuf[in] == <span class="hljs-string"><span class="hljs-string">' '</span></span>) &amp;&amp; (in + <span class="hljs-number"><span class="hljs-number">1</span></span> == datalen)) || ((databuf[in] &lt; <span class="hljs-number"><span class="hljs-number">33</span></span>) &amp;&amp; (databuf[in] != <span class="hljs-string"><span class="hljs-string">'\r'</span></span>) &amp;&amp; (databuf[in] != <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) &amp;&amp; (quotetabs || (!quotetabs &amp;&amp; ((databuf[in] != <span class="hljs-string"><span class="hljs-string">'\t'</span></span>) &amp;&amp; <span class="hljs-comment"><span class="hljs-comment">// &lt;= (databuf[in] != ' ')))))) { .... } .... }</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0375/">V728 Anonymous</a> check can be simplified.  The '||'  quotetabs' and '! quotetabs' operator  binascii.c 1453 <br><br>  This fragment is not erroneous, however, it is worth considering it separately.  The warning is largely advisory in nature: the expression <i>'A ||</i>  <i>(! A &amp;&amp; B) '</i> can and should be simplified to <i>' A ||</i>  <i>B '</i> : this will make it easier to read the already over complicated code. <br><br>  Similar warnings: <ul><li>  V728 Anonymous check can be simplified.  The '||'  operator type by opposite expressions '! type' and 'type'.  digest.c 167 </li><li>  V728 Anonymous check can be simplified.  The '||'  operator is surrounded by opposite expressions! cipher and cipher.  evp_enc.c 120 </li></ul><br><h3>  Fragment N5 </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dh_cms_set_peerkey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> atype; .... <span class="hljs-comment"><span class="hljs-comment">/* Only absent parameters allowed in RFC XXXX */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (atype != V_ASN1_UNDEF &amp;&amp; atype == V_ASN1_NULL) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> err; .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0194/">V590</a> Consider inspecting the 'atype! = - 1 &amp;&amp; atype == 5' expression.  The expression is misprint.  dh_ameth.c 670 <br><br>  Oddly enough, errors in logical expressions are very often found even in large projects.  The logical expression from this fragment is redundant: it can be simplified to ' <i>atype == V_ASN1_NULL</i> '.  Most likely, based on the context, there is no error here, but such code looks suspicious. <br><br><h3>  Fragment N6 </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cms_env_set_version</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CMS_EnvelopedData *env)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (env-&gt;originatorInfo || env-&gt;unprotectedAttrs) env-&gt;version = <span class="hljs-number"><span class="hljs-number">2</span></span>; env-&gt;version = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0108/">V519</a> The 'env-&gt; version' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 907, 908. cms_env.c 908 <br><br>  It is difficult to say what was originally meant by the author of this code.  Possibly, else is missing here.  Now there is no sense in if, since the value of the variable ' <i>env-&gt; version'</i> will be overwritten in any case. <br><br><h3>  Fragment N7 </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _PyState_AddModule(PyObject* <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>, struct PyModuleDef* def) { PyInterpreterState *state; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (def-&gt;m_slots) { PyErr_SetString(PyExc_SystemError, <span class="hljs-string"><span class="hljs-string">"PyState_AddModule called on module with slots"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } state = GET_INTERP_STATE(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!def) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0205/">V595</a> The 'self-&gt; extra' pointer was used before it was verified against nullptr.  Check lines: 917, 923. _elementtree.c 917 <br><br>  The traditional mistake associated with dereferencing a null pointer, which occurs in almost every project.  First, in the expression <i>'def-&gt; m_slots',</i> they were addressed to some address, and then it turned out that this address could be zero.  As a result, the check for <i>nullptr</i> does not work, since the null pointer dereference will occur, which will lead to undefined program behavior, for example, to its fall. <br><br><h2>  Ruby </h2><br><img src="https://habrastorage.org/files/f33/cdb/063/f33cdb0636224574b5c5261f741220f7.png"><br><br><h3>  Fragment N1 </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vm_set_main_stack</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">rb_thread_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *th, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">rb_iseq_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *iseq)</span></span></span><span class="hljs-function"> </span></span>{ VALUE toplevel_binding = rb_const_get(rb_cObject, rb_intern(<span class="hljs-string"><span class="hljs-string">"TOPLEVEL_BINDING"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">rb_binding_t</span></span> *bind; <span class="hljs-keyword"><span class="hljs-keyword">rb_env_t</span></span> *env; GetBindingPtr(toplevel_binding, bind); GetEnvPtr(bind-&gt;env, env); vm_set_eval_stack(th, iseq, <span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;env-&gt;block); <span class="hljs-comment"><span class="hljs-comment">/* save binding */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bind &amp;&amp; iseq-&gt;body-&gt;local_size &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { bind-&gt;env = vm_make_env_object(th, th-&gt;cfp); } }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0205/">V595</a> The 'bind' pointer was used before it was verified against nullptr.  Check lines: 377, 382. vm.c 377 <br><br>  Not escaped a similar error in the Ruby project.  The <i>'if (bind)'</i> check will not save from trouble, since <i>bind</i> was de-referenced above by code.  In total, there were more than 30 such warnings in Ruby; it makes no sense to bring them all. <br><br><h3>  Fragment N2 </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">code_page_i</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ table = <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(table, count * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*table)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!table) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ST_CONTINUE; .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0340/">V701</a> realloc () possible leak: when realloc () fails in allocating memory, the original pointer 'table' is lost.  Consider assigning realloc () to a temporary pointer.  file.c 169 <br><br>  In this section of the code, the value of realloc is stored in the same variable that is used as the argument.  In the case where realloc returns <i>nullptr</i> , the initial value of the pointer will be lost, leading to a memory leak. <br><br><h3>  Fragment N3 </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">w32_symlink</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UINT cp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *link)</span></span></span><span class="hljs-function"> </span></span>{ .... BOOLEAN ret; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DWORD</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WINAPI *create_symbolic_link_func)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WCHAR*, WCHAR*, DWORD)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> create_symbolic_link_func create_symbolic_link = (create_symbolic_link_func)<span class="hljs-number"><span class="hljs-number">-1</span></span>; .... ret = create_symbolic_link(wlink, wsrc, flag); ALLOCV_END(buf); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ret) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> e = GetLastError(); errno = map_errno(e); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0369/">V724</a> Converting type 'DWORD' to type 'BOOLEAN' can lead to a loss of high-order bits.  Non-zero value can become 'FALSE'.  win32.c 4974 <br><br>  The BOOLEAN type is used in WinAPI as a logical type.  It is declared as follows: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> BYTE; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> BYTE BOOLEAN;</code> </pre> <br>  DWORD is a 32-bit unsigned number.  Therefore, if we bring, for example, the DWORD value 0xffffff00 to BOOLEAN (or any other one whose low-order bit is zero), then it will become 0, that is, FALSE. <br><br><h3>  Fragment N4 </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> VALUE </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rb_str_split_m</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, VALUE *argv, VALUE str)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *ptr = RSTRING_PTR(str); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> len = RSTRING_LEN(str); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> start = beg; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr+start == ptr+len) start++; .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0187/">V584</a> The 'ptr' value is the operator.  The expression is not correct.  string.c 7211 <br><br>  In both parts of the comparison, the addition of <i>ptr is</i> present, therefore, it can be omitted: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (start == len)</code> </pre> <br>  Most likely in this fragment there is no error.  However, often in such expressions actually want to compare two different variables.  Therefore, it is better to pay attention to such comparisons. <br><br><h2>  Results </h2><br>  After analyzing all the issued general-purpose diagnostic warnings and removing all false positives, I arrived at the following error distribution: <br><br><img src="https://habrastorage.org/files/11b/767/71a/11b76771accf4c5d8f26adc07992b9da.png"><br><br>  Most of the Ruby alarms fell on the <a href="http://www.viva64.com/ru/d/0225/">V610</a> warning (369 alarms!), But even if they are excluded, the situation will not change: the number of suspicious places is still less in Python. <br><br>  <a href="http://www.viva64.com/ru/d/0205/">V595</a> diagnostics turned out to be the most frequent: it met 17 times in Python code, and 37 times in Ruby code. <br><br>  But the most interesting is the density error ratio.  For this characteristic, Python also differs for the better.  The results of the calculations can be found in the table: <br><br><img src="https://habrastorage.org/files/9ee/7e1/9dc/9ee7e19dc5cf445e9cd6ec203aa06976.png"><br><br>  It may seem like a bit of mistakes.  This is not true.  First, not all of the errors found are critical.  For example, the previously mentioned <a href="http://www.viva64.com/ru/d/0225/">V610</a> diagnostics detect errors from the point of view of the C ++ language.  However, in practice, for the set of compilers used, the result can always be correct.  Although this error does not cease to be errors, they in no way affect the work of the program.  Secondly, you need to consider the size of the verified code.  Therefore, we can talk about the high quality of these projects.  So far, this assessment is subjective, since previously we did not calculate the density of errors in proven projects.  But we will try to do it in the future, so that later comparisons can be made. <br><br><h2>  Conclusion </h2><br><img src="https://habrastorage.org/files/ed7/386/c54/ed7386c54c6d417eb43ff40a7aa12ab2.png"><br><br>  Python and Ruby are very popular: they are written by millions of developers from around the world.  With such projects and community activity, good code quality, excellent testing and the use of static analysis (both projects are checked using Coverity) it is difficult to find a large number of errors.  However, PVS-Studio managed to find several suspicious places.  But it should be understood that it is precisely regular code checking that can seriously ease the life of developers.  It is best to correct the error immediately before the changes get into the repository and release - a static analyzer can help with this, like no other. <br><br>  I suggest everyone to try <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> on their projects. <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0414/"><img src="https://habrastorage.org/files/8d2/41b/5bf/8d241b5bf34747169141ed7c1997143b.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Pavel Belikov.  <a href="http://www.viva64.com/en/b/0414/">Python and Ruby implementations compared by the error density</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div><br><br>  <b>Update.</b>  This article contains inaccuracies.  Please <a href="http://www.viva64.com/ru/b/0418/">review the</a> " <a href="http://www.viva64.com/ru/b/0418/">Clarification on CPython and Ruby Project Verification</a> ". </div><p>Source: <a href="https://habr.com/ru/post/306204/">https://habr.com/ru/post/306204/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306194/index.html">‚ÄúIs this your backup so tired?‚Äù *</a></li>
<li><a href="../306196/index.html">Asyncpg released - PostgreSQL client library for Python / asyncio</a></li>
<li><a href="../306198/index.html">MLBootCamp "Performance Evaluation". Very simple and quick solution.</a></li>
<li><a href="../306200/index.html">Novice Investor's FAQ: How money is actually protected on the exchange</a></li>
<li><a href="../306202/index.html">Industrial Management Systems - 2016: Vulnerability and Availability</a></li>
<li><a href="../306208/index.html">Strata + Hadoop 2016 review</a></li>
<li><a href="../306210/index.html">One pixel instead of a thousand words</a></li>
<li><a href="../306214/index.html">What are behavior trees and how are they used?</a></li>
<li><a href="../306216/index.html">‚ÄúThe Sun hasn't Set yet‚Äù: Is it worth forcing programmers to work 80 hours a week</a></li>
<li><a href="../306218/index.html">Laser communications on the example of Facebook technologies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>