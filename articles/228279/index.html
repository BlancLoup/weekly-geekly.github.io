<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gson or "There and Back"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I had to work with the Google Gson library, designed to convert Java objects to JSON (serialized) text format and reverse conversion (deseri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Gson or "There and Back"</h1><div class="post__text post__text-html js-mediator-article">  Recently, I had to work with the Google <a href="https://code.google.com/p/google-gson/">Gson</a> library, designed to convert Java objects to JSON (serialized) text format and reverse conversion (deserialization).  Often, when working with Gson, the standard settings of the library are enough, but there are cases (including mine) when it is necessary to customize the conversion processes. <br><br>  Having worked with Gson, I decided to write this tutorial that illustrates the principles of working with the library on an example.  The post turned out to be relatively long, but I do not want to split it up because of the logical coherence of the narration. <br><br>  First you need to choose any subject area.  Say, I do not know, for some reason, the thought of a detachment of gnomes comes to mind.  Actually, why not? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/208/e0a/b7d/208e0ab7d4724628b72f355488ea5885.jpg"><br><a name="habracut"></a><br>  Yes, all the code involved in the article can be found on GitHub: <a href="https://github.com/treble-snake/gson.dwarves">https://github.com/treble-snake/gson.dwarves</a> <br>  The images, except for the class diagram, are borrowed from the series of articles about Gson at <a href="http://www.javacreed.com/">http://www.javacreed.com</a> . <br><br><h4>  Introduction </h4><br><h5>  About gnomes </h5><br>  So, with the "detachment" is clear - this is a kind of many dwarves.  But what about the gnomes themselves?  The most important detail that characterizes a dwarf is, of course, a beard.  You can paint for a long time the features and classifications of dwarf beards, but for simplicity, we define three parameters: whether the dwarf has a mustache, has a beard, and what color are they.  Further, the name and age - where do without them.  Add something more personal, let's say that the dwarf ate for lunch.  And finally, a weapon.  A gnome can have many weapons, and it can be simple, or it can be unique, with its own name and origin. <br><br>  The result is something like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/c1d/0e6/7ac/c1d0e67acaacdd260ef60413ed610a8b.png"><br><br><div class="spoiler">  <b class="spoiler_title">Class listings describing the subject area</b> <div class="spoiler_text">  For brevity, I will give all the classes in one listing: <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DwarvesBand</span></span></span><span class="hljs-class"> </span></span>{ List&lt;Dwarf&gt; dwarves = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinkedList&lt;&gt;(); <span class="hljs-comment"><span class="hljs-comment">// getters &amp; setters } public class Dwarf { private String name; private FacialHair facialHair; private List&lt;Weapon&gt; weapons = new LinkedList&lt;&gt;(); private String lunch; private int dwarfAge; public Dwarf() { } public Dwarf(String name, int dwarfAge) { this.name = name; this.dwarfAge = dwarfAge; } // getters &amp; setters } /** *     */ public class FacialHair { private boolean haveBeard; private boolean haveMustache; private String color; public FacialHair(boolean haveBeard, boolean haveMustache, String color) { this.haveBeard = haveBeard; this.haveMustache = haveMustache; this.color = color; } // getters &amp; setters } public class Weapon { private String type; public Weapon() { // do nothing } public Weapon(String type) { this.type = type; } // getters &amp; setters } public class UniqueWeapon extends Weapon { private String name; private String origin; public UniqueWeapon() { super(); } public UniqueWeapon(String type, String name, String origin) { super(type); this.name = name; this.origin = origin; } // getters &amp; setters }</span></span></code> </pre> <br></div></div><br><br>  We initialize our gnome company by adding three participants ( <i>all the actors are fictional and the coincidences are random</i> ): <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BandUtil</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> DwarvesBand </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createBand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ DwarvesBand company = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwarvesBand(); Dwarf tmpDwarf; tmpDwarf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dwarf(<span class="hljs-string"><span class="hljs-string">"Orin"</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>); tmpDwarf.setLunch(<span class="hljs-string"><span class="hljs-string">"Ale with chicken"</span></span>); tmpDwarf.setFacialHair(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FacialHair(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">"black"</span></span>)); tmpDwarf.addWeapon(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UniqueWeapon(<span class="hljs-string"><span class="hljs-string">"sword"</span></span>, <span class="hljs-string"><span class="hljs-string">"Slasher"</span></span>, <span class="hljs-string"><span class="hljs-string">"Gondolin"</span></span>)); tmpDwarf.addWeapon(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UniqueWeapon(<span class="hljs-string"><span class="hljs-string">"shield"</span></span>, <span class="hljs-string"><span class="hljs-string">"Oaken Shield"</span></span>, <span class="hljs-string"><span class="hljs-string">"Moria"</span></span>)); tmpDwarf.addWeapon(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Weapon(<span class="hljs-string"><span class="hljs-string">"dagger"</span></span>)); company.addDwarf(tmpDwarf); tmpDwarf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dwarf(<span class="hljs-string"><span class="hljs-string">"Kori"</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>); <span class="hljs-comment"><span class="hljs-comment">// no lunch :( tmpDwarf.setFacialHair(new FacialHair(false, true, "red")); tmpDwarf.addWeapon(new Weapon("mace")); tmpDwarf.addWeapon(new Weapon("bow")); company.addDwarf(tmpDwarf); tmpDwarf = new Dwarf("Billy Bob", 45); tmpDwarf.setLunch("Ale with chicken and potatoes, tea with some cakes"); tmpDwarf.setFacialHair(new FacialHair(false, false, "")); company.addDwarf(tmpDwarf); return company; } }</span></span></code> </pre><br><h4>  There </h4><br><h5>  Default </h5><br>  So, we want to get information about our gnomes in JSON format.  Let's try the easiest way - to use the standard parameters of the Gson library, creating an instance of the class with the same name and calling the <code>toJson()</code> method. <br><pre> <code class="java hljs">DwarvesBand band = BandUtil.createBand(); Gson gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonBuilder() .setPrettyPrinting() .create(); String json = gson.toJson(band);</code> </pre><br>  Actually, an instance of the <code>Gson</code> class <code>Gson</code> also be created through the <code>new</code> operator, but then the output JSON would not be formatted, which is good for data exchange between applications (it forms faster, weighs less), but not healthy for human perception.  Therefore, we used a special <a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/GsonBuilder.html">GsonBuilder</a> by calling the <code>setPrettyPrinting()</code> method, which allowed us to see the output JSON as follows: <br><div class="spoiler">  <b class="spoiler_title">JSON after serialization by default</b> <div class="spoiler_text"><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"dwarves"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Orin"</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: { <span class="hljs-string"><span class="hljs-string">"haveBeard"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"haveMustache"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"color"</span></span>: <span class="hljs-string"><span class="hljs-string">"black"</span></span> }, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Slasher"</span></span>, <span class="hljs-string"><span class="hljs-string">"origin"</span></span>: <span class="hljs-string"><span class="hljs-string">"Gondolin"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"sword"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Oaken Shield"</span></span>, <span class="hljs-string"><span class="hljs-string">"origin"</span></span>: <span class="hljs-string"><span class="hljs-string">"Moria"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"shield"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"dagger"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"lunch"</span></span>: <span class="hljs-string"><span class="hljs-string">"Ale with chicken"</span></span>, <span class="hljs-string"><span class="hljs-string">"dwarfAge"</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Kori"</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: { <span class="hljs-string"><span class="hljs-string">"haveBeard"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"haveMustache"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"color"</span></span>: <span class="hljs-string"><span class="hljs-string">"red"</span></span> }, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"mace"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"bow"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"dwarfAge"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Billy Bob"</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: { <span class="hljs-string"><span class="hljs-string">"haveBeard"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"haveMustache"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"color"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> }, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"lunch"</span></span>: <span class="hljs-string"><span class="hljs-string">"Ale with chicken and potatoes, tea with some cakes"</span></span>, <span class="hljs-string"><span class="hljs-string">"dwarfAge"</span></span>: <span class="hljs-number"><span class="hljs-number">45</span></span> } ] }</code> </pre><br></div></div><br>  Well, it is already possible to work with this, however, if you think about it, there are a few remarks: <br><ol><li>  What a stupid property name is ‚ÄúdwarfAge‚Äù?  And so it is clear that we are talking about a gnome.  Just "age" would look much better. </li><li>  Perhaps the information about lunch is not so important.  You can do without it. </li><li>  Description of the beard is some kind of dry, this should not be allowed.  It should be described with a complete sentence, that is, a line, for example: ‚ÄúRed beard and mustache‚Äù or ‚ÄúBlack mustache‚Äù. </li><li>  Why do we need to get an object with a single ‚Äútype‚Äù property for conventional weapons?  It will cost just a string. </li></ol><br>  If we take into account all the comments, we want to see information about the dwarf in this format: <br><pre> <code class="javascript hljs"> { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Orin"</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: <span class="hljs-string"><span class="hljs-string">"Black beard and mustache"</span></span>, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Slasher"</span></span>, <span class="hljs-string"><span class="hljs-string">"origin"</span></span>: <span class="hljs-string"><span class="hljs-string">"Gondolin"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"sword"</span></span> }, ... , <span class="hljs-string"><span class="hljs-string">"dagger"</span></span> ], <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span> }</code> </pre><br><br><h5>  Annotations </h5><br>  Gson provides us with some useful <a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/annotations/package-summary.html">annotations</a> for setting up serialization.  See if they can help us. <br><br>  With the first problem - yes, we can change the output name of the property by adding the <a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/annotations/SerializedName.html">SerializedName</a> annotation to the corresponding.  field class.  That is, by doing this: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SerializedName</span></span>(<span class="hljs-string"><span class="hljs-string">"age"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dwarfAge;</code> </pre><br>  We will get a property named ‚Äúage‚Äù instead of ‚ÄúdwarfAge‚Äù. <br><br>  Already not bad, we go further.  You need to exclude the <code>lunch</code> box.  First, you can do this by adding the <a href="http://docs.oracle.com/javase/specs/jls/se7/html/jls-8.html">transient</a> keyword to it, in which case the field will not be taken into account during serialization.  But not the fact that this is the right way.  The fact that we do not need information about dinner here does not mean that it is not needed during some other serialization. <br>  Another way is to use the <a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/annotations/Expose.html">Expose</a> annotation.  It only works in conjunction with the <a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/GsonBuilder.html">GsonBuilder.excludeFieldsWithoutExposeAnnotation ()</a> method, which excludes all fields that <b>do not</b> have the Expose annotation from processing.  But, it turns out, to exclude one field, we need to add annotations to all other fields.  Not too comfortable, right? <br><br><h5>  Your serializer </h5><br>  A more flexible way is to create your own class that serializes objects of a certain type.  To do this, you need to implement the <a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/index.html">JsonSerializer &lt;T&gt;</a> interface, where T is the type of objects being processed.  Consider a single interface <code>serialize()</code> method: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">JsonElement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T src, Type typeOfSrc, JsonSerializationContext context)</span></span></span></span></code> </pre><br>  It takes three parameters: <br><ul><li>  <code>T src</code> is the object to be serialized; </li><li>  <code>Type typeOfSrc</code> - the type of the object being serialized; </li><li>  <code>JsonSerializationContext context</code> - the context of serialization;  The <code>JsonSerializationContext</code> interface <code>JsonSerializationContext</code> also functional and contains 1 method, also <code>serialize()</code> ;  it should be used to process non-primitive data included in the object being serialized (and we will do this just below);  context inherits all settings (including registered serializers, etc.) of the original Gson object. </li></ul><br>  The returned data type of the method is <code>JsonElement</code> .  This is an abstract class with 4 implementations, shown in the figure below: <br><img src="https://habrastorage.org/files/4e8/d0b/a27/4e8d0ba27e5d4b05b9748303a5704d17.png"><br><ul><li>  <code>JsonNull</code> - the actual representation for <code>null</code> </li><li>  <code>JsonPrimitive</code> - representing primitive types like strings, numbers, etc. </li><li>  <code>JsonArray</code> - a set of objects of type <code>JsonElement</code> ;  can be viewed as a <code>List&lt;JsonElement&gt;</code> ;  elements can be any of the <code>JsonElement</code> implementations, and mixed types are supported; </li><li>  <code>JsonObject</code> is a set of key-value pairs, where the key is a string and the value is again an object of type <code>JsonElement</code> ;  similar to the <code>Map&lt;String, JsonElement&gt;</code> . </li></ul><br>  The figure below shows an example of a combination of types: <br><img src="https://habrastorage.org/getpro/habr/post_images/c3d/50b/bc3/c3d50bbc3dc79c81ac0daabe05ae8bdf.png"><br><br><h5>  Time to serialize dwarves </h5><br>  So, enough theory, let's finally serialize! <br>  First, how many data types we have that require custom processing. <br>  Firstly, it is, of course, the class itself, describing the gnome - <code>Dwarf</code> . <br>  Secondly, the beard and mustache class is <code>FacialHair</code> . <br>  Still here it is possible to carry <code>Weapon</code> and especially <code>UniqueWeapon</code> , but we will leave it while on care of processing by default. <br><br>  Accordingly, we need two implementations of the <code>JsonSerializer</code> .  They look quite similar: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DwarfSerializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonSerializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dwarf</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> JsonElement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Dwarf src, Type typeOfSrc, JsonSerializationContext context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ! return null; } } public class FacialHairSerializer implements JsonSerializer&lt;FacialHair&gt; { @Override public JsonElement serialize(FacialHair src, Type typeOfSrc, JsonSerializationContext context) { //    ! return null; } }</span></span></code> </pre><br>  In order for Gson to use our serializers when processing dwarves, you need to register it using the <code>registerTypeAdapter()</code> method of the <code>GsonBuilder</code> class as follows: <br><br><pre> <code class="java hljs">Gson gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonBuilder() .setPrettyPrinting() .registerTypeAdapter(Dwarf.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwarfSerializer()) .registerTypeAdapter(FacialHair.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FacialHairSerializer()) .create();</code> </pre><br><br><h6>  Beard and mustache </h6><br>  We realize to start the treatment of the beard and mustache.  Below is the full code, which will be discussed in more detail below: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FacialHairSerializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonSerializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FacialHair</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> JsonElement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FacialHair src, Type typeOfSrc, JsonSerializationContext context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!src.isHaveBeard() &amp;&amp; !src.isHaveMustache()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonPrimitive(<span class="hljs-string"><span class="hljs-string">"is he really a dwarf?"</span></span>); List&lt;String&gt; list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinkedList&lt;String&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (src.isHaveBeard()) { list.add(<span class="hljs-string"><span class="hljs-string">"beard"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (src.isHaveMustache()) { list.add(<span class="hljs-string"><span class="hljs-string">"mustache"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonPrimitive( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(src.getColor()) .append(<span class="hljs-string"><span class="hljs-string">" "</span></span>) .append(StringUtils.join(list, <span class="hljs-string"><span class="hljs-string">" and "</span></span>)) .toString() ); } }</code> </pre><br>  It's pretty simple.  Since we reduce the information about the beard and mustache to one line, the result of the work of the serialize () method should be a <code>JsonPrimitive</code> object containing the desired string. <br>  For example, if a gnome has neither a beard nor a mustache, one may question its attitude to the gnome family: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!src.isHaveBeard() &amp;&amp; !src.isHaveMustache()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonPrimitive(<span class="hljs-string"><span class="hljs-string">"is he really a dwarf?"</span></span>);</code> </pre><br>  Otherwise, using a rather trivial algorithm, we obtain from the source data a string of the type we need, and also create an instance of <code>JsonPrimitive</code> on its basis.  And yes, let us take for granted that the input object and hair color are always initialized with us, so as not to complicate the code with checks that are completely unimportant for the purposes of the article. <br><br><h6>  The dwarf himself </h6><br>  Now we implement the processing of the gnome as a whole (also omit the checks): <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DwarfSerializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonSerializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dwarf</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> JsonElement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Dwarf src, Type typeOfSrc, JsonSerializationContext context)</span></span></span><span class="hljs-function"> </span></span>{ JsonObject result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonObject(); result.addProperty(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, src.getName()); result.addProperty(<span class="hljs-string"><span class="hljs-string">"age"</span></span>, src.getDwarfAge()); result.add(<span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>, context.serialize(src.getFacialHair())); JsonArray weapons = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonArray(); result.add(<span class="hljs-string"><span class="hljs-string">"weapons"</span></span>, weapons); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(Weapon weapon : src.getWeapons()) { weapons.add( weapon <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> UniqueWeapon ? context.serialize(weapon) : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonPrimitive(weapon.getType()) ); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre><br>  Let's sort this code in parts.  As a result, we should get a JSON object, we create a variable of the appropriate type: <br><pre> <code class="java hljs">JsonObject result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonObject();</code> </pre><br>  Then, using the <a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/JsonObject.html">addProperty ()</a> method, we <a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/JsonObject.html">enter the</a> data of primitive types into our object (without creating an intermediate <code>JsonPrimitive</code> object).  We pass two parameters to the method: the first is the key, that is, the name of the property of the JSON object, the second is the value of this property.  This is where we set the name of the property ‚Äúage‚Äù instead of ‚ÄúdwarfAge‚Äù, and also exclude information about lunch from the result ‚Äî simply by not adding it to the resulting object. <br><pre> <code class="java hljs">result.addProperty(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, src.getName()); result.addProperty(<span class="hljs-string"><span class="hljs-string">"age"</span></span>, src.getDwarfAge());</code> </pre><br>  Next we need to add beard data.  To do this, we use the context's <code>serialize()</code> method ‚Äî as mentioned earlier, the context is aware of the registered serializers, so our <code>FacialHairSerializer</code> <code>FacialHair</code> apply to the <code>FacialHairSerializer</code> .  We add the resulting <code>JsonElement</code> to our object using the <a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/JsonObject.html">add ()</a> method, specifying the desired property name. <br><pre> <code class="java hljs">result.add(<span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>, context.serialize(src.getFacialHair()));</code> </pre><br>  It remains only to add information about the weapons of the gnome.  Since we have no symbolic keys for weapons, we create an instance of <code>JsonArray</code> to store them and add it to our object using the same add () method. <br><pre> <code class="java hljs">JsonArray weapons = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonArray(); result.add(<span class="hljs-string"><span class="hljs-string">"weapons"</span></span>, weapons);</code> </pre><br>  Now you need to fill the created array with elements.  The <code>JsonArray</code> class also has a <a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/JsonArray.html">add ()</a> method, but it accepts only one parameter of the <code>JsonElement</code> type, which is logical - the key is not needed in this case.  When adding a conventional weapon, we create a <code>JsonPrimitive</code> based on a string, and uniquely serialize it using a context.  In this case, the standard serialization mechanism will work, because we have not registered any handlers for the <code>UniqueWeapon</code> class. <br><pre> <code class="java hljs">weapons.add( weapon <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> UniqueWeapon ? context.serialize(weapon) : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonPrimitive(weapon.getType()) );</code> </pre><br><h6>  Result </h6><br>  Finally, we use the fruit of our work for its intended purpose: <br><pre> <code class="java hljs">DwarvesBand band = BandUtil.createBand(); Gson gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonBuilder() .setPrettyPrinting() .registerTypeAdapter(Dwarf.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwarfSerializer()) .registerTypeAdapter(FacialHair.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FacialHairSerializer()) .create(); String json = gson.toJson(band);</code> </pre><br>  We look that we did: <br><div class="spoiler">  <b class="spoiler_title">Output json</b> <div class="spoiler_text"><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"dwarves"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Orin"</span></span>, <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: <span class="hljs-string"><span class="hljs-string">"black beard and mustache"</span></span>, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Slasher"</span></span>, <span class="hljs-string"><span class="hljs-string">"origin"</span></span>: <span class="hljs-string"><span class="hljs-string">"Gondolin"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"sword"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Oaken Shield"</span></span>, <span class="hljs-string"><span class="hljs-string">"origin"</span></span>: <span class="hljs-string"><span class="hljs-string">"Moria"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"shield"</span></span> }, <span class="hljs-string"><span class="hljs-string">"dagger"</span></span> ] }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Kori"</span></span>, <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: <span class="hljs-string"><span class="hljs-string">"red mustache"</span></span>, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"mace"</span></span>, <span class="hljs-string"><span class="hljs-string">"bow"</span></span> ] }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Billy Bob"</span></span>, <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">45</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: <span class="hljs-string"><span class="hljs-string">"is he really a dwarf?"</span></span>, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [] } ] }</code> </pre><br></div></div><br><h6>  Finishing touch </h6><br>  The only thing I would like to change is that all the dwarves in our country are elements of an array, which is stored in the ‚Äúdwarves‚Äù property.  This is somehow disreputable, and redundant - we know that we are talking about dwarves, right?  Let each gnome be a separate property of a JSON object, where the key is the name of the gnome.  For example: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"Kori"</span></span>: { <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: <span class="hljs-string"><span class="hljs-string">"red mustache"</span></span>, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [ ... ] }, ... }</code> </pre><br>  Most likely, you yourself can already imagine what needs to be done to bring this final touch to life.  But just in case: <br><div class="spoiler">  <b class="spoiler_title">Implementation</b> <div class="spoiler_text">  1. Add a serializer for the whole gnome company: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DwarvesBandSerializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonSerializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DwarvesBand</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> JsonElement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DwarvesBand src, Type typeOfSrc, JsonSerializationContext context)</span></span></span><span class="hljs-function"> </span></span>{ JsonObject result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonObject(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(Dwarf dwarf : src.getDwarves()) { result.add(dwarf.getName(), context.serialize(dwarf)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre><br><br>  2. Remove the name information from the gnome serializer ( <code>DwarfSerializer</code> class) by deleting the line: <br><pre> <code class="java hljs">result.addProperty(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, src.getName());</code> </pre><br><br>  3. Register the squad serializer by adding a call to the <code>registerTypeAdapter()</code> method of the <code>GsonBuilder</code> class: <br><pre> <code class="java hljs">.registerTypeAdapter(DwarvesBand.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwarvesBandSerializer())</code> </pre><br></div></div><br>  And we got the desired data format for the gnomes company: <br><div class="spoiler">  <b class="spoiler_title">Ta-daa!</b> <div class="spoiler_text"><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"Orin"</span></span>: { <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: <span class="hljs-string"><span class="hljs-string">"black beard and mustache"</span></span>, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Slasher"</span></span>, <span class="hljs-string"><span class="hljs-string">"origin"</span></span>: <span class="hljs-string"><span class="hljs-string">"Gondolin"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"sword"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Oaken Shield"</span></span>, <span class="hljs-string"><span class="hljs-string">"origin"</span></span>: <span class="hljs-string"><span class="hljs-string">"Moria"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"shield"</span></span> }, <span class="hljs-string"><span class="hljs-string">"dagger"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"Kori"</span></span>: { <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: <span class="hljs-string"><span class="hljs-string">"red mustache"</span></span>, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"mace"</span></span>, <span class="hljs-string"><span class="hljs-string">"bow"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"Billy Bob"</span></span>: { <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">45</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: <span class="hljs-string"><span class="hljs-string">"is he really a dwarf?"</span></span>, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [] } }</code> </pre><br></div></div><br>  You can safely go for the blue mountains, for the white mist! <br><br><h4>  Back </h4><br>  Returning from JSON-adventure, the squad of dwarfs naturally wants to be transformed back into cozy Java objects.  For the inverse transform, that is, deserialization, Gson has a <code>fromJson()</code> method.  It takes two parameters: data in several formats (including <code>String</code> , which we will use) and the type of the returned result.  However, if we try to simply create a Gson object and call this method, as shown below, we will get an instance of the <code>DwarvesBand</code> class with an empty list of gnomes: <br><pre> <code class="java hljs">DwarvesBand dwarvesBand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gson().fromJson(json, DwarvesBand.class);</code> </pre><br>  This is natural, because we used our own algorithms for the conversion, and the default Gson does not know how to handle our format.  Therefore, in exactly the same way, we have to create special deserializers and indicate to the library that it is necessary to use them to process information about gnomes.  As you may have already guessed, to create them, you need to implement the <a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/JsonDeserializer.html">JsonDeserializer &lt;T&gt;</a> interface and its only method, <a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/JsonDeserializer.html">deserialize ()</a> . <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deserialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JsonElement json, Type typeOfT, JsonDeserializationContext context)</span></span></span></span></code> </pre><br>  Accepted Parameters: <br><ul><li>  <code>JsonElement json</code> - Json element to restore data from; </li><li>  <code>Type typeOfT</code> - the type of the object that should be the result; </li><li>  <code>JsonDeserializationContext context</code> - deserialization context;  similar to <code>JsonSerializationContext</code> , the <code>JsonDeserializationContext</code> interface contains one <code>deserialize()</code> method;  this context inherits all settings of the Gson object </li></ul><br>  The returned data type is parameterized. <br>  Let's get started! <br><br><h5>  Borrrod! </h5><br>  Let's start small.  Restore data on the beard and mustache.  Full deserialization code: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FacialHairDeserializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonDeserializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FacialHair</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> FacialHair </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deserialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JsonElement json, Type typeOfT, JsonDeserializationContext context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> JsonParseException </span></span>{ FacialHair hair = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FacialHair(); String data = json.getAsString(); List&lt;String&gt; parts = Arrays.asList(data.split(<span class="hljs-string"><span class="hljs-string">" "</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.contains(<span class="hljs-string"><span class="hljs-string">"beard"</span></span>)) hair.setHaveBeard(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(parts.contains(<span class="hljs-string"><span class="hljs-string">"mustache"</span></span>)) hair.setHaveMustache(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(hair.isHaveBeard() || hair.isHaveMustache()) hair.setColor(parts.get(<span class="hljs-number"><span class="hljs-number">0</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hair; } }</code> </pre><br>  Yes, in an amicable way, it would be worth checking the input data more carefully, but we take it for granted that they are correct so as not to complicate the code of the examples. <br>  The most important line in this method is: <br><pre> <code class="java hljs">String data = json.getAsString();</code> </pre><br>  The <a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/JsonElement.html">getAsString ()</a> method converts the contents of a <code>JsonElement</code> to a string if it is applied to an element of type <code>JsonPrimitive</code> containing a valid string, or to a <code>JsonArray</code> containing only one such element of type <code>JsonPrimitive</code> .  Otherwise, the method will throw an exception.  All methods of the <code>getAs{JavaType}()</code> type <code>getAs{JavaType}()</code> . <br>  We are sure that we get <code>JsonPrimitive</code> with a string at the input, so we will not check it (one could use the <code>isJsonPrimitive()</code> method).  Further processing of the data obtained is trivial, we will not linger on it. <br><br><h5>  Dwarf </h5><br>  It is time to recover the data about the gnome.  We do it like this: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DwafDeserializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonDeserializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dwarf</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Dwarf </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deserialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JsonElement json, Type typeOfT, JsonDeserializationContext context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> JsonParseException </span></span>{ JsonObject jsonObject = json.getAsJsonObject(); Dwarf dwarf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dwarf(); dwarf.setDwarfAge(jsonObject.get(<span class="hljs-string"><span class="hljs-string">"age"</span></span>).getAsInt()); dwarf.setFacialHair((FacialHair) context.deserialize(jsonObject.get(<span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>), FacialHair.class)); JsonArray weapons = jsonObject.getAsJsonArray(<span class="hljs-string"><span class="hljs-string">"weapons"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(JsonElement weapon : weapons) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weapon.isJsonPrimitive()) { dwarf.addWeapon(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Weapon(weapon.getAsString())); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dwarf.addWeapon((UniqueWeapon) context.deserialize(weapon, UniqueWeapon.class)); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dwarf; } }</code> </pre><br>  Again, some checks are omitted for brevity.  We analyze in parts. <br>  We know that the information about the gnome is presented in the form of a <code>JsonObject</code> , so we will convert the input data to this type without checking. <br><pre> <code class="java hljs">JsonObject jsonObject = json.getAsJsonObject();</code> </pre><br>  We <code>JsonElement</code> age using the <code>get()</code> method first, which returns us a <code>JsonElement</code> with the value of the specified property ‚Äúage‚Äù, and then the <code>getAsInt()</code> method, since age has an integer type. <br><pre> <code class="java hljs">dwarf.setDwarfAge(jsonObject.get(<span class="hljs-string"><span class="hljs-string">"age"</span></span>).getAsInt());</code> </pre><br>  Restore the beard data to an object of type <code>FacialHair</code> using <code>context.deserialize()</code> .  As we remember, the context is aware of the need to use a special deserializer to process beard information. <br><pre> <code class="java hljs">dwarf.setFacialHair((FacialHair) context.deserialize(jsonObject.get(<span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>), FacialHair.class));</code> </pre><br>  We get the value of the ‚Äúweapons‚Äù property immediately in the form of a Json-array.  You could first get <code>JsonElement</code> with the get method (‚Äúweapons‚Äù), then check for the array type using the <code>isJsonArray()</code> method, and then convert it into an array using the <code>getAsJsonArray()</code> method.  But we believe in our gnomes and the format of their input. <br><pre> <code class="java hljs">JsonArray weapons = jsonObject.getAsJsonArray(<span class="hljs-string"><span class="hljs-string">"weapons"</span></span>);</code> </pre><br>  It remains to go through the array, restoring data on weapons: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(JsonElement weapon : weapons) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weapon.isJsonPrimitive()) { dwarf.addWeapon(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Weapon(weapon.getAsString())); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dwarf.addWeapon((UniqueWeapon) context.deserialize(weapon, UniqueWeapon.class)); } }</code> </pre><br>  For each element, we check if it is of <code>JsonPrimitive</code> type.  We remember that conventional weapons are described with a simple string, which corresponds to this type.  In this case, create an instance of a conventional weapon, getting its type using the <code>getAsString()</code> method.  Otherwise, we are dealing with a unique weapon.  We processed it using context using standard Gson mechanisms.  We do the same thing now using <code>context.deserialize()</code> . <br><br>  Noticed that something is missing?  And not just "something", but the name of the gnome!  To complete the recovery of information about the gnome, adding this important detail, we turn to the last deserializer. <br><br><h5>  Squad </h5><br>  Finally, add a handler for the entire squad of gnomes: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DwarvesBandDeserializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonDeserializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DwarvesBand</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DwarvesBand </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deserialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JsonElement json, Type typeOfT, JsonDeserializationContext context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> JsonParseException </span></span>{ DwarvesBand result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwarvesBand(); JsonObject jsonObject = json.getAsJsonObject(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(Map.Entry&lt;String, JsonElement&gt; entry : jsonObject.entrySet()) { Dwarf dwarf = context.deserialize(entry.getValue(), Dwarf.class); dwarf.setName(entry.getKey()); result.addDwarf(dwarf); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre><br>  As in the processing of the gnome, we <code>JsonObject</code> input data to the <code>JsonObject</code> type.  Remember, it was previously mentioned that <code>JsonObject</code> can be perceived as <code>Map&lt;String, JsonElement&gt;</code> ?  Similar to <code>Map</code> , <code>JsonObject</code> has an <code>entrySet()</code> method that returns a set of key-value elements.  Just with his help, we will cycle through all the records about the gnomes. <br>  The value of the element is all the information about the gnome, except the name.  We use context to deserialize this information and get an instance of the Dwarf class. <br><pre> <code class="java hljs">Dwarf dwarf = context.deserialize(entry.getValue(), Dwarf.class);</code> </pre><br>  The remaining name is empty in the item key.  We write it in our object and - voila - the information about the gnome is fully restored! <br><pre> <code class="java hljs">dwarf.setName(entry.getKey());</code> </pre><br><br><h5>  Home, sweet home </h5><br>  It remains to register our newly baked deserializers, and you can start the journey "There and Back."  Registration is absolutely similar to the registration of serializers: <br><pre> <code class="java hljs">Gson gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonBuilder() .registerTypeAdapter(DwarvesBand.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwarvesBandDeserializer()) .registerTypeAdapter(FacialHair.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FacialHairDeserializer()) .registerTypeAdapter(Dwarf.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwafDeserializer()) .create();</code> </pre><br><br>  To check, we first transform the company of the dwarves into a Json string, then back, and for clarity, we will display the result as a Json object obtained using the standard Gson mechanism.  You can make sure that no one is forgotten and nothing is forgotten, all the dwarfs have returned safe and sound! <br><div class="spoiler">  <b class="spoiler_title">Security Code</b> <div class="spoiler_text"><pre> <code class="java hljs">DwarvesBand company = BandUtil.createBand(); Gson gson; gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonBuilder() .registerTypeAdapter(Dwarf.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwarfSerializer()) .registerTypeAdapter(FacialHair.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FacialHairSerializer()) .registerTypeAdapter(DwarvesBand.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwarvesBandSerializer()) .create(); String json = gson.toJson(company); gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonBuilder() .registerTypeAdapter(DwarvesBand.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwarvesBandDeserializer()) .registerTypeAdapter(FacialHair.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FacialHairDeserializer()) .registerTypeAdapter(Dwarf.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwafDeserializer()) .create(); DwarvesBand bandIsBack = gson.fromJson(json, DwarvesBand.class); gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonBuilder() .setPrettyPrinting() .create(); System.out.println(gson.toJson(bandIsBack));</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Result</b> <div class="spoiler_text"><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"dwarves"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Orin"</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: { <span class="hljs-string"><span class="hljs-string">"haveBeard"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"haveMustache"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"color"</span></span>: <span class="hljs-string"><span class="hljs-string">"black"</span></span> }, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Slasher"</span></span>, <span class="hljs-string"><span class="hljs-string">"origin"</span></span>: <span class="hljs-string"><span class="hljs-string">"Gondolin"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"sword"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Oaken Shield"</span></span>, <span class="hljs-string"><span class="hljs-string">"origin"</span></span>: <span class="hljs-string"><span class="hljs-string">"Moria"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"shield"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"dagger"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"dwarfAge"</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Kori"</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: { <span class="hljs-string"><span class="hljs-string">"haveBeard"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"haveMustache"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"color"</span></span>: <span class="hljs-string"><span class="hljs-string">"red"</span></span> }, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"mace"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"bow"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"dwarfAge"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Billy Bob"</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: { <span class="hljs-string"><span class="hljs-string">"haveBeard"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"haveMustache"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"color"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> }, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"dwarfAge"</span></span>: <span class="hljs-number"><span class="hljs-number">45</span></span> } ] }</code> </pre><br></div></div><br><h4>  Round trip </h4><br>  So, we have considered the trip "There" (from Java to JSON) and "Back" (from JSON to Java).  Each time in our serializers and deserializers we worked with an intermediate layer of objects of type <code>JsonElement</code> , which <code>JsonElement</code> kindly provided us. <br><img src="https://habrastorage.org/files/bc2/59a/a83/bc259aa83be244efadf1c97211f7c379.png"><br>  And although it is quite convenient, it leads to overhead.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gson gives us the opportunity to sacrifice convenience for the sake of performance, eliminating the intermediate layer. You can do this using a custom JsonSerializer + JsonDeserializer pair for the custom conversion, but the implementation of the </font></font><a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/TypeAdapter.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TypeAdapter &lt;T&gt;</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class </font><font style="vertical-align: inherit;">, which is intended for converting to both sides. Most of all we are interested in two abstract methods of this class - </font></font><code>write()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>read()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. They are responsible for custom transformations: </font></font><code>write()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- for serialization, and </font></font><code>read()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- for deserialization. </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/e34/d0a/d71/e34d0ad719395aaef0d7495761aa3fdc.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remember we abandoned the gnome‚Äôs guns to the default processing? Let's fix this injustice. Combine the name and origin of the weapon in a string like "Slasher from Gondolin". And in order not to waste time on trifles, create</font></font><code>TypeAdapter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for the entire list of weapons, not just for unique copies. </font><font style="vertical-align: inherit;">Our class will look like this:</font></font><br><pre> <code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WeaponsTypeAdapter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TypeAdapter&lt;List&lt;Weapon&gt;&gt;</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> public void write(<span class="hljs-type"><span class="hljs-type">JsonWriter</span></span> out, <span class="hljs-type"><span class="hljs-type">List</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Weapon</span></span>&gt; value) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> <span class="hljs-type"><span class="hljs-type">IOException</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Java ‚Üí JSON } @Override public List&lt;Weapon&gt; read(JsonReader in) throws IOException { // JSON ‚Üí Java return null; } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we, according to the old scheme, must notify Gson of the new handler for the list of weapons by calling the method </font></font><code>.registerTypeAdapter()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">However, there is a snag. </font><font style="vertical-align: inherit;">The first parameter of the method - is a data type for which the handler is registered, and gnome weapons we sold the usual list: </font></font><code>List&lt;Weapon&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">And we obviously do not want all other lists to be processed by our TypeAdapter. </font><font style="vertical-align: inherit;">It is necessary to somehow indicate that it is intended only for the list of weapons, passing the parameterized type. </font><font style="vertical-align: inherit;">For this, Gson uses a special tricky class - </font></font><a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/reflect/TypeToken.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TypeToken &lt;T&gt;</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">With it, we can get the parameterized type we need as follows:</font></font><br><pre> <code class="java hljs">Type weaponsListType = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypeToken&lt;List&lt;Weapon&gt;&gt;(){}.getType();</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In fact, we specifically inherit the parameterized class by the </font></font><code>TypeToken</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anonymous class, in order to then </font></font><code>getGenericSuperclass()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtain the type of the parameterizing parent </font><font style="vertical-align: inherit;">by method </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In our case, the parameterizing parent type is ours </font></font><code>List&lt;Weapon&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A little confusing, but in a different way, alas, no way. </font><font style="vertical-align: inherit;">In more detail about obtaining the parameters of the Generic classes can be read, for example, in </font></font><a href="http://habrahabr.ru/post/66593/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well and further - as usual:</font></font><br><pre> <code class="java hljs">Type weaponsListType = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypeToken&lt;List&lt;Weapon&gt;&gt;(){}.getType(); Gson gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonBuilder() .setPrettyPrinting() .registerTypeAdapter(Dwarf.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwarfSerializerWithTypeAdapter()) .registerTypeAdapter(FacialHair.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FacialHairSerializer()) .registerTypeAdapter(DwarvesBand.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwarvesBandSerializer()) .registerTypeAdapter(weaponsListType, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WeaponsTypeAdapter()) .create();</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It remains only to change the serialization and deserialization code of the gnome, transferring control on the processing of weapons to the context indicating the type of value being processed: </font></font><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DwarfSerializerWithTypeAdapter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonSerializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dwarf</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> JsonElement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... Type weaponsType = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypeToken&lt;List&lt;Weapon&gt;&gt;(){}.getType(); result.add(<span class="hljs-string"><span class="hljs-string">"weapons"</span></span>, context.serialize(src.getWeapons(), weaponsType)); ... } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DwafDeserializerWithTypeAdapter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonDeserializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dwarf</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Dwarf </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deserialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... Type weaponsType = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypeToken&lt;List&lt;Weapon&gt;&gt;(){}.getType(); List&lt;Weapon&gt; weapons = context.deserialize(jsonObject.getAsJsonArray(<span class="hljs-string"><span class="hljs-string">"weapons"</span></span>), weaponsType); dwarf.addWeapons(weapons); ... } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That's all, the adapter is connected. </font><font style="vertical-align: inherit;">Oh yeah, it remains to implement it. </font><font style="vertical-align: inherit;">As usual, under the spoiler - the full code, which will be further discussed in more detail.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full TypeAdapter code</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WeaponsTypeAdapter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TypeAdapter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">List</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Weapon</span></span></span><span class="hljs-class">&gt;&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JsonWriter out, List&lt;Weapon&gt; value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ out.beginArray(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Weapon weapon : value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (weapon <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> UniqueWeapon) { UniqueWeapon uWeapon = (UniqueWeapon) weapon; out.beginObject(); out.name(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) .value(uWeapon.getName() + <span class="hljs-string"><span class="hljs-string">" from "</span></span> + uWeapon.getOrigin()); out.name(<span class="hljs-string"><span class="hljs-string">"type"</span></span>) .value(uWeapon.getType()); out.endObject(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { out.value(weapon.getType()); } } out.endArray(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Weapon&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JsonReader in)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ List&lt;Weapon&gt; result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinkedList&lt;&gt;(); in.beginArray(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (in.hasNext()) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (in.peek()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> STRING: result.add(createCommonWeapon(in)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> BEGIN_OBJECT: result.add(createUniqueWeapon(in)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: in.skipValue(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Weapon </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createCommonWeapon</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JsonReader in)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Weapon(in.nextString()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Weapon </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createUniqueWeapon</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JsonReader in)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ UniqueWeapon weapon = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UniqueWeapon(); in.beginObject(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (in.hasNext()) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (in.nextName()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"name"</span></span>: String[] tmp = in.nextString().split(<span class="hljs-string"><span class="hljs-string">" from "</span></span>); weapon.setName(tmp[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tmp.length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) weapon.setOrigin(tmp[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"type"</span></span>: weapon.setType(in.nextString()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: in.skipValue(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } in.endObject(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> weapon; } }</code> </pre><br></div></div><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Again </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, the method is responsible for the transformation "There" </font></font><code>write()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Its code is:</font></font><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JsonWriter out, List&lt;Weapon&gt; value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ out.beginArray(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Weapon weapon : value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (weapon <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> UniqueWeapon) { UniqueWeapon uWeapon = (UniqueWeapon) weapon; out.beginObject(); out.name(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) .value(uWeapon.getName() + <span class="hljs-string"><span class="hljs-string">" from "</span></span> + uWeapon.getOrigin()); out.name(<span class="hljs-string"><span class="hljs-string">"type"</span></span>) .value(uWeapon.getType()); out.endObject(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { out.value(weapon.getType()); } } out.endArray(); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We see in the parameters of the method an instance of the </font></font><a href="https://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/stream/JsonWriter.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JsonWriter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class </font><font style="vertical-align: inherit;">and our list of weapons. </font></font><code>JsonWriter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allows you to create output JSON in streaming mode. </font><font style="vertical-align: inherit;">First of all, we need an array where we will store weapon data.</font></font><br><pre> <code class="java hljs">out.beginArray(); ... out.endArray();</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These commands, in fact, are responsible for arranging square brackets (as, in fact, arrays in JSON are denoted). </font><font style="vertical-align: inherit;">Since we want to get an array at the output, we start it at the beginning of the method, and at the end we finish it. </font><font style="vertical-align: inherit;">It's all pretty simple. </font><font style="vertical-align: inherit;">Similarly, the &lt;codebeginObject () &lt;/ code and &lt;codeendObject () &lt;/ code methods are used to create objects. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further, in the case of conventional weapons, we simply write to the array the value of a primitive type (string) by calling the method </font></font><code>value()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><pre> <code class="java hljs">out.value(weapon.getType());</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And for a unique weapon, we create an object and write two key-value pairs into it, calling the </font></font><code>name()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font><font style="vertical-align: inherit;">methods in turn </font></font><code>value()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><pre> <code class="java hljs">out.name(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) .value(uWeapon.getName() + <span class="hljs-string"><span class="hljs-string">" from "</span></span> + uWeapon.getOrigin()); out.name(<span class="hljs-string"><span class="hljs-string">"type"</span></span>) .value(uWeapon.getType());</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> That's all, an array of weapons recorded. </font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And back again </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We pretty famously transformed our weapon into a JSON array with a mixed data type, right? </font><font style="vertical-align: inherit;">And now it is time to convert it back. </font><font style="vertical-align: inherit;">And here we have a small problem. </font><font style="vertical-align: inherit;">So, the method </font></font><code>read()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">takes one parameter:</font></font><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Weapon&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JsonReader in)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{...}</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><a href="https://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/stream/JsonReader.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JsonReader</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class </font><a href="https://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/com/google/gson/stream/JsonReader.html"><font style="vertical-align: inherit;">is</font></a><font style="vertical-align: inherit;"> engaged in extracting data from Json, and also in stream format. Therefore, we must iterate through all the "nodes", processing them accordingly. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By analogy with the record, objects and arrays are processed by the </font></font><code>beginObject() / endObject()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font><font style="vertical-align: inherit;">methods </font></font><code>beginArray() / endArray()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We iterate the properties of objects with the method </font></font><code>nextName()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, their values ‚Äã‚Äãwith the method </font></font><code>next{Type}()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(for example, </font></font><code>nextString()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). The elements of the arrays are also sorted by the method </font></font><code>next{Type}()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But all this is good, if we have a strict data format, with a certain sequence of elements. Then we know when to open an array, when an object, and so on. In our case, we are dealing with a mixed type of data array, where Json-objects and strings can go in any order. Fortunately,</font></font><code>GsonReader</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there is also a method </font></font><code>peek()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that returns the type of the next node without processing it. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, the general form of the method </font></font><code>read()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we get is:</font></font><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Weapon&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JsonReader in)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ List&lt;Weapon&gt; result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinkedList&lt;&gt;(); in.beginArray(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (in.hasNext()) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (in.peek()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> STRING: result.add(createCommonWeapon(in)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> BEGIN_OBJECT: result.add(createUniqueWeapon(in)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: in.skipValue(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } in.endArray(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We know that the gnome‚Äôs arsenal is represented by an array containing objects (for unique instances) and strings (for regular ones). </font><font style="vertical-align: inherit;">Therefore, processing each element of the array, we check the type of the initial node of this element. </font><font style="vertical-align: inherit;">To handle strings and objects, we have created methods that we call. </font><font style="vertical-align: inherit;">Other types are simply skipped by the method </font></font><code>skipValue()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The method of creating conventional weapons is extremely simple:</font></font><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Weapon </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createCommonWeapon</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JsonReader in)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Weapon(in.nextString()); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Just get a string that contains the type of weapon, method, </font></font><code>nextString()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and create an object on its basis. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With a unique weapon - somewhat more complicated:</font></font><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Weapon </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createUniqueWeapon</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JsonReader in)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ UniqueWeapon weapon = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UniqueWeapon(); in.beginObject(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (in.hasNext()) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (in.nextName()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"name"</span></span>: String[] tmp = in.nextString().split(<span class="hljs-string"><span class="hljs-string">" from "</span></span>); weapon.setName(tmp[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tmp.length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) weapon.setOrigin(tmp[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"type"</span></span>: weapon.setType(in.nextString()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: in.skipValue(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } in.endObject(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> weapon; }</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We go into the object and iterate through all its properties using the method </font></font><code>nextName()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">For properties with the names "name" and "type" we have processing algorithms - we create on their basis instances of conventional and unique weapons. </font><font style="vertical-align: inherit;">The remaining properties (if there are any), again, skip. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, deserialization of the gnome‚Äôs arsenal using the TypeAdapter is ready. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Just in case - check if everything is in order.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Security Code</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs">DwarvesBand company = BandUtil.createBand(); Gson gson; Type weaponsType = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TypeToken&lt;List&lt;Weapon&gt;&gt;(){}.getType(); gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonBuilder() .registerTypeAdapter(Dwarf.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwarfSerializerWithTypeAdapter()) .registerTypeAdapter(FacialHair.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FacialHairSerializer()) .registerTypeAdapter(DwarvesBand.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwarvesBandSerializer()) .registerTypeAdapter(weaponsType, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WeaponsTypeAdapter()) .setPrettyPrinting() .create(); String json = gson.toJson(company); System.out.println(<span class="hljs-string"><span class="hljs-string">"Serialized:"</span></span>); System.out.println(json); gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonBuilder() .registerTypeAdapter(DwarvesBand.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwarvesBandDeserializer()) .registerTypeAdapter(FacialHair.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FacialHairDeserializer()) .registerTypeAdapter(Dwarf.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DwafDeserializerWithTypeAdapter()) .registerTypeAdapter(weaponsType, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WeaponsTypeAdapter()) .create(); DwarvesBand companyIsBack = gson.fromJson(json, DwarvesBand.class); gson = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GsonBuilder() .setPrettyPrinting() .create(); System.out.println(<span class="hljs-string"><span class="hljs-string">"\n\nDeserialized:"</span></span>); System.out.println(gson.toJson(companyIsBack));</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Result</b> <div class="spoiler_text"><pre> <code class="javascript hljs">Serialized: { <span class="hljs-string"><span class="hljs-string">"Orin"</span></span>: { <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: <span class="hljs-string"><span class="hljs-string">"black beard and mustache"</span></span>, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Slasher from Gondolin"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"sword"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Oaken Shield from Moria"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"shield"</span></span> }, <span class="hljs-string"><span class="hljs-string">"dagger"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"Kori"</span></span>: { <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: <span class="hljs-string"><span class="hljs-string">"red mustache"</span></span>, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"mace"</span></span>, <span class="hljs-string"><span class="hljs-string">"bow"</span></span> ] }, <span class="hljs-string"><span class="hljs-string">"Billy Bob"</span></span>: { <span class="hljs-string"><span class="hljs-string">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">45</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: <span class="hljs-string"><span class="hljs-string">"is he really a dwarf?"</span></span>, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [] } } Deserialized: { <span class="hljs-string"><span class="hljs-string">"dwarves"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Orin"</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: { <span class="hljs-string"><span class="hljs-string">"haveBeard"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"haveMustache"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"color"</span></span>: <span class="hljs-string"><span class="hljs-string">"black"</span></span> }, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Slasher"</span></span>, <span class="hljs-string"><span class="hljs-string">"origin"</span></span>: <span class="hljs-string"><span class="hljs-string">"Gondolin"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"sword"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Oaken Shield"</span></span>, <span class="hljs-string"><span class="hljs-string">"origin"</span></span>: <span class="hljs-string"><span class="hljs-string">"Moria"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"shield"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"dagger"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"dwarfAge"</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Kori"</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: { <span class="hljs-string"><span class="hljs-string">"haveBeard"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"haveMustache"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"color"</span></span>: <span class="hljs-string"><span class="hljs-string">"red"</span></span> }, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"mace"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"bow"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"dwarfAge"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Billy Bob"</span></span>, <span class="hljs-string"><span class="hljs-string">"facialHair"</span></span>: { <span class="hljs-string"><span class="hljs-string">"haveBeard"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"haveMustache"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"color"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> }, <span class="hljs-string"><span class="hljs-string">"weapons"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"dwarfAge"</span></span>: <span class="hljs-number"><span class="hljs-number">45</span></span> } ] }</code> </pre><br></div></div><br><br><h4>  Afterword </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That's the end of the journey from Java to JSON and back. </font><font style="vertical-align: inherit;">At this let me take my leave, dear reader.</font></font> I hope you were interested. <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let me remind you a few links that may come in handy: </font></font><br><br><ul><li> <a href="https://code.google.com/p/google-gson/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gson project</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/index.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on it</font></font></li><li> <a href="https://github.com/treble-snake/gson.dwarves"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sample code on GitHub</font></font></a> </li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And they lived happily ever after. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The end.</font></font></div><p>Source: <a href="https://habr.com/ru/post/228279/">https://habr.com/ru/post/228279/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../228265/index.html">Badoo reports from RIT 2014 conference</a></li>
<li><a href="../228267/index.html">Creating audio plug-ins, part 13</a></li>
<li><a href="../228269/index.html">Braille ebook for the blind</a></li>
<li><a href="../228273/index.html">How to correctly issue intellectual rights to the program?</a></li>
<li><a href="../228277/index.html">Up-selling (upselling): increase the average sales receipt</a></li>
<li><a href="../228281/index.html">Electronic passports from 2016 throughout Russia</a></li>
<li><a href="../228283/index.html">Hydrointegrator Lukyanova</a></li>
<li><a href="../228285/index.html">IoT example: Making a bitcoin monitor from a Nokia screen, a Netduino board and a cloud</a></li>
<li><a href="../228287/index.html">Google plans to lay its own fiber optic cable across the Pacific Ocean.</a></li>
<li><a href="../228289/index.html">We distinguish the bus from the car by GPS tracks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>