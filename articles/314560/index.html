<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Making a project on Node.js using Mongoose, Express, Cluster. Part 2.1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 


 Hello, dear habrovchane! Today we will mainly have small changes, but many changes. In this part we will: 


- Create your own logger...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Making a project on Node.js using Mongoose, Express, Cluster. Part 2.1</h1><div class="post__text post__text-html js-mediator-article"><h1 id="vvedenie">  Introduction </h1><br><p>  Hello, dear habrovchane!  Today we will mainly have small changes, but many changes.  In this part we will: </p><br><ul><li>  Create your own logger </li><li>  Log requests and their processing time </li><li>  Correct the mistakes that we made in the first part. </li><li>  Deal with authorization </li><li>  Deal with some classes </li><li>  Configs! </li></ul><a name="habracut"></a><br><h1 id="logi">  Logs </h1><br><p> For logs we will use a homemade module.  Create a folder <code>logger</code> .  It will have an <code>index.js</code> file. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stackTrace = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'stack-trace'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      var util = require('util'); //util.inspect() var path = require('path'); //path.relative() path.sep var projectname = require('../package').name; //package.json -&gt; project name module.exports = class Logger //   :) { constructor() { function generateLogFunction(level) //     :) { return function(message,meta) { //var d = Date.now(); //      var mes = this.module + " -- "; mes += level + " -- "; mes += message; //   if(meta) mes += " " + util.inspect(meta) + " "; //    (Object||Error) mes += '\n'; //   :) this.write(mes); //       } }; this.trace = stackTrace.get()[1]; //    this.filename = this.trace.getFileName(); //       this.module = projectname + path.sep + path.relative('.',this.filename); //    this.streams = [process.stdout]; //        //        this.log = generateLogFunction('Log'); //   this.info = generateLogFunction('Info'); //   this.error = generateLogFunction('Error'); //   this.warn = generateLogFunction('Warning'); //   } write(d) { this.streams.forEach((stream)=&gt;{ stream.write(d); }); } }</span></span></code> </pre><br><p>  And now about the syntax of use. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> logger = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./logger'</span></span>)(); <span class="hljs-comment"><span class="hljs-comment">//... logger.info('Hello, world');</span></span></code> </pre> <br><p>  Why do we use <code>new</code> ?  In order to get the name of the file in which the logger was created.  Because running stack-trace every time we write to the log will use a lot of resources.  Replace all console with logger.  I will leave everything to the will of your IDE :) </p><br><p>  NOTE: In the <code>doc</code> and <code>node_modules</code> there are files using the <code>console</code> .  Be careful! </p><br><p>  Also replace in the file <code>worker.js</code> <code>console.error</code> with a <code>throw</code> .  Like this: </p><br><pre> <code class="javascript hljs">app.listen(<span class="hljs-number"><span class="hljs-number">3000</span></span>,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> err; <span class="hljs-comment"><span class="hljs-comment">//       logger.log(`Running server at port 3000!`) //         //      });</span></span></code> </pre> <br><p>  Why we do not use <code>winston</code> and other modules to work with logs?  The answer is simple: <code>winston</code> shows little performance.  And not only Winston.  The same goes for many modules.  As it turned out after some testing, our homemade module shows 4-8 times more performance than many other modules :) </p><br><h1 id="vremya-obrabotki-zaprosa">  Request processing time </h1><br><p>  In order to see which requests came to the server and how long it took to process it, we will write our middleware.  In the <code>bin</code> folder, create the <code>rt.js</code> file </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Logger = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../logger'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> logger = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Logger(); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req,res,next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   var beginTime = Date.now(); //    res.on('finish',()=&gt;{ var d = Date.now();//     logger.log('Reponse time: ' + (d - beginTime),{ url:req.url, //       ( urlencode string :) time:(d - beginTime) //    }); }); //     next(); }</span></span></code> </pre> <br><p>  And in <code>worker.js</code> before any handlers, add: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   app.use(require('./rt'));</span></span></code> </pre> <br><p>  Here we use our own module because all other modules are NOT able to log only guaranteed requests (at least before the OS) requests. </p><br><h1 id="raznica-prilozheniya-ot-routera">  The difference of the application from the router </h1><br><p>  In the controller, we saw <code>express()</code> for creating a mini application and then we mounted it into the project using <code>app.use()</code> but express does not recommend doing so.  We will replace <code>express()</code> with <code>new express.Router()</code> in the controller file: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// : var Router = require('express').Router; var app = new Router(); // app.use(....) // app.get(....) // etc</span></span></code> </pre> <br><p>  What problems will arise with <code>express()</code> ?  The most important.  We cannot change the settings in the entire application.  Also, we can't use <code>app.locals</code> .  And for some unclear reason, it DOES NOT pass on cookies (Why is this?). </p><br><h1 id="konfiguraciya">  Configuration </h1><br><p>  Create a folder <code>config</code> .  In the folder we will have the <code>index.js</code> file, where we will receive all the settings, add, parse and even <del>  rob cows </del>  insert, if necessary, the required fields if they are missing. </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./config'</span></span>);</code> </pre> <br><p>  And in the <code>config.json</code> file: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>:<span class="hljs-number"><span class="hljs-number">8080</span></span>, <span class="hljs-attr"><span class="hljs-attr">"mongoUri"</span></span>:<span class="hljs-string"><span class="hljs-string">"mongodb://127.0.0.1/armleo-test"</span></span> }</code> </pre> <br><p>  NOTE: If there are no enabled networks in windows, then <code>localhost</code> does not work and <code>127.0.0.1</code> must be used. <br>  In the <code>worker.js</code> file <code>worker.js</code> add at the beginning: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../config'</span></span>);</code> </pre> <br><p>  And the last lines turn into <del>  a hare </del>  following: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     3000      . //  Worker-        app.listen(config.port,function(err){ if(err) throw err; //       logger.log(`Running server at port ${config.port}!`); //         //      });</span></span></code> </pre> <br><p>  We remember that we still need to change the lines in <code>dbinit.js</code> ?  So do it. </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// 10 line bin/dbinit.js //    MongoDB var config = require('../config'); mongoose.connect(config.mongoUri,{ server:{ poolSize: 10 //      // 10     . //      ... } });</span></span></code> </pre> <br><h1 id="es6">  ES6 </h1><br><p>  We will replace all the necessary <code>var</code> with <code>const</code> and <code>let</code> .  A little change, but I like it! </p><br><h1 id="avtorizaciya">  Authorization </h1><br><p>  Now to the authorization!  For authorization we will use <a href="http://passportjs.org/"><code>Passport.js</code></a> .  In our project, BYE, registration is not needed because one user will be added by us to the database manually.  Create the <code>auth.js</code> controller.  In the controller, we need input parsers: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> app = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>).Router)(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> models = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./../models'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> passport = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'passport'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> LocalStrategy = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'passport-local'</span></span>).Strategy; app.use(passport.initialize()); app.use(passport.session()); passport.use(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LocalStrategy( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">username, password, done</span></span></span><span class="hljs-function">) </span></span>{ models.User.findOne({ <span class="hljs-attr"><span class="hljs-attr">username</span></span>: username }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, user</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(err); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, { <span class="hljs-attr"><span class="hljs-attr">message</span></span>: <span class="hljs-string"><span class="hljs-string">'Incorrect username.'</span></span> }); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.password != password) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, { <span class="hljs-attr"><span class="hljs-attr">message</span></span>: <span class="hljs-string"><span class="hljs-string">'Incorrect password.'</span></span> }); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, user); }); } )); passport.serializeUser(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user, done</span></span></span><span class="hljs-function">) </span></span>{ done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, user._id); }); passport.deserializeUser(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id, done</span></span></span><span class="hljs-function">) </span></span>{ models.User.findById(id, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, user</span></span></span><span class="hljs-function">) </span></span>{ done(err, user); }); }); app.post(<span class="hljs-string"><span class="hljs-string">'/login'</span></span>, passport.authenticate(<span class="hljs-string"><span class="hljs-string">'local'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">successRedirect</span></span>: <span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-attr"><span class="hljs-attr">failureRedirect</span></span>: <span class="hljs-string"><span class="hljs-string">'/login'</span></span> }) ); app.get(<span class="hljs-string"><span class="hljs-string">'/login'</span></span>,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req,res,next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(req.user) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.redirect(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); res.render(<span class="hljs-string"><span class="hljs-string">'login'</span></span>,{ <span class="hljs-attr"><span class="hljs-attr">user</span></span>:req.user }); }); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = app;</code> </pre> <br><p>  For authorization, we <code>views/login.html</code> add a form to <code>views/login.html</code> . </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/login"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"POST"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"username"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  For users we come up with a model. </p><br><h1 id="posty">  Posts! </h1><br><p>  Install the modules: </p><br><pre> <code class="bash hljs">npm i mongoose-url-slugs --save</code> </pre> <br><p>  Create a post model in the <code>models</code> folder file <code>post.js</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  mongoose ..          const mongoose = require('mongoose'); const URLSlugs = require('mongoose-url-slugs'); //   ! let postSchema = new mongoose.Schema({ title:{ type:String, // : String required:[true,"titleRequired"], //   .        titleRequired //   32   (Unicode symbol != byte) minlength:[6,"tooShort"], unique:true //     }, text:{ type:String, //  String required:[true,"textRequired"] //      }, //     ,       ! //   //  //   // slug:String }); //    ( ) //      postSchema.plugin(URLSlugs('title')); //     module.exports = mongoose.model('Post',postSchema);</span></span></code> </pre> <br><p>  And in the <code>models/index.js</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-comment"><span class="hljs-comment">//    () //  *nix-      User:require('./user'), Post:require('./post') }; //     !</span></span></code> </pre> <br><p>  Create a controller for creating / editing posts!  In the file <code>controllers/index.js</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Logger = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../logger'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> logger = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Logger(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> app = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>).Router)(); app.use(<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./auth'</span></span>)); app.use(<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./home'</span></span>)); app.use(<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./post'</span></span>)); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = app;</code> </pre> <br><p>  And in the file <code>controllers/post.js</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> app = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>).Router)(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> models = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"../models"</span></span>); app.get(<span class="hljs-string"><span class="hljs-string">'/post'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req,res,next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!req.user) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.redirect(<span class="hljs-string"><span class="hljs-string">'/login'</span></span>); res.render(<span class="hljs-string"><span class="hljs-string">'addpost'</span></span>,{ <span class="hljs-attr"><span class="hljs-attr">user</span></span>:req.user }); }); app.post(<span class="hljs-string"><span class="hljs-string">'/post'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!req.user) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.redirect(<span class="hljs-string"><span class="hljs-string">'/login'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> post = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> models.Post(req.body); post.save() .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">=&gt;</span></span>{ res.redirect(<span class="hljs-string"><span class="hljs-string">'/post/'</span></span> + post.slug); }).catch(next); }); app.get(<span class="hljs-string"><span class="hljs-string">'/post/:slug'</span></span>,(req, res, next)=&gt;{ models.Post.findOne({ <span class="hljs-attr"><span class="hljs-attr">slug</span></span>:req.params.slug }).exec().then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">post</span></span></span><span class="hljs-function">)=&gt;</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!post) res.redirect(<span class="hljs-string"><span class="hljs-string">'/#notfound'</span></span>); res.render(<span class="hljs-string"><span class="hljs-string">'post'</span></span>,{ <span class="hljs-attr"><span class="hljs-attr">user</span></span>:req.user, post }); }).catch(next); }); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = app;</code> </pre> <br><p>  And accordingly the images!  Creations <code>views/addpost.html</code> </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"POST"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/post"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"title"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  <code>views/post.html</code> </p><br><pre> <code class="html hljs xml">{{#post}} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>{{title}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">/&gt;</span></span> {{text}} {{/post}}</code> </pre> <br><p>  Let's finish the image <code>views/index.html</code> bit </p><br><pre> <code class="javascript hljs">{{#user}} Hello {{username}} {{/user}} {{^user}} Login &lt;a href=<span class="hljs-string"><span class="hljs-string">"/login"</span></span>&gt;here!<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> {{/user}} {{#posts}} &lt;br/&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"/post/{{slug}}"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{{title}}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> {{/posts}}</code> </pre> <br><p>  Let's finish the controller <code>controllers/home.js</code> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> app = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>).Router)(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> models = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../models'</span></span>); app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>,(req,res,next)=&gt;{ <span class="hljs-comment"><span class="hljs-comment">//  handler     `/` models.Post.find({}).exec().then((posts)=&gt;{ res.render('index',{ user:req.user, posts }); //      index }).catch(next); }); module.exports = app;</span></span></code> </pre> <br><p>  Add the urlencode parser to <code>bin/worker.js</code> : </p><br><pre> <code class="javascript hljs">app.use(bodyParser.urlencoded());</code> </pre> <br><h1 id="github">  Github </h1><br><p>  You can find our project on the githaba <a href="https://github.com/armleo/node-base">here.</a> </p><br><h1 id="konec-vtoroy-chasti">  The end of the second part! </h1><br><p>  At the end of the second part.  In the next  parts, we will allocate some HTTPS time, services in Ubuntu, We will hash the password, Captcha (recaptcha) and comments with some statistics and introduce markdown support for posts, Replace MongoDB for sessions with Redis, Add caching. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/314560/">https://habr.com/ru/post/314560/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314550/index.html">Offensive programming: paranoid, offensive, offensive or defenseless programming</a></li>
<li><a href="../314552/index.html">The digest of fresh materials from the world of the frontend for the last week No. 235 (November 1 - 6, 2016)</a></li>
<li><a href="../314554/index.html">Be King of your state with Angular2 State Machine</a></li>
<li><a href="../314556/index.html">Almost half of the developers spend 10-25% of the time to correct errors in the finished product</a></li>
<li><a href="../314558/index.html">How to launch ClickHouse on your own and win the jackpot</a></li>
<li><a href="../314562/index.html">The book "Web Development. Comprehensive Guide ¬ª</a></li>
<li><a href="../314564/index.html">Simplify or die. What should be the product for the Russian E-commerce?</a></li>
<li><a href="../314566/index.html">7 things about books and life that I learned by reading 100 books a year</a></li>
<li><a href="../314570/index.html">Emoji is just the beginning. And why business communications are no longer effective without smiles.</a></li>
<li><a href="../314572/index.html">Hello, I got a call from this number</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>