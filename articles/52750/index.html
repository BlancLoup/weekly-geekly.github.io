<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Moving from one production server to another</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Task:  move a working project from one server to another. 

 We have:  working server, new server configured and configured to run the project. 

 I w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Moving from one production server to another</h1><div class="post__text post__text-html js-mediator-article"><h4>  Task: </h4>  move a working project from one server to another. <br><br><h4>  We have: </h4>  working server, new server configured and configured to run the project. <br><br>  I will not delve into the details of server settings, as this can be, in principle, any server under any OS.  The main thing is that you have full access to the entire system.  Those.  admin rights.  As well as the server should be ready at any time to receive visitors.  Those.  virtuals must be configured, installed DBMS, WEB server, etc. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  The first way is simple: </h5><br>  We hang on the working server page with the words "We move, come tomorrow" and go! <br><br>  Actually it is best to start with scripts.  It would be perfect if you had SVN or CVS.  In this case, the scripts can be poured in one click.  In principle, FTP can also be easily downloaded, but if you need to correct something and quickly reload it, then it may be a little problematic to rush all the modified files in a hurry, especially if they are scattered in different directories. <br><br>  After filling scripts go to the database.  If your base is not gigabyte / terabyte in size, then you can try to make a test base and upload the entire dump there.  If the dump is still very large, then you can fill only the structure and the necessary tables (so that the system ‚Äústarts‚Äù) into the test database and test it.  This is necessary for intermediate testing before you open the site for visitors.  In addition to the test base, create a working one and fill in the entire dump there, but leave the use of the test base in the settings. <br><br>  Virtual host  It should be configured so that it can work with two different domains.  What for?  Again for testing.  For example, your site site.com is now closed, but you need to make sure that everything will be fine on the new server?  This is what the second domain is for.  Where to get it is the second question.  If you do not have subdomains, you can temporarily add test.site.com and register it on a new server.  Well, or just write in the hosts (in your OS) any domain and it should work.  It should also be noted that your scripts must be properly configured for this domain (unless of course they are bound to domains). <br><br>  Shimmering content.  If your site has custom content, it should also be transferred to a new server.  This can be done in different ways depending on your OS and your skills.  I will not dwell on this, in general, a trivial task. <br><br>  If everything went well, try to enter the test domain.  In this case, if properly configured, the site should work correctly.  Make a full system check - register a user, check sending mail, upload files, work of services, crones, daemons, etc.  if everything is good, switch the scripts to a real base and you can change DNS (IP at the real domain).  As the update on DNS servers passes, more and more new visitors will arrive at your new server.  Do not forget to remove the page with the inscription on the new server.  She is absolutely useless here :) <br><br>  Estimated time - from 30 minutes to 3-4 hours (without taking into account the update time of DNS) <br><br>  Further more fun ... <br><br><a name="habracut"></a><br><h5>  The second way - moving on the fly without closing the site. </h5><br>  More complex and requires changes to the scripts, as well as database replication settings.  And some manipulations with the system.  It also requires more time and good skills in administering the system.  It is better to do it together with the system administrator. <br><br>  The beginning is the same as in the first case - setting up virtuals, DBMS, WEB server, etc.  Only the site does not close!  Let the visitors go.  Further more fun - rule the scripts.  We need to add a global constant that will contain the point in time from which our move will begin.  We will rely on this constant in many places of the project, so it should be visible everywhere.  I want to note - this constant is needed only if the system uses user content.  For example, users upload pictures, avatars, music, etc.  In this case, we need to know - from what moment we start to move and the new content should be uploaded to the new server, and the old one should remain where it is.  If we simply start copying the current content to a new server, then no one will give us a guarantee that as long as we copy everything, nothing new will appear.  Someone may have already guessed what to do with the constant.  But I will explain in more detail - for example, we must begin the move at 00:00:00 01-03-2009.  At this point, all user content should be stored on the old server, after this point - on the new one.  To do this, you have to edit the scripts in all places where content is loaded.  We need to add a check for time and if the server time is less than the time of the constant - leave the content where it is, if more - upload to the new server.  Fill can be done in various ways.  You can mount NFS or drbd (under * nix).  You can upload content via FTP, SCP or other means.  Of course, you have to worry about the security and stability of the system, so the choice of means of content delivery again depends on the specific situation.  But how to understand what content is where?  And how to separate the new content from the old?  Well, if you have time to add content in the database, this makes the task very easy, if it is not ... then you need to proceed from the current situation - if the DBMS supports global object IDs (OID), then you can get the first ID after the specified date ( again automatically) or try to get the ID for each table where the content is stored separately and attach to them already.  For example, we solved this problem.  What's next?  Next, we need to configure the auxiliary domain for the new server.  For example, let your site be all the same site.com uses subdomains to access content: video.site.com, audio.site.com, etc.  it will also make life easier for us.  Add a subdomain: new.site.com and in it we prescribe all our subdomains: video.new.site.com, audio.new.site.com well, or vice versa - for each subdomain we prescribe another one: new.video.  site.com, new.audio.site.com, etc.  the main thing is that they point to a new server and at this address there was a new content.  And the least thing left is to replace all the links to the content depending on our constant - i.e.  after the date X, some of the links will point to new content, and some to old.  If your paths are registered in one place and are available globally, it will not be difficult to replace links on the fly if all links are hammered into templates ... well, you know who you are now :) But not everything is as simple as it seems.  You will have to fix all the places where the content is displayed ... Unfortunately, there may be a lot of them.  It is good if you have a good project architecture and all entities have classes with methods for retrieving objects from the database.  It is possible at the time to roughly fit into these methods and do a check there.  For example, you get an audio object only in the retrieve method in the Audio class.  In this case, you can add your verification to this method and change your base URL.  But if your page contains a list of old and new content, you will have to edit the template specifically for this page.  Alas. <br><br>  To avoid such a situation, add just one field to the content tables (it‚Äôs better to think about it at the architecture stage), which will indicate where to get this content.  For example, the storage (smallint) field contains 1,2,3 ... and in the templates you simply substitute the necessary URL for this - for 1 - vid1.site.com, for 2 - vid2.site.com, etc.  It is also recommended to do something similar for the distribution of content across multiple servers in a working project with a high load.  But that's another story. <br><br>  <b>UPD: to</b> avoid these dances with Buna in some case, you can proxy - all requests for content are wrapped on a new server and there, if the content is not found, they are proxied to the old one.  Thanks <a href="http://geektimes.ru/users/mgyk/" class="user_link">mgyk</a> for the hint. <br><br>  So, at the moment we have solved the problem with the distribution of content and the substitution of correct links depending on the time constant.  Next base. <br><br>  The problem is the same - you need to be able to use 2 bases in parallel.  Very well, if you already have a cluster.  With it we solve one important problem - we have a replication server.  If this server is supported by the master-master and you can also add servers on the fly, then this is just super.  All we need is to raise the secure channel between the servers and configure replication through it.  On a live server, we raise the master, set up replication with our working server and it delays (at least should) the entire database itself + constantly keeps it up to date which is very important.  At the moment it works like a ‚Äúslave‚Äù i.  Only synchronized with the main database. <br><br>  If the replication server is not installed on the main server, you will have to install it.  During installation, you may have to restart the DBMS, which may cause interruptions in the work of the site.  So it is better to practice "on cats" i.  somewhere else. <br><br>  If replication is impossible, then we are at a dead end ... <br><br>  Perhaps many will say that replication is not the best way.  Yes, perhaps it is.  It will slow down a little, and in real-time mode it will load the entire system, but this is not really for long.  Just for a few hours, until you transfer the main content and all DNSa are updated.  It took me no more than 30 hours. <br><br>  So, the problem with the base will be considered closed.  It is configured and synchronized normally.  It remains just a little bit, be patient.  Your site is already one foot on another server :) <br><br>  Starting a smooth transition - add the IP of the new server to your primary domain.  As the zone is updated, users will go to your new site.  This should start to do after the cherished date.  Also make sure that all new content from the old server is poured onto the new one and the database is working as it should.  Now she can slow down.  It all depends on the channel, but if you do not store pictures, music, video, etc. in it, then the synchronization will not strain. <br><br>  As soon as you are convinced that everything is going as it should, start pouring old content.  Just make a copy of it.  Do not worry, he has not changed.  Of course, if everything works as it should.  As soon as all content is uploaded - remove the old IP from the domain.  There must be only a new one.  As the zone is updated, all users will switch to the new server.  About a day later, just in case hang up on the old server in the virtual for the domain, a page with a request to update the DNS cache.  This is if someone zaksirovalsya.  Stop the replication server on the new server.  Fill in old scripts without checks.  If everything is fine - congratulations - you are on a new server.  If something went wrong - I'm not guilty :) <br><br>  Do not rush to stop the old server and give it to the hoster.  Hold another couple of weeks.  Suddenly something did not overflow, so you will have an old copy and you will be able to recover the data. <br><br>  Also, be careful when you make changes to the scripts - they should not try to upload content on the new server.  To do this, you need to make an additional check for their location.  For example, to add some file that will only be on a new server, and if it exists, it means not to send content. <br><br>  Actually that's all. <br><br>  Thank you for your attention and <u>invite</u> , I hope this will help someone. </div><p>Source: <a href="https://habr.com/ru/post/52750/">https://habr.com/ru/post/52750/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../52738/index.html">Adobe InDesign 6.0.1 update</a></li>
<li><a href="../52741/index.html">Safari 4 Beta</a></li>
<li><a href="../52744/index.html">Prepaid for electricity meter</a></li>
<li><a href="../52745/index.html">Mirrors math hicks</a></li>
<li><a href="../52746/index.html">What torrent trackers do you use?</a></li>
<li><a href="../52751/index.html">Compatibility of ESET NOD32 with Windows 7</a></li>
<li><a href="../52752/index.html">Compact SLR Olympus E-620</a></li>
<li><a href="../52754/index.html">Samsung W7100 - children's mobile phone with siren</a></li>
<li><a href="../52756/index.html">SMS voting is a way to get around piracy</a></li>
<li><a href="../52757/index.html">Steve, happy birthday.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>