<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Homemade Bluetooth AB Class Amplifier with Power Management Automation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started with laziness. 
 Or rather, with Vega 50u-122s, inherited along with the acoustics Electronics 25as-033. And at first everything was fi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Homemade Bluetooth AB Class Amplifier with Power Management Automation</h1><div class="post__text post__text-html js-mediator-article"> It all started with laziness. <br>  Or rather, with Vega 50u-122s, inherited along with the acoustics Electronics 25as-033.  And at first everything was fine.  And then, stumbling over the wire, the laptop was killed.  After that, the BT module appeared in Vega, and Vega learned how to switch on by connecting devices to this module. <br><br>  Time passed and the quality was not enough.  Then the first upgrade was made to Vega.  Then the second.  Then acoustics.  Then ... Then the understanding came that it is necessary to do something qualitatively new.  Well, when Vega began to wheeze and the prospect of a complete soldering of all electrolytes loomed ... <br><br>  And the construction began ... <br>  Those who are too lazy to read technical details and just want to see how it works - you can scroll to the end, there is a shortened video version for my channel. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/geektimes/post_images/22c/b87/e24/22cb87e2489640d1c7bb6f5f9939b601.jpg" alt="image"><br><br><a name="habracut"></a><br>  This is not a story about how to solder this.  This is not an instruction: there will be no diagrams, no description of the settings, and so on. <br>  This will be a story about ideas and technologies that I use in my devices. <br>  Ideas that I embodied myself, and which you may want to embody. <br><br>  <b>So.</b> <br><br>  Basic idea.  I want an amplifier.  But I do not want to be confused in the wires.  This is not convenient and not as high quality as we would like.  Need some kind of wireless solution. <br><br>  Second idea.  I don't want to run around and poke buttons somewhere.  Especially if I want to listen to relaxing music before bedtime.  Yes, I am a lazy brute, I want to lie on the sofa, press the power button of the laptop and that everything would turn on and play itself.  And when I fall asleep and the laptop turns off with a script, it turns off after it. <br><br>  The third idea.  Timers.  In other words - on the weekend I do not turn off the laptop for the night.  And this means that if the power-on via bluetooth is implemented, then the amplifier will be turned on all night.  Somehow it's not cool, considering that the filter capacitors are worn out first.  And secondly, it is simply heated and devours electricity. <br><br>  The fourth idea.  I want an indicator.  Big.  Nice.  Indicator.  And then I found the IN-33, in the joy of writing the <a href="https://geektimes.ru/post/264154/">previous article</a> .  But not to say that it is big, so a trick was found with a film from the monitor, which visually ‚Äúforks‚Äù the scale. <br><br>  <b>As a result</b> , thinking about all the ideas, I came to the conclusion that a new amplifier should be made from scratch. <br>  A <a href="http://fas.st/yP3QX">Bluetooth module with apt-x</a> was ordered: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/dcc/c88/777/dccc88777531fa4b0656923921f26b2b.jpg" alt="image"><br><br>  The following <a href="http://fas.st/Lndjz">AB class amplifiers</a> were ordered: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/af4/e76/1d3/af4e761d331d5cd6c9443c5687fc9b7c.jpg" alt="image"><br><br>  My grandfather bought a chic TOR at 200 watts for only 1000 rubles.  with ready branches 2x26v and 2x12v.  But the rest already did. <br><br>  <b>Housing</b> <br><br>  The case was made 300x300mm, the bottom - a dural plate 5mm thick on it is attached P figuratively bent corner 50 * 100 * 5mm, to which the transistors are attached through silicone pads and kit, and on top everything is tightened with bolts and a bar 20 * 6mm <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/4d0/a72/2c8/4d0a722c89f75fe5a4cb4cb7237dce01.jpg" alt="image"><br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/efd/ef6/754/efdef6754534d9aa3fe592a6e1606512.jpg" alt="image"><br><br>  The front panel is mineral glass.  Glass was taken from a photo frame for 300 rubles and clipped to the desired size with an ordinary glass cutter. <br>  Then ordered silk screening.  Moreover, I recommend not to cut on the paint and still do with the paint on the glass.  Otherwise, sooner or later it will peel off and it will be a pity. <br><img src="https://habrastorage.org/getpro/geektimes/post_images/7da/884/1e2/7da8841e2a7f88272b0e62850bd4e74c.jpg" alt="image"><br><br>  And, I recommend silk screen printing, because direct printing is garbage.  I will explain: <br>  Direct print on clearance (another project) <br><img src="https://habrastorage.org/getpro/geektimes/post_images/2c1/032/370/2c1032370c75124ff6ce8c1ea102c542.jpg" alt="image"><br><br>  But the silk screen on the light: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/c48/106/7bf/c481067bf8a03e14105386e94e1fec7e.jpg" alt="image"><br><br>  The hole for the volume control is simply drilled on the glass with a drill. <br>  Moreover, if you do it for the first time, I recommend to practice.  It is not as fast and simple as it seems. <br><img src="https://habrastorage.org/getpro/geektimes/post_images/762/2f5/fcd/7622f5fcd99750cd13f1e798f29c9f2d.jpg" alt="image"><br><br>  Then the sensors.  White double adhesive tape was stuck on the glass.  Then the copper foil was taken, on the one hand they were taped with adhesive tape, on the other side LUT was applied a drawing and was etched ‚Äúthrough‚Äù. <br>  It turned out like this: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/ecf/9e4/6c0/ecf9e46c0105f4b72d93a2e9cf0034d3.jpg" alt="image"><br><br>  Then the foil was removed, everything was washed and it turned out: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/518/5c4/498/5185c4498e0bdd1f58e254d0a4c4364f.jpg" alt="image"><br><br>  These are ready preparations for sensors.  Outlets were soldered to them and the whole structure was molded onto the front panel. <br><img src="https://habrastorage.org/getpro/geektimes/post_images/5d4/31e/075/5d431e07538f8b6b892cf9f4299bd708.jpg" alt="image"><br><br>  The exact alignment is important.  Because everything should work for a clearance. <br><img src="https://habrastorage.org/getpro/geektimes/post_images/63e/460/77b/63e46077b17daa1be2d0a6e7d5a5340a.jpg" alt="image"><br><br>  Next indicator.  For the "expansion" of the scale, a prismatic substrate from the monitor matrix was used.  And what would she lay down, glued superglue.  Clay do not regret! <br>  It is important to drive out all the bubbles and apply a film much wider than the indicator itself, otherwise the glue will spill over onto the opposite side and spoil everything. <br>  Well, we must bear in mind that this film ‚Äúforks‚Äù in only one plane, so it is important to maintain the strict horizontal position of the film prisms. <br><img src="https://habrastorage.org/getpro/geektimes/post_images/ae1/83c/ea8/ae183cea823f64c661ce415e17a934a1.jpg" alt="image"><br><br>  On this, if everything is illuminated from the inside, it will turn out like this: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/f67/5a5/a9b/f675a5a9bcdb6d285e8c2f74758bbe9b.jpg" alt="image"><br><br>  But to make a uniform highlighting of characters is not as easy as it may seem. <br>  The fact is that if you just take the LED and start to shine, the light illuminates part of the icon.  Looks ugly.  Moreover, if in the twilight it may still seem that everything is not bad, then in total darkness there will be a mass of flare shoals.  Annoyed. <br><br>  The output is as follows: <br>  Foil was taken, twisted into a cone: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/0b0/4c0/785/0b04c07854d3acf30aa35f1f162b9d0f.jpg" alt="image"><br><br>  Then hot melt glue.  I liked the iron for this, although my wife did not share my joy ... <br><img src="https://habrastorage.org/getpro/geektimes/post_images/d73/561/aaa/d73561aaad172767427e0ad0968ab7f5.jpg" alt="image"><br><br>  Then it was poured and clipped to the size of the highlighted icon, a recess for the LED was drilled from the back side. <br><img src="https://habrastorage.org/getpro/geektimes/post_images/9f1/7b9/771/9f17b9771d80dccc5951c11eab8935ef.jpg" alt="image"><br><br>  Well, it stuck.  I pasted superglue.  But then it would be thought that it would be better to simply heat up the glue of the cone and stick it straight on it. <br>  And small gaps between the foil of the cone and the foil of the icons were plastered with putty and painted over.  Putty - so that the paint does not flow between the filter and the sensor.  After installing the LED icons - and they painted over the butt.  Only in this way was I able to completely get rid of third-party covenants. <br><br>  <b>According to the scheme.</b> <br>  I'll start with power supplies.  There are 2 of them. <br><br>  The first is a power supply unit, not voltage stabilized.  Assembled according to the scheme with 2 separate diode bridges, each arm has 33V of constant power and a 3x10,000 microfarad block of electrolytes, shunted with a 0.33 micron film and 1 microfarad ceramics.  Also, the transformer windings themselves are shunted with 1 micron ceramics. <br><br>  Power wiring: from transformer to bridges 2.5mm ^ 2, from bridges to capacitor banks - 4mm ^ 2, from capacitor units to plan amplifiers 6mm ^ 2. <br><br>  The second is on duty.  The Bluetooth module board must be constantly powered, so that you can always connect to it.  Well, what would be understood that they connected to the amplifier and turn on the main power supply - it is also necessary to power the controller board.  Therefore, the duty unit is low-power and pulse.  Taken just charging from asus eee.  Moreover, the analog part, namely the bluetooth module, is powered through an additional linear stabilizer. <br><br>  Boards of amplifiers also had to completely re-solder.  One board was nothing, but the second one was simply obscene.  + further extended power tracks. <br><br>  STM32 was chosen as the central ‚Äúbrain‚Äù.  In principle, I could use the arduin on AVR, but meg firstly have few legs, and secondly only one ADC, which is why the indicator does not work well.  The fact is that while we are digitizing one channel, the sound changes in both, and by the time the second is digitized, the difference is already quite large.  This is striking and wanted to avoid it.  Therefore, STM32. <br><br>  The indicator scheme is not much different from the scheme from the previous article (by the way, it seems no one noticed a mistake in the scheme, but oh well). <br><br>  <b>Control.</b> <br>  Touch keys were needed.  Having rummaged in articles about sensory for STM32, I found several options that I was not thrilled about. <br>  First, I did not understand anything))) <br>  Secondly, I had 5 buttons.  Yes, and what would it work through a 3 mm mineral glass. <br><br>  As a result, I had to taste the principle, experiment a bit and got the following code: <br><div class="spoiler">  <b class="spoiler_title">Sensor code reading</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// #define SenseMinLevel 100 // #define ButZ GPIOA, GPIO_Pin_10 #define BtnOn GPIOB, GPIO_Pin_15 #define BtnOff GPIOA, GPIO_Pin_8 #define BtnAuto GPIOA, GPIO_Pin_9 #define BtnBT GPIOA, GPIO_Pin_3 #define BtnRCA GPIOA, GPIO_Pin_2 //  volatile uint16_t CalibrateTimeB1 = 0; volatile uint16_t CalibrateTimeB2 = 0; volatile uint16_t CalibrateTimeB3 = 0; volatile uint16_t CalibrateTimeB4 = 0; volatile uint16_t CalibrateTimeB5 = 0; //    uint8_t SenseButton(void) { uint16_t m; uint16_t b1 = 0; uint16_t b2 = 0; uint16_t b3 = 0; uint16_t b4 = 0; uint16_t b5 = 0; for (m = 0; m &lt; 21; m++) { b1 += scan_sense_pin(BtnOff); b2 += scan_sense_pin(BtnOn); b3 += scan_sense_pin(BtnAuto); b4 += scan_sense_pin(BtnBT); b5 += scan_sense_pin(BtnRCA); } if (CalibrateTimeB1 == 0) { CalibrateTimeB1 = b1; CalibrateTimeB2 = b2; CalibrateTimeB3 = b3; CalibrateTimeB4 = b4; CalibrateTimeB5 = b5; } else { if (b1 &gt; CalibrateTimeB1) b1 -= CalibrateTimeB1; else b1 = 0; if (b2 &gt; CalibrateTimeB2) b2 -= CalibrateTimeB2; else b2 = 0; if (b3 &gt; CalibrateTimeB3) b3 -= CalibrateTimeB3; else b3 = 0; if (b4 &gt; CalibrateTimeB4) b4 -= CalibrateTimeB4; else b4 = 0; if (b5 &gt; CalibrateTimeB5) b5 -= CalibrateTimeB5; else b5 = 0; } //    if (b1 &gt; SenseMinLevel || b2 &gt; SenseMinLevel || b3 &gt; SenseMinLevel || b4 &gt; SenseMinLevel || b5 &gt; SenseMinLevel) { if (b1 &gt; b2 &amp;&amp; b1 &gt; b3 &amp;&amp; b1 &gt; b4 &amp;&amp; b1 &gt; b5) return 1; if (b2 &gt; b1 &amp;&amp; b2 &gt; b3 &amp;&amp; b2 &gt; b4 &amp;&amp; b2 &gt; b5) return 2; if (b3 &gt; b1 &amp;&amp; b3 &gt; b2 &amp;&amp; b3 &gt; b4 &amp;&amp; b3 &gt; b5) return 3; if (b4 &gt; b1 &amp;&amp; b4 &gt; b3 &amp;&amp; b4 &gt; b2 &amp;&amp; b4 &gt; b5) return 4; if (b5 &gt; b1 &amp;&amp; b5 &gt; b3 &amp;&amp; b5 &gt; b4 &amp;&amp; b5 &gt; b2) return 5; } return 0; } uint16_t scan_sense_pin(GPIO_TypeDef* port, uint16_t pin) { uint16_t ret = 0; GPIO_ResetBits(ButZ); delay_t(1800); GPIO_SetBits(ButZ); while (!GPIO_ReadInputDataBit(port, pin) &amp;&amp; ret &lt; 500) { ret++; } GPIO_ResetBits(ButZ); return ret; } void delay_t(uint32_t ms) { // nCount=(RCC_Clocks.HCLK_Frequency/1000)*ms; // for (; nCount!=0; nCount--); for (; ms!=0; ms--); }</span></span></code> </pre> <br></div></div><br><br>  Where - ButZ - bare pin, in GPIO_Mode_Out_PP mode, the rest - read in GPIO_Mode_IN_FLOATING mode <br>  The idea is simple.  All reading sensors are connected to the bare pin through a 3MŒ© resistor.  Next, we give a unit to the bare pin and see how long it takes to charge up to the logical unit of the pin sensor.  If the calibration time is longer, it means that you have to charge your finger, leaning against the sensor.  So - there is a touch to the sensor. <br><br>  <b>Modes of operation</b> <br><br>  There are three of them. <br><br>  First - Just off.  And that's all. <br><br>  The second mode is continuous power on.  In this case, the amplifier always works.  However, in case of idle time without sound, the level indicator turns off after a minute. <br><br>  The third is ‚ÄúA‚Äù.  And this is the main mode, automatic.  If the Bluetooth input is selected, the amplifier is turned on and off by connecting the sound source.  But if the device is connected and does not play - after 15 minutes the amplifier will go into standby mode.  And, of course, if there is no sound for a minute, the level indicator turns off. <br><br>  Moreover, it does not matter which audio input is used - whether it is bluetooth or external RCA input. <br><br>  In general, the rest is standard.  The volume knob is just a variable resistor.  Just because the main volume control is assumed to be on the laptop and no one will go to the amplifier for this. <br><br>  The result is beautiful.  And it does not sound bad! <br><br>  Video: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/NJDqo55z5uE%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjyGs-nS_raAGOlfT24Qc11enatzg" frameborder="0" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/369323/">https://habr.com/ru/post/369323/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../369313/index.html">Keychain for rapid assessment of the ripple coefficient of energy-saving lamps</a></li>
<li><a href="../369315/index.html">The scandal in the competition "Miss Universe" happened because of a designer error</a></li>
<li><a href="../369317/index.html">Safety on a quadcopter: calibrate the compass and hold it with your hand</a></li>
<li><a href="../369319/index.html">Troy fell when she opened the door for a gift horse. From such "gifts" will save the electronic door "chain"</a></li>
<li><a href="../369321/index.html">Simple vs. Free: Compare Moodle and Teachbase</a></li>
<li><a href="../369325/index.html">Economy 2.0: why I don‚Äôt believe in banks in 15 years</a></li>
<li><a href="../369327/index.html">Ask Ethan # 53: What is the Big Break?</a></li>
<li><a href="../369329/index.html">Tesla Model Xmas: electric cars can entertain</a></li>
<li><a href="../369331/index.html">Autocoding "Blade Runner"</a></li>
<li><a href="../369333/index.html">About mobile applications in the Soviet Union</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>