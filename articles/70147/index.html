<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>File storage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I had to work actively with sites that store large amounts of information in the file system. These are various photo sites and file hosting...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>File storage</h1><div class="post__text post__text-html js-mediator-article">  Recently, I had to work actively with sites that store large amounts of information in the file system.  These are various photo sites and file hosting sites, as well as sites with video content downloads, some sites were designed and programmed by me from scratch, some were copied, finished or ‚Äúput in order‚Äù. <br>  I should note that file storage in the file system is for many programmers an area that passes by their attention. <a name="habracut"></a><br>  First, I‚Äôll give you a small overview of common mistakes: <br>  1. The file is stored in the file system under the Cyrillic name.  Actually, the following happens: the user uploads a file with the name, say, ‚Äúnameless-1.jpg‚Äù, a programmer with the same name shoves it into the directory where files are stored.  I hope you do not need to explain what problems this may entail? <br>  2. The file is stored under the same name under which it was loaded by the user, but the characters not included in the Latin alphabet are transliterated.  Already better, but still this method causes many problems, for example, users love to load files with the same name))) And it's not that they are so angry, for example, my camera after each cleaning of a memory card starts numbering photos from 00001. <br>  And the third most common mistake: <br>  3. Stores in the directory the number of files exceeding the file system.  Consider this situation on a specific example, I rewrote file hosting, large, at the time of rewriting the amount of information came close to four terabytes, and this despite the fact that 80 percent of the files were pictures.  All files on the disk (there were 4 disks per terabyte) were randomly scattered across two dozen directories, and so on until the disk was full, then the program moved to the next disk.  As a result, it took about three seconds to open a directory to a web server.  Agree, it is a lot of disastrous.  In each directory on the disk were about twenty thousand files. <br>  After analyzing several such situations, I tried to deduce a file storage method that would satisfy the following conditions: <br>  1. The directory should not slow down, that is, more than 1000 files or directories should not be stored in one directory (the number is taken with a margin). <br>  2. File names should not be repeated. <br>  3. It is advisable not to keep two copies of the same file. <br>  After some deliberation, I came to the following scheme, which I want to share with fellow programmers. <br>  I'll start with the last requirement not to keep two copies of the file.  To determine the integrity of the file, the md5 hash for php has been used successfully for a long time and is solved by the function md5_file (filename), which calculates the MD5 hash of the file, whose name is given by the argument using the MD5 algorithm of RSA Data Security, Inc.  and returns this hash.  A hash is a 32-digit hexadecimal number. <br>  If two files are the same for them and the hash will be the same, if different files are different.  Now stones will fly into me accompanied by arguments about collisions and unreliability md5.  I will answer in order md5 is not reliable?  But we do not set ourselves the task of deceiving the ‚Äúprobable enemy‚Äù!  We just get a unique file id and that's it.  And about the collisions ... I do not insist on repeating my method one-on-one, use another function.  Just think, two in two hundred and fifty-sixth degree is a lot!  If they tell me about the possibility of collisions, I ask a person to give an example of two lines or two files, md5 hash, which are the same ... I have not yet been given such a pair so that the possibility is purely theoretical. <br>  The second point - ‚Äúfile names should not be repeated, directly follows from the third.  If we use the string md5 hash as the name of the file on the disk, the file names are not repeated (the actual file names (those that the user uploaded) we can store in the database).  In the case of users downloading two identical files, we get the same names from them.  And the first - the files will not be duplicated, the second - we do not worry about the names in the directories. <br>  Now a little more complicated about storing files on disk.  I create a nested directory structure based on file names.  Here, too, full scope for fantasy.  I by no means call blindly to copy my method.  I usually do two, three levels of nesting directories.  The first level is the first two letters of the file name (do not forget, the file name is its md5 hash!);  the second level is the third and fourth letters ... <br>  Each level of nesting gives me * 256 directories. <br>  That is, if I can upload no more than 1000 files into one directory, then with one nesting level I can safely place 256,000 files on a disk;  with two levels of nesting - 65,536,000;  with three - 16 777 216 000 and so on.  The length of the string md5 hash allows us to make 16 levels of nesting in directories.  In my opinion, this is enough to ensure the work of the most capacious disks.  Although, based on practice, usually, there are three levels ‚Äúby the eye‚Äù for projects of any complexity. <br>  PS <a href="https://sites.google.com/site/kamaikin/rabota-s-fajlami-1/teoria-hranenia-fajlov-na-servere">Updated and detailed version (written following the discussion)</a> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/70147/">https://habr.com/ru/post/70147/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../70140/index.html">PHP Database Engine</a></li>
<li><a href="../70141/index.html">Looking for KVM ...</a></li>
<li><a href="../70142/index.html">Coworking: 18 months later</a></li>
<li><a href="../70145/index.html">Automatic configuration of apache vhosts or denwer for Mac</a></li>
<li><a href="../70146/index.html">The nuances of creating a hyperlink, on the user leading</a></li>
<li><a href="../70150/index.html">Revolution 2.0</a></li>
<li><a href="../70151/index.html">Work with databases in iPhone, SQLite and work with dates</a></li>
<li><a href="../70162/index.html">Rock # 1: First Album Compiled</a></li>
<li><a href="../70164/index.html">KO3: HMVC and Routing</a></li>
<li><a href="../70165/index.html">Majesty 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>