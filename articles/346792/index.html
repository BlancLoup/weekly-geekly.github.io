<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementation of an asynchronous secure communication system based on TCP sockets and central OpenVPN server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to tell you about my implementation of the messenger with double encryption of messages based on tcp sockets, OpenVPN server, P...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementation of an asynchronous secure communication system based on TCP sockets and central OpenVPN server</h1><div class="post__text post__text-html js-mediator-article">  In this article I want to tell you about my implementation of the messenger with double encryption of messages based on tcp sockets, OpenVPN server, PowerDNS server. <br>  The essence of the task is to provide Internet messaging bypassing NAT between clients on different platforms (IOS, Android, Windows, Linux).  It is also necessary to ensure the security of transmitted data. <br><a name="habracut"></a><br>  My system consists of: <br><ul><li>  OpenVPN server </li><li>  PowerDNS server </li><li>  Proxy.  In my case, this is a service I wrote on a Ruby on Rails Web service with the implementation of the SOAP protocol.  That is, on this SOAP server, I describe the mechanism for performing certain actions, then I make a SOAP request from the client terminal, the server performs some actions, such as an update of the PowerDNS zone, and returns a response to the terminal - successfully or unsuccessfully.  Very comfortably. </li><li>  directly client terminals. </li></ul><br><br>  On client terminals, a tcp socket is raised that listens to a specific port for incoming messages.  If the message arrives, the socket outputs it to the terminal.  The message itself contains the sender's username.  The tcp client socket is also opened for sending messages. <br>  The socket opens directly with the remote client terminal.  Therefore, in my case, the interaction is in client-client mode. <br>  The search for customers occurs by username.  The username and IP addresses are stored in the PowerDNS server. <br>  PowerDNS is a high-performance DNS server written in C ++ and licensed under the GPL license.  Development is carried out in the framework of support for Unix-systems;  Windows systems are no longer supported. <br>  The server was developed at the Dutch company PowerDNS.com by Bert Hubert and is maintained by the free software community. <br>  PowerDNS uses a flexible data storage / access architecture that can retrieve DNS information from any data source.  This includes files, BIND zone files, relational databases, or LDAP directories. <br>  PowerDNS is configured by default to serve requests from the database. <br>  After the release of version 2.9.20, the software is distributed in the form of two components - (Authoritative Server) (authoritative DNS) and Recursor (recursive DNS). <br>  The choice of this solution is due to the fact that PowerDNS is able to work with the database without connecting additional modules, as well as a higher speed of work in comparison with other freely distributed solutions. <br>  For my purposes, only an authoritative module was enough for me; <br><br>  Client terminals communicate with all internal components through the SOAP Gateway. <br>  The logic of work is as follows - the client includes the program, the SOAP method is executed on the update zone on the PowerDNS server.  If a client wants to contact someone, he enters or selects the corresponding username in the list, performs a SOAP method to obtain an IP address from the DNS database, and connects to the remote client by IP address. <br>  I have written ready-made clients for IOS, Android, Windows.  When writing them, I used the xamarin framework.  Very convenient, only small code changes were required to transfer the application to another platform. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, I will present the client and server socket codes that I use on the client terminals.  Here are the codes for iOS.  For Android and Windows will be almost like that.  The difference is only in different types of elements (buttons, text blocks, etc.) <br><br><div class="spoiler">  <b class="spoiler_title">Server tcp socket code</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GlobalFunction</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeLOG</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> loggg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//        string path = @"bin\logfile.log"; string time = DateTime.Now.ToString("hh:mm:ss"); string date = DateTime.Now.ToString("yyyy.MM.dd"); string logging = date + " " + time + " " + loggg; using (StreamWriter sw = File.AppendText(path)) { sw.WriteLine(logging); } } public static void writeLOGdebug(string loggg) { try { //        string path = @"bin\logfile.log"; string time = DateTime.Now.ToString("hh:mm:ss"); string date = DateTime.Now.ToString("yyyy.MM.dd"); string logging = date + " " + time + " " + loggg; using (StreamWriter sw = File.AppendText(path)) { sw.WriteLine(logging); } } catch (Exception exc) { } } } public class Globals { public static IPAddress localip = "192.168.88.23"; public static int _localServerPort = 19991; public const int _maxMessage = 100; public static string _LocalUserName = "375297770001"; public struct MessBuffer { public string usernameLocal; public string usernamePeer; public string message; } public static List&lt;MessBuffer&gt; MessagesBase = new List&lt;MessBuffer&gt;(); public static List&lt;MessBuffer&gt; MessagesBaseSelected = new List&lt;MessBuffer&gt;(); } public class StateObject { // Client socket. public Socket workSocket = null; // Size of receive buffer. public const int BufferSize = 1024; // Receive buffer. public byte[] buffer = new byte[BufferSize]; // Received data string. public StringBuilder sb = new StringBuilder(); } public partial class ViewController : UIViewController { public static ManualResetEvent allDone = new ManualResetEvent(false); public void startLocalServer() { //IPHostEntry ipHost = Dns.GetHostEntry(_serverHost); //IPAddress ipAddress = ipHost.AddressList[0]; IPAddress ipAddress = Globals.localip; IPEndPoint ipEndPoint = new IPEndPoint(ipAddress, Globals._localServerPort); Socket socket = new Socket(ipAddress.AddressFamily, SocketType.Stream, ProtocolType.Tcp); socket.Bind(ipEndPoint); socket.Listen(1000); GlobalFunction.writeLOGdebug("Local Server has been started on IP: " + ipEndPoint); while (true) { try { // Set the event to nonsignaled state. allDone.Reset(); // Start an asynchronous socket to listen for connections. socket.BeginAccept( new AsyncCallback(AcceptCallback), socket); // Wait until a connection is made before continuing. allDone.WaitOne(); } catch (Exception exp) { GlobalFunction.writeLOGdebug("Error. Failed startLocalServer() method: " + Convert.ToString(exp)); } } } public void AcceptCallback(IAsyncResult ar) { // Signal the main thread to continue. allDone.Set(); // Get the socket that handles the client request. Socket listener = (Socket)ar.AsyncState; Socket handler = listener.EndAccept(ar); // Create the state object. StateObject state = new StateObject(); state.workSocket = handler; handler.BeginReceive(state.buffer, 0, StateObject.BufferSize, 0, new AsyncCallback(ReadCallback), state); } public void ReadCallback(IAsyncResult ar) { String content = String.Empty; // Retrieve the state object and the handler socket // from the asynchronous state object. StateObject state = (StateObject)ar.AsyncState; Socket handler = state.workSocket; // Read data from the client socket. int bytesRead = handler.EndReceive(ar); if (bytesRead &gt; 0) { // There might be more data, so store the data received so far. state.sb.Append(Encoding.UTF8.GetString( state.buffer, 0, bytesRead)); // Check for end-of-file tag. If it is not there, read // more data. content = state.sb.ToString(); if (content.IndexOf("&lt;EOF&gt;") &gt; -1) { // All the data has been read from the // client. Display it on the console. string[] bfd = content.Split(new char[] { '|' }, StringSplitOptions.None); string decrypt = MasterEncryption.MasterDecrypt(bfd[0]); string[] bab = decrypt.Split(new char[] { '~' }, StringSplitOptions.None); Globals.MessBuffer Bf = new Globals.MessBuffer(); Bf.message = bab[2]; Bf.usernamePeer = bab[0]; Bf.usernameLocal = bab[1]; string upchat_m = "[" + bab[1] + "]# " + bab[2]; this.InvokeOnMainThread(delegate { frm.messageField1.InsertText(Environment.NewLine + "[" + bab[1] + "]# " + bab[2]); }); //if (Ok != null) { Ok(this, upchat_m); } Globals.MessagesBase.Add(Bf); //GlobalFunction.writeLOGdebug("Received message: " + content); // Echo the data back to the client. //Send(handler, content); } else { handler.BeginReceive(state.buffer, 0, StateObject.BufferSize, 0, new AsyncCallback(ReadCallback), state); } } } }</span></span></code> </pre> <br><br></div></div><br><br>  The server is started in a separate thread, for example, like this: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Thread _serverLocalThread; <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> The main entry point for the application. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> [STAThread] static void Main() { _serverLocalThread = new Thread(GlobalFunction.startLocalServer); _serverLocalThread.IsBackground = true; _serverLocalThread.Start(); Application.EnableVisualStyles(); Application.SetCompatibleTextRenderingDefault(false); Application.Run(new Form1()); } }</span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Client's tcp socket code</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DidReceiveMemoryWarning</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.DidReceiveMemoryWarning(); <span class="hljs-comment"><span class="hljs-comment">// Release any cached data, images, etc that aren't in use. } private void connectToRemotePeer(IPAddress ipAddress) { try { IPEndPoint ipEndPoint = new IPEndPoint(ipAddress, Globals._localServerPort); _serverSocketClientRemote = new Socket(ipAddress.AddressFamily, SocketType.Stream, ProtocolType.Tcp); _serverSocketClientRemote.Connect(ipEndPoint); GlobalFunction.writeLOGdebug("We connected to: " + ipEndPoint); } catch (Exception exc) { GlobalFunction.writeLOGdebug("Error. Failed connectToRemotePeer(string iphost) method: " + Convert.ToString(exc)); } } private void sendDataToPeer(string textMessage) { try { byte[] buffer = Encoding.UTF8.GetBytes(textMessage); int bytesSent = _serverSocketClientRemote.Send(buffer); GlobalFunction.writeLOGdebug("Sended data: " + textMessage); } catch (Exception exc) { GlobalFunction.writeLOGdebug("Error. Failed sendDataToPeer(string testMessage) method: " + Convert.ToString(exc)); } } private void Client_listner() { try { while (_serverSocketClientRemote.Connected) { byte[] buffer = new byte[8196]; int bytesRec = _serverSocketClientRemote.Receive(buffer); string data = Encoding.UTF8.GetString(buffer, 0, bytesRec); //string data1 = encryption.Decrypt(data); if (data.Contains("#updatechat")) { //UpdateChat(data); GlobalFunction.writeLOGdebug("Chat updated with: " + data); continue; } } } catch (Exception exc) { GlobalFunction.writeLOGdebug("Error. Failed Client_listner() method: " + Convert.ToString(exc)); } } private void sendMessage() { try { connectToRemotePeer(Globals._peerRemoteServer); _RemoteclientThread = new Thread(Client_listner); _RemoteclientThread.IsBackground = true; _RemoteclientThread.Start(); string data = inputTextBox.Text; Globals.MessBuffer ba = new Globals.MessBuffer(); ba.usernameLocal = Globals._LocalUserName; ba.usernamePeer = Globals._peerRemoteUsername; ba.message = data; Globals.MessagesBase.Add(ba); if (string.IsNullOrEmpty(data)) return; string datatopeer = Globals._peerRemoteUsername + "~" + Globals._LocalUserName + "~" + data; string datatopeerEncrypted = MasterEncryption.MasterEncrypt(datatopeer); sendDataToPeer(datatopeerEncrypted + "|&lt;EOF&gt;"); addLineToChat(data, Globals._LocalUserName); inputTextBox.Text = string.Empty; } catch (Exception exp) { GlobalFunction.writeLOGdebug(Convert.ToString(exp)); } } private void addLineToChat(string msg, string username) { messageField1.InsertText(Environment.NewLine + "[" + username + "]# " + msg); } public void addFromServer(string msg, string username) { messageField1.InsertText(Environment.NewLine + "[" + username + "]# " + msg); } private void listBox1_Click() { messageField1.Text = ""; Globals.MessagesBaseSelected.Clear(); GlobalFunction.ReloadLocalBufferForSelected(); for (int i = 0; i &lt; Globals.MessagesBaseSelected.Count; i++) { messageField1.InsertText(Environment.NewLine + "[" + Globals.MessagesBaseSelected[i].usernameLocal + "]# " + Globals.MessagesBaseSelected[i].message); } Globals._peerRemoteServer = GlobalFunction.getPEERIPbySOAPRequest(Globals._peerRemoteUsername); string Name = Globals._LocalUserName; GlobalFunction.writeLOGdebug("Local name parameter listBox1_DoubleClick: " + Name); connectToRemotePeer(Globals._peerRemoteServer); _RemoteclientThread = new Thread(Client_listner); _RemoteclientThread.IsBackground = true; _RemoteclientThread.Start(); } public static ViewController Form;</span></span></code> </pre><br></div></div><br><br>  OpenVPN server is needed to overcome NAT, as well as for additional data protection. <br>  In the case of OpenVPN, we have some kind of addressing inside the tunnel, through which customers can communicate. <br>  I will not describe the installation process of the OpenVPN server, as there is a lot of information on this topic.  I will give only my configuration.  It is fully optimized for my purposes and fully working (copied from the working server as it is, unchanged, only the IP in the client configuration was changed to fake, instead of 1.1.1.1 you need to specify the IP address of your OpenVPN server). <br>  OpenVPN conducts all network operations via TCP or UDP transport.  In general, UDP is preferred because the tunnel passes through network layer traffic and higher on OSI, if a TUN connection is used, or link layer traffic and above, if TAP is used.  This means that OpenVPN for the client acts as a channel or even physical layer protocol, which means that data transfer reliability can be provided by OSI higher layers, if necessary.  That is why the UDP protocol is closest to OpenVPN in its concept, since  he, like the channel and physical layer protocols, does not ensure the reliability of the connection, passing this initiative to higher levels.  If you configure the tunnel to work on TCP, the server will typically receive OpenVPN TCP segments that contain other TCP segments from the client.  As a result, the chain produces a double check for the integrity of information, which makes no sense at all, because  reliability does not increase, and connection and ping speeds decrease. <br><br><div class="spoiler">  <b class="spoiler_title">My OpenVPN Server Configuration</b> <div class="spoiler_text">  port 8443 <br>  proto udp <br>  dev tun <br><br>  cd / etc / openvpn <br>  persist-key <br>  persist tun <br>  tls-server <br>  tls-timeout 120 <br><br>  #certificates and encryption <br>  dh /etc/openvpn/keys/dh2048.pem <br>  ca /etc/openvpn/keys/ca.crt <br>  cert /etc/openvpn/keys/server.crt <br>  key /etc/openvpn/keys/server.key <br>  tls-auth /etc/openvpn/keys/ta.key 0 <br>  auth SHA512 <br>  cipher AES-256-CBC <br>  duplicate-cn <br>  client-to-client <br><br>  #DHCP information <br>  server 10.0.141.0 255.255.255.0 <br>  topology subnet <br>  max-clients 250 <br>  route 10.0.141.0 255.255.255.0 <br><br>  #any <br>  mssfix <br>  float <br>  comp-lzo <br>  mute 20 <br><br>  #log and security <br>  user nobody <br>  group nogroup <br>  keepalive 10 120 <br>  status /var/log/openvpn/openvpn-status.log <br>  log-append /var/log/openvpn/openvpn.log <br>  client-config-dir / etc / openvpn / ccd <br>  verb 3 <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">My OpenVPN Client Configuration</b> <div class="spoiler_text">  client <br>  dev tun <br>  proto udp <br>  remote 1.1.1.1 8443 <br>  tls-client <br>  #ca ca.crt <br>  #cert client1.crt <br>  #key client1.key <br>  key-direction 1 <br>  # tls-auth ta.key 1 <br>  auth SHA512 <br>  cipher AES-256-CBC <br>  remote-cert-tls server <br>  comp-lzo <br>  tun-mtu 1500 <br>  mssfix <br>  ping-restart 180 <br>  persist-key <br>  persist tun <br>  auth-nocache <br>  verb 3 <br></div></div><br>  I am waiting for comments on this OpenVPN configuration. <br><br>  All the requests from the client terminals are carried out at the tunnel address on the side of the OpenVPN server, where the corresponding port forwarding and necessary access are configured. <br>  Here is an example: <br><pre> <code class="bash hljs">iptables -A INPUT -i ens160 -p tcp -m tcp --dport 8443 -j ACCEPT iptables -A INPUT -i ens160 -p udp -m udp --dport 8443 -j ACCEPT iptables -A INPUT -m state --state ESTABLISHED -j ACCEPT iptables -A INPUT -i ens192 -j ACCEPT iptables -P INPUT DROP iptables -t nat -A PREROUTING -p tcp -m tcp -d 10.0.141.1 --dport 443 -j DNAT --to-destination 10.24.184.179:443 <span class="hljs-comment"><span class="hljs-comment">#iptables -t nat -A PREROUTING -p udp -m udp -d 10.0.141.1 --dport 53 -j DNAT --to-destination 10.24.214.124:53</span></span></code> </pre><br><br>  DNS server for me serves as a kind of storage of IP-username bindings, and not only. <br>  Also here is the configuration of my PowerDNS server.  I can only say that in terms of security, it is not very optimized, it would be possible to resolve only the corresponding addresses, but also fully working.  I copied from the working server, only replacing logins / passwords / addresses with fake ones. <br><br><div class="spoiler">  <b class="spoiler_title">Configuration of my PowerDNS authoritative server</b> <div class="spoiler_text">  launch = gmysql <br>  gmysql-host = 10.24.214.131 <br>  gmysql-user = powerdns <br>  gmysql-password = password <br>  gmysql-dbname = powerdns <br>  gmysql-dnssec = yes <br>  allow-axfr-ips = 0.0.0.0 / 0 <br>  allow-dnsupdate-from = 0.0.0.0 / 0 <br>  allow-notify-from = 0.0.0.0 / 0 <br>  api = yes <br>  api-key = 1234567890 <br>  # api-logfile = / var / log / pdns.log <br>  api-readonly = no <br>  cache-ttl = 2000 <br>  daemon = yes <br>  default-soa-mail = dbuynovskiy.spectrum.by <br>  disable-axfr = yes <br>  guardian = yes <br>  local-address = 0.0.0.0 <br>  local-port = 53 <br>  log-dns-details = yes <br>  log-dns-queries = yes <br>  logging facility = 0 <br>  loglevel = 7 <br>  master = yes <br>  dnsupdate = yes <br>  max-tcp-connections = 512 <br>  receiver-threads = 4 <br>  retrieval-threads = 4 <br>  reuseport = yes <br>  setgid = pdns <br>  setuid = pdns <br>  signing-threads = 8 <br>  slave = no <br>  slave-cycle-interval = 60 <br>  version-string = powerdns <br>  webserver = yes <br>  webserver-address = 0.0.0.0 <br>  webserver-allow-from = 0.0.0.0 / 0.10.10.71.0 / 24.10.10.55.4 / 32 <br>  webserver-password = 1234567890 <br>  webserver-port = 7777 <br>  webserver-print-arguments = yes <br>  write-pid = yes <br><br></div></div><br><br>  To update the PowerDNS zones I used the built-in REST API.  I wrote the following procedure in Ruby: <br><div class="spoiler">  <b class="spoiler_title">PowerDNS zone update method via REST</b> <div class="spoiler_text"><pre> <code class="ruby hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updatezone</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(username,ipaddress)</span></span></span></span> p data = {<span class="hljs-string"><span class="hljs-string">"rrsets"</span></span>: [ {<span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{username}</span></span></span><span class="hljs-string">.spectrum.loc."</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"ttl"</span></span>: <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">"changetype"</span></span>: <span class="hljs-string"><span class="hljs-string">"REPLACE"</span></span>, <span class="hljs-string"><span class="hljs-string">"records"</span></span>: [ {<span class="hljs-string"><span class="hljs-string">"content"</span></span>: ipaddress, <span class="hljs-string"><span class="hljs-string">"disabled"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> } ] } ] } url = <span class="hljs-string"><span class="hljs-string">'http://10.24.214.124:7777/api/v1/servers/localhost/zones/spectrum.loc.'</span></span> uri = URI.parse(url) http = Net::HTTP.new(uri.host, uri.port) req = Net::HTTP::Patch.new(uri.request_uri) req[<span class="hljs-string"><span class="hljs-string">"X-API-Key"</span></span>]=<span class="hljs-string"><span class="hljs-string">"1234567890"</span></span> req.body = data.to_json p <span class="hljs-string"><span class="hljs-string">"fd"</span></span> p response = http.request(req) p content = response.body <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></div></div><br>  I execute this method when starting the client.  That is, there is an update of the IP address corresponding to a specific user.  I remind you that such requests are performed by SOAP Gateway written in Ruby. <br><br>  My information transmitted between sockets is encrypted using the AES algorithm, but not by a separate password, but by a randomly selected password from the list, which provides almost absolute protection, even if the attacker has infinite computing resources.  Of course, the longer the list, the better. <br>  I have a method for doing this encryption / decryption. <br><br>  In addition, I want to leave here an example of my c # procedure for performing SOAP requests. <br>  Maybe someone will come in handy.  In any case, I have long sought to make SOAP requests run on different platforms.  At first I used the Service Reference on Windows, but for Xamarin for other platforms it is not available.  And this technique works everywhere.  Anyway, I tested it on iOS, Android and Windows <br><br><div class="spoiler">  <b class="spoiler_title">An example of executing a SOAP request on c #</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registerSession2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { CallWebServiceUpdateLocation(); writeLOG(<span class="hljs-string"><span class="hljs-string">"Session registered on SoapGW."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception exc) { writeLOG(<span class="hljs-string"><span class="hljs-string">"Error. Failed GlobalFunction.registerSession2() method: "</span></span> + Convert.ToString(exc)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> HttpWebRequest </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateWebRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> action</span></span></span><span class="hljs-function">)</span></span> { HttpWebRequest webRequest = (HttpWebRequest)WebRequest.Create(url); webRequest.Headers.Add(<span class="hljs-string"><span class="hljs-string">"SOAPAction"</span></span>, action); webRequest.ContentType = <span class="hljs-string"><span class="hljs-string">"text/xml;charset=\"utf-8\""</span></span>; webRequest.Accept = <span class="hljs-string"><span class="hljs-string">"text/xml"</span></span>; webRequest.Method = <span class="hljs-string"><span class="hljs-string">"POST"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> webRequest; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> XmlDocument </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateSoapEnvelope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { XmlDocument soapEnvelopeDocument = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XmlDocument(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> xml = System.String.Format(<span class="hljs-string"><span class="hljs-string">@" &lt;soapenv:Envelope xmlns:xsi=""http://www.w3.org/2001/XMLSchema-instance"" xmlns:xsd=""http://www.w3.org/2001/XMLSchema"" xmlns:soapenv=""http://schemas.xmlsoap.org/soap/envelope/"" xmlns:spec=""https://spectrum.master""&gt; &lt;soapenv:Header/&gt; &lt;soapenv:Body&gt; &lt;master_update_location soapenv:encodingStyle=""http://schemas.xmlsoap.org/soap/encoding/""&gt; &lt;ipaddress xsi:type=""xsd:string""&gt;{0}&lt;/ipaddress&gt; &lt;username xsi:type=""xsd:string""&gt;{1}&lt;/username&gt; &lt;/master_update_location&gt; &lt;/soapenv:Body&gt; &lt;/soapenv:Envelope&gt; "</span></span>, Convert.ToString(Globals.localip), Globals._LocalUserName); soapEnvelopeDocument.LoadXml(xml); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> soapEnvelopeDocument; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CallWebServiceUpdateLocation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _url = <span class="hljs-string"><span class="hljs-string">"http://10.0.141.1/master/action"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _action = <span class="hljs-string"><span class="hljs-string">"master_update_location"</span></span>; XmlDocument soapEnvelopeXml = CreateSoapEnvelope(); HttpWebRequest webRequest = CreateWebRequest(_url, _action); InsertSoapEnvelopeIntoWebRequest(soapEnvelopeXml, webRequest); <span class="hljs-comment"><span class="hljs-comment">// begin async call to web request. IAsyncResult asyncResult = webRequest.BeginGetResponse(null, null); // suspend this thread until call is complete. You might want to // do something usefull here like update your UI. asyncResult.AsyncWaitHandle.WaitOne(); // get the response from the completed web request. string soapResult; using (WebResponse webResponse = webRequest.EndGetResponse(asyncResult)) { using (StreamReader rd = new StreamReader(webResponse.GetResponseStream())) { soapResult = rd.ReadToEnd(); } //Console.Write(soapResult); } } private static void InsertSoapEnvelopeIntoWebRequest(XmlDocument soapEnvelopeXml, HttpWebRequest webRequest) { using (Stream stream = webRequest.GetRequestStream()) { soapEnvelopeXml.Save(stream); } }</span></span></code> </pre><br></div></div><br><br>  PS Thank you all for your attention!  I hope that someone will be useful if not an idea, then at least examples of procedures.  Write in the comments your thoughts about this messaging implementation. <br><br>  Some literature: <br>  1. Useful article.  I used it myself.  True, the configuration proposed in it did not fit me, but the installation process is very detailed - <a href="https://www.digitalocean.com/community/tutorials/openvpn-ubuntu-16-04-ru">Setting up an OpenVPN server on Ubuntu 16.04</a> <br>  2. <a href="https://habrahabr.ru/post/278153/">Install PowerDNS</a> <br>  3. <a href="https://habrahabr.ru/post/188130/">Details on Xamarin</a> </div><p>Source: <a href="https://habr.com/ru/post/346792/">https://habr.com/ru/post/346792/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346782/index.html">Optional: Schr√∂dinger's cat in Java 8</a></li>
<li><a href="../346784/index.html">Web application on Node and Vue, part 5: finalizing the project</a></li>
<li><a href="../346786/index.html">Social architecture: 4 steps to a self-governing community</a></li>
<li><a href="../346788/index.html">How to build a community. Translation of Social Architecture: Chapter 3. ZeroMQ Community</a></li>
<li><a href="../346790/index.html">Addition to the article "Subtleties of resume in German IT-companies"</a></li>
<li><a href="../346794/index.html">How to make friends team admins with development teams?</a></li>
<li><a href="../346796/index.html">ICO analysis: technical approach. Part I - general conclusions</a></li>
<li><a href="../346798/index.html">X.509 Certificate Spurs</a></li>
<li><a href="../346800/index.html">Basic API sets for implementing transparent proxying services</a></li>
<li><a href="../346802/index.html">Using Docker CE (Community Edition) with Kubernetes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>