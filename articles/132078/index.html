<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How missed var ripped off our launch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Translation of this note is not intended to discourage the reader from using Node.js, and the old woman is prorukha, but only calls to be careful, and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How missed var ripped off our launch</h1><div class="post__text post__text-html js-mediator-article"> <i>Translation of this note is not intended to discourage the reader from using Node.js, and the old woman is prorukha, but only calls to be careful, and, perhaps, will prompt the decision to those who suddenly face the same behavior of their application.</i>  <i>The author's vocabulary is left without any changes and censorship.</i> <br><br>  The tale is short, it‚Äôs a long time being done, <a href="http://meloncard.com/">MelonCard</a> was presented today at <a href="http://techcrunch.com/">TechCrunch</a> along with other companies, when <b>all of a</b> sudden it broke.  Each  small.  small change.  We just updated the site to make it look and feel more responsive, using long-polling NodeJS, with the coolest dynamic frontend on jQuery Templates and KnockoutJS.  We did our best and conducted manual and unit testing with <a href="http://vowsjs.org/">Vows</a> .  Are all systems ready, full speed and all?  It was not there. <a name="habracut"></a><br><br>  Our system on NodeJS uses the state of the user, for example, ‚ÄúI expect these two records to be updated‚Äù, and the server (starting from checking the time fix) returns either ‚ÄúYour records are up to date‚Äù or ‚ÄúThe xxx record has changed to yyy‚Äù (in fact, everything is a bit more complicated) with shared Redis variables, sessions, and other security checks for the interconnection of Rails, MySQL, Redis, and Node).  Everything is so crystal simple, but even a simple NodeJS code can turn into hell when something goes wrong.  It happened today. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After the articles about us were published, a stream of delighted users rushed to us (say, 50-100 new users per hour).  And suddenly everything fell apart.  Pages no longer worked;  Our mailboxes started to get messed up from disgruntled users.  I poured coffee and got ready for the battle. <br><br>  My first thought was that NodeJS holds the load well, and that‚Äôs what it‚Äôs glorious for.  Fifty or a hundred users could not ruin the system.  And as it turned out it was not the fault of NodeJS, per se, but more on that later.  The server started returning completely unexpected answers, as if the user was saying ‚ÄúI have a, b and c entries,‚Äù and the server responded, ‚ÄúYou are an idiot, erase x, y and z entries, but you need a, b and c entries.‚Äù  Focusing and reproducing the problem was impossible, given the terrible error handling and debag capabilities in Node.  The following team had to constantly use (yes, right on the production): <br><br>  NODE_ENV = 'production' node / privacy.js |  grep ‚ÄúReturned Results‚Äù <br><br>  You can imagine how terribly hard it was to disassemble this pile.  It is worth noting that everything continued to work remarkably on the test server, and all the unit tests passed remarkably, and I had nothing more to push off from.  On top of that, our system carefully checked sessions (for security), and frustrated users logged in and logged out in different browser bookmarks, receiving a huge number of warnings that they were not logged in (which also made it impossible to cut off real errors).  I got errors like this: <br><br>  Trace: at EventEmitter.  (/‚Äî/Node/privacy.js:118:11) at EventEmitter.emit (events.js: 81: 20) <br><br>  The line mentioned here (the only one reported by Node): <br><br>  process.on ('uncaughtException', function (err) {console.log (['Caught exception', err]); console.trace ();}); <br><br>  Well, at least the application did not collapse, but all the same - there was nothing to start from.  It should be noted that nothing of what we did (manual testing of the interface, unit testing, error handling, etc.) did not reveal errors associated with this line.  Yes, it would be necessary to use load testing, but there is no certainty that it would reveal this misfortune. <br>  After four hours of debugging (and translating the title page to 503 - Temporarily Unavailable), and while my co-founder personally responded with apologies to each frustrated and inquisitive user, I noticed that the user confused the parameters of my request with the parameters of other users.  Frankly speaking, the server was designed in such a way that it worked so that only YOUR information was returned on YOUR request, but it confused what you requested.  That is, you asked "I love apples and melons," and he replied, "Nonsense, you love mango."  That is, everything was safe, but still damn wrong.  Why would my <a href="http://expressjs.com/">ExpressJS</a> server confuse what I asked him.  I started digging and found this: <br><br> <code>app.all('/apps/:user_id/status', function(req, res, next) { <br> // ‚Ä¶ <br> initial = extractVariables(req.body); <br> }); <br></code> <br>  Looks bad?  Yes, it's just a failure.  I am not an expert in JavaScript, but I will try to explain how I can.  In JavaScript, variables are declared either in the context of a function or in a global context (with some problems passing through the nesting of contexts from current to global).  When I created ‚Äúinitial‚Äù without ‚Äúvar‚Äù, a passage was made from the current context and quickly got into the global one, and created the global variable ‚Äúinitial‚Äù there.  When the next request came, the same pass was made again and wrote the data to the same variable (the same one that the previous request was still going to use).  And so it happened with every next request.  When the server responded to requests after some processing, it read from this constantly updated variable and returned crazy results.  Complete shit  It was necessary to write something like this: <br><br> <code>var initial = extractVariables(req.body);</code> <br> <br>  Such code would create a variable in the context of my anonymous function, and there would be no other possibility to overwrite it with another query.  It was an amateur mistake, but all debags and tests that I could apply were passed by it, without noticing. <br><br>  So the moment came when you should say "you had to use <a href="http://jashkenas.github.com/coffee-script/">CoffeeScript</a> ."  And you will be right.  In other circumstances, things could have been even worse (what would have happened if I had mistaken the context for the session variable?).  On top of that, the lack of normal error handling (in Rails, we catch errors on the spectra and send unique spectra to the team via email), and some normal debugging tools (except grep and less) took me to the years when programming was not pleasant thing.  Or maybe I just needed to be careful. <br><br>  After four hours of service interruption and several hundreds of frustrated users, I found the problem and quickly corrected it on a productive server.  The clouds scattered, the birds chirped and the sun looked out.  We began to respond to users with an apology, considered the losses and moved on.  But it's still not easy for me on how much damage one missing keyword has caused.  Can it really be that I missed one var makes me flawed? </div><p>Source: <a href="https://habr.com/ru/post/132078/">https://habr.com/ru/post/132078/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132066/index.html">We are going to a new Ciklum Subbotnik in Minsk - now on .NET! Join now!</a></li>
<li><a href="../132070/index.html">Model for calculating the probability of crime</a></li>
<li><a href="../132071/index.html">Django project template with build tools and utilities</a></li>
<li><a href="../132075/index.html">7app chart # 5</a></li>
<li><a href="../132076/index.html">Mouse manager extension</a></li>
<li><a href="../132079/index.html">Eric Schmidt Senate Subcommittee: Siri could be a competitive threat to Google</a></li>
<li><a href="../132082/index.html">Video review of Android applications and games - kedDroid</a></li>
<li><a href="../132084/index.html">PHP IoC</a></li>
<li><a href="../132088/index.html">Matryoshka principle</a></li>
<li><a href="../132092/index.html">Search for talent on Youtube using acoustic analysis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>