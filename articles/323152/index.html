<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Some techniques of working in Bitrix on SQL and BASH</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I keep writing about Bitrix in the context of exchanges, Mysql and the Linux command line. 

 This article is an introduction to a series of articles ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Some techniques of working in Bitrix on SQL and BASH</h1><div class="post__text post__text-html js-mediator-article">  I keep writing about Bitrix in the context of exchanges, Mysql and the Linux command line. <br><br>  This article is an introduction to a series of articles on the structure of the Bitrix database, where this topic will be covered in sufficient detail.  For a start, solutions of some small but annoying tasks will be presented.  As always, knowledge of SQL is necessary. <br><br>  The article deals with quite private issues that do not arise daily.  Of course, you can use these materials for their intended purpose, but this is not the main purpose of the article.  I begin to open the ‚Äúblack box‚Äù called ‚ÄúBitrix database structure‚Äù, and show that this knowledge can be useful for improving the level of both the system and basic technologies (SQL, linux shell), which, of course, helps to solve new complex, interesting, diverse tasks. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The page with which you can make SQL queries to the database, or the mysql web Bitrix client, is located in the Bitrix control panel along the path: ‚ÄúSettings-&gt; Tools-&gt; SQL query‚Äù. <br><br>  Also, of course, you can make requests from the command line of the operating system, for which I can offer you a simple operation to retrieve the login and password directly from the settings of Bitrix: <br><br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">log</span></span>=$(grep -i <span class="hljs-string"><span class="hljs-string">"login"</span></span> /home/bitrix/www/bitrix/php_interface/dbconn.php | cut -f2 -d<span class="hljs-string"><span class="hljs-string">'"'</span></span>) pas=$(grep -i <span class="hljs-string"><span class="hljs-string">"pass"</span></span> /home/bitrix/www/bitrix/php_interface/dbconn.php | cut -f2 -d<span class="hljs-string"><span class="hljs-string">'"'</span></span>) mysql -u<span class="hljs-variable"><span class="hljs-variable">$log</span></span> -p<span class="hljs-variable"><span class="hljs-variable">$pas</span></span> <span class="hljs-variable"><span class="hljs-variable">$log</span></span></code> </pre> <br>  - in this way you can get the login and password for the Mysql Bitrix database from the linux command line on bash.  Of course, replace the paths with your own.  In the version provided by the Bitrix virtual machine, DOCUMENT_ROOT looks like / home / bitrix / www /. <br><a name="habracut"></a><br><h2>  1. Set up "Favorites" for all users of the Bitrix control panel at once. </h2><br>  When a new site is introduced, the developer does not want to explain to anyone who adds news or edits pages what to click to get into the news or product catalog.  It is better to bring the links directly to the start page of the Bitrix control panel, especially since in the Bitrix the ‚Äúdesktop‚Äù in the admin panel is intended for this. <br><br>  If the settings of the so-called "desktop" can be extended to anyone who enters the Beatrix admin area, the user can fill in the "Favorites" column only for himself.  This is logical, but usually users neglect this opportunity, so we will do this work for them. <br><br>  In addition, not everything can be placed on the "Desktop", and you can add anything to the "Favorites", even a link to a third-party resource, for example, to mail or tickets from the technical support service of another system. <br><br>  The control panel does not allow filling in the ‚ÄúFavorites‚Äù block in the bitrix admin panel for all content managers: there is no such button.  Therefore, we first add the necessary links in the block "Favorites" for yourself. <br><br>  Find out your user ID.  If you are under the administrator (admin) in the control panel, then your user ID = 1. <br><br>  Obviously, this data refers to the user, and the first glance is thrown at the tables starting with b_user_, of which there are a dozen in the Bitrix database.  However, the table we need does not have such a prefix and is called b_f Favorites. <br><br>  This table contains the COMMON field, which for all records is 'N'.  As it turns out, the function of displaying favorites for all users is present, and the COMMON field in the b_f is well justifies its name. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> b_favorite <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> common=<span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> user_id=<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br>  We don‚Äôt even need to duplicate the administrator‚Äôs records for all users (and how would it be with the newly created site administrators? .. Make mysql a trigger? .. Start an event? ...).  Now all Bitrix admin users see the same ‚ÄúFavorites‚Äù as you.  Problem solved. <br><br><h2>  2. How to change the username and password of the Bitrix user through the database.  How to reset the Bitrix admin password. </h2><br>  If you are unable to log in to the Bitrix control panel, but the base is available, you can either set your own password for the user, or make it the same as any other user whose password you know. <br><br>  The master data of all users is stored in the b_user table.  You need to know the user ID in the Bitrix system. <br><br><h3>  Setting your own Bitrix login and password using Mysql </h3><br>  The password is stored in the database as: <br><br> <code>&lt;_&gt;md5(&lt;_&gt;&lt;&gt;)</code> <br> <br>  They say they have changed something else, but if you do this, it will work. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> b_user <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> login=<span class="hljs-string"><span class="hljs-string">'su'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">concat</span></span>(<span class="hljs-string"><span class="hljs-string">'12345678'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">md5</span></span>(<span class="hljs-string"><span class="hljs-string">'12345678stupidpassword'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">8</span></span>;</code> </pre> <br><blockquote>  Where <br>  su - new user login <br>  12345678 - salt <br>  stupidpassword - new user password <br>  id = 8 - user id (if admin, then = 1) </blockquote><br>  Password Bitrix reset, the problem is solved.  At the same time, you can change the login. <br><br><h3>  Copying password from another user </h3><br>  And the second, very simple, way to reset the password in the bitrix. <br><br>  This time, we just need to transfer the password hash from one user to another.  Of course, you need to know the ID of both users in bitrix, in this case, the user with ID = 36, we set the password from the user with ID = 895. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> b_user b1 <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> b_user b2 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> b2.id=<span class="hljs-number"><span class="hljs-number">36</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> b1.password=b2.password <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> b1.id=<span class="hljs-number"><span class="hljs-number">895</span></span>;</code> </pre> <br><h2>  3. Application of setting fields in order editing in Bitrix admin panel for all users. </h2><br>  In a certain second-level domain zone, on some website, in the administrative panel of the control system of Bitrix, there is an online store order editing page, in the header of which product table there is a gear setting button, and this button is sometimes blue, then gray ... <br><br>  By clicking on this button, you can set the order fields that will be displayed in the table, including the custom properties of the order.  But at the same time, it is set only for one user. <br><br>  To apply these settings to all users of the Bitrix control panel, and not to explain to everyone, "click the little button in the table header with the goods, see the list of properties ... Choose the ones you need ...", set the settings through the base. <br><br>  These settings are stored in the b_user_option table, which are mapped to a specific user through the user_id field.  But there is one feature: if user_id = 0, then the property is global, and applies to all users. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> b_user_option <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> user_id=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=<span class="hljs-string"><span class="hljs-string">'table_columns'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">category</span></span>=<span class="hljs-string"><span class="hljs-string">'order_basket_table'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> user_id=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  where user_id = 1 is the user ID under which you set up the product table.  If it is admin, then id = 1. <br><br>  The problem is solved: Now your settings table of products work for all at once. <br><br><h2>  4. Sort search results in Bitrix on their own algorithm. </h2><br>  If we are talking about site search, the main table for the bitrix search modules is b_search_content. <br><br>  Interesting fields in the b_search_content table: <br><br>  custom_rank - the field by which sorting works before all other fields <br>  param1 - information block code <br>  param2 - information block number <br>  module_id - = 'iblock' <br>  item_id - the id of the item or section <br>  - to search in information blocks. <br><br>  First of all, we are interested in the custom_rank field. <br><br>  If in the previous cases we used the provided, but unrealized capabilities of Bitrix, then there is a special ‚Äútick‚Äù for this field in the control panel.  But it is exhibited separately for each element, and usually this opportunity is not used. <br><br>  By the way, this field turns out to be numeric, and we will fill it at our discretion, thereby setting our own rules for sorting search results.  By default, for all elements its value is zero. <br><br>  In my case, when searching for products in the online store catalog implemented on the romza developer's solution, it was necessary to first display those products that had a certain special check mark that was a ‚Äúproperty‚Äù corresponding to the availability of goods in a certain outlet.  All this stuff arrived with incremental loading from 1C, so this SQL query was hung on the exchange termination event from 1C. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> b_search_content sc <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> b_iblock_element_property elp <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> elp.iblock_element_id=sc.item_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> elp.iblock_property_id=&lt;_id_&gt; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> sc.custom_rank=<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(elp.value=&lt;_id__&gt;,&lt;_&gt;,<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> sc.param1=<span class="hljs-string"><span class="hljs-string">'&lt;_&gt;'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> sc.param2=&lt;_&gt;</code> </pre><br>  In the information block setting, ‚ÄúProperty values ‚Äã‚Äãshould be stored: in the general table (default)‚Äù, and not in a separate table, otherwise the query will look somewhat different. <br><br>  Now, due to the fact that the request first goes to the b_iblock_element_property table, and not b_iblock_element, which is the main storage for information block blocks, we select only those elements that have the desired property in general, and if it is equal to the desired value, then custom_rank rises otherwise, it is reset to zero. <br><br>  In my case, the problem is solved, and for you there is full scope for the implementation of its own logic of sorting search results.  And if you do not quite know these table names, then in the next article I will reveal their purpose in more detail. <br><br><h2>  How to quickly clean the cache in Bitrix. </h2><br>  ‚ÄúAnd on footer.php‚Äù: Clearing the cache in the bitrix via the control panel is very slow.  In fact, there is only the removal of files in certain directories, it is just done by slow means.  Make a special file to clear the cache in the bitrix on the linux command line. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /home/bitrix/ cat &lt;&lt;<span class="hljs-string"><span class="hljs-string">'EOF'</span></span> &gt; clearcache.sh <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash cd $( dirname $0 ) basedir=$(pwd)/www/bitrix/ for d in cache managed_cache; do find $basedir$d -mindepth 1 -delete done EOF chmod 0775 clearcache.sh</span></span></code> </pre><br>  Now you can run ./clearcache.sh, and the Bitrix cache will clear almost instantly. <br><br>  This script should be one directory higher than the DOCUMENT_ROOT of your site.  Although you can change both its location and code, the point is that we have to delete all files from directories: <br><br>  cache <br>  managed_cache <br>  stack_cache - there used to be this directory before, but in recent versions I don‚Äôt watch it, so now without it. <br><br>  In fact, if you delete the directories themselves, nothing happens, they will be re-created.  But it is more correct to leave them. <br><br>  In a virtual machine, Bitrix DOCUMENT_ROOT is equal to / home / bitrix / www /, if your site is installed in another directory, adjust the script according to your paths. </div><p>Source: <a href="https://habr.com/ru/post/323152/">https://habr.com/ru/post/323152/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323136/index.html">DataLine experience: how we prepare duty engineers for our data centers</a></li>
<li><a href="../323138/index.html">How effective are the next-generation information security solutions?</a></li>
<li><a href="../323142/index.html">React or Vue? Choosing a library for front-end development</a></li>
<li><a href="../323144/index.html">Build a cache with efficient multithreaded access</a></li>
<li><a href="../323148/index.html">ReactDoc - the first open source solution of the program "Common Frontal System"</a></li>
<li><a href="../323154/index.html">Microservices: experience of use in a loaded project</a></li>
<li><a href="../323156/index.html">Interactive UX prototype: parsing on a real example</a></li>
<li><a href="../323158/index.html">RandLib. Library of probability distributions in C ++ 17</a></li>
<li><a href="../323160/index.html">Why do I need Refresh Token if there is Access Token?</a></li>
<li><a href="../323162/index.html">Virtualization and Cloud Performance Testing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>