<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Config-files in Delphi without problems</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Somehow there was a case and I thought about how the most convenient way to configure a user somewhere locally, quickly write and forget this business...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Config-files in Delphi without problems</h1><div class="post__text post__text-html js-mediator-article">  Somehow there was a case and I thought about how the most convenient way to configure a user somewhere locally, quickly write and forget this business.  I decided to keep this file in an xml file.  What could be without them. <br>  The main thing in this method is that when adding any new parameters or changing old ones, it will not be necessary to rewrite the code for saving data and loading it.  Everything will be done automatically.  All we need is to create a base class that will do everything for us, and we will store the data in the objects of the inheriting classes. <br><a name="habracut"></a><br><br>  In general, in order not to powder the brain, I will immediately cite the code of the base class: <br><br><blockquote><pre>  unit tlXMLClass; 
 
 interface 
 
 uses 
   Classes, XMLIntf, 
   // it is important!!!  the module allows you to work with the properties of the object 
   TypInfo; 
 
 type 
   TXMLClass = class (TPersistent) 
   private 
     // here we will have the name of the file with the settings 
     FXMLFilePath: string;
     // and here is the name of the application for identification 
     FApplicationName: string; 
     // name of the root file branch
     FRootNodeName: string; 
     // version
     FVersion: byte; 
   protected 
     procedure SaveClass (oObject: TObject; Node: IXMLNode); 
     procedure LoadClass (oObject: TObject; Node: IXMLNode); 
   public 
     constructor Create (const AppName, XMLFilePath: string; RootNodeName: string = 'config');  
 
     procedure Initialize;  abstract; 
 
     // load values ‚Äã‚Äãfrom file
     procedure Load; 
     // and save them
     procedure Save; 

     // virtual method, we will write it in the heir 
     procedure LoadDefaults;  virtual; 
 
     property ApplicationName: string read FApplicationName write FApplicationName; 
     property RootNodeName: string read FRootNodeName; 
     property Version: byte read FVersion write FVersion default 1; 
   end; 
 
 implementation 
 
 uses 
   // about XMLDoc and XMLIntf - these two modules appeared in Delphi not so long ago, 
   // as long as I remember.  if you don‚Äôt have them, you‚Äôll have to do it in a different way. 
   XMLDoc, SysUtils, Windows, 
   resConfig; 
 
 {TXMLConfig} 
 
 {$ REGION 'Initialization'} 
 constructor TXMLClass.Create (const AppName, XMLFilePath: string; RootNodeName: string = 'config'); 
 begin 
   Initialize; 
 
   FApplicationName: = AppName; 
   FXMLFilePath: = XMLFilePath; 
   FRootNodeName: = RootNodeName; 
 
   // set default settings 
   LoadDefaults; 
 end; 

 procedure TXMLClass.LoadDefaults; 
 begin 
 
 end; 
 {$ ENDREGION} 
 
 {$ REGION 'Loading'} 
 procedure TXMLClass.LoadClass (oObject: TObject; Node: IXMLNode); 
 
   // here we try to find the property and set its value 
   procedure GetProperty (PropInfo: PPropInfo); 
   var 
     sValue: string; 
     TempNode: IXMLNode; 
     LObject: TObject; 
   begin 
     // try to find a branch with the name of the property 
     TempNode: = Node.ChildNodes.FindNode (PropInfo ^ .Name); 
     // if not found, then exit the function.  property value will remain the default value 
     if TempNode = nil then 
       exit; 
 
     // if the property is not an object, then we get the value from the branch
     if PropInfo ^ .PropType ^ .Kind &lt;&gt; tkClass then 
       sValue: = TempNode.Text; 
 
     // analyze the type of the property and give it a value according to it
     case PropInfo ^ .PropType ^ .Kind of 
       tkEnumeration: 
         if GetTypeData (PropInfo ^ .PropType ^) ^. BaseType ^ = TypeInfo (Boolean) 
           then SetPropValue (oObject, PropInfo, Boolean (StrToBool (sValue))) 
           else SetPropValue (oObject, PropInfo, StrToInt (sValue)); 
       tkInteger, tkChar, tkWChar, tkSet: 
         SetPropValue (oObject, PropInfo, StrToInt (sValue)); 
       tkFloat: 
         SetPropValue (oObject, PropInfo, StrToFloat (sValue)); 
       tkString, tkLString, tkWString: 
         SetPropValue (oObject, PropInfo, sValue); 
       // but if the property is an object, then recursively execute the procedure
       // LoadClass, but for the found branch
       tkClass: 
         begin 
           LObject: = GetObjectProp (oObject, PropInfo); 
           if LObject &lt;&gt; nil then 
             LoadClass (LObject, TempNode); 
         end; 
     end; 
   end; 
 
 var 
   i, iCount: integer; 
   PropInfo: PPropInfo; 
   PropList: PPropList;   
 begin 
   // get the number of public properties of the object 
   iCount: = GetTypeData (oObject.ClassInfo) ^. PropCount; 
 
   if iCount&gt; 0 then 
   begin 
     // request a piece of memory for storage 
     // property list 
     GetMem (PropList, iCount * SizeOf (Pointer)); 
 
     // and get them in PropList 
     GetPropInfos (oObject.ClassInfo, PropList); 
     try 
       // go through the list of properties 
       for i: = 0 to iCount - 1 do 
       begin 
         PropInfo: = PropList ^ [i]; 
         if PropInfo = nil then 
           break; 
 
         // and for each property we execute GetProperty (see above) 
         GetProperty (PropInfo); 
       end; 
     finally 
       // and at the very end we release the memory occupied by the list 
       FreeMem (PropList, iCount * SizeOf (Pointer)); 
     end; 
   end; 
 end; 
 
 procedure TXMLClass.Load;
 // procedure for reading from file 
 var 
   XMLRoot: IXMLNode; 
   XML: IXMLDocument; 
 begin 
   LoadDefaults; 
   if not FileExists (FXMLFilePath) then 
     exit; 
 
   try 
     // xml file with settings
     XML: = LoadXMLDocument (FXMLFilePath); 
     // root branch of the xml document 
     XMLRoot: = XML.DocumentElement; 
 
     // check if this file is ours
     if (XMLRoot.NodeName &lt;&gt; FRootNodeName) or 
        (XMLRoot.Attributes [rsApplication] &lt;&gt; FApplicationName) then 
       exit; 
 
     FVersion: = XMLRoot.Attributes [rsFormat]; 
 
     // let's go download
     LoadClass (Self, XMLRoot); 
   except 
     // an exception occurred?  load default values
     LoadDefaults; 
   end; 
 end; 
 {$ ENDREGION} 
 
 {$ REGION 'Saving'} 
 procedure TXMLClass.SaveClass (oObject: TObject; Node: IXMLNode); 
 // here we save the values ‚Äã‚Äãand this procedure is very 
 // much like the download procedure, so comment 
 // I'll be here only what is not in that procedure 
 
   procedure WriteProperty (PropInfo: PPropInfo); 
   var 
     sValue: string; 
     LObject: TObject; 
     TempNode: IXMLNode; 
   begin 
     case PropInfo ^ .PropType ^ .Kind of 
       tkEnumeration: 
         if GetTypeData (PropInfo ^ .PropType ^) ^. BaseType ^ = TypeInfo (Boolean) 
           then sValue: = BoolToStr (Boolean (GetOrdProp (oObject, PropInfo)), true) 
           else sValue: = IntToStr (GetOrdProp (oObject, PropInfo)); 
       tkInteger, tkChar, tkWChar, tkSet: 
         sValue: = IntToStr (GetOrdProp (oObject, PropInfo)); 
       tkFloat: 
         sValue: = FloatToStr (GetFloatProp (oObject, PropInfo)); 
       tkString, tkLString, tkWString: 
 
         sValue: = GetWideStrProp (oObject, PropInfo); 
       tkClass: 
         if Assigned (PropInfo ^ .GetProc) and Assigned (PropInfo ^ .SetProc) then 
         begin 
           LObject: = GetObjectProp (oObject, PropInfo); 
           if LObject &lt;&gt; nil then 
           begin 
             TempNode: = Node.AddChild (PropInfo ^ .Name); 
 
             SaveClass (LObject, TempNode); 
           end; 
         end; 
     end; 
 
     // here we create a new branch in the root of the document 
     // and write the property value to it 
     if PropInfo ^ .PropType ^ .Kind &lt;&gt; tkClass then 
       with Node.AddChild (PropInfo ^ .Name) do 
         Text: = sValue; 
   end; 
 
 var 
   PropInfo: PPropInfo; 
   PropList: PPropList; 
   i, iCount: integer; 
 begin 
   iCount: = GetTypeData (oObject.ClassInfo) ^. PropCount; 
 
   if iCount&gt; 0 then 
   begin 
     GetMem (PropList, iCount * SizeOf (Pointer)); 
     try 
       GetPropInfos (oObject.ClassInfo, PropList); 
 
       for i: = 0 to iCount - 1 do 
       begin 
         PropInfo: = PropList ^ [i]; 
         if PropInfo = nil then 
           Break; 
 
         WriteProperty (PropInfo); 
       end; 
     finally 
       FreeMem (PropList, iCount * SizeOf (Pointer)); 
     end; 
   end; 
 end; 
 
 procedure TXMLClass.Save; 
 var 
   FRootNode: IXMLNode; 
   FBackFileName: string; 
   XML: IXMLDocument; 
 begin 
   // so far without backup.  just in case it does not hurt 
   FBackFileName: = ChangeFileExt (FXMLFilePath, '.bak'); 
   try 
     // original is deleted 
     if FileExists (FXMLFilePath) then 
       DeleteFile (PChar (FXMLFilePath)); 
 
     try 
       // create a new XML document 
       XML: = NewXMLDocument; 
 
       // ask him the encoding and version 
       with XML do 
       begin 
         Encoding: = 'UTF-8'; 
         Version: = '1.0'; 
       end; 
 
       // add root branch FRootNodeName
       FRootNode: = XML.AddChild (FRootNodeName); 
       FRootNode.Attributes [rsApplication]: = FApplicationName; 
       FRootNode.Attributes [rsFormat]: = FVersion; 
 
       SaveClass (Self, FRootNode); 
 
       // save the document 
       XML.SaveToFile (FXMLFilePath); 
     except 
       // but if an error occurred, then we try 
       // restore the file from the created backup 
       if FileExists (FBackFileName) then 
         RenameFile (FBackFileName, FXMLFilePath); 
     end; 
   finally 
     // and at the very end delete the backup 
     if FileExists (FBackFileName) then 
       DeleteFile (PChar (FBackFileName)); 
   end; 
 end; 
 {$ ENDREGION} 
 
 end. </pre></blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here are the things here.  The code is not very small, but, if you look, it is not complicated at all.  I hope also useful.  For someone :) <br>  Yes, the code works on D2007, but there will be no problems on the version earlier.  On those versions where there is support for XML. <br><br>  An example of a config generated by a class: <br><br><blockquote><pre>  &lt;? xml version = "1.0" encoding = "UTF-8"?&gt; 
 &lt;config application = "test" format = "0"&gt;
	 &lt;Main&gt;
		 &lt;HistoryDepth&gt; 40 &lt;/ HistoryDepth&gt; 
	 &lt;/ Main&gt;
	 &lt;LookAndFeel&gt;
		 &lt;WindowWidth&gt; 200 &lt;/ WindowWidth&gt; 
		 &lt;AlwaysOnTop&gt; True &lt;/ AlwaysOnTop&gt; 
		 &lt;AlphaBlending&gt; False &lt;/ AlphaBlending&gt; 
		 &lt;AlphaBlendValue&gt; 245 &lt;/ AlphaBlendValue&gt; 
		 &lt;AnimateWithAlpha&gt; False &lt;/ AnimateWithAlpha&gt; 
		 &lt;Elements&gt;
			 &lt;ItemDefault&gt;
				 &lt;Font&gt;
					 &lt;Name&gt; Tahoma &lt;/ Name&gt; 
					 &lt;Size&gt; 8 &lt;/ Size&gt; 
					 &lt;Color&gt; 0 &lt;/ Color&gt; 
					 &lt;Bold&gt; False &lt;/ Bold&gt; 
					 &lt;Italic&gt; False &lt;/ Italic&gt; 
					 &lt;Strikeout&gt; False &lt;/ Strikeout&gt; 
					 &lt;Underline&gt; False &lt;/ Underline&gt; 
				 &lt;/ Font&gt;
			 &lt;/ ItemDefault&gt;
			 &lt;ItemChecked&gt;
				 &lt;Font&gt;
					 &lt;Name&gt; Tahoma &lt;/ Name&gt; 
					 &lt;Size&gt; 8 &lt;/ Size&gt; 
					 &lt;Color&gt; 9079434 &lt;/ Color&gt; 
					 &lt;Bold&gt; False &lt;/ Bold&gt; 
					 &lt;Italic&gt; False &lt;/ Italic&gt; 
					 &lt;Strikeout&gt; True &lt;/ Strikeout&gt; 
					 &lt;Underline&gt; False &lt;/ Underline&gt; 
				 &lt;/ Font&gt;
			 &lt;/ ItemChecked&gt;
		 &lt;/ Elements&gt;
	 &lt;/ LookAndFeel&gt;
	 &lt;Confirmation&gt;
		 &lt;DeleteElement&gt; True &lt;/ DeleteElement&gt; 
	 &lt;/ Confirmation&gt;
	 &lt;Windows&gt;
		 &lt;HelpWindow&gt;
			 &lt;Top&gt; 182 &lt;/ Top&gt; 
			 &lt;Left&gt; 73 &lt;/ Left&gt; 
			 &lt;Width&gt; 1135 &lt;/ Width&gt; 
			 &lt;Height&gt; 642 &lt;/ Height&gt; 
			 &lt;WindowState&gt; 0 &lt;/ WindowState&gt; 
			 &lt;SplitterLeft&gt; 156 &lt;/ SplitterLeft&gt; 
		 &lt;/ HelpWindow&gt;
	 &lt;/ Windows&gt;
 &lt;/ config&gt; </pre></blockquote><br><br>  <strong>PS</strong> All this business supports the grouping of properties into separate objects inherited from TPersistent. <br><br>  <a href="http://code.google.com/p/txmlconfig/">project page</a> on GoogleCode. </div><p>Source: <a href="https://habr.com/ru/post/27764/">https://habr.com/ru/post/27764/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../27763/index.html">Search in favorites.</a></li>
<li><a href="../277631/index.html">Kilometers of logs and recovery of databases on MS SQL</a></li>
<li><a href="../277635/index.html">Get websocket data using swift and populate UITableView (node.js server)</a></li>
<li><a href="../277637/index.html">Automatic work with SMS on the modem ZTE-MF823</a></li>
<li><a href="../277639/index.html">Implementing a MODBUS RTU server using the Fastwel interface module and CoDeSys software</a></li>
<li><a href="../277643/index.html">Load testing - product quality assurance stage</a></li>
<li><a href="../277645/index.html">Amelisa. Offline and realtime engine for React and Mongo</a></li>
<li><a href="../277649/index.html">50 shades of paranoia or how to store passwords without saving</a></li>
<li><a href="../27765/index.html">Maven Overview Plugin</a></li>
<li><a href="../277653/index.html">Installing a Django project on a VPS (centOS 7) [For Beginners]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>