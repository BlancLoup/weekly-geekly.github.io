<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to let cryptographers sink a company</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So far, not all system administrators have enjoyed their full acquaintance with crypto-fiber, although many are trying. In this article, I will explai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to let cryptographers sink a company</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/f89/70e/9d1/f8970e9d196f489dadc8a32baf22ba71.png" alt="image alt text"></p><br><p>  So far, not all system administrators have enjoyed their full acquaintance with crypto-fiber, although many are trying.  In this article, I will explain what needs to be done to facilitate the entry of the cryptographer into the infrastructure and to ensure the most devastating consequences. <a name="habracut"></a></p><br><p>  <strong>Depending on the worldview and mood, what is written can be perceived both literally and creatively.</strong> </p><br><h1 id="vektor-ataki-i-zaschita-perimetra">  Attack Vector and Perimeter Defense </h1><br><p>  Most often, cryptographers get into the infrastructure in two ways - via email, or outside, through RDP.  With the mail, everything is clear: the letters "from the tax" and "from the bank" reach their recipients even through spam filters (it is better, of course, to disable them altogether).  But on the second method, I will focus in more detail. </p><br><p>  First you need to open RDP outside - it will be easier for employees to work, without any uncomfortable VPNs there.  If the boss wants to increase information security, just hang the external RDP port on another.  This does not interfere with scanners, and the boss may calm down. </p><br><p><img src="https://habrastorage.org/files/a4b/a71/fc2/a4ba71fc2ea741d6a6b6994a09c4e2c8.jpg" alt="image alt text"></p><br><p>  <em>Brutfors when auditing failed login attempts is enabled</em> </p><br><p>  The virus will try to get to your server using brute force.  In order to maximally entreat this task to him, perform the following "tuning": </p><br><ul><li><p>  On the terminal server, disable account lockout, which works after several failed login attempts; </p><br></li><li><p>  If the terminal server has a fail2ban equivalent, for example, <a href="https://github.com/EvanAnderson/ts_block">Ts_block</a> , <a href="http://nerderies.blogspot.ru/">EvlWatcher</a> or <a href="https://rdpguard.com/">RdpGuard</a> , then remove it immediately.  This service will provide you with blocking on the firewall IP-address after unsuccessful attempts to connect.  You do not want to interfere with hacking, right? </p><br></li><li>  Passwords of users and administrators should be as short and simple as possible - ideally, consist only of numbers.  If management suddenly orders action, turn on password complexity requirements.  This does not interfere with the cryptographer if you do not put a length limit.  Without length restrictions, users will use dictionary passwords, because they are more convenient than complex combinations and easier to select. </li></ul><br><p>  When the RDP is open outside, all users have simple passwords, and letters with links to archives regularly come to the post office, the virus will not keep itself waiting.  The administrator‚Äôs next task is to facilitate the new arrival of decent feeding in the infrastructure. </p><br><h1 id="optimiziruem-infrastrukturu">  We optimize infrastructure </h1><br><p>  When the cryptographer "knocks" to you in the form of a letter from the "prosecutor's office", the system can be alerted.  Here the user downloaded the archive, launched the executable file, but when starting up a message appears: </p><br><p><img src="https://habrastorage.org/files/f3a/bd5/dd4/f3abd5dd40fa414f8565baba089a075e.jpg" alt="image alt text"></p><br><p>  This means that the <a href="https://technet.microsoft.com/en-us/library/hh831534(v%3Dws.11).aspx">Software Restriction Policies</a> (SRP) policy is enabled on the system.  This technology appeared at the time of Windows XP and its principle of operation is very simple: with a configured policy, none of the executable files, except the ones allowed, will be launched.  And only exploits will remain really dangerous for the system. </p><br><p>  Fortunately for coders, rare administrators include this policy.  If your system is ‚Äúunlucky‚Äù and protection is working, then you need to change the domain or local group policy, setting the default security level to ‚Äúunlimited‚Äù: </p><br><p><img src="https://habrastorage.org/files/dfc/652/bb4/dfc652bb438a4bde91c532a09673d127.jpg" alt="image alt text"></p><br><p>  But management can pay attention to disabling the policy.  In this case, you can open another loophole for the virus.  Usually, when configuring SRP, executable files from system folders are allowed to run, but one thing is left out: the system folders have subfolders in which the user has rights to create files.  For example, the path C: \ Windows \ Temp: </p><br><p><img src="https://habrastorage.org/files/181/578/6fc/1815786fc02d4ac69521afcb814d681b.jpg" alt="image alt text"></p><br><p>  <em>In the security settings, allow the creation of files and their execution</em> </p><br><p>  A complete list of interesting subfolders in the system directories can be obtained using Powershell or through utilities like <a href="http://www.systemtools.com/somarsoft/index.html">DumpSec</a> . </p><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>‚ÄìChildItem C:\Windows\ ‚Äìrecurse | <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>‚ÄìAcl | export‚Äìcsv filename.csv</code> </pre> <br><p>  To cipher operators who get into the system via mail, this, of course, will not help.  But if the author of the virus has received unprivileged access to the server, then he will be able to upload executable files to these folders and encrypt anything.  An experienced encryption master can also get password hashes (especially if the system uses NTLM), and through them open the hash through brute force and discover already privileged access.  For NTLM to work instead of secure Kerberos, it‚Äôs enough to access network resources not by name, but by IP address. </p><br><p>  Administrator rights on computers also help in obtaining hashes.  Therefore, if the user needs access to specific applications, then you should not allocate his computer in a separate VLAN.  Optimally, with the rights of the local administrator, immediately issue and domain. </p><br><p>  If the policy of limited use of programs is disabled, then the antivirus can be left: all the same, the encryptor who uses the installed archiver, the antivirus can be caught only by signatures.  At the same time, UAC must be disabled. </p><br><p>  Now the virus is guaranteed to be able to penetrate the infrastructure and encrypt useful data.  However, for the final triumph, this is not enough: after all, you will have backup copies that will quickly restore their functionality.  So what?  That's right, adjust the backup settings - so as not to interfere ... </p><br><h1 id="nastraivaem-rezervnoe-kopirovanie">  Configuring backup </h1><br><p>  Do not turn off the backup completely - it will cause a lot of questions, even for not very savvy employees, when you suddenly can not restore the deleted file at their request. </p><br><p>  There are more elegant ways to make system recovery after a coder‚Äôs attack impossible: </p><br><ul><li><p>  The backups must be on the same server: the encryption cipher encrypts them, and the existing shadow copies will delete them; </p><br></li><li><p>  Files must be archived with the extension .zip or .bak.  God forbid billgates, there will be files .exe or even without an extension - our "animal" can skip them! </p><br></li><li><p>  It is undesirable to make backups to the cloud or to a network share connected by a separate username - so it will be difficult for the virus to reach them; <br>  Another good option is to set up a backup in a shared folder with ‚ÄúAll - full access‚Äù rights. </p><br></li><li><p>  You should not keep backups for a certain period: it is better to create backup copies on a daily basis, erasing previous ones.  And you do not need to enable for backup copying settings for your own protocol in your repository; </p><br></li><li>  Another thing you should not forget about is that the built-in backup tool for Windows can make backups to a hard disk that is invisible in the system.  This is inconvenient for both you and the cryptographer. </li></ul><br><p>  Now, after the cipher attacker can be sad, but confidently say that there are no backups.  This is victory! </p><br><p><img src="https://habrastorage.org/files/103/f14/4ff/103f144ffb014524b8ab66196c76d472.jpg" alt="image alt text"></p><br><p>  <em>Spora ransomware removes shadow copies using the vssadmin.exe command and disables recovery in the boot loader.</em>  <em>UAC could stop this action.</em> </p><br><p>  Although not - you can make the final chord and become an intermediary between the organization and the authors of cryptographers.  To do this, tell the boss that the extortioners do not have to pay, but there are companies involved in decoding.  After that, take from him an amount equal to that which the extortioners are asking plus throw a percentage - and voila, a quiet monetary joy was added to the moral pleasure.  You can safely consider yourself a god of systemic intrigue and ... it is better to quit. </p><br><h1 id="a-teper-serezno">  Now seriously </h1><br><p>  On writing this article, the eleventh in the past six months was inspired by an appeal from organizations affected by the coder's actions.  When investigating the attack vector, there were wonderful things like the open RDP for user ‚Äú1‚Äù with password ‚Äú1‚Äù, open attachments from letters ‚Äúfrom the bank‚Äù, and the researcher who mixed up the isolated sandbox computer with the blast machine. </p><br><p>  It's a shame that the simplest setting of the SRP and the perimeter closed a little more seriously would help avoid the sad consequences.  I hope the material will help someone to organize the protection of the enterprise more rationally, or at least think about it. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/325080/">https://habr.com/ru/post/325080/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325070/index.html">Myths about Spark, or Can a Sparkle Java Developer Use Spark?</a></li>
<li><a href="../325072/index.html">Runtyper - a tool for checking types when executing JavaScript code</a></li>
<li><a href="../325074/index.html">Machine Design Tools</a></li>
<li><a href="../325076/index.html">We start the flow velocity sensor</a></li>
<li><a href="../325078/index.html">MEPhI organizes information security competition for students</a></li>
<li><a href="../325082/index.html">Terminal graphics</a></li>
<li><a href="../325084/index.html">Test items. Opinions and speculations</a></li>
<li><a href="../325088/index.html">Blog a la Habr, the choice of platform</a></li>
<li><a href="../325090/index.html">We start VMWare ESXi 6.5 under QEMU hypervisor</a></li>
<li><a href="../325092/index.html">Several arguments against Dependency Injection and Inversion of Control</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>