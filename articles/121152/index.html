<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Quick tinderbox setup for testing FreeBSD ports</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The proposed text is addressed primarily to FreeBSD ports maintainers and committers themselves, but even if you haven‚Äôt yet sent any ports of the por...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Quick tinderbox setup for testing FreeBSD ports</h1><div class="post__text post__text-html js-mediator-article">  The proposed text is addressed primarily to FreeBSD ports maintainers and committers themselves, but even if you haven‚Äôt yet sent any ports of the ports category, but are going to do it, or simply don‚Äôt mind learning about QA methods for the ports collection, I think you will It will be interesting. <br><a name="habracut"></a><br>  Actually, this is <a href="http://tinderbox.marcuscom.com/">MarcusCom Tinderbox</a> - a set of scripts written by Marcus Clarke associates based on those used to build official FreeBSD packages. <br><br>  In short, it works like this: you specify a set of basic systems (base system in FreeBSD terminology; not necessarily a release, it can be any stable branch or -CURRENT, or even your own build), port trees and builds (combinations of the first two).  Then, in a pure chroot environment, you can assemble any port as a packet, and make sure you don‚Äôt miss anything: all dependencies are taken into account, everything is correctly assembled, put and removed, without leaving anything superfluous in the system.  All meta information is stored in the database (MySQL and PostgreSQL are supported), there are advanced tools for updating ports and the ‚Äúsubstrate‚Äù of the target system, caching the assembled packages and distfiles, support for ccache and even PHP web frontend. <br><br>  In fact, the installation, configuration, and usage examples are described in some detail in the <a href="http://tinderbox.marcuscom.com/README/README.html">documentation</a> , but only a few use the tinderbox regularly. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Why? </h2><br>  The point here, it seems to me, is that the authors are far from first thinking about simple developers who do not need anything more complicated than just testing their port on a particular version of FreeBSD.  No need to collect statistics for each port (build-logs, error types, when the last time ‚Äúeverything worked‚Äù, etc.) and store it.  Few really need web access and tinderd service. <br><br>  In this sense, the initial requirements are unreasonably high.  For first of all, a person who wants to quickly test their changes before committing or sending PR (and not deploying a build farm with a full collection of statistics and then distributing it ‚Äúdirectly to the web‚Äù) raises the question: why do I need a database at all? <br><br>  A typical FreeBSD user on a desktop will most likely not have any * SQL other than SQLite.  Putting MySQL or PostgreSQL just for the sake of the tinderbox is just silly for general reasons.  <s>Fortunately, quite recently the project was <a href="https://github.com/markjdb/tinderbox-WORK">forknook</a> in order to improve it (the official repository has not been updated for a long time), and SQLite support was added first.</s>  For some reason unknown to me, the author deleted all his repositories on the githaba.  You can <a href="">download</a> the <code>.git</code> directory, unpack it and execute the <code>git reset --hard</code> .  Now you can deploy the tinderbox in literally five to ten minutes. <br><br>  <b>Update:</b> Recently, SQLite support has appeared in the <a href="http://www.marcuscom.com:8080/cgi-bin/cvsweb.cgi/portstools/tinderbox/">official repository</a> . <br><br><h2>  For the cause! </h2><br>  We clone the repository into a directory with a short convenient name <code>tb</code> and switch to the <code>sqlite_support</code> branch (besides, we will create <code>scripts</code> link to the current directory, since we will work directly in it): <br><br><pre> <code class="xml hljs">git clone https://github.com/markjdb/tinderbox-WORK.git tb cd tb git checkout sqlite_support ln -s . scripts</code> </pre> <br>  <i>At once I will make a reservation that the following commands are supposed to be executed from under the root in order to avoid potential problems (although this is not always necessary).</i> <br><br>  Now you need to initialize the tinderbox settings, answering a few simple questions (choose sqlite as the base and set the file name): <br><br><pre> <code class="xml hljs">./tc Setup</code> </pre> <br>  The script will warn that we have not installed some dependencies, but most of them are needed for the web-frontend.  We only need <code>p5-DBD-SQLite</code> and <code>lftp</code> .  If you plan to support, for example, -STABLE branches and update them with <code>csup(1)</code> , and then build through <code>make world</code> , you need to create the <code>tb/scripts/etc/env/GLOBAL</code> <code>./tc init</code> running <code>./tc init</code> , but we have enough releases , which we will take via FTP, so you can skip this step. <br><br>  Now we need to create what I described above as a substrate (in the original jails) of all versions of FreeBSD for which we want to build packages.  They have nothing to do with <code>jail(8)</code> , in this case it is just a matching name, so I did not translate it literally.  At the heart of the tinderbox are only <code>chroot(8)</code> and mounting over NFS or nullfs (preferably, since there is no need to configure anything).  I think, for starters, we limit ourselves to the latest releases of two stable branches: <br><br><pre> <code class="xml hljs">./tc createJail -j 7.4 -t 7.4-RELEASE -u LFTP -H ftp.freebsd.org ./tc createJail -j 8.2 -t 8.2-RELEASE -u LFTP -H ftp.freebsd.org</code> </pre> <br>  Names must begin with the main FreeBSD version number (the same applies to build names, see below).  As a host (the <code>-H</code> parameter), it makes sense to substitute the address of the nearest mirror (we only need distsets of <code>base</code> , <code>dict</code> , <code>proflibs</code> and <code>src</code> ). <br><br>  Now we need to add our working ports tree - not <code>/usr/ports</code> , but which checkout is from Subversion (or, in the old way, from CVS) and from where we will create diffs for <code>send-pr(1)</code> or commit.  Let it be the directory <code>/home/alice/fbsd/ports</code> called <code>wip</code> (work in progress): <br><br><pre> <code class="xml hljs">./tc createPortsTree -p wip -u NONE -m /home/alice/fbsd/ports</code> </pre> <br>  The <code>-u NONE</code> option is not accidental: we explicitly state that it is not necessary to update the ports tree;  usually we update it ourselves through <code>cvs^Wsvn up</code> (this is our <i>working</i> tree).  There can be several trees, as well as substrates, but most often it is one on the machine of an ordinary ports hacker. <br><br>  However, we are almost there.  It remains to build builds: combinations of the substrate and the ports tree.  Because  we have two releases (7.4 and 8.2) and one tree (wip), then there will be two builds too: <br><br><pre> <code class="xml hljs">./tc createBuild -b 7.4-wip -j 7.4 -p wip ./tc createBuild -b 8.2-wip -j 8.2 -p wip</code> </pre> <br>  If we did something wrong (for example, we entered incorrect parameters in some of the commands), and the record has already got into the database, we will need to manually (using <code>sqlite3 tinderbox.db</code> ) delete the corresponding records (usually from the <code>jails</code> , <code>ports_trees</code> tables <code>ports_trees</code> or <code>builds</code> ). <br><br>  It is logical to use the existing cache as the local cache of distfiles: <br><br><pre> <code class="xml hljs">./tc configDistfile -c /usr/ports/distfiles</code> </pre> <br>  Actually, everything!  We are ready to build our first package in the tinderbox.  Let's collect, for example, <code>nmap</code> for FreeBSD-7.4 (indicating that we prefer to mount directories through nullfs and consider problems with <code>pkg-plist</code> fatal errors): <br><br><pre> <code class="xml hljs">./tc tinderbuild -nullfs -plistcheck -b 7.4-wip security/nmap</code> </pre> <br>  If everything is done correctly, after a while we will have new packages in the <code>packages/7.4-wip</code> directory and build logs in <code>logs/7.4-wip</code> (if you did not manage to assemble the port or any of its dependencies, the package will not appear, but we look for error logs in the <code>errors/7.4-wip</code> directory and carefully study them): <br><br><pre> <code class="xml hljs">$ find logs packages -type f -name nmap\* logs/7.4-wip/nmap-5.51_2.log packages/7.4-wip/All/nmap-5.51_2.tbz</code> </pre> <br>  In addition to files, symbolic links are also created by categories of the port and the  The latest link to install the package via <code>pkg_add -r</code> : <br><br><pre> <code class="xml hljs">$ find packages -type l -name nmap\* packages/7.4-wip/Latest/nmap.tbz packages/7.4-wip/ipv6/nmap-5.51_2.tbz packages/7.4-wip/security/nmap-5.51_2.tbz</code> </pre> <br><h2>  What's next? </h2><br>  In principle, usually more is not needed;  our goal is to be able to collect any ports in a clean environment for different versions of FreeBSD and not to litter our system with anything superfluous.  Of course, the possibilities of the tinderbox are much broader, but their description goes beyond the topic, and it will no longer be ‚Äúset up a tinderbox in five minutes.‚Äù  In addition, retelling documentation is not good.  :-) <br><br>  In conclusion, I will once again emphasize the importance of clean assembly at an early stage.  Remember: if the port is built on your system, this does not mean that it will be collected from all the others;  Only tinderbox provides the assembly, as they say, in the pristine environment.  Of course, the FreeBSD build cluster (pointyhat) does virtually the same thing, and if the package is not assembled, it will be revealed, the maintainer will receive a notification to which it will have to respond, otherwise the port will be marked as BROKEN.  But it all takes time, because  portmgr @ has to dig out more problematic logs, and users have to be content with a raw product.  A tinderbox, with almost no gestures on your part, if used properly, can greatly simplify the work of many people and help improve the overall quality of FreeBSD ports. </div><p>Source: <a href="https://habr.com/ru/post/121152/">https://habr.com/ru/post/121152/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../121142/index.html">GUNNARS: Upgrade an IT Man's View (Part 1)</a></li>
<li><a href="../121143/index.html">Box-box of diskettes</a></li>
<li><a href="../121145/index.html">Yandex.Maps will be paid for MTS subscribers</a></li>
<li><a href="../121147/index.html">BrowserDeps - different browsers for different connections</a></li>
<li><a href="../121150/index.html">In vkontakte you can no longer hide your friends list !! 1</a></li>
<li><a href="../121153/index.html">Gesturin - input gestures for Android</a></li>
<li><a href="../121154/index.html">I invite everyone to the cinema!</a></li>
<li><a href="../121155/index.html">Etiquette</a></li>
<li><a href="../121157/index.html">QtSpeech, text-to-speech access</a></li>
<li><a href="../121158/index.html">Master class in Kiev, June 18 (Sat)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>