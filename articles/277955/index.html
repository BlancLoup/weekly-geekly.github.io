<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Video transmission from the deep-sea robot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share with the community the experience of developing software for viewing and recording the video signal transmitted from the deep-water ro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Video transmission from the deep-sea robot</h1><div class="post__text post__text-html js-mediator-article">  I want to share with the community the experience of developing software for viewing and recording the video signal transmitted from the deep-water robot Moby Dick.  The development was carried out by order of <a href="http://www.rov-underwater.com/">The Whale</a> underwater robotics laboratory.  The project was designed to provide: <br>  - work with any IP cameras that support the RTSP protocol; <br>  - viewing and recording video from multiple IP cameras; <br>  - viewing and recording stereo video from two dedicated IP cameras; <br>  - Record video from the screen; <br>  - comfortable video viewing with a short drop in the data transfer rate. <br><br><img src="https://habrastorage.org/files/c30/74d/2fa/c3074d2faa2c4d46a6c26304aaf3d7ad.png"><br>  The deep-water robot Moby Dick of Project 1-0-1, landed from the board of the transrader of the <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25BE%25D0%25B7%25D0%25B4%25D1%2583%25D1%2588%25D0%25BD%25D0%25BE-%25D0%25BA%25D0%25BE%25D1%2581%25D0%25BC%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B5_%25D1%2581%25D0%25B8%25D0%25BB%25D1%258B_%25D0%25A0%25D0%25BE%25D1%2581%25D1%2581%25D0%25B8%25D0%25B9%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B9_%25D0%25A4%25D0%25B5%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D0%25B8">Russian</a> Moonboard <a href="https://ru.wikipedia.org/wiki/%25D0%259B%25D1%2583%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2580%25D0%25B0%25D0%25B4%25D1%2583%25D0%25B3%25D0%25B0_(%25D1%2580%25D0%25BE%25D0%25BC%25D0%25B0%25D0%25BD)">Rainbow,</a> explores the ocean of <a href="https://ru.wikipedia.org/wiki/%25D0%2595%25D0%25B2%25D1%2580%25D0%25BE%25D0%25BF%25D0%25B0_(%25D1%2581%25D0%25BF%25D1%2583%25D1%2582%25D0%25BD%25D0%25B8%25D0%25BA)">Europe</a> (in the artist‚Äôs view, a collage) <br><br>  If you are not afraid of the megaton code, welcome under cat. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><h4>  Moby dick </h4><br>  Moby Dick is a <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B5%25D0%25BB%25D0%25B5%25D1%2583%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D1%258F%25D0%25B5%25D0%25BC%25D1%258B%25D0%25B9_%25D0%25BD%25D0%25B5%25D0%25BE%25D0%25B1%25D0%25B8%25D1%2582%25D0%25B0%25D0%25B5%25D0%25BC%25D1%258B%25D0%25B9_%25D0%25BF%25D0%25BE%25D0%25B4%25D0%25B2%25D0%25BE%25D0%25B4%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25BF%25D0%25BF%25D0%25B0%25D1%2580%25D0%25B0%25D1%2582">remote</a> - <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B5%25D0%25BB%25D0%25B5%25D1%2583%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D1%258F%25D0%25B5%25D0%25BC%25D1%258B%25D0%25B9_%25D0%25BD%25D0%25B5%25D0%25BE%25D0%25B1%25D0%25B8%25D1%2582%25D0%25B0%25D0%25B5%25D0%25BC%25D1%258B%25D0%25B9_%25D0%25BF%25D0%25BE%25D0%25B4%25D0%25B2%25D0%25BE%25D0%25B4%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25BF%25D0%25BF%25D0%25B0%25D1%2580%25D0%25B0%25D1%2582">controlled underwater vehicle</a> (born Underwater Remotely Operated Vehicle (Underwater ROV or UROV)) developed in <a href="http://www.rov-underwater.com/">The Whale</a> underwater robotics laboratory.  The main goal in the design and creation of Moby Dick was to create a small robot capable of diving to the maximum (in perspective) depths of the world ocean (as part of the lifting mechanism), to issue high-resolution video (Full HD), take samples, samples, carry out rescue . <br><br><img src="https://habrastorage.org/files/41c/c8c/78a/41cc8c78a2a24d889311796b1d00be69.jpg"><br>  Deep-sea robot Moby Dick in front (two front cameras are visible in the upper part under the cylinders) <br><br><img src="https://habrastorage.org/files/8f7/5d5/555/8f75d555523a4decb8b08fb3f7888c4a.jpg"><br>  Deep-sea robot Moby Dick behind (visible rear camera at the bottom under the cable mount) <br><br>  As a rule, three digital video cameras are installed on Moby Dick, and two of them are mounted on a rotating suspension with 360 ¬∞ rotation on all three axes.  360 ¬∞ rotation along all three axes allows inspecting the engines of the apparatus and the general situation around and inside the frame, as well as quickly inspect lengthy objects (pipelines, ships, etc.) when the video camera is perpendicular to the movement of the robot.  This feature also allows you to receive a stereoscopic image of the seabed, it is possible to estimate the distance to objects and their size directly from the monitor screen. <br><br>  In total, up to 9 digital cameras can be installed on Moby Dick by getting an overview of the entire sphere.  However, in the maximum configuration, you have to be content with Full HD for only one camera - the rest will have to be connected as 720p due to the limited data transfer rate over the cable. <br><br>  It should be noted that this is the only underwater robot with the ability to transfer stereo video in our country.  Robots similar in their capabilities exist abroad, but in comparison with Moby Dick they are very large in size. <br><br><h4>  Receiving and recording video </h4><br>  The <a href="https://ffmpeg.zeranoe.com/">FFMPEG</a> library was chosen to receive and record video.  To isolate the developer from the specific API FFMPEG, a proxy DLL is used (compiled in the good old Microsoft Visual C ++ 2008 Express Edition).  Consider the most interesting parts of his code. <br><br>  Code is used to obtain high accuracy time stamps. <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> timer_supported;
<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> LARGE_INTEGER timer_f;
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timer_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> timer_supported = QueryPerformanceFrequency(&amp;timer_f);
}
<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> LARGE_INTEGER <span class="hljs-keyword"><span class="hljs-keyword">timer_t</span></span>;
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timer_get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QueryPerformanceCounter(&amp;<span class="hljs-keyword"><span class="hljs-keyword">timer_t</span></span>);
}
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> LONGLONG </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_microseconds_hi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> timer_get()? <span class="hljs-keyword"><span class="hljs-keyword">timer_t</span></span>.QuadPart * <span class="hljs-number"><span class="hljs-number">1000000</span></span> / timer_f.QuadPart : <span class="hljs-number"><span class="hljs-number">0</span></span>;
}
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> LONGLONG </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_microseconds_lo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetTickCount() * <span class="hljs-number"><span class="hljs-number">1000</span></span>i64;
}
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LONGLONG</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*get_microseconds)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>= get_microseconds_lo;
</code></pre><br>
      Sleep.   /           <br>
<pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> TIMECAPS tc;
...
<span class="hljs-comment"><span class="hljs-comment">//  DLL</span></span>
<span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;tc, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(tc));
...
<span class="hljs-comment"><span class="hljs-comment">//        </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag)
{
	get_microseconds = timer_init()? get_microseconds_hi : get_microseconds_lo;

	<span class="hljs-comment"><span class="hljs-comment">//       tc , ...</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!tc.wPeriodMin &amp;&amp; timeGetDevCaps(&amp;tc, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(tc)) == MMSYSERR_NOERROR)
	{
		timeBeginPeriod(tc.wPeriodMin); <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
		<span class="hljs-comment"><span class="hljs-comment">// Sleep     </span></span>
	}
}
<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
{
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tc.wPeriodMin) <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
	{
		timeEndPeriod(tc.wPeriodMin); <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
		<span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;tc, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(tc));
	}
}
</code></pre><br>
    ctx_t.<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ctx_t</span></span></span><span class="hljs-class">:</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">public</span></span> mt_obj <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
{
<span class="hljs-keyword"><span class="hljs-keyword">public</span></span>:
	AVFormatContext *format_ctx; <span class="hljs-comment"><span class="hljs-comment">// </span></span>

	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> stream; <span class="hljs-comment"><span class="hljs-comment">// -</span></span>

	AVCodecContext *codec_ctx; <span class="hljs-comment"><span class="hljs-comment">//  -</span></span>

	AVFrame *frame[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> frame_idx; <span class="hljs-comment"><span class="hljs-comment">//   (    !frame_idx  frames_count &gt; 0)</span></span>

        <span class="hljs-comment"><span class="hljs-comment">//BGR-    ...</span></span>
        <span class="hljs-comment"><span class="hljs-comment">//   DLL-    </span></span>
        AVFrame *x_bgr_frame; 
        SwsContext *x_bgr_ctx;

	AVFormatContext *ofcx; <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
	AVStream *ost; <span class="hljs-comment"><span class="hljs-comment">//-  </span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rec_started; <span class="hljs-comment"><span class="hljs-comment">//   (    )</span></span>
	mt_obj rec_cs; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>

	<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> pts[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> continue_on_error; <span class="hljs-comment"><span class="hljs-comment">//    </span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> disable_decode; <span class="hljs-comment"><span class="hljs-comment">// </span></span>

	<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*cb_fn)(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cb_param); <span class="hljs-comment"><span class="hljs-comment">//    </span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cb_param; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>

	<span class="hljs-keyword"><span class="hljs-keyword">ms_rec_ctx_t</span></span> *owner; <span class="hljs-comment"><span class="hljs-comment">//   -</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> out_stream; <span class="hljs-comment"><span class="hljs-comment">// - ()</span></span>

	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> frames_count; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>

	DWORD base_ms; <span class="hljs-comment"><span class="hljs-comment">//   FFMPEG</span></span>
	DWORD timeout_ms; <span class="hljs-comment"><span class="hljs-comment">//    FFMPEG</span></span>

	HANDLE thread_h; <span class="hljs-comment"><span class="hljs-comment">//</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> terminated; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
};
</code></pre><br>
     FFMPEG    <br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interrupt_cb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *_ctx)</span></span></span><span class="hljs-function">
</span></span>{
	<span class="hljs-keyword"><span class="hljs-keyword">ctx_t</span></span> *ctx = (<span class="hljs-keyword"><span class="hljs-keyword">ctx_t</span></span> *)_ctx;
	<span class="hljs-comment"><span class="hljs-comment">//    FFMPEG  ,    </span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GetTickCount() - ctx-&gt;base_ms &gt; ctx-&gt;timeout_ms) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;
	<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
}
</code></pre><br>
         FFMPEG   avformat_open_input / avformat_find_stream_info / av_read_frame / avformat_close_input<br>
<pre><code class="cpp hljs">format_ctx = avformat_alloc_context();
<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!format_ctx)
{...}

format_ctx-&gt;interrupt_callback.callback = interrupt_cb;
format_ctx-&gt;interrupt_callback.opaque = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>;

AVDictionary *opts = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tcp_flag) av_dict_set(&amp;opts, <span class="hljs-string"><span class="hljs-string">"rtsp_transport"</span></span>, <span class="hljs-string"><span class="hljs-string">"tcp"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">// TCP-</span></span>

base_ms = GetTickCount(); <span class="hljs-comment"><span class="hljs-comment">//    FFMPEG</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (avformat_open_input(&amp;format_ctx, src, <span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;opts) != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  FFMPEG (  )</span></span>
{...}
</code></pre><br>
    avformat_open_input        timeout_ms.              IP-.    ,      TCP.   UDP       (             ). <br>
<br>
      <br>
<pre><code class="cpp hljs">AVPacket packet;
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> finished;
<span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!ctx-&gt;terminated)
{
	ctx-&gt;base_ms = GetTickCount();
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (av_read_frame(ctx-&gt;format_ctx, &amp;packet) != <span class="hljs-number"><span class="hljs-number">0</span></span>)
	{
		<span class="hljs-comment"><span class="hljs-comment">//        </span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx-&gt;continue_on_error)
		{}
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
		{
			ctx-&gt;terminated = <span class="hljs-number"><span class="hljs-number">1</span></span>;
			ExitThread(<span class="hljs-number"><span class="hljs-number">0</span></span>);
		}
	}
	<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (packet.stream_index == ctx-&gt;stream)
	{
		<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> original_pts = packet.pts;

		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx-&gt;disable_decode) <span class="hljs-comment"><span class="hljs-comment">//     (  )</span></span>
		{
			ctx-&gt;rec_cs.lock(); <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx-&gt;owner) lock(ctx-&gt;owner); <span class="hljs-comment"><span class="hljs-comment">//    -</span></span>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx-&gt;ofcx)
			{
				<span class="hljs-comment"><span class="hljs-comment">//     </span></span>
				<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ctx-&gt;rec_started &amp;&amp; (packet.flags &amp; AV_PKT_FLAG_KEY))
				{
					ctx-&gt;rec_started = <span class="hljs-number"><span class="hljs-number">1</span></span>;
				}
				<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx-&gt;rec_started)
				{
					<span class="hljs-comment"><span class="hljs-comment">//  </span></span>
					<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> pts = packet.pts;
					<span class="hljs-comment"><span class="hljs-comment">//     </span></span>
					<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> delta = packet.dts - packet.pts;
					<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx-&gt;owner) <span class="hljs-comment"><span class="hljs-comment">//     -, ...</span></span>
					{
						LONGLONG start;
						<span class="hljs-comment"><span class="hljs-comment">//   -</span></span>
						get_start(ctx-&gt;owner, &amp;start);
						<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
						LONGLONG dt = (get_microseconds() - start) / <span class="hljs-number"><span class="hljs-number">1000</span></span>;
						<span class="hljs-comment"><span class="hljs-comment">//      </span></span>
						pts = dt * ctx-&gt;format_ctx-&gt;streams[ctx-&gt;stream]-&gt;time_base.den / <span class="hljs-number"><span class="hljs-number">1000</span></span>;
					}
					packet.stream_index = ctx-&gt;out_stream; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
					<span class="hljs-comment"><span class="hljs-comment">//       </span></span>
					packet.pts = av_rescale_q(pts, ctx-&gt;format_ctx-&gt;streams[ctx-&gt;stream]-&gt;time_base, ctx-&gt;ost-&gt;time_base);
					<span class="hljs-comment"><span class="hljs-comment">//      ...</span></span>
					<span class="hljs-comment"><span class="hljs-comment">//       </span></span>
					packet.dts = av_rescale_q(packet.dts == AV_NOPTS_VALUE? AV_NOPTS_VALUE : (pts + delta), ctx-&gt;format_ctx-&gt;streams[ctx-&gt;stream]-&gt;time_base, ctx-&gt;ost-&gt;time_base);
					<span class="hljs-comment"><span class="hljs-comment">//    </span></span>
					packet.duration = av_rescale_q(packet.duration, ctx-&gt;format_ctx-&gt;streams[ctx-&gt;stream]-&gt;time_base, ctx-&gt;ost-&gt;time_base);
					<span class="hljs-comment"><span class="hljs-comment">//     </span></span>
					packet.pos = <span class="hljs-number"><span class="hljs-number">-1</span></span>;
					<span class="hljs-comment"><span class="hljs-comment">//    -    ...</span></span>
					<span class="hljs-comment"><span class="hljs-comment">//FFMPEG   </span></span>
					av_interleaved_write_frame( ctx-&gt;ofcx, &amp;packet );
					<span class="hljs-comment"><span class="hljs-comment">//     </span></span>
					packet.stream_index = ctx-&gt;stream;
				}
			}
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx-&gt;owner) unlock(ctx-&gt;owner);
			ctx-&gt;rec_cs.unlock();
		}
		<span class="hljs-comment"><span class="hljs-comment">//  ,        ...</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (avcodec_decode_video2(ctx-&gt;codec_ctx, ctx-&gt;frame[ctx-&gt;frame_idx], &amp;finished, &amp;packet) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>)
		{
			<span class="hljs-comment"><span class="hljs-comment">//  (  )      </span></span>
			ctx-&gt;rec_cs.lock();
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx-&gt;owner) lock(ctx-&gt;owner);
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx-&gt;ofcx)
			{
				<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ctx-&gt;rec_started &amp;&amp; (packet.flags &amp; AV_PKT_FLAG_KEY))
				{
					ctx-&gt;rec_started = <span class="hljs-number"><span class="hljs-number">1</span></span>;
				}
				<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx-&gt;rec_started)
				{
					<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> pts = packet.pts;
					<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> delta = packet.dts - packet.pts;
					<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx-&gt;owner)
					{
						LONGLONG start;
						get_start(ctx-&gt;owner, &amp;start);
						LONGLONG dt = (get_microseconds() - start) / <span class="hljs-number"><span class="hljs-number">1000</span></span>;
						pts = dt * ctx-&gt;format_ctx-&gt;streams[ctx-&gt;stream]-&gt;time_base.den / <span class="hljs-number"><span class="hljs-number">1000</span></span>;
					}
					packet.stream_index = ctx-&gt;out_stream;
					packet.pts = av_rescale_q(pts, ctx-&gt;format_ctx-&gt;streams[ctx-&gt;stream]-&gt;time_base, ctx-&gt;ost-&gt;time_base);
					packet.dts = av_rescale_q(packet.dts == AV_NOPTS_VALUE? AV_NOPTS_VALUE : (pts + delta), ctx-&gt;format_ctx-&gt;streams[ctx-&gt;stream]-&gt;time_base, ctx-&gt;ost-&gt;time_base);
					packet.duration = av_rescale_q(packet.duration, ctx-&gt;format_ctx-&gt;streams[ctx-&gt;stream]-&gt;time_base, ctx-&gt;ost-&gt;time_base);
					packet.pos = <span class="hljs-number"><span class="hljs-number">-1</span></span>;
					av_interleaved_write_frame( ctx-&gt;ofcx, &amp;packet );
					packet.stream_index = ctx-&gt;stream;
				}
			}
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx-&gt;owner) unlock(ctx-&gt;owner);
			ctx-&gt;rec_cs.unlock();

			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (finished) <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
			{
				ctx-&gt;lock(); <span class="hljs-comment"><span class="hljs-comment">// </span></span>
				ctx-&gt;pts[ctx-&gt;frame_idx] = original_pts; <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
				ctx-&gt;frame_idx = !ctx-&gt;frame_idx; <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
				<span class="hljs-comment"><span class="hljs-comment">//      ,   </span></span>
				<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx-&gt;cb_fn) ctx-&gt;cb_fn(ctx-&gt;cb_param);
				ctx-&gt;unlock();

				<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx-&gt;frames_count + <span class="hljs-number"><span class="hljs-number">1</span></span> &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) ctx-&gt;frames_count = <span class="hljs-number"><span class="hljs-number">1</span></span>;
				<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ctx-&gt;frames_count++;
			}
		}
	}
	av_free_packet(&amp;packet);
}
</code></pre><br>
   :<br>
-         (           IP-,       );<br>
-   (        ).<br>
<br>
   .        .     1280 x 720, 24 fps, 2727 kbps    Intel Core2 Duo E8300 2.83    17%.    ffplay      .             .<br>
<br>
-    IP-     (     ).<br>
<br>
              (   moov atom not found)               <br>
<pre><code class="cpp hljs">AVOutputFormat *ofmt = av_guess_format( <span class="hljs-string"><span class="hljs-string">"VOB"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-comment"><span class="hljs-comment">// VOB</span></span>
ofcx = avformat_alloc_context();
<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ofcx)
{...}
ofcx-&gt;oformat = ofmt;
</code></pre><br>
        <br>
<pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ffmpeg_get_bmp_NB_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _ctx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *bmp_bits, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> w, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> h, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> br, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> co, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sa, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pts)</span></span></span><span class="hljs-function">
</span></span>{
	<span class="hljs-keyword"><span class="hljs-keyword">ctx_t</span></span> *ctx = (<span class="hljs-keyword"><span class="hljs-keyword">ctx_t</span></span> *)_ctx;

	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ctx || !ctx-&gt;frames_count) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//      - </span></span>

        <span class="hljs-comment"><span class="hljs-comment">//  BGR-        , ...</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ctx-&gt;x_bgr_frame || ctx-&gt;x_bgr_frame-&gt;width != w || ctx-&gt;x_bgr_frame-&gt;height != h)
	{
                <span class="hljs-comment"><span class="hljs-comment">//    BGR- </span></span>

		sws_freeContext(x_bgr_ctx);
		av_free(x_bgr_frame);

		x_bgr_frame = <span class="hljs-number"><span class="hljs-number">0</span></span>;
		x_bgr_ctx = <span class="hljs-number"><span class="hljs-number">0</span></span>;

                <span class="hljs-comment"><span class="hljs-comment">// BGR- </span></span>

		ctx-&gt;x_bgr_frame = av_frame_alloc();
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ctx-&gt;x_bgr_frame)
		{
        		sws_freeContext(x_bgr_ctx);
        		av_free(x_bgr_frame);

        		x_bgr_frame = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        		x_bgr_ctx = <span class="hljs-number"><span class="hljs-number">0</span></span>;

			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}

		ctx-&gt;x_bgr_frame-&gt;width = w;
		ctx-&gt;x_bgr_frame-&gt;height = h;

		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> 
		(
			avpicture_fill((AVPicture *)ctx-&gt;x_bgr_frame, <span class="hljs-number"><span class="hljs-number">0</span></span>, PIX_FMT_RGB32, w, h) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>
		)
		{
        		sws_freeContext(x_bgr_ctx);
        		av_free(x_bgr_frame);

        		x_bgr_frame = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        		x_bgr_ctx = <span class="hljs-number"><span class="hljs-number">0</span></span>;

			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}

                <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
		ctx-&gt;x_bgr_ctx = sws_getContext(ctx-&gt;codec_ctx-&gt;width, ctx-&gt;codec_ctx-&gt;height, ctx-&gt;codec_ctx-&gt;pix_fmt, w, h, PIX_FMT_RGB32, SWS_BICUBIC, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ctx-&gt;x_bgr_ctx)
		{
        		sws_freeContext(x_bgr_ctx);
        		av_free(x_bgr_frame);

        		x_bgr_frame = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        		x_bgr_ctx = <span class="hljs-number"><span class="hljs-number">0</span></span>;

			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}
	}

	<span class="hljs-comment"><span class="hljs-comment">// BGR-       </span></span>
	ctx-&gt;x_bgr_frame-&gt;data[<span class="hljs-number"><span class="hljs-number">0</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *)bmp_bits;
	ctx-&gt;x_bgr_frame-&gt;data[<span class="hljs-number"><span class="hljs-number">0</span></span>] += ctx-&gt;x_bgr_frame-&gt;linesize[<span class="hljs-number"><span class="hljs-number">0</span></span>] * (h - <span class="hljs-number"><span class="hljs-number">1</span></span>);
	ctx-&gt;x_bgr_frame-&gt;linesize[<span class="hljs-number"><span class="hljs-number">0</span></span>] = -ctx-&gt;x_bgr_frame-&gt;linesize[<span class="hljs-number"><span class="hljs-number">0</span></span>];   

	<span class="hljs-comment"><span class="hljs-comment">// , , </span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *table;
	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *inv_table;
	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> brightness, contrast, saturation, srcRange, dstRange; 
	sws_getColorspaceDetails(ctx-&gt;x_bgr_ctx, &amp;inv_table, &amp;srcRange, &amp;table, &amp;dstRange, &amp;brightness, &amp;contrast, &amp;saturation); 
	brightness = ((br&lt;&lt;<span class="hljs-number"><span class="hljs-number">16</span></span>) + <span class="hljs-number"><span class="hljs-number">50</span></span>) / <span class="hljs-number"><span class="hljs-number">100</span></span>;
	contrast = (((co+<span class="hljs-number"><span class="hljs-number">100</span></span>)&lt;&lt;<span class="hljs-number"><span class="hljs-number">16</span></span>) + <span class="hljs-number"><span class="hljs-number">50</span></span>) / <span class="hljs-number"><span class="hljs-number">100</span></span>;
	saturation = (((sa+<span class="hljs-number"><span class="hljs-number">100</span></span>)&lt;&lt;<span class="hljs-number"><span class="hljs-number">16</span></span>) + <span class="hljs-number"><span class="hljs-number">50</span></span>) / <span class="hljs-number"><span class="hljs-number">100</span></span>;
	sws_setColorspaceDetails(ctx-&gt;x_bgr_ctx, inv_table, srcRange, table, dstRange, brightness, contrast, saturation); 

	<span class="hljs-comment"><span class="hljs-comment">//</span></span>
	sws_scale(ctx-&gt;x_bgr_ctx, ctx-&gt;frame[!ctx-&gt;frame_idx]-&gt;data, ctx-&gt;frame[!ctx-&gt;frame_idx]-&gt;linesize, <span class="hljs-number"><span class="hljs-number">0</span></span>, ctx-&gt;codec_ctx-&gt;height, ctx-&gt;x_bgr_frame-&gt;data, ctx-&gt;x_bgr_frame-&gt;linesize);

	<span class="hljs-comment"><span class="hljs-comment">//  BGR-   </span></span>
	ctx-&gt;x_bgr_frame-&gt;linesize[<span class="hljs-number"><span class="hljs-number">0</span></span>] = -ctx-&gt;x_bgr_frame-&gt;linesize[<span class="hljs-number"><span class="hljs-number">0</span></span>]; 

	<span class="hljs-comment"><span class="hljs-comment">//  </span></span>
	*(<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> *)pts = ctx-&gt;pts[!ctx-&gt;frame_idx] * <span class="hljs-number"><span class="hljs-number">1000</span></span> / ctx-&gt;format_ctx-&gt;streams[ctx-&gt;stream]-&gt;time_base.den;

	<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;
}

<span class="hljs-comment"><span class="hljs-comment">// </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ffmpeg_get_bmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _ctx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *bmp_bits, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> w, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> h, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> br, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> co, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sa, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pts)</span></span></span><span class="hljs-function">
</span></span>{
	<span class="hljs-keyword"><span class="hljs-keyword">ctx_t</span></span> *ctx = (<span class="hljs-keyword"><span class="hljs-keyword">ctx_t</span></span> *)_ctx;

	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ctx || !ctx-&gt;frames_count) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;

	ctx-&gt;lock();

	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res = ffmpeg_get_bmp_NB_(_ctx, bmp_bits, w, h, br, co, sa, pts);

	ctx-&gt;unlock();

	<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res;
}
</code></pre><br>
<h4> </h4><br>
              (     Borland C++ Builder 6.0 Enterprise Suite).<br>
<br>
<img src="https://habrastorage.org/files/d07/442/c0e/d07442c0ebe2422c8b68337bdce3d4c2.jpg"><br>
      (   ,    ‚Äî  ‚Äî     ;        )<br>
<br>
<iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/IwLZ41hY8VQ%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjOa-Axo2vZWG6Wu6PJjrvPGKyebQ" frameborder="0" allowfullscreen=""></iframe><br>
  (   ,          )<br>
<br>
   , ,  , , , ,         .             :  ,  , FPS   ,   ,  ,   ( ,  , ),        ()  ..<br>
<br>
         WM_PAINT  .  WM_PAINT      .        .          <br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t_buf_t</span></span></span><span class="hljs-class">
{</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">public</span></span>:
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
    __int64 *t; <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx; <span class="hljs-comment"><span class="hljs-comment">//      </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ttl; <span class="hljs-comment"><span class="hljs-comment">//     (   )</span></span>

    <span class="hljs-keyword"><span class="hljs-keyword">t_buf_t</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>): n(<span class="hljs-number"><span class="hljs-number">0</span></span>), t(<span class="hljs-number"><span class="hljs-number">0</span></span>), idx(<span class="hljs-number"><span class="hljs-number">0</span></span>), ttl(<span class="hljs-number"><span class="hljs-number">0</span></span>) {}
    <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~<span class="hljs-keyword"><span class="hljs-keyword">t_buf_t</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) {<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> [] t;}

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset_size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function">
    </span></span>{
        <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> [] t;
        <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;n = n;
        t = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> __int64[n];
        idx = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        ttl = <span class="hljs-number"><span class="hljs-number">0</span></span>;
    }
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_t</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(__int64 t)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">//     </span></span></span><span class="hljs-function">
    </span></span>{
        <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;t[idx] = t;
        idx++;
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idx == n) idx = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ttl &lt; n) ttl++;
    }
    __<span class="hljs-function"><span class="hljs-function">int64 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_dt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">//    </span></span></span><span class="hljs-function">
    </span></span>{
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ttl != n) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx_2 = idx - <span class="hljs-number"><span class="hljs-number">1</span></span>;
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idx_2 &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) idx_2 = n - <span class="hljs-number"><span class="hljs-number">1</span></span>;
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (t[idx_2] - t[idx]) / n;
    }
};
</code></pre><br>
         .                            .<br>
<br>
        ‚Äî     ,      .        .       ‚Äî       .       ‚Äî       .        (   ).       .<br>
<pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **form_bmp_bits; <span class="hljs-comment"><span class="hljs-comment">//     </span></span>
HBITMAP *form_bmp_h; <span class="hljs-comment"><span class="hljs-comment">//     </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> *frame_good; <span class="hljs-comment"><span class="hljs-comment">//      </span></span>

<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> frame_buffer_size; <span class="hljs-comment"><span class="hljs-comment">//  (  )</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> frame_buffer_size_2; <span class="hljs-comment"><span class="hljs-comment">//   (  )</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> in_frames_count_ttl; <span class="hljs-comment"><span class="hljs-comment">//    (   )</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> in_frame_idx; <span class="hljs-comment"><span class="hljs-comment">//       </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> out_frame_idx; <span class="hljs-comment"><span class="hljs-comment">//       </span></span>

<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> in_frames_count; <span class="hljs-comment"><span class="hljs-comment">//    </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> out_frames_count; <span class="hljs-comment"><span class="hljs-comment">//    </span></span>

<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> in_base_idx; <span class="hljs-comment"><span class="hljs-comment">//    (   )</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> out_base_idx; <span class="hljs-comment"><span class="hljs-comment">//    (   )</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> buffer_w, buffer_h; <span class="hljs-comment"><span class="hljs-comment">// </span></span>

<span class="hljs-keyword"><span class="hljs-keyword">t_buf_t</span></span> in_t_buf; <span class="hljs-comment"><span class="hljs-comment">//       </span></span>

__int64 out_dt; <span class="hljs-comment"><span class="hljs-comment">//   </span></span>

__int64 pts; <span class="hljs-comment"><span class="hljs-comment">//    </span></span>
__int64 dpts; <span class="hljs-comment"><span class="hljs-comment">//      </span></span>

<span class="hljs-comment"><span class="hljs-comment">//          </span></span>
HANDLE h_a;
HANDLE h_b;

<span class="hljs-comment"><span class="hljs-comment">//         </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n_param;
<span class="hljs-comment"><span class="hljs-comment">//        / </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> active_dt_param;

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset_frame_buffer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
    in_frames_count_ttl = frame_buffer_size == <span class="hljs-number"><span class="hljs-number">1</span></span>? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>;

    in_frame_idx = <span class="hljs-number"><span class="hljs-number">0</span></span>;
    out_frame_idx = <span class="hljs-number"><span class="hljs-number">0</span></span>;

    in_frames_count = frame_buffer_size == <span class="hljs-number"><span class="hljs-number">1</span></span>? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>;
    out_frames_count = frame_buffer_size == <span class="hljs-number"><span class="hljs-number">1</span></span>? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>;

    in_base_idx = <span class="hljs-number"><span class="hljs-number">0</span></span>;
    out_base_idx = frame_buffer_size == <span class="hljs-number"><span class="hljs-number">1</span></span>? <span class="hljs-number"><span class="hljs-number">0</span></span> : frame_buffer_size;

    <span class="hljs-comment"><span class="hljs-comment">//        </span></span>
    in_t_buf.reset_size(n_param);

    out_dt = <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    20 </span></span>
}
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_frame_buffer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
    reset_frame_buffer();

    frame_buffer_size_2 = frame_buffer_size == <span class="hljs-number"><span class="hljs-number">1</span></span>? <span class="hljs-number"><span class="hljs-number">1</span></span> : frame_buffer_size * <span class="hljs-number"><span class="hljs-number">2</span></span>;

    buffer_w = ClientWidth;
    buffer_h = ClientHeight;

    <span class="hljs-comment"><span class="hljs-comment">//      (  )      </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = frame_buffer_size == <span class="hljs-number"><span class="hljs-number">1</span></span>? <span class="hljs-number"><span class="hljs-number">1</span></span> : frame_buffer_size * <span class="hljs-number"><span class="hljs-number">4</span></span>;

    form_bmp_bits = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *[n];
    form_bmp_h = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HBITMAP[n];
    frame_good = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>[n];

    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; n; i++)
    {
        BITMAPINFOHEADER form_bmi_hdr;
        form_bmi_hdr.biSize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(BITMAPINFOHEADER);
        form_bmi_hdr.biWidth = buffer_w;
        form_bmi_hdr.biHeight = buffer_h;
        form_bmi_hdr.biPlanes = <span class="hljs-number"><span class="hljs-number">1</span></span>;
        form_bmi_hdr.biBitCount = <span class="hljs-number"><span class="hljs-number">32</span></span>;
        form_bmi_hdr.biCompression = BI_RGB;
        form_bmi_hdr.biSizeImage = form_bmi_hdr.biWidth * form_bmi_hdr.biHeight * <span class="hljs-number"><span class="hljs-number">4</span></span>;
        form_bmi_hdr.biXPelsPerMeter = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        form_bmi_hdr.biYPelsPerMeter = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        form_bmi_hdr.biClrUsed = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        form_bmi_hdr.biClrImportant = <span class="hljs-number"><span class="hljs-number">0</span></span>;

        form_bmp_h[i] = CreateDIBSection(<span class="hljs-number"><span class="hljs-number">0</span></span>, (BITMAPINFO *)&amp;form_bmi_hdr, DIB_RGB_COLORS, (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> **)&amp;form_bmp_bits[i], <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);

        frame_good[i] = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
    }
}
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">destroy_frame_buffer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = frame_buffer_size == <span class="hljs-number"><span class="hljs-number">1</span></span>? <span class="hljs-number"><span class="hljs-number">1</span></span> : frame_buffer_size * <span class="hljs-number"><span class="hljs-number">4</span></span>;

    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; n; i++)
        DeleteObject(form_bmp_h[i]);

    <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> [] form_bmp_bits;
    <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> [] form_bmp_h;
    <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> [] frame_good;
}
</code></pre><br>
   (  )                      .<br>
<br>
     .    DLL-       <br>
<pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">u_obj_t</span></span>::get_frame(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _NB_, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *pts)
{
    <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> res;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_NB_)
    {
        res = ffmpeg_get_bmp_NB_(form-&gt;ctx, form-&gt;form_bmp_bits[form-&gt;in_frame_idx + form-&gt;in_base_idx], form-&gt;buffer_w, form-&gt;buffer_h, form-&gt;br, form-&gt;co, form-&gt;sa, pts);
    }
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
    {
        res = ffmpeg_get_bmp(form-&gt;ctx, form-&gt;form_bmp_bits[form-&gt;in_frame_idx + form-&gt;in_base_idx], form-&gt;buffer_w, form-&gt;buffer_h, form-&gt;br, form-&gt;co, form-&gt;sa, pts);
    }
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res;
}

<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">u_obj_t</span></span>::exec(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _NB_)
{
    __int64 pts;
    <span class="hljs-comment"><span class="hljs-comment">//     , ...</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (form-&gt;form_bmp_h[form-&gt;in_frame_idx + form-&gt;in_base_idx] &amp;&amp; get_frame(_NB_, &amp;pts))
    {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pts != form-&gt;pts) <span class="hljs-comment"><span class="hljs-comment">//     (  ), ...</span></span>
        {
            form-&gt;frame_good[form-&gt;in_frame_idx + form-&gt;in_base_idx] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;

            <span class="hljs-comment"><span class="hljs-comment">//       ...</span></span>
            <span class="hljs-comment"><span class="hljs-comment">//      </span></span>
            form-&gt;dpts = pts - form-&gt;pts;
            form-&gt;pts = pts;

            <span class="hljs-comment"><span class="hljs-comment">//           </span></span>
            form-&gt;in_t_buf.<span class="hljs-keyword"><span class="hljs-keyword">set_t</span></span>(ffmpeg_get_microseconds() / <span class="hljs-number"><span class="hljs-number">1000</span></span>);

            <span class="hljs-comment"><span class="hljs-comment">//    </span></span>
            form-&gt;out_dt = form-&gt;in_t_buf.get_dt();
            <span class="hljs-comment"><span class="hljs-comment">//    250 </span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (form-&gt;out_dt &gt; <span class="hljs-number"><span class="hljs-number">250</span></span>) form-&gt;out_dt = <span class="hljs-number"><span class="hljs-number">250</span></span>;

            <span class="hljs-comment"><span class="hljs-comment">//        </span></span>
            form-&gt;in_frame_idx++;
            <span class="hljs-comment"><span class="hljs-comment">//    -          </span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (form-&gt;in_frame_idx == form-&gt;frame_buffer_size_2) form-&gt;in_frame_idx--;

            <span class="hljs-comment"><span class="hljs-comment">//     </span></span>
            form-&gt;in_frames_count++;

            <span class="hljs-comment"><span class="hljs-comment">//         </span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (form-&gt;in_frames_count_ttl != form-&gt;frame_buffer_size) form-&gt;in_frames_count_ttl++;
        }
    }
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
    {
        form-&gt;frame_good[form-&gt;in_frame_idx + form-&gt;in_base_idx] = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
    }
}

<span class="hljs-comment"><span class="hljs-comment">//</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cb_fn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cb_param)</span></span></span><span class="hljs-function">
</span></span>{
    Tmain_form *form = (Tmain_form *)cb_param;
    form-&gt;u_obj-&gt;lock(); <span class="hljs-comment"><span class="hljs-comment">//     </span></span>
    form-&gt;u_obj-&gt;exec(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">// </span></span>
    form-&gt;u_obj-&gt;unlock(); <span class="hljs-comment"><span class="hljs-comment">//     </span></span>

    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (form-&gt;frame_buffer_size == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">//     </span></span>
    {
        ResetEvent(form-&gt;h_b); <span class="hljs-comment"><span class="hljs-comment">//  A</span></span>
        SetEvent(form-&gt;h_a); <span class="hljs-comment"><span class="hljs-comment">//  A</span></span>
        ResetEvent(form-&gt;h_a); <span class="hljs-comment"><span class="hljs-comment">//  B</span></span>
        SetEvent(form-&gt;h_b); <span class="hljs-comment"><span class="hljs-comment">//  B</span></span>
    }
}
</code></pre><br>
     WM_PAINT        <br>
<pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __fastcall <span class="hljs-keyword"><span class="hljs-keyword">repaint_thread_t</span></span>::repaint(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)
{
    form-&gt;Repaint(); <span class="hljs-comment"><span class="hljs-comment">//    WM_PAINT  </span></span>

    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (form-&gt;frame_buffer_size == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">//         </span></span>
    {}
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-comment"><span class="hljs-comment">//...</span></span>
    {
        <span class="hljs-comment"><span class="hljs-comment">//        </span></span>
        form-&gt;out_frame_idx++;
        <span class="hljs-comment"><span class="hljs-comment">//       ,    </span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (form-&gt;out_frame_idx &gt;= form-&gt;out_frames_count || form-&gt;in_frames_count &gt;= form-&gt;frame_buffer_size_2)
        {
            form-&gt;u_obj-&gt;lock();

            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (form-&gt;in_frames_count) <span class="hljs-comment"><span class="hljs-comment">//     , ...</span></span>
            {
                <span class="hljs-comment"><span class="hljs-comment">//  </span></span>

                <span class="hljs-comment"><span class="hljs-comment">//      </span></span>
                <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = form-&gt;in_frames_count &gt;= form-&gt;frame_buffer_size_2? form-&gt;frame_buffer_size_2 : form-&gt;in_frames_count;

                form-&gt;out_frame_idx = <span class="hljs-number"><span class="hljs-number">0</span></span>;
                form-&gt;out_frames_count = n;
                form-&gt;out_base_idx = form-&gt;out_base_idx? <span class="hljs-number"><span class="hljs-number">0</span></span> : form-&gt;frame_buffer_size_2;

                form-&gt;in_frame_idx = <span class="hljs-number"><span class="hljs-number">0</span></span>;
                form-&gt;in_frames_count = <span class="hljs-number"><span class="hljs-number">0</span></span>;
                form-&gt;in_base_idx = form-&gt;in_base_idx? <span class="hljs-number"><span class="hljs-number">0</span></span> : form-&gt;frame_buffer_size_2;
            }
            <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-comment"><span class="hljs-comment">//           </span></span>
            {
                form-&gt;out_frame_idx--;
            }

            form-&gt;u_obj-&gt;unlock();
        }
    }
}

<span class="hljs-comment"><span class="hljs-comment">// </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __fastcall <span class="hljs-keyword"><span class="hljs-keyword">repaint_thread_t</span></span>::Execute(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)
{
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!Terminated)
    {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (form-&gt;frame_buffer_size == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">//     , ...</span></span>
        {
            WaitForSingleObject(form-&gt;h_a, <span class="hljs-number"><span class="hljs-number">250</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  A   250 </span></span>
            Synchronize(repaint); <span class="hljs-comment"><span class="hljs-comment">//     WM_PAINT  </span></span>
            WaitForSingleObject(form-&gt;h_b, <span class="hljs-number"><span class="hljs-number">250</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  B   250 </span></span>

            <span class="hljs-comment"><span class="hljs-comment">/*           
                     
                         */</span></span>
        }
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-comment"><span class="hljs-comment">//         ...</span></span>
        {
            <span class="hljs-comment"><span class="hljs-comment">//        ...</span></span>
            <span class="hljs-comment"><span class="hljs-comment">//  / </span></span>
            form-&gt;active_dt_param =
            (

            <span class="hljs-comment"><span class="hljs-comment">/*          ...
                    (     )
                    (      )*/</span></span>

            form-&gt;frame_buffer_size -
            (form-&gt;out_frames_count - form-&gt;out_frame_idx + form-&gt;in_frames_count)

            <span class="hljs-comment"><span class="hljs-comment">/*                
                

                         
              (  )   (   )

                           
               (   )

                          
             :
                 
            (               
            )
                 
            (              )

                          
                      -    
                     /  
                         
            (               
                         )...  :)*/</span></span>

            ) * form-&gt;out_dt / form-&gt;frame_buffer_size;

            LONGLONG t = ffmpeg_get_microseconds() / <span class="hljs-number"><span class="hljs-number">1000</span></span>;
            Synchronize(repaint); <span class="hljs-comment"><span class="hljs-comment">//     WM_PAINT  </span></span>
            LONGLONG dt = ffmpeg_get_microseconds() / <span class="hljs-number"><span class="hljs-number">1000</span></span> - t;

            <span class="hljs-comment"><span class="hljs-comment">//    :</span></span>
            <span class="hljs-comment"><span class="hljs-comment">//            </span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> delay = form-&gt;out_dt + form-&gt;active_dt_param - dt;
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (delay &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) Sleep(delay);
        }
    }
}
</code></pre><br>
                      .<br>
<br>
       <br>
<pre><code class="cpp hljs">mem_c = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TCanvas; <span class="hljs-comment"><span class="hljs-comment">//        </span></span>
...
<span class="hljs-comment"><span class="hljs-comment">//    </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Tmain_form::draw_bg_img(TCanvas *c, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> w, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> h)
{
    c-&gt;Brush-&gt;Style = bsSolid;
    c-&gt;Brush-&gt;Color = clBlack;
    c-&gt;FillRect(TRect(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, w, h));
}

<span class="hljs-comment"><span class="hljs-comment">//     </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Tmain_form::draw_no_signal_img(TCanvas *c, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> w, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> h)
{
    AnsiString s = <span class="hljs-string"><span class="hljs-string">"NO SIGNAL"</span></span>;

    c-&gt;Brush-&gt;Style = bsClear;
    c-&gt;Font-&gt;Color = clWhite;
    c-&gt;Font-&gt;Size = <span class="hljs-number"><span class="hljs-number">24</span></span>;
    c-&gt;Font-&gt;Style = TFontStyles()&lt;&lt; fsBold;
    c-&gt;TextOutA(w / <span class="hljs-number"><span class="hljs-number">2</span></span> - c-&gt;TextWidth(s) / <span class="hljs-number"><span class="hljs-number">2</span></span>, h / <span class="hljs-number"><span class="hljs-number">2</span></span> - c-&gt;TextHeight(s) / <span class="hljs-number"><span class="hljs-number">2</span></span>, s);
}
...
<span class="hljs-comment"><span class="hljs-comment">//  WM_PAINT</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __fastcall Tmain_form::WMPaint(TWMPaint&amp; Message)
{
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (form_bmp_h[out_frame_idx + out_base_idx]) <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
    {
        PAINTSTRUCT ps;
        HDC paint_hdc = BeginPaint(Handle, &amp;ps);

        HDC hdc_1 = CreateCompatibleDC(paint_hdc); <span class="hljs-comment"><span class="hljs-comment">//  1</span></span>
        HDC hdc_2 = CreateCompatibleDC(paint_hdc); <span class="hljs-comment"><span class="hljs-comment">//  2</span></span>
        mem_c-&gt;Handle = hdc_1; <span class="hljs-comment"><span class="hljs-comment">//    1</span></span>

        HBITMAP h_1 = CreateCompatibleBitmap(paint_hdc, buffer_w, buffer_h); <span class="hljs-comment"><span class="hljs-comment">// BMP</span></span>
        HBITMAP old_h_1 = (HBITMAP)SelectObject(hdc_1, h_1); <span class="hljs-comment"><span class="hljs-comment">//  1  BMP</span></span>

        <span class="hljs-comment"><span class="hljs-comment">//       (    1)    BMP</span></span>

        <span class="hljs-comment"><span class="hljs-comment">//  2  </span></span>
        HBITMAP old_h_2 = (HBITMAP)SelectObject(hdc_2, form_bmp_h[out_frame_idx + out_base_idx]);
        <span class="hljs-comment"><span class="hljs-comment">//   BMP</span></span>
        BitBlt(hdc_1, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, buffer_w, buffer_h, hdc_2, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, SRCCOPY);

        <span class="hljs-comment"><span class="hljs-comment">//              ...</span></span>
        <span class="hljs-comment"><span class="hljs-comment">//  (        ), ...</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (start_form-&gt;stereo_test &amp;&amp; (start_form-&gt;left_form == <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> || start_form-&gt;right_form == <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>))
        {
            <span class="hljs-comment"><span class="hljs-comment">//     (     )</span></span>
            mem_c-&gt;CopyMode = cmSrcCopy;
            mem_c-&gt;StretchDraw(TRect(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, buffer_w, buffer_h), start_form-&gt;left_form == <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>? start_form-&gt;left_img : start_form-&gt;right_img);
        }
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
        {
            <span class="hljs-comment"><span class="hljs-comment">//   -       NO SIGNAL</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ffmpeg_get_status(ctx))
            {
                draw_bg_img(mem_c, buffer_w, buffer_h);
                draw_no_signal_img(mem_c, buffer_w, buffer_h);
            }
            <span class="hljs-comment"><span class="hljs-comment">//           ...BUFFERING...</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!out_frames_count)            {
                draw_bg_img(mem_c, buffer_w, buffer_h);
                draw_buffering_img(mem_c, buffer_w, buffer_h);
            }
            <span class="hljs-comment"><span class="hljs-comment">//   -       NO SIGNAL</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!frame_good[out_frame_idx + out_base_idx])
            {
                draw_bg_img(mem_c, buffer_w, buffer_h);
                draw_no_signal_img(mem_c, buffer_w, buffer_h);
            }
        }
        <span class="hljs-comment"><span class="hljs-comment">//           ()</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (area_type) draw_area_img(mem_c, buffer_w, buffer_h);
        <span class="hljs-comment"><span class="hljs-comment">//     ( , FPS, ,    ..)...</span></span>
        <span class="hljs-comment"><span class="hljs-comment">//    </span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (show_ui) draw_info_img(mem_c, buffer_w, buffer_h);

        <span class="hljs-comment"><span class="hljs-comment">//     (BMP)  </span></span>
        BitBlt(paint_hdc, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, buffer_w, buffer_h, hdc_1, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, SRCCOPY);

        <span class="hljs-comment"><span class="hljs-comment">//  </span></span>

        SelectObject(hdc_1, old_h_1);
        SelectObject(hdc_2, old_h_2);

        DeleteObject(h_1);

        DeleteDC(hdc_1);
        DeleteDC(hdc_2);

        EndPaint(Handle, &amp;ps);
    }
}
</code></pre><br>
      ‚Äî                      (!),         (BMP)  .  ?   ,       (,       ,     )            ,                 ‚Ä¶<br>
<br>
   .        .           .<br>
<br>
<h4> -</h4><br>
 -    IP-   :         (        ).                            .               ().<br>
<br>
<img src="https://habrastorage.org/files/333/0fe/cfa/3330fecfa4ec43b489a8c9e57edd1c69.jpg"><br>
                ()<br>
<br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/pfEX9ANZD9I%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhjL598c1CVp-RRAQWqqui-d9NUOCA" frameborder="0" allowfullscreen=""></iframe><br>
  (   ‚Äî              )<br>
<br>
  -    :<br>
- VR       Android;<br>
-    <a href="http://getidisplay.com/">iDisplay</a> ();<br>
-      iDisplay ();<br>
-      USB ( ADB )  Wi-Fi   ¬´ ¬ª (    ‚Äî    );<br>
-      ¬´ ¬ª      VR .<br>
<br>
    -    :<br>
-    (VR         0 USD :),  iDisplay      5 USD);<br>
-  ‚Äî   .<br>
<br>
  :<br>
-¬´ ¬ª ‚Äî          ‚Äî         ‚Äî ,   ,         iDisplay     ,          :    Intel Core2 Duo E8300 2.83  iDisplay  50%   (  ; ,   Intel Core2 Quad Q9400 2.66         25%)   ,     ;          (  )        ‚Äî iDisplay  -          (            );       iDisplay             ¬´ ¬ª;<br>
-      VR ,           .<br>
<br>
<h4>   </h4><br>
      :              DLL-  .     <br>
<pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">scr_rec_thread_t</span></span>::main(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) <span class="hljs-comment"><span class="hljs-comment">// </span></span>
{
    LONGLONG t = ffmpeg_get_microseconds() / <span class="hljs-number"><span class="hljs-number">1000</span></span>;

    HBITMAP old_h = (HBITMAP)SelectObject(scr_bmp_hdc, scr_bmp_h);
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!BitBlt <span class="hljs-comment"><span class="hljs-comment">// </span></span>
    (
        scr_bmp_hdc, <span class="hljs-comment"><span class="hljs-comment">//HDC hdcDest</span></span>
        <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">//int nXDest</span></span>
        <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-comment"><span class="hljs-comment">//int nYDest</span></span>
        scr_w, <span class="hljs-comment"><span class="hljs-comment">//int nWidth</span></span>
        scr_h, <span class="hljs-comment"><span class="hljs-comment">//int nHeight</span></span>
        scr_hdc, <span class="hljs-comment"><span class="hljs-comment">//HDC hdcSrc</span></span>
        scr_x, <span class="hljs-comment"><span class="hljs-comment">//int nXSrc</span></span>
        scr_y, <span class="hljs-comment"><span class="hljs-comment">//int nYSrc</span></span>
        CAPTUREBLT | SRCCOPY <span class="hljs-comment"><span class="hljs-comment">//DWORD dwRop</span></span>
    ))
    {}
    SelectObject(scr_bmp_hdc, old_h);

    ffmpeg_rec_bmp(scr_rec_ctx, scr_bmp_bits); <span class="hljs-comment"><span class="hljs-comment">// </span></span>

    <span class="hljs-comment"><span class="hljs-comment">/*      FPS   
            
     */</span></span>

    LONGLONG dt = ffmpeg_get_microseconds() / <span class="hljs-number"><span class="hljs-number">1000</span></span> - t;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ms_per_frame = <span class="hljs-number"><span class="hljs-number">1000</span></span> / scr_rec_max_fps;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dt &lt; ms_per_frame)
    {
        dt = ms_per_frame - dt;
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dt &lt; scr_rec_min_delay) dt = scr_rec_min_delay;
    }
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
    {
        dt = scr_rec_min_delay;
    }
    Sleep(dt);

    <span class="hljs-comment"><span class="hljs-comment">//    FPS   </span></span>
    frames_count++;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ffmpeg_get_microseconds() / <span class="hljs-number"><span class="hljs-number">1000</span></span> - start &gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>)
    {
        start = ffmpeg_get_microseconds() / <span class="hljs-number"><span class="hljs-number">1000</span></span>;
        fps = frames_count;
        frames_count = <span class="hljs-number"><span class="hljs-number">0</span></span>;
    }
}

<span class="hljs-keyword"><span class="hljs-keyword">scr_rec_thread_t</span></span> *scr_rec_thread; <span class="hljs-comment"><span class="hljs-comment">//-</span></span>

<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> scr_x;
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> scr_y;
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> scr_w;
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> scr_h;
HDC scr_hdc; <span class="hljs-comment"><span class="hljs-comment">// </span></span>
HDC scr_bmp_hdc; <span class="hljs-comment"><span class="hljs-comment">// BMP</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *scr_bmp_bits; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
HBITMAP scr_bmp_h; <span class="hljs-comment"><span class="hljs-comment">// BMP</span></span>

<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scr_rec_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//   DLL-   </span></span>
    scr_rec_ctx = ffmpeg_alloc_rec_ctx();

    <span class="hljs-comment"><span class="hljs-comment">//    </span></span>
    scr_x = GetSystemMetrics(SM_XVIRTUALSCREEN);
    scr_y = GetSystemMetrics(SM_YVIRTUALSCREEN);
    scr_w = GetSystemMetrics(SM_CXVIRTUALSCREEN);
    scr_h = GetSystemMetrics(SM_CYVIRTUALSCREEN);

    <span class="hljs-comment"><span class="hljs-comment">//    BMP</span></span>
    scr_hdc = GetDC(<span class="hljs-number"><span class="hljs-number">0</span></span>);
    scr_bmp_hdc = CreateCompatibleDC(scr_hdc);

    <span class="hljs-comment"><span class="hljs-comment">// BMP</span></span>

    BITMAPINFOHEADER scr_bmi_hdr;
    scr_bmi_hdr.biSize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(BITMAPINFOHEADER);
    scr_bmi_hdr.biWidth = scr_w;
    scr_bmi_hdr.biHeight = scr_h;
    scr_bmi_hdr.biPlanes = <span class="hljs-number"><span class="hljs-number">1</span></span>;
    scr_bmi_hdr.biBitCount = <span class="hljs-number"><span class="hljs-number">32</span></span>;
    scr_bmi_hdr.biCompression = BI_RGB;
    scr_bmi_hdr.biSizeImage = scr_bmi_hdr.biWidth * scr_bmi_hdr.biHeight * <span class="hljs-number"><span class="hljs-number">4</span></span>;
    scr_bmi_hdr.biXPelsPerMeter = <span class="hljs-number"><span class="hljs-number">0</span></span>;
    scr_bmi_hdr.biYPelsPerMeter = <span class="hljs-number"><span class="hljs-number">0</span></span>;
    scr_bmi_hdr.biClrUsed = <span class="hljs-number"><span class="hljs-number">0</span></span>;
    scr_bmi_hdr.biClrImportant = <span class="hljs-number"><span class="hljs-number">0</span></span>;

    scr_bmp_h = CreateDIBSection(<span class="hljs-number"><span class="hljs-number">0</span></span>, (BITMAPINFO *)&amp;scr_bmi_hdr, DIB_RGB_COLORS, (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> **)&amp;scr_bmp_bits, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);

    scr_rec_thread = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">scr_rec_thread_t</span></span>(); <span class="hljs-comment"><span class="hljs-comment">// -</span></span>
}

<span class="hljs-comment"><span class="hljs-comment">// </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scr_rec_uninit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> scr_rec_thread;

    DeleteObject(scr_bmp_h);
    DeleteDC(scr_bmp_hdc);
    DeleteDC(scr_hdc);

    ffmpeg_free_ctx(scr_rec_ctx);
}

<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> scr_rec_ctx;
</code></pre><br>
    .    DLL-   <br>
<pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   </span></span>
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rec_ctx_t</span></span></span><span class="hljs-class">:</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">public</span></span> mt_obj
{
<span class="hljs-keyword"><span class="hljs-keyword">public</span></span>:
	AVFormatContext *ofcx; <span class="hljs-comment"><span class="hljs-comment">// </span></span>
	AVStream *ost; <span class="hljs-comment"><span class="hljs-comment">//</span></span>
	LONGLONG start; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
	AVPacket pkt; <span class="hljs-comment"><span class="hljs-comment">//</span></span>

 	AVFrame *frame; <span class="hljs-comment"><span class="hljs-comment">// YUV420P</span></span>
	AVFrame *_frame; <span class="hljs-comment"><span class="hljs-comment">// RGB32</span></span>
	<span class="hljs-comment"><span class="hljs-comment">/*       BGR-     
	  RGB32-  -           
	   BMP,          FFMPEG*/</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *_buffer; <span class="hljs-comment"><span class="hljs-comment">//</span></span>
	<span class="hljs-comment"><span class="hljs-comment">//  (        RGB32  YUV420P)</span></span>
	SwsContext *ctx;
	<span class="hljs-comment"><span class="hljs-comment">//ID    - ,   ,     ...</span></span>
	<span class="hljs-comment"><span class="hljs-comment">//     </span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> codec_id;
	<span class="hljs-comment"><span class="hljs-comment">//   -      </span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *preset;
	<span class="hljs-comment"><span class="hljs-comment">//CRF   -      ,    ...</span></span>
	<span class="hljs-comment"><span class="hljs-comment">//( .  FFMPEG)</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> crf;

	<span class="hljs-keyword"><span class="hljs-keyword">rec_ctx_t</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>):
		ofcx(<span class="hljs-number"><span class="hljs-number">0</span></span>),
		ost(<span class="hljs-number"><span class="hljs-number">0</span></span>),

		frame(<span class="hljs-number"><span class="hljs-number">0</span></span>),
		_frame(<span class="hljs-number"><span class="hljs-number">0</span></span>),
		_buffer(<span class="hljs-number"><span class="hljs-number">0</span></span>),
		ctx(<span class="hljs-number"><span class="hljs-number">0</span></span>),

		codec_id(CODEC_ID_H264),
		preset(strdup(<span class="hljs-string"><span class="hljs-string">"ultrafast"</span></span>)),
		crf(<span class="hljs-number"><span class="hljs-number">23</span></span>)
	{
		<span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;start, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(start));
		av_init_packet( &amp;pkt ); 
	}
	<span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~<span class="hljs-keyword"><span class="hljs-keyword">rec_ctx_t</span></span>()
	{
		ffmpeg_stop_rec2((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);
		<span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(preset);
	}
	<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clean</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">// </span></span></span><span class="hljs-function">
	</span></span>{
		sws_freeContext(ctx);
		av_free(_buffer);
		av_free(frame);
		av_free(_frame);

		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ost) avcodec_close( ost-&gt;codec );
		avformat_free_context( ofcx );

		ofcx = <span class="hljs-number"><span class="hljs-number">0</span></span>;
		ost = <span class="hljs-number"><span class="hljs-number">0</span></span>;
		<span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;start, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(start));
		av_init_packet( &amp;pkt ); 

		frame = <span class="hljs-number"><span class="hljs-number">0</span></span>;
		_frame = <span class="hljs-number"><span class="hljs-number">0</span></span>;
		_buffer = <span class="hljs-number"><span class="hljs-number">0</span></span>;
		ctx = <span class="hljs-number"><span class="hljs-number">0</span></span>;
	}
	<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *dst, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> w, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> h, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> den, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> gop_size)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">// </span></span></span><span class="hljs-function">
	</span></span>{
		<span class="hljs-comment"><span class="hljs-comment">//    </span></span>
		AVOutputFormat *ofmt = av_guess_format( <span class="hljs-string"><span class="hljs-string">"VOB"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-comment"><span class="hljs-comment">// VOB</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ofmt)
		{
			clean();
			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}
		ofcx = avformat_alloc_context();
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ofcx)
		{
			clean();
			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}
		ofcx-&gt;oformat = ofmt;

		<span class="hljs-comment"><span class="hljs-comment">// ,    </span></span>
		AVCodec *ocodec = avcodec_find_encoder( (AVCodecID)codec_id );
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ocodec || !ocodec-&gt;pix_fmts || ocodec-&gt;pix_fmts[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-number"><span class="hljs-number">-1</span></span>)
		{
			clean();
			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}
		ost = avformat_new_stream( ofcx, ocodec );
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ost)
		{
			clean();
			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}
		ost-&gt;codec-&gt;width = w;
		ost-&gt;codec-&gt;height = h;
		ost-&gt;codec-&gt;pix_fmt = ocodec-&gt;pix_fmts[<span class="hljs-number"><span class="hljs-number">0</span></span>];
		ost-&gt;codec-&gt;time_base.num = <span class="hljs-number"><span class="hljs-number">1</span></span>; 
		ost-&gt;codec-&gt;time_base.den = den; 
		ost-&gt;time_base.num = <span class="hljs-number"><span class="hljs-number">1</span></span>;
		ost-&gt;time_base.den = den;
		ost-&gt;codec-&gt;gop_size = gop_size; 
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ofcx-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER ) ost-&gt;codec-&gt;flags |= CODEC_FLAG_GLOBAL_HEADER;
		AVDictionary *opts = <span class="hljs-number"><span class="hljs-number">0</span></span>;
		av_dict_set(&amp;opts, <span class="hljs-string"><span class="hljs-string">"preset"</span></span>, preset, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">// </span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> crf_str[<span class="hljs-number"><span class="hljs-number">3</span></span>];
		<span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(crf_str, <span class="hljs-string"><span class="hljs-string">"%i"</span></span>, crf); <span class="hljs-comment"><span class="hljs-comment">// CRF</span></span>
		av_dict_set(&amp;opts, <span class="hljs-string"><span class="hljs-string">"crf"</span></span>, crf_str, <span class="hljs-number"><span class="hljs-number">0</span></span>);
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (avcodec_open2( ost-&gt;codec, ocodec, &amp;opts ) != <span class="hljs-number"><span class="hljs-number">0</span></span>)
		{
			clean();
			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}

		<span class="hljs-comment"><span class="hljs-comment">//   ,    </span></span>
		frame = av_frame_alloc();
		_frame = av_frame_alloc();
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!frame || !_frame)
		{
			clean();
			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}
		frame-&gt;format = PIX_FMT_RGB32;
		frame-&gt;width = w;
		frame-&gt;height = h;
		_frame-&gt;format = PIX_FMT_YUV420P;
		_frame-&gt;width = w;
		_frame-&gt;height = h;
		<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _buffer_size = avpicture_get_size(PIX_FMT_YUV420P, w, h);
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_buffer_size &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>)
		{
			clean();
			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}
		<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *_buffer = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *)av_malloc(_buffer_size * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>));
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_buffer)
		{
			clean();
			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> 
		(
			avpicture_fill((AVPicture *)frame, <span class="hljs-number"><span class="hljs-number">0</span></span>, PIX_FMT_RGB32, w, h) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> ||
			avpicture_fill((AVPicture *)_frame, _buffer, PIX_FMT_YUV420P, w, h) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>
		)
		{
			clean();
			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}
		ctx = sws_getContext(w, h, PIX_FMT_RGB32, w, h, PIX_FMT_YUV420P, SWS_BICUBIC, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ctx)
		{
			clean();
			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}

		<span class="hljs-comment"><span class="hljs-comment">// </span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (avio_open2( &amp;ofcx-&gt;pb, dst, AVIO_FLAG_WRITE, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>)
		{
			clean();
			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}

		<span class="hljs-comment"><span class="hljs-comment">// </span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (avformat_write_header( ofcx, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) != <span class="hljs-number"><span class="hljs-number">0</span></span>)
		{
			avio_close( ofcx-&gt;pb );
			clean();
			<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
		}

		<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
		start = get_microseconds();

		<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;
	}
};

<span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ffmpeg_start_rec2</span></span></span><span class="hljs-function">
</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(
    </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rec_ctx,
    </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *dst, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> w, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> h, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> den, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> gop_size
)</span></span></span><span class="hljs-function">
</span></span>{
	<span class="hljs-keyword"><span class="hljs-keyword">rec_ctx_t</span></span> *ctx = (<span class="hljs-keyword"><span class="hljs-keyword">rec_ctx_t</span></span> *)rec_ctx;

	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ctx) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;

	ffmpeg_stop_rec2(rec_ctx); <span class="hljs-comment"><span class="hljs-comment">//</span></span>

	<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ctx-&gt;prepare(dst, w, h, den, gop_size);
}

<span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ffmpeg_stop_rec2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rec_ctx)</span></span></span><span class="hljs-function">
</span></span>{
	<span class="hljs-keyword"><span class="hljs-keyword">rec_ctx_t</span></span> *ctx = (<span class="hljs-keyword"><span class="hljs-keyword">rec_ctx_t</span></span> *)rec_ctx;

	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ctx || !ctx-&gt;ofcx) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;

	<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
	av_write_trailer( ctx-&gt;ofcx );
	avio_close( ctx-&gt;ofcx-&gt;pb );

	ctx-&gt;clean();
}

<span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ffmpeg_rec_bmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rec_ctx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *bmp_bits)</span></span></span><span class="hljs-function">
</span></span>{
	<span class="hljs-keyword"><span class="hljs-keyword">rec_ctx_t</span></span> *ctx = (<span class="hljs-keyword"><span class="hljs-keyword">rec_ctx_t</span></span> *)rec_ctx;

	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ctx) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;

	<span class="hljs-comment"><span class="hljs-comment">// RGB32-        </span></span>
	ctx-&gt;frame-&gt;data[<span class="hljs-number"><span class="hljs-number">0</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *)bmp_bits;
	ctx-&gt;frame-&gt;data[<span class="hljs-number"><span class="hljs-number">0</span></span>] += ctx-&gt;frame-&gt;linesize[<span class="hljs-number"><span class="hljs-number">0</span></span>] * (ctx-&gt;frame-&gt;height - <span class="hljs-number"><span class="hljs-number">1</span></span>);
	ctx-&gt;frame-&gt;linesize[<span class="hljs-number"><span class="hljs-number">0</span></span>] = -ctx-&gt;frame-&gt;linesize[<span class="hljs-number"><span class="hljs-number">0</span></span>];  
	<span class="hljs-comment"><span class="hljs-comment">// RGB32-   YUV420P- </span></span>
	sws_scale(ctx-&gt;ctx, ctx-&gt;frame-&gt;data, ctx-&gt;frame-&gt;linesize, <span class="hljs-number"><span class="hljs-number">0</span></span>, ctx-&gt;frame-&gt;height, ctx-&gt;_frame-&gt;data, ctx-&gt;_frame-&gt;linesize);
	<span class="hljs-comment"><span class="hljs-comment">//  RGB32-   </span></span>
	ctx-&gt;frame-&gt;linesize[<span class="hljs-number"><span class="hljs-number">0</span></span>] = -ctx-&gt;frame-&gt;linesize[<span class="hljs-number"><span class="hljs-number">0</span></span>];   

	<span class="hljs-comment"><span class="hljs-comment">//         </span></span>
	LONGLONG dt = (get_microseconds() - ctx-&gt;start) / <span class="hljs-number"><span class="hljs-number">1000</span></span>;
	ctx-&gt;_frame-&gt;pts = dt * ctx-&gt;ost-&gt;time_base.den / <span class="hljs-number"><span class="hljs-number">1000</span></span>;

	<span class="hljs-comment"><span class="hljs-comment">//</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> got_packet;
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (avcodec_encode_video2(ctx-&gt;ost-&gt;codec, &amp;ctx-&gt;pkt, ctx-&gt;_frame, &amp;got_packet) != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;

	<span class="hljs-comment"><span class="hljs-comment">//      </span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res = <span class="hljs-number"><span class="hljs-number">1</span></span>;
	<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (got_packet) 
	{
		res = av_interleaved_write_frame( ctx-&gt;ofcx, &amp;ctx-&gt;pkt ) == <span class="hljs-number"><span class="hljs-number">0</span></span>? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>;
		av_free_packet( &amp;ctx-&gt;pkt );
	}
	<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res;
}
</code></pre><br>
 ,     (1280 x 1024, 25 fps)    Intel Core2 Duo E8300 2.83    30%         FPS,    ,            .<br>
<br>
   .                   . .<br>
<br>
            :<br>
<a href="https://habrahabr.ru/post/177071/">  </a>.</div><p>Source: <a href="https://habr.com/ru/post/277955/">https://habr.com/ru/post/277955/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277943/index.html">The competition of student works in theoretical computer science and discrete mathematics. Alan Turing</a></li>
<li><a href="../277945/index.html">HPE Intelligent Resilient Framework Virtualization Technology</a></li>
<li><a href="../277947/index.html">CPLD retrocomputing. Part 1 - Board for the student</a></li>
<li><a href="../277951/index.html">Distance learning at ShAD Yandex: 570 wonderful hours of my life</a></li>
<li><a href="../277953/index.html">What happens in C ++. Interviews with speakers and live broadcasts of the meeting in Yandex</a></li>
<li><a href="../277957/index.html">Web. History of one technology</a></li>
<li><a href="../277959/index.html">PHDays VI Young School starts accepting applications</a></li>
<li><a href="../277967/index.html">We invite you to Data Fest on March 5 and 6</a></li>
<li><a href="../277969/index.html">Friday format: DNA and data storage solution</a></li>
<li><a href="../277971/index.html">How the VMware cloud works, as well as networking and network connectivity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>