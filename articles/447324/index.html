<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How does the computer inside the Hayabusy-2, which dropped a bomb on Ryuga. And photos of its developers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, the Japanese automatic station Hayabusa-2 dropped a bomb on an asteroid Ryugu . The spacecraft is controlled by a HR5000 (JAXA2010 / 101) ra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How does the computer inside the Hayabusy-2, which dropped a bomb on Ryuga. And photos of its developers</h1><div class="post__text post__text-html js-mediator-article">  Recently, the <a href="https://lenta.ru/news/2019/04/05/bomb/">Japanese automatic station Hayabusa-2 dropped a bomb on an asteroid Ryugu</a> .  The spacecraft is controlled by a HR5000 (JAXA2010 / 101) radiation-resistant system with a 64-bit MIPS 5Kf processor core.  The on-board computer runs the real-time operating system uITRON, one of the family of RTOS s of the TRON standard, which appeared in Japan back in the 1980s <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582_TRON">and deserves a separate post</a> . <br><br>  In this post I will briefly describe what is included in the So5 HR5000 and its processor core, show photos of two of the key developers of the MIPS 4K and 5K lines, and also tell how you can play at home on the FPGA board with the ‚Äúdescendant of the younger brother‚Äù of this computer The 32-bit MIPS microAptiv UP kernel, whose Verilog hardware description code was based on MIPS 4KEc. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5fa/02a/94a/5fa02a94a100a6e139fe53bfb77f4cc5.png"><br><a name="habracut"></a><br>  Japan Aerospace Agency JAXA licensed processor core MIPS 5Kf from the US company MIPS Technologies.  This happened back in the 2000s.  The group that developed this core has existed in different configurations for 40 years: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  First, in 1978-1984, MIPS was a project in Stanford, under the direction of John Hennessy.  On the success of this project, Hennessy became the author of the most famous textbook on computer architecture and at some point the president of Stanford. </li><li>  Then, in 1984, MIPS became a commercial company - MIPS Computer Systems.  In the same year, ARM was commercialized.  In 1991, MIPS released the world's first 64-bit microprocessor - MIPS R4000. </li><li>  After that, MIPS was absorbed by Silicon Graphics and in the 1990s was used inside graphic stations, where the first films with realistic graphics were made in Hollywood (‚ÄúJurassic Park‚Äù). </li><li>  In the 2000s, the group emerged in the company MIPS Technologies and in particular designed a processor for JAXA.  The headquarters of MIPS was located in California, some of the developers of MIPS 5Kf <a href="https://www.hpcwire.com/1998/11/20/mips-technologies-opens-development-center-denmark/">sat in the European branch of MIPS in Copenhagen.</a> </li><li>  In 2012, MIPS Technologies bought the British company Imagination Technologies, which became famous as a GPU developer inside the early Apple iPhone. </li><li>  In 2017, Apple threw Imagination and, after some perturbations, technology and part of the MIPS group were integrated into Wave Computing, a startup that develops a chip to accelerate neural networks. </li><li>  Wave Computing Chip is a combination of a cluster of 64-bit MIPS I6500 processors, a matrix multiplier based on the systolic array a la Google TPU, and a dataflow processor based on a Coarse-Grained Reconfigurable Architecture (CGRA) device. ).  Classical processors in the I6500 cluster load the matrix multiplier and data stream processor, the matrix multiplier provides computational density, and the task stream processor is halfway between the classic processor and the matrix multiplier ‚Äî it is more flexible than the multiplier and more productive than the classic CPU. </li></ol><br>  So I took a picture with one of the two key developers of the MIPS 4K and 5K line - Larry Hudepohl, Larry Hudepol (in the red shirt on the right).  Larry began his career at Digital Equipment Corporation (DEC) as a processor designer for MicroVAX.  Then Larry worked in a small company Cyrix, which in the late 1980s defied Intel and made an FPU coprocessor that was compatible with Intel 80387 and was 50% faster than it.  Then Larry designed the MIPS chips in Silicon Graphics.  When MIPS Technologies separated from Silicon Graphics, Larry and Ryan Kinter together started the first independent MIPS product - MIPS 4K, which became the basis of the line that dominates the 2000s home electronics (DVD players, cameras, digital TVs).  Then MIPS 5K flew into space - it was used by the Japanese space agency JAXA.  Then Larry in the position of VP Hardware Engineering led the development of the following lines, and is now working on new Wave Accelerator architectures: <br><br><img width="800" src="https://habrastorage.org/getpro/habr/post_images/3c4/034/18a/3c403418a02c7b913f7503333ff8f467.jpg"><br><br>  Now back to the processor in Hayabus-2 (in Hayabus-1, it is different).  Here is the <a href="http://www.silicon-russia.com/wp-content/uploads/2019/04/MIPS645Kf.pdf">datasheet on the MIPS64 5Kf processor core</a> and the <a href="http://www.silicon-russia.com/wp-content/uploads/2019/04/MIPS645Kf.pdf">HR5000</a> <a href="http://www.silicon-russia.com/wp-content/uploads/2019/04/320MIPS64bitMPU.pdf">system data page</a> .  Note some interesting points. <br><br>  First of all, MIPS 5Kf is a pipeline processor.  If you are unfamiliar with how it works, then the easiest way to get acquainted is to study the seventh chapter of the book ‚ÄúDigital circuit design and computer architecture‚Äù by David M. Harris and Sarah L. Harris, the latest version of which can be downloaded <a href="http://www.mips.com/downloads/digital-design-and-computer-architecture-russian-edition-second-edition-ver3">here</a> or <a href="http://silicon-russia.com/public_materials/2018_01_15_latest_harris_harris_ru_barabanov_version/digital_design_rus-25.10.2017.pdf">here</a> .  At the same time, the conveyor in MIPS 5Kf is different from the classic MIPS conveyor from Harris &amp; Harris.  Those of you who read X &amp; X can look at the differences and guess why: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2f7/b1f/8bf/2f7b1f8bffa3a8b3486caeb42f4ebe7a.png"><br><br>  Of course, the MIPS 5Kf does not have five pipeline stages, but six, with the additional Dispatch stage.  This stage is needed to make MIPS 5Kf limited-superscalar.  It can perform not only one-by-one operations in the pipeline, but also can perform a floating-point operation simultaneously with an integer operation or with a memory operation (load or save).  The Dispatch stage runs a floating point coprocessor that has its own seven-stage pipeline: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/508/bff/391/508bff391f1203e66c0673688e1b0d9f.png"><br><br>  But on the right of the photo is Darren Jones, Darren Jones, the FPU developer at MIPS 5Kf.  The letter ‚Äúf‚Äù in ‚Äú5Kf‚Äù means exactly that it has a floating point: <br><br><img width="500" src="https://habrastorage.org/getpro/habr/post_images/156/d3b/e04/156d3be04866e0fb1b7dab56bb79920a.jpg"><br><br>  Here in this plate you can see how many cycles require different operations in the FPU and how often (repeat rate) they can be run into the pipeline.  For example, multiplication of single precision requires four cycles, but you can run a new multiplication into the pipeline each cycle.  So the FPU can simultaneously process four single precision multiplications at each stage of processing.  But the multiplication of double precision requires five cycles, and it can be started only with a pause in the cycle.  A complex double-square root operation requires as many as 32 cycles, and a new square-root can only be launched after 29 cycles.  This is how the calculation of the coordinates of the ship and the formulas for its movement in outer space is optimized: <br><br><img width="500" src="https://habrastorage.org/getpro/habr/post_images/458/e2f/e00/458e2fe00a0c894f6de90233ce342d44.png"><br><br>  Hayabusa-2 uses the MIPS 5Kf configuration with separate 32-kilobyte instruction and data caches.  At the same time, it is not clear from the <a href="http://www.silicon-russia.com/wp-content/uploads/2019/04/320MIPS64bitMPU.pdf">brief description of the HR5000</a> whether it uses a four-channel cache of 8 kilobytes each - or a dual-channel cache of 16 kilobytes each.  You can read how these caches work in X &amp; X, as well as in <a href="http://silicon-russia.com/public_materials/2015_11_14_mipsfpga_related_presentations/caches_in_mips_microaptive_up_2015_10_25.pdf">my old caching presentation</a> , as well as in the <a href="https://www.dropbox.com/s/dbdlz3qsgsfe23z/Sweetman%2520D.See%2520MIPS%2520run%2520Linux.2007.pdf%3Fdl%3D0">See MIPS Run Linux 2nd Edition by Dominic Sweetman</a> useful book <a href="https://www.dropbox.com/s/dbdlz3qsgsfe23z/Sweetman%2520D.See%2520MIPS%2520run%2520Linux.2007.pdf%3Fdl%3D0">:</a> <a href="https://www.dropbox.com/s/dbdlz3qsgsfe23z/Sweetman%2520D.See%2520MIPS%2520run%2520Linux.2007.pdf%3Fdl%3D0"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/49b/b0f/5f2/49bb0f5f26816d0b214fbcb702f3fc23.jpg"></a> <br><br>  The Hayabus-2 also has a Memory Management Unit (MMU), with a Translation Lookaside Buffer (TLB) buffer.  TLB is a universal tool for quickly converting addresses from virtual to physical.  TLB allows you to: <br><br><ol><li><p>  Hide the operating system memory from unprivileged code. </p></li><li><p>  Protect user programs from each other. </p></li><li><p>  Provide program access to the amount of virtual memory that exceeds the amount of physical RAM. </p></li><li><p>  Address more physical memory than available virtual addresses. </p></li><li><p>  Place the program in any part of the physical memory. </p></li><li><p>  Allows multiple regions of memory to look like a sequential piece. </p></li><li><p>  Allows you to load pieces of the program from an external device as needed. </p></li><li><p>  TLB also associates with the address various attributes: the prohibition of reading, writing and execution, as well as the attributes of cacheability and coherence. </p><br><ul><li><p>  The cacheability attribute is needed to show the processor where the address space is for the next level of the cache, and where it is for the I / O solvers that cannot be cached. </p></li><li><p>  Attributes of coherence are needed for joint work of several processor cores, each of which has its own first-level cache, and together they use a common second-level cache. </p></li></ul></li><li><p>  TLB can store an indicator that a record has been recorded on the page with this address.  This helps when swapping, loading and unloading memory pages on systems with less physical memory than the application needs to address all pieces of their code and data with virtual addresses. </p></li></ol><br><br>  Here is the translation of a 64-bit virtual address into a 36-bit physical address on MIPS 5Kf.  Why on Hayabus-2 64-bit processor with 36-bit physical addresses?  I suspect that Hayabusa-2 takes photographs and must process images, for which it takes a lot of memory.  Perhaps for some algorithms, 64-bit arithmetic and 64-bit exchanges with a cache (or 64-bit non-cached exchanges with memory) improve something, and it turns out to be useful in space.  But I don‚Äôt know for sure, you probably need to ask <a href="https://habr.com/ru/users/zelenyikot/" class="user_link">Zelenyikot</a> and <a href="https://habr.com/ru/users/amartology/" class="user_link">amartology</a> , who know more about space than I do. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1f4/b5e/54e/1f4b5e54e0f42636b906fe5d4f851682.png"><br><br>  You can read about TLB in X &amp; X and See MIPS Run, but there is a nuance: both books describe what TLB looks like from a programmer's point of view.  But from the point of view of the hardware developer, the CPU designers are deceiving the programmer, showing him TLB as one associative translation table, while there are actually three tables inside the TLB Hayabusy-2: micro-TLB instructions, micro-TLB data and common (Joint TLB).  First, the memory management device searches in ITLB and DTLB, and only if it does not find it, takes it from JTLB.  It costs the processor extra 2 cycles.  Also see <a href="http://silicon-russia.com/public_materials/2015_11_14_mipsfpga_related_presentations/tlb_mmu_in_mips_microaptiv_up_2015_10_25.pdf">my old TLB presentation</a> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f00/7eb/578/f007eb578f4887c7cf8f890444d61684.png"><br><br>  The interface between the first-level caches and the memory controller in MIPS 5Kf in Hayabusa-2 is called EB (pronounced IB).  This is short for External Bus.  It is similar to AHB and AXI, and allows you to make a burst, get a whole line from the cache or fill the cache with memory, using transfers in successive cycles. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f3d/013/feb/f3d013feb5e2960574d69d66fa610a7a.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e87/867/c8b/e87867c8bdc823d7f4551bdfbf431eae.png"><br><br>  Outside the processor core, the HR5000 has an interrupt controller, a UART module, a direct memory access controller, timers, and a PCI controller: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/172/8c3/b43/1728c3b431ac6ddb63bcbc7f38bf847b.png"><br><br>  To work in space, the chip must be protected from radiation.  I am not an expert in radiation protection, for this there is <a href="https://habr.com/ru/users/amartology/" class="user_link">amartology</a> on Habr√©, but I know that such protection can be done both at the level of physical production technology, and at the level of various ECC checks, and even at the level of architecture, with triplication, etc.  The creators of the HR5000 on-chip system decided to use the usual RTL2GDSII route adopted in commercial applications, the synthesis of a graph from logical elements from the code in the Verilog hardware description language.  However, after receiving such a graph (netlist), they modify it with the help of a special hardness-by-design (HBD) primitive library (never used this, so any explanation in the comments is welcome): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/142/c66/1f0/142c661f0bfe8b1237c9e33a968887f8.png"><br><br>  Since MIPS 5Kf is written in Verilog, it can be turned not only into a netlist, and not only into a mask for the production of a chip at a factory, but also into a FPGA configuration.  Unfortunately, the MIPS 5Kf sources are not in open access, but in open access are the sources of a descendant of its ‚Äúyounger brother‚Äù, a 32-bit MIPS 4K processor.  This ‚Äúdescendant‚Äù is called MIPS microAptiv UP, and its basic configuration is included in the MIPSfpga package.  The MIPS 4K / 4KEc / microAptiv UP / M5150 code (these are all progressive versions of the line) was also written by Larry, Ryan and Darren. <br><br>  You can play with the pipeline, caches, memory management device and interrupt the kernel MIPS microAptiv UP, run it on the simulator or the board with FPGA / FPGA.  To do this, just download the <a href="https://www.mipsopen.com/mips-open-components/mips-open-fpga-getting-started-guide/">MIPS Open ‚Ñ¢ FPGA Getting Started Package</a> , along with <a href="https://www.mipsopen.com/mips-open-components/mips-open-fpga-labs/">MIPS Open ‚Ñ¢ FPGA Labs</a> , and (this is important!) <a href="https://github.com/MIPSfpga/mipsfpga-plus">Add</a> it to the <a href="https://github.com/MIPSfpga/mipsfpga-plus">MIPSfpga +</a> .  In the latter there are <a href="https://github.com/MIPSfpga/mipsfpga-plus/tree/master/documentation/html_labs">labs about the pipeline, cache and memory management device</a> . <br><br>  You can synthesize and run a MIPS microAptiv UP processor on a low-cost $ 85 motherboard (academic price is $ 55): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a20/82b/988/a2082b988e8b633dac41bbc31659326d.jpg"><br><br>  To work with the MIPSfpga / MIPSfpga + package, you need knowledge of the Verilog hardware description language, design principles at the register transfer level, and the ability to write in MIPS assembler. <br><br>  MIPS assembler is the easiest to learn.  For this you can <a href="http://courses.missouristate.edu/KenVollmar/MARS/">download the MARS simulator (MIPS Assembler and Runtime Simulator)</a> .  You can learn to use it in 5 minutes, in fact there are three buttons in it - to assemble, run, run in steps: <br><br><img width="800" src="https://habrastorage.org/getpro/habr/post_images/159/348/2f7/1593482f7897e6462c5b6ebe7455b3cd.png"><br><br>  Then you can spend the day practicing writing in assembly language from <a href="http://www.mips.com/downloads/digital-design-and-computer-architecture-russian-edition-second-edition-ver3">Harris &amp; Harris</a> and <a href="https://www.dropbox.com/s/dbdlz3qsgsfe23z/Sweetman%2520D.See%2520MIPS%2520run%2520Linux.2007.pdf%3Fdl%3D0">See MIPS Run Linux</a> books. <br><br>  If you do not know anything at all about the development of digital circuits in general and in the hardware description language in particular, you can start with the Rosnan online course for schoolchildren, in three parts: <a href="https://stemford.org/">‚ÄúFrom the transistor to a chip‚Äù</a> , <a href="https://stemford.org/">‚ÄúThe logical side of digital circuitry‚Äù</a> , <a href="https://stemford.org/">‚ÄúThe physical side digital circuitry "</a> ).  Then you can study Verilog on X &amp; X and understand that there is a processor using a simplified processor <a href="https://github.com/MIPSfpga/schoolMIPS">schoolMIPS</a> . <br><br>  If you are interested in this topic and want to participate in the work on the <a href="https://mipsopen.com/">MIPS Open</a> (as part of which the core of MIPS microAptiv UP was open), write in the comments.  Rosnanovtsy also conduct a <a href="http://bit.ly/nanochip-2019">seminar for schoolchildren on digital design on April 17-19</a> , which will also include this space processor.  Hayabusa-2 bombarded Ryugu for good reason - this is also an occasion for Russian schoolchildren and students to find out what is inside her. </div><p>Source: <a href="https://habr.com/ru/post/447324/">https://habr.com/ru/post/447324/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447308/index.html">Instant design</a></li>
<li><a href="../447310/index.html">How do we go from web development to game development</a></li>
<li><a href="../447314/index.html">What I understood about building a business, having worked for seven years at Airbnb</a></li>
<li><a href="../447318/index.html">Flea Gadgets: Why Buy a Packard Bell 20-Year Laptop for 10 Euros</a></li>
<li><a href="../447322/index.html">Principles of building a REST JSON API</a></li>
<li><a href="../447326/index.html">Fractals in irrational numbers. Part 2</a></li>
<li><a href="../447328/index.html">Habro suicide. Pain planning in 1C</a></li>
<li><a href="../447330/index.html">It was evening, there was nothing to do, or how to install Gentoo without a keyboard</a></li>
<li><a href="../447334/index.html">An example of a content strategy for promoting an online gun parts store</a></li>
<li><a href="../447336/index.html">Monitor Kubernetes cluster resources</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>