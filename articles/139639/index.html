<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to run Truckers 2 under Wine, patch ddraw.c</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am an ardent fan of the game "Truckers-2", but unfortunately, I could not run them under Linux. I tried to make the game work for several years (thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to run Truckers 2 under Wine, patch ddraw.c</h1><div class="post__text post__text-html js-mediator-article">  I am an ardent fan of the game "Truckers-2", but unfortunately, I could not run them under Linux.  I tried to make the game work for several years (this does not mean that I was sitting all day long over it) with varying success.  I tried different versions of wine, picked the settings, but the game did not yield.  Once I had some free time, and I decided to figure out why the Truckers didn‚Äôt run under Wine, although they worked fine under Cedega.  Next, I will tell you how I managed it. <a name="habracut"></a><br><br><h4>  Attempt number 0. We tighten the config </h4><br>  At first I took the path of least resistance: try setting up the game itself.  I partially succeeded.  To start, you need to edit the TRUCK.INI file, namely the <b>DRV</b> section, and set the correct settings for the video adapter in it.  I once managed to find the TRUCK.INI file with the correct settings and the game started, but when I sat down to write this article, I could not reproduce the launch of the game with the "correct" TRUCK.INI on unpatched wine.  We consider this method unreliable. <br><br><h4>  Attempt number 1. Choose a version of wine </h4><br>  I tried several versions that I had on hand (including the latest from git).  None of them started the game on the ‚Äúclean settings‚Äù.  Therefore, it was decided to take the source code of the latest stable version.  At the time of this writing, it was a version of <i>wine-1.2.3</i> .  Then I conducted all the experiments on this version of wine. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Game log analysis </h5><br>  When I start the game on a "pure" wine, it shows me the starting splash-screen, after which it opens the window several times and turns off without any message.  After such a launch, I looked into the folder with the game and saw the <b>warn.log</b> file with the following contents: <br> <code>warning : fail in SetCoop... One or more of the parameters passed to the method are incorrect. (unknown) 0 <br> warning : DirectDraw4/7 not found 0 <br> warning : <br> <br> (09-03-12 11:09) <br>  ,      <br> (fail in SetCoop... One or more of the parameters passed to the method are incorrect. (unknown)(null)) <br> 0 <br></code> <br>  This log gave me the first hint: the DirectDraw subsystem is incorrectly initialized.  I hadn‚Äôt dealt with directdraw before, so this record helped me a little, however it was the first clue.  Google on the query "directdraw SetCoop" gave me information about the function SetCooperativeLevel.  I did not go into the description of this function, instead I decided to go a different way (but I‚Äôll return to this function). <br><br><h5>  We go deep into the theory.  Wine logging features </h5><br>  I went to the office.  wine site and started looking for information on how to make wine give me a message about all the errors that occur when you start the application.  All information is located at <a href="http://www.winehq.org/developer-cheatsheet">www.winehq.org/developer-cheatsheet</a> .  I would like to say that the logging capabilities of wine are very rich, and allow you to receive various information about the program being started (you can even trace the chain of calls to all WinAPI functions with all input and output parameters). <br>  So, run the wine and remove the logs: <br>  At first I launched without parameters: <code>wine king &gt; wine.dbg 2&gt;&amp;1</code> .  Received at the exit <br> <code>fixme:win:EnumDisplayDevicesW ((null),0,0x32f110,0x00000000), stub! <br> fixme:win:EnumDisplayDevicesW ((null),0,0x32f424,0x00000000), stub! <br></code> <br>  There is nothing interesting here. <br><h6>  A small digression: description of the logging subsystem in wine </h6><br><ul><li>  In wine, there are several classes (although I‚Äôm used to the word level) logging is FIXME, ERR, WARN, TRACE, MESSAGE.  They are responsible for the importance of the message and its type. </li><li>  Also in wine there are debugging channels, they are responsible for one or another subsystem within wine.  For example, <b>reg</b> is responsible for the registry subsystem, etc. </li><li>  Logging is controlled by the environment variable WINEDEBUG.  For example, I ran with the following arguments: <b>WINEDEBUG = warn + all, trace + all</b> </li></ul><br>  So, back to our task.  After exploring the possibilities of logging, I started to run the game with different logging parameters, stopped at the above. <br>  After launch, I received a 40 megabyte log.  It is clear that manually find something in it is unrealistic.  At first, I filtered it by <b>ERR</b> class, but I didn‚Äôt find anything interesting there.  Then I decided to return to the message from warn.log, and filtered it by <b>SetCoop</b> : <br> <code>cat wine.dbg | grep SetCoop <br> 0009:trace:ddraw:IDirectDrawImpl_SetCooperativeLevel (0x15ae78)-&gt;(0x40066,0000105b) <br> <b>0009:trace:ddraw:IDirectDrawImpl_SetCooperativeLevel (0x15ae78) DDSCL_NORMAL is not compative with DDSCL_FULLSCREEN or DDSCL_EXCLUSIVE</b> <br> 0009:trace:ddraw:IDirectDrawImpl_SetCooperativeLevel (0x15ae78)-&gt;(0x40066,00000008) <br> 0009:trace:ddraw:IDirectDrawImpl_SetCooperativeLevel SetCooperativeLevel retuning DD_OK <br> 0009:trace:ddraw:IDirectDrawImpl_SetCooperativeLevel (0x15ae78)-&gt;(0x40066,00000008) <br> 0009:trace:ddraw:IDirectDrawImpl_SetCooperativeLevel SetCooperativeLevel retuning DD_OK <br> 0009:trace:ddraw:IDirectDrawImpl_SetCooperativeLevel (0x15ae78)-&gt;((nil),00000008) <br> 0009:trace:ddraw:IDirectDrawImpl_SetCooperativeLevel SetCooperativeLevel retuning DD_OK <br> 0009:trace:ddraw:IDirectDrawImpl_SetCooperativeLevel (0x160420)-&gt;(0x40066,0000105b) <br> 0009:trace:ddraw:IDirectDrawImpl_SetCooperativeLevel (0x160420) DDSCL_NORMAL is not compative with DDSCL_FULLSCREEN or DDSCL_EXCLUSIVE <br> 0009:trace:ddraw:IDirectDrawImpl_SetCooperativeLevel (0x160420)-&gt;(0x40066,00000008) <br> 0009:trace:ddraw:IDirectDrawImpl_SetCooperativeLevel SetCooperativeLevel retuning DD_OK <br> 0009:trace:ddraw:IDirectDrawImpl_SetCooperativeLevel (0x160420)-&gt;((nil),00000008) <br> 0009:trace:ddraw:IDirectDrawImpl_SetCooperativeLevel SetCooperativeLevel retuning DD_OK <br></code> <br><br>  Here are more interesting data.  We see that incompatible parameters were passed to the SetCooperativeLevel function, this is already something.  If we look at the previous lines in the log, we will see all the parameters that are passed to the function: <code>0009:trace:ddraw:DDRAW_dump_cooperativelevel - DDSCL_FULLSCREEN DDSCL_ALLOWREBOOT DDSCL_NORMAL DDSCL_ALLOWMODEX DDSCL_EXCLUSIVE <br></code> <code>0009:trace:ddraw:DDRAW_dump_cooperativelevel - DDSCL_FULLSCREEN DDSCL_ALLOWREBOOT DDSCL_NORMAL DDSCL_ALLOWMODEX DDSCL_EXCLUSIVE <br></code> <br>  Description of all parameters can be found in MSDN <br><br><h4>  Source Code Analysis </h4><br>  Next, I moved on to analyzing the source code and documentation for the SetCooperativeLevel function. <br>  Finding the desired function in wine is easy; it is in% SRC_ROOT% / dlls / ddraw / ddraw.c.  The function is called <b>IDirectDrawImpl_SetCooperativeLevel</b> . <br><br>  Open MSDN and find the description on the function <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/gg426155(v%3Dvs.85).aspx">SetCooperativeLevel</a> and see: <br> <code><b>DDSCL_NORMAL</b> <br> The application functions as a typical Windows application. This flag cannot be used with the DDSCL_ALLOWMODEX, DDSCL_EXCLUSIVE, or DDSCL_FULLSCREEN flags</code> <br>  That is, this means that these flags can not be together. <br><br>  It should be noted that the implementation of wine fully complies with the documentation and gives the error code DDERR_INVALIDPARAMS in this case.  I decided for the test to try to remove the check for a specific combination of flags: <br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">/* DDSCL_NORMAL or DDSCL_FULLSCREEN | DDSCL_EXCLUSIVE */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(cooplevel &amp; DDSCL_NORMAL) { <span class="hljs-comment"><span class="hljs-comment">/* Can't coexist with fullscreen or exclusive */</span></span> <span class="hljs-comment"><span class="hljs-comment">/** @note commented for test only if(cooplevel &amp; (DDSCL_FULLSCREEN | DDSCL_EXCLUSIVE) ) { TRACE("(%p) DDSCL_NORMAL is not compative with DDSCL_FULLSCREEN or DDSCL_EXCLUSIVE\n", This); LeaveCriticalSection(&amp;ddraw_cs); return DDERR_INVALIDPARAMS; } */</span></span></code> </pre> <br><br>  Compile and install wine, run Truckers and ... <br>  Loaded familiar game menu, victory!  We try to create a game, the game is created and I can ride on my favorite truck Zil! <br><br><h4>  Improvements in the study </h4><br>  Having done so much on the virtual map, I decided that the game works quite stably and that means it's time to issue our results in the form of a patch and create an application in the wine bug tracker. <br><br>  In order to fully understand this function, I decided to write a test program for win32 that would give an error code depending on the combination of the DDSCL_ * flags and I saw that the SetCooperativeLevel function returns a specific combination of flags (which is used by the ‚ÄúLong-haul truckers‚Äù), then there is success.  <i>It is also worth noting that this function returns DD_OK much more often than described in MSDN</i> .  It is possible that the game developers did not take into account the difference in the description and in the implementation of this function and used flags that are prohibited in the documentation. <br>  I created an <a href="http://bugs.winehq.org/show_bug.cgi%3Fid%3D30117">application</a> , attached a log and a patch to it. <br>  In fact, the patch is very simple, I just commented on checking for prohibited flags (as in the example above), but this function is used in many applications, so it is necessary to conduct a more detailed analysis.  To do this, I attached to the application program for win32, which goes through all possible combinations of flags and gives the appropriate error codes. <br><br>  PS Checked on the version of wine-1.4 everything works fine. <br>  In this version of SetCooperativeLevel has been significantly reworked, and now the behavior of this function is close to the actual implementation in win32.  I closed the corresponding application in wine.  Thank you all for the comments. </div><p>Source: <a href="https://habr.com/ru/post/139639/">https://habr.com/ru/post/139639/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139633/index.html">New game controller will add interactivity in the game</a></li>
<li><a href="../139634/index.html">YiiConf 2012, Kiev</a></li>
<li><a href="../139636/index.html">MODx Evolution CMS 1.0.6 release</a></li>
<li><a href="../139637/index.html">Drag and drop images from the browser to a folder on the disk</a></li>
<li><a href="../139638/index.html">For the rest of us</a></li>
<li><a href="../139640/index.html">Changes in the dropbox web interface</a></li>
<li><a href="../139641/index.html">OpenStreetMap News ‚Ññ14: Apple and geokeshery also leave Google Maps, monitoring of transport in St. Petersburg - on OSM, and our Linux users continue to ignore this success of freedom</a></li>
<li><a href="../139642/index.html">Max Skibinsky, entrepreneur, angel investor and business mentor</a></li>
<li><a href="../139643/index.html">New aggregation framework in MongoDB 2.1</a></li>
<li><a href="../139645/index.html">Free tickets to developers on Yandex Mobile Camp</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>