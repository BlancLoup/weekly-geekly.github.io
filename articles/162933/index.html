<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>More rootkits are ‚Äúgood‚Äù and different. Part I</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes the differences in the style of writing and the applied principles of the malicious software significantly differs from sample to sample. So...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>More rootkits are ‚Äúgood‚Äù and different. Part I</h1><div class="post__text post__text-html js-mediator-article">  Sometimes the differences in the style of writing and the applied principles of the malicious software significantly differs from sample to sample.  Some rely on polymorphism, others on the <a href="http://u.wikipedia.org/wiki/%25D0%25A0%25D1%2583%25D1%2582%25D0%25BA%25D0%25B8%25D1%2582">rootkit</a> component.  Especially in terms of the development of the rootkit technology, the TDL TDV family (also called TDSS, Alureon, Olmarik, Tidserv) has distinguished itself.  As you know, the new is a well forgotten old.  At the dawn of personal computer development, the bulk of malware was viruses, which were divided into two classes ‚Äî file and boot (there were also combined, for example, the infamous <a href="http://ru.wikipedia.org/wiki/OneHalf">OneHalf</a> ).  The TDL-4 <a href="http://ru.wikipedia.org/wiki/%25D0%2591%25D1%2583%25D1%2582%25D0%25BA%25D0%25B8%25D1%2582">bootkit</a> is a worthy successor to boot viruses, although it is a Trojan program (unable to spread on its own).  A bootkit is a word formed from the words boot (boot, boot area) and rootkit (rootkit, means of hiding signs of activity).  But before becoming a bootkit, TDL has come a long way. <a name="habracut"></a><br><br><h4>  TDL-1 </h4><br>  One of the first versions of the rootkit was discovered by Kaspersky Lab in April 2008, it kept its tdsserv.sys driver in the system, from which the TDSS name came.  Subsequently, the name of the main driver was changed several times to clbdriver.sys, seneka * .sys, UACd * .sys, gaopdx * .sys, tdlserv.sys and others. <br>  The alternative TDL name was due to the presence of multiple identifiers in the code, starting with the characters 'tdl'.  The TDL-1 dropper contained two main files: the driver-rootkit itself and the library in which the main functionality (payload) was located.  At that time, methods for intercepting functions were quite trivial and did not differ in innovation, but allowed to bypass most of the anti-virus protection. <br>  The main functions of masking, implemented by the driver: <br><br><ul><li>  hiding registry keys; </li><li>  hiding files on the disk; </li><li>  introduction of malicious code into system processes from the kernel mode driver; </li><li>  hiding TCP network ports; </li><li>  hiding loaded DLL libraries. </li></ul><br>  The driver is also able to perform several other functions aimed at actively counteracting antivirus: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  destroy the flow; </li><li>  block the execution of a thread; </li><li>  destroy the current process; </li><li>  get the name of the current process; </li><li>  unload the driver; </li><li>  get a list of running processes. </li></ul><br>  When installing the rootkit, the following technique was used to bypass the behavioral protection: the malicious code is placed in the system cache of frequently used \ KnownDLLS libraries, from where it is called by the legitimate system application when it uses one of these libraries.  Specifically, TDL-1 was used to patch the advapi32.dll library, loaded by the Microsoft Installer service, during the installation.  Newer versions used the msi.dll patching library.  Thus, the call to the TDL-1 code was made from the context of the trusted application.  More information about the methods used by TDL-1 can be found in the <a href="http://www.nobunkum.ru/ru/tdss-analysis">post of</a> Alice Shevchenko. <br><br><h4>  TDL-2 </h4><br>  The installation took place according to a similar first version of the TDL method, while the msvcrt.dll library was patched.  To make it more difficult for driver-rootkits to detect, obfuscation and encryption mechanisms have been used.  In particular, the binary code was ‚Äúdiluted‚Äù with random words from the work of ‚ÄúHamlet‚Äù by William Shakespeare.  Compared to the first version, the rootkit has changed little functionally, however, the concealment and protection methods have changed, which is probably due to the previous version getting into the anti-virus database. <br><br><h4>  TDL-3 </h4><br>  In the fall of 2009, a third version appeared, containing many technical innovations.  The crawl technique has changed, now it was the DLL hijacking method, its essence - the OS first searches for the necessary dll in the current directory, and then in the system directory, therefore, by placing a malicious library in the directory of a legitimate program with the name of one of the imported libraries, you can running a malicious code.  TDL-3 copied itself as a library into the print processor directory, and then accessed it.  This led to the execution of malicious code in the context of a system process. <br>  To gain control after a reboot, the method used to infect OS system components (drivers) was used.  For infection, a mini-port / port disk driver, atapi.sys, was used; in later versions, TDL-3 randomly selected and infected system drivers suitable for some parameters.  Atapi.sys driver was injected with a small section of 824 bytes of malicious code (917 bytes for variants with random drivers), which served as a loader, while the original size of the driver remained unchanged.  The original data that was replaced was stored together with the main code in a dedicated place at the end of the hard disk.  The last several disk sectors were organized into a kind of encrypted data storage with its own file system, and a virtual device was created to work with it.  This storage also contained configuration data blocks.  TDL-3 intercepted calls to the disk and, in the case of viewing its "personal" sectors, returned their contents as a data block filled with zeros.  The configuration data block (config.ini) is unchanged for all three versions, it contained the following data: <br><br>  <i>[main] - identification data</i> <i><br></i>  <i>Quote - quotes from movies, cartoons, etc., which are displayed when the debugger is connected;</i> <i><br></i>  <i>Version - version;</i> <i><br></i>  <i>Botid - bot ID for the admin panel;</i> <i><br></i>  <i>AffId - ID of the "affiliate program";</i> <i><br></i>  <i>SubId - is used to identify the bot network when a botnet is divided into several subnets;</i> <i><br></i>  <i>Installdate - installation date in the system;</i> <i><br></i>  <i>Builddate - the date of compilation.</i> <i><br></i>  <i>[injector] - mapping of implemented modules and processes</i> <i><br></i>  <i>contains a list of value pairs: process name (by default ‚Äú*‚Äù, means all processes) - the name of the DLL (dynamic library that should be loaded to the specified process).</i> <i><br></i>  <i>[tdlcmd] - server data</i> <i><br></i>  <i>Servers - addresses of rootkit administrative panels, usually three addresses;</i> <i><br></i>  <i>Wspservers - addresses of servers for work with search services;</i> <i><br></i>  <i>Popupservers - server addresses for opening pages;</i> <i><br></i>  <i>Version - payload version.</i> <br><br>  TDL was distributed using so-called ‚Äúaffiliate programs‚Äù or ‚Äúaffiliate programs‚Äù.  According to <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B0%25D1%2580%25D1%2582%25D0%25BD%25D1%2591%25D1%2580%25D1%2581%25D0%25BA%25D0%25B0%25D1%258F_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B0">Wikipedia</a> , ‚Äúaffiliate programs are a form of business cooperation between a seller and partners when selling a product or providing services;  allows the seller to reduce the cost of attracting the end buyer. "  In the field of cybercrime, malware is a commodity, and the services are attracting users to infected web resources and infecting their computers.  Money is paid for each successful installation.  This is exactly what the AffId field in config.ini is used for, in order to know to whom in what amount to pay money for installing a bot with a given identifier.  It also allows you to evaluate the performance of a particular "affiliate".  For assistance in distributing TDL, affiliate program owners receive from 1,000 installations of malware from 20 to 200 USD - depending on the geographic location of the victim computer.  The final installation could be done in various ways, for example, by installing fake codecs, by introducing a bot into keygens for popular software, or by <a href="http://ru.und3rgr0und.org/wiki/%25D0%25A1%25D0%25B2%25D1%258F%25D0%25B7%25D0%25BA%25D0%25B0_%25D1%258D%25D0%25BA%25D1%2581%25D0%25BF%25D0%25BB%25D0%25BE%25D0%25B9%25D1%2582%25D0%25BE%25D0%25B2">distributing exploits</a> via exploit packs. <br><br>  Data exchange with the TDL control server was carried out using the HTTPS protocol, for this purpose, the attackers used a self-signed security certificate (which was located on the server) issued by the fictitious company Internet Widgits Pty Ltd.  The use of HTTPS did not allow antivirus to detect and block network traffic on the contents of packages.  In addition, in TDL-3 GET, requests were additionally encrypted using the RC4 symmetric algorithm. <br><br>  The main goal of TDL is to monetize, based on the botnet created with it.  TDL had a modular structure and allowed loading additional modules (as a DLL) over the network.  One of the modules installed by TDL by default was tdlcmd.dll, which performs the following tasks: <br><br><ul><li>  receiving and executing commands from the control center; </li><li>  interception of user requests to search engines in order to spoof the issue; </li><li>  Creation of specified queries to search engines; </li><li>  Emulation of user experience with the site. </li></ul><br>  List of commands supported by tldcmd.dll: <br><br><ul><li>  DownloadCrypted - download an encrypted file; </li><li>  DownloadAndExecute - download and execute the file; </li><li>  DownloadCryptedAndExecute - download an encrypted file, decrypt and execute it; </li><li>  Download - download file; </li><li>  ConfigWrite - make changes to the configuration file. </li></ul><br>  Interception of user requests for the purpose of spoofing the output was made for popular search engines such as Google, Yahoo, Bing, etc. With each request to such sites tdlcmd.dll generates a request to the server specified in the Wspservers field of the configuration file.  In response from the server comes a link to the page that you want to display to the user.  A link can lead either to a malicious site (for example, to install another malware) or to a legitimate site (banner wrapping). <br><br>  An interesting feature is tdlcmd.dll - a mechanism for unfair "promotion" of sites by keywords (Black Seo).  For his work in the TDK repository, a keywords file is created containing words that need to be addressed to the search engine.  Then, in the search results, the site chosen by the attackers is selected.  At the same time, to convincingly simulate the user's work, JavaScript was used, embedded in the browser and imitating clicking on the corresponding controls (buttons, links, etc.). <br><br>  Another way to monetize was the sale of part of a botnet, for this purpose in the config.ini was the parameter SubId.  Subnets of a botnet of up to 20,000 computers were subject to sale.  Otherwise, TDL creators conducted their criminal business themselves. <br><br>  In February 2010, an unplanned update from Microsoft MS10-015 was released.  This patch eliminated a vulnerability that allows you to locally enhance your privileges, and made modifications directly to the OS kernel.  After this patch, some users began to complain about the appearance of BSOD.  Later it turned out that the indicated computers were infected with TDL-3 and the BSOD caused its incorrect loading.  This is due to the use of implicit calls to WinAPI functions by shifting them in memory, modifications occurred during the update, as a result, the addresses of the functions became different, and the TDL-3 code stopped working as intended.  Because of this developer error, the number of the botnet was significantly reduced, especially in the United States, where the majority of users use licensed Windows with the update mechanism enabled ( <a href="http://habrahabr.ru/company/eset/blog/84957">source</a> ).  The developers quickly responded with the release of TDL version 3.26.  Now, instead of infecting a previously known driver, the rootkit infected a random driver, and the search for addresses of kernel functions used in this code was carried out using checksums calculated from their names.  Encryption storage has changed to a simpler one, using single-byte XOR operation and increasing the value of this byte, the initial value 0x54 ( <a href="http://www.securitylab.ru/analytics/393943.php">source</a> ). <br><br>  Despite some tricks to protect against loss of control, the command center scripts contained vulnerabilities that allowed some computer security researchers to successfully crack.  Details of one of them are available <a href="http://www.nobunkum.ru/ru/tdss-botnet">here</a> .  According to the information obtained from the databases of the hacked server, the total number of computers infected with the TDL-3 rootkit from 12.08.2009 to 14.07.2010 amounted to more than 16,000,000 computers.  Naturally, this is the total.  In reality, the ‚Äúlive‚Äù bots were of the order of 5,000,000. A larger number of them (43%) were in the USA.  This can be explained by the greater monetary return from banner cheating in this country. <br><br>  Continued <a href="http://habrahabr.ru/post/163089/">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/162933/">https://habr.com/ru/post/162933/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../162919/index.html">"I do not understand"</a></li>
<li><a href="../162921/index.html">TVs. Part 2. Plasma or LCD, chassis, diagonal, motion transmission, color, effect on vision</a></li>
<li><a href="../162923/index.html">Do you use tabindex in form layout?</a></li>
<li><a href="../162929/index.html">Has the pigeon message been deciphered?</a></li>
<li><a href="../162931/index.html">W3C announced the completion of work on the specifications of HTML 5 and Canvas 2D, as well as the beginning of work on HTML 5.1</a></li>
<li><a href="../162937/index.html">BM25 algorithm</a></li>
<li><a href="../162939/index.html">Opera: How do 196M users use mobile internet? Traffic, and most popular sites in European countries</a></li>
<li><a href="../162943/index.html">Dji - Death fails. The prequel to the cartoon Roma (Making off)</a></li>
<li><a href="../162945/index.html">NASA bombs the moon online</a></li>
<li><a href="../162947/index.html">"Problem 2000" in WebMoney WMClasses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>