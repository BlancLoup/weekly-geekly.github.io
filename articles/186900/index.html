<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Office PBX - The Devil in the details</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About a year ago I had to face a new task for myself - automation of PBX control. At first glance, there is nothing difficult in it: you need to conne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Office PBX - The Devil in the details</h1><div class="post__text post__text-html js-mediator-article">  About a year ago I had to face a new task for myself - automation of <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B2%25D1%2582%25D0%25BE%25D0%25BC%25D0%25B0%25D1%2582%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B0%25D1%258F_%25D1%2582%25D0%25B5%25D0%25BB%25D0%25B5%25D1%2584%25D0%25BE%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D1%2586%25D0%25B8%25D1%258F">PBX</a> control.  At first glance, there is nothing difficult in it: you need to connect to the controlling port of the PBX via a TCP or Serial interface, send a command and analyze the response.  As it turned out in the process, this simplicity was deceptive. <br><br>  In my article I want to talk about the difficulties that I had to face in the process.  It is unlikely that this article will be of interest to a wide circle of readers, but perhaps specialists in the field of telephony will find in it something useful for themselves.  As an illustrative material, I will use examples of <a href="http://de.wikipedia.org/wiki/Alcatel_S12">Alcatel S12</a> and <a href="http://www.m-200.com/base/index.php/%25D0%2593%25D0%25BB%25D0%25B0%25D0%25B2%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2581%25D1%2582%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B8%25D1%2586%25D0%25B0">M200</a> PBX commands supported by the project at present. <br><a name="habracut"></a><br><h1>  1. Glossary </h1><br>  For starters, you should decide on the terminology. <br><br><h2>  1.1 Tasks </h2><br>  <b>A task</b> is a set of actions performed atomically.  From the point of view of the equipment management subsystem, the task consists of a set of <b>services</b> .  Each service controls subscriber's access to a particular service (for example, you can select access services to long-distance and international communications). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When performing a task, individual services can be turned on or off.  In addition, for a number of services, the values ‚Äã‚Äãof configuration <b>parameters</b> (for example, such as the alarm time or PIN value) can be set.  Boolean values ‚Äã‚Äãthat determine the status of connecting or disconnecting a service are also considered as parameters. <br><br>  From the point of view of equipment, the process of connecting or disconnecting a service is reduced to the execution of one or more <b>commands</b> .  The process of executing commands on the equipment will be called <b>activation</b> . <br><br><h2>  1.2 Specifications </h2><br>  <b>Specifications</b> control the work of a specialized <a href="http://ru.wikipedia.org/wiki/ORM">ORM</a> , designed to integrate an application with the <a href="http://en.wikipedia.org/wiki/Order_management_system">Order Management</a> subsystem, which controls the execution of tasks.  I will not delve into this topic, since it is not related to issues of specificity of interaction with PBX.  To understand the subsequent presentation, it is enough to know that this layer provides read and write access to the named <b>variables</b> containing the values ‚Äã‚Äãloaded from the database. <br><br>  In addition to accessing scalar values, access to tuple collections is provided.  For example, by opening a collection represented by the name 'tk' (Tech. Card), you can access records containing data from technical cards, such as 'tk.phone' - the subscriber‚Äôs phone or 'tk.ats_type' - the type of PBX.  In turn, these records may contain links to other collections.  Nesting of collections is not limited. <br><br>  Of all the above, it is perhaps not very clear why the term specification is used?  The fact is that during the development of this layer, <a href="http://ru.wikipedia.org/wiki/SID_%2528%25D1%258D%25D0%25BB%25D0%25B5%25D0%25BA%25D1%2582%25D1%2580%25D0%25BE%25D1%2581%25D0%25B2%25D1%258F%25D0%25B7%25D1%258C%2529">SID</a> concepts such as the Specification and Policy were actively used, which, from my point of view, greatly simplified the development.  In general, I strongly recommend that you familiarize yourself with the materials of the <a href="http://ru.wikipedia.org/wiki/TM_Forum">TM Forum</a> , and to all who have such an opportunity. <br><br><h2>  1.3 Scripts </h2><br>  I already described this subsystem <a href="http://habrahabr.ru/post/162865/">earlier</a> .  Initially, the script performed two tasks: it described the order of command execution as part of the work order and hid in itself platform-specific features.  The script accessed the variables provided by the specifications and formed the commands, depending on the type of PBX.  Here's what it looked like: <br><br><div class="spoiler">  <b class="spoiler_title">Fragment of the script of the first version</b> <div class="spoiler_text"><pre><code class="hljs mel">... [<span class="hljs-number"><span class="hljs-number">002082</span></span>] platform:M<span class="hljs-number"><span class="hljs-number">-200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tk.attach.service = <span class="hljs-string"><span class="hljs-string">'SET_HOLD'</span></span>) { [<span class="hljs-number"><span class="hljs-number">020820</span></span>] &lt; <span class="hljs-keyword"><span class="hljs-keyword">text</span></span>:settune %s enb_flash=on; var_list:tk.phone; [<span class="hljs-number"><span class="hljs-number">001041</span></span>] &gt; is_error:<span class="hljs-number"><span class="hljs-number">1</span></span>; regexp:(.+); var_list:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>; [<span class="hljs-number"><span class="hljs-number">020821</span></span>] is_rollback:<span class="hljs-number"><span class="hljs-number">1</span></span>; { [<span class="hljs-number"><span class="hljs-number">001020</span></span>] &lt; device_id:tk.ats_id; [<span class="hljs-number"><span class="hljs-number">020822</span></span>] &lt; <span class="hljs-keyword"><span class="hljs-keyword">text</span></span>:settune %s enb_flash=off; var_list:tk.phone; [<span class="hljs-number"><span class="hljs-number">001041</span></span>] &gt; is_error:<span class="hljs-number"><span class="hljs-number">1</span></span>; regexp:(.+); var_list:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>; } } [<span class="hljs-number"><span class="hljs-number">003082</span></span>] platform:S<span class="hljs-number"><span class="hljs-number">-12</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tk.attach.service = <span class="hljs-string"><span class="hljs-string">'SET_HOLD'</span></span>) { [<span class="hljs-number"><span class="hljs-number">030820</span></span>] &lt; <span class="hljs-keyword"><span class="hljs-keyword">text</span></span>:MODIFY-SUBSCR:DN=K<span class="hljs-string"><span class="hljs-string">'%s,RECALL=ADD&amp;ECTRF.; var_list:tk.phone; [001041] &gt; is_error:1; regexp:(.+); var_list:error; [030821] is_rollback:1; { [001020] &lt; device_id:tk.ats_id; [030822] &lt; text:MODIFY-SUBSCR:DN=K'</span></span>%s,RECALL=REMOVE&amp;ECTRF.; var_list:tk.phone; [<span class="hljs-number"><span class="hljs-number">001041</span></span>] &gt; is_error:<span class="hljs-number"><span class="hljs-number">1</span></span>; regexp:(.+); var_list:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>; } } ...</code> </pre> </div></div><br>  From the above fragment, you can see that by analyzing the variable tk.attach.service, we determine which command should be executed.  Then, depending on the platform, by substituting the phone number from the variable tk.phone into the corresponding command pattern, a command is generated for execution on the hardware. <br><br>  Since there were quite a few different commands, the script was large (over 1000 lines) and obscure.  As a result, when developing the second version, it was decided to abandon the formation of separate commands in the script (transferring it to a lower level), transferring service codes instead of ready commands.  This decision is very beneficial effect on the size of the script.  Here‚Äôs what the whole version of the second script looks like: <br><br><div class="spoiler">  <b class="spoiler_title">Script of the second version</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml">[002000] { [200001] var_list:retry_cnt = retry_cnt + 1, state = 1; [200002] if (subtype = -1) { [200003] foreach (devices) { [200004] </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device_id:devices.ats_id</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device_ip:devices.ats_ip</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device_password:devices.ats_password</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device_port:devices.ats_tcp_port</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device_protocol:devices.ats_type</span></span></span></span><span class="xml"><span class="hljs-tag">; [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200005</span></span></span></span><span class="xml"><span class="hljs-tag">] &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device_id:devices.ats_id</span></span></span></span><span class="xml"><span class="hljs-tag">; [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200006</span></span></span></span><span class="xml"><span class="hljs-tag">] &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">text:ROLLBACK</span></span></span></span><span class="xml"><span class="hljs-tag">; [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200007</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:retry_cnt</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> } } [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200008</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">subtype</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1)</span></span></span></span><span class="xml"><span class="hljs-tag"> { [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200009</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">foreach</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk</span></span></span></span><span class="xml"><span class="hljs-tag">) { [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200010</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.phone</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">''</span></span></span></span><span class="xml"><span class="hljs-tag">) { [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200011</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:tk.phone</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">tk.phone_old;</span></span></span></span><span class="xml"><span class="hljs-tag"> } [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200012</span></span></span></span><span class="xml"><span class="hljs-tag">] &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device_id:tk.ats_id</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device_protocol:tk.ats_type</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device_ip:tk.ats_ip</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device_port:tk.ats_tcp_port</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device_password:tk.ats_password</span></span></span></span><span class="xml"><span class="hljs-tag">; [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200013</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:action</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">is_dou_activated</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200014</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">target:tk.ats_type</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">foreach</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.detach</span></span></span></span><span class="xml"><span class="hljs-tag">) { [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200015</span></span></span></span><span class="xml"><span class="hljs-tag">] &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device_id:tk.ats_id</span></span></span></span><span class="xml"><span class="hljs-tag">; [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200016</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:activate_command</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1;</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200017</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">platform:S-12</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.detach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'C_INTRAAREAL'</span></span></span></span><span class="xml"><span class="hljs-tag"> | </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.detach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'C_INTERCITY'</span></span></span></span><span class="xml"><span class="hljs-tag"> | </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.detach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'C_INTERNATIONAL'</span></span></span></span><span class="xml"><span class="hljs-tag">) { [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200018</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">is_dou_activated</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1)</span></span></span></span><span class="xml"><span class="hljs-tag"> { [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200019</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:activate_command</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> } [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200020</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:is_dou_activated</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1;</span></span></span></span><span class="xml"><span class="hljs-tag"> } [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200025</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">activate_command</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1)</span></span></span></span><span class="xml"><span class="hljs-tag"> { [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200026</span></span></span></span><span class="xml"><span class="hljs-tag">] &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">text:</span></span></span></span><span class="xml"><span class="hljs-tag">%</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:tk.detach.service</span></span></span></span><span class="xml"><span class="hljs-tag">; [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200027</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:retry_cnt</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> } } [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200028</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:action</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">is_dou_activated</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">is_cat_activated</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200029</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">target:tk.ats_type</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">foreach</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.attach</span></span></span></span><span class="xml"><span class="hljs-tag">) { [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200030</span></span></span></span><span class="xml"><span class="hljs-tag">] &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device_id:tk.ats_id</span></span></span></span><span class="xml"><span class="hljs-tag">; [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200031</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:activate_command</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1;</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200032</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">platform:S-12</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.attach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'C_INTRAAREAL'</span></span></span></span><span class="xml"><span class="hljs-tag"> | </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.attach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'C_INTERCITY'</span></span></span></span><span class="xml"><span class="hljs-tag"> | </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.attach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'C_INTERNATIONAL'</span></span></span></span><span class="xml"><span class="hljs-tag">) { [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200033</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">is_dou_activated</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1)</span></span></span></span><span class="xml"><span class="hljs-tag"> { [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200034</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:activate_command</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> } [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200035</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:is_dou_activated</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1;</span></span></span></span><span class="xml"><span class="hljs-tag"> } [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200021</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.attach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'CATEG_AON_0'</span></span></span></span><span class="xml"><span class="hljs-tag"> | </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.attach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'CATEG_AON_1'</span></span></span></span><span class="xml"><span class="hljs-tag"> | </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.attach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'CATEG_AON_2'</span></span></span></span><span class="xml"><span class="hljs-tag"> | </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.attach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'CATEG_AON_3'</span></span></span></span><span class="xml"><span class="hljs-tag"> | </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.attach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'CATEG_AON_4'</span></span></span></span><span class="xml"><span class="hljs-tag"> | </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.attach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'CATEG_AON_6'</span></span></span></span><span class="xml"><span class="hljs-tag"> | </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.attach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'CATEG_AON_7'</span></span></span></span><span class="xml"><span class="hljs-tag"> | &amp; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.attach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'CATEG_AON_8'</span></span></span></span><span class="xml"><span class="hljs-tag"> | </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tk.attach.service</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'CATEG_AON_9'</span></span></span></span><span class="xml"><span class="hljs-tag">) { [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200022</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">is_cat_activated</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1)</span></span></span></span><span class="xml"><span class="hljs-tag"> { [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200023</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:activate_command</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> } [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200024</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:is_cat_activated</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1;</span></span></span></span><span class="xml"><span class="hljs-tag"> } [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200036</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">activate_command</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">1)</span></span></span></span><span class="xml"><span class="hljs-tag"> { [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200037</span></span></span></span><span class="xml"><span class="hljs-tag">] &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">text:</span></span></span></span><span class="xml"><span class="hljs-tag">%</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:tk.attach.service</span></span></span></span><span class="xml"><span class="hljs-tag">; [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">200038</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">var_list:retry_cnt</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> } } } } }</span></span></span></span></code> </pre></div></div><br>  I will explain the logic of its execution in the subsequent sections, for the time being I will only say that now the script controls only the sequence of connecting and disconnecting services within the scope of the task.  We can still execute different code, depending on the type of equipment used, but now it is used only if the dependence on the platform matters in the performance of the task as a whole, and not individual commands. <br><br><h2>  1.4 Adapter </h2><br>  <b>An adapter</b> is a plug-in ( <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BB%25D0%25B0%25D0%25B3%25D0%25B8%25D0%25BD">plugin</a> ) that implements the logic of working with a specific type of equipment.  In the first version, the adapter received ready-made commands from the script and its role was to transfer these commands to the PBX using a TCP or Serial connection and process the received response.  In the current (second) version, the logic of forming a set of commands, when connecting or disconnecting a service, is transferred to the adapter.  The explanation of the reasons for which this was done is the subject of this article. <br><br><h2>  1.5 Synchronization </h2><br>  <b>Synchronization</b> we will call the process of obtaining current subscriber settings from equipment.  The problem of discrepancies in the data on the state of settings of subscribers on the PBX in relation to the database is fundamental for this class of tasks.  This problem is relevant not only for telephony.  In the previous activation project related to the management of <a href="http://www.cisco.com/">cisco</a> equipment, he was no less acute.  We can say that this article talks about how, using synchronization, to make the activation process more "smart". <br><br><h1>  2. Task Level </h1><br>  Obviously, to control various types of PBXs, completely different command systems are used, for example, the command is used to disable outgoing communications in PBX M-200: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">settune</span></span> XXXXXXX cmn_outcome=<span class="hljs-literal"><span class="hljs-literal">off</span></span></code> </pre><br>  and in the Alcatel S12: <br><br><pre> <code class="hljs scala"><span class="hljs-type"><span class="hljs-type">MODIFY</span></span>-<span class="hljs-type"><span class="hljs-type">SUBSCR</span></span>:<span class="hljs-type"><span class="hljs-type">DN</span></span>=<span class="hljs-type"><span class="hljs-type">K</span></span><span class="hljs-symbol"><span class="hljs-symbol">'XXXXXXX</span></span>,<span class="hljs-type"><span class="hljs-type">OCB</span></span>=<span class="hljs-type"><span class="hljs-type">REMOVE</span></span>&amp;<span class="hljs-type"><span class="hljs-type">TOTALBAR</span></span>.</code> </pre><br>  But such differences in command syntax are far from the only difficulty.  We will understand this issue in more detail. <br><br><h2>  2.1 Mapping services to teams </h2><br>  The first thing we face is that the possibilities for activating various services provided by different PBXs are also different.  Of course, there is some common set of services supported by most types of PBXs, such as outgoing call control, setting an alarm, dialing control, etc. <br><br>  At the same time, a significant part of teams that are interesting from a business point of view may not be implemented on a particular type of PBX (and the larger the set of PBX types supported, the more such teams).  This means that the service that is part of the task can not always be performed at the PBX where activation is performed.  An attempt to activate such a service may be considered as an error, or it may simply be ignored.  It is important that a mechanism should be implemented for displaying services used as part of service tasks implemented on supported PBX types. <br><br>  One job service can be displayed on several different services supported by PBXs.  For example, M-200 supports the following commands to enable a PIN: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">settune</span></span> XXXXXXX dvo_pincode=<span class="hljs-literal"><span class="hljs-literal">on</span></span> settune XXXXXXX dvo_pincodetwo=<span class="hljs-literal"><span class="hljs-literal">on</span></span></code> </pre><br>  The first includes the use of a PIN for long-distance and international calls, and the second for all outgoing calls.  In our case, one of the requirements of the Customer was that both of these services, at the task level, be mapped into one common 'PINCODE' service.  What kind of service will be performed is determined by the value of additional variables.  For Alcatel S12, only one PIN enable command is implemented: <br><br><pre> <code class="hljs scala"><span class="hljs-type"><span class="hljs-type">MODIFY</span></span>-<span class="hljs-type"><span class="hljs-type">SUBSCR</span></span>:<span class="hljs-type"><span class="hljs-type">DN</span></span>=<span class="hljs-type"><span class="hljs-type">K</span></span><span class="hljs-symbol"><span class="hljs-symbol">'XXXXXXX</span></span>,<span class="hljs-type"><span class="hljs-type">PASSWORD</span></span>=<span class="hljs-type"><span class="hljs-type">ADD</span></span>&amp;<span class="hljs-string"><span class="hljs-string">"YYYY"</span></span>,<span class="hljs-type"><span class="hljs-type">SUBCTRL</span></span>=<span class="hljs-type"><span class="hljs-type">ADD</span></span>&amp;<span class="hljs-type"><span class="hljs-type">OCBVAR</span></span>.</code> </pre><br>  Besides the fact that there is no division of this service into two types, it can be noted that this command not only includes the use of a PIN code, but also sets its value.  Of course, M-200 allows you to run, for example, the following command: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">settune</span></span> XXXXXXX dvo_pincode=<span class="hljs-literal"><span class="hljs-literal">on</span></span> pincode=YYYY</code> </pre><br>  But, in the process of introducing the first version of the activation module into commercial operation, it turned out that these commands are more convenient to activate separately.  In addition, it turned out that, in order for the PIN code to work, it is necessary to activate one more command.  Thus, for the M-200, the PIN installation command should result in the activation of three commands in the specified order: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">settune</span></span> XXXXXXX enb_pincode=<span class="hljs-literal"><span class="hljs-literal">on</span></span> settune XXXXXXX dvo_pincode=<span class="hljs-literal"><span class="hljs-literal">on</span></span> settune XXXXXXX pincode=YYYY</code> </pre><br>  Moreover, the enb_pincode command, which controls the use of a PIN code, can be executed separately (thus adding another display option for the 'PINCODE' service).  In this case, the PIN code can be set by the subscriber himself.  This leads to a rather non-trivial problem, which I will discuss below in the section "Problems associated with synchronization." <br><br><h2>  2.2 Restriction of outgoing communication </h2><br>  PBXs of different types can vary not only the set of supported services, but also how these services are implemented.  So for the M-200, access to intrazonal, long-distance, and international communications can be controlled separately: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">settune</span></span> XXXXXXX cmn_82xxx=<span class="hljs-literal"><span class="hljs-literal">on</span></span> settune XXXXXXX cmn_8xxx=<span class="hljs-literal"><span class="hljs-literal">on</span></span> settune XXXXXXX cmn_10xxx=<span class="hljs-literal"><span class="hljs-literal">on</span></span></code> </pre><br>  For the Alcatel S12, similar commands look like this: <br><br><pre> <code class="hljs scala"><span class="hljs-type"><span class="hljs-type">MODIFY</span></span>-<span class="hljs-type"><span class="hljs-type">SUBSCR</span></span>:<span class="hljs-type"><span class="hljs-type">DN</span></span>=<span class="hljs-type"><span class="hljs-type">K</span></span><span class="hljs-symbol"><span class="hljs-symbol">'XXXXXXX</span></span>,<span class="hljs-type"><span class="hljs-type">OCB</span></span>=<span class="hljs-type"><span class="hljs-type">MODIFY</span></span>&amp;<span class="hljs-type"><span class="hljs-type">PERM</span></span>&amp;<span class="hljs-number"><span class="hljs-number">5.</span></span> <span class="hljs-type"><span class="hljs-type">MODIFY</span></span>-<span class="hljs-type"><span class="hljs-type">SUBSCR</span></span>:<span class="hljs-type"><span class="hljs-type">DN</span></span>=<span class="hljs-type"><span class="hljs-type">K</span></span><span class="hljs-symbol"><span class="hljs-symbol">'XXXXXXX</span></span>,<span class="hljs-type"><span class="hljs-type">OCB</span></span>=<span class="hljs-type"><span class="hljs-type">MODIFY</span></span>&amp;<span class="hljs-type"><span class="hljs-type">PERM</span></span>&amp;<span class="hljs-number"><span class="hljs-number">4.</span></span> <span class="hljs-type"><span class="hljs-type">MODIFY</span></span>-<span class="hljs-type"><span class="hljs-type">SUBSCR</span></span>:<span class="hljs-type"><span class="hljs-type">DN</span></span>=<span class="hljs-type"><span class="hljs-type">K</span></span><span class="hljs-symbol"><span class="hljs-symbol">'XXXXXXX</span></span>,<span class="hljs-type"><span class="hljs-type">OCB</span></span>=<span class="hljs-type"><span class="hljs-type">REMOVE</span></span>.</code> </pre><br>  You may notice that these commands control the state of just one setting (when you turn on long-distance communication, the restrictions are simply removed).  This leads to the following problem: <br><br><ul><li>  For the M-200, the inclusion of intra-zone, long-distance, and international services should be activated independently (and are mapped to the corresponding assignment services) </li><li>  When activated, Alcatel S12 should activate only one of the included services, the least restricting access </li></ul><br>  This means that if we need to enable intra-zone and long-distance communications on the Alcatel S12, we should activate only the command to switch on long-distance communications.  If the command to enable intra-zone communication is subsequently activated, long-distance communication for the subscriber will be disabled!  Simultaneous activation of intrazonal and international communication, with disconnected long-distance communication, is impossible (unlike M-200). <br><br>  This is a good example of functionality implemented at the level of an activation script.  Let's see how this can be implemented: <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">200028</span></span>] var_list:action = <span class="hljs-number"><span class="hljs-number">1</span></span>, is_dou_activated = <span class="hljs-number"><span class="hljs-number">0</span></span>, is_cat_activated = <span class="hljs-number"><span class="hljs-number">0</span></span>; [<span class="hljs-number"><span class="hljs-number">200029</span></span>] target:tk.ats_type; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (tk.attach) { [<span class="hljs-number"><span class="hljs-number">200031</span></span>] var_list:activate_command = <span class="hljs-number"><span class="hljs-number">1</span></span>; [<span class="hljs-number"><span class="hljs-number">200032</span></span>] platform:S<span class="hljs-number"><span class="hljs-number">-12</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tk.attach.service = <span class="hljs-string"><span class="hljs-string">'C_INTRAAREAL'</span></span> | tk.attach.service = <span class="hljs-string"><span class="hljs-string">'C_INTERCITY'</span></span> | tk.attach.service = <span class="hljs-string"><span class="hljs-string">'C_INTERNATIONAL'</span></span>) { [<span class="hljs-number"><span class="hljs-number">200033</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_dou_activated = <span class="hljs-number"><span class="hljs-number">1</span></span>) { [<span class="hljs-number"><span class="hljs-number">200034</span></span>] var_list:activate_command = <span class="hljs-number"><span class="hljs-number">0</span></span>; } [<span class="hljs-number"><span class="hljs-number">200035</span></span>] var_list:is_dou_activated = <span class="hljs-number"><span class="hljs-number">1</span></span>; } [<span class="hljs-number"><span class="hljs-number">200036</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (activate_command = <span class="hljs-number"><span class="hljs-number">1</span></span>) { [<span class="hljs-number"><span class="hljs-number">200037</span></span>] &lt; text:%s; var_list:tk.attach.service; [<span class="hljs-number"><span class="hljs-number">200038</span></span>] var_list:retry_cnt = <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre><br>  Variables save us.  By activating the first command that controls outgoing communication from the tk.attach collection, we set the is_dou_activated flag, which prohibits the activation of subsequent commands.  Moreover, this code only works for Alcatel S12. <br><br>  The only thing we need for this approach to work is for the teams to come in the correct order: first, the inclusion of international calls (if any), then the long-distance and intra-zone calls.  Fortunately, specs allow sorting of samples. <br>  Collections by any criterion.  You only need to add priority fields to the service table when connecting and disconnecting. <br><br><h1>  3. Problems associated with synchronization </h1><br>  As I said above, the possibility of obtaining actual settings from the equipment is one of the main requirements for performing at least some kind of correct activation.  Let's see why this is so? <br><br><h2>  3.1 "Intellectual" activation </h2><br>  The very first additional requirement that we received from the Customer, when introducing the first version of the product, was that it was not necessary to reactivate the settings previously activated on the equipment.  This is really important for two reasons: <br><br><ol><li>  Activation of commands on the equipment is not a quick process.  The average execution time for a single command on the Alcatel S12 is ~ 10 seconds (the M-200 is much faster (~ 1 second) because it returns a much smaller amount of data).  Add to this the fact that the connection with the PBX is not very stable and we can lose it within those 10 seconds.  If at each re-execution of the task (and we must fulfill all the commands that make up the task, to ensure the atomicity of its execution) we will re-activate all the commands from the very beginning, then, in the worst case, we will activate these commands again and again and never get to the end of the mission </li><li>  In some cases (on Alcatel S12), re-activating a command may result in an error.  In this case, we can not peek at the state of settings in the database, because, perhaps, the activation for this subscriber is carried out for the first time.  In this case, the only correct solution is to get the status of the settings directly from the equipment, before executing the activation command. </li></ol><br>  All this means that before activating any command, we must receive the current values ‚Äã‚Äãof settings affecting the execution of this command from the PBX.  In that case, if the settings are already in the required state, we can not execute the activated command and move on (if the activated command cannot be executed due to conflicting settings, we can also not execute the command, but immediately trigger an exception).  This approach works great for the M-200 because: <br><br><ol><li>  All subscriber settings are returned in response to the execution of a single gettune command. </li><li>  Activation on the M-200 is relatively quick and the connection is stable.  We can afford to perform one additional command at the beginning of each activation. </li></ol><br>  For the Alcatel S12, everything is not so bright.  To read the settings, you will have to execute various commands and all of them will be executed slowly.  Thus, it is impossible to do without storing the state of settings in the database.  When activating, we will be able to get the settings values ‚Äã‚Äãfrom the database and, only if they are not there, form the necessary commands to get the missing values ‚Äã‚Äãfrom the equipment. <br><br>  Of course, this is not the ideal solution, because with manual execution of commands, bypassing the activation subsystem, the data in the database will be out of sync, but this is the lesser of the evils that we can afford.  In addition, upon completion of the command activation, the actual values ‚Äã‚Äãof the settings will become known to us (since the command has successfully changed them) and we will be able to update the unsynchronized data in the database. <br><br>  There is also a problem with the M-200.  In some cases, the <a href="http://www.m-200.com/base/index.php/Tune">tune-</a> server used to interact with the PBX, which I will discuss below, starts to work incorrectly.  He answers Ok to all settune commands, although the data on the PBX does not change!  Calling gettune, in this case, results in an error. <br><br>  This means that for the M-200, we must call gettune not only before, but also after activation and, in the event of an error, must initiate a rerun of the task.  As soon as the tune-server starts working correctly, we will be able to activate those commands, the activation of which actually failed during the previous execution of the task.  What has been successfully activated will not be re-activated. <br><br><h2>  3.2 Dependent Services </h2><br>  As I mentioned above, on the PBX M-200, the inclusion of the 'PINCODE' service (depending on the values ‚Äã‚Äãof the specification variables) can lead to the activation of one of the three command sequences: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">settune</span></span> XXXXXXX enb_pincode=<span class="hljs-literal"><span class="hljs-literal">on</span></span></code> </pre><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">settune</span></span> XXXXXXX enb_pincode=<span class="hljs-literal"><span class="hljs-literal">on</span></span> settune XXXXXXX dvo_pincode=<span class="hljs-literal"><span class="hljs-literal">on</span></span> settune XXXXXXX pincode=YYYY</code> </pre><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">settune</span></span> XXXXXXX enb_pincode=<span class="hljs-literal"><span class="hljs-literal">on</span></span> settune XXXXXXX dvo_pincodetwo=<span class="hljs-literal"><span class="hljs-literal">on</span></span> settune XXXXXXX pincode=YYYY</code> </pre><br>  Setting enb_pincode is enabled in all three cases.  It is easy to imagine a possible error arising from the naive implementation of the activation of these commands: <br><br><ol><li>  The service is activated, which includes the enb_pincode setting, which allows the subscriber to set a PIN code independently </li><li>  The service activating the PIN-code for outgoing communication (within which enb_pincode is activated again) </li><li>  The subscriber refuses the service enb_pincode </li></ol><br>  As a result of this sequence of actions, the enb_pincode setting is disabled and the PIN code set in the second step stops working!  What can be done to prevent this from happening? <br><br>  The decision, in general, is obvious.  We must record all activated services in the database and conduct additional checks when the trip commands are activated.  If the setting to be disabled is still used by some other non-disabled service, the disable command should be ignored. <br><br>  Yes, the subscriber will be able to use the enb_pincode service, which he actually refused, but the PIN codes set will work without any complaints from the subscriber.  There are not many such dependencies in the M200 command system, but they are all associated with important services (such as setting an alarm clock or turning on redirection).  Accounting for these dependencies is important in terms of correct activation. <br><br><h2>  3.3 Implementing Rollback </h2><br>  Not any task can be completed successfully.  Activation of the command may fail, due to incorrect data (the subscriber‚Äôs number is not served by this PBX, incorrect time when setting the alarm, etc.), or when activated services conflict (this often happens on Alcatel S12).  Such errors will be called unrecoverable. <br><br>  Since the task must be executed atomically, in the event of an unrecoverable error, we will have to ‚Äúroll back‚Äù all the commands that were successfully activated earlier, within the same task.  The first thing that comes to mind is to remember all the commands that you managed to fulfill and, when an error occurred, execute the commands that they reverse.  The implementation of this approach can be seen in the old version of the script: <br><br><pre> <code class="hljs mel">... [<span class="hljs-number"><span class="hljs-number">002391</span></span>] platform:M<span class="hljs-number"><span class="hljs-number">-200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tk.detach.service = <span class="hljs-string"><span class="hljs-string">'PINCODE'</span></span> &amp; tk.detach.act_mode = <span class="hljs-number"><span class="hljs-number">0</span></span> &amp; tk.detach.act_level = <span class="hljs-number"><span class="hljs-number">2</span></span>) { [<span class="hljs-number"><span class="hljs-number">023910</span></span>] &lt; <span class="hljs-keyword"><span class="hljs-keyword">text</span></span>:settune %s dvo_pincode=off; var_list:tk.phone; [<span class="hljs-number"><span class="hljs-number">001041</span></span>] &gt; is_error:<span class="hljs-number"><span class="hljs-number">1</span></span>; regexp:(.+); var_list:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>; [<span class="hljs-number"><span class="hljs-number">001610</span></span>] &lt; <span class="hljs-keyword"><span class="hljs-keyword">text</span></span>:settune %s pincode=; var_list:tk.phone; [<span class="hljs-number"><span class="hljs-number">001041</span></span>] &gt; is_error:<span class="hljs-number"><span class="hljs-number">1</span></span>; regexp:(.+); var_list:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>; [<span class="hljs-number"><span class="hljs-number">022010</span></span>] &lt; <span class="hljs-keyword"><span class="hljs-keyword">text</span></span>:settune %s enb_pincode=off; var_list:tk.phone; [<span class="hljs-number"><span class="hljs-number">001041</span></span>] &gt; is_error:<span class="hljs-number"><span class="hljs-number">1</span></span>; regexp:(.+); var_list:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>; [<span class="hljs-number"><span class="hljs-number">023911</span></span>] is_rollback:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tk.detach.value != <span class="hljs-string"><span class="hljs-string">''</span></span>) { [<span class="hljs-number"><span class="hljs-number">001020</span></span>] &lt; device_id:tk.ats_id; [<span class="hljs-number"><span class="hljs-number">023912</span></span>] &lt; <span class="hljs-keyword"><span class="hljs-keyword">text</span></span>:settune %s dvo_pincode=on; var_list:tk.phone; [<span class="hljs-number"><span class="hljs-number">001041</span></span>] &gt; is_error:<span class="hljs-number"><span class="hljs-number">1</span></span>; regexp:(.+); var_list:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>; [<span class="hljs-number"><span class="hljs-number">001603</span></span>] &lt; <span class="hljs-keyword"><span class="hljs-keyword">text</span></span>:settune %s pincode=%s; var_list:tk.phone, tk.detach.value; [<span class="hljs-number"><span class="hljs-number">001041</span></span>] &gt; is_error:<span class="hljs-number"><span class="hljs-number">1</span></span>; regexp:(.+); var_list:<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>; } } ...</code> </pre><br>  Here, immediately after the successful disconnection of the 'PINCODE' service, the return commands are saved, to activate the service, in the rollback command stack.  In addition to excessive verbosity, this approach has several other disadvantages. <br><br><ol><li>  Proper implementation of this approach is very time consuming.  The fact is that in order to execute the reverse commands, the values ‚Äã‚Äãof the variables are required at the time of activation of the direct command, but some of these variables are in the collections viewed by the foreach operator.  This means that when forming the inverse command, you need to save the "snapshots" of the state of these collections (and the subcollections enclosed in them) and use them instead of the original specifications when you roll back.  In addition, commands such as resetting a PIN code require a PIN value for a reverse command in order for it to be restored, and we have to add this value to the specification, although the direct command does not use it </li><li>  Running a rollback command after an activation error occurs may result in an error on the Alcatel S12.  For example, in case of an incorrect setting of any of the parameters, the PBX requests the correct value and expects to receive it, and not the rollback command.  Receiving a command in this context results in an error, as a result of which the rollback command is not executed.  In the section ‚ÄúValidation of parameters‚Äù I will examine this question in more detail. </li><li>  This approach does not work!  In fact, we have nowhere to get the correct values ‚Äã‚Äãof the parameters, not only for the PIN code setting command, but also for the enb_pincode and dvo_pincode commands.  If we turned them off during the assignment, this does not mean that they were not turned off before the activation of the assignment.  In this case, the inclusion of these settings, in the rollback process, will be an error </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, the only place from which we can get the correct values ‚Äã‚Äãof the settings at the time of activation is the equipment or database, provided that the data in it is synchronized with the state of the PBX. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order to close this question, it remains to mention one more thing. The fact is that the activation task can activate commands on several PBXs (for example, when a subscriber is transferred from one PBX to another).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Access settings to the PBX are stored in the tk collection and it may turn out that having successfully completed the commands on one PBX, we received an error when executing the command on another. </font><font style="vertical-align: inherit;">In the open record of the tk collection, at this moment, there are no parameters for access to the PBX, which should be rolled back. </font><font style="vertical-align: inherit;">The easiest way to deal with this problem is after initiating a rollback, to cause a restart to activate the task. </font><font style="vertical-align: inherit;">In this case, all collections will be reopened and the ‚Äúservice‚Äù 'ROLLBACK' will be executed for all PBXs involved in activation:</font></font><br><br><pre> <code class="hljs cs">... [<span class="hljs-number"><span class="hljs-number">200002</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (subtype = <span class="hljs-number"><span class="hljs-number">-1</span></span>) { [<span class="hljs-number"><span class="hljs-number">200003</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (tk) { [<span class="hljs-number"><span class="hljs-number">200015</span></span>] &lt; device_id:tk.ats_id; [<span class="hljs-number"><span class="hljs-number">200006</span></span>] &lt; text:ROLLBACK; ... } } ...</code> </pre><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3.4 Renewable Activation </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition to the unrecoverable errors discussed in the previous section, errors are possible, after the occurrence of which the activation can be continued. For example, if a TCP connection with a PBX was broken during the activation process, rollback is not required. In this case, activation is sufficient to repeat, skipping the execution of commands activated earlier. Here is the hierarchy of exceptions raised in the activation process:</font></font><br><br><img src="http://habrastorage.org/getpro/habr/post_images/f21/33d/3ec/f2133d3ecb012b7894d6d3e9e449c12c.png" alt="image"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exceptions implying the need for renewed activation are inherited from RetryRequiredException. </font><font style="vertical-align: inherit;">A rollbackRequiredException additionally triggers a rollback activation. </font><font style="vertical-align: inherit;">Unplanned errors are triggered by a RuntimeAeException, shutting down the activation service with the appropriate diagnostics. </font><font style="vertical-align: inherit;">Renewal of activation due to loss of connection with PBX (TcpConnectionLostException) can occur in two fundamentally different cases:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Loss of connection with PBX during activation </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Impossibility of primary connection to PBX </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the first case, intervention by the administrator is not required. Since the PBX, in principle, is available, having repeated the activation several times (with a delay of several minutes), we will sooner or later complete the task. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the second case, an error, for example, may be caused by the fact that the parameters of access to the PBX are set incorrectly. In this case, several connection attempts should be made, after which an error message should be generated. This logic is implemented by the script:</font></font><br><br><pre> <code class="hljs perl">[<span class="hljs-number"><span class="hljs-number">002000</span></span>] { [<span class="hljs-number"><span class="hljs-number">200001</span></span>] var_list:retry_cnt = retry_cnt + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; ... [<span class="hljs-number"><span class="hljs-number">200008</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (subtype = <span class="hljs-number"><span class="hljs-number">1</span></span>) { [<span class="hljs-number"><span class="hljs-number">200009</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (tk) { ... [<span class="hljs-number"><span class="hljs-number">200014</span></span>] target:tk.ats_type; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (tk.detach) { [<span class="hljs-number"><span class="hljs-number">200015</span></span>] &lt; device_id:tk.ats_id; ... [<span class="hljs-number"><span class="hljs-number">200025</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (activate_command = <span class="hljs-number"><span class="hljs-number">1</span></span>) { [<span class="hljs-number"><span class="hljs-number">200026</span></span>] &lt; text:%s; var_list:tk.detach.service; [<span class="hljs-number"><span class="hljs-number">200027</span></span>] var_list:retry_cnt = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } ... }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> At the very beginning of the script, we increase the attempt counter (if the variable is not defined by the specification, it is automatically created with a zero value), and after successful execution of any command, reset it to 0. Exceeding the counter value by the maximum number of connection attempts is tracked by the specification and forms an exception, appropriate diagnosis. </font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4. Validation of parameters </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The important point is the need to validate the values ‚Äã‚Äãof parameters that are inserted into the command. </font><font style="vertical-align: inherit;">As I said above, passing an incorrect value to a parameter can make it impossible to automatically execute subsequent commands (for example, rollback commands):</font></font><br><br><pre> <code class="hljs 1c"><span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">5.130</span></span>:<span class="hljs-number"><span class="hljs-number">4001</span></span>&gt; MODIFY-SUBSCR:DN=K'<span class="hljs-number"><span class="hljs-number">8553377684</span></span>,ALMCALL=ACTIVATE&amp;06&amp;00&amp;00. 10.0.5.130:<span class="hljs-number"><span class="hljs-number">4001</span></span>&gt; SEQ=<span class="hljs-number"><span class="hljs-number">1306.130403</span></span> <span class="hljs-number"><span class="hljs-number">9002</span></span> 10.0.5.130:<span class="hljs-number"><span class="hljs-number">4001</span></span>&gt; COM=<span class="hljs-number"><span class="hljs-number">4294</span></span> 10.0.5.130:<span class="hljs-number"><span class="hljs-number">4001</span></span>&gt; JOB SUBMITTED 10.0.5.130:<span class="hljs-number"><span class="hljs-number">4001</span></span>&gt; 10.0.5.130:<span class="hljs-number"><span class="hljs-number">4001</span></span>&gt; 10.0.5.130:<span class="hljs-number"><span class="hljs-number">4001</span></span>&gt; ARGUMENT SEMANTIC ERROR : ALMCALL ARG <span class="hljs-number"><span class="hljs-number">0004</span></span> 10.0.5.130:<span class="hljs-number"><span class="hljs-number">4001</span></span>&gt; ERROR CODE = <span class="hljs-number"><span class="hljs-number">0008</span></span> 10.0.5.130:<span class="hljs-number"><span class="hljs-number">4001</span></span>&gt; &lt; 10.0.5.130:<span class="hljs-number"><span class="hljs-number">4001</span></span>&lt; MODIFY-SUBSCR:DN=K'<span class="hljs-number"><span class="hljs-number">8553377684</span></span>,ALMCALL=ACTIVATE<span class="hljs-meta"><span class="hljs-meta">&amp;06&amp;00&amp;00. 10.0.5.130:4001&gt; MODIFY-SUBSCR:DN=K'8553377684,SUBCTRL=REMOVE&amp;CWTG. 10.0.5.130:4001&gt; PARAMETER NOT EXISTENT ; MODIFY-S 10.0.5.130:4001&gt; &lt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, you can analyze the patterns of such errors and automatically generate additional commands that put the PBX in the waiting state of the next team, but this will significantly complicate the algorithm of interaction with the PBX. </font><font style="vertical-align: inherit;">It is much easier to avoid such errors. </font><font style="vertical-align: inherit;">Make it pretty easy. </font><font style="vertical-align: inherit;">For example, to validate the number of times the alarm went off, the zero value of which resulted in an error in this example, it suffices to use the following regular expression:</font></font><br><br><pre> <code class="hljs">^([1-9])$</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, it is best to perform this check back in Order Management, preventing the creation of tasks with incorrect parameter values. </font><font style="vertical-align: inherit;">But, regardless of whether such testing is implemented or not, it makes sense to check the values ‚Äã‚Äãof the parameters immediately before sending the command to the PBX. </font><font style="vertical-align: inherit;">This will help to avoid unnecessary mistakes and simplify the logic of interaction with PBX.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 5. Access to PBX </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Features access to the PBX should also be considered in the design. </font><font style="vertical-align: inherit;">A common point for both Alcatel S12 and M-200 (using tune) is that a control session is not created for each connection to the PBX. </font><font style="vertical-align: inherit;">In fact, every time we connect to the same ‚Äúsession‚Äù (this is a certain simplification, but, for the activation subsystem, it looks like this). </font><font style="vertical-align: inherit;">From this fact there are two important consequences:</font></font><br><br><ol><li>            .    . ,    Alcatel S12   .           'PASSWORD'    .        ,     , ,     ,   . ,     ,     ,    'INVALID PASSWORD'.   ,    ,   ,  ,     </li><li>   .    ,          - .  ,   , , ,    (   ).     ,          ,       </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It should also take into account a number of features Alcatel S12. </font><font style="vertical-align: inherit;">Thus, non-printable characters (0x05, 0x17) may be present in its output, and when entering commands, line feed and carriage return characters are not used. </font><font style="vertical-align: inherit;">The command string sent to the Alcatel S12 must end with a '.' </font><font style="vertical-align: inherit;">or ';' </font><font style="vertical-align: inherit;">(the password transmitted during authorization must also be terminated by a ';'). </font><font style="vertical-align: inherit;">The high bit in each byte transmitted to the PBX can be used for parity (this is configured on the PBX). </font><font style="vertical-align: inherit;">These settings do not apply to the text transmitted from the PBX. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Currently, a Telnet-like TCP connection is used to connect to both the Alcatel S12 and the M-200, but this solution is not the only one possible. </font><font style="vertical-align: inherit;">Below are briefly discussed other options for connecting to these PBXs.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 5.1 Serial vs TCP </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As I said earlier, at the time the project started I didn‚Äôt have any experience with Alcatel S12. The fact that with this type of PBX (in any case, in the configuration used by the Customer) will have to work on the Serial-connection, from the very beginning, was considered as one of the most significant risks of the project. This may seem strange, but at the same time I was right and wrong. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, using such libraries as </font></font><a href="http://rxtx.qbang.org/wiki/index.php/Main_Page"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RXTX</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><a href="http://code.google.com/p/java-simple-serial-connector/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jSSC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (which I learned from an </font></font><a href="http://habrahabr.ru/post/133766/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on Habr√©), connecting to the Serial port from Java SE (used in the project) is not a problem in itself, but here you need to take two things into account:</font></font><br><br><ol><li>   ,         Serial-.    ,  USB-Serial  (  )     .        ,    ,     .  ,    Serial-       ¬´¬ª </li><li>             RS-232   ,   . ,         (   ,         ),      ! </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The solution was found in the process of communicating with the Customer, who had more experience in interaction with the PBX. </font><font style="vertical-align: inherit;">Of course, telephonists also wanted to manage all PBXs from one place, and they had been successfully doing this for a long time, using </font></font><a href="http://www.moxa.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MOXA</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> communication equipment </font><font style="vertical-align: inherit;">, which allows them to ‚Äúpush‚Äù a Serial connection through an Intranet. </font><font style="vertical-align: inherit;">Unfortunately, when trying to connect to the virtual port created by MOXA on the client side, there were </font></font><a href="http://habrahabr.ru/qa/28121/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">problems</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We spent quite a lot of time trying to solve this problem until we found out that some MOXA models allow you to use a TCP connection. </font><font style="vertical-align: inherit;">This approach has been used. </font><font style="vertical-align: inherit;">A </font><font style="vertical-align: inherit;">Serial-port </font></font><a href="http://www.serialmon.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">monitor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and a </font></font><a href="http://ru.wikipedia.org/wiki/Wireshark"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sniffer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> helped us a lot </font><font style="vertical-align: inherit;">.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 5.2 Tune vs TCP </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There were fewer problems connecting to the M-200, since it initially supported a TCP connection. Initially it was planned to use direct access to the ‚Äúsubscriber card‚Äù. I will not clutter the article with dumps of TCP sessions, I will only say that the subscriber settings in M-200 are stored in a bitmap. The PBX control protocol allows (using TCP) to read this bitmap entirely and write it back after making the necessary changes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We managed to decrypt some of the subscriber card fields (we could not find the documentation), but eventually it was decided to use the tune server as a more documented method for managing the PBX. In addition, the work in the mode of entering text commands was more convenient.</font></font><br><br><h1>  Conclusion </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this article I tried to describe (and somehow classify) the difficulties that arose in a real activation project. </font><font style="vertical-align: inherit;">Despite the pronounced focus on the equipment of traditional telephony, the material can be useful when working on the automation control of any equipment (for example, switches cisco). </font><font style="vertical-align: inherit;">I hope that this article will be useful to someone.</font></font><br></div><p>Source: <a href="https://habr.com/ru/post/186900/">https://habr.com/ru/post/186900/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../186882/index.html">NASA conducted successful tests of the ‚Äúprinted‚Äù rocket engine injector</a></li>
<li><a href="../186886/index.html">Windows Azure Recovery Services. Part 2: Preparation</a></li>
<li><a href="../186888/index.html">ORANGEMAN: new distribution of servers, results and plans for the future</a></li>
<li><a href="../186890/index.html">This year there will be robotic cars on the roads of Great Britain</a></li>
<li><a href="../186892/index.html">Reports from past hacker tournaments C ^ 2</a></li>
<li><a href="../186902/index.html">Illegal video content detected on seized Ukrainian Vkontakte servers</a></li>
<li><a href="../186912/index.html">Communigate - mobile office for VPS hosting</a></li>
<li><a href="../186920/index.html">Competition of mobile applications for the city of Moscow App Contest'13</a></li>
<li><a href="../186922/index.html">What's new in Windows Server 2012 R2?</a></li>
<li><a href="../186924/index.html">Pope Francis will hand out indulgences via Twitter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>