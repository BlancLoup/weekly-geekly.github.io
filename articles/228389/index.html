<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Elliptics from Yandex. How to use it to create your fault-tolerant storage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear readers! 

 In previous articles, I outlined in general terms about our open fault-tolerant Elliptics repository, as well as a li...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Elliptics from Yandex. How to use it to create your fault-tolerant storage</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear readers! <br><br>  In previous articles, I outlined in general terms about our open fault-tolerant Elliptics repository, as well as a <a href="http://habrahabr.ru/company/yandex/blog/209882/">little bit of detail</a> .  Today I will visually tell you and show you how to use Elliptics on the example of creating your own fault-tolerant HabraMusic. <br><br> <a href="http://habrahabr.ru/company/yandex/blog/228389/"><img src="https://habrastorage.org/getpro/habr/post_images/187/d7f/dab/187d7fdaba6ae918d3de2d86ff296498.jpg" width="800"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      HabraMusic is your personal music repository with regional support, data replication, minimal disk and network load, and a simple HTTP API that can be used in any of your applications or on a personal website. <br><br>  Under the cut - step by step details. <br><a name="habracut"></a><br><h1>  Deploying Elliptics </h1><br>  First we need to put Elliptics.  To do this, we collect packages in <a href="http://repo.reverbrain.com/">our repository</a> for such common server systems as: <br><br><ul><li>  Debian Wheezy; </li><li>  Ubuntu Precise 12.04; </li><li>  Ubuntu Trusty 14.04; </li><li>  RedHat 6 / CentOS 6. </li></ul><br>  For other distributions, you can build the system yourself from the sources that are located on our <a href="https://github.com/reverbrain">GitHub account</a> . <br><br>  For further work it is necessary to deliver the packages: <br><br><pre><code class="bash hljs">$ sudo apt-get install elliptics elliptics-client rift</code> </pre> <br>  or <br><br><pre> <code class="bash hljs">$ sudo yum install elliptics elliptics-client rift</code> </pre><br><br>  If you want to try in the API for C ++, then you should also install the package <code>elliptics-dev</code> or <code>elliptics-client-devel</code> , depending on the distribution. <br><br>  Great, packages are delivered.  Now it's time to launch your cluster.  In this tutorial, we will run all the servers on the same machine.  In a real situation, they should be spread to different machines and data centers.  On <a href="https://github.com/euroelessar/habrahabr-elliptics">GitHub</a> all configuration files which will be necessary for our tutorial are located. <br><br>  First <code>node-1.json</code> look at the example of the <code>node-1.json</code> configuration file: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"loggers"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"/srv/elliptics/1/log.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"level"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> }, <span class="hljs-string"><span class="hljs-string">"options"</span></span>: { <span class="hljs-string"><span class="hljs-string">"join"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"flags"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"remote"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"autodiscovery:224.0.0.5:1025:2"</span></span> ], <span class="hljs-string"><span class="hljs-string">"address"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"localhost:1025:2"</span></span> ], <span class="hljs-string"><span class="hljs-string">"wait_timeout"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"check_timeout"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"io_thread_num"</span></span>: <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-string"><span class="hljs-string">"nonblocking_io_thread_num"</span></span>: <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-string"><span class="hljs-string">"net_thread_num"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"daemon"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"auth_cookie"</span></span>: <span class="hljs-string"><span class="hljs-string">"&lt;-Don't forget to change it-&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"cache"</span></span>: { <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">1073741824</span></span> }, <span class="hljs-string"><span class="hljs-string">"indexes_shard_count"</span></span>: <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-string"><span class="hljs-string">"monitor_port"</span></span>: <span class="hljs-number"><span class="hljs-number">20000</span></span> }, <span class="hljs-string"><span class="hljs-string">"backends"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"blob"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"history"</span></span>: <span class="hljs-string"><span class="hljs-string">"/srv/elliptics/1/history/"</span></span>, <span class="hljs-string"><span class="hljs-string">"data"</span></span>: <span class="hljs-string"><span class="hljs-string">"/srv/elliptics/1/blob/data"</span></span>, <span class="hljs-string"><span class="hljs-string">"sync"</span></span>: <span class="hljs-string"><span class="hljs-string">"-1"</span></span>, <span class="hljs-string"><span class="hljs-string">"blob_flags"</span></span>: <span class="hljs-string"><span class="hljs-string">"129"</span></span>, <span class="hljs-string"><span class="hljs-string">"blob_size"</span></span>: <span class="hljs-string"><span class="hljs-string">"10G"</span></span>, <span class="hljs-string"><span class="hljs-string">"records_in_blob"</span></span>: <span class="hljs-string"><span class="hljs-string">"1000000"</span></span> } ] }</code> </pre><br>  To run Elliptics with this configuration file, you need to create the following directories: <br><ul><li>  <code>/srv/elliptics/1/</code> - here logs with the Debug level will be written to the log.txt file; </li><li>  <code>/srv/elliptics/1/blob/</code> - blobs with data will be located here; </li><li>  <code>/srv/elliptics/1/history/</code> - there will be a file with the beginning of the intervals from the DHT-ring. </li></ul><br>  Details on the remaining specified and unspecified fields can be found in our <a href="http://doc.reverbrain.com/elliptics:configuration">documentation</a> . <br><br>  To start, just run: <br><br><pre> <code class="bash hljs">$ dnet_ioserv -c node-1.json</code> </pre><br>  But we want to build a failover cluster.  For this we need to raise at least one more car in the second group.  In her config you will need to specify a different address, as well as other remote addresses.  As a result, while the <code>node-1.json, node-2.json</code> configuration files are used to store data in 2 copies. <br><br>  Create directories needed for the first two nodes, and run each of them: <br><br><pre> <code class="bash hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> `seq 1 2`; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> mkdir /srv/elliptics/<span class="hljs-variable"><span class="hljs-variable">$id</span></span>/{<span class="hljs-built_in"><span class="hljs-built_in">history</span></span>,blob} -p; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> $ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> `seq 1 2`; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> dnet_ioserv -c node-<span class="hljs-variable"><span class="hljs-variable">$id</span></span>.json; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br><h1>  Meet C ++ / Python API </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/d96/cac/8c7/d96cac8c728593ba16fe3f5f5b7344b7.jpg" width="640"><br>  And now, when the servers are running, let's start our acquaintance with low-level C ++ and Python API.  To do this, I will show every action in two languages ‚Äã‚Äãat once with explanations. <br><br><h3>  <i>Connect to servers</i> </h3><br>  First you need to create a client node to connect to Elliptics servers. <br><br>  C ++: <br><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta">#include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;elliptics/session.hpp&gt;</span></span></span><span class="hljs-meta"> using namespace ioremap::elliptics; file_logger logger(‚Äú/dev/stderr‚Äù, DNET_LOG_ERROR); node n(file_logger); n.add_remote(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"localhost"</span></span></span><span class="hljs-meta">, 1025); n.add_remote(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"localhost"</span></span></span><span class="hljs-meta">, 1026); session sess(n); sess.set_groups({ 1, 2, 3 });</span></span></code> </pre><br>  Python: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> elliptics log = elliptics.Logger(‚Äú/dev/stderr‚Äù, elliptics.log_level.debug) node = elliptics.Node(log) node.add_remote(‚Äúlocalhost‚Äù, <span class="hljs-number"><span class="hljs-number">1025</span></span>) node.add_remote(‚Äúlocalhost‚Äù, <span class="hljs-number"><span class="hljs-number">1026</span></span>) sess = elliptics.Session(node) sess.group = [ <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> ]</code> </pre><br><h3>  <i>We write data in Elliptics</i> </h3><br>  Write some data in Elliptics: <br><br>  C ++: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> async_result = sess.write_data(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(<span class="hljs-string"><span class="hljs-string">"test_key"</span></span>), <span class="hljs-string"><span class="hljs-string">"some data"</span></span>, offset);</code> </pre><br>  Python: <br><br><pre> <code class="python hljs">async_result = sess.write_data(‚Äútest_key‚Äù, ‚Äúsome_data‚Äù, offset)</code> </pre><br>  The above code will send a request to write data to the Elliptics server.  However, after that you need to wait for the answers and process them.  Many teams send multiple requests to Elliptics servers.  For example, data recording sends requests simultaneously to each group on request.  Each request receives a response, from which you can find out some information common to all commands (for example, the address of the server that processed the request, or the result code of the command execution), as well as information specific to this command (such as the path to the blob in which a recording was made, with coordinates inside it). <br><br><h3>  <i>Handling server response</i> </h3><br>  There are several options for processing the result of the command.  They should be considered in more detail. <br><br><h4>  Synchronous request </h4><br>  C ++: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { async_result.wait(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error &amp;e) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cerr</span></span> &lt;&lt; ‚ÄúError <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> write execution: ‚Äú &lt;&lt; e.message(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> sync_result = async_result.get(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (write_result_entry entry : async_result.get()) { <span class="hljs-comment"><span class="hljs-comment">// Process entry std::cerr &lt;&lt; "Received answer from: " &lt;&lt; dnet_server_convert_dnet_addr(result.address()) &lt;&lt; "status: " &lt;&lt; result.status() &lt;&lt; std::endl; }</span></span></code> </pre><br>  Python: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: async_result.wait() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Write failed: "</span></span>, e <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> entry <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> async_result.get(): print(<span class="hljs-string"><span class="hljs-string">"Reply from {}, status: {}"</span></span>.format(entry.address, entry.error.code))</code> </pre><br>  You can get rid of exceptions by invoking the session method set_exceptions_policy, which is present in both C ++ and the Python API.  In this case, you need to do a manual check for errors: <br><br>  C ++: <br><br><pre> <code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (async_result.<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>()) { <span class="hljs-comment"><span class="hljs-comment">//    }</span></span></code> </pre><br>  Python: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (async_result.error) { //    }</code> </pre><br><h4>  Iterated query </h4><br>  Sometimes the total amount of data from the server may be too large to be stored in memory at once.  There may also be a requirement to process data as it arrives.  In this case, you can use an iteration: the body of the loop will be executed for each response received from the server, as their performances.  Between packets, the user's thread will sleep. <br><br>  C ++: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> entry : async_result) { }</code> </pre><br>  Python: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> entry <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> async_result: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre><br><h4>  Asynchronous request </h4><br>  Also, as soon as the answer is completely received, you can execute your code in the Elliptics stream. <br><br>  C ++: <br><br><pre> <code class="hljs lua">async_result.connect([] (const sync_write_result &amp;result, const error_info &amp;<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { //   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (auto entry : result) { //   } });</code> </pre><br><br>  Python: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(results, error)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> error.code != <span class="hljs-number"><span class="hljs-number">0</span></span>: //   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> entry <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> results: //   <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> async_result.connect(handler)</code> </pre><br><h4>  Asynchronous iterative query </h4><br>  This method is recommended to use if there is a lot of data from the server, you want to process them as they arrive and you do not want to block any of the threads to wait for the data.  The first callback will be called for every response received from the server, and the last one will be called after the last response has been received.  And the only argument will be information about a possible error, if the final response code is not zero. <br><br>  C ++ <br><br><pre> <code class="hljs lua">async_result.connect([] (const write_result_entry &amp;entry) { //   }, [] (const error_info &amp;<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>) { //   } });</code> </pre><br>  Python: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">result_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(result, error)</span></span></span><span class="hljs-function">:</span></span> //   <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(results, error)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> error.code != <span class="hljs-number"><span class="hljs-number">0</span></span>: //   <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> async_result.connect(result_handler, error_handler)</code> </pre><br><h3>  <i>Reading data</i> </h3><br>  To read the data, it is enough to execute the code below, and then process the response in the same way as in the case of write: <br><br>  C ++: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> async_result = sess.read_data(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(<span class="hljs-string"><span class="hljs-string">"test_key"</span></span>), offset, size);</code> </pre><br>  Python: <br><br><pre> <code class="hljs pgsql">async_result = sess.read_data(‚Äútest_key‚Äù, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, size)</code> </pre><br>  It should be remembered that for reading the server could not find the file the first time.  In this case, the number of answers may be more than one, and all, except the last, will be with a negative error code. <br><br><h3>  <i>Data deletion</i> </h3><br>  Deleting data is also easy. <br><br>  C ++: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> async_result = sess.remove_data(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(<span class="hljs-string"><span class="hljs-string">"test_key"</span></span>));</code> </pre><br>  Python: <br><br><pre> <code class="python hljs">async_result = sess.remove_data(‚Äútest_key‚Äù)</code> </pre><br><h3>  <i>And much more</i> </h3><br>  available in <a href="http://doc.reverbrain.com/elliptics:api-python">our documentation</a> . <br><br><h1>  HTTP API </h1><br><img src="http://img-fotki.yandex.ru/get/9756/54074776.c/0_1166de_5b48516b_orig" width="640"><br>  We recommend using <a href="https://github.com/reverbrain/rift">Rift</a> to work with the HTTP API.  Detailed documentation is available <a href="http://doc.reverbrain.com/rift:rift">here</a> .  Rift is based on our high-performance asynchronous HTTP server <a href="https://github.com/reverbrain/swarm">TheVoid</a> , specially designed to work as an HTTP backend for Nginx. <br><br>  Rift has support for two main modes of operation - with and without support for buckets.  In this post, we will consider the baketa mode as more flexible and, of course, difficult.  Buckets allow you to share files and rights of different users.  For example, you can give one user the right to write to the bakt, and another will only be able to read from it. <br><br>  As an example, consider the way to create your service for listening to music. <br><br>  First we need to raise at least one more Elliptics server for storing such Rift meta-information as buckets. <br><br><pre> <code class="bash hljs">$ dnet_ioserv -c node-3.json</code> </pre><br>  Now you need to configure and raise Rift, its config is listed in the <a href="https://github.com/euroelessar/habrahabr-elliptics">GitHub repository</a> under the name <code>rift.json</code> , let's take a closer look: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"endpoints"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"0.0.0.0:8080"</span></span> ], <span class="hljs-string"><span class="hljs-string">"backlog"</span></span>: <span class="hljs-number"><span class="hljs-number">128</span></span>, <span class="hljs-string"><span class="hljs-string">"threads"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"buffer_size"</span></span>: <span class="hljs-number"><span class="hljs-number">65536</span></span>, <span class="hljs-string"><span class="hljs-string">"logger"</span></span>: { <span class="hljs-string"><span class="hljs-string">"file"</span></span>: <span class="hljs-string"><span class="hljs-string">"/srv/rift/log.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"level"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> }, <span class="hljs-string"><span class="hljs-string">"daemon"</span></span>: { <span class="hljs-string"><span class="hljs-string">"fork"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"uid"</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span> }, <span class="hljs-string"><span class="hljs-string">"monitor-port"</span></span>: <span class="hljs-number"><span class="hljs-number">21000</span></span>, <span class="hljs-string"><span class="hljs-string">"application"</span></span>: { <span class="hljs-string"><span class="hljs-string">"remotes"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"localhost:1025:2"</span></span>, <span class="hljs-string"><span class="hljs-string">"localhost:1026:2"</span></span>, <span class="hljs-string"><span class="hljs-string">"localhost:1027:2"</span></span> ], <span class="hljs-string"><span class="hljs-string">"groups"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"metadata-groups"</span></span>: [ <span class="hljs-number"><span class="hljs-number">3</span></span> ], <span class="hljs-string"><span class="hljs-string">"bucket"</span></span>: { <span class="hljs-string"><span class="hljs-string">"timeout"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span> }, <span class="hljs-string"><span class="hljs-string">"read-timeout"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"write-timeout"</span></span>: <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-string"><span class="hljs-string">"redirect-port"</span></span>: <span class="hljs-number"><span class="hljs-number">8081</span></span>, <span class="hljs-string"><span class="hljs-string">"path-prefix"</span></span>: <span class="hljs-string"><span class="hljs-string">"/srv/elliptics/"</span></span> } }</code> </pre><br>  The configuration file can be divided into two sections.  The first is responsible for configuring the HTTP server as a whole: <br><ul><li>  ‚ÄúEndpoints‚Äù - a list of ports and unix-sockets that the server listens to incoming connections; </li><li>  ‚ÄúLogger‚Äù - logging system configuration; </li><li>  ‚ÄúDaemon‚Äù - description of server demonization. </li></ul><br>  The second section - ‚Äúapplication‚Äù - is responsible for the configuration of the Rift: <br><ul><li>  ‚ÄúRemotes‚Äù - list of Elliptics nodes; </li><li>  ‚ÄúMetadata-groups‚Äù - a list of groups in which all meta-information is stored, for example, bucket; </li><li>  ‚ÄúRedirect-port‚Äù - the port that will listen to Nginx on data machines; </li><li>  ‚ÄúPath-prefix‚Äù is the initial part of the path to blobs on data machines. </li></ul><br>  Details about all the parameters of the configuration file can be found <a href="http://doc.reverbrain.com/rift:rift">here</a> . <br><br><pre> <code class="bash hljs">$ rift_server -c rift.json</code> </pre><br>  All operations in Rift with activated bucks require authorization.  The signature generation algorithm is described in the documentation.  Here I will use an extremely simple http-client in Python, which will sign all requests properly.  It lies in the archive and is called <code>http_auth.py</code> . <br><br>  Create a bake, in which we will fill our music.  And I would like to have the right to download music only the administrator of the resource, that is, we, and anyone could listen.  Consider the baket configuration file: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"groups"</span></span>: [ <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> ], <span class="hljs-string"><span class="hljs-string">"acl"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, <span class="hljs-string"><span class="hljs-string">"token"</span></span>: <span class="hljs-string"><span class="hljs-string">"favorite_music"</span></span>, <span class="hljs-string"><span class="hljs-string">"flags"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> }, { <span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-string"><span class="hljs-string">"token"</span></span>: <span class="hljs-string"><span class="hljs-string">"very_secret_token"</span></span>, <span class="hljs-string"><span class="hljs-string">"flags"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } ] }</code> </pre><br>  The first field ‚Äúgroups‚Äù says that the data will be written in two copies, for copies in groups 1 and 2. More information about groups can be found <a href="http://habrahabr.ru/search/%3Fq%3Delliptics">in previous articles</a> . <br>  The second field ‚Äúacl‚Äù contains access rights for different users, in this example, for each user 3 fields were specified: <br><ul><li>  ‚ÄúUser‚Äù is the public user id; </li><li>  ‚ÄúToken‚Äù is a secret token by which authorization takes place; </li><li>  ‚ÄúFlags‚Äù is a description of user rights, currently the following flags and their bit combinations are available: <br><ul><li>  1 - no authorization required for this user; </li><li>  2 - this user has the right to write data to the bakt; </li><li>  4 - this user has the right to change the data of the bake itself (list of groups, acl, etc.). </li></ul></li></ul><br>  Only ‚Äúadmin‚Äù possesses the rights to write new files and change the baket, its secret key is also indicated, with which the authorization will take place.  But read access has any external user without the need for authorization.  Now let's create a bake <code>music</code> in the <code>all</code> directory: <br><br><pre> <code class="bash hljs">$ ./http_auth.py http://localhost:8080/update-bucket/all/music --file update-bucket.json 200</code> </pre><br>  A directory is a special entity that allows, for example, finding all the buckets it contains.  In the created bake we will fill in some music by the key <code>example.mp3</code> : <br><br><pre> <code class="bash hljs">$ ./http_auth.py http://localhost:8080/upload/music/example.mp3?user=admin --file example.mp3 --token favorite_music 200</code> </pre><br>  After that, you can listen to music directly from any player: <br><br><pre> <code class="bash hljs">$ mplayer http://localhost:8080/get/music/example.mp3</code> </pre><br>  The <code>/get</code> handle supports the Last-Modified and Range headers for more efficient traffic management, but this is still not the most rational use of resources.  It would be much more efficient to stream data using Nginx from the physical machines closest to the user on which this file is stored.  This is achieved by supporting the regionality in Elliptics. <br><br>  For this we need Nginx with our eblob module.  It can be found on <a href="https://github.com/toshic/nginx_patches">GitHub</a> . <br><br>  You can assemble it using any suitable Nginx (versions 1.7.x supported) are approximately as follows: <br><br><pre> <code class="bash hljs">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/toshic/nginx_patches.git $ wget <span class="hljs-string"><span class="hljs-string">'http://nginx.org/download/nginx-1.7.0.tar.gz'</span></span> $ tar -xzvf nginx-1.7.0.tar.gz $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> nginx-1.7.0 $ ./configure --prefix=/opt/nginx --add-module=../nginx_patches/nginx-eblob $ make $ sudo checkinstall <span class="hljs-comment"><span class="hljs-comment"># :)</span></span></code> </pre><br>  To activate an eblob module, simply add the <code>‚Äúeblob;‚Äù</code> block to the <code>location</code> section.  Thus, the minimum configuration file looks like this: <br><br><pre> <code class="javascript hljs">worker_processes <span class="hljs-number"><span class="hljs-number">8</span></span>; events { worker_connections <span class="hljs-number"><span class="hljs-number">1024</span></span>; } http { sendfile on; server { listen <span class="hljs-number"><span class="hljs-number">8081</span></span>; server_name localhost; location / { root /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/srw; eblob; } } }</code> </pre><br>  Of course, for the combat environment Nginx should not be configured so naively. <br><br>  Great, now that nginx is configured and running, you can stream music directly from it: <br><br><pre> <code class="bash hljs">$ mplayer -q http://localhost:8080/redirect/music/example.mp3</code> </pre><br>  On this request, the server will generate a special type of url, upon receiving which Nginx will be able to send music directly from blobs, in which Elliptics stores its data. <br><br>  Much more about the Rift can be read in our <a href="http://doc.reverbrain.com/rift:rift">documentation</a> .  There is also a detailed description of all available methods. <br><br><h1>  Instead of conclusion </h1><br>  You can read about this and much more in our documentation on <a href="http://doc.reverbrain.com/">doc.reverbrain.com</a> : <br><ul><li>  <a href="http://doc.reverbrain.com/elliptics:elliptics">Elliptics</a> ; </li><li>  <a href="http://doc.reverbrain.com/thevoid:thevoid">TheVoid</a> ; </li><li>  <a href="http://doc.reverbrain.com/rift:rift">Rift</a> . </li></ul><br>  I remind you that all the projects provided in this article are open and located on GitHub: <a href="https://github.com/reverbrain">https://github.com/reverbrain</a> . </div><p>Source: <a href="https://habr.com/ru/post/228389/">https://habr.com/ru/post/228389/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../228375/index.html">Effective or effective? Master class on creating a site design</a></li>
<li><a href="../228377/index.html">Feature # 3 - Podcast on entrepreneurs and current trends in the IT ecosystem</a></li>
<li><a href="../228379/index.html">The practice of programming games in python: life</a></li>
<li><a href="../228383/index.html">Serious design of a serious store. Part 3. Card product and not only</a></li>
<li><a href="../228385/index.html">9 things that I learned as a programmer, and that I would like to know when I entered the magistracy</a></li>
<li><a href="../228391/index.html">Wind generator energetically pays off in 5-7 months</a></li>
<li><a href="../228393/index.html">Annual online conference MegaIndex.tv 2014</a></li>
<li><a href="../228395/index.html">UNET - new network technology in Unity 3D</a></li>
<li><a href="../228397/index.html">Brave Octopus Adventure - the brave octopus is ready to conquer your Android smartphones</a></li>
<li><a href="../228401/index.html">Gaming Conferences: DevGamm, White Nights and Health Industry</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>