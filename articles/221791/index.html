<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Berkshelf and Chef cookbook dependencies</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Hub users! 
 I continue my immersion in the piquancy of automation and configuration management , in parallel trying to share my experience with t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Berkshelf and Chef cookbook dependencies</h1><div class="post__text post__text-html js-mediator-article">  Hi, Hub users! <img width="200" height="120" align="right" src="https://habrastorage.org/getpro/habr/post_images/b77/fb0/3e6/b77fb03e6f010a70baade23b512604f3.png"><br>  I continue my immersion in the piquancy of <i>automation</i> and <i>configuration management</i> , in parallel trying to share my experience with the <i>community</i> . <br><br>  It will be <b>discussed</b> again about the automation tool for resolving dependencies of the <b>Chef</b> <i>cookbooks</i> that our company uses, namely, <b>Berkshelf</b> . <br><a name="habracut"></a><br><br><h2>  And what have Berkshelf? </h2><br>  <b>Chef</b> has a fairly large and growing community, which constantly makes its contribution to the creation and editing of <i>cookbooks</i> .  All of them are stored on the Community site, many of them are very often used by us. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, there is one ‚Äúbut‚Äù in our company associated with editing the <i>community cookbooks</i> .  The correct way to make any changes to those related to the specifics of the company's infrastructure is to write <b>wrapper-</b> containing changes (for example, reassigning attributes, changing recipes, etc.).  In short, the process of writing a wrapper is described in <a href="http://www.getchef.com/blog/2013/12/03/doing-wrapper-cookbooks-right/">this article</a> . <br><br>  But, having the right path does not mean that everyone will follow it.  That is why in the <i>repository of the</i> cookbooks of our company there turned out to be a lot of <i>community cookbooks</i> with unfair edits.  And it's time to clean the repository :) <br><br>  The plan was as follows: <br><br>  - select the <i>community cookbook</i> and in our repository; <br>  - assess the presence and number of local edits ( <i>diff</i> between identical versions of <i>cookbooks</i> ); <br>  - make changes to the <i>wrapper</i> and include a call to the <i>community cookbook</i> or recipe from it; <br>  - remove the <i>community cookbook</i> and add it to the <i>wrapper</i> dependencies. <br><br>  And what to do with the "cleaned" <i>community cookbooks</i> ?  How after removal - will they appear ‚Äúclean‚Äù on the <i>Chef Server</i> ? <br><br>  Just here <b>Berkshelf</b> comes to the <b>rescue</b> . <br><br><h2>  What is Berkshelf and what is it eaten with? </h2><br><br>  Berkshelf is <b>a</b> <b>dependency</b> <b>manager</b> for <i>Chef cookbooks</i> .  It is written in Ruby and has methods and APIs for interacting with the <b>Chef Server</b> . <br>  The <b>Berkshelf</b> installation comes from Ruby Gems <i>either</i> through the use of <a href="http://www.getchef.com/downloads/chef-dk/windows/">Chef DK</a> . <br>  We are using <b>Berkshelf</b> version <b>2.0</b> , however, version 3.0 was recently released, which brought some changes and ‚Äúbuns‚Äù. <br>  If you decide to use <i>Ruby Gem</i> - I advise you to install it within the framework of <i>Ruby</i> installed by <i>Chef Server</i> (the executable files are on the path - <i>/ opt / chef / embedded / bin /</i> ). <br>  To interact with Chef Server, you must configure Berkshelf, indicating to it the address of our server and certificates for authorization on it.  To <b>configure,</b> you must run the following command: <br><pre><code class="bash hljs">berks configure</code> </pre> <br>  <b>The configuration</b> files are in one of the following paths: <br><pre> <code class="hljs lua">$PWD/.berkshelf/<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.json $PWD/berkshelf/<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.json $PWD/berkshelf-<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.json $PWD/<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.json ~/.berkshelf/<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.json</code> </pre> <br>  After you have correctly installed <b>Berkshelf</b> , you can proceed to resolving <b>dependencies for</b> <i>cookbooks</i> . <br>  For this, <b>Berkshelf</b> first copies the <i>cookbook</i> and their <b>dependencies</b> to their <i>shelf</i> (local storage / repository <i>Berkshelf</i> , the default is <i>~ / .berkshelf / cookbooks /</i> ), and then uploads everything to the <i>Chef Server</i> . <br>  Immediately there are questions: " <i>How does Berkshelf know about dependencies?</i> ", " <i>What does he do to resolve them?</i> " <br>  <b>Berkshelf instructions</b> are contained in the <i>Berksfile</i> , located in the root directory of the <i>cookbook</i> .  This file is created using the command <pre> <code class="bash hljs">berks init</code> </pre>  in the root directory. <br>  The contents of this file describe the dependencies and the source for resolving them.  An example of such a file: <br><br><pre> <code class="ruby hljs">site <span class="hljs-symbol"><span class="hljs-symbol">:opscode</span></span> metadata cookbook <span class="hljs-string"><span class="hljs-string">'my-cookbook'</span></span>, (<span class="hljs-symbol"><span class="hljs-symbol">:path</span></span> <span class="hljs-params"><span class="hljs-params">| :git |</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:github</span></span>) cookbook <span class="hljs-string"><span class="hljs-string">'my-book-2'</span></span>, (<span class="hljs-string"><span class="hljs-string">'&gt; 1.0.0'</span></span>)</code> </pre><br><br>  This file is prescribed as follows: <br>  - take into account the dependencies from the <b>metadata.rb</b> file of our cookbook and download them from the <i>Opscode Community</i> site; <br>  - <b>my-cookbook</b> will be loaded along the path specified in brackets (this can be either a <i>local</i> path or a link to <i>Git</i> ); <br>  - The <b>my-book-2 of the</b> latest version, higher than 1.0.0, will be downloaded from the <i>Opscode Community</i> site. <br><br>  After that, you can run <pre> <code class="bash hljs">berks install</code> </pre>  and wait for the successful copying of dependencies to the <i>Berkshelf</i> local storage.  As a result, the storage directory should contain all the <i>cookbooks,</i> and those mentioned in the <b>depends</b> field of the <b>metadata.rb</b> file, their <b>dependencies</b> (dependencies), and the two <b>cookbooks</b> mentioned in the <i>Berksfile</i> .  You can verify the result with the command <pre> <code class="bash hljs">berks shelf list</code> </pre> <br>  The next step is to launch <pre> <code class="bash hljs">berks upload</code> </pre>  which will download everything from local storage to the <i>Chef Server</i> .  As a result (provided that the <i>Chef Server</i> is available and we can log in using the certificate files) - all dependencies will be resolved.  The result of the download can be checked with the command <pre> <code class="bash hljs">knife cookbook list</code> </pre>  the output of which should contain new <i>cookbooks</i> -and <br><br>  Essentially, this is the whole process of basic use of <b>Berkshelf</b> .  Of course, this is not all the functionality, because  <b>Berkshelf</b> interaction with <i>Vagrant</i> , <i>Chef Solo</i> , <i>Chef Client</i> , and also some innovations of version 3.0 are not mentioned.  However, I think this is enough for most. <br><br><h2>  Our history of using Berkshelf </h2><br>  Everything would be fine if again not one ‚Äúbut‚Äù - <b>Berkshelf</b> does not know how to work cyclically.  I am very surprised, because  I did not find an option in which he could " <i>natively</i> " take into account the nesting of directories with a <i>cookbook</i> , they are a kind of <i>nested</i> mode.  What I mean? <br>  For example, imagine a typical situation, there is a <i>chef-repo</i> directory in which the <i>cookbooks</i> directory is embedded, which contains our cookbooks ( <i>./chef-repo/cookbooks/</i> ). <br>  In the current version of <b>Berkshelf</b> - it is necessary to go to each of the cookbook directories and execute commands related to <b>Berkshelf in it</b> .  That is - a <b>bash</b> script that would do it, not with your own hands, in fact ... This is a solution, but alas - not the best, frankly speaking - ‚Äúa crutch‚Äù. <br>  On the Internet, <a href="https://coderwall.com/p/j72egw">an article</a> was found in which using Ruby-code, this issue was solved. <br>  I will give the code of our " <i>root</i> " Berksfile, located in the directory <i>./chef-repo/</i> : <br><br><pre> <code class="ruby hljs">site <span class="hljs-symbol"><span class="hljs-symbol">:opscode</span></span> metadata <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dependencies</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(path)</span></span></span></span> berks = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{path}</span></span></span><span class="hljs-string">/Berksfile"</span></span> instance_eval(File.read(berks)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> File.exists?(berks) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> Dir.glob(<span class="hljs-string"><span class="hljs-string">'./cookbooks/*'</span></span>).each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|path|</span></span> dependencies path cookbook File.basename(path), <span class="hljs-symbol"><span class="hljs-symbol">:path</span></span> =&gt; path <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> cookbook <span class="hljs-string"><span class="hljs-string">'gecode'</span></span>, <span class="hljs-string"><span class="hljs-string">'= 2.1.0'</span></span></code> </pre><br><br>  In fact, this piece of code is going to the contents of all the directories of <i>cookbooks</i> (their <b>metadata.rb</b> and <b>Berksfile</b> ) in the ‚Äú <i>root</i> ‚Äù Berksfile. <br><br>  We successfully applied the proposed solution and voila - all the <i>cookbooks</i> were on our <i>Chef Server</i> . <br>  However, in the mentioned article one <b>big</b> feature was not mentioned - <b>the</b> <i>Berksfile</i> <b>format of</b> our <i>cookbooks</i> . <br>  Experimentally, it was found that they should look like this: <br><pre> <code class="ruby hljs">group <span class="hljs-symbol"><span class="hljs-symbol">:name_of_cookbook</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> cookbook <span class="hljs-string"><span class="hljs-string">'my-cookbook'</span></span>, (<span class="hljs-symbol"><span class="hljs-symbol">:path</span></span> <span class="hljs-params"><span class="hljs-params">| :git |</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:github</span></span>) cookbook <span class="hljs-string"><span class="hljs-string">'my-book-2'</span></span>, (<span class="hljs-string"><span class="hljs-string">'&gt; 1.0.0'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  That is, a list of <i>cookbooks</i> that must meet <b>certain conditions</b> ‚Äî for example, a version or location that is enclosed in a <b>group</b> (so that the same dependencies of different cookbooks do not cause multiple entry conflicts).  All other dependencies are taken from the file <b>metadata.rb</b> .  Under the cut - a specific example, so that it was clearer: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="ruby hljs">group <span class="hljs-symbol"><span class="hljs-symbol">:database</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> cookbook <span class="hljs-string"><span class="hljs-string">'postgresql'</span></span>, <span class="hljs-string"><span class="hljs-string">'= 3.3.4'</span></span> cookbook <span class="hljs-string"><span class="hljs-string">'aws'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:path</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'./cookbooks/aws'</span></span> cookbook <span class="hljs-string"><span class="hljs-string">'xfs'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:path</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'./cookbooks/xfs'</span></span> cookbook <span class="hljs-string"><span class="hljs-string">'mysql'</span></span>, <span class="hljs-string"><span class="hljs-string">'= 4.1.2'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></div></div><br>  As a result, for the <i>cookbook</i> <b>database,</b> 4 <i>cookbooks</i> will be downloaded that meet certain conditions, as well as all the other dependencies mentioned in <b>metadata.rb</b> , as well as the dependencies mentioned (for excuse the tautology). <br>  All that remains to be done after editing the <i>Berksfiles of</i> our cookbooks is to run the commands in the <i>./chef-repo</i> directory <i>.</i> <pre> <code class="bash hljs">berks install &amp;&amp; berks upload</code> </pre> <br>  Here is a solution, perhaps not very reliable or convenient - but a solution.  Worked with our repositories several times successfully. <br>  If someone came across this issue and can share <i>experience</i> - write comments or PM. <br><br>  Thank you all for your attention, to new articles. <br><br>  <b>PS</b> A colleague says that Berkshelf v.3.0 is broken, so we do not recommend it! </div><p>Source: <a href="https://habr.com/ru/post/221791/">https://habr.com/ru/post/221791/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../221777/index.html">Tax deduction for programmers (program authors)</a></li>
<li><a href="../221779/index.html">The dark side of the ZRF</a></li>
<li><a href="../221781/index.html">Processes in the development of the payment system</a></li>
<li><a href="../221785/index.html">Ps. "" Anti "terrorist" package of bills</a></li>
<li><a href="../221789/index.html">Social media is nonsense. The Brandon Mendelsohn Book</a></li>
<li><a href="../221795/index.html">Zabbix + Communigate Pro: we monitor the message queue on the selected domains and hosts</a></li>
<li><a href="../221797/index.html">How we didn't earn a million on an iPhone app.</a></li>
<li><a href="../221799/index.html">Colocation, normal and not very</a></li>
<li><a href="../221801/index.html">Linus Torvalds received the IEEE Computer Pioneer award</a></li>
<li><a href="../221803/index.html">VPS Optimization Checklist for PHP / Mysql / Nginx</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>