<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CDN do it yourself or distribute video content</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="[Part I. Delivery of video content] [Part II. CDN do it yourself] 

 In continuation of the topic about the delivery of video content : we ensured the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CDN do it yourself or distribute video content</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/blogs/webdev/46134/">[Part I. Delivery of video content]</a> [Part II.  CDN do it yourself] <br><br>  In continuation of the topic about the <a href="http://habrahabr.ru/blogs/webdev/46134/">delivery of video content</a> : we ensured the storage and processing of content, how can we now deliver the content so that it is as close as possible to the consumer?  Most of the article will be devoted to a generalized approach of geographically distributed distribution of content, and at the end, as an example, the described approach will be applied to the delivery of video files and broadcasts to end users. <br><br>  In addition to the fact that the content was delivered to the user, we must ensure the quality of content delivery.  For a FLV video file, this means that the speed with which it is delivered to the user must be higher or equal to the bitrate of the stream, otherwise the video from the user will ‚Äúshut up‚Äù when viewed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In addition, it makes sense to ‚Äúbring‚Äù content to the user geographically.  This is due to the bandwidth of the channels (sometimes lacking good trunk channels), as well as the difference in the cost of local and external traffic for the end user (for example, in regions of the Russian Federation). <br><br>  Such a step must be made if one wishes to enter the international market, as well as with regional development within the Russian Federation.  Today in the regions very often the most popular sites are regional portals that provide various services, including a video hosting service, and their popularity is due to both the cost of traffic and the access speed / response time.  You can imagine that the user is ready to wait for the page to open, to load the player, but it‚Äôs hard to assume that the user agrees to watch videos that are interrupted due to constant buffering, or to watch a broadcast that reaches the user in the form of a slideshow video). <br><br>  Thus, having realized the need for geographical distribution for content, we buy / rent servers in close proximity to the consumer: in Europe, the USA, Ukraine, Yekaterinburg, etc. <br><br><a name="habracut"></a><br><br><h2>  Work mechanism </h2><br>  In the abstract, two entities are involved in the content delivery process: a resource, our content (for example, broadcasting or video), and a visitor.  It is necessary to begin to find out where our consumer resource is - a visitor to our site.  We don‚Äôt have to hope that he will tell this information about himself, so we take the visitor‚Äôs IP address, perform a search in the GeoIP database (of which there are quite a few today, both paid and free), and we get the output information about the user's location : his country, region, city, name of his provider. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1a8/980/0ac/1a89800acc2a83d2fb087e4af309fd0d.png" alt=" IP" title="Visitor - GeoIP" width="358" height="176"><br><br>  The resource (content) is always located on a specific server, and the server has its own physical location, which we know in advance.  Therefore, the resource through the server also has its geographical location: the same country, region, city, etc.  In addition, we can create copies of the resource on special mirroring servers, thus the same resource will be available on several servers, and therefore, in several geographic points. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dcc/a6a/f30/dcca6af3021f02c088e8aa6e62a9dd3e.png" alt="    " title="Resource and location on servers" width="427" height="215"><br><br><h2>  Choosing the resource nearest to the visitor </h2><br>  Now we have a visitor, his location, the resource he wants to receive, as well as all copies of this resource with their locations.  Now you need to select the copy of the resource that is closest to the user.  How can I do that? <br>  It would be logical to calculate the distance from the visitor to the resource and all its copies and select the copy of the resource closest to the visitor.  How to set this distance? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b8c/aba/4d2/b8caba4d27726d4535b97d0c429017b1.png" alt="   " title="Count of distances between cities" width="439" height="259"><br><br>  This distance does not always coincide with the distance on the map between two points, and is rather a measure of the quality and capacity of the channels between regions, countries or cities (or even between individual providers).  In the first approximation, it is enough to set the distance between individual countries and cities.  An example of such a distance arrangement is shown in the figure above. <br><br>  Thus, we get a weighted oriented graph on which we need to solve the problem of finding the shortest path (minimizing the sum of the weights of the edges of the graph included in this path).  This is a classic problem that can be easily solved in polynomial time.  Although the graph is loosely coupled, its dimensions are still quite large (in the example above, only a small part of the real graph is displayed), so real-time calculation for each visitor is not the most effective solution.  But we can ‚Äúcheat a little‚Äù: we know that for all searches for the shortest path, the end point of the path will be the places where the servers with resources are located, thus the number of different end points of the desired path is fixed and relatively small.  Now it is enough for us to calculate and cache, for example, in memcached, the lengths of the shortest paths from all vertices of the graph (where visitors of our site can be located) to the locations of resources. <br><br>  Already this processed information will be used in real time when a visitor requests for a resource.  If we find several copies of the resource, which will reach the shortest distance from the visitor, we will select any of the copies randomly (possibly, in accordance with the weight of the server where the resource is located). <br><br><h2>  Copying resource </h2><br>  The selection scheme works great when we have copies of the resource on servers scattered around the world.  However, how are these copies made?  It would be unreasonable to copy all resources to all servers, it is better to choose those resources that will be in demand by a specific audience. <br><br>  To do this, we propose the following solution: when a visitor applies for a resource, all geographic places where the resource could be, but is not currently located, receive a bonus: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/afb/eb9/a1f/afbeb9a1f1ebdda5b905eded0d99044d.png" alt="  " title="Bonus calculation formula" width="144" height="45"><br><br>  where <em>distance</em> is the distance from the visitor to a given geographical location, and <em>k</em> is a certain coefficient that determines how quickly the resource will be moved to the specified server.  If there is no way from the visitor to this place (ie, the visitor is far away), then the distance will be equal to infinity, and the bonus will be zero.  If the path exists, the resource will be copied to the server at this point the faster, the closer it is to the visitor and the more such visitors ask for access to this resource. <br>  As soon as the bonus exceeds a certain threshold, the resource is copied to the server located in this geographic location, and the algorithm for selecting a copy of the resource described above already comes into play. <br><br><h2>  Geographically Distributed Video Files and Broadcasts </h2><br>  Now we can apply the above approach to the content of the video hosting: broadcasting and video. <br><br>  <strong>Video files</strong>  In this case, the resource is the video file itself (of any type, like FLV, for example, the original video).  Resource Copies ‚Äî Copies of a file that reside on mirroring file servers.  Accessing a resource ‚Äî downloading a file, playing a FLV video by a visitor in Flash Player.  Copying a resource is simply copying a file from the main file server to one of the mirroring file servers located at different points. <br><br>  <strong>Broadcasting</strong> .  For broadcasting, the situation is very similar, here the resource is, of course, the broadcast itself, located on the main broadcasting server for it (the server to which the broadcast author is connected).  Copies of the resource are all retransmissions of this broadcast on other broadcast servers.  Appeal to the resource is the ‚Äúentrance‚Äù to the broadcast of a new visitor.  Copying a resource is opening a relay on a broadcast server located in a particular point in the world. <br><br>  In the case of broadcasting, it is interesting that relaying is at the same time a way to deal with high load and means of bringing content closer to the consumer, that is, relaying is carried out simultaneously in two planes: on the one hand, to satisfy the requests of all users with the most closely located content.  On the other hand, it is necessary to ensure in each geographic point such a number of retransmissions so that the load on the broadcast servers remains normal. </div><p>Source: <a href="https://habr.com/ru/post/46239/">https://habr.com/ru/post/46239/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../46234/index.html">Eclipse, pydev and code highlighting</a></li>
<li><a href="../46235/index.html">Unfinished article on spam</a></li>
<li><a href="../46236/index.html">No Comments</a></li>
<li><a href="../46237/index.html">School, trainings, mega trainings and super trainings</a></li>
<li><a href="../46238/index.html">PHP 5.3 alpha 3 released</a></li>
<li><a href="../46240/index.html">Prototype & Ajax.Request: an important point when catching problems on the server</a></li>
<li><a href="../46242/index.html">Get Gmail Stickers</a></li>
<li><a href="../46243/index.html">Broadcast of the final cup of innovative projects</a></li>
<li><a href="../46244/index.html">Say a word about a poor provider</a></li>
<li><a href="../46245/index.html">How has the water changed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>