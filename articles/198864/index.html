<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Social network without a server. Development history of the iOS client and backend</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Intro 
 I want to talk about the experience of developing an iOS client for a social network and a backend implemented using BaaS Parse.com. The follo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Social network without a server. Development history of the iOS client and backend</h1><div class="post__text post__text-html js-mediator-article"><h4>  Intro </h4><br>  I want to talk about the experience of developing an iOS client for a social network and a backend implemented using BaaS <a href="http://parse.com/">Parse.com. The</a> following is the architecture that we got, some tips &amp; tricks and thoughts about working with parse.com. <br>  Initially, the client thought about the server on RoR, but apparently they did not dare to invest a lot of money at once.  We signed a strict NDA, so I can‚Äôt give a link to the Appstore.  By the good tradition of all IT books, I want to thank customer X and company Y for having had the opportunity to work on this project and learn from all this experience.  Also, thanks to A. for writing the part about the module for embedded purchases. <br><a name="habracut"></a><br><h4>  Architecture </h4><br>  I have seen and heard many times about projects that exchanged between different developers and at the same time lost the integrity of the idea, so I decided to write a small document that sets out the basic principles on which I built the architecture of the application.  I believe that for the most part, all the experience I gained on this project was concentrated in it. <br><div class="spoiler">  <b class="spoiler_title">Screenshot of the Xcode project structure</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/fe0/345/734/fe034573418baede705f4d84946ca2f4.png" alt="image"></div></div><br><br><h5>  Logical layers </h5><br><h6>  Work with network </h6><br>  In the application we work with two services: <a href="http://www.pubnub.com/">PubNub</a> and <a href="http://parse.com/">Parse</a> .  All interaction with the SDK of these services occurs on this layer. <br><ul><li>  Message center <ul><li>  PubNub SDK </li></ul></li></ul><br><ul><li>  Parse services <br>  Parse has its own iOS SDK, but we didn‚Äôt want to become strongly attached to it, because the client said that they plan to launch their server later.  Therefore, we used the Parse RESTfull API, which we interacted with through AFNetworking.  We transferred all the business logic that could be transferred to the server to the <a href="https://parse.com/docs/cloud_code_guide">cloud code</a> - it turned out that each request caused the server code.  In principle, it was possible to create complex queries by stuffing parameters into the NSDictionary, but after I figured out Backbone.js, on which the cloud code is written, I began to do everything there - this is much more readable and better amenable to change.  As a result, the application sent only one request to the server for each user action.  Only on login and update screens with different information sent more requests. </li></ul><br><h6>  Ui </h6><br>  This layer is the easiest - there is only ViewControllers, Views, Cells and an additional controller that helps in navigation and implements various tricks with showing screens in unexpected places.  For example, if a user logs in via facebook, he shows a screen with the fields that the user must fill out if they are not in his facebook account.  Also located here are controllers that respond to push notification.  We needed to do drag-n-drop for the UICollectionView ‚Äî as a result, we used a ready-made implementation: <a href="https://github.com/lxcid/LXReorderableCollectionViewFlowLayout">github.com/lxcid/LXReorderableCollectionViewFlowLayout</a> .  I had to podshamanit a little, but, in general, you can use the code. <br>  I can also recommend <a href="https://github.com/emenegro/pull-to-refresh/tree/master/pull-to-refresh/MNMPullToRefresh">MNMPullToRefresh</a> if you need pull to refresh control for UITableView. <br><br><h6>  Data </h6><br>  We use Magic Recording to work with CoreData: there are no other additional classes, except for the class that connects to the database of a specific user. <br><ul><li>  Core data <ul><li>  Magic Recording </li><li>  DataBaseManager class </li></ul></li><li>  Datasources <br>  Separate classes for UIViewController, which contains the logic of interaction with the database and server. </li><li>  Models <br>  We have two main types of models - local database models and intermediate information models that come to us from the server. </li></ul><br><h6>  Synchronization Layer </h6><br>  The logical layer on which we translate objects received from the server into database objects and vice versa (if necessary).  If there is no object with the current id, we add it to the database.  If there is, then just update the information from the server. <br>  For models with a large number of fields, a generalized method of filling them with values ‚Äã‚Äãis implemented using runtime functions: <br><div class="spoiler">  <b class="spoiler_title">watch code</b> <div class="spoiler_text"><pre><code class="hljs objectivec">-(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)syncLocal:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)local withClass:(Class)localClass fromParse:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)parse{ <span class="hljs-built_in"><span class="hljs-built_in">NSAssert</span></span>([parse isKindOfClass:[UserStatistic <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]], <span class="hljs-string"><span class="hljs-string">@"wrong class"</span></span>); UserStatistic*stat =(UserStatistic*)parse; LocalUserStatistics* newLocalStat = (LocalUserStatistics*)local; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!newLocalStat) newLocalStat=[<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> syncLocal:local withClass:localClass fromParse:parse]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> outCount; Protocol* protocol = objc_getProtocol(<span class="hljs-string"><span class="hljs-string">"StatisticsProtocol"</span></span>); objc_property_t *propList = protocol_copyPropertyList(protocol, &amp;outCount); <span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span>* noSetProps = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> propertiesDontNeedToSet]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)outCount; i++) { objc_property_t * oneProp = propList + i; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *propName = [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithUTF8String:property_getName(*oneProp)]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([noSetProps indexOfObject:propName]==<span class="hljs-built_in"><span class="hljs-built_in">NSNotFound</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> newValue =[stat valueForKey:propName]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(newValue &amp;&amp; newValue!=[<span class="hljs-built_in"><span class="hljs-built_in">NSNull</span></span> null]){ [newLocalStat setValue:newValue forKey:propName]; } } } free(propList); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newLocalStat; }</code> </pre> </div></div><br><ul><li>  ParseObjectsSync <br>  Layer for synchronization of arrays of objects - calls the appropriate class from the ParseObjectSync layer for the corresponding model </li><li>  ParseObjectSync <br>  The layer on which the logic is described, where we assign the Core Date model to each Parse model.  Also convert fields if necessary. </li><li>  Chat engine <br>  The UI works with the network and the database only through a layer of synchronization classes.  The Chat Engine class also lies between UI and Pubnub with CoreDate.  It turned out to be large enough, but not so much that it was possible to distinguish from it a separate class, which would be called according to the occupied layer.  Although, most likely, I just did not have the desire to do it. <br></li></ul><br><h6>  In app purchase </h6><br>  In the application, the domestic currency, Coins (Coins), was conceived from the very beginning, which the user can easily buy using the In-App Purchase mechanism, but there is always something to spend on that :).  From Apple's in-app purchase, they are a Consumable Product, i.e.  you need to be very careful about recording and accounting for the receipt / expenditure of coins, otherwise the user will lose money and be upset. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It was decided to make this thin layer without using third-party libraries.  We decided to keep the Coins ourselves in the User model on parse.com, and not locally.  This affected the way the completion code worked.  After all, we must wait for the moment when the Coins changes are written to parse.com and only after that do finishTransaction.  Here is a great place to use Block-a, which stores the context for completing a transaction while we make a request to the server.  This approach gave us the opportunity to log in from different devices and always have up-to-date information about the current user's Coins. <br><br>  Another thing that is not usually done: SKPaymentTransactionObserver (the class that implements this protocol) must be created when the application starts and live its whole life, as there may come an incomplete transaction that was not completed during the last application launch.  We did not create our Singleton here. <br><br><h6>  Work Circle Controller </h6><br>  In the course of development, more and more actions appeared that had to be carried out in a specific period of time and between such and such a request.  For example, to maintain the consistency of the local database, it was necessary to first load the user's pictures, and only then the chats that refer to these pictures.  There were also a lot of nuances in business logic: show a screen with required fields to fill in if the user registered via facebook and subscribe to push notifications after login, because it‚Äôs not a fact that the login will happen simultaneously with the receipt of the token.  You also need to unsubscribe from push notifications after logout, initialize some services immediately after launch, and others only after login.  After all the logic of the sequence of launching the services and the life of the application was concentrated in a separate class, it became much easier to live.  The class, by the way, is not a singleton - it lives in AppDelegate.  As a result, only 146 lines of code remained in AppDelegate. <br><br><h5>  Work with Parse.com </h5><br><br>  In general, I liked working with Parse, but it is still not clear how applications with which traffic volume can work stably.  At the moment, the service gives the following limits for one account (Pro plan): <br>  <a href="https://www.parse.com/questions/burst-limit">Burst limit</a> : 40 requests per second <br>  <a href="https://parse.com/questions/code-154the-number-of-count-operations-in-progress-has-reached-its-limit-code-154-version-1125">API requests limit</a> : 160 - you will not find this in the documentation (at the time of writing this is not) <br>  Restriction on the execution of the cloud code function: 15 seconds <br>  Background job limit: 15 minutes <br><br>  Our application has not yet gained a large number of users, and it is not entirely clear how it will behave in production, but there are doubts about this.  The application is already reaching a limit on the number of API requests.  I contacted the Parse team about the transition to the Enterprise plan with the following characteristics: <br><br>  Total users: 1000 <br>  Users performing request in the same time: 500 <br>  API requests performing in the same time: 1000 <br>  API calls burst limit: 1000 <br>  Cloud code burst limit: 2000 <br><br>  They replied that 1000 requests per second would cost $ 14,000 per month.  After that, I asked them how to reduce the number of requests, and described the operation of our application.  They replied that 1000 requests per second for our application is fully justified, and it is unlikely to be able to do less. <br><br>  At Parse, for the time being, one cannot simply raise another environment for testing and development on the same database model.  We have to create a new application and almost manually create the same data model. <br><br>  In terms of restrictions on the number of requests Parse loses <a href="http://kinvey.com/">Kinvey</a> .  I specifically learned about this restriction from Kinvey, and this is what they answered: "You can get for $ 1,400 per month you can get BaaS, on which there can be 50,000 active users per month, 3 environments, and business logic is limited to 50 scripts.  At the same time, one support script was defined as follows: S lot S S S S S S S S S S S S BL BL so desires. ‚ÄùHow everything works in practice, I do not know, but it looks attractive. <br><br><h6>  Cloud code on Backbone.js </h6><br><br>  As a person who wrote only in languages ‚Äã‚Äãwith strict typing and never touched the backend, it was very interesting for me to learn backbone.js.  The main difficulties encountered: <br><ul><li>  Callback hell. <br>  decided using the <a href="https://github.com/caolan/async">async.js</a> library </li><li>  Debugging <br>  For writing code I used Sublime.  Then I came across a post about how to set up the environment in Cloud9, and on the same day I found a message from the author of this instruction, in which he shared a problem: after updating the service to deploy the Parse code to the Parse server, everything stopped working because the python version on Cloud9 does not support some features.  As a result, everything remained on Sublime, and debugging occurred only after deploy and running the code on the server </li><li>  Testing. <br>  See below.  It deserves a separate chapter. </li></ul><br><br><h6>  Integration testing </h6><br><br>  Preparing the environment for testing <br>  As one smart person said, the most difficult thing in tests is setting up an environment for testing. <br>  In the course of development, more and more logic accumulated on the server code and more and more scripts appeared for testing.  It became clear that without automatic tests, the writing of the cloud code would take an enormous amount of time.  As I wrote above, debugging was possible only after deploying to the server, until the code was run it was impossible to even know about the presence of syntax errors, only if they are not directly related to deployment. <br>  As a result, we set up an environment for testing.  In tests, we run all necessary services using Work Circle Controller.  Using the flags for the preprocessor, we install the code that we need to run for the test environment: <br><div class="spoiler">  <b class="spoiler_title">watch code</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> <span class="hljs-comment"><span class="hljs-comment">"WorkCircleController.h"</span></span> //<span class="hljs-type"><span class="hljs-type">UI</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> !<span class="hljs-type"><span class="hljs-type">TEST</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> <span class="hljs-comment"><span class="hljs-comment">"LoginViewsManager.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> //<span class="hljs-type"><span class="hljs-type">Net</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> &lt;<span class="hljs-type"><span class="hljs-type">Parse</span></span>/<span class="hljs-type"><span class="hljs-type">Parse</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> <span class="hljs-comment"><span class="hljs-comment">"ParseRESTClient.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> <span class="hljs-comment"><span class="hljs-comment">"StatisticService.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> <span class="hljs-comment"><span class="hljs-comment">"ProfilePicturesSync.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> !<span class="hljs-type"><span class="hljs-type">TEST</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> <span class="hljs-comment"><span class="hljs-comment">"ChatsEngine.h"</span></span> //<span class="hljs-type"><span class="hljs-type">Data</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> <span class="hljs-comment"><span class="hljs-comment">"DataBaseManager.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> <span class="hljs-comment"><span class="hljs-comment">"LocalUser.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> <span class="hljs-comment"><span class="hljs-comment">"LocalLockSlot.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> <span class="hljs-comment"><span class="hljs-comment">"LocalPicture.h"</span></span> //<span class="hljs-type"><span class="hljs-type">Sync</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> <span class="hljs-comment"><span class="hljs-comment">"SyncManager.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#import</span></span> <span class="hljs-comment"><span class="hljs-comment">"UserSync.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#else</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> !<span class="hljs-type"><span class="hljs-type">TEST</span></span> @interface <span class="hljs-type"><span class="hljs-type">WorkCircleController</span></span>(){ <span class="hljs-type"><span class="hljs-type">ProfilePicturesSync</span></span>* profilePicturesSync; } @property(nonatomic, weak) <span class="hljs-type"><span class="hljs-type">AppDelegate</span></span>* appDelegate; @property(nonatomic, strong) <span class="hljs-type"><span class="hljs-type">LoginViewsManager</span></span>* loginManager; @property(nonatomic, strong) <span class="hljs-type"><span class="hljs-type">NSData</span></span>* deviceToken; @end <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> @implementation <span class="hljs-type"><span class="hljs-type">WorkCircleController</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> !<span class="hljs-type"><span class="hljs-type">TEST</span></span> - (id)initWithDelegate:(<span class="hljs-type"><span class="hljs-type">AppDelegate</span></span>*)appDelegate { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> init]; if (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.appDelegate = appDelegate; profilePicturesSync = [<span class="hljs-type"><span class="hljs-type">ProfilePicturesSync</span></span> new]; } return <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; } <span class="hljs-symbol"><span class="hljs-symbol">#pragma</span></span> mark - <span class="hljs-type"><span class="hljs-type">Push</span></span> notification - (void)app:(<span class="hljs-type"><span class="hljs-type">UIApplication</span></span>*)application didRegisterForRemoteNotificationsWithToken:(<span class="hljs-type"><span class="hljs-type">NSData</span></span>*)deviceToken{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.deviceToken = deviceToken; if(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.state == <span class="hljs-type"><span class="hljs-type">LifeStateLoginDataAndNetLayersReady</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.state == <span class="hljs-type"><span class="hljs-type">LifeStateLoggedIn</span></span>) [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> subscribeToPushes:deviceToken]; } - (void)subscribeToPushes:(<span class="hljs-type"><span class="hljs-type">NSData</span></span> *)deviceToken { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> subscribeToParsePushes:deviceToken]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> subscribeToChatPushes:deviceToken]; } - (void)subscribeToParsePushes:(<span class="hljs-type"><span class="hljs-type">NSData</span></span> *)deviceToken { ... } - (void)subscribeToChatPushes:(<span class="hljs-type"><span class="hljs-type">NSData</span></span> *)deviceToken { ... } - (void)unsubscribeFromPushesInParseWithBlock:(void (^)(<span class="hljs-type"><span class="hljs-type">NSError</span></span> *error))block { ... } <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#pragma</span></span> mark - <span class="hljs-type"><span class="hljs-type">Pre</span></span> <span class="hljs-type"><span class="hljs-type">Login</span></span> <span class="hljs-type"><span class="hljs-type">Logic</span></span> -(void)setupPreLoginStateWithBlock:(void (^) (<span class="hljs-type"><span class="hljs-type">NSError</span></span>* error))block{ [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> prepareNetManagersForPreLoggin]; <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> !<span class="hljs-type"><span class="hljs-type">TEST</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> performUIUpdatesForPreLogginWithBlock:^(<span class="hljs-type"><span class="hljs-type">NSError</span></span> *error) { if(block) block(error); }]; <span class="hljs-symbol"><span class="hljs-symbol">#else</span></span> finishWithErrorBlock(<span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> } -(void)prepareNetManagersForPreLoggin{ [[<span class="hljs-type"><span class="hljs-type">ParseRESTClient</span></span> sharedClient] startParseService]; } <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> !<span class="hljs-type"><span class="hljs-type">TEST</span></span> -(void)performUIUpdatesForPreLogginWithBlock:(void (^) (<span class="hljs-type"><span class="hljs-type">NSError</span></span>* error))block { ... } <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#pragma</span></span> mark after register <span class="hljs-type"><span class="hljs-type">Login</span></span> <span class="hljs-type"><span class="hljs-type">Logic</span></span> - (void)afterRegistrationWithBlock:(void (^) (<span class="hljs-type"><span class="hljs-type">NSError</span></span>* error))block{ ... } <span class="hljs-symbol"><span class="hljs-symbol">#pragma</span></span> mark - <span class="hljs-type"><span class="hljs-type">Login</span></span> <span class="hljs-type"><span class="hljs-type">Logic</span></span> -(void)loginWithBlock:(void (^) (<span class="hljs-type"><span class="hljs-type">NSError</span></span>* error))block{ [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> prepareDataManagersForLogginWithBlock:^(<span class="hljs-type"><span class="hljs-type">NSError</span></span> *error) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> prepareNetManagersForLogginWithBlock:^(<span class="hljs-type"><span class="hljs-type">NSError</span></span> *_error) { <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> !<span class="hljs-type"><span class="hljs-type">TEST</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> performUIUpdatesForLogginWithBlock:^(<span class="hljs-type"><span class="hljs-type">NSError</span></span> *uIError) { if(block) block(uIError); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> performAfterLoginUpdatesWithBlock:^(<span class="hljs-type"><span class="hljs-type">NSError</span></span> *afterLoginError) { }]; }]; <span class="hljs-symbol"><span class="hljs-symbol">#else</span></span> if(finishWithErrorBlock) finishWithErrorBlock(error); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> }]; }]; } -(void)prepareDataManagersForLogginWithBlock:(void (^) (<span class="hljs-type"><span class="hljs-type">NSError</span></span>* error))block{ <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> !<span class="hljs-type"><span class="hljs-type">TEST</span></span> [<span class="hljs-type"><span class="hljs-type">DataBaseManager</span></span> setupDataBaseWithUserId:[<span class="hljs-type"><span class="hljs-type">PFUser</span></span> currentUser].email]; [[<span class="hljs-type"><span class="hljs-type">Settings</span></span> defaultSettings] setUsername:[<span class="hljs-type"><span class="hljs-type">PFUser</span></span> currentUser].email]; <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> block(<span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>); } -(void)prepareNetManagersForLogginWithBlock:(void (^) (<span class="hljs-type"><span class="hljs-type">NSError</span></span>* error))block{ [[<span class="hljs-type"><span class="hljs-type">ParseRESTClient</span></span> sharedClient] updateToken]; <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> !<span class="hljs-type"><span class="hljs-type">TEST</span></span> ... <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> block(<span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>); } <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> !<span class="hljs-type"><span class="hljs-type">TEST</span></span> - (void)performUIUpdatesForLogginWithBlock:(void (^) (<span class="hljs-type"><span class="hljs-type">NSError</span></span>* error))block{ ... } - (void)performAfterLoginUpdatesWithBlock:(void (^) (<span class="hljs-type"><span class="hljs-type">NSError</span></span>* error))block { ... } <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#pragma</span></span> mark - <span class="hljs-type"><span class="hljs-type">Logout</span></span> <span class="hljs-type"><span class="hljs-type">Logic</span></span> -(void)logoutWithBlock:(void (^)(<span class="hljs-type"><span class="hljs-type">NSError</span></span> *error))block{ <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> !<span class="hljs-type"><span class="hljs-type">TEST</span></span> ... <span class="hljs-symbol"><span class="hljs-symbol">#else</span></span> [<span class="hljs-type"><span class="hljs-type">PFUser</span></span> logOut]; [[<span class="hljs-type"><span class="hljs-type">ParseRESTClient</span></span> sharedClient] closeClient]; block(<span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> } - (void)deleteAccountWithBlock:(void (^)(<span class="hljs-type"><span class="hljs-type">NSError</span></span> *error))block{ [[<span class="hljs-type"><span class="hljs-type">ParseRESTClient</span></span> sharedClient] closeClient]; <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> !<span class="hljs-type"><span class="hljs-type">TEST</span></span> ... <span class="hljs-symbol"><span class="hljs-symbol">#else</span></span> [<span class="hljs-type"><span class="hljs-type">PFUser</span></span> logOut]; block(<span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>); <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> }</code> </pre> </div></div><br><br>  Next, we created separate classes in which we put the implementation of various scripts that the user can execute. <br>  In the base class, a single method is implemented: <br><br><pre> <code class="hljs objectivec"> - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) setUpWithBlock:(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (^) (<span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span>* error))block{ [<span class="hljs-built_in"><span class="hljs-built_in">NSURLRequest</span></span> setAllowsAnyHTTPSCertificate:<span class="hljs-literal"><span class="hljs-literal">YES</span></span> forHost:<span class="hljs-string"><span class="hljs-string">@"api.parse.com"</span></span>]; <span class="hljs-comment"><span class="hljs-comment">//  ,  iOS      https   .   . self.workCircleController = [WorkCircleController new]; [self.workCircleController setupPreLoginStateWithBlock:^(NSError *error) { block(error); }]; }</span></span></code> </pre> <br><br>  Next, we created an environment and logic for two users and for individual scenarios.  Since the interaction with the server is asynchronous, we used <a href="">SRTAdditions.h</a> to get the kalbek and perform the tests correctly. <br>  Idea development <br>  The main goal of this approach was to reduce the time spent on testing different scenarios.  I think it‚Äôs realistic to set up Jasmine or Mocha on Parse, so some cases would be easier to solve through unit tests, but overall the integration tests were fully justified: the builds became more stable, the time to develop new features for the cloud code decreased, and It was playing tennis while all the tests were being done. <br><img src="https://habrastorage.org/getpro/habr/post_images/32d/746/6bc/32d7466bc553e4dc2e06365a347c6378.png" alt="image"><br>  After I started playing too much time in tennis, the authorities <a href="http://hudson-ci.org/">got</a> worried and decided to pick up the server at <a href="http://hudson-ci.org/">hudson-ci.org</a> , which takes the latest code from git, and runs sh scripts that run the tests.  To run tests and beautifully display logs, <a href="https://github.com/facebook/xctool">xtool was</a> used.  By the way, when running through the console, the tests do not start the simulator, and you can continue to work on the code while the tests are performed. <br><br><h6>  Localization </h6><br>  For localization, I finally began to use a very simple <a href="https://github.com/angelolloqui/AGi18n">tool</a> : <a href="https://github.com/angelolloqui/AGi18n">agi18n</a> <br><br><h6>  Tips &amp; Tricks </h6><br><ul><li>  Why it is necessary to include warnings in draft <a href="http://boredzo.org/blog/archives/2009-11-07/warnings">article 1</a> , <a href="http://lightyearsoftware.com/2013/03/xcode-hard-mode/">article 2</a> </li><li>  Snippets ( <a href="http://runmad.com/blog/2012/09/xcode-code-snippets-and-syncing/">sharing via dropbox</a> ): <ul><li> <code>__weak typeof(self) weakSelf = self;</code> </li> <li> <code>(void (^)(NSError *error))&lt;#block#&gt;</code> </li> </ul></li><li>  <a href="http://github.com/NYTimes/objective-c-style-guide">Code style from the New York Times</a> </li><li>  <a href="http://revealapp.com/">Reveal</a> .  A very curious debugging tool for UI.  It is very convenient when it is unclear where I‚Äôve left the view or when they give for support a new big project and not enough time to figure out how the architecture of the view controllers is arranged and where I look at. </li><li>  convenient to generate countless icons of various sizes <br>  <a href="http://www.gieson.com/Library/projects/utilities/icon_slayer/">www.gieson.com/Library/projects/utilities/icon_slayer</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/198864/">https://habr.com/ru/post/198864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198854/index.html">From the creators of Indexisto - ‚ÄúSearch for Habr II‚Äù</a></li>
<li><a href="../198856/index.html">FailConf-2013: conference on errors in IT business</a></li>
<li><a href="../198858/index.html">Universal Electronic Card (UEC) and its future</a></li>
<li><a href="../198860/index.html">Handwriting Recognition Appears in Gmail and Google Docs</a></li>
<li><a href="../198862/index.html">Vuforia: a bit of magic in our reality</a></li>
<li><a href="../198866/index.html">New version of Yandex Browser: search by page, taking into account morphology and gesture support</a></li>
<li><a href="../198868/index.html">The history of mistakes: how we built and lost a business with a turnover of 500,000 dollars a year</a></li>
<li><a href="../198870/index.html">Management tools: How to explain when you feel one place?</a></li>
<li><a href="../198872/index.html">Concept: how to improve iMessage</a></li>
<li><a href="../198874/index.html">Li-Fi: how the LED light turns into a modem</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>