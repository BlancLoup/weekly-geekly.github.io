<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Make reflection fast as direct calls.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most programmers are aware of reflection , which (it‚Äôs a reflection) makes it easy to add dynamic capabilities to static languages ‚Äã‚Äãsuch as Java / C ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Make reflection fast as direct calls.</h1><div class="post__text post__text-html js-mediator-article">  Most programmers are aware of <a href="http://java.sun.com/docs/books/tutorial/reflect/">reflection</a> , which (it‚Äôs a reflection) makes it easy to add dynamic capabilities to static languages ‚Äã‚Äãsuch as Java / C #.  However, reflection is blamed for the fact that calls work very slowly - up to 500 times slower.  Nevertheless, this can be easily corrected - we will show in this article how to make a reflection-call as fast as a direct call. <br><a name="habracut"></a><br><br>  Measure the speed of the next class: <br><br><blockquote><code><a href="http://s-c.me/3079/s"></a> <a href="http://s-c.me/3079/h"></a> <font color="black">Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#2b91af">A</font> { <font color="#0000ff">public int value</font> = <font color="#A31515">0</font> ; <font color="#0000ff">public void</font> add( <font color="#0000ff">int</font> x) { <font color="#0000ff">value</font> += x; } }</font></code> <ol> <li> <code><font color="black"><a href="http://s-c.me/3079/s"></a> <a href="http://s-c.me/3079/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#2b91af">A</font> { <font color="#0000ff">public int value</font> = <font color="#A31515">0</font> ; <font color="#0000ff">public void</font> add( <font color="#0000ff">int</font> x) { <font color="#0000ff">value</font> += x; } }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/3079/s"></a> <a href="http://s-c.me/3079/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#2b91af">A</font> { <font color="#0000ff">public int value</font> = <font color="#A31515">0</font> ; <font color="#0000ff">public void</font> add( <font color="#0000ff">int</font> x) { <font color="#0000ff">value</font> += x; } }</font></code> </li> <li></li><li> <code><font color="black"><a href="http://s-c.me/3079/s"></a> <a href="http://s-c.me/3079/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#2b91af">A</font> { <font color="#0000ff">public int value</font> = <font color="#A31515">0</font> ; <font color="#0000ff">public void</font> add( <font color="#0000ff">int</font> x) { <font color="#0000ff">value</font> += x; } }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/3079/s"></a> <a href="http://s-c.me/3079/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#2b91af">A</font> { <font color="#0000ff">public int value</font> = <font color="#A31515">0</font> ; <font color="#0000ff">public void</font> add( <font color="#0000ff">int</font> x) { <font color="#0000ff">value</font> += x; } }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/3079/s"></a> <a href="http://s-c.me/3079/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#2b91af">A</font> { <font color="#0000ff">public int value</font> = <font color="#A31515">0</font> ; <font color="#0000ff">public void</font> add( <font color="#0000ff">int</font> x) { <font color="#0000ff">value</font> += x; } }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/3079/s"></a> <a href="http://s-c.me/3079/h"></a> Copy Source | Copy HTML <font color="#0000ff">class</font> <font color="#2b91af">A</font> { <font color="#0000ff">public int value</font> = <font color="#A31515">0</font> ; <font color="#0000ff">public void</font> add( <font color="#0000ff">int</font> x) { <font color="#0000ff">value</font> += x; } }</font></code> </li> </ol></blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I measured the speed on a Core 2 Duo E6300, Windows Vista, JRE 1.6.0_16.  The Timer class is an auxiliary class for measuring time.  For the measurement we will make 5 million calls of each method.  Let's start with direct access to the class field: <br><br><blockquote> <code><a href="http://s-c.me/3080/s"></a> <a href="http://s-c.me/3080/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  t.start ( <font color="#A31515">"Direct field access"</font> ); </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = <font color="#A31515">0</font> ; i &lt;LOOPS_IN_STEP_COUNT; ++ i) { </li><li>  a.  <font color="#0000ff">value</font> + = i; </li><li>  } </li><li>  t.stop (); </li></ol></blockquote><br><br>  5000000 iterations performed in 44ms.  Time may vary from call to call, but in general, the result is this.  Let's do the same with the use of reflection: <br><br><blockquote> <code><a href="http://s-c.me/3081/s"></a> <a href="http://s-c.me/3081/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  t.start ( <font color="#A31515">"Preparing for reflective field access"</font> ); </li><li>  Field f = A. <font color="#0000ff">class</font> .getField ( <font color="#A31515">"value"</font> ); </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Reflective field access"</font> ); </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = <font color="#A31515">0</font> ; i &lt;LOOPS_IN_STEP_COUNT; ++ i) { </li><li>  f.  <font color="#0000ff">set</font> (a, ((Integer) f. <font color="#0000ff">get</font> (a)) + i); </li><li>  } </li><li>  t.stop (); </li></ol></blockquote><br><br>  Run for 11233ms - more than 250 times slower!  Repeat the same thing, replacing direct work with fields on method calls. <br><br><blockquote> <code><a href="http://s-c.me/3082/s"></a> <a href="http://s-c.me/3082/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  t.start ( <font color="#A31515">"Direct method access"</font> ); </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = <font color="#A31515">0</font> ; i &lt;LOOPS_IN_STEP_COUNT; ++ i) { </li><li>  a.add (i); </li><li>  } </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Preparing for reflective method access"</font> ); </li><li>  Method m = A. <font color="#0000ff">class.</font> GetDeclaredMethod ( <font color="#A31515">"add"</font> , <font color="#0000ff">int</font> . <font color="#0000ff">Class</font> ); </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Reflective method access"</font> ); </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = <font color="#A31515">0</font> ; i &lt;LOOPS_IN_STEP_COUNT; ++ i) { </li><li>  m.invoke (a, i); </li><li>  } </li><li>  t.stop (); </li></ol></blockquote><br><br>  A direct method call is slightly slower than direct access to the field and is performed in 51 ms.  At the same time, the reflection-access to the method is slightly faster - 4177 ms - about 100 slower than direct access. <br><br><h4>  How to optimize it? </h4><br>  Reflection by means of JVM is implemented using slow <a href="http://en.wikipedia.org/wiki/Java_Native_Interface">JNI</a> calls.  <a href="http://cglib.sourceforge.net/">CGLIB</a> provides the FastMethod class, which provides the same functionality without using JNI, making calls much, much faster: <br><br><blockquote> <code><a href="http://s-c.me/3083/s"></a> <a href="http://s-c.me/3083/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  t.start ( <font color="#A31515">"Preparing for fast reflective method access"</font> ); </li><li>  FastClass fc = FastClass.create (A. <font color="#0000ff">Class</font> ); </li><li>  FastMethod fm = fc.getMethod (m); </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Fast reflective method access"</font> ); </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = <font color="#A31515">0</font> ; i &lt;LOOPS_IN_STEP_COUNT; ++ i) { </li><li>  fm.invoke (a, <font color="#0000ff">new</font> <font color="#2b91af">Object</font> [] {i}); </li><li>  } </li><li>  t.stop (); </li></ol></blockquote><br><br>  The result is 353 ms, which is only 7 times slower than the usual method call.  If CGLIB had an analogue FastMethod for fields, we could compare and access fields. <br><br>  Let's think about how you can achieve better results in the previous snippet.  We have several costly operations: the first is to create an array in a loop, we can do with one array for all iterations of the loop.  The other is <a href="http://en.wikipedia.org/wiki/Boxing_(computer_science)">boxing</a> (auto-boxing) numbers.  Suppose that a number is not a number, but an ordinary object and does not require boxing: <br><br><blockquote> <code><a href="http://s-c.me/3084/s"></a> <a href="http://s-c.me/3084/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">class</font> <font color="#2b91af">Ref</font> { </li><li>  <font color="#0000ff">int value</font> ; </li><li>  } </li><li></li><li>  <font color="#0000ff">class</font> <font color="#2b91af">A</font> { </li><li>  <font color="#0000ff">public int value</font> = <font color="#A31515">0</font> ; </li><li></li><li>  <font color="#0000ff">public void</font> add ( <font color="#2b91af">Ref</font> <font color="#0000ff">ref</font> ) { </li><li>  <font color="#0000ff">value</font> + = <font color="#0000ff">ref</font> .  <font color="#0000ff">value</font> ; </li><li>  } </li><li>  } </li><li></li><li>  ... </li><li></li><li>  t.start ( <font color="#A31515">"Preparing for fast reflective method access (2)"</font> ); </li><li>  FastClass fc2 = FastClass.create ( <font color="#2b91af">A.</font> <font color="#0000ff">Class</font> ); </li><li>  FastMethod fm2 = fc2.getMethod ( <font color="#A31515">"add"</font> , <font color="#0000ff">new</font> <font color="#2b91af">Class</font> [] { <font color="#2b91af">Ref</font> . <font color="#0000ff">Class</font> }); </li><li>  <font color="#2b91af">Ref</font> <font color="#0000ff">ref</font> = <font color="#0000ff">new</font> <font color="#2b91af">Ref</font> (); </li><li>  <font color="#2b91af">Object</font> [] arguments = <font color="#0000ff">new</font> <font color="#2b91af">Object</font> [] { <font color="#0000ff">ref</font> }; </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Fast reflective method access (2)"</font> ); </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = <font color="#A31515">0</font> ; i &lt;LOOPS_IN_STEP_COUNT; ++ i) { </li><li>  <font color="#0000ff">ref</font> .  <font color="#0000ff">value</font> = i; </li><li>  fm2.invoke (a, arguments); </li><li>  } </li><li>  t.stop (); </li></ol></blockquote><br><br>  The result is 112ms.  Only 2 times slower than the usual method call!  However, why slower?  The fact is that FastMethod is implemented using <a href="http://en.wikipedia.org/wiki/Decorator_pattern">the Decorator design pattern</a> .  Let's try to decorate our class A and evaluate the result: <br><br><blockquote> <code><a href="http://s-c.me/3085/s"></a> <a href="http://s-c.me/3085/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  <font color="#0000ff">interface</font> <font color="#2b91af">AIf</font> { </li><li>  <font color="#0000ff">public void</font> add ( <font color="#0000ff">int</font> x); </li><li>  } </li><li></li><li>  <font color="#0000ff">class</font> <font color="#2b91af">A</font> implements <font color="#2b91af">AIf</font> { </li><li>  <font color="#0000ff">public int value</font> = <font color="#A31515">0</font> ; </li><li></li><li>  <font color="#0000ff">public void</font> add ( <font color="#0000ff">int</font> x) { </li><li>  <font color="#0000ff">value</font> + = x; </li><li>  } </li><li>  } </li><li></li><li>  <font color="#0000ff">class</font> <font color="#2b91af">ADecorator</font> implements <font color="#2b91af">AIf</font> { </li><li>  <font color="#0000ff">private</font> <font color="#2b91af">AIf</font> a; </li><li></li><li>  <font color="#0000ff">public</font> <font color="#2b91af">ADecorator</font> ( <font color="#2b91af">AIf</font> a) { </li><li>  <font color="#0000ff">this</font> .a = a; </li><li>  } </li><li></li><li>  <font color="#0000ff">public void</font> add ( <font color="#0000ff">int</font> x) { </li><li>  a.add (x); </li><li>  } </li><li>  } </li><li>  ... </li><li>  t.start ( <font color="#A31515">"Preparing decorator method access"</font> ); </li><li>  <font color="#2b91af">AIf</font> d = <font color="#0000ff">new</font> <font color="#2b91af">ADecorator</font> (a); </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Decorator method access"</font> ); </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = <font color="#A31515">0</font> ; i &lt;LOOPS_IN_STEP_COUNT; ++ i) { </li><li>  d.add (i); </li><li>  } </li><li>  t.stop (); </li></ol></blockquote><br><br>  Run for 124 ms - it turned out even slower than FastMethod.  And since every good programmer uses design patterns, we can say that with some optimization, reflection can be as fast as direct calls without reflection. <br><br>  Full listing: <br><br><blockquote> <code><a href="http://s-c.me/3086/s"></a> <a href="http://s-c.me/3086/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  package reflection; </li><li></li><li>  import net.sf.cglib.reflect.FastClass; </li><li>  import net.sf.cglib.reflect.FastMethod; </li><li></li><li>  import java.lang.reflect.Field; </li><li>  import java.lang.reflect.InvocationTargetException; </li><li>  import java.lang.reflect.Method; </li><li>  import java.util.  <font color="#2b91af">LinkedHashMap</font> ; </li><li>  import java.util.Map; </li><li></li><li>  <font color="#0000ff">class</font> <font color="#2b91af">Timer</font> { </li><li>  <font color="#0000ff">private long</font> startTime = <font color="#A31515">0</font> ; </li><li></li><li>  <font color="#0000ff">private</font> <font color="#2b91af">String</font> msg = <font color="#0000ff">null</font> ; </li><li></li><li>  <font color="#0000ff">private</font> Map &lt; <font color="#2b91af">String</font> , <font color="#2b91af">Long</font> &gt; map = <font color="#0000ff">new</font> <font color="#2b91af">LinkedHashMap</font> &lt; <font color="#2b91af">String</font> , <font color="#2b91af">Long</font> &gt; (); </li><li></li><li>  <font color="#0000ff">public void</font> start ( <font color="#2b91af">String</font> msg) { </li><li>  <font color="#0000ff">if</font> (startTime! = <font color="#A31515">0</font> ) { </li><li>  <font color="#0000ff">throw new</font> <font color="#2b91af">IllegalStateException</font> ( <font color="#A31515">"Already started"</font> ); </li><li>  } </li><li>  startTime = System.currentTimeMillis (); </li><li>  <font color="#0000ff">this</font> .msg = msg; </li><li>  } </li><li></li><li>  <font color="#0000ff">public void</font> stop () { </li><li>  <font color="#0000ff">if</font> (startTime == <font color="#A31515">0</font> ) { </li><li>  <font color="#0000ff">throw new</font> <font color="#2b91af">IllegalStateException</font> ( <font color="#A31515">"Not started"</font> ); </li><li>  } </li><li>  <font color="#0000ff">long</font> now = System.currentTimeMillis (); </li><li>  <font color="#2b91af">Long</font> n = map.  <font color="#0000ff">get</font> (msg); </li><li>  <font color="#0000ff">if</font> (n == <font color="#0000ff">null</font> ) { </li><li>  n = 0l; </li><li>  } </li><li>  n + = (now - startTime); </li><li>  map.put (msg, n); </li><li>  startTime = <font color="#A31515">0</font> ; </li><li>  msg = <font color="#0000ff">null</font> ; </li><li>  } </li><li></li><li>  <font color="#0000ff">public void</font> output () { </li><li>  <font color="#0000ff">for</font> ( <font color="#2b91af">String</font> msg: map.keySet ()) { </li><li>  System.  <font color="#0000ff">out</font> .println (msg + <font color="#A31515">":"</font> + map. <font color="#0000ff">get</font> (msg)); </li><li>  } </li><li>  } </li><li>  } </li><li></li><li>  <font color="#0000ff">class</font> <font color="#2b91af">Ref</font> { </li><li>  <font color="#0000ff">int value</font> ; </li><li>  } </li><li></li><li>  <font color="#0000ff">interface</font> <font color="#2b91af">AIf</font> { </li><li>  <font color="#0000ff">public void</font> add ( <font color="#0000ff">int</font> x); </li><li>  } </li><li></li><li>  <font color="#0000ff">class</font> <font color="#2b91af">A</font> implements <font color="#2b91af">AIf</font> { </li><li>  <font color="#0000ff">public int value</font> = <font color="#A31515">0</font> ; </li><li></li><li>  <font color="#0000ff">public void</font> add ( <font color="#0000ff">int</font> x) { </li><li>  <font color="#0000ff">value</font> + = x; </li><li>  } </li><li></li><li>  <font color="#0000ff">public void</font> add ( <font color="#2b91af">Ref</font> <font color="#0000ff">ref</font> ) { </li><li>  <font color="#0000ff">value</font> + = <font color="#0000ff">ref</font> .  <font color="#0000ff">value</font> ; </li><li>  } </li><li>  } </li><li></li><li>  <font color="#0000ff">class</font> <font color="#2b91af">ADecorator</font> implements <font color="#2b91af">AIf</font> { </li><li>  <font color="#0000ff">private</font> <font color="#2b91af">AIf</font> a; </li><li></li><li>  <font color="#0000ff">public</font> <font color="#2b91af">ADecorator</font> ( <font color="#2b91af">AIf</font> a) { </li><li>  <font color="#0000ff">this</font> .a = a; </li><li>  } </li><li></li><li>  <font color="#0000ff">public void</font> add ( <font color="#0000ff">int</font> x) { </li><li>  a.add (x); </li><li>  } </li><li>  } </li><li></li><li>  <font color="#0000ff">public class</font> <font color="#2b91af">Reflect</font> { </li><li>  <font color="#0000ff">private static</font> final <font color="#0000ff">int</font> TOTAL_LOOP_COUNT = <font color="#A31515">5000000</font> ; </li><li></li><li>  <font color="#008000">/ **</font> &lt;br/&gt; <font color="#008000">* How many loops to do in one step.</font>  &lt;br/&gt; <font color="#008000">* /</font> </li><li>  <font color="#0000ff">private static</font> final <font color="#0000ff">int</font> LOOPS_IN_STEP_COUNT = <font color="#A31515">100</font> ; </li><li></li><li>  <font color="#008000">/ **</font> &lt;br/&gt; <font color="#008000">* How many steps to do in each step there will be</font> &lt;br/&gt; <font color="#008000">* {@link #LOOPS_IN_STEP_COUNT} loops.</font>  &lt;br/&gt; <font color="#008000">* /</font> </li><li>  <font color="#0000ff">private static</font> final <font color="#0000ff">int</font> STEP_COUNT = TOTAL_LOOP_COUNT / LOOPS_IN_STEP_COUNT; </li><li></li><li>  <font color="#0000ff">public static void</font> main ( <font color="#2b91af">String</font> [] args) <font color="#2b91af">throws</font> SecurityException, </li><li>  NoSuchFieldException, IllegalArgumentException, </li><li>  IllegalAccessException, NoSuchMethodException, </li><li>  InvocationTargetException { </li><li></li><li>  <font color="#2b91af">Timer</font> t = <font color="#0000ff">new</font> <font color="#2b91af">Timer</font> (); </li><li>  <font color="#2b91af">A</font> a = <font color="#0000ff">new</font> <font color="#2b91af">A</font> (); </li><li></li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> j = <font color="#A31515">0</font> ; j &lt;STEP_COUNT; ++ j) { </li><li></li><li>  t.start ( <font color="#A31515">"Direct field access"</font> ); </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = <font color="#A31515">0</font> ; i &lt;LOOPS_IN_STEP_COUNT; ++ i) { </li><li>  a.  <font color="#0000ff">value</font> + = i; </li><li>  } </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Preparing for reflective field access"</font> ); </li><li>  Field f = <font color="#2b91af">A.</font>  <font color="#0000ff">class</font> .getField ( <font color="#A31515">"value"</font> ); </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Reflective field access"</font> ); </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = <font color="#A31515">0</font> ; i &lt;LOOPS_IN_STEP_COUNT; ++ i) { </li><li>  f.  <font color="#0000ff">set</font> (a, ((Integer) f. <font color="#0000ff">get</font> (a)) + i); </li><li>  } </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Direct method access"</font> ); </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = <font color="#A31515">0</font> ; i &lt;LOOPS_IN_STEP_COUNT; ++ i) { </li><li>  a.add (i); </li><li>  } </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Preparing for reflective method access"</font> ); </li><li>  Method m = <font color="#2b91af">A.</font>  <font color="#0000ff">class</font> .getDeclaredMethod ( <font color="#A31515">"add"</font> , <font color="#0000ff">int</font> . <font color="#0000ff">class</font> ); </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Reflective method access"</font> ); </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = <font color="#A31515">0</font> ; i &lt;LOOPS_IN_STEP_COUNT; ++ i) { </li><li>  m.invoke (a, i); </li><li>  } </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Preparing for fast reflective method access"</font> ); </li><li>  FastClass fc = FastClass.create ( <font color="#2b91af">A.</font> <font color="#0000ff">Class</font> ); </li><li>  FastMethod fm = fc.getMethod (m); </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Fast reflective method access"</font> ); </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = <font color="#A31515">0</font> ; i &lt;LOOPS_IN_STEP_COUNT; ++ i) { </li><li>  fm.invoke (a, <font color="#0000ff">new</font> <font color="#2b91af">Object</font> [] {i}); </li><li>  } </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Preparing for fast reflective method access (2)"</font> ); </li><li>  FastClass fc2 = FastClass.create ( <font color="#2b91af">A.</font> <font color="#0000ff">Class</font> ); </li><li>  FastMethod fm2 = fc2.getMethod ( <font color="#A31515">"add"</font> , <font color="#0000ff">new</font> <font color="#2b91af">Class</font> [] { </li><li>  <font color="#2b91af">Ref</font> .  <font color="#0000ff">class</font> </li><li>  }); </li><li>  <font color="#2b91af">Ref</font> <font color="#0000ff">ref</font> = <font color="#0000ff">new</font> <font color="#2b91af">Ref</font> (); </li><li>  <font color="#2b91af">Object</font> [] arguments = <font color="#0000ff">new</font> <font color="#2b91af">Object</font> [] { <font color="#0000ff">ref</font> }; </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Fast reflective method access (2)"</font> ); </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = <font color="#A31515">0</font> ; i &lt;LOOPS_IN_STEP_COUNT; ++ i) { </li><li>  <font color="#0000ff">ref</font> .  <font color="#0000ff">value</font> = i; </li><li>  fm2.invoke (a, arguments); </li><li>  } </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Preparing decorator method access"</font> ); </li><li>  <font color="#2b91af">AIf</font> d = <font color="#0000ff">new</font> <font color="#2b91af">ADecorator</font> (a); </li><li>  t.stop (); </li><li></li><li>  t.start ( <font color="#A31515">"Decorator method access"</font> ); </li><li>  <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = <font color="#A31515">0</font> ; i &lt;LOOPS_IN_STEP_COUNT; ++ i) { </li><li>  d.add (i); </li><li>  } </li><li>  t.stop (); </li><li></li><li>  } </li><li></li><li>  t.output (); </li><li>  } </li><li>  } </li><li></li></ol></blockquote><br><br>  And the result: <br><br>  Direct field access: 44 <br>  Preparing for reflective field access: 765 <br>  Reflective field access: 11233 <br>  Direct method access: 51 <br>  Preparing for reflective method access: 1020 <br>  Reflective method access: 4177 <br>  Preparing for fast reflective method access: 1400 <br>  Fast reflective method access: 353 <br>  Preparing for fast reflective method access (2): 2164 <br>  Fast reflective method access (2): 112 <br>  Preparing decorator method access: 52 <br>  Decorator method access: 124 <br><br>  You may notice that the ‚Äúpreparation‚Äù takes some time, but this operation can be performed only once.  ‚ÄúPreparation‚Äù of standard methods of reflection takes less than 1 ms, methods of CGLIB - about 100 ms.  The point is that the generated class must be compiled and loaded by the <a href="http://en.wikipedia.org/wiki/Class_loader">class loader</a> .  However, such generation can be performed only once. <br><br>  So, reflection in Java is not a bottleneck when using FastMethod from the CGLIB library.  And after some optimizations, calls can be as fast as immediate calls.  Now you can not be afraid to use these features in your code.  However, it is important to remember that premature optimization leads to problems, and you need to optimize only the code that really is the bottleneck of your application. <br><br>  <i>Translator's note: I increased the number of iterations 10 times and ran (Intel Q6600, Vista x64, JRE 1.6.0_16 x64) the test cited in the article, obtained several other results - ‚Äúdecoration‚Äù had practically no effect on the time of 120 vs 168, and the final result turned out to be 6 times slower than a direct call, not 2 as in the article:</i> <i><br><br></i>  <i>Direct field access: 170</i> <i><br></i>  <i>Preparing for reflective field access: 1370</i> <i><br></i>  <i>Reflective field access: 33928</i> <i><br></i>  <i>Direct method access: 120</i> <i><br></i>  <i>Preparing for reflective method access: 3382</i> <i><br></i>  <i>Reflective method access: 21208</i> <i><br></i>  <i>Preparing for fast reflective method access: 3043</i> <i><br></i>  <i>Fast reflective method access: 1247</i> <i><br></i>  <i>Preparing for fast reflective method access (2): 13174</i> <i><br></i>  <i>Fast reflective method access (2): 741</i> <i><br></i>  <i>Preparing decorator method access: 128</i> <i><br></i>  <i>Decorator method access: 168</i> <i><br></i> </div><p>Source: <a href="https://habr.com/ru/post/69552/">https://habr.com/ru/post/69552/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../69544/index.html">Haiku R1 / Alpha 1</a></li>
<li><a href="../69545/index.html">Interesting task: we increase the stability (robustness) of applications</a></li>
<li><a href="../69547/index.html">AdSense Fail or Global Redirect Loop</a></li>
<li><a href="../69549/index.html">First week with Intel</a></li>
<li><a href="../69550/index.html">Motorola CLIQ / DEXT Video</a></li>
<li><a href="../69553/index.html">Wi-Fi 802.11n approved</a></li>
<li><a href="../69556/index.html">Bethesda, perhaps, "drown" Interplay</a></li>
<li><a href="../69557/index.html">Webasyst Shop-script Programmer's Guide</a></li>
<li><a href="../69558/index.html">Solve the puzzle using one bit of memory!</a></li>
<li><a href="../69559/index.html">Integrating telephony into your applications without learning TAPI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>