<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis of the behavior of the Pegasus Trojan in the network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The source code for the Pegasus banking Trojan was recently published . Despite the mention of the Carbanak group in the name of the archive, research...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analysis of the behavior of the Pegasus Trojan in the network</h1><div class="post__text post__text-html js-mediator-article">  The source code for the Pegasus banking Trojan was recently <a href="https://malware-research.org/carbanak-source-code-leaked/">published</a> .  Despite the mention of the Carbanak group in the name of the archive, researchers from Minerva Labs <a href="https://blog.minerva-labs.com/pimped-buhtrap-source-leaked">denied the</a> Trojan‚Äôs involvement in this group and proved their involvement in the <a href="https://xakep.ru/tag/buhtrap/">Buhtrap</a> (Ratopak) group.  Inside the archive is a brief description of the work of the Trojan, its source codes, a description of the bank payment system and data from employees of many Russian banks. <br><br>  The architecture of the source code of this malware is quite interesting.  The functionality is divided into modules assembled into a single binpack at compile time.  The compilation process also includes the signature of executable files with a certificate from the tric.pfx file that is not in the archive. <br><br>  No less curious is the network activity of Pegasus, which, after infection, tries to spread within the domain and is able to proxy the data between the machines using the Mailslot pipes and transport.  We focused on studying the characteristics of Trojan network activity and quickly added detections for Pegasus to the <a href="https://www.ptsecurity.com/ru-ru/products/network-attack-discovery/">PT Network Attack Discovery</a> product.  This will allow all its users to timely detect the activity of this trojan and its modifications in its network.  In this article I will give a detailed description of the mechanisms of distribution over the network and the interaction between copies of Pegasus. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/yn/sn/-u/ynsn-udu1ai9y-xbrolf4fubrta.png"><a name="habracut"></a><br><br><h2>  Intro </h2><br>  Once on the machine, the main module InstallerExe injects the code into svchost.exe using the Process Hollowing technique and, after initializing the main modules, Pegasus launches several parallel processes: <br><br><ol><li>  Domain Replication - is engaged in intelligence within the network and attempts to spread to other Windows machines. </li><li>  Mailslot Listener listens to broadcast mailslot messages with which Pegasus sends out acquired accounts.  The slot name is generated at compile time. </li><li>  Pipe Server Listener listens to the Windows Pipe with the name generated on behalf of the machine.  These pipes are mainly used to detect other copies of Pegasus in the network and their interaction. </li><li>  Logon Passwords periodically every few minutes trying to dump account data module from Mimikatz. </li><li>  Network Connectivity is responsible for communicating with the CnC server and periodically exchanging messages. </li></ol><br><pre><code class="bash hljs">// start transports <span class="hljs-built_in"><span class="hljs-built_in">which</span></span> links data with our CB-manager pwInitPipeServerAsync(dcmGetServerCallback()); mwInitMailslotServer(dcmGetServerCallback()); ... // start broadcasting creds to other machines cmStartupNetworkBroadcaster();</code> </pre> <br><h2>  Domain Replication </h2><br>  One of the subsystems in Pegasus is responsible for the horizontal distribution (Lateral Movement) in the Windows network.  Distribution is divided into two important stages: <br><br><ol><li>  Detection of neighboring machines. </li><li>  Attempt to replicate on the machine. </li></ol><br>  Detection of neighboring machines in the domain is carried out through two API calls: <br><br><img src="https://habrastorage.org/webt/-p/6f/sj/-p6fsjb6pe8v-rdjacycwncholk.png" align="left">  NetServerEnum, which requires Browser service and WNetOpenEnum / WNetEnumResource calls. <br>  All machines found in the domain are checked if they are already infected.  Pegasus queries the generated name of the pipe once every 200 milliseconds more than 20 times in a row.  We have used this abnormal behavior as one of the indicators of Pegasus activity in the domain.  Having found no signs of infection, the malware moves to the next step - an attempt to replicate. <br><br><img src="https://habrastorage.org/webt/j0/nw/yl/j0nwylxgv6mvqzd8krxwf2su2x8.png" align="left">  Replication occurs as follows.  Using the found accounts (US) on the host, Pegasus attempts to authenticate on the machine using the SMB protocol to the IPC $ and ADMIN $ balls, and if there is access to IPC $, but there is no access to the ADMIN $, Pegasus concludes that account is not enough and must be marked as invalid.  Having gained access to the ADMIN $ balloon, which is an alias for the% windir% folder, the malware tries to determine the architecture of the machine in order to use the appropriate module in the future. <br><br>  The architecture definition algorithm is based on the headers of the PE files on the remote machine.  As such a file, Pegasus tries to read the first 4 kilobytes of notepad.exe from the% windir% folder.  The obvious lack of such a method is that on Windows Server 2012, the notebook is located along the path% windir% \ System32. <br><br>  The location of notepad.exe on Windows 7: <br><br><pre> <code class="bash hljs">C:\Users\Administrator&gt;<span class="hljs-built_in"><span class="hljs-built_in">where</span></span> notepad.exe C:\Windows\System32\notepad.exe C:\Windows\notepad.exe</code> </pre><br>  On Windows Server 2012: <br><br><pre> <code class="bash hljs">C:\Users\Administrator&gt;<span class="hljs-built_in"><span class="hljs-built_in">where</span></span> notepad.exe C:\Windows\System32\notepad.exe</code> </pre><br>  Not finding notepad.exe, Pegasus cannot infect the server, even with account information with the necessary permissions.  The mere absence of a notebook in% windir% can stop the distribution of Pegasus on Windows Server 2012. Using regedit.exe in this regard is more reliable. <br><br>  After successfully determining the architecture of the target server, Pegasus downloads a small RSE (Remote Service Exe) dropper with a size of about 10 kilobytes, the task of which is to load the binpack from Pegasus modules through the pipe in open form and transfer control to the Shellcode module.  A dropper name is composed in a pseudo-random manner and consists of a string of hexadecimal characters 8 to 15 characters long.  The pseudo-random generator is initialized depending on the name of the target machine and will be the same between launches to avoid possible garbage% windir% with past copies of the dropper. <br><br><img src="https://habrastorage.org/webt/pu/qb/hf/puqbhf_9-i8k7civefzklrqegxk.png"><br><br>  The dropper is checked for integrity and possible removal by the antivirus, after which it is launched by one of two implemented mechanisms - SCM or WMI, and in the first place Pegasus attempts to launch RSE through the WMI mechanism, and only then with the help of Service Control Manager (SCM).  This is done for the reason that SCM leaves more traces in the Windows logs.  The plans of the creators of Pegasus were other methods of distribution - Wsh Remote, Powershell remoting, Task Scheduler, and a module for executing commands via RDP was under development. <br><br>  As mentioned above, after a successful launch, the dropper checks and opens the pipe for listening and transfers control to the incoming payload. <br><br><img src="https://habrastorage.org/webt/od/zt/to/odztto9o8_yrp0galq3-9_owej4.png"><br><br>  Since Pegasus code is injected by the Process Hollowing method into the svchost.exe process, neither the original InstallerExe module in the case of the initial infection, nor the RSE dropper in the distribution case should remain on the disk.  If the dropper is still available along a known path, Pegasus deletes it in its own way: <br><br><ol><li>  overwriting the file contents with random data; </li><li>  overwriting with empty data (zeros); </li><li>  rename file; </li><li>  delete the file. </li></ol><br><img src="https://habrastorage.org/webt/up/ti/uy/uptiuydt0vx1zc9lz29l2kcdy80.png"><br><br>  After successful infection, the Domain Replication distribution process begins again. <br><br><h2>  Mailslot works </h2><br><img src="https://habrastorage.org/webt/z1/oa/hu/z1oahuoskry5bzymotu4d6n_9kk.png" align="left">  After Pegasus has access to the account data either from another copy of Pegasus, or from the mod_LogonPasswords module, it will begin broadcasting the UZ data across the domain.  Mailing is done using Mailslot's SMB-based mechanism, which allows for unidirectional broadcasting of a small portion of data across a domain.  Distribution occurs on a randomly generated slot name and, so that all infected machines in the domain can send and receive data using a single name, the pseudo-random generator for names is initialized from the TARGET_BUILDCHAIN_HASH variable specified in the config when building. <br><br>  Since the Mailslot mechanism imposes a limit on the maximum packet size, only one UZ is distributed at a time according to the principle of the last distribution time: among all the existing UZ by the domain, the one whose date of last distribution is the oldest is distributed. <br><br><img src="https://habrastorage.org/webt/e6/rw/wt/e6rwwt8svxdb_yzrszemgjeonlk.png" align="right">  The data in Mailslot ah is not transmitted in the clear, but wrapped with three layers of XOR encryption, with the keys being transmitted along with the data.  The first data layer is the envelope NetMessageEnvelope with data integrity checking algorithm SHA1, used for all data transmitted over the local network.  The 4 bytes of data at the beginning of a packet are the key, which is changed by bit shifts by 5 bits to the right per cycle.  Inside the envelope contains XOR coded data structure with the fields of the ultrasound directly and the date of their addition.  The 8 byte key is also located at the beginning of the structure, but is applied without shifts.  After decoding the structure of the KM, all that remains is to deserialize the individual fields from the ENC_BUFFER structures such as the computer name, the domain name, the user name, and his password.  These fields are encrypted using an 8 byte key with offsets.  A script to decrypt the Mailslot package and an example of such a package can be found here: <a href="https://gist.github.com/kirillwow/3ed4e475dab2e906d94561c7b1798d58">script</a> , <a href="https://www.cloudshark.org/captures/87931d2cc5b0">PCAP</a> . <br><br>  The mailing period for Mailslot messages in the release version ranges from 20 seconds to 11 minutes. <br><br><pre> <code class="bash hljs">// some random <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> before making next step DbgPrint(<span class="hljs-string"><span class="hljs-string">"going to sleep"</span></span>); <span class="hljs-comment"><span class="hljs-comment">#ifdef _DEBUG // debug - 2-5 s Sleep(rg.rgGetRnd(&amp;rg, 2000, 5000)); #else // release - 20 - 650 s //Sleep(rg.rgGetRnd(&amp;rg, 2000, 65000) * 10); Sleep(rg.rgGetRnd(&amp;rg, 2000, 15000)); #endif</span></span></code> </pre> <br>  In addition to sharing accounts, the Mailslot mechanism is used to search for an infected machine with Internet access and to announce Internet access.  The envelope NetMessageEnvelope stores the type of message sent.  The data exchange between the machine without access and the machine with Internet access is carried out through the pipes. <br><br><h2>  Pipe works </h2><br>  For two-way communication or transfer of large amounts of data, copies of Pegasus use pipes as a channel of communication.  The name of the pipe, although it is also generated by a pseudo-random generator, but depends on the name of the machine and the build, and thus allows the client and server parts to use the same name. <br><br>  When one-way communication, for example, transfer binpack during replication to another machine, the data is not encrypted and transmitted in the clear.  Binpack starts with a SHELLCODE_CONTEXT structure with a length of 561 bytes. <br><br><img src="https://habrastorage.org/webt/qf/ja/89/qfja89-eipqz2lncisi7fkcuqbe.png"><br><br>  During a two-way transfer, for example, of proxying data between a copy of Pegasus without Internet access and a CnC server, the same NetMessageEnvelope structure with XOR encryption is used, as in the case of Mailslot, since  It allows you to distinguish between different types of messages in the id field. <br><br>  Architecturally, data proxying is performed through a request to transfer a portion of data (PMI_SEND_QUERY), receiving the request id in response, and polling the task status by id (PMI_CHECK_STATUS_QUERY).  As a rule, a different Envelope structure is added as a load, adding different functionality and another layer of encryption. <br><br>  In addition, work with the pipe does not end with the interaction between infected machines.  The mod_KBRI_hd module injects cmd.exe code into the processes that intercepts MoveFileExW calls and analyzes all copied data, since this is part of the payment mechanism.  If the file being copied contains data interesting to the attackers - payment data, a notification about this is sent to the CnC server.  Communication between the mod_KBRI module injected into cmd.exe and a copy of Pegasus is carried out inside the infected machine via a pipe whose name is not generated, but is strictly specified in the source code: <br><br><pre> <code class="bash hljs">\.\pipe\pg0F9EC0DB75F67E1DBEFB3AFA2</code> </pre> <br><img src="https://habrastorage.org/webt/xr/eh/uj/xrehuj7ia40r-g4ka-osjtq9gjc.png" align="left">  The functionality of the module also includes the substitution of account data on the fly by a template.  An example of patterns for search in the screenshot. <br><br><h2>  Cnc traffic </h2><br>  For the direct exchange of data with the CnC server, a separate stream is responsible, which every few minutes checks a queue of data chunks from internal processes or from other copies of the malware and sends them to the server. <br><br>  During the initialization of the mod_NetworkConnectivity module, it conducts a multi-step test of the network connection: <br><br>  1) Detection of proxy server settings and attempt to connect to <a href="http://www.google.com/">www.google.com</a> : <br><br><ul><li>  In the registry \\ Software \\ Microsoft \\ Windows \\ CurrentVersion \\ Internet Settings. </li><li>  Via WPAD (call WinHttpGetProxyForUrl). </li><li>  Through the proxy server configuration for the current user (call WinHttpGetIEProxyConfigForCurrentUser). </li></ul><br>  2) Check connection to Microsoft update servers and return data ( <a href="http://www.download.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootseq.txt">authrootseq.txt</a> , <a href="">authrootstl.cab</a> , <a href="">rootsupd.exe</a> ) <br><br>  3) Testing HTTPS connections with one of 6i addresses: <br><br><ul><li>  <a href="https://safebrowsing.google.com/">safebrowsing.google.com</a> </li><li>  <a href="https://aus3.mozilla.org/">aus3.mozilla.org</a> </li><li>  <a href="https://addons.mozilla.org/">addons.mozilla.org</a> </li><li>  <a href="https://fhr.data.mozilla.com/">fhr.data.mozilla.com</a> </li><li>  <a href="https://versioncheck-bg.addons.mozilla.org/">versioncheck-bg.addons.mozilla.org</a> </li><li>  <a href="https://services.addons.mozilla.org/">services.addons.mozilla.org</a> </li></ul><br>  Only after passing through all the checks, Pegasus believes that it has the necessary access to the external network and can announce it over the Mailslot domain as a message.  And Pegasus can be masked and communicate with the CnC server only during business hours - from 9 to 19 and local time. <br><br>  Pegasus sends chunks of data wrapped in an envelope with a hash sum calculation in encrypted form using DES encryption in CRYPT_MODE_CBC / PKCS5_PADDING mode.  The encryption key depends only on the variable at compile time, and so we can decrypt the traffic between the malware and the server knowing only its BUILDCHAIN_HASH.  In the source code inside the archive, this variable had the value 0x7393c9a643eb4a76.  The script for decrypting the bounce (Check-in) to the server and an example of such a package can be found here: <a href="https://gist.github.com/kirillwow/91ffb736a4fb088218e442efe3c5a168">script</a> , <a href="https://www.cloudshark.org/captures/c6047154ef72">PCAP</a> . <br><br>  Such content (structure INNER_ENVELOPE) it transfers to the CnC server during the Check-in, or with some data.  First, there are 28 bytes of an envelope with a length field and a SHA1 sum. <br><br><img src="https://habrastorage.org/webt/po/zs/7s/pozs7shklsxh653kgnbxkgnmgl0.png"><br><br>  The same data is transmitted between the machines during proxying through the pipe, but wrapped inside the NetMessageEnvelope envelope known to us with a hash sum and XOR encryption. <br><br>  The CnC operator can send commands to execute on a copy of Pegasus and messages with commands or other data, for example EID_CREDENTIALS_LIST may contain their own field encryption layers, as we have already seen in the case of broadcast accounts. <br><br><h2>  Detection </h2><br>  First of all, we were interested in detecting Pegasus activity on the network and, after carefully studying the source codes and running it in a test environment, we found those network anomalies and artifacts that clearly indicate the presence of this complex malware on the network.  Pegasus can really be called versatile - it actively uses the SMB protocol for sending messages and establishing communication with other copies, extends to other machines and communicates with the CnC server in its own particular way.  By establishing a peer-to-peer network in the domain, copies of Pegasus pave the way to the external network and communicate with the CnC server, proxying traffic through each other.  Using certificates to sign executable files and accessing Microsoft and Mozilla resources during connection testing makes it difficult to detect its activity and detection on the host. <br><br>  The Pegasus source code project is quite well structured and described, so in the near future we can expect parts of its code to be borrowed by other malware and the appearance of modifications. <br><br>  Many of the mechanisms for remote execution of commands and search for these accounts remained unfulfilled, the developers were also going to add the ability to change the shellcode during the implementation process on the fly.  And this is not all their ideas. <br><br>  We have developed several signatures for PT NAD and IDS Suricata, which allow identifying Pegasus-specific network activity at different stages, starting from the very first seconds of its activity.  You can find open signatures for Suricata IDS on our <a href="https://github.com/ptresearch/AttackDetection/tree/master/carbanak_pegasus">github</a> and <a href="https://twitter.com/AttackDetection/status/1019310079961714689">Twitter</a> , they will automatically go to your Suricata if you use the suricata-update update mechanism. <br><br>  You can see how the signatures on the activity of Pegasus work in the screenshot below.  This is our new product, <a href="https://www.ptsecurity.com/ru-ru/products/network-attack-discovery/">PT Network Attack Discovery</a> , which identifies incidents and assists in their investigation: <br><br> <a href=""><img src="https://habrastorage.org/webt/cc/ok/ou/ccokou2rr1ed01valiivylk6prs.png"></a> <br><br>  In addition, the following compromise indicators (IC) can be used for detection: <br><br><pre>  MAILSLOT \ 46CA075C165CBB2786 
 pipe \ pg0F9EC0DB75F67E1DBEFB3AFA2

 hxxp: //denwer/pegasus/index.php
 hxxp: //mp3.ucrazy.org/music/index.php
 hxxp: //support.zakon-auto.net/tuning/index.asp
 hxxp: //video.tnt-online.info/tnt-comedy-tv/stream.php </pre><br>  <b>Posted by</b> : Kirill Shipulin from @attackdetection, <a href="http://www.twitter.com/attackdetection">Twitter</a> |  <a href="http://www.t.me/kirill_wow">Telegram</a> </div><p>Source: <a href="https://habr.com/ru/post/418017/">https://habr.com/ru/post/418017/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418007/index.html">Cross-platform development using .NET, reactive programming, MVVM pattern and code generation</a></li>
<li><a href="../418009/index.html">Node.js and server rendering in Airbnb</a></li>
<li><a href="../418011/index.html">One-page and SEO. Optimization secrets</a></li>
<li><a href="../418013/index.html">The Intel Core i7-8086K (Part 3)</a></li>
<li><a href="../418015/index.html">New Vasyuki. Innovative development of Moscow until 2100</a></li>
<li><a href="../418023/index.html">Pointers in C are more abstract than they might seem.</a></li>
<li><a href="../418025/index.html">The book "Learning Java EE. Modern programming for large enterprises ¬ª</a></li>
<li><a href="../418027/index.html">Microservice blitz</a></li>
<li><a href="../418029/index.html">ReactOS 0.4.9: Hayters will have to look for new arguments</a></li>
<li><a href="../418031/index.html">Mass stacking of ML models in production: is it real or not?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>