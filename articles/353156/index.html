<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FusionPBX, or cool again, FreeSWITCH</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the same river 
 Relatively recently, I wrote myself a cheat sheet for setting up FreeSWITCH. The configuration process described there led to a co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FusionPBX, or cool again, FreeSWITCH</h1><div class="post__text post__text-html js-mediator-article"><h4>  In the same river </h4><br>  Relatively recently, I wrote myself a <a href="https://habrahabr.ru/post/348458/">cheat sheet</a> for setting up FreeSWITCH.  The configuration process described there led to a configuration that worked in a test environment.  The test was necessary for drawing up a preliminary idea of ‚Äã‚Äãwhat will have to be dealt with after moving the organization and launching telephony into production.  However, when the move took place and the connection started in the working mode, the very first switch-on showed the inoperability of the configuration: the internal calls stopped going. <br><a name="habracut"></a><br>  This was a complete surprise for me, since from the moment of the final configuration and performance check, based on which the cheat sheet was written, no changes were made to the config until the operating mode was activated.  There were only massively added internal numbers and routes for incoming and outgoing calls for those employees for whom direct city numbers were assigned (about 60 with a tail of numbers). <br><br>  Debug was performed, the joint was detected, and it all worked.  However, the feeling of a crutch remained.  I will not describe it, as I remain confident that the solution used is not the right one, although it has led to the desired result.  In addition, it turned out the nuances: for outgoing calls, only the number that was specified in the SIP trunk setting in the <i>default_provider_username</i> field was determined from the outside: <br><br><pre><code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">X-PRE-PROCESS</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cmd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"set"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"default_provider_username=3435555555"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br>  and not the one specified in the subscriber number configuration: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs pgsql">&lt;variable <span class="hljs-type"><span class="hljs-type">name</span></span>="outbound_caller_id_name" <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>="3435555566"/&gt;</code> </pre> <br>  The provider‚Äôs technical support reported that all the calls arriving to them from us in the <i>From</i> field have the number <i>3435555555</i> , that is, the cant is on my side.  Plus, I'm suddenly completely hung up with the task of forwarding calls.  And the cherry on the cake was the removal of the brain with the Ericsson Dialog 4422, which refused to perform the call transfer, and the Cisco 7945g, who decided that their connection duration was 90-100 seconds in the absence of the slightest hint of a similar setting in the config.  At the same time, Yealink T21 E2 devices worked completely without any complaints. <br><br>  At this stage, I realized that I had reached the limit of my competence in the field of telephony and took time out to ensure that everything in my head was settled and completed.  This decision was also very powerful contributed to the general fatigue after a completely wild two working weeks without days off and with irregular working hours, which followed immediately after arrival at the new location of the organization. <br><br><h4>  Fusionpbx </h4><br>  Despite my lack of sympathy for graphical interfaces where the console and text configs reigns, I still began to look towards a solution with a web-snout called FusionPBX.  The first reason for such betrayal of our own principles was the desire to see the entire amount of settings for each functional element, collected in one place in the form of a workable out-of-the-box configuration.  This is exactly what the graphical interface gives.  An added bonus of a thoughtful graphical interface is a visual representation of the relationships between modules and functions.  For a beginner (for me personally), a lower level of abstraction with a specific implementation method contributes to faster learning and coming to understand how this thing works.  The second reason was <a href="http://www.pbxforums.com/">www.pbxforums.com</a> , to which I got a link through one when searching for information on FreeSWITCH, and, ironically, it was on the screenshots of the FusionPBX settings pages. <br><br>  FusionPBX is a FreeSWITCH with a web snout and with settings stored in a database.  The automatic installation script installs both FreeSWITCH, Nginx, PostgreSQL, and, in fact, the web interface of FusionPBX itself.  I will not stop at this moment, everything without hesitation is put according to the instructions from the documentation.  I put everything on the recommended 64-bit Debian 8 by developers. <br><br>  <b>Subscriber number import</b> <br><br>  The process of setting up subscriber numbers and incoming routes will not be considered here.  This process is described in the official documentation. <br><br>  Instead, it will be described the procedure for importing a crowd.  Descriptions, manuals and tips for performing this procedure were not found by me. <br><br>  After the installation is completed, we enable automatic login to the Adminer (analogous to phpMyAdmin): <br>  <b><i>Advanced ‚Üí Default settings</i></b> : <blockquote> <code><b>auto_login</b> <br> <b>Value</b> : true <br> <b>Enabled</b> : true</code> </blockquote>  After changing the values ‚Äã‚Äãon the current page, click <b>Save</b> , on the <b>Reload</b> settings default page. <br><br>  Go to Adminer: <b><i>Advanced ‚Üí Adminer</i></b> . <br><br>  The following tables are of interest to us: <br><br>  <i>v_extensions</i> - subscriber numbers. <br>  <i>v_destinations</i> ‚Äî routes for incoming calls to fixed numbers assigned to internal subscriber numbers. <br>  <i>v_dialplans</i> - <i>dialplan</i> reference. <br>  <i>v_dialplan_details</i> - incoming call <i>dialplan</i> settings. <br>  <i>v_voicemails</i> - voice mail settings. <br><br>  The task formulation was as follows: unload the full name of employees and their internal phone numbers from AD, save the unloading to a CSV file and import it into the database in the table of subscriber numbers and voice mail settings (voice mail should be disabled). <br>  Using the directory of the correspondence of city numbers to internal numbers, create CSV files for import into tables with routes and dialplans of incoming calls. <br><br>  I will not consider this problem in detail, I simply hide the finished scripts under the spoiler. <br><blockquote>  <b>Attention!</b> <br><br>  You use the proposed scripts at your own risk and risk; the author is not responsible for their incorrect use or the unexpected side effects of their correct use. <br><br><ul><li>  Set the <i>$ nums</i> variable to match your numbers. </li><li>  Before using scripts, you must replace the domain UUID everywhere with the value assigned to the domain during installation (the <i>domain_uuid</i> field). </li><li>  It is also necessary to replace the IP address of the domain (172.18.253.1) with yours. </li><li>  Do not forget to correct the value of the <i>-SearchBase</i> key, specifying your sample area instead of <i>"OU = Ekaterinburg, DC = dc, DC = domain, DC = local"</i> </li><li>  The UUID of the <i>Voicemail</i> application ( <i>app_uuid</i> field) is also replaced with the UUID assigned during installation. </li><li>  Values ‚Äã‚Äãof UUIDs can be viewed, for example, in the <i>v_dialplans</i> table. </li><li>  All subscriber numbers will be assigned a password for registration ‚Äú12345‚Äù, a password for voice mail and other services - the same as the subscriber number. </li><li>  The script appends files line by line!  Therefore, do not forget to delete files before each launch of the script or to clear their contents! </li></ul>  . </blockquote><div class="spoiler">  <b class="spoiler_title">Subscriber numbers and voice mail</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk"><span class="hljs-string"><span class="hljs-string">$U</span></span>tf8NoBomEncoding = <span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> <span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">Text</span></span>.<span class="hljs-type"><span class="hljs-type">UTF8Encoding</span></span> <span class="hljs-string"><span class="hljs-string">$F</span></span>alse <span class="hljs-string"><span class="hljs-string">$n</span></span>ums=@{<span class="hljs-comment"><span class="hljs-comment">"1111"</span></span>=<span class="hljs-comment"><span class="hljs-comment">"5555555"</span></span>;<span class="hljs-comment"><span class="hljs-comment">"1112"</span></span>=<span class="hljs-comment"><span class="hljs-comment">"5555566"</span></span>} [<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">IO</span></span>.<span class="hljs-type"><span class="hljs-type">File</span></span>]::<span class="hljs-type"><span class="hljs-type">AppendAllText</span></span>(<span class="hljs-comment"><span class="hljs-comment">"d:\v_extensions.csv"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"extension_uuid;domain_uuid;extension;number_alias;password;accountcode;effective_caller_id_name;effective_caller_id_number;outbound_caller_id_name;outbound_caller_id_number;emergency_caller_id_name;emergency_caller_id_number;directory_full_name;directory_visible;directory_exten_visible;limit_max;limit_destination;missed_call_app;missed_call_data;user_context;toll_allow;call_timeout;call_group;call_screen_enabled;user_record;hold_music;auth_acl;cidr;sip_force_contact;nibble_account;sip_force_expires;mwi_account;sip_bypass_media;unique_id;dial_string;dial_user;dial_domain;do_not_disturb;forward_all_destination;forward_all_enabled;forward_busy_destination;forward_busy_enabled;forward_no_answer_destination;forward_no_answer_enabled;follow_me_uuid;enabled;description;forward_caller_id_uuid;absolute_codec_string;forward_user_not_registered_destination;forward_user_not_registered_enabled;force_ping`r`n"</span></span>, <span class="hljs-string"><span class="hljs-string">$U</span></span>tf8NoBomEncoding) [<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">IO</span></span>.<span class="hljs-type"><span class="hljs-type">File</span></span>]::<span class="hljs-type"><span class="hljs-type">AppendAllText</span></span>(<span class="hljs-comment"><span class="hljs-comment">"d:\v_voicemails.csv"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"domain_uuid;voicemail_uuid;voicemail_id;voicemail_password;greeting_id;voicemail_alternate_greet_id;voicemail_mail_to;voicemail_sms_to;voicemail_attach_file;voicemail_file;voicemail_local_after_email;voicemail_enabled;voicemail_description;voicemail_name_base64`r`n"</span></span>, <span class="hljs-string"><span class="hljs-string">$U</span></span>tf8NoBomEncoding) <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">ADUser</span></span> -<span class="hljs-type"><span class="hljs-type">Filter</span></span> * -<span class="hljs-type"><span class="hljs-type">SearchBase</span></span> <span class="hljs-comment"><span class="hljs-comment">"OU=Ekaterinburg,DC=dc,DC=domain,DC=local"</span></span> -<span class="hljs-type"><span class="hljs-type">Properties</span></span> <span class="hljs-type"><span class="hljs-type">Telephonenumber</span></span>,sn,initials,cn|%{ if(-not <span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">Telephonenumber</span></span> -eq <span class="hljs-comment"><span class="hljs-comment">""</span></span>){ if(<span class="hljs-string"><span class="hljs-string">$n</span></span>ums.<span class="hljs-type"><span class="hljs-type">Get_Item</span></span>(<span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">Telephonenumber</span></span>) -eq <span class="hljs-string"><span class="hljs-string">$n</span></span>ull) {<span class="hljs-string"><span class="hljs-string">$o</span></span>utn = <span class="hljs-comment"><span class="hljs-comment">"5555555"</span></span>} else {<span class="hljs-string"><span class="hljs-string">$o</span></span>utn = <span class="hljs-string"><span class="hljs-string">$n</span></span>ums.<span class="hljs-type"><span class="hljs-type">Get_Item</span></span>(<span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">Telephonenumber</span></span>)} <span class="hljs-string"><span class="hljs-string">$e</span></span>xtension_uuid = (<span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Guid</span></span>).<span class="hljs-type"><span class="hljs-type">Tostring</span></span>() <span class="hljs-string"><span class="hljs-string">$d</span></span>omain_uuid = <span class="hljs-comment"><span class="hljs-comment">"ffffffff-ffff-ffff-ffff-ffffffffffff"</span></span> ## !!! <span class="hljs-string"><span class="hljs-string">$e</span></span>xtension = <span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">Telephonenumber</span></span> <span class="hljs-string"><span class="hljs-string">$n</span></span>umber_alias = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>assword = <span class="hljs-comment"><span class="hljs-comment">"12345"</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>ccountcode = <span class="hljs-comment"><span class="hljs-comment">"172.18.253.1"</span></span> <span class="hljs-string"><span class="hljs-string">$e</span></span>ffective_caller_id_name = <span class="hljs-string"><span class="hljs-string">$_</span></span>.sn + <span class="hljs-comment"><span class="hljs-comment">" "</span></span> + <span class="hljs-string"><span class="hljs-string">$_</span></span>.initials <span class="hljs-string"><span class="hljs-string">$e</span></span>ffective_caller_id_number = <span class="hljs-string"><span class="hljs-string">$e</span></span>xtension <span class="hljs-string"><span class="hljs-string">$o</span></span>utbound_caller_id_name = <span class="hljs-string"><span class="hljs-string">$o</span></span>utn <span class="hljs-string"><span class="hljs-string">$o</span></span>utbound_caller_id_number = <span class="hljs-string"><span class="hljs-string">$o</span></span>utn <span class="hljs-string"><span class="hljs-string">$e</span></span>mergency_caller_id_name = <span class="hljs-string"><span class="hljs-string">$e</span></span>ffective_caller_id_name <span class="hljs-string"><span class="hljs-string">$e</span></span>mergency_caller_id_number = <span class="hljs-string"><span class="hljs-string">$e</span></span>xtension <span class="hljs-string"><span class="hljs-string">$d</span></span>irectory_full_name = <span class="hljs-string"><span class="hljs-string">$_</span></span>.cn <span class="hljs-string"><span class="hljs-string">$d</span></span>irectory_visible = <span class="hljs-comment"><span class="hljs-comment">"true"</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>irectory_exten_visible = <span class="hljs-comment"><span class="hljs-comment">"true"</span></span> <span class="hljs-string"><span class="hljs-string">$l</span></span>imit_max = <span class="hljs-comment"><span class="hljs-comment">"1"</span></span> <span class="hljs-string"><span class="hljs-string">$l</span></span>imit_destination = <span class="hljs-comment"><span class="hljs-comment">"error/user_busy"</span></span> <span class="hljs-string"><span class="hljs-string">$m</span></span>issed_call_app = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$m</span></span>issed_call_data = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$u</span></span>ser_context = <span class="hljs-comment"><span class="hljs-comment">"172.18.253.1"</span></span> <span class="hljs-string"><span class="hljs-string">$t</span></span>oll_allow = <span class="hljs-comment"><span class="hljs-comment">"domestic,international,local"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>all_timeout = <span class="hljs-comment"><span class="hljs-comment">"30"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>all_group = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>all_screen_enabled = <span class="hljs-comment"><span class="hljs-comment">"false"</span></span> <span class="hljs-string"><span class="hljs-string">$u</span></span>ser_record = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>old_music = <span class="hljs-comment"><span class="hljs-comment">"local_stream://default"</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>uth_acl = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>idr = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>ip_force_contact = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$n</span></span>ibble_account = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>ip_force_expires = <span class="hljs-comment"><span class="hljs-comment">"3600"</span></span> <span class="hljs-string"><span class="hljs-string">$m</span></span>wi_account = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>ip_bypass_media = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$u</span></span>nique_id = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>ial_string = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>ial_user = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>ial_domain = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>o_not_disturb = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_all_destination = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_all_enabled = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_busy_destination = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_busy_enabled = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_no_answer_destination = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_no_answer_enabled = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>ollow_me_uuid = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled = <span class="hljs-comment"><span class="hljs-comment">"true"</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>escription = <span class="hljs-string"><span class="hljs-string">$_</span></span>.sn + <span class="hljs-comment"><span class="hljs-comment">" "</span></span> + <span class="hljs-string"><span class="hljs-string">$_</span></span>.initials <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_caller_id_uuid = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>bsolute_codec_string = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_user_not_registered_destination = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_user_not_registered_enabled = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orce_ping = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>sv=<span class="hljs-comment"><span class="hljs-comment">"$extension_uuid;$domain_uuid;$extension;$number_alias;$password;$accountcode;$effective_caller_id_name;$effective_caller_id_number;$outbound_caller_id_name;$outbound_caller_id_number;$emergency_caller_id_name;$emergency_caller_id_number;$directory_full_name;$directory_visible;$directory_exten_visible;$limit_max;$limit_destination;$missed_call_app;$missed_call_data;$user_context;`"</span></span><span class="hljs-string"><span class="hljs-string">$t</span></span>oll_allow`<span class="hljs-comment"><span class="hljs-comment">";$call_timeout;$call_group;$call_screen_enabled;$user_record;$hold_music;$auth_acl;$cidr;$sip_force_contact;$nibble_account;$sip_force_expires;$mwi_account;$sip_bypass_media;$unique_id;$dial_string;$dial_user;$dial_domain;$do_not_disturb;$forward_all_destination;$forward_all_enabled;$forward_busy_destination;$forward_busy_enabled;$forward_no_answer_destination;$forward_no_answer_enabled;$follow_me_uuid;$enabled;$description;$forward_caller_id_uuid;$absolute_codec_string;$forward_user_not_registered_destination;$forward_user_not_registered_enabled;`"</span></span><span class="hljs-string"><span class="hljs-string">$f</span></span>orce_ping`<span class="hljs-comment"><span class="hljs-comment">"`r`n"</span></span> [<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">IO</span></span>.<span class="hljs-type"><span class="hljs-type">File</span></span>]::<span class="hljs-type"><span class="hljs-type">AppendAllText</span></span>(<span class="hljs-comment"><span class="hljs-comment">"d:\v_extensions.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">$c</span></span>sv, <span class="hljs-string"><span class="hljs-string">$U</span></span>tf8NoBomEncoding) <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_uuid = (<span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Guid</span></span>).<span class="hljs-type"><span class="hljs-type">Tostring</span></span>() <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_id = <span class="hljs-string"><span class="hljs-string">$e</span></span>xtension <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_password = <span class="hljs-string"><span class="hljs-string">$e</span></span>xtension <span class="hljs-string"><span class="hljs-string">$g</span></span>reeting_id <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_alternate_greet_id <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_mail_to = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_sms_to <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_attach_file <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_file = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_local_after_email = <span class="hljs-comment"><span class="hljs-comment">"true"</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_enabled = <span class="hljs-comment"><span class="hljs-comment">"false"</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_description = <span class="hljs-string"><span class="hljs-string">$d</span></span>escription <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_name_base64 [<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">IO</span></span>.<span class="hljs-type"><span class="hljs-type">File</span></span>]::<span class="hljs-type"><span class="hljs-type">AppendAllText</span></span>(<span class="hljs-comment"><span class="hljs-comment">"d:\v_voicemails.csv"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"$domain_uuid;$voicemail_uuid;$voicemail_id;$voicemail_password;$greeting_id;$voicemail_alternate_greet_id;$voicemail_mail_to;$voicemail_sms_to;$voicemail_attach_file;$voicemail_file;$voicemail_local_after_email;$voicemail_enabled;$voicemail_description;$voicemail_name_base64`r`n"</span></span>, <span class="hljs-string"><span class="hljs-string">$U</span></span>tf8NoBomEncoding)}}</code> ; user_context; toll_allow; call_timeout; call_group; call_screen_enabled; user_record; hold_music; auth_acl; cidr; sip_force_contact; nibble_account; sip_force_expires; mwi_account; sip_bypass_media; unique_id; dial_string; dial_user; dial_domain; do_not_disturb; forward_all_destination; forward_all_enabled <code class="hljs smalltalk"><span class="hljs-string"><span class="hljs-string">$U</span></span>tf8NoBomEncoding = <span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> <span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">Text</span></span>.<span class="hljs-type"><span class="hljs-type">UTF8Encoding</span></span> <span class="hljs-string"><span class="hljs-string">$F</span></span>alse <span class="hljs-string"><span class="hljs-string">$n</span></span>ums=@{<span class="hljs-comment"><span class="hljs-comment">"1111"</span></span>=<span class="hljs-comment"><span class="hljs-comment">"5555555"</span></span>;<span class="hljs-comment"><span class="hljs-comment">"1112"</span></span>=<span class="hljs-comment"><span class="hljs-comment">"5555566"</span></span>} [<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">IO</span></span>.<span class="hljs-type"><span class="hljs-type">File</span></span>]::<span class="hljs-type"><span class="hljs-type">AppendAllText</span></span>(<span class="hljs-comment"><span class="hljs-comment">"d:\v_extensions.csv"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"extension_uuid;domain_uuid;extension;number_alias;password;accountcode;effective_caller_id_name;effective_caller_id_number;outbound_caller_id_name;outbound_caller_id_number;emergency_caller_id_name;emergency_caller_id_number;directory_full_name;directory_visible;directory_exten_visible;limit_max;limit_destination;missed_call_app;missed_call_data;user_context;toll_allow;call_timeout;call_group;call_screen_enabled;user_record;hold_music;auth_acl;cidr;sip_force_contact;nibble_account;sip_force_expires;mwi_account;sip_bypass_media;unique_id;dial_string;dial_user;dial_domain;do_not_disturb;forward_all_destination;forward_all_enabled;forward_busy_destination;forward_busy_enabled;forward_no_answer_destination;forward_no_answer_enabled;follow_me_uuid;enabled;description;forward_caller_id_uuid;absolute_codec_string;forward_user_not_registered_destination;forward_user_not_registered_enabled;force_ping`r`n"</span></span>, <span class="hljs-string"><span class="hljs-string">$U</span></span>tf8NoBomEncoding) [<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">IO</span></span>.<span class="hljs-type"><span class="hljs-type">File</span></span>]::<span class="hljs-type"><span class="hljs-type">AppendAllText</span></span>(<span class="hljs-comment"><span class="hljs-comment">"d:\v_voicemails.csv"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"domain_uuid;voicemail_uuid;voicemail_id;voicemail_password;greeting_id;voicemail_alternate_greet_id;voicemail_mail_to;voicemail_sms_to;voicemail_attach_file;voicemail_file;voicemail_local_after_email;voicemail_enabled;voicemail_description;voicemail_name_base64`r`n"</span></span>, <span class="hljs-string"><span class="hljs-string">$U</span></span>tf8NoBomEncoding) <span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">ADUser</span></span> -<span class="hljs-type"><span class="hljs-type">Filter</span></span> * -<span class="hljs-type"><span class="hljs-type">SearchBase</span></span> <span class="hljs-comment"><span class="hljs-comment">"OU=Ekaterinburg,DC=dc,DC=domain,DC=local"</span></span> -<span class="hljs-type"><span class="hljs-type">Properties</span></span> <span class="hljs-type"><span class="hljs-type">Telephonenumber</span></span>,sn,initials,cn|%{ if(-not <span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">Telephonenumber</span></span> -eq <span class="hljs-comment"><span class="hljs-comment">""</span></span>){ if(<span class="hljs-string"><span class="hljs-string">$n</span></span>ums.<span class="hljs-type"><span class="hljs-type">Get_Item</span></span>(<span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">Telephonenumber</span></span>) -eq <span class="hljs-string"><span class="hljs-string">$n</span></span>ull) {<span class="hljs-string"><span class="hljs-string">$o</span></span>utn = <span class="hljs-comment"><span class="hljs-comment">"5555555"</span></span>} else {<span class="hljs-string"><span class="hljs-string">$o</span></span>utn = <span class="hljs-string"><span class="hljs-string">$n</span></span>ums.<span class="hljs-type"><span class="hljs-type">Get_Item</span></span>(<span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">Telephonenumber</span></span>)} <span class="hljs-string"><span class="hljs-string">$e</span></span>xtension_uuid = (<span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Guid</span></span>).<span class="hljs-type"><span class="hljs-type">Tostring</span></span>() <span class="hljs-string"><span class="hljs-string">$d</span></span>omain_uuid = <span class="hljs-comment"><span class="hljs-comment">"ffffffff-ffff-ffff-ffff-ffffffffffff"</span></span> ## !!! <span class="hljs-string"><span class="hljs-string">$e</span></span>xtension = <span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">Telephonenumber</span></span> <span class="hljs-string"><span class="hljs-string">$n</span></span>umber_alias = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>assword = <span class="hljs-comment"><span class="hljs-comment">"12345"</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>ccountcode = <span class="hljs-comment"><span class="hljs-comment">"172.18.253.1"</span></span> <span class="hljs-string"><span class="hljs-string">$e</span></span>ffective_caller_id_name = <span class="hljs-string"><span class="hljs-string">$_</span></span>.sn + <span class="hljs-comment"><span class="hljs-comment">" "</span></span> + <span class="hljs-string"><span class="hljs-string">$_</span></span>.initials <span class="hljs-string"><span class="hljs-string">$e</span></span>ffective_caller_id_number = <span class="hljs-string"><span class="hljs-string">$e</span></span>xtension <span class="hljs-string"><span class="hljs-string">$o</span></span>utbound_caller_id_name = <span class="hljs-string"><span class="hljs-string">$o</span></span>utn <span class="hljs-string"><span class="hljs-string">$o</span></span>utbound_caller_id_number = <span class="hljs-string"><span class="hljs-string">$o</span></span>utn <span class="hljs-string"><span class="hljs-string">$e</span></span>mergency_caller_id_name = <span class="hljs-string"><span class="hljs-string">$e</span></span>ffective_caller_id_name <span class="hljs-string"><span class="hljs-string">$e</span></span>mergency_caller_id_number = <span class="hljs-string"><span class="hljs-string">$e</span></span>xtension <span class="hljs-string"><span class="hljs-string">$d</span></span>irectory_full_name = <span class="hljs-string"><span class="hljs-string">$_</span></span>.cn <span class="hljs-string"><span class="hljs-string">$d</span></span>irectory_visible = <span class="hljs-comment"><span class="hljs-comment">"true"</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>irectory_exten_visible = <span class="hljs-comment"><span class="hljs-comment">"true"</span></span> <span class="hljs-string"><span class="hljs-string">$l</span></span>imit_max = <span class="hljs-comment"><span class="hljs-comment">"1"</span></span> <span class="hljs-string"><span class="hljs-string">$l</span></span>imit_destination = <span class="hljs-comment"><span class="hljs-comment">"error/user_busy"</span></span> <span class="hljs-string"><span class="hljs-string">$m</span></span>issed_call_app = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$m</span></span>issed_call_data = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$u</span></span>ser_context = <span class="hljs-comment"><span class="hljs-comment">"172.18.253.1"</span></span> <span class="hljs-string"><span class="hljs-string">$t</span></span>oll_allow = <span class="hljs-comment"><span class="hljs-comment">"domestic,international,local"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>all_timeout = <span class="hljs-comment"><span class="hljs-comment">"30"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>all_group = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>all_screen_enabled = <span class="hljs-comment"><span class="hljs-comment">"false"</span></span> <span class="hljs-string"><span class="hljs-string">$u</span></span>ser_record = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$h</span></span>old_music = <span class="hljs-comment"><span class="hljs-comment">"local_stream://default"</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>uth_acl = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>idr = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>ip_force_contact = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$n</span></span>ibble_account = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>ip_force_expires = <span class="hljs-comment"><span class="hljs-comment">"3600"</span></span> <span class="hljs-string"><span class="hljs-string">$m</span></span>wi_account = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$s</span></span>ip_bypass_media = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$u</span></span>nique_id = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>ial_string = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>ial_user = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>ial_domain = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>o_not_disturb = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_all_destination = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_all_enabled = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_busy_destination = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_busy_enabled = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_no_answer_destination = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_no_answer_enabled = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>ollow_me_uuid = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled = <span class="hljs-comment"><span class="hljs-comment">"true"</span></span> <span class="hljs-string"><span class="hljs-string">$d</span></span>escription = <span class="hljs-string"><span class="hljs-string">$_</span></span>.sn + <span class="hljs-comment"><span class="hljs-comment">" "</span></span> + <span class="hljs-string"><span class="hljs-string">$_</span></span>.initials <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_caller_id_uuid = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>bsolute_codec_string = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_user_not_registered_destination = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orward_user_not_registered_enabled = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$f</span></span>orce_ping = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>sv=<span class="hljs-comment"><span class="hljs-comment">"$extension_uuid;$domain_uuid;$extension;$number_alias;$password;$accountcode;$effective_caller_id_name;$effective_caller_id_number;$outbound_caller_id_name;$outbound_caller_id_number;$emergency_caller_id_name;$emergency_caller_id_number;$directory_full_name;$directory_visible;$directory_exten_visible;$limit_max;$limit_destination;$missed_call_app;$missed_call_data;$user_context;`"</span></span><span class="hljs-string"><span class="hljs-string">$t</span></span>oll_allow`<span class="hljs-comment"><span class="hljs-comment">";$call_timeout;$call_group;$call_screen_enabled;$user_record;$hold_music;$auth_acl;$cidr;$sip_force_contact;$nibble_account;$sip_force_expires;$mwi_account;$sip_bypass_media;$unique_id;$dial_string;$dial_user;$dial_domain;$do_not_disturb;$forward_all_destination;$forward_all_enabled;$forward_busy_destination;$forward_busy_enabled;$forward_no_answer_destination;$forward_no_answer_enabled;$follow_me_uuid;$enabled;$description;$forward_caller_id_uuid;$absolute_codec_string;$forward_user_not_registered_destination;$forward_user_not_registered_enabled;`"</span></span><span class="hljs-string"><span class="hljs-string">$f</span></span>orce_ping`<span class="hljs-comment"><span class="hljs-comment">"`r`n"</span></span> [<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">IO</span></span>.<span class="hljs-type"><span class="hljs-type">File</span></span>]::<span class="hljs-type"><span class="hljs-type">AppendAllText</span></span>(<span class="hljs-comment"><span class="hljs-comment">"d:\v_extensions.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">$c</span></span>sv, <span class="hljs-string"><span class="hljs-string">$U</span></span>tf8NoBomEncoding) <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_uuid = (<span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Guid</span></span>).<span class="hljs-type"><span class="hljs-type">Tostring</span></span>() <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_id = <span class="hljs-string"><span class="hljs-string">$e</span></span>xtension <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_password = <span class="hljs-string"><span class="hljs-string">$e</span></span>xtension <span class="hljs-string"><span class="hljs-string">$g</span></span>reeting_id <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_alternate_greet_id <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_mail_to = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_sms_to <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_attach_file <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_file = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_local_after_email = <span class="hljs-comment"><span class="hljs-comment">"true"</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_enabled = <span class="hljs-comment"><span class="hljs-comment">"false"</span></span> <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_description = <span class="hljs-string"><span class="hljs-string">$d</span></span>escription <span class="hljs-string"><span class="hljs-string">$v</span></span>oicemail_name_base64 [<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">IO</span></span>.<span class="hljs-type"><span class="hljs-type">File</span></span>]::<span class="hljs-type"><span class="hljs-type">AppendAllText</span></span>(<span class="hljs-comment"><span class="hljs-comment">"d:\v_voicemails.csv"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"$domain_uuid;$voicemail_uuid;$voicemail_id;$voicemail_password;$greeting_id;$voicemail_alternate_greet_id;$voicemail_mail_to;$voicemail_sms_to;$voicemail_attach_file;$voicemail_file;$voicemail_local_after_email;$voicemail_enabled;$voicemail_description;$voicemail_name_base64`r`n"</span></span>, <span class="hljs-string"><span class="hljs-string">$U</span></span>tf8NoBomEncoding)}}</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Routes and Dialplans</b> <div class="spoiler_text"><pre> <code class="hljs mel">$Utf8NoBomEncoding = New-Object System.Text.UTF8Encoding $False [System.IO.File]::AppendAllText(<span class="hljs-string"><span class="hljs-string">"d:\v_destinations.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"domain_uuid;destination_uuid;dialplan_uuid;fax_uuid;destination_type;destination_number;destination_number_regex;destination_caller_id_name;destination_caller_id_number;destination_cid_name_prefix;destination_context;destination_app;destination_data;destination_enabled;destination_description;destination_accountcode`r`n"</span></span>, $Utf8NoBomEncoding) [System.IO.File]::AppendAllText(<span class="hljs-string"><span class="hljs-string">"d:\v_dialplans.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"domain_uuid;dialplan_uuid;app_uuid;dialplan_context;dialplan_name;dialplan_number;dialplan_continue;dialplan_order;dialplan_enabled;dialplan_description`r`n"</span></span>, $Utf8NoBomEncoding) [System.IO.File]::AppendAllText(<span class="hljs-string"><span class="hljs-string">"d:\v_dialplan_details.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"domain_uuid;dialplan_uuid;dialplan_detail_uuid;dialplan_detail_tag;dialplan_detail_type;dialplan_detail_data;dialplan_detail_break;dialplan_detail_inline;dialplan_detail_group;dialplan_detail_order`r`n"</span></span>, $Utf8NoBomEncoding) $nums=<span class="hljs-string"><span class="hljs-string">"1111=5555555;1112=5555566"</span></span> $nums.Split(<span class="hljs-string"><span class="hljs-string">";"</span></span>)|%{ $innum = $_.Split(<span class="hljs-string"><span class="hljs-string">"="</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] $outnum = $_.Split(<span class="hljs-string"><span class="hljs-string">"="</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] $domain_uuid = <span class="hljs-string"><span class="hljs-string">"ffffffff-ffff-ffff-ffff-ffffffffffff"</span></span> ## !!! $destination_uuid = (New-Guid).Tostring() $dialplan_uuid = (New-Guid).Tostring() $fax_uuid $destination_type = <span class="hljs-string"><span class="hljs-string">"inbound"</span></span> $destination_number = <span class="hljs-string"><span class="hljs-string">"343$outnum"</span></span> $destination_number_regex = <span class="hljs-string"><span class="hljs-string">"^(343$outnum)$"</span></span> $destination_caller_id_name $destination_caller_id_number $destination_cid_name_prefix $destination_context = <span class="hljs-string"><span class="hljs-string">"public"</span></span> $destination_app $destination_data $destination_enabled = <span class="hljs-string"><span class="hljs-string">"true"</span></span> $destination_description = <span class="hljs-string"><span class="hljs-string">"$outnum-$innum"</span></span> $destination_accountcode [System.IO.File]::AppendAllText(<span class="hljs-string"><span class="hljs-string">"d:\v_destinations.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"$domain_uuid;$destination_uuid;$dialplan_uuid;$fax_uuid;$destination_type;$destination_number;$destination_number_regex;$destination_caller_id_name;$destination_caller_id_number;$destination_cid_name_prefix;$destination_context;$destination_app;$destination_data;$destination_enabled;$destination_description;$destination_accountcode`r`n"</span></span>, $Utf8NoBomEncoding) $app_uuid = <span class="hljs-string"><span class="hljs-string">"ffffffff-ffff-ffff-ffff-ffffffffffff"</span></span> ## !!! $dialplan_context = <span class="hljs-string"><span class="hljs-string">"public"</span></span> $dialplan_name = $destination_number $dialplan_number = $destination_number $dialplan_continue = <span class="hljs-string"><span class="hljs-string">"false"</span></span> $dialplan_order = <span class="hljs-string"><span class="hljs-string">"100"</span></span> $dialplan_enabled = <span class="hljs-string"><span class="hljs-string">"true"</span></span> $dialplan_description = $destination_description [System.IO.File]::AppendAllText(<span class="hljs-string"><span class="hljs-string">"d:\v_dialplans.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"$domain_uuid;$dialplan_uuid;$app_uuid;$dialplan_context;$dialplan_name;$dialplan_number;$dialplan_continue;$dialplan_order;$dialplan_enabled;$dialplan_description`r`n"</span></span>, $Utf8NoBomEncoding) $dialplan_detail_break $dialplan_detail_inline $dialplan_detail_group $dialplan_detail_uuid = (New-Guid).Tostring() $dialplan_detail_tag = <span class="hljs-string"><span class="hljs-string">"condition"</span></span> $dialplan_detail_type = <span class="hljs-string"><span class="hljs-string">"destination_number"</span></span> $dialplan_detail_data = <span class="hljs-string"><span class="hljs-string">"^(343$outnum)$"</span></span> $dialplan_detail_order = <span class="hljs-number"><span class="hljs-number">20</span></span> [System.IO.File]::AppendAllText(<span class="hljs-string"><span class="hljs-string">"d:\v_dialplan_details.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"$domain_uuid;$dialplan_uuid;$dialplan_detail_uuid;$dialplan_detail_tag;$dialplan_detail_type;$dialplan_detail_data;$dialplan_detail_break;$dialplan_detail_inline;$dialplan_detail_group;$dialplan_detail_order`r`n"</span></span>, $Utf8NoBomEncoding) $dialplan_detail_uuid = (New-Guid).Tostring() $dialplan_detail_tag = <span class="hljs-string"><span class="hljs-string">"action"</span></span> $dialplan_detail_type = <span class="hljs-string"><span class="hljs-string">"transfer"</span></span> $dialplan_detail_data = <span class="hljs-string"><span class="hljs-string">"$innum XML 172.18.253.1"</span></span> $dialplan_detail_order = <span class="hljs-number"><span class="hljs-number">30</span></span> [System.IO.File]::AppendAllText(<span class="hljs-string"><span class="hljs-string">"d:\v_dialplan_details.csv"</span></span>, <span class="hljs-string"><span class="hljs-string">"$domain_uuid;$dialplan_uuid;$dialplan_detail_uuid;$dialplan_detail_tag;$dialplan_detail_type;$dialplan_detail_data;$dialplan_detail_break;$dialplan_detail_inline;$dialplan_detail_group;$dialplan_detail_order`r`n"</span></span>, $Utf8NoBomEncoding) }</code> </pre> </div></div><br>  Testing the connection to randomly selected numbers showed the operability of the import. <br><br>  <b>Gateway Setup</b> <br>  <b><i>Accounts ‚Üí Gateways</i></b> <br><blockquote> <code><b>Gateway</b> : 172.16.253.3 <br> <b>Username</b> : 3435555555 <br> <b>Password</b> : not-used <br> <b>From User</b> : 3435555555 <br> <b>From Domain</b> : 172.16.253.3 <br> <b>Proxy</b> : 172.16.253.3 <br> <b>Register</b> : False <br> <b>Caller ID In From</b> : True</code> </blockquote>  Note! <blockquote>  The FusionPBX documentation explicitly states that when making settings, fields in bold text are required. <br>  However, for some unknown reason, I did not see the fat content of the <b>Proxy</b> field and did not give it any meaning.  As a result, I received working incoming external calls, but not working outgoing calls.  The <code>sofia status gateway ffffffff-ffff-ffff-ffff-ffffffffffff</code> did not show any configuration anomalies and even showed the assigned value of the <b>proxy</b> field corresponding to the value of the <b>Gateway</b> .  Exactly the same output of the command with exactly the same settings was demonstrated by the ‚Äúbare‚Äù FreeSWITCH in the previous installation, and at the same time it allowed to make outgoing calls to the outside without any problems. <br>  FusionPBX earned only after <b>explicitly specifying the value of Proxy</b> . <br>  <i>* <code>ffffffff-ffff-ffff-ffff-ffffffffffff</code> - gateway UUID</i> <br></blockquote>  <b>ACL Setup</b> <br><br>  Made the settings in accordance with the cheat sheet and immediately received broken internal calls.  The logs showed that the devices for some reason turned out to be in the <i>external</i> context, respectively, were processed "not by their own" dialpan, from which the call ended with an error ROUTE_NOT_FOUND. <br><br><div class="spoiler">  <b class="spoiler_title">Lyrical digression</b> <div class="spoiler_text">  The humor of the situation was also in the fact that this ‚Äútrouble‚Äù struck me before I discovered that it was mandatory to fill in the <b>Proxy</b> field in the gateway settings.  And as soon as I set up the ACL, calls from outside started coming, but internal calls were broken.  And no matter how I played with the use of ACL and with their values, the result was the same: either calls from outside to inside, or internal calls without calls from inside to outside and outside to inside. </div></div><br>  As it turned out, the ACL setting was incorrect! <br><blockquote>  <b>Important!</b> <br><br>  ACLs are for networks and domains of providers only. <br>  Your own networks and domains in them should <b>not be</b> . <br>  The <i><b>domains</b></i> list should be <b>deny</b> by default. <br>  The rules themselves must be resolving and the provider‚Äôs gateway IP address with the / 32 mask must be entered in them, you do not need to fill in the <i>domain</i> field. </blockquote><br>  So, we configure the ACL: <b><i>Advanced ‚Üí Access Controls ‚Üí domains</i></b> .  Delete existing rules, create new: <br><blockquote> <code><b>Type</b> : allow <br> <b>CIDR</b> : 172.16.253.3/32 <br> <b>Domain</b> : <br> <b>Description</b> : default SIP-trunk</code> </blockquote> <br>  At the end, click <b>Save</b> , then to the new ACL come into effect: <b><i>Status ‚Üí Sip Status</i></b> and click <b>Reload ACL</b> . <br><br>  <b>System variables</b> <br><br>  <b><i>Advanced ‚Üí Default Settings</i></b> <br>  Here we will specify the external IP address given to us by the provider, which we used when configuring 1: 1 NAT in the cheat sheet, we will indicate the telephone area code, language and voice for voice responses, the type of dial tone. <br><br>  <b>Defaults</b> section: <blockquote> <code><b>default_areacode</b> : 343 <br> <b>default_language</b> : ru <br> <b>default_dialect</b> : RU <br> <b>default_voice</b> : elena <br> <b>ringback</b> : $${ru-ring} <br> <b>transfer_ringback</b> : $${ru-ring}</code> </blockquote>  <b>IP Address</b> Section <br><blockquote> <code><b>external_rtp_ip</b> : 172.16.160.154 <br> <b>external_sip_ip</b> : 172.16.160.154</code> </blockquote>  <b>SIP Profile</b> Section <b>: Internal</b> <br><blockquote> <code><b>internal_auth_calls</b> : true</code> </blockquote>  As a matter of fact, it is this variable, in the <i>true</i> value, that is responsible for reading the settings of the subscriber number and transferring the values <i>$ {outbound_caller_id_number}</i> and <i>$ {outbound_caller_id_name} from it</i> .  For this variable to be effective, it is necessary that the authorization of internal subscriber numbers via ACL is disabled.  By default, out of the box, this is done as follows: ACL authorization is absent, Digest is used instead (by subscriber number and password): <code><b>internal_auth_calls</b> : true</code> . <br><blockquote>  <b>Important!</b> <br><br>  In order to correctly identify direct city numbers assigned to the internal in the settings through the fields <i>Outbound Caller ID Name</i> and <i>Outbound Caller ID Number</i> , three conditions must be met: <br><ol><li>  No ACL authorization of internal subscribers </li><li>  Included Digest authorization in SIP profile settings: <br> <code><b>internal_auth_calls</b> : true</code> </li> <li>  Presence in the gateway settings: <br> <code><b>Caller ID In From</b> : True</code> </li> </ol></blockquote>  <b>Outbound routes</b> <br><br>  <b><i>Dialplan ‚Üí Outbound Routes</i></b> <br>  Perhaps this is the only setting item that has not been rethought. <br>  I will not analyze it in detail.  I will only note that the following regular expressions were used for different directions: <br><br><ul><li>  Inside city: <code>^(\d{7})$</code> (dialing a direct city 7-digit number without any prefixes in the form of zeros, nines, etc.). </li><li>  An inner city with a city code: <code>^(8343\d{7})$</code> (dialing a 7-digit urban number with the prefix 8343). </li><li>  Cell: <code>^(89\d{9})$</code> (a call to a cell with a prefix of 8, which is the de facto standard) </li><li>  Intercity: <code>^(8\d{10})$</code> (long-distance call, also familiar: 8, code of the settlement, subscriber number) </li><li>  International: <code>^(810\d+)$</code> (standard prefix 810, then country code, area code, subscriber number). </li></ul><br>  For all routes, two <i>action</i> tags of the <i>set</i> type were edited: <code>effective_caller_id_name= <u>${default_areacode}</u> ${outbound_caller_id_name}</code> <code>effective_caller_id_number= <u>${default_areacode}</u> ${outbound_caller_id_number}</code> so that the caller number transmitted to the operator includes the area code. <br><br>  <b>We treat call reset in 90-100 seconds on Cisco devices</b> <br><br>  As noted above, the surprise was a disconnection of an established connection in 90-100 seconds on all Cisco 7945g devices.  Twisting all the timers with a more or less relevant variable name in the config of the devices did not give any result.  Smoking logs in the FreeSWITCH console revealed Session Expire. <br><br>  Googling, besides the mats in the direction of the reluctance of Cisco devices to work normally with at least someone other than Call Manager, revealed that this behavior could be cured by disabling the variable <code><b>aggressive-nat-detection</b></code> . <br><br>  <b><i>Advanced ‚Üí SIP Profile</i></b> <br><blockquote> <code><b>aggressive-nat-detection</b> <br> <b>Value</b> : true <br> <b>Enabled</b> : False</code> </blockquote>  <b>Russification of voice response</b> <br><br>  We will need the voice files created by altruistic professionals. <br><br>  Downloading: <br><br>  <a href="">files.freeswitch.org/releases/sounds/freeswitch-sounds-ru-RU-elena-48000-1.0.51.tar.gz</a> <br>  <a href="">files.freeswitch.org/releases/sounds/freeswitch-sounds-ru-RU-elena-32000-1.0.51.tar.gz</a> <br>  <a href="">files.freeswitch.org/releases/sounds/freeswitch-sounds-ru-RU-elena-16000-1.0.51.tar.gz</a> <br>  <a href="">files.freeswitch.org/releases/sounds/freeswitch-sounds-ru-RU-elena-8000-1.0.51.tar.gz</a> <br><br>  Each of the archives contains a ready-made directory structure.  Each of the archives is unpacked in <i>/ usr / share / freeswitch / sound /</i> <br><br>  Since we have already done the default settings, from this point on the Russian voice files will pick up and start playing without additional movements.  The only thing you may have to do (I had to) is in all four folders <i>ru / RU / elena / voicemail / _bitrate_ /</i> rename the file <i>vm-not_available_no_voicemail.wav</i> and give it a new name <i>vm-no_answer_no_vm.wav</i> .  Only after this manipulation did I receive a voice response to the unavailable event of the called subscriber. <br><br>  PS: Like the <a href="https://habrahabr.ru/post/348458/">previous part</a> , this text was written solely for the purpose of documenting the emerging difficulties and ways to solve them.  Despite the fact that the text also covers a quick start from scratch of the same FreeSWITCH, albeit with a ‚Äúgraphic face‚Äù, I believe that the text is self-sufficient and is a kind of fork, and has the right to independent life.  The previous part also retains some value due to the described configuration of network equipment.  Incorrect settings in that text will be corrected and brought to those used in this article. </div><p>Source: <a href="https://habr.com/ru/post/353156/">https://habr.com/ru/post/353156/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353144/index.html">Literary Archiver</a></li>
<li><a href="../353146/index.html">The story about the blockchain and a little bit about bitcoins</a></li>
<li><a href="../353148/index.html">Telephony integration with MoiSklad service</a></li>
<li><a href="../353150/index.html">Animation in Angular Applications</a></li>
<li><a href="../353152/index.html">Rustam Mehmandarov and Alexander Tarasov - semantic wonders and automation of experiments on jug.msk.ru</a></li>
<li><a href="../353160/index.html">Proof-of-Proof-of-Work on the fingers. On the way to a sensible blockchain</a></li>
<li><a href="../353162/index.html">Phone + CRM: The Benefits of Collaboration</a></li>
<li><a href="../353164/index.html">Where does a quality strategy begin and why is it needed in product management?</a></li>
<li><a href="../353166/index.html">And we will have a real cosmonaut! On Imagine Cup 2018</a></li>
<li><a href="../353168/index.html">Store data in the cloud</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>