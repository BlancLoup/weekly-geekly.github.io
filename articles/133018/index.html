<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Magic Cache Decorator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Now I am working on revising / rewriting a project that was written, well, let's say, ‚Äúnot quite competently‚Äù. Along the way, there is a task to optim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Magic Cache Decorator</h1><div class="post__text post__text-html js-mediator-article">  Now I am working on revising / rewriting a project that was written, well, let's say, ‚Äúnot quite competently‚Äù.  Along the way, there is a task to optimize the work, since  The code was originally written extremely non-optimal.  Among the work on optimizing cache is screwed. <br><br>  There are several different data sources in the project, the results of which would be good to cache, the main one - of course, the database.  I wanted a clear solution, with minimal blood.  At one point, tired of writing constructs of the form <br><br><pre><code class="php hljs">$query = <span class="hljs-string"><span class="hljs-string">"Select something"</span></span>; $result = $cache-&gt;get($query, $tag); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$result) { $result = $db-&gt;queryAll($query); $cache-&gt;set($query, $tag); }</code> </pre> <br>  And you want something else.  Of course, the code can be put into a separate function or method, but it is somehow boring and, besides, for each different call (and there is not only $ db-&gt; queryAll, but several different options) you will need your own code and its own /method. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On the other hand, adding caching code directly to data sources is also not very correct - after all, they should not do this (which is why <a href="http://ru2.php.net/manual/ru/language.oop5.traits.php">Traits</a> also do not fit).  Creating a separate cache class is also not very convenient. <br><br>  In general, we wanted a single, universal solution that would be suitable for different data sources, with different interfaces, but at the same time was uniform.  It was decided to make a "magic" decorator. <br><br><a name="habracut"></a>  If you do not know what a decorator is, then in general terms: A decorator is a design pattern that aims to dynamically connect a new behavior to an object.  Thus, in our case, the data access object for the system will seem to be the same, with exactly the same interface and behavior, but it will have some new (caching) behavior. <br><br>  What exactly you want: so that additional methods like cached * appear in the data source object.  For example, there was a getData () method, in addition to it, a cachedGetData () method will appear, with the same interface as getData ().  The decorator will do on the "magic" methods. <br><br>  So, we write: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CachingDecorator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> object    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $obj; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> object    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $cache; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string     - . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $cacheTag; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> type $object   * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> type $cache   * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> type $cacheTag    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($object, $cache, $cacheTag = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'query'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;obj = $object; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache = $cache; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheTag = $cacheTag; } }</code> </pre> <br>  The initialization of the decorator will look something like this: <br><br><pre> <code class="php hljs">$data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CachingDecorator($data, $cache, <span class="hljs-string"><span class="hljs-string">'remote'</span></span>);</code> </pre> <br>  But so far our decorator is not a decorator at all and does not behave like a decorated object at all.  Fix this by adding magic (add getters / setters, forwarding calls): <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;obj-&gt;$name; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name, $value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;obj-&gt;$name = $value; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name, $args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> call_user_func_array(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;obj, $name), $args); }</code> </pre> <br>  Great, now the object's behavior is identical to the natural (well, almost, but in our situation it is enough, if you are missing something, add the necessary magic methods). <br><br>  Usually, simple methods are added to the decorator.  But we want magic, so let's do it like this: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name, $args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strtolower(substr($name, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>)) == <span class="hljs-string"><span class="hljs-string">'cached'</span></span>) { $name = substr($name, <span class="hljs-number"><span class="hljs-number">6</span></span>); $cacheName = md5(serialize($args)); $result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache-&gt;get($cacheName, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheTag); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($result === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { $result = call_user_func_array(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;obj, $name), $args); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache-&gt;save($result, $cacheName, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheTag); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> call_user_func_array(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;obj, $name), $args); } }</code> </pre> <br>  Actually everything.  Now, by decorating the desired data source, we can write instead <br><br><pre> <code class="php hljs">$result = $data-&gt;getDataById($id);</code> </pre> <br>  Simply: <br><br><pre> <code class="php hljs">$result = $data-&gt;cachedGetDataById($id);</code> </pre> <br>  So simple, and no longer need to fence any gardens to work with the cache. <br><br>  <b>Update:</b> Here they write in a personal note that flexibility is being lost, there is no way to specify the cache lifetime.  In my case, this is simply not relevant, using the time specified during the initialization of the cache object.  But if you need it, you can simply expand the decorator.  You can, for example, change the interface for cached * functions by adding the cache lifetime to the first parameter.  Or add more magic methods that will use different cache lifetime, for example, fastCached * and slowCached * (for often and rarely updated data, respectively). </div><p>Source: <a href="https://habr.com/ru/post/133018/">https://habr.com/ru/post/133018/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133008/index.html">Four autonomous robots plow the Pacific</a></li>
<li><a href="../133009/index.html">Introduction to Template Haskell. Part 3. Other aspects of TH</a></li>
<li><a href="../133011/index.html">Ticket to the world of USB 3.0, cheap</a></li>
<li><a href="../133016/index.html">Why Code Review in smartnut.ru?</a></li>
<li><a href="../133017/index.html">MODX Revolution 2.2 RC1 released</a></li>
<li><a href="../133019/index.html">Casting ideas for the Moscow Informatization Plan for 2012</a></li>
<li><a href="../133020/index.html">Ebaytoday + EMS: hammering a wallet (part 2)</a></li>
<li><a href="../133024/index.html">Welcome to Windows Phone 7 Student Camp in Tomsk on November 22</a></li>
<li><a href="../133025/index.html">In the footsteps of Citrix Synergy in Barcelona</a></li>
<li><a href="../133026/index.html">Mobile solutions are becoming a popular destination for startups.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>