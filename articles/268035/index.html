<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bad "Spring" or as the reasons for the delays were looking for</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We are used to seeing the history of projects with millions of clients and a whole fleet of servers, but various interesting and funny situations can ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bad "Spring" or as the reasons for the delays were looking for</h1><div class="post__text post__text-html js-mediator-article">  We are used to seeing the history of projects with millions of clients and a whole fleet of servers, but various interesting and funny situations can also be found on relatively small projects.  One of them happened recently.  Once the server was working normally, it suddenly began to slow down in a random way ... <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/08a/0d8/5d0/08a0d85d06f34a86beee6ef4ce5b77c7.png" title="If you keep going, there is a solution."></div><br><a name="habracut"></a><br>  I'll start with a little background.  Often, there are projects that have been replaced by many developers who do not always know what they were doing or not thinking about what they were doing before them.  It is not always possible, or even more justified, to comb it all right now, and you have to quickly fix the problems, regardless of the general desire to throw it all into the pipe. <br>  On one such project a strange thing happened.  Approximately at the same time, as minor corrections were made on the functionality, it was not known from where strange slowdowns began to occur on page generation, almost a minute.  (the one who spoiled everything was to blame, but the one who was the last to touch :)) <br><br><h2>  Investigation began </h2><br>  Realizing that these corrections can not make this, they began to dig.  The first thought is ‚Äúthis is some strange timeout, probably knocking somewhere remotely‚Äù.  We had to cling to this idea and not let it go, but more on that later.  The site was on bitrix, quite complex and there were a lot of different agents.  Almost all of them worked on the crown.  But you never know what.  It was painfully floating that there were slowdowns, with different users and once in several consecutive visits (another alarm bell, which no one paid attention to). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/files/43c/9c6/464/43c9c64644c44f4a9fb6f2f0ad1fbd39.png"></div><br><br>  The bitrix profiler showed that it was in the PHP code of the prolog core.  (just there agents can sometimes be run).  Sometimes it was true that the problem moved to the template code.  But since in most cases the prologue was decided to start with it.  (another mistake that could save some valuable time) <br>  Started digging consistently. <br><br><ul><li>  Step one.  At first, the changes made were rolled back, the problem did not disappear.  Breathed quietly, yet we did not. </li><li>  Step two.  Added logging time to agent call mechanism.  No correlation with slowdowns, all figures at the level of milliseconds. <br><br></li></ul><br>  It would be necessary to measure the various parts of the core.  (Here we would have to grasp the sensible idea that why these manual measurements of the code, we should put it on the XHProf combat server and see, but it was decided that there would be anyway).  The core piece is obfuscated.  A little manual dexterity, and the main places become clear, the code is broken into pieces, and you can take measurements of its individual parts. <br><br>  The search is narrowed down and here we find our suspect.  How so session_start () ??? <br><br><h2>  The clouds are gathering </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8f2/8a8/5b6/8f28a85b6e09ad1cd535a2f1539a0556.jpg"></div><br><br>  We look, sessions in files, files on SSD, sessions the cat wept.  Must work out instantly.  And here we turned off the right path.  Going in a roundabout way.  Thoughts are logical.  If the session starts for a long time, then there may be problems with IO, delays in the templates worked on the same idea.  Long connected files.  htop / iotop and other brethren show that there are no problems with the input output.  File folders fly back and forth without any delays.  There are no errors in the raid logs, the ssd firmware is recent.  SSD manufactured by Intel.  That is the case with the Samsung mentioned in Habr√© here no side. <br><br>  We try to transfer the session to the ram disk, to no avail.  The problem repeats more often.  Restarting processes does not help.  We plan on rebooting the physical server for the night in order to eliminate possible problems that could have accumulated over the uptime year, at the same time all kernel updates will arise. <br><br>  Restarting did not help.  In the nginx logs there are strange inscriptions like: <br><br><pre><code class="hljs pgsql">*<span class="hljs-number"><span class="hljs-number">38600646</span></span> an upstream response <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> buffered <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> file /var/<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>/nginx/proxy_temp/<span class="hljs-number"><span class="hljs-number">7</span></span>/<span class="hljs-number"><span class="hljs-number">29</span></span>/<span class="hljs-number"><span class="hljs-number">0000006297</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> reading upstream</code> </pre> <br>  They coincide in time with the known slowdowns.  It seems that the problem is much more common than it seemed.  Having thought it, we come to the idea that everything is logical, if the Apache for some reason is waiting for the session and does not hang at the same time, then he should somehow say to nginx that everything is fine, and we must wait, it means that he is probably sending empty packets which nginx puts in the buffer.  We set this aside and move on. <br><br>  We update services.  apache / php / nginx updated.  The problem is still there.  Free memory on the server under 25%, the swap settings are spinning to avoid any hypothetical problems with transferring the Apache processes to disk.  Quite expectedly no results. <br><br>  We transfer sessions to memcached.  We try to find a solution to the problem on stackoverflow.  (We are moving further away from the root of the problem, parallelly turning up the settings of the software and the system).  We transfer the cache partially in memcache partially to the ram disk. <br><br>  As you can guess no sense. <br><br><h2>  I have to go deeper </h2><br>  We get heavy artillery.  Once again we are trying to catch the process with the command - <i>ps -e -o pid, comm, wchan = WIDE-WCHAN-COLUMN |</i>  <i>grep httpd</i> .  It looks like this is <b>poll_schedule_timeout</b> .  Cling with strace. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4d3/1c0/3ee/4d31c03ee9ab715a60118e9bf19ce87d.jpg"></div><br><br>  Long wait - <pre> <code class="hljs lisp">restart_syscall(<span class="hljs-name"><span class="hljs-name">&lt;</span></span>... resuming interrupted call ...&gt;)</code> </pre> <br>  After which the process comes to life.  Like the page in the browser. <br>  We see work with sockets. <br><pre> <code class="hljs lisp">getsockopt(<span class="hljs-number"><span class="hljs-number">32</span></span>, SOL_SOCKET, SO_ERROR, [<span class="hljs-number"><span class="hljs-number">110</span></span>], [<span class="hljs-number"><span class="hljs-number">4</span></span>]) = <span class="hljs-number"><span class="hljs-number">0</span></span> fcntl(<span class="hljs-number"><span class="hljs-number">32</span></span>, F_SETFL, O_RDWR) = <span class="hljs-number"><span class="hljs-number">0</span></span> close(<span class="hljs-number"><span class="hljs-number">32</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span> socket(<span class="hljs-name"><span class="hljs-name">PF_INET</span></span>, SOCK_STREAM, IPPROTO_IP) = <span class="hljs-number"><span class="hljs-number">32</span></span> fcntl(<span class="hljs-number"><span class="hljs-number">32</span></span>, F_GETFL) = <span class="hljs-number"><span class="hljs-number">0</span></span>x2 (<span class="hljs-name"><span class="hljs-name">flags</span></span> O_RDWR) fcntl(<span class="hljs-number"><span class="hljs-number">32</span></span>, F_SETFL, O_RDWR|O_NONBLOCK) = <span class="hljs-number"><span class="hljs-number">0</span></span> connect(<span class="hljs-number"><span class="hljs-number">32</span></span>, {sa_family=AF_INET, sin_port=htons(<span class="hljs-number"><span class="hljs-number">80</span></span>), sin_addr=inet_addr(<span class="hljs-string"><span class="hljs-string">"87.250.250.85"</span></span>)}, <span class="hljs-number"><span class="hljs-number">16</span></span>) = <span class="hljs-number"><span class="hljs-number">-1</span></span> EINPROGRESS (<span class="hljs-name"><span class="hljs-name">Operation</span></span> now in progress)</code> </pre><br><br>  I remember the original thoughts about timeouts. <br>  Looks like they found the culprit.  We find on the strace where we knocked <br><pre> <code class="hljs objectivec">sendto(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-string"><span class="hljs-string">"\0\264\1\0\0\1\0\0\0\0\0\0\5vesna\6yandex\2ru\0\0\1\0"</span></span>..., <span class="hljs-number"><span class="hljs-number">33</span></span>, MSG_NOSIGNAL, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) = <span class="hljs-number"><span class="hljs-number">33</span></span></code> </pre> <br><br>  And close vesna.yandex.ru.  (What is such a vesna.yandex.ru where did it come from then? I understand some kind of doorway or something like that, but is this?) <br>  Problems suddenly disappear.  Disable memcache and ram disk, everything is fine.  So it is in this. <br><br>  Go back to strace logs and look for the reason <br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">lstat</span></span>(<span class="hljs-string"><span class="hljs-string">"/home/bitrix/ext_www/XXX/bitrix/modules/defa.tools/include.php"</span></span>, {st_mode=S_IFREG|<span class="hljs-number"><span class="hljs-number">0775</span></span>, st_size=<span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span>, ...}) = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lstat</span></span>(<span class="hljs-string"><span class="hljs-string">"/home/bitrix/ext_www/XXX/bitrix/modules/defa.tools"</span></span>, {st_mode=S_IFDIR|<span class="hljs-number"><span class="hljs-number">0775</span></span>, st_size=<span class="hljs-number"><span class="hljs-number">4096</span></span>, ...}) = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lstat</span></span>(<span class="hljs-string"><span class="hljs-string">"/home/bitrix/ext_www/XXX/bitrix/modules/defa.tools/classes/general/ibprop_elemcompleter.php"</span></span>, {st<span class="hljs-number"><span class="hljs-number">_</span></span> mode=S_IFREG|<span class="hljs-number"><span class="hljs-number">0775</span></span>, st_size=<span class="hljs-number"><span class="hljs-number">15267</span></span>, ...}) = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><br>  <abbr title="Free module for 1C-Bitrix expanding work with information blocks">Defa.Tools</abbr> ?  And what have the defa.tools.  profiling clearly showed session_start (). <br><br><h2>  The light in the darkness </h2><br><div style="text-align:center;"> <a href="https://500px.com/photo/95806739/fairy-night-by-mhadzuki%3Ffrom%3Dsearch" title="taken with 500px"><img src="https://habrastorage.org/files/c7d/59f/f61/c7d59ff610d140a6972a4429aeac01cc.jpeg"></a> </div><br><br>  We climb into the code.  We see the receipt of an archive with vesna.yandex.ru for the autogeneration of some texts.  (a functional that no one used, and in fact, like the module itself. It was put by some of the previous developers). <br>  An understanding of what is likely due to frequent reversal or even for whatever reasons, yandex starts to delay this file from time to time or does not return at all, and therefore we began to stumble upon this problem.  (why it is impossible to put the file received from Yandex into the cache on the server, and update it from time to time, rather than store it in a class instance and constantly request it - this is a question for the defa.tools developers). <br><br>  But why is it called to us, and the main question is where session_start () is.  We continue to dig.  And we find a hung handler (recall, a rather complicated project that a bunch of people wrote, transferring from developer to developer, many handlers in different files, sometimes without some kind of system) to save the property. <br><br>  We find not correctly registered filter.  The problem of brakes is finally found. <br><br><h2>  Solution </h2><br>  Now back to the main mystic, and here session_start.  On all pages for authorized users (in view of the subject and ideas of the site, most users are authorized) there is a call to the update check script by ajax.  (websocket'y? No, I have not heard).  The browser separates the wheat from the chaff, so it allows you to open a new tab at the time of the ajax request.  Since the session was started there, but not yet completed, the session_start obediently waits for it to be allowed to begin.  And it has nothing to do with <abbr title="Input / ouput">io</abbr> and other shamanism. <br><br><hr><br>  What conclusions can be drawn as a result: <br><br><ul><li>  The legacy of the old code always sneaks up unnoticed, and it hits the head hard. </li><li>  Trust your intuition.  (The idea of ‚Äã‚Äãaccessing an external resource turned out to be true. But shamanism with the installation and setup of XHProf would make it possible to notice that there are other long delays. And accordingly, to understand the essence of the problem more quickly.) </li><li>  Roll out heavy artillery early. </li><li>  Most likely the problem is much simpler than it seems. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/268035/">https://habr.com/ru/post/268035/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268023/index.html">The story of a "hack" or How Yahoo gave me a login and password from someone else's mail</a></li>
<li><a href="../268025/index.html">How-to: The process of creating the layout of html-letters</a></li>
<li><a href="../268029/index.html">Security vulnerability detected in WinRAR software</a></li>
<li><a href="../268031/index.html">Apiway - a new way of client-server data transport</a></li>
<li><a href="../268033/index.html">We balance the mechanics in games</a></li>
<li><a href="../268037/index.html">Preparing ASP.NET5, issue number 4 - details about routing</a></li>
<li><a href="../268039/index.html">Predicting Titanic Passenger Survival with Azure Machine Learning</a></li>
<li><a href="../268047/index.html">Asterisk. This time, as a background music broadcasting system with the possibility of emergency notification</a></li>
<li><a href="../268055/index.html">Support for geolocation and corrected sketches of the express panel in the assembly Vivaldi 1.0.288.3</a></li>
<li><a href="../268057/index.html">CUSTIS Open Seminars: Graduation Season</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>