<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Create live streaming CDN for low latency WebRTC video streams</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Where may be required to broadcast with a guaranteed low latency? - in fact, many where. For example in online video auctions. Imagine yourself leadin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Create live streaming CDN for low latency WebRTC video streams</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d6100d3230732662.jpeg"></div><br>  Where may be required to broadcast with a guaranteed low latency?  - in fact, many where.  For example in online video auctions.  Imagine yourself leading such an event. <br>  - ‚ÄúTwo hundred thousand raaaaz‚Äù <br>  - "Sales!" <br><br>  With a high delay, you will have time to say ‚Äútwo hundred thousand three‚Äù and sell the lot before the video reaches the participants.  To bidders have time to react, the delay must be guaranteed to be low. <br><br>  In general, low latency is vital in any gaming scenario, whether it is an online video auction, video broadcasts of horse racing or an intelligent online game ‚ÄúWhat, Why‚Äù - and there and there a guaranteed low delay and real-time video and audio transmission are required. . <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Why CDN </h2><br>  One server is often not able to deliver streams to everyone just because all viewers are geographically distributed and have communication channels of different bandwidth.  In addition, a single server may not be enough resources.  Therefore, we need a bunch of servers that are engaged in the delivery of the stream.  And this is the CDN - content delivery network.  The content in this case will be a low-latency streaming video that is transmitted from the webcam of the transmitting user to viewers. <br><br>  In this article, we describe the process of building a geographically-distributed mini-CDN and test the result.  Our CDN will consist of four servers and work as follows: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d60ff09667209412.jpeg"></div><br>  This scheme uses the minimum required number of servers: 4. <br><br>  1) Origin + LB <br><br>  This is the server that receives the broadcast video stream from the user's webcam. <br><br>  Sending a stream in a browser might look like this: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d673c46479298216.png"></div><br><br>  This is an example of sending a video stream from a web page opened in the Google Chrome browser.  The stream is sent to the origin.llcast.com test server. <br><br>  After Origin has received the video stream, it retransmits the received stream to two Edge1 and Edge2 servers.  The Origin server itself does not distribute threads. <br><br>  To simplify, in this scheme, we assigned to Origin the role of load balancer (LB).  He polls edge-nodes and informs connected viewer clients to which of the nodes they should connect to. <br><br>  Balancing works like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d668bd9596147432.jpeg"></div><br><br><ol><li>  The browser refers to the balancer (in this case coincides with the Origin). </li><li>  The balancer returns one of the servers: Edge1 or Edge2. </li><li>  The browser establishes a connection with the Edge2 server (in the example), using the Websocket protocol. </li><li>  Edge2 server sends video traffic via WebRTC. </li></ol><br>  Origin periodically polls the servers Edge1 and Edge2, checking their availability and collects data on the load.  This is enough to make a decision on which of the servers to "land" a new connection.  If one of the servers is unavailable for some reason, the connections will ‚Äúland‚Äù on the remaining Edge server. <br><br>  2) Edge1 and Edge2 <br><br>  These are servers that deal directly with the distribution of audio and video traffic to viewers.  Each of them receives a stream from the Origin server and each provides the Origin server with information about its download. <br><br>  3) TURN relay - server. <br><br>  To ensure a really low latency, all of the above audio and video delivery schemes work over UDP.  However, this protocol can be closed on firewalls and sometimes you have to let all traffic through HTTPS port 443, which is usually open.  For this, TURN relay is used.  If a normal UDP connection fails, the video will go through TURN and over TCP.  This will inevitably worsen the latency, but if most of your viewer users are behind corporate firewalls, one way or another you will have to use TURN for WebRTC or another way to deliver content via TCP, for example <a href="https://habr.com/transliruem-webrtc-rtsp-i-rtmp-potoki-na-media-source-extensions/%3Flang%3Dru">Media Source Extension / Websocket</a> . <br><br>  In this case, we allocate 1 server specifically for passing firewalls.  He will distribute video over WebRTC / TCP for those viewers who are not lucky enough to receive a normal connection via UDP. <br><br><h2>  Geographical distribution </h2><br>  Origin-server will be located in the data center of Frankfurt.  While Edge1 server will be located in New York, and Edge2 will be located in Singapore.  Thus we get a distributed broadcast, covering most of the globe in length. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d6d373e642560088.jpeg"></div><br><h2>  Installation and start of servers </h2><br>  For low-cost testing, take the Digital Ocean virtual servers. <br><br>  We will prepare 4 drops (virtual servers) on DO, 2 Gb of RAM each.  It will cost us 12 cents per hour, and one day about 3 dollars. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d6dc904975507953.jpeg"></div><br>  The Origin and Edge1, Edge2 servers will use the <a href="https://flashphoner.com/">WCR5</a> WebRTC server.  It must be downloaded and installed on each of the droplets. <br><br>  The installation process for a WCS server looks like this: <br><br>  1) Download the distribution. <br><br><pre><code class="bash hljs">wget https://flashphoner.com/download-wcs5-server.tar.gz</code> </pre> <br>  2) Unpack and install. <br><br><pre> <code class="bash hljs">tar -xvzf download-wcs5-server.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> FlashphonerWebCallServer-5.0.2505 ./install.sh</code> </pre> <br>  Do not forget to install haveged, which may be required to speed up the launch of the WCS server on the Digital Ocean. <br><br><pre> <code class="bash hljs">yum install epel-release yum install haveged haveged chkonfig on haveged</code> </pre> <br>  3) Run. <br><pre> <code class="bash hljs">service webcallserver start</code> </pre> <br>  4) Create Let'sencrypt certificates <br><br><pre> <code class="bash hljs">wget https://dl.eff.org/certbot-auto chmod a+x certbot-auto certbot-auto certonly</code> </pre> <br>  Certbot will put the certificates in the / etc / letsencrypt / live folder <br><br>  Example: <br><br><pre> <code class="bash hljs">/etc/letsencrypt/live/origin.llcast.com</code> </pre> <br>  6) Import Let'sencrypt certificates <br><br>  Cer‚îÄ‚îÄ cert.pem <br>  Chain‚îÄ‚îÄ chain.pem <br>  Full‚îÄ‚îÄ fullchain.pem <br>  Full‚îÄ‚îÄ fullchain_privkey.pem <br>  Priv‚îÄ‚îÄ privkey.pem <br>  RE‚îÄ‚îÄ README <br><br>  From these files we need only two: a chain of certificates and a private key: <br><br><ul><li>  fullchain.pem </li><li>  privkey.pem </li></ul><br><br>  Download them via Dashboard / Security / Certificates.  To enter the WCS server admin area, open the address <a href="https://origin.llcast.com/">origin.llcast.com</a> : 8888, where origin.llcast.com is the domain name of your WCS server. <br><br>  The import result looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d7194e3898004635.png"></div><br>  All is ready.  The import was successful and now you need to perform a short test to make sure everything works.  Go to the Dashboard server in the demo - an example of Two Way Streaming.  Press the Publish button and after a few seconds Play.  We are convinced that the server works, receives streams and gives them to play. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d673c46479298216.png"></div><br>  After checking one server, we do the same with the other two (Edge1 and Edge1).  We install WCS5 on them, get Let's Encrypt certificates and import them into the installed WCS server for correct operation.  At the end of each installation we carry out a simple test that shows that the server responds and plays streams. <br><br>  As a result, we have configured three servers that are available at the following addresses: <br><br><ul><li>  <a href="https://origin.llcast.com:8888/">https://origin.llcast.com:8888</a> </li><li>  <a href="https://edge1.llcast.com:8888/">https://edge1.llcast.com:8888</a> </li><li>  <a href="https://edge2.llcast.com:8888/">https://edge2.llcast.com:8888</a> </li></ul><br><h2>  Origin server configuration </h2><br>  It remains to configure and combine the servers in the CDN.  We start from the Origin server. <br><br>  As we have already mentioned above, Origin is also a balancer.  We find the WCS_HOME / conf / loadbalancing.xml file in the configs and write Edge nodes in it.  As a result, the config will look like this: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">loadbalancer</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"roundrobin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stream_distribution</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"webrtc"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span>edge1.llcast.com<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span>443<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span>edge2.llcast.com<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span>443<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">loadbalancer</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  This config describes the following settings: <br><br><ul><li>  On which node the video stream with Origin (edge1 and edge2) should be relayed. </li><li>  What technology will be used for relaying (webrtc). </li><li>  What port should be used for the Websocket connection with the edge node (443). </li><li>  Balancing mode - in a circle (roundrobin). </li></ul><br>  Currently, there are two ways to rebate Origin - Edge, which are specified by the attribute stream_distribution, which are: <br><br><ul><li>  webrtc </li><li>  rtmp </li></ul><br>  We expose here webrtc, because  we need low latency.  Next, you need to tell the Origin server that it will deal with balancing.  Enable the balancer in the WCS_HOME / conf / server.properties config <br><br><pre> <code class="bash hljs">load_balancing_enabled =<span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br>  In addition, we will assign port 443 to the balancer so that connecting clients can receive data from the balancer via the standard HTTPS port, again for the successful passage of firewalls.  In the same server.properties config we add <br><br><pre> <code class="bash hljs">https.port=443</code> </pre> <br>  Next, we restart the WCS server to apply the changes. <br><br><pre> <code class="bash hljs">service webcallserver restart</code> </pre> <br>  As a result, we enabled the balancer and configured it on port 443 in the server.properties config, and also configured the Origin-Edge relays in the loadbalancing.xml config. <br><br><h2>  Edge Server Configuration </h2><br>  Edge servers do not require special configuration.  Just take a stream from the Origin server, as if the user sent the stream from the webcam directly to this Edge server. <br><br>  Although one setting will still have to be added.  It is necessary to switch Websocket - the port of the distributing video servers on 443 for the best passability through firewalls.  If the Edge servers make connections on port 443 via HTTPS and TURN will do the same, we will get a firewall bypass solution that will help increase the availability of broadcast for corporate users behind firewalls. <br><br>  Change the WCS_HOME / conf / server.properties config and set the configuration <br><br><pre> <code class="bash hljs">wss.port=443</code> </pre> <br>  Reboot the WCS server to apply the changes. <br><br><pre> <code class="bash hljs">service webcallserver restart</code> </pre> <br>  This completes the Edge server setup and you can begin testing the CDN. <br><br><h2>  Webcam streaming to Origin </h2><br>  Users of our mini-CDN are divided into streamers and players.  Streamers - broadcast video on CDN, and players - viewers, this video is played.  The interface of the tape drive may look like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d7999f4763740294.jpeg"></div><br>  The easiest way to test this interface is to open the Two Way Streaming demo on the Origin server. <br><br>  Example streamer on the Origin server: <br><br><pre> <code class="bash hljs">https://origin.llcast.com:8888/demo2/two-way-streaming</code> </pre> <br>  For testing, you need to establish a Websocket connection to the server using the Connect button and then send the video stream to the server using the Publish button.  As a result, if everything is correctly configured, the stream will appear on the Edge1 and Edge2 servers and it can be lost from them. <br><br>  This interface is just a demo of an HTML page based on a client-side JavaScript API (Web SDK) and can be customized and brought to any design using HTML / CSS. <br><br><h2>  Replay stream from Edge1 and Edge2 servers </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d7b532e677016672.png"></div><br>  The player interface can be taken from one of the servers edge1.llcast.com or edge2.llcast.com - an example of Demo / Embed Player <br><br>  Testing can be done by connecting directly to the edge-server via these links: <br><br>  Edge1 <br><br><pre> <code class="bash hljs">https://edge1.llcast.com:8888/demo2/embed-player</code> </pre> <br>  Edge2 <br><br><pre> <code class="bash hljs">https://edge2.llcast.com:8888/demo2/embed-player</code> </pre> <br>  The player establishes a Websocket connection with the specified Edge server and retrieves the video stream from WebRTC from this server.  Notice that on the Edge Websocket servers, the connection is established on port 443, which was configured above to pass through firewalls. <br><br>  This player can be embedded in the website as an iframe or you can more closely integrate using the JavaScript API and develop your own HTML / CSS design. <br><br><h2>  Connecting the load balancer to the player </h2><br>  Above, we made sure that Origin receives a video stream and replicates this stream to two Edge servers.  We connected to each of the Edge servers separately and tested the playback of the stream. <br><br>  Now you need to use the balancer so that the player selects the Edge server from the pool automatically. <br><br>  To do this, in the JavaScript code of the player you need to specify the address of the balancer - <b>lbUrl</b> .  If you specify it, the Embed Player example will first contact the balancer and take the recommended server address from it, and after that establish a connection with the received address using the Websocket protocol. <br><br>  URL balancer is easy to test.  Open it in the browser: <br><br><pre> <code class="bash hljs">https://origin.llcast.com/?action=server_list</code> </pre> <br>  The result will be a piece of JSON in which the balancer shows the recommended Edge server. <br><br><pre> <code class="php hljs">{ <span class="hljs-string"><span class="hljs-string">"server"</span></span>: <span class="hljs-string"><span class="hljs-string">"edge1.llcast.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"flash"</span></span>: <span class="hljs-string"><span class="hljs-string">"1935"</span></span>, <span class="hljs-string"><span class="hljs-string">"ws"</span></span>: <span class="hljs-string"><span class="hljs-string">"8080"</span></span>, <span class="hljs-string"><span class="hljs-string">"wss"</span></span>: <span class="hljs-string"><span class="hljs-string">"443"</span></span> }</code> </pre> <br>  In this case, the balancer returned the first server to edge1.llcast.com and showed that a secure Websocket connection (wss) can be established with the server on port 443. <br><br>  If you refresh the page in the browser, the balancer will give one Edge server, then another, in a circle.  This is how roundrobin works. <br><br>  It remains to turn on the balancer in the player.  To do this, in the player.js player code, add the lbUrl parameter when setting up a session with the server: <br><br><pre> <code class="php hljs">Flashphoner.createSession({urlServer: urlServer, mediaOptions: mediaOptions, lbUrl:<span class="hljs-string"><span class="hljs-string">'https://origin.llcast.com/?action=server_list'</span></span>})</code> </pre> <br>  The full player code is listed below: <br><br><pre> <code class="php hljs">https:<span class="hljs-comment"><span class="hljs-comment">//edge1.llcast.com:8888/client2/examples/demo/streaming/embed_player/player.js</span></span></code> </pre> <br>  We check the work of the balancer and make sure that it correctly scatters connections on the nodes of edge1.llcast.com and edge2.llcast.com.  To do this, simply update the player page and look in the Developer Tools Network tab, where you can see the connection to the balancer and to the server edge1.llcast.com (highlighted in red). <br><br><pre> <code class="php hljs">https:<span class="hljs-comment"><span class="hljs-comment">//edge1.llcast.com:8888/client2/examples/demo/streaming/embed_player/player.html</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d7d91de553021704.jpeg"></div><br><br><h2>  Final test </h2><br>  We set up Orign-Edge, relaying, balancing and connecting the player based on the balancer data.  It remains to put everything together and conduct a test demonstrating the work of the resulting CDN. <br><br>  1. Open the streamer page <br><br><pre> <code class="php hljs">https:<span class="hljs-comment"><span class="hljs-comment">//origin.llcast.com:8888/client2/examples/demo/streaming/two_way_streaming/two_way_streaming.html</span></span></code> </pre> <br>  We send a video stream from a webcam to the Origin server, named stream1 from the Google Chrome browser. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d812120137511852.jpeg"></div><br>  We go to the Dev Tools - Network and make sure that the translating browser has connected to the Origin server and sent a stream to it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d83cdab355309175.jpeg"></div><br>  2. Open the player page on the Edge server and play stream1 stream. <br><br><pre> <code class="php hljs">https:<span class="hljs-comment"><span class="hljs-comment">//edge1.llcast.com:8888/client2/examples/demo/streaming/embed_player/sample.html</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/59/e6/22/59e622d876b0c936203010.png"><br>  We see that the balancer issued edge1.llcast.com and the stream is currently being taken from it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d88d042339204054.jpeg"></div><br><br>  Then we update the page again and the balancer connects the player to the server edge2.llcast.com, which is located in Singapore. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d8bd54f668748509.jpeg"></div><br>  Thus, we coped with the first task and completed the configuration of a geographically distributed CDN based on WebRTC with low latency. <br><br>  Next, you need to check the delay and make sure that it is really low relative to RTT.  A good delay in the global network is a stable delay, not exceeding 1 second.  Check what happened with us. <br><br><h2>  Measure the delay </h2><br>  We assume that the delay value will differ depending on which server we connected to the player - on Edge1 in New York or on Edge2 in Singapore. <br><br>  In order to have some point of reference, we will make an RTT map in order to understand how our test network is arranged and what to expect from its participants.  We assume that there are no special losses and measure only the ping time (RTT). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d8e711b993186081.jpeg"></div><br>  As you can see, our test network is quite global and non-uniform in delay.  Streamer and player will be located in Novosibirsk.  Ping to Edge1 server in New York will be 170 ms, and to Edge2 in Singapore 306 ms. <br><br>  We will take this data into account when analyzing the test results.  For example, it is clear that if we broadcast the stream on Origin in Frankfurt, transfer it to Edge 2 in Singapore and take it from Novosibirsk, then the delay is expected to be no less (90 + 183 + 306) / 2 = 290 milliseconds. <br><br>  Let's check the assumptions in practice.  To obtain data on the delay, we use the test with a millisecond timer <a href="https://www.youtube.com/watch%3Fv%3D9cQT4urTlXM">from here</a> , using it as a virtual camera. <br><br>  We send the stream to Origin and make some screenshots when playing from <br>  Edge1 - server.  On the left is the local video from the camera with zero delay, and on the right is the video that came to the player through the CDN. <br><br>  Test results: <br><table><tbody><tr><td><p>  <b>Test number</b> </p></td><td><p>  <b>Latency (ms)</b> </p></td></tr><tr><td><p>  one </p></td><td><p>  386 </p></td></tr><tr><td><p>  2 </p></td><td><p>  325 </p></td></tr><tr><td><p>  3 </p></td><td><p>  384 </p></td></tr><tr><td><p>  four </p></td><td><p>  387 </p></td></tr><tr><td colspan="2"><p>  <b>Average latency: 370 ms</b> </p></td></tr></tbody></table><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d8f3a20975665316.png"></div><br>  As you can see, the average latency of the video stream on the way the content delivery Novosibirsk (streamer) - Frankfurt (Origin) - New York (Edge1) - Novosibirsk (player) was 370 milliseconds.  RTT on the same path = 90 + 84 + 170 = 344 milliseconds.  Thus, we get the result of 0.9 RTT, which is very, very good for delivering a live video stream, considering that the ideal result would be 0.5 RTT. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d914cc3939506257.png"></div><br>  <i>Delay and RTT for the route Edge1, New York</i> <br><br>  Now we will take the same stream from the Edge2 server in Singapore and understand how increasing RTT affects latency.  We do a similar test with the Edge2 server and arrive at the following results: <br><br><table><tbody><tr><td><p>  <b>Test number</b> </p></td><td><p>  <b>Latency (ms)</b> </p></td></tr><tr><td><p>  one </p></td><td><p>  436 </p></td></tr><tr><td><p>  2 </p></td><td><p>  448 </p></td></tr><tr><td><p>  3 </p></td><td><p>  449 </p></td></tr><tr><td colspan="2"><p>  <b>Average latency: 444 ms</b> </p></td></tr></tbody></table><br><br>  From this test we see that the ratio of delay to RTT is about 0.7, that is, better than in the previous test. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d92e887730500613.png"></div><br>  <i>Delay and RTT for route Edge2, Singapore</i> <br><br>  The test results suggest that with an increase in RTT, the delay value will not increase dramatically, but will smoothly approach 0.5 RTT. <br><br>  Anyway, the goal of building a geographically distributed CDN with a delay of less than a second is achieved and there is a field for future tests and optimizations. <br><br><h2>  Finally </h2><br>  As a result, we deployed three servers: Origin, Edge1 and Edge2, and not four, as promised at the beginning of the article.  Setting up, configuring, and testing TURN servers behind a firewall greatly increases already bloated material.  In this regard, we believe that it makes sense to issue it in a separate article.  In the meantime, just do not forget that the fourth server in this scheme can be a TURN server that serves WebRTC browsers on port 443, providing passability through firewalls. <br><br>  So, the CDN for WebRTC streams is configured and the delay is measured.  The final scheme of work came out like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/22/59e622d98be84990259553.png"></div><br>  How can this scheme be improved and expanded?  Can be improved in width.  For example, we add several Origin servers and set the balancer between them.  Thus, we will balance not only viewers, but also streamers - those who directly broadcast content from webcams: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e6/25/59e6250de534b559634663.png"></div><br>  CDN is still open for the demo access on the llcast.com domain.  Maybe we will freeze it soon, and the demo links will stop working.  Therefore, if there is a desire to measure the delay - welcome.  Good streaming! <br><br><h2>  Links </h2><br>  <a href="https://origin.llcast.com:8888/">https://origin.llcast.com:8888</a> - Origin Demo Server <br>  <a href="https://edge1.llcast.com:8888/">https://edge1.llcast.com:8888</a> - Edge1 demo server <br>  <a href="https://edge2.llcast.com:8888/">https://edge2.llcast.com:8888</a> - Edge2 demo server <br>  <a href="https://origin.llcast.com:8888/client2/examples/demo/streaming/two_way_streaming/two_way_streaming.html">Two Way Streaming</a> - demo streaming interface from webcam to Origin. <br>  <a href="https://edge1.llcast.com:8888/client2/examples/demo/streaming/embed_player/sample.html">Embed Player</a> - demo player interface with balancer between Edge1 and Edge2 <br>  <a href="https://flashphoner.com/">WCS5</a> - WebRTC server, on the basis of which the CDN is built </div><p>Source: <a href="https://habr.com/ru/post/340344/">https://habr.com/ru/post/340344/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340332/index.html">Theoretical informational approach to the analysis of sales funnel in contextual advertising</a></li>
<li><a href="../340336/index.html">HR-hack - a joint hackathon from Alfa-Bank, Unilever, Leroy Merlin, CRIC and Beeline</a></li>
<li><a href="../340338/index.html">Magento Dare to Share. Autumn - season Magento mitapov</a></li>
<li><a href="../340340/index.html">IPSec between Cisco ISR and RUH2 3G router using dynamically allocated IP</a></li>
<li><a href="../340342/index.html">How to create an electronic voting system on the blockchain?</a></li>
<li><a href="../340348/index.html">Odoo 11 is released - an open system for business automation</a></li>
<li><a href="../340350/index.html">Uptime Institute has prepared a certification program for modular data centers</a></li>
<li><a href="../340352/index.html">Structure and randomness of prime numbers</a></li>
<li><a href="../340354/index.html">Cocos2d-x - UI components</a></li>
<li><a href="../340356/index.html">The global consequences of a single mistake in Quagga</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>