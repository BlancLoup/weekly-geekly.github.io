<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating an electronic component model for Proteus on Lua</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have several long-term projects, one of which is the creation of a computer based on CDP1802. The main board modeled on paper and in Proteus. 
 Pret...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating an electronic component model for Proteus on Lua</h1><div class="post__text post__text-html js-mediator-article">  I have several long-term projects, one of which is the creation of a computer based on CDP1802.  The main board modeled on paper and in Proteus. <br>  Pretty soon the question arose: what about elements that are absent in Proteus? <br>  Many resources <a href="http://www.nedopc.org/forum/viewtopic.php%3Ft%3D10110">describe in detail</a> how to create your own C ++ model in Visual Studio. <br>  Unfortunately, when building on Linux, this option is not very convenient.  And what to do if you do not know C ++ or need to edit the model on the fly for debugging? <br>  And just want to focus on modeling, as much as possible to simplify everything else. <br>  So the idea was to make simulation models using scripts - on Lua. <br>  I ask those interested under the cat (2Mb gifs). <br><br><img src="https://habrastorage.org/files/691/fd5/6b9/691fd56b988743d4bd342bd5983ee323.jpg"><br><a name="habracut"></a><br><h4>  <b>Why do you need it</b> </h4><br>  If you forget about any exotics, such as writing a processor model, I have long been unaccustomed to do anything in the simulator - I connected sensors to debugs of a different type, an oscilloscope in my hands, a multimeter, JTAG / UART and debug myself. <br>  But when it was necessary to check the logic of the program in case of GPS failure / in motion and the like, I had to write a GPS emulation on another microcontroller. <br>  When it was necessary to do telemetry for a machine under the KWP2000 protocol, debugging ‚Äúlive‚Äù was inconvenient and dangerous.  And if one - oh, how uncomfortable. <br>  The ability to debug / test on the road or somewhere, where to carry with you the entire gentleman's set is simply inconvenient (we are talking primarily about hobby projects) - a good help, so there is a place for the simulator. <br><br><h4>  <b>Visual Studio C ++ and GCC</b> </h4><br>  I am writing all the software for GCC and I would also like to assemble the model under it, using the established libraries and code that it would be difficult to assemble under MSVS.  The problem was that the Proteus was built under the mingw32 DLL.  Various methods including manipulations with __thiscall and associates have been tried, but the options with assembly hacks did not suit the calls. <br>  A <a href="https://habrahabr.ru/users/moonglow/" class="user_link">moonglow</a> friend with extensive experience in such matters suggested and showed how to rewrite the C ++ interface in C using virtual tables.  Of the conveniences, apart from the possibility of assembling under Linux "on the job," the possibility, in theory, to write models even on Fortran would be a desire. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <b>Mimicking under C ++</b> </h4><br>  The idea of ‚Äã‚Äã‚Äúemulating‚Äù virtual classes in practice looks like this: <br>  The original C ++ virtual class header looks like this. <br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDSIMMODEL</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> INT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isdigital</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( CHAR* pinname )</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> VOID </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( IINSTANCE* instance, IDSIMCKT* dsim )</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> VOID </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runctrl</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( RUNMODES mode )</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> VOID </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actuate</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( REALTIME time, ACTIVESTATE newstate )</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indicate</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( REALTIME time, ACTIVEDATA* newstate )</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> VOID </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">simulate</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( ABSTIME time, DSIMMODES mode )</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> VOID </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( ABSTIME time, EVENTID eventid )</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; };</code> </pre> <br><br>  And here is the C version;  this is our pseudo-class and its virtual table <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDSIMMODEL</span></span></span><span class="hljs-class"> {</span></span> IDSIMMODEL_vtable* vtable; };</code> </pre><br><br>  Now we create a structure with pointers to functions that are inside the class (we will create and declare them separately) <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDSIMMODEL_vtable</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> __attribute__ ( ( fastcall ) ) ( *isdigital ) ( IDSIMMODEL* <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, EDX, CHAR* pinname ); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __attribute__ ( ( fastcall ) ) ( *setup ) ( IDSIMMODEL* <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, EDX, IINSTANCE* inst, IDSIMCKT* dsim ); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __attribute__ ( ( fastcall ) ) ( *runctrl ) ( IDSIMMODEL* <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, EDX, RUNMODES mode ); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __attribute__ ( ( fastcall ) ) ( *actuate ) ( IDSIMMODEL* <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, EDX, REALTIME atime, ACTIVESTATE newstate ); <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> __attribute__ ( ( fastcall ) ) ( *indicate ) ( IDSIMMODEL* <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, EDX, REALTIME atime, ACTIVEDATA* data ); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __attribute__ ( ( fastcall ) ) ( *simulate ) ( IDSIMMODEL* <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, EDX, ABSTIME atime, DSIMMODES mode ); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __attribute__ ( ( fastcall ) ) ( *callback ) ( IDSIMMODEL* <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, EDX, ABSTIME atime, EVENTID eventid ); };</code> </pre><br><br>  We write the necessary functions and create one copy of our ‚Äúclass‚Äù, which we will use <br><pre> <code class="cpp hljs">IDSIMMODEL_vtable VSM_DEVICE_vtable = { .isdigital = vsm_isdigital, .setup = vsm_setup, .runctrl = vsm_runctrl, .actuate = vsm_actuate, .indicate = vsm_indicate, .simulate = vsm_simulate, .callback = vsm_callback, }; IDSIMMODEL VSM_DEVICE = { .vtable = &amp;VSM_DEVICE_vtable, };</code> </pre><br><br>  And so on, with all the classes we need.  Since it is not very convenient to call such a structure, wrapper functions were written, some things were automated, missing, frequently used functions were added.  Even in the process of writing this article, I added a lot of new things, looking at the work from the other side. <br><br><h4>  <b>‚ÄúMake it as simple as possible, but not simpler.‚Äù</b> </h4><br>  As a result, the code grew and the feeling grew that it was necessary to change something: it took less time and effort to create a model than to write the same emulator for the microcontroller.  In the process of debugging models, it was necessary to constantly change something, experiment.  We had to rebuild the model on every detail, and working with text data in C leaves much to be desired.  Familiar, who would also be interested in this, were frightened by C (someone uses <s>Turbo</s> Pascal, someone uses <s>Q</s> Basic). <br><br>  I remembered Lua: it perfectly integrates into C, it is fast, compact, clear, dynamic typing is all that is needed.  As a result, I duplicated all the C functions in Lua with the same names, getting a completely self-contained method of creating models that does not require reassembly at all.  You can simply take the dll and describe any model only on Lua.  It is enough to stop the simulation, correct the text script, and again into battle. <br><h4>  <b>Modeling in Lua</b> </h4><br>  The main testing was conducted in Proteus 7, but the models created from scratch and imported into the 8th version behaved excellently. <br><br>  Let's create some simplest models and use their example to see what and how we can do. <br>  I will not describe how to create a graphical model itself, it is perfectly described <a href="http://www.nedopc.org/forum/viewtopic.php%3Ft%3D10110">here</a> and <a href="http://proyectosfie.webcindario.com/documentos/proteus/Creation%2520VSM%2520-%2520Modelos%2520Digitales.PDF">here</a> , so I‚Äôll stop on writing code. <br>  Here are 3 devices that we will consider.  I wanted to first start with the flashing of the LED, but then I decided that it was too sad, I hope I had not lost. <br>  Let's start with A_COUNTER: <br><br><img src="https://habrastorage.org/files/ba4/772/e29/ba4772e29973427595eba8f4e631b054.png"><br><br>  This is the simplest binary counter with an internal clock generator, all its conclusions are outputs. <br><br>  Each model has a DLL that describes the behavior of the model and interaction with the outside world.  In our case, all models dll will be the same, but the scripts are different.  So, create a model: <br><br><h5>  Model Description </h5><br><br><pre> <code class="lua hljs">device_pins = { {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A0"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A1"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A2"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A3"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, <span class="hljs-comment"><span class="hljs-comment">--       --     {is_digital=true, name = "A15", on_time=100000, off_time=100000}, }</span></span></code> </pre><br><br>  <b>device_pins</b> is a mandatory global variable containing a description of the device pins.  At this stage, the library only supports digital devices.  Support analog and mixed types in process. <br>  <b>is_digital</b> - our output works only with logical levels, while only true is possible <br>  <b>name</b> - the name of the output on the graphic model.  It must match exactly - the output binding inside Proteus goes by name. <br>  The two remaining fields speak for themselves - the pin switch time in picoseconds. <br><br><h5>  Required user defined functions </h5><br><br>  In fact, there is no strict need to create something in the script.  You can not write anything at all - there will be a dummy model, but for the minimum functionality you need to create a function <b>device_simulate</b> .  This function will be called when the state of the nodes (conductors) changes, for example, the logical level changes.  There is a <b>device_init</b> function.  it is called (if exists) once immediately after loading the model. <br>  To set the state of the output to one of the levels, there is the <b>set_pin_state</b> function, the first argument is the name of the output, the second is the desired state, for example, SHI, SLO, FLT, and so on <br><br>  To begin with, we will do so that at the launch all the conclusions are in logical 0, with the help of one-liner / <br>  We can refer to the output as through a global variable, for example, <b>A0</b> , And through its name as a string constant <b>‚ÄúA0‚Äù</b> through the global environment table _G <br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">device_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k, v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(device_pins) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> set_pin_state(<span class="hljs-built_in"><span class="hljs-built_in">_G</span></span>[v.name], SLO) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  Now we need to implement the counter itself;  Let's start with the master oscillator.  For this there is a function <b>timer_callback</b> , which takes two arguments - the time and the number of the event. <br>  Add the following call to the device_init after setting the output status: <br><pre> <code class="lua hljs">set_callback(NOW, PC_EVENT)</code> </pre><br><br>  <b>PC_EVENT</b> is a numeric variable containing the event code (we must declare it globally) <br>  <b>NOW</b> means that the event handler must be called after 0 picoseconds from the current time (the function takes as argument a <b>pico of a</b> second) <br>  And here is the handler function <br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timer_callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time, eventid)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> eventid == PC_EVENT <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k, v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(device_pins) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> set_pin_bool(<span class="hljs-built_in"><span class="hljs-built_in">_G</span></span>[v.name], get_bit(COUNTER, k) ) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> COUNTER = COUNTER + <span class="hljs-number"><span class="hljs-number">1</span></span> set_callback(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> + <span class="hljs-number"><span class="hljs-number">100</span></span> * MSEC, PC_EVENT) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  Upon the event, the <b>set_pin_bool</b> function is <b>called</b> , which controls the output, taking as an argument one of the two states, 1/0. <br><br>  You may notice that after switching the output, the set_callback is called again, because this function is planning non-periodic events.  The difference in the task time due to the fact that set_callback will be called in the future, so we need to add the time difference, and <b>time</b> just contains the current system time <br><br><div class="spoiler">  <b class="spoiler_title">Total, that's what happened</b> <div class="spoiler_text"><pre> <code class="lua hljs">device_pins = { {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A0"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A1"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A2"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A3"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A4"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A5"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A6"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A7"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A8"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A9"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A10"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A11"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A12"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A13"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A14"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"A15"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">100000</span></span>}, } PC_EVENT = <span class="hljs-number"><span class="hljs-number">0</span></span> COUNTER = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">device_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k, v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(device_pins) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> set_pin_state(<span class="hljs-built_in"><span class="hljs-built_in">_G</span></span>[v.name], SLO) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> set_callback(<span class="hljs-number"><span class="hljs-number">0</span></span>, PC_EVENT) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timer_callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time, eventid)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> eventid == PC_EVENT <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k, v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(device_pins) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> set_pin_bool(<span class="hljs-built_in"><span class="hljs-built_in">_G</span></span>[v.name], get_bit(COUNTER, k) ) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> COUNTER = COUNTER + <span class="hljs-number"><span class="hljs-number">1</span></span> set_callback(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> + <span class="hljs-number"><span class="hljs-number">100</span></span> * MSEC, PC_EVENT) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></div></div><br><br>  Everything else - the declaration, model initialization, and so on is done on the library side.  Although of course, all the same can be done in C, and Lua can be used for prototyping, the benefit of the function names are identical. <br>  Run the simulation and observe the operation of our model. <br><br><img src="https://habrastorage.org/files/d95/9c5/a11/d959c5a11e3c4a678e1bf28a2c9323c7.Gif"><br><br><h4>  <b>Debugging Features</b> </h4><br><br>  The main goal was to facilitate the writing of models and their debugging, so consider some of the possibilities of displaying useful information <br><br><h5>  Text messaging </h5><br><br>  4 functions for outputting messages to the log, the latter two automatically leading to stopping the simulation <br><br><pre> <code class="lua hljs">out_log(<span class="hljs-string"><span class="hljs-string">"This is just a message"</span></span>) out_warning(<span class="hljs-string"><span class="hljs-string">"This is warning"</span></span>) out_error(<span class="hljs-string"><span class="hljs-string">"This is error"</span></span>) out_fatal(<span class="hljs-string"><span class="hljs-string">"This is fatal error"</span></span>)</code> </pre><br><br><img src="https://habrastorage.org/files/2ba/606/da5/2ba606da569942148a711d4aaf7ea18c.png"><br><br>  Thanks to the capabilities of Lua you can easily, conveniently, quickly and clearly display any necessary information: <br><br><pre> <code class="lua hljs">out_log(<span class="hljs-string"><span class="hljs-string">"We have "</span></span>..#device_pins..<span class="hljs-string"><span class="hljs-string">" pins in our device"</span></span>)</code> </pre><br><br>  Now let's move on to our second model - ROM chips, and look at <br><h5>  <b>Popup windows</b> </h5><br>  Let's model our ROM and podabazhim it in operating time. <br>  Announcements of the conclusions here are no different, but we need to add the properties of our chip, first of all - the ability to load a memory dump from a file: <br><br><img src="https://habrastorage.org/files/2fd/d8c/ef6/2fdd8cef60d44f02a6ba04355882f14d.png"><br><br>  This is done in a text script when creating a model: <br><blockquote>  {FILE = "Image File", FILENAME, FALSE ,, Image / *. BIN} </blockquote><br><br>  Now we will make it so that when pausing the simulation, it was possible to view important information about the model, such as the contents of its memory, the contents of the address bus, the data bus, the running time.  To output binary data in a convenient form, there is a memory_popup. <br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">device_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> romfile = get_string_param(<span class="hljs-string"><span class="hljs-string">"file"</span></span>) rom = read_file(romfile) mempop, memid = create_memory_popup(<span class="hljs-string"><span class="hljs-string">"My ROM dump"</span></span>) set_memory_popup(mempop, rom, <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(rom)) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_suspend</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> == debugpop <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> debugpop, debugid = create_debug_popup(<span class="hljs-string"><span class="hljs-string">"My ROM vars"</span></span>) print_to_debug_popup(debugpop, <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">format</span></span>(<span class="hljs-string"><span class="hljs-string">"Address: %.4X\nData: %.4X\n"</span></span>, ADDRESS, <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>(rom, ADDRESS))) dump_to_debug_popup(debugpop, rom, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">0x1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> debugpop <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> print_to_debug_popup(debugpop, <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">format</span></span>(<span class="hljs-string"><span class="hljs-string">"Address: %.4X\nData: %.4X\n"</span></span>, ADDRESS, <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>(rom, ADDRESS))) dump_to_debug_popup(debugpop, rom, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">0x1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  The <b>on_suspend</b> function <b>is</b> called (if declared by the user) during pause.  If the window is not created - create it. <br>  The memory is transferred to the library as a pointer, then nothing needs to be released; the Lua garbage collector will do everything.  And we will create a <b>debug</b> type window, where we will output the variables we need and, for masking, we will transfer 32 bytes from the offset 0x1000: <br><br><img src="https://habrastorage.org/files/38b/239/5f8/38b2395f8e6445ea86eb1b14c59ecdfc.png"><br><br>  Finally, we implement the algorithm of the ROM itself, ignoring the OE, VPP and other CE findings <br><br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">device_simulate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> == get_pin_bool(<span class="hljs-built_in"><span class="hljs-built_in">_G</span></span>[<span class="hljs-string"><span class="hljs-string">"A"</span></span>..i]) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ADDRESS = set_bit(ADDRESS, i) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ADDRESS = clear_bit(ADDRESS, i) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> set_pin_bool(<span class="hljs-built_in"><span class="hljs-built_in">_G</span></span>[<span class="hljs-string"><span class="hljs-string">"D"</span></span>..i], get_bit(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>(rom, ADDRESS), i)) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br><img src="https://habrastorage.org/files/5ed/0d1/77d/5ed0d177da0d4e9b8fe39166ee407e53.Gif"><br><br>  Let's do something for our debugger: <br><div class="spoiler">  <b class="spoiler_title">create a software UART, in which we will display the contents of the data bus</b> <div class="spoiler_text"><pre> <code class="lua hljs">device_pins = { {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"D0"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"D1"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"D2"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"D3"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"D4"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"D5"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"D6"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"D7"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>}, {is_digital=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, name = <span class="hljs-string"><span class="hljs-string">"TX"</span></span>, on_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>, off_time=<span class="hljs-number"><span class="hljs-number">1000</span></span>}, } <span class="hljs-comment"><span class="hljs-comment">-- UART events UART_STOP = 0 UART_START = 1 UART_DATA=2 -- Constants BAUD=9600 BAUDCLK = SEC/BAUD BIT_COUNTER = 0 ----------------------------------------------------------------- DATA_BUS = 0 function device_init() end function device_simulate() for i = 0, 7 do if 1 == get_pin_bool(_G["D"..i]) then DATA_BUS = set_bit(DATA_BUS, i) else DATA_BUS = clear_bit(DATA_BUS, i) end end uart_send(string.format("[%d] Fetched opcode %.2X\r\n", systime(), DATA_BUS)) end function timer_callback(time, eventid) uart_callback(time, eventid) end function uart_send (string) uart_text = string char_count = 1 set_pin_state(TX, SHI) -- set TX to 1 in order to have edge transition set_callback(BAUDCLK, UART_START) --schedule start end function uart_callback (time, event) if event == UART_START then next_char = string.byte(uart_text, char_count) if next_char == nil then return end char_count = char_count +1 set_pin_state(TX, SLO) set_callback(time + BAUDCLK, UART_DATA) end if event == UART_STOP then set_pin_state(TX, SHI) set_callback(time + BAUDCLK, UART_START) end if event == UART_DATA then if get_bit(next_char, BIT_COUNTER) == 1 then set_pin_state(TX, SHI) else set_pin_state(TX, SLO) end if BIT_COUNTER == 7 then BIT_COUNTER = 0 set_callback(time + BAUDCLK, UART_STOP) return end BIT_COUNTER = BIT_COUNTER + 1 set_callback(time + BAUDCLK, UART_DATA) end end</span></span></code> </pre><br></div></div><br><img src="https://habrastorage.org/files/e2a/5f9/3b4/e2a5f93b47f0424ca2f4c6a97e3fa9bc.Gif"><br><br><h4>  <b>Performance</b> </h4><br>  An interesting question that worried me.  I took the model of the 4040 binary counter that comes with the Proteus 7 delivery and made my analogue. <br>  Using a pulse generator gave the input to both models of a square wave with a frequency of 100 kHz <br><br>  Proteus's 4040 = 15-16% CPU Load <br>  Library C = 25-28% CPU Load <br>  Library and Lua 5.2 = 98-100% CPU Load <br>  Library and Lua 5.3a = 76-78% CPU Load <br><br>  I did not compare the source code, but apparently optimized the virtual machine very much in version 5.3.  However, it is quite tolerant for the convenience of work. <br>  Yes, and optimization issues, I did not even begin to engage. <br><br>  This whole project was born as a spontaneous idea, and a lot more needs to be done: <br><h4>  <b>Immediate plans</b> </h4><br><ul><li>  Fix obvious bugs in code </li><li>  Minimize the ability to shoot yourself in the foot </li><li>  Document Doxygen code </li><li>  Perhaps go to luaJIT </li><li>  Implement analog and mixed device types </li><li>  With plugin for IDA </li></ul><br><br>  Of course, I would like to find like-minded people who want to help, if not with their participation in writing code, then with ideas and feedback.  After all, now a lot of things are hardcoded for the goals and tasks that I needed. <br><br><h4>  <b>Download no ads and SMS</b> </h4><br>  <a href="https://github.com/Pugnator/openvsm">Repository</a> with code. <br>  The ready-made library and debugging symbols for GDB are <a href="https://github.com/Pugnator/openvsm/tree/master/library">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/224739/">https://habr.com/ru/post/224739/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../224723/index.html">Million dollars for inflation theory</a></li>
<li><a href="../224727/index.html">How programmers look for differences</a></li>
<li><a href="../224731/index.html">We expand the service of building routes OSRM</a></li>
<li><a href="../224733/index.html">How to test non-public methods in .NET</a></li>
<li><a href="../224737/index.html">Training with super-human speed</a></li>
<li><a href="../224743/index.html">Deep disappointment or the First Hakaton of the Moscow Government</a></li>
<li><a href="../224747/index.html">Samsung launches the industry's first 3D V-NAND flash memory with 32 layers of memory cells.</a></li>
<li><a href="../224749/index.html">Ideas and opportunities for the development of electronics in Russia</a></li>
<li><a href="../224751/index.html">Some interesting and useful things for web developer # 18</a></li>
<li><a href="../224753/index.html">Dvorak or how to turn life into pain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>