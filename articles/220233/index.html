<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a Custom Scope in JEE and Spring</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Scope determines the life cycle of an object. For example, a java-bin (hereinafter just a bin) defined in RequestScope is created when an http request...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a Custom Scope in JEE and Spring</h1><div class="post__text post__text-html js-mediator-article">  Scope determines the life cycle of an object.  For example, a java-bin (hereinafter just a bin) defined in RequestScope is created when an http request is received and is released when the request is completed.  In JEE and in Spring there is an opportunity to create your own scope.  Those.  we can create objects with our own life cycle - they will be created for any of our events and also destroyed.  In JEE, the CDI (Context and Dependency Injection) specification is responsible for this, and in fact there already exists one such built-in scope.  This is a ConversationScope.  We have API and annotations for starting and ending a conversation.  If we do not use them, then by default ConversationScope behaves like RequestScope.  To track the conversation of each individual client, a special conversationId is used, which is usually added as an http request parameter.  But this approach does not work for web services.  And in Spring there is nothing like that at all.  But in my practice, the customer asked to make a web service that would use the same physical connection to the external system for several consecutive calls.  It was also necessary to store some amount of additional data.  Those.  it was necessary to save a certain state (an object with a connection and data) for a certain period of time, such an analogue of the conversation scope for the web service.  You can, of course, save this object in Mar, where our analogue of conversationId will be the key, and Mar will be put into ServleContext and get it all from the methods of the web service.  But it is inconvenient.  It is much more convenient when the server itself will inject us our object in a given conversationId.  Therefore, let's make our scope, which will work with the SOAP web service.  The web service itself cannot belong to any scope, but our bin, which we will inject into the web service, will belong to our scope. <br><a name="habracut"></a><br>  Creating CustomScope for Spring and JEE is almost the same.  For example, consider the creation of the following application: our web service will have a method that activates our scope and returns sessionId (analog of conversationId).  Then, using this id, we will call a method that will store the data in our scope.  Then we call the method that reads this data, and then close the scope.  The architecture in both cases is the same: <br><ul><li>  The class responsible for creating the beans of our scope is created and registered. </li><li>  A SOAP Handler is created that intercepts the sessionId parameter and sets the scope state for the current thread. </li><li>  A web service is created that contains methods for activating and deactivating the scope. </li></ul>  . <br>  In Spring, to create a web service, we will use Apache CXF to minimize the differences from JEE. <br><br><h4>  Creating context class scope. </h4><br>  The context is intended to generate / store / deactivate bins of our scope.  Each session in our Osprey is identified by a special id, which is stored in the ThreadLocal variable.  The context reads this id returns the bin instances of the corresponding current session, which are stored locally in the object of the Map class.  Those.  each sessionId thread will have its own value and the context will return the corresponding instances of the beans.  Accordingly, the context contains methods for activating and deactivating the session.  Now about this in more detail.  In addition to the methods for activating and de-activating in JEE, we need to implement the <code>javax.enterprise.context.spi.Context</code> interface, in Spring - <code>org.springframework.beans.factory.config.Scope</code> .  These interfaces are similar, so the implementations are also very similar.  For JEE we will make a class WsContext, for Spring - WsScope.  They consist of the following parts: <br><h5>  Storage session bins </h5><br><h6>  in JEE: </h6><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InstanceInfo</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CreationalContext&lt;T&gt; ctx; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T instance; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;Contextual, InstanceInfo&gt;&gt; instances = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;SessionId, Map&lt;Contextual, InstanceInfo&gt;&gt;();</code> </pre><br>  Here <code>instances</code> is a Map, where the key is the session id, and the Map value of the bins for this session.  But just references to bin are not enough for us  When you deactivate a CDI bean, you need to know the context in which the given bean was created, which is why the InstanceInfo class is used, in ctoro, ctx is the context, and instance is bin.  The key to Marin Bins is a <code>Contextual</code> object. <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;(); <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code></code></code> <h6> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;(); <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code></code> </h6> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;(); <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h5> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h5> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h5> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h5> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h5> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h5> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code class="java"><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;(); <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h5> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h5> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h5> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h5> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h4> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h4> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code class="java"><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h4> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h4> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h4> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h4> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h6> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <pre> <code class="hljs kotlin"><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String initialValue() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getCurrentSessionId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setCurrentSessionId(String currentSessionId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean isActive() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Map&lt;Contextual, InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Set&lt;Contextual&gt; keySet = map.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); instances.remove(id); }</code> <br>    JEE   ,      .        <code><span class="hljs-meta"><span class="hljs-meta">@PreDestroy</span></span></code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void deactivate() { String id = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope with id ="</span></span> + id + <span class="hljs-string"><span class="hljs-string">" doesn't exist"</span></span>); } Map&lt;String, Object&gt; objectsMap = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(id); Set&lt;String&gt; keySet = objectsMap.keySet(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object remove(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Runnable runnable = destructionCollbacks.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); Thread t = new Thread(runnable); t.start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual),  <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     <span class="hljs-literal"><span class="hljs-literal">null</span></span>,   ,       . <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } InstanceInfo&lt;T&gt; info = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(contextual); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.instance; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; T <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(), map); } map.put(contextual, info); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; }</code> <br>  Spring <br>  Spring    <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  <span class="hljs-literal"><span class="hljs-literal">null</span></span>.            <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code> .   <code><span class="hljs-keyword"><span class="hljs-keyword">get</span></span></code>  . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(String name, ObjectFactory&lt;?&gt; objectFactory) { Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = resolveContextualObject(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> new RuntimeException(<span class="hljs-string"><span class="hljs-string">"WsScope is inactive"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = objectFactory.getObject(); map.put(name, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object resolveContextualObject(String name) { String sessionId = currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Map&lt;String, Object&gt; map = instances.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (map == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Object <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> = map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String getConversationId() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSessionId.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@NormalScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> WsScope { }</code> <br>          scope.       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends Annotation&gt; getScope() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WsScope.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extension</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> WsContext getContext() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void afterBeanDiscovery(<span class="hljs-meta"><span class="hljs-meta">@Observes</span></span> AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">org</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">springframework</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beans</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">config</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomScopeConfigurer</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">property name="scopes"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">entry key="WsScope"</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean class="com.dataart.customscope.spring.context.WsScope" /</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/entry</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/map</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/property</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">           </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class">. </span></span><br><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">     </span></span><br><span class="hljs-class"><span class="hljs-class">       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scope</span></span></span><span class="hljs-class">       . </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JEE</span></span></span><span class="hljs-class">     , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       WsExtension.        </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">         scope.    WsContext   Extension.     Producer: </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><code class="java"><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span></code> . ..    : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Vetoed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsContext</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{...}</code> <br>            : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WsScope</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>  -: <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@WebService()</span></span> <span class="hljs-meta"><span class="hljs-meta">@HandlerChain(file = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"wshandler.xml"</span></span></span><span class="hljs-meta">, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsScopeTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static int id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsService srv; <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sessionId; } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void endWsScope(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { context.deactivate(); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void setName(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId, <span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">)</span></span>String name) { srv.setName(name); } <span class="hljs-meta"><span class="hljs-meta">@WebMethod()</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String sayHello(<span class="hljs-meta"><span class="hljs-meta">@WebParam(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ws-session-id"</span></span></span><span class="hljs-meta">)</span></span> String sessionId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> srv.hello(); } }</code> <br>  : <br> <code class="java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsCdiSoapHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SOAPHandler</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SOAPMessageContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>.getName()); <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WsContext context; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void close(MessageContext ctx) { } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleFault(SOAPMessageContext ctx) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> boolean handleMessage(SOAPMessageContext ctx) { <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> outbound = (<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>) ctx.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { soapBody = message.getSOAPBody(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SOAPException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } String methodName = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outbound) { LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[OUT] "</span></span> + methodName.replace(<span class="hljs-string"><span class="hljs-string">"Response"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"[IN] "</span></span> + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine(<span class="hljs-string"><span class="hljs-string">"Handler. Id="</span></span> + sessionId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findMethodName(String methodName, NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> methodName; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String findSessionId(NodeList nodes) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"ws-session-id"</span></span>.equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (firstChild == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Set&lt;QName&gt; getHeaders() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> <br>  Spring <br>  Spring    .   <code><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span></code>  <code><span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span></code> ,      -  -  . <br>  : <br> <code class="java"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Scope(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"WsScope"</span></span></span><span class="hljs-meta">, proxyMode = ScopedProxyMode.TARGET_CLASS)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsService</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id=<span class="hljs-string"><span class="hljs-string">"testWsService"</span></span> implementor=<span class="hljs-string"><span class="hljs-string">"#testWS"</span></span> address=<span class="hljs-string"><span class="hljs-string">"/WsTest"</span></span> publish=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; &lt;jaxws:handlers&gt; &lt;bean <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataart</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customscope</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spring</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsSoapHandler</span></span></span><span class="hljs-class">"&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:handlers</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/jaxws:endpoint</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"</span></span></span><span class="hljs-class">&gt;&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">/bean</span></span></span><span class="hljs-class">&gt;</span></span></code><span class="hljs-class"><span class="hljs-class"> </span></span><br><span class="hljs-class"><span class="hljs-class">  , </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">       </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@Autowired   . </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type"> </span></span></span></span><br><span class="hljs-class"><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">      custom scope  JEE  Spring     .     .   JEE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">  </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   -         </span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">   - JEE      .</span></span></span></span></code></code></code></code> </pre> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> <h4> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </h4> <code><code><code><code><code><code class="java">Contextual ‚Äì  ,  CDI     .  , CDI       T,    Contextual (Bean, Decorator, Interceptor) <br></code>  Spring: <br> private Map&lt;String, Map&lt;String, Object&gt;&gt; instances = new HashMap&lt;String, Map&lt;String, Object&gt;&gt;();</code> <br>  , Spring   . <br> <br>   . <br>    , id     ThreadLocal .  Spring JEE   . <br> <code class="java">private final ThreadLocal&lt;String&gt; currentSessionId = new ThreadLocal&lt;String&gt;() { protected String initialValue() { return null; } }; public String getCurrentSessionId() { return currentSessionId.get(); } public void setCurrentSessionId(String currentSessionId) { this.currentSessionId.set(currentSessionId); }</code> <br> <br>   <br>    JEE  Spring.      Map  id . <br> <code class="java">public void activate(String sessionId) { Map&lt;Contextual, InstanceInfo&gt; map = new HashMap&lt;Contextual, InstanceInfo&gt;(); instances.put(sessionId, map); this.currentSessionId.set(sessionId); }</code> <br>  JEE        , JEE       : <br> <code class="java">@Override public boolean isActive() { String id = currentSessionId.get(); return instances.containsKey(id); }</code> <br> <br>   <br>  JEE <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Map&lt;Contextual, InstanceInfo&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Set&lt;Contextual&gt; keySet = map.keySet(); for (Contextual contextual : keySet) { InstanceInfo instanceInfo = map.get(contextual); contextual.destroy(instanceInfo.instance, instanceInfo.ctx); } currentSessionId.set(null); instances.remove(id); }</code> <br>    JEE   ,      .        <code>@PreDestroy</code>      garbage collector. JEE ,   ,     ,     . <br> <br>  Spring <br>    : <br> <code class="java">public void deactivate() { String id = currentSessionId.get(); Thread currentThread = Thread.currentThread(); Map&lt;String, Object&gt; map = instances.get(id); if (map == null) { throw new RuntimeException("WsScope with id =" + id + " doesn't exist"); } Map&lt;String, Object&gt; objectsMap = instances.get(id); Set&lt;String&gt; keySet = objectsMap.keySet(); for (String name : keySet) { remove(name); } instances.remove(id); currentSessionId.set(null); }</code> <br>    JEE,  Spring     <code>remove</code>   .      <code>Scope</code> ,      . <br> <code class="java">public Object remove(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } Runnable runnable = destructionCollbacks.get(name); Thread t = new Thread(runnable); t.start(); return map.remove(name); }</code> <br> <code>destructionCallbacks</code>   : <br> <code class="java">private Map&lt;String, Runnable&gt; destructionCollbacks = new HashMap&lt;&gt;();</code> <br>         <code>Scope</code> <br> <code class="java">public void registerDestructionCallback(String name, Runnable callback) { destructionCollbacks.put(name, callback); }</code> <br>   , callback,    Spring,   ,      <code>registerDestructionCallback</code> .     ,    JEE,  . ..         custom scope  Spring. <br> <br>   <br>  JEE <br>     <br> <code class="java">public &lt;T&gt; T get(Contextual&lt;T&gt; contextual),  public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext)</code> <br>       ,   .     null,   ,       . <br> <code class="java">@Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual) { Map&lt;Contextual,InstanceInfo&gt; map = instances.get(currentSessionId.get()); if (map == null) { return null; } InstanceInfo&lt;T&gt; info = map.get(contextual); if (info == null) { return null; } return info.instance; } @Override public &lt;T&gt; T get(Contextual&lt;T&gt; contextual, CreationalContext&lt;T&gt; creationalContext) { T instance = contextual.create(creationalContext); InstanceInfo&lt;T&gt; info = new InstanceInfo&lt;T&gt;(); info.ctx = creationalContext; info.instance = instance; Map&lt;Contextual, InstanceInfo&gt; map = nstances.get(currentSessionId.get()); if (map == null) { map= new HashMap&lt;Contextual, Context.InstanceInfo&gt;(); instances.put(currentSessionId.get(), map); } map.put(contextual, info); return instance; }</code> <br>  Spring <br>  Spring    <code>get</code>  <code>resolveContextualObject</code> . <code>resolveContextualObject</code>     Spring   custom scope.       ,      .  ,      , ..  null.            <code>get</code> .   <code>get</code>  . <br> <code class="java">public Object get(String name, ObjectFactory&lt;?&gt; objectFactory) { Object object = resolveContextualObject(name); if (object != null) { return object; } String sessionId = currentSessionId.get(); if (sessionId == null) { throw new RuntimeException("WsScope is inactive"); } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { throw new RuntimeException("WsScope is inactive"); } object = objectFactory.getObject(); map.put(name, object); return object; } public Object resolveContextualObject(String name) { String sessionId = currentSessionId.get(); if (sessionId == null) { return null; } Map&lt;String, Object&gt; map = instances.get(sessionId); if (map == null) { return null; } Object object = map.get(name); return object; }</code> <br>   <code>org.springframework.beans.factory.config.Scope</code>       : <code>public String getConversationId()</code> .   ,    ,  javadoc,        . <br> <code class="java">public String getConversationId() { return currentSessionId.get(); }</code> <br> <br>  scope <br>  JEE <br>  JEE   ,     ,       scope. <br> <code class="java">@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD}) @Retention(RetentionPolicy.RUNTIME) @NormalScope public @interface WsScope { }</code> <br>          scope.       : <br> <code class="java">@Override public Class&lt;? extends Annotation&gt; getScope() { return WsScope.class; }</code> <br>  Spring <br>  Spring scope   ,     ,      . <br> <br>   (scope) <br>  JEE <br>  JEE      CDI Extension.    ,  Extension    <br> <code class="java">public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm)</code> <br>      : <br> <code class="java">context = new WsContext(); abd.addContext(context);</code> <br>  extension      <code>/META-INF/services/javax.enterprise.inject.spi.Extension</code> .       extension   . <br>   Extension : <br> <br> <code class="java">public class WsExtension implements Extension { private WsContext context; public WsContext getContext() { return context; } public void afterBeanDiscovery(@Observes AfterBeanDiscovery abd, BeanManager bm) { context = new WsContext(); abd.addContext(context); } }</code> <br> <br>  Spring <br>  Spring     scope.       <br> <code class="xml">&lt;bean class="org.springframework.beans.factory.config.CustomScopeConfigurer"&gt; &lt;property name="scopes"&gt; &lt;map&gt; &lt;entry key="WsScope"&gt; &lt;bean class="com.dataart.customscope.spring.context.WsScope" /&gt; &lt;/entry&gt; &lt;/map&gt; &lt;/property&gt; &lt;/bean&gt;</code> <br>           scope Singleton. <br> <br>     <br>       scope       . <br>  JEE <br>  JEE     ,        WsExtension.        ,          scope.    WsContext   Extension.     Producer: <br> <code class="java">public class WsContextProducer { @Inject private WsExtension ext; @Produces public WsContext getContext() { return ext.getContext(); } }</code> <br>          manged bean  JEE        scope Default (      ). ,     - CDI   WsScope  : default   Producer.      ,     , ..  Producer.     ,  CDI      .  JEE7     <code>@Vetoed</code> . ..    : <br> <code class="java">@Vetoed public class WsContext implements Context {...}</code> <br>            : <br> <code class="java">@Inject private WsContext context;</code> <br>  Spring <br> ..   scope   ,       : <br> <code class="java">@Autowired private WsScope scope;</code> <br> <br>   scope <br> -,        id    ws-session-id.     -   ,    id         . ..       .  id ,   id      (  ),            .   id  ,     <code>activate()</code>  .   id,     .      - ,    .       <code>deactivate()</code> .  -    (  WsService)     scope.          -. ..    id    -     ,   id. <br>  JEE <br> <code class="java">@WsScope public class WsService { ... }</code> <br>  -: <br> <code class="java">@WebService() @HandlerChain(file = "wshandler.xml", name = "") public class WsScopeTest { private static int id = 0; @Inject private WsContext context; @Inject private WsService srv; @WebMethod() public String startWsScope() { String sessionId = String.valueOf(id++); context.activate(sessionId); return sessionId; } @WebMethod() public void endWsScope(@WebParam(name = "ws-session-id") String sessionId) { context.deactivate(); } @WebMethod() public void setName(@WebParam(name = "ws-session-id") String sessionId, @WebParam(name = "name")String name) { srv.setName(name); } @WebMethod() public String sayHello(@WebParam(name = "ws-session-id") String sessionId) { return srv.hello(); } }</code> <br>  : <br> <code class="java">public class WsCdiSoapHandler implements SOAPHandler&lt;SOAPMessageContext&gt; { private static final Logger LOGGER = Logger.getLogger(WsCdiSoapHandler.class.getName()); @Inject private WsContext context; @Override public void close(MessageContext ctx) { } @Override public boolean handleFault(SOAPMessageContext ctx) { return true; } @Override public boolean handleMessage(SOAPMessageContext ctx) { Boolean outbound = (Boolean) ctx.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY); SOAPMessage message = ctx.getMessage(); SOAPBody soapBody; try { soapBody = message.getSOAPBody(); } catch (SOAPException e) { e.printStackTrace(); return false; } String methodName = null; NodeList nodes = soapBody.getChildNodes(); methodName = findMethodName(methodName, nodes); if (outbound) { LOGGER.fine("[OUT] " + methodName.replace("Response", "")); return true; } LOGGER.fine("[IN] " + methodName); String sessionId = findSessionId(nodes); context.setCurrentSessionId(sessionId); LOGGER.fine("Handler. Id=" + sessionId); return true; } private String findMethodName(String methodName, NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if (Node.ELEMENT_NODE == node.getNodeType()) { methodName = node.getLocalName(); } } return methodName; } private String findSessionId(NodeList nodes) { for (int i = 0; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); if ("ws-session-id".equals(node.getLocalName())) { Node firstChild = node.getFirstChild(); if (firstChild == null) { return null; } return firstChild.getNodeValue(); } NodeList childNodes = node.getChildNodes(); String id = findSessionId(childNodes); if (id != null) { return id; } } return null; } @Override public Set&lt;QName&gt; getHeaders() { return null; } }</code> <br>  Spring <br>  Spring    .   <code>@Inject</code>  <code>@Autowired</code> ,      -  -  . <br>  : <br> <code class="java">@Service @Scope(value = "WsScope", proxyMode = ScopedProxyMode.TARGET_CLASS) public class WsService { ... }</code> <br>   - <code>proxyMode = ScopedProxyMode.TARGET_CLASS</code> !   ,         , ..  - ,    .     ,         . <br>  -  : <br> <code class="xml">&lt;jaxws:endpoint id="testWsService" implementor="#testWS" address="/WsTest" publish="true"&gt; &lt;jaxws:handlers&gt; &lt;bean class="com.dataart.customscope.spring.context.WsSoapHandler"&gt;&lt;/bean&gt; &lt;/jaxws:handlers&gt; &lt;/jaxws:endpoint&gt; &lt;bean id="testWS" class="com.dataart.customscope.spring.testapp.WsTest"&gt;&lt;/bean&gt;</code> <br>  ,        , @Autowired   . <br> <br>  <br> <br>      custom scope  JEE  Spring     .     .   JEE,   ,    -         ,    - JEE      .</code></code></code></code> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/220233/">https://habr.com/ru/post/220233/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220219/index.html">We distribute 500K to the organization of circles of robotics</a></li>
<li><a href="../220225/index.html">HackDay City: from idea to prototype project for a city in 48 hours!</a></li>
<li><a href="../220227/index.html">What gets into deny ip any any?</a></li>
<li><a href="../220229/index.html">JSCS: JavaScript Code Style</a></li>
<li><a href="../220231/index.html">Chat bot applications via skype, jabber and whatsapp</a></li>
<li><a href="../220235/index.html">History of one internationalization</a></li>
<li><a href="../220237/index.html">12 little-known CSS features</a></li>
<li><a href="../220239/index.html">Sandbox Augmented Reality</a></li>
<li><a href="../220241/index.html">Domestic processor "Elbrus-4C" will soon be launched into mass production</a></li>
<li><a href="../220243/index.html">Yandex cloud platform: Cocaine in action</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>