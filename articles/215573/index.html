<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We lift the domain controller on Ubuntu Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This option can be useful for small organizations with computers running Windows. 
 There is no need to purchase a cheap Windows Server for organizing...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We lift the domain controller on Ubuntu Server</h1><div class="post__text post__text-html js-mediator-article">  This option can be useful for small organizations with computers running Windows. <br>  There is no need to purchase a cheap Windows Server for organizing AD and CAL licenses to access a domain controller. <br>  In the end, we have AD buns: group policies, differentiation of access rights to resources, etc. <br><a name="habracut"></a><br>  I tried to write a detailed algorithm of actions necessary for the organization of Active Directory (AD) Domain Controller (DC) based on Ubuntu Server. <br><br>  <i>Consider setting up a domain controller on the example of Ubuntu Server 12.04.4 LTS or Ubuntu Server 13.10, the instruction is suitable for both options without additional changes</i> <br><br><h5>  1. Installing Ubuntu </h5><br>  I think installing Ubuntu-server will not cause problems even for most computer users. <br>  When installing the OS, it is advisable to immediately specify the name of the machine on the network (hostname) with the domain <b>specified</b> (for example, I use <b>dc1.domain.local</b> ), so that later I would have to edit the configuration in the files less. <br>  If there is no DHCP server on the network, the installer will prompt you to enter the IP address, network mask, gateway, and DNS. <br>  During installation, it is also advisable to install an OpenSSH server in order to have remote access to the server, as well as correctly specify the time zone in which the machine is located. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  2. Configure Network Adapter Settings </h5><br>  Network settings are stored in the / etc / network / interfaces file <br>  We edit it to your taste.  As an editor, you can use nano, vi, etc. <br>  To edit the files, you will need root rights, you can get them for example <pre><code class="bash hljs">sudo su</code> </pre>  after that, you will work as root. <br>  <sub><i>The fact that you are working as a root user is indicated by a</i> # <i>sign</i> <i>at the command line prompt.</i></sub> <br>  Or you can assign sudo before each command that requires root access. <br><pre> <code class="bash hljs">sudo nano /etc/network/interfaces</code> </pre><br>  Your network interface configuration is likely to be <blockquote>  iface eth0 inet dhcp </blockquote>  let's change the settings to use a static ip-address. <br>  In my case, they look like this: <br><blockquote>  auto lo <br>  iface lo inet loopback <br><br>  auto eth0 <br>  iface eth0 inet static <br>  address 192.168.10.1 <br>  netmask 255.255.255.0 <br>  gateway 192.168.10.10 <br>  dns-nameservers 192.168.10.10 <br>  dns-search domain.local domain </blockquote>  After changing the network settings, you must restart the network service. <br><pre> <code class="bash hljs">/etc/init.d/networking restart</code> </pre><br><h5>  3. Install the necessary packages </h5><br>  If you still did not install the OpenSSH server in the first stage, you can do this with the command <pre> <code class="bash hljs">apt-get install ssh</code> </pre><br>  Before installing anything, it is better to first upgrade the system and packages with the command <pre> <code class="bash hljs">apt-get update &amp;&amp; apt-get upgrade</code> </pre><br>  In order for the computers of the network to check the time on our server we will install the ntp-server <br><pre> <code class="bash hljs">apt-get install ntp</code> </pre><br>  Samba4 will use the latest version and build from source, so we will need packages for its assembly and correct operation. <br><pre> <code class="bash hljs">apt-get install git checkinstall build-essential libacl1-dev libattr1-dev libblkid-dev libgnutls-dev libreadline-dev python-dev python-dnspython gdb pkg-config libpopt-dev libldap2-dev dnsutils libbsd-dev attr docbook-xsl libcups2-dev acl</code> </pre><br><h5>  4. Build Samba4 </h5><br>  For Samba to work correctly, you will need vfs support at the file system level, for this we make changes in / etc / fstab, you need to add <i>user_xattr, acl, barrier = 1</i> to the root partition settings <i>/</i> <br><pre> <code class="bash hljs">nano /etc/fstab</code> </pre>  Should get a string, something like this: <blockquote>  / dev / mapper / dc1 - vg-root / ext4 <b>user_xattr, acl, barrier = 1,</b> errors = remount-ro 0 1 </blockquote>  after which you need to restart the computer <pre> <code class="bash hljs">reboot</code> </pre>  Do not forget about root rights <pre> <code class="bash hljs">sudo su</code> </pre> <br>  Download the latest stable version of Samba from the GIT repository <pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> -b v4-1-stable git://git.samba.org/samba.git samba-v4-1-stable</code> </pre><br>  configure, compile and install Samba <pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> samba-v4-1-stable &amp;&amp; ./configure --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-debug &amp;&amp; make &amp;&amp; checkinstall</code> </pre>  The <i>--enable-debug</i> parameter is required to display more detailed information in Samba logs. <br><br>  After Samba is assembled and installed (this is a long time), for ease of use, you need to set the paths to the executable files / usr / local / samba / sbin and / usr / local / samba / bin in the files <i>/ etc / sudoers</i> variable <i>secure_path</i> and <i>/ etc / environment</i> <i>PATH</i> variable, adding the line <i>: / usr / local / samba / sbin: / usr / local / samba / bin</i> <br><pre> <code class="bash hljs">nano /etc/sudoers</code> </pre>  it should make something like this: <br><blockquote>  Defaults secure_path = "/ usr / local / sbin: / usr / local / bin: / usr / sbin: / usr / bin: / sbin: / bin <b>: / usr / local / samba / sbin: / usr / local / samba / bin</b> " </blockquote><pre> <code class="bash hljs">nano /etc/environment</code> </pre>  it should make something like this: <br><blockquote>  PATH = "/ usr / local / sbin: / usr / local / bin: / usr / sbin: / usr / bin: / sbin: / bin: / usr / games <b>: / usr / local / samba / sbin: / usr / local / samba / bin</b> " </blockquote><br>  reboot again (just in case) <br><pre> <code class="bash hljs">reboot</code> </pre><br><h5>  5. Raise AD </h5><br>  We will use Samba as the AD DNS server, so disable bind with the command <br><pre> <code class="bash hljs">service bind9 stop &amp;&amp; update-rc.d bind9 <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span></code> </pre><br>  There is a samba-tool for manipulating AD in Samba. <br>  For the initial Samba setup, enter the command <br><pre> <code class="bash hljs">samba-tool domain provision</code> </pre><br>  If at the first stage you specified the computer name correctly, all the settings that the program asks for can be left to the default. <br>  During the configuration, the password of the Administrator user for AD will be requested, it must meet the password complexity requirements of the default: at least one upper case letter, at least one digit, at least 8 characters. <br>  If the password did not come up in complexity and you saw an error like this: <br><blockquote>  ERROR (ldb): uncaught exception - 0000052D: Constraint violation - check_password_restrictions: the password is too short.  It should be equal or longer than 7 characters! </blockquote>  then before re-performing the initial configuration, you must delete the contents of the / usr / local / samba / private / and / usr / local / samba / etc / directories <br>  If you need to change the password complexity, you can do this with the command <pre> <code class="bash hljs">samba-tool domain passwordsettings <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --min-pwd-length=6 --complexity=off --max-pwd-age=0 --min-pwd-age=0</code> </pre>  this command disables the complexity requirement, disables password expiration, sets a minimum password length of 6 characters <br><br>  Next, you need to tweak the Samba settings and add the following lines to the <i>[global]</i> section <br><pre> <code class="bash hljs">nano /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/samba/etc/smb.conf</code> </pre><blockquote>  allow dns updates = nonsecure and secure <br>  printing = bsd <br>  printcap name = / dev / null </blockquote>  This will allow you to dynamically update the DNS records on the server when the workstation (under windows control) enters the domain and disable printing support, which constantly generates errors in the log. <br><br>  In the /etc/resolvconf/resolv.conf.d/head file, you must specify our DNS server, Samba 127.0.0.1 <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"nameserver 127.0.0.1"</span></span> &gt;&gt; /etc/resolvconf/resolv.conf.d/head</code> </pre>  and restart the resolvconf service <pre> <code class="bash hljs">service resolvconf restart</code> </pre><br>  Also install the Kerberos client <pre> <code class="bash hljs">apt-get install krb5-user</code> </pre>  and configure it on AD using the file created at the stage of the <i>samba-tool domain provision</i> <pre> <code class="bash hljs">mv /etc/krb5.conf /etc/krb5.conf.old cp /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/samba/private/krb5.conf /etc/krb5.conf</code> </pre><br>  To automatically start the Samba service, you need a script: <br><pre> <code class="bash hljs">nano /etc/init.d/samba4</code> </pre><div class="spoiler">  <b class="spoiler_title">/etc/init.d/samba4</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/sh ### BEGIN INIT INFO # Provides: samba4 # Required-Start: $network $local_fs $remote_fs # Required-Stop: $network $local_fs $remote_fs # Default-Start: 2 3 4 5 # Default-Stop: 0 1 6 # Short-Description: start Samba daemons ### END INIT INFO # # Start/stops the Samba daemon (samba). # Adapted from the Samba 3 packages. # PIDDIR=/var/run/samba SAMBAPID=$PIDDIR/samba.pid # clear conflicting settings from the environment unset TMPDIR # See if the daemon and the config file are there test -x /usr/local/samba/sbin/samba -a -r /usr/local/samba/etc/smb.conf || exit 0 . /lib/lsb/init-functions case "$1" in start) log_daemon_msg "Starting Samba 4 daemon" "samba" # Make sure we have our PIDDIR, even if it's on a tmpfs install -o root -g root -m 755 -d $PIDDIR if ! start-stop-daemon --start --quiet --oknodo --exec /usr/local/samba/sbin/samba -- -D; then log_end_msg 1 exit 1 fi log_end_msg 0 ;; stop) log_daemon_msg "Stopping Samba 4 daemon" "samba" start-stop-daemon --stop --quiet --name samba $SAMBAPID # Wait a little and remove stale PID file sleep 1 if [ -f $SAMBAPID ] &amp;&amp; ! ps h `cat $SAMBAPID` &gt; /dev/null then # Stale PID file (samba was succesfully stopped), # remove it (should be removed by samba itself IMHO.) rm -f $SAMBAPID fi log_end_msg 0 ;; restart|force-reload) $0 stop sleep 1 $0 start ;; *) echo "Usage: /etc/init.d/samba4 {start|stop|restart|force-reload}" exit 1 ;; esac exit 0</span></span></code> </pre></div></div><br>  it must be made executable <pre> <code class="bash hljs">chmod 755 /etc/init.d/samba4</code> </pre><br>  and create default settings <pre> <code class="bash hljs">update-rc.d samba4 defaults</code> </pre><br>  Reboot the computer <pre> <code class="bash hljs">reboot</code> </pre><br><h5>  6. We check server performance </h5><br>  We must have samba running after a reboot. <br><pre> <code class="bash hljs">ps aux | grep samba</code> </pre><blockquote>  root 865 0.3 3.0 95408 31748?  Ss 18:59 0:00 / usr / local / samba / sbin / samba -D </blockquote><br>  DNS server should work <br><pre> <code class="bash hljs">nslookup dc1</code> </pre><blockquote>  Server: 127.0.0.1 <br>  Address: 127.0.0.1 # 53 <br><br>  Name: dc1.domain.local <br>  Address: 192.168.10.1 </blockquote><br>  AD network resources must be available. <br><pre> <code class="bash hljs">smbclient -L localhost -U%</code> </pre><blockquote>  Domain = [DOMAIN] OS = [Unix] Server = [Samba 4.1.6] <br>  Sharename Type Comment <br>  - - - netlogon Disk <br>  sysvol disk <br>  IPC $ IPC IPC Service (Samba 4.1.6) <br>  Domain = [DOMAIN] OS = [Unix] Server = [Samba 4.1.6] <br>  Server Comment <br>  - - Workgroup Master <br>  - ------- </blockquote><br>  Must connect Kerberos <br><pre> <code class="bash hljs">kinit administrator</code> </pre><blockquote>  Warning: Your password will expire in 41 days on Wed Apr 23 18:49:14 2014 </blockquote><br>  Must be stored Ticket kerberos'a <br><pre> <code class="bash hljs">klist</code> </pre><blockquote>  Valid starting Expires Service principal <br>  03/12/2014 19:17 03/13/2014 05:17 krbtgt/DOMAIN.LOCAL@DOMAIN.LOCAL </blockquote><br>  Must pass through netlogon authentication <br><pre> <code class="bash hljs">smbclient //localhost/netlogon -UAdministrator -c <span class="hljs-string"><span class="hljs-string">'ls'</span></span></code> </pre><blockquote>  Domain = [DOMAIN] OS = [Unix] Server = [Samba 4.1.6] <br>  .  D 0 Wed Mar 12 18:46:48 2014 <br>  ... D 0 Wed Mar 12 18:49:15 2014 </blockquote><br><br>  That's all. <br>  You can enter in the client domain, get users. <br><br>  You can manage AD: <br>  <i>partly</i> with the samba-tool on Ubuntu <br>  using the Administration Tools Pack on Windows XP <br>  using Remote Server Administration Tools (RSAT) on Windows 7 and higher <br><br>  This post can be considered a kind of translation of the official Samba wiki, which is located at: <br>  <a href="https://wiki.samba.org/index.php/Samba_AD_DC_HOWTO">wiki.samba.org/index.php/Samba_AD_DC_HOWTO</a> , with my additions. <br><br>  PS If it will be interesting to someone, I can still write a ‚Äúmanual‚Äù about the inclusion of a backup controller on Ubuntu in the domain. </div><p>Source: <a href="https://habr.com/ru/post/215573/">https://habr.com/ru/post/215573/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215555/index.html">How we did the homework robot</a></li>
<li><a href="../215557/index.html">Bitcoin: Decentralized Electronic Monetary System</a></li>
<li><a href="../215559/index.html">Valve has unveiled the source for the Direct3D translator in OpenGL</a></li>
<li><a href="../215567/index.html">When the star goes out: an interview with Jim Weirich</a></li>
<li><a href="../215569/index.html">Secure Active Directory management. Part 1</a></li>
<li><a href="../215575/index.html">Sir Tim Berners-Lee: The World Wide Web is 25 years old. Keep it free and open.</a></li>
<li><a href="../215577/index.html">Strace</a></li>
<li><a href="../215581/index.html">As I bought, I finished and set up a Chinese 3D printer Wanhao Duplicator 4</a></li>
<li><a href="../215585/index.html">Network detectives: looking for the causes of traffic surges and load</a></li>
<li><a href="../215587/index.html">About the correct work of BA in a financial institution</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>