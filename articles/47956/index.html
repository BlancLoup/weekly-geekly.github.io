<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multi-user mode for Terminal Server in Windows XP x64</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the wake of a recent upgrade, I happened to face the unpleasant limitation of Windows XP x64 on the number of users simultaneously connected via Re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multi-user mode for Terminal Server in Windows XP x64</h1><div class="post__text post__text-html js-mediator-article">  In the wake of a recent upgrade, I happened to face the unpleasant limitation of Windows XP x64 on the number of users simultaneously connected via Remote Desktop.  Namely, at any given time, no more than one user can work with a computer.  When connecting via RDP, the local user is disabled;  when you log on locally, the remote is disabled.  It's a shame, given that the machine‚Äôs resources would be more than enough for several clients. <br><br>  As far as I know, this problem is inherent in all desktop (non-server) versions of Windows.  For the 32-bit version of Windows XP, there is a solution in the form of a TS-Free patch, which replaces several system libraries with older, but unlimited, versions.  For 64-bit systems, the solution usually comes down either to switching to the server version of the OS (respectively, considerable expenses), or to using third-party programs like <a href="http://www.thinsoftinc.com/product_thin_client_winconnect_server_vs64.aspx">WinConnect Server VS</a> (however, WinXP x64 is still not supported).  I already had time to despair, when in one Dutch blog I accidentally came across an article " <a href="http://www.remkoweijnen.nl/blog/2008/12/19/windows-xp-x64-terminal-server-patch-part-1-mandatory/">Windows XP x64 Terminal Server patch</a> ".  Unlike TS-Free, for which all antiviruses swear, in this article the author describes in detail which bytes are changing and why, so that the reader can independently verify the security of the patch. <br>  Below is a free translation of the article. <a name="habracut"></a><br><br>  Windows XP x64 is based on the same files as Windows 2003 x64, however Terminal Server in XP has some limitations.  This article demonstrates how to get rid of them.  The basis of the ideas cw2k from the original patch for Windows XP Terminal Server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1) <b>Winlogon.exe</b> contains the function <b>EnumerateMatchingUsers</b> , which calls <b>IsProfessionalTerminalServer</b> .  The last one needs to be fixed so that it returns zero (FALSE): <blockquote>  .text: 0000000100042F77 IsProfessionalTerminalServer proc near <font color="green">;</font>  <font color="green">CODE XREF: EnumerateMatchingUsers: loc_10002B44Bp</font> <br>  .text: 0000000100042F77 <font color="lightblue">;</font>  <font color="lightblue">DATA XREF: .pdata: 00000001000D01DCo ...</font> <br>  .text: 0000000100042F77 <br>  .text: 0000000100042F77 <font color="green">VersionInformation = <font color="blue">_OSVERSIONINFOW ptr</font> -138h</font> <br>  .text: 0000000100042F77 <font color="green">var_20 <font color="blue">= word ptr</font> -20h</font> <br>  .text: 0000000100042F77 <font color="green">var_ 1E <font color="blue">= byte ptr</font> -1Eh</font> <br>  .text: 0000000100042F77 <font color="green">var_18 <font color="blue">= qword ptr</font> -18h</font> <br>  .text: 0000000100042F77 <br>  .text: 0000000100042F77 48 81 EC 58 01 00 00 <font color="blue">sub rsp,</font> <font color="green">158h</font> <font color="red">=&gt; 31 C0 C3 xor eax, eax;</font>  <font color="red">retn</font> <br>  .text: 0000000100042F7E 48 8B 05 F3 3A 08 00 <font color="blue">mov rax, cs: __ security_cookie</font> <br>  .text: 0000000100042F85 48 89 84 24 40 01 00 00 <font color="blue">mov [rsp + <font color="green">158h</font> + <font color="green">var_18</font> ], rax</font> <br>  .text: 0000000100042F8D 48 8D 4C 24 20 <font color="blue">lea rcx, [rsp + <font color="green">158h</font> + <font color="green">VersionInformation</font> ]</font> ;  void * <br>  .text: 0000000100042F92 33 D2 <font color="blue">xor edx, edx</font> ;  int </blockquote><br>  But that is not all.  There is also a function <b>IsPerOrProTerminalServer</b> ;  it is used in several places, but we will only edit its calls from the <b>MultiUserLogonAttempt</b> : <blockquote>  .text: 0000000100044A91 E8 71 E5 FF FF <font color="blue">call IsPerOrProTerminalServer</font> <br>  .text: 0000000100044A96 85 C0 <font color="blue">test eax, eax</font> <br>  .text: 0000000100044A98 0F 84 C9 00 00 00 <font color="blue">jz loc_100044B67</font> =&gt; <font color="red">0F 8D C9 00 00 00 jmp loc_100044B67</font> <br>  .text: 0000000100044B13 E8 EF E4 FF FF <font color="blue">call IsPerOrProTerminalServer</font> <br>  .text: 0000000100044B18 85 C0 <font color="blue">test eax, eax</font> <br>  .text: 0000000100044B1A 74 0C <font color="blue">jz short loc_100044B28</font> <font color="red">=&gt; EB 0C jmp short loc_100044B28</font> </blockquote><br>  2) <b>Termsrv.dll</b> .  Let's make Terminal Server think that it is running on the server OS.  In <b>ServiceMain,</b> <em>termsrv.dll</em> initializes a global variable called <b>gbServer</b> .  We need it to be TRUE (1): <blockquote>  .text: 000007FF7B877F77 33 C9 <font color="blue">xor ecx, ecx</font> ;  ConditionMask <br>  .text: 000007FF7B877F79 C7 05 9D 2C 05 00 1C 01 00 00 <font color="blue">mov cs: gOsVersion.dwOSVersionInfoSize,</font> <font color="green">11Ch</font> <br>  .text: 000007FF7B877F83 C6 05 B0 2D 05 00 01 <font color="blue">mov cs: gOsVersion.wProductType,</font> <font color="green">1</font> <br>  .text: 000007FF7B877F8A FF 15 F8 9A FF FF <font color="blue">call cs: __ imp_VerSetConditionMask</font> <br>  .text: 000007FF7B877F90 48 8D 0D 89 2C 05 00 <font color="blue">lea rcx, gOsVersion</font> ;  lpVersionInformation <br>  .text: 000007FF7B877F97 BA 80 00 00 00 <font color="blue">mov edx,</font> <font color="green">80h</font> ;  dwTypeMask <br>  .text: 000007FF7B877F9C 4C 8B C0 <font color="blue">mov r8, rax</font> ;  dwlConditionMask <br>  .text: 000007FF7B877F9F FF 15 73 95 FF FF <font color="blue">call cs: __ imp_VerifyVersionInfoW</font> <br>  .text: 000007FF7B877FA5 8B CF <font color="blue">mov ec ec, ed</font> <font color="red">=&gt; 31 C9 x</font> <font color="blue">ec ec</font> <font color="red">, ecx</font> <br>  .text: 000007FF7B877FA7 48 8D 15 B2 AE FF FF <font color="blue">lea rdx, SubKey</font> ;  "System \\ CurrentControlSet \\ Control \\ Termin" ... <br>  .text: 000007FF7B877FAE 85 C0 <font color="blue">test eax, eax</font> <br>  .text: 000007FF7B877FB0 48 8D 44 24 60 <font color="blue">lea rax, [rsp + <font color="green">78h</font> + <font color="green">hKey</font> ]</font> <br>  .text: 000007FF7B877FB5 41 B9 19 00 02 00 <font color="blue">mov r9d,</font> <font color="green">20019h</font> ;  samDesired <br>  .text: 000007FF7B877FBB 0F 94 C1 <font color="blue">setz cl</font> <font color="red">=&gt; FF C1 90 inc ecx;</font>  <font color="red">nop</font> <br>  .text: 000007FF7B877FBE 45 33 C0 <font color="blue">xor r8d, r8d</font> ;  ulOptions <br>  .text: 000007FF7B877FC1 48 89 44 24 20 <font color="blue">mov [rsp + <font color="green">78h</font> + <font color="green">var_58</font> ], rax</font> <br>  .text: 000007FF7B877FC6 89 0D 30 B0 04 00 <font color="blue">mov cs: gbServer, ecx</font> </blockquote><br>  So, we "upgraded" to the server.  However, it is forbidden to disable the console on the server OS (STATUS_CTX_CONSOLE_DISCONNECT = $ C00A0027), so we need to fix two more places where this code is used: <blockquote>  .text: 000007FF7B889D99 85 C0 <font color="blue">test eax, eax</font> <br>  .text: 000007FF7B889D9B 75 21 <font color="blue">jnz short loc_7FF7B889DBE</font> <font color="red">=&gt; EB 21 jmp short loc_7FF7B889DBE</font> <br>  .text: 000007FF7B889D9D 48 8D 4B 18 <font color="blue">lea rcx, [rbx + <font color="green">18h</font> ]</font> <br>  .text: 000007FF7B889DA1 BF 27 00 0A C0 <font color="blue">mov ed, <font color="green">0C00A0027h</font></font> </blockquote>  once again: <blockquote>  .text: 000007FF7B88AA1B 45 85 E4 <font color="blue">test r12d, r12d</font> <br>  .text: 000007FF7B88AA1E 74 0A <font color="blue">jz short loc_7FF7B88AA2A</font> <font color="red">=&gt; EB 21 jmp short loc_7FF7B88AA2A</font> <br>  .text: 000007FF7B88AA20 BB 27 00 0A C0 <font color="blue">mov ebx, <font color="green">0C00A0027h</font></font> </blockquote><br>  On this with all the patches!  To apply them, do the following: <br><ul><li>  First, make sure you do it from a 64-bit process (for example, 64-bit explorer.exe)!  32-bit processes are redirected to the <em>% windir% \ SysWOW64 directory</em> (see <a href="http://msdn.microsoft.com/en-us/library/aa384187%2528VS.85%2529.aspx">File System Redirector</a> ). </li><li>  Back up <em>termsrv.dll</em> and <em>winlogon.exe</em> from <em>% windir% \ system32</em> .  In case the system does not boot, you will need them :) </li><li>  Delete (or rename) all the <em>termsrv.dll</em> and <em>winlogon.exe</em> files (they are usually located in <em>% windir% \ system32 \ DllCache</em> , in <em>% windir% \ ServicePackFiles</em> , or somewhere else).  You also need to deny the system access to its own distribution.  If done correctly, you will see messages like this: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/77e/1fc/e7b/77e1fce7b0d0d7fe949a6a8bb753aacd.png" alt="Windows File Protection"><br>  [ <i>Note: I did from Safe Mode, and there were no such messages.</i>  ] <br></li><li>  Using <a href="">Windows XP x64 Terminal Server Mandatory Patch</a> and <a href="">DUP2</a> , apply the patch to <em>termsrv.dll</em> and <em>winlogon.exe</em> . </li><li>  Copy the patched files back to <em>% windir% \ system32</em> .  A warning will appear again about changing system files. </li><li>  Reboot. </li></ul><br>  <b>Registry edit</b> : make sure that the following keys have the specified values. <ul><li>  <em>HKLM \ SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion \ Winlogon \ AllowMultipleTSSessions</em> = 1 </li><li>  <em>HKLM \ SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion \ Winlogon \ WinStationsDisabled</em> = 0 </li><li>  <em>HKLM \ SYSTEM \ CurrentControlSet \ Control \ Terminal Server \ WinStations \ Console \ fEnableWinStation</em> = 1 </li><li>  <em>HKLM \ SYSTEM \ CurrentControlSet \ Control \ Terminal Server \ WinStations \ RDP-Tcp \ fEnableWinStation</em> = 1 </li></ul><br>  Some nuances still remain: you cannot connect to localhost (solved by connecting to 127.0.0.2), and if you block your computer from the RDP session (not the console), you will simply disconnect (in the case of Fast User Switching, fast user switching).  The following article will be devoted to solving these problems. <br><br>  <em>PS ‚ÄúDonate‚Äù button turned out to be just the way, in order to thank the author for his joy :)</em> <em><br></em>  <em>PPS No, we are not in the lobe :)</em> </div><p>Source: <a href="https://habr.com/ru/post/47956/">https://habr.com/ru/post/47956/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../47946/index.html">Binaural Beats</a></li>
<li><a href="../47947/index.html">Maps of internet traffic and underwater fiber.</a></li>
<li><a href="../47952/index.html">Packard Bell EasyNote BG46. Almost ideal for 16930r.</a></li>
<li><a href="../47953/index.html">Are there any web services for putting invisible watermarks on images?</a></li>
<li><a href="../47955/index.html">Skin for Opera Habrahabr-style</a></li>
<li><a href="../47957/index.html">Russian software and outsourcing in Germany - 2</a></li>
<li><a href="../47958/index.html">Happy birthday, Linus!</a></li>
<li><a href="../47959/index.html">Service of manual placement of hyperlinks on someone else's text content</a></li>
<li><a href="../47960/index.html">Happy birthday, Linus!</a></li>
<li><a href="../47962/index.html">SQL Server 2008 free during training</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>