<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Compiled Distributed System Configuration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I would like to tell one interesting mechanism for working with the configuration of a distributed system. The configuration is represented directly i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Compiled Distributed System Configuration</h1><div class="post__text post__text-html js-mediator-article"><p>  I would like to tell one interesting mechanism for working with the configuration of a distributed system.  The configuration is represented directly in the compiled language (Scala) using safe types.  In this post, an example of such a configuration is examined and various aspects of implementing a compiled configuration into the overall development process are considered. </p><br><p><img src="https://habrastorage.org/webt/71/bl/ax/71blaxtldz-ia4yftyebaxbam7c.png" alt="Configuration life cycle"></p><br><p>  ( <a href="https://habr.com/ru/company/primetalk/blog/447690/">english</a> ) </p><a name="habracut"></a><br><h3 id="vvedenie">  Introduction </h3><br><p>  Building a reliable distributed system implies that all nodes use the correct configuration, synchronized with other nodes.  DevOps technology is usually used (terraform, ansible or something like) for automatic generation of configuration files (often its own for each node).  We would also like to be sure that on all interacting nodes identical protocols are used (including the same version).  Otherwise, incompatibility will be incorporated in our distributed system.  In the JVM world, one consequence of this requirement is the need to use the same version of the library containing the protocol messages everywhere. </p><br><p>  What about testing a distributed system?  Of course, we assume that unit-tests are provided for all components, before we proceed to integration testing.  (So ‚Äã‚Äãthat we can extrapolate test results at runtime, we also need to provide an identical set of libraries at the testing stage and in runtime.) </p><br><p>  When working with integration tests, it is often easier to use the same classpath everywhere on all nodes.  We will only have to ensure that the same classpath is involved in runtime.  (Despite the fact that it is quite possible to run different nodes with different classpaths, this leads to complication of the entire configuration and difficulties with deployment and integration tests.) In the framework of this post, we assume that the same classpath will be used on all nodes. </p><br><p>  The configuration evolves with the application.  We use versions to identify different stages of program evolution.  Apparently, it is also logical to identify different versions of configurations.  And the configuration itself is placed in the version control system.  If there is a single configuration in production, then we can use just the version number.  If multiple production instances are used, then we will need several <br>  configuration branches and an additional label in addition to the version (for example, the name of the branch).  In this way, we can uniquely identify the exact configuration.  Each configuration identifier uniquely corresponds to a certain combination of distributed nodes, ports, external resources, and library versions.  In this post, we will assume that there is only one branch, and we can identify the configuration in the usual way using three numbers separated by a dot (1.2.3). </p><br><p>  In modern environments, manual configuration files are rarely created.  More often, they are generated during deployment and no longer touch them (so as <a href="https://devrant.com/rants/1537005/dont-touch-it">not to break anything</a> ).  A legitimate question arises, why do we still use a text format to store the configuration?  A completely viable alternative is the ability to use ordinary code for configuration and get benefits from checks during compilation. </p><br><p>  In this post, we are exploring the idea of ‚Äã‚Äãrepresenting the configuration inside a compiled artifact. </p><br><h3 id="kompiliruemaya-konfiguraciya">  Compiled configuration </h3><br><p>  This section describes an example of a static compiled configuration.  Two simple services are implemented - echo service and client echo service.  Based on these two services, two system variants are assembled.  In one embodiment, both services are located on the same node, in another version - on different nodes. </p><br><p> Typically, a distributed system contains several nodes.  You can identify nodes using values ‚Äã‚Äãof some <code>NodeId</code> type: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Backend</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Frontend</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span></span></code> </pre> <br><p>  or </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">hostName: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><p>  or even </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">Singleton</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span></code> </pre> <br><p>  Nodes play different roles, services are running on them, and TCP / HTTP communications can be established between them. </p><br><p>  To describe TCP communication, we need at least a port number.  We would also like to reflect the protocol that is supported on this port to ensure that both the client and the server use the same protocol.  We will describe the connection using this class: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TcpEndPoint</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Protocol</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">node: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">NodeId</span></span></span></span><span class="hljs-class"><span class="hljs-params">, port: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Port</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Protocol</span></span></span></span><span class="hljs-class"><span class="hljs-params">]</span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><p>  where <code>Port</code> is just an integer <code>Int</code> with the range of valid values: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortNumber</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">Refined</span></span>[<span class="hljs-type"><span class="hljs-type">Int</span></span>, <span class="hljs-type"><span class="hljs-type">Closed</span></span>[_0, <span class="hljs-type"><span class="hljs-type">W</span></span>.`<span class="hljs-number"><span class="hljs-number">65535</span></span>`.<span class="hljs-type"><span class="hljs-type">T</span></span>]]</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Refined Types</b> <div class="spoiler_text"><p>  See the <a href="https://github.com/fthomas/refined/">refined</a> library and <a href="https://primetalk.github.io/talks/refined.html">my</a> <a href="https://youtu.be/qpYI90b5k5Y">report</a> .  In short, the library allows you to add constraints to types that are checked at compile time.  In this case, the valid values ‚Äã‚Äãfor the port number are 16-bit integers.  For the compiled configuration, the use of the refined library is not mandatory, but it does allow the compiler to improve its configuration checking capabilities. </p></div></div><br><p>  For HTTP (REST) ‚Äã‚Äãprotocols, in addition to the port number, we may also need the path to the service: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UrlPathPrefix</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">Refined</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">MatchesRegex</span></span>[<span class="hljs-type"><span class="hljs-type">W</span></span>.`<span class="hljs-string"><span class="hljs-string">"[a-zA-Z_0-9/]*"</span></span>`.<span class="hljs-type"><span class="hljs-type">T</span></span>]] <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortWithPrefix</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Protocol</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">portNumber: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">PortNumber</span></span></span></span><span class="hljs-class"><span class="hljs-params">, pathPrefix: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">UrlPathPrefix</span></span></span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Phantom types</b> <div class="spoiler_text"><p>  To identify the protocol at the compilation stage, we use a type parameter that is not used inside the class.  Such a solution is due to the fact that we do not use a protocol instance in runtime, but we would like the compiler to check protocol compatibility.  Due to the indication of the protocol, we will not be able to transfer inappropriate service as a dependency. </p></div></div><br><p>  One common protocol is the REST API with Json serialization: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonHttpRestProtocol</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestMessage</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResponseMessage</span></span></span><span class="hljs-class">]</span></span></code> </pre> <br><p>  where <code>RequestMessage</code> is the type of request, <code>ResponseMessage</code> is the type of the response. <br>  Of course, you can use other protocol descriptions that provide the accuracy we require. </p><br><p>  For the purposes of this post, we will use a simplified version of the protocol: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleHttpGetRest</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RequestMessage</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResponseMessage</span></span></span><span class="hljs-class">]</span></span></code> </pre> <br><p>  Here, the request is a string added to the url, and the response is the returned string in the body of the HTTP response. </p><br><p>  The service configuration is described by the service name, ports, and dependencies.  These elements can be represented in Scala in several ways (for example, <code>HList</code> , or algebraic data types).  For the purposes of this post, we will use Cake Pattern and represent the modules using <code>trait</code> 's.  (Cake Pattern is not a required element of the described approach. It is just one of the possible implementations.) </p><br><p>  The dependencies between services can be represented as methods that return <code>EndPoint</code> ports of other nodes: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoProtocol</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span></span>= <span class="hljs-type"><span class="hljs-type">SimpleHttpGetRest</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>, <span class="hljs-type"><span class="hljs-type">A</span></span>] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">portNumber</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">PortNumber</span></span> = <span class="hljs-number"><span class="hljs-number">8081</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">echoPort</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">PortWithPrefix</span></span>[<span class="hljs-type"><span class="hljs-type">EchoProtocol</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>]] = <span class="hljs-type"><span class="hljs-type">PortWithPrefix</span></span>[<span class="hljs-type"><span class="hljs-type">EchoProtocol</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>]](portNumber, <span class="hljs-string"><span class="hljs-string">"echo"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">echoService</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">HttpSimpleGetEndPoint</span></span>[<span class="hljs-type"><span class="hljs-type">NodeId</span></span>, <span class="hljs-type"><span class="hljs-type">EchoProtocol</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>]] = providedSimpleService(echoPort) }</code> </pre> <br><p>  To create an echo service, all that is needed is a port number and an indication that this port supports an echo protocol.  We could not specify a specific port, because  trait'y allow you to declare methods without implementation (abstract methods).  In this case, when creating a specific configuration, the compiler would require us to provide an implementation of the abstract method and provide the port number.  Since we have implemented the method, we may not specify a different port when creating a specific configuration.  The default value will be used. </p><br><p>  In the client configuration, we declare a dependency on the echo service: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMessage</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"test"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pollInterval</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">FiniteDuration</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">echoServiceDependency</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">HttpSimpleGetEndPoint</span></span>[_, <span class="hljs-type"><span class="hljs-type">EchoProtocol</span></span>[<span class="hljs-type"><span class="hljs-type">A</span></span>]] }</code> </pre> <br><p>  The dependency is of the same type as the <code>echoService</code> exported service.  In particular, in the echo client, we require the same protocol.  Therefore, when connecting two services, we can be sure that everything will work correctly. </p><br><div class="spoiler">  <b class="spoiler_title">Service implementation</b> <div class="spoiler_text"><p>  A function is required to start and stop the service.  (The ability to stop the service is critical for testing.) Again, there are several options for implementing such a function (for example, we could use type classes based on the configuration type).  For the purposes of this post, we will use the Cake Pattern.  We will represent the service using the <code>cats.Resource</code> class, since  this class already provides safe means of guaranteed release of resources in case of problems.  To get the resource we need to provide the configuration and ready runtime context.  The service launch function can be as follows: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResourceReader</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">[_], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class">] </span></span>= <span class="hljs-type"><span class="hljs-type">Reader</span></span>[<span class="hljs-type"><span class="hljs-type">Config</span></span>, <span class="hljs-type"><span class="hljs-type">Resource</span></span>[<span class="hljs-type"><span class="hljs-type">F</span></span>, <span class="hljs-type"><span class="hljs-type">A</span></span>]] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">[_]] </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> implicit resolver: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">AddressResolver</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">F</span></span></span></span><span class="hljs-class"><span class="hljs-params">], timer: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Timer</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">F</span></span></span></span><span class="hljs-class"><span class="hljs-params">], contextShift: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ContextShift</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">F</span></span></span></span><span class="hljs-class"><span class="hljs-params">], ec: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ExecutionContext</span></span></span></span><span class="hljs-class"><span class="hljs-params">, applicative: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Applicative</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">F</span></span></span></span><span class="hljs-class"><span class="hljs-params">] </span></span></span><span class="hljs-class">)</span></span>: <span class="hljs-type"><span class="hljs-type">ResourceReader</span></span>[<span class="hljs-type"><span class="hljs-type">F</span></span>, <span class="hljs-type"><span class="hljs-type">Config</span></span>, <span class="hljs-type"><span class="hljs-type">Unit</span></span>] }</code> </pre> <br><p>  Where </p><br><ul><li>  <code>Config</code> - the configuration type for this service. </li><li>  <code>AddressResolver</code> is a runtime object that allows you to find the addresses of other nodes (see below) </li></ul><br><p>  and other types from the <code>cats</code> library: </p><br><ul><li>  <code>F[_]</code> is the effect type (in the simplest case, <code>F[A]</code> may be just a function <code>() =&gt; A</code> In this post we will use <code>cats.IO</code> ) </li><li>  <code>Reader[A,B]</code> - more or less synonymous with <code>A =&gt; B</code> </li><li>  <code>cats.Resource</code> - a resource that can be <code>cats.Resource</code> and released </li><li>  <code>Timer</code> - timer (allows you to fall asleep for a while and measure time intervals) </li><li>  <code>ContextShift</code> - analogue of <code>ExecutionContext</code> </li><li>  <code>Applicative</code> is an effect type class that allows you to combine individual effects (almost a monad).  In more complex applications, it seems better to use <code>Monad</code> / <code>ConcurrentEffect</code> . </li></ul><br><p>  Using this function signature, we can implement several services.  For example, a service that does nothing: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeroServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">[_]] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">&lt;</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Any</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resource</span></span></span></span>(...): <span class="hljs-type"><span class="hljs-type">ResourceReader</span></span>[<span class="hljs-type"><span class="hljs-type">F</span></span>, <span class="hljs-type"><span class="hljs-type">Config</span></span>, <span class="hljs-type"><span class="hljs-type">Unit</span></span>] = <span class="hljs-type"><span class="hljs-type">Reader</span></span>(_ =&gt; <span class="hljs-type"><span class="hljs-type">Resource</span></span>.pure[<span class="hljs-type"><span class="hljs-type">F</span></span>, <span class="hljs-type"><span class="hljs-type">Unit</span></span>](())) }</code> </pre> </div></div><br><p>  (See the <a href="https://github.com/Primetalk/distributed-compilable-configuration">source code</a> , which implements other services - <a href="https://github.com/Primetalk/distributed-compilable-configuration/blob/master/src/main/scala/ru/primetalk/config/example/echo/EchoServiceService.scala">echo service</a> , <a href="https://github.com/Primetalk/distributed-compilable-configuration/blob/master/src/main/scala/ru/primetalk/config/example/echo/EchoClientService.scala">echo client</a> <br>  and <a href="https://github.com/Primetalk/distributed-compilable-configuration/blob/master/src/main/scala/ru/primetalk/config/example/meta/Meta.scala">time-of-life controllers</a> .) </p><br><p>  A node is an object that can start several services (the launch of the resource chain is provided by the Cake Pattern): </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SingleNodeImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeroServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IO</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoServiceService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FiniteDurationLifecycleServiceImpl</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">EchoConfig</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-type"><span class="hljs-type">EchoClientConfig</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-type"><span class="hljs-type">FiniteDurationLifecycleConfig</span></span> }</code> </pre> <br><p>  Note that we specify the exact type of configuration that is required for this node.  If we forget to specify one of the types of configuration required by a separate service, there will be a compilation error.  Also, we will not be able to start a node unless we provide an object of the appropriate type with all the necessary data. </p><br><div class="spoiler">  <b class="spoiler_title">Host name resolution</b> <div class="spoiler_text"><p>  To connect to a remote host, we need a real IP address.  It is possible that the address will be known later than the rest of the configuration.  Therefore, we need a function that displays the node ID to the address: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeAddress</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NodeId</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">host: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Uri</span></span></span></span><span class="hljs-class"><span class="hljs-params">.</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Host</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddressResolver</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">F</span></span></span><span class="hljs-class">[_]] </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resolve</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">NodeId</span></span>](nodeId: <span class="hljs-type"><span class="hljs-type">NodeId</span></span>): <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">NodeAddress</span></span>[<span class="hljs-type"><span class="hljs-type">NodeId</span></span>]] }</code> </pre> <br><p>  You can offer several ways to implement this function: </p><br><ol><li>  If the addresses become known to us before deployment, then we can generate the Scala code with <br>  addresses and then run the build.  This will compile and run the tests. <br>  In this case, the function will be known statically and can be represented in the code as a <code>Map[NodeId, NodeAddress]</code> . </li><li>  In some cases, the actual address becomes known only after the node has started. <br>  In this case, we can implement a "discovery service" (discovery) that runs up to the other nodes and all nodes will register with this service and request the addresses of other nodes. </li><li>  If we can modify <code>/etc/hosts</code> , we can use predefined host names (like <code>my-project-main-node</code> and <code>echo-backend</code> ) and simply link these names <br>  with IP addresses during deployment. </li></ol><br><p>  As part of this post, we will not consider these cases in more detail.  For our <br>  of the toy example, all nodes will have the same IP address - <code>127.0.0.1</code> . </p></div></div><br><p>  Next, we consider two variants of a distributed system: </p><br><ol><li>  Placement of all services on one site. </li><li>  And the placement of the echo service and the echo client on different nodes. </li></ol><br><p>  <a href="https://github.com/Primetalk/distributed-compilable-configuration/blob/master/src/main/scala/ru/primetalk/config/example/echo/SingleNodeConfig.scala">Single node</a> configuration: </p><br><div class="spoiler">  <b class="spoiler_title">Single node configuration</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SingleNodeConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FiniteDurationLifecycleConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">//</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">identifier</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">single</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">//</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">configuration</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">server</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">Singleton</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nodeId</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">Singleton</span></span> <span class="hljs-comment"><span class="hljs-comment">/** Type safe service port specification. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">portNumber</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">PortNumber</span></span> = <span class="hljs-number"><span class="hljs-number">8088</span></span> <span class="hljs-comment"><span class="hljs-comment">// configuration of client /** We'll use the service provided by the same host. */ def echoServiceDependency = echoService override def testMessage: UrlPathElement = "hello" def pollInterval: FiniteDuration = 1.second // lifecycle controller configuration def lifetime: FiniteDuration = 10500.milliseconds // additional 0.5 seconds so that there are 10 requests, not 9. }</span></span></code> </pre> </div></div><br><p>  The object implements the configuration of both the client and the server.  The lifetime configuration is also used to terminate the program after the <code>lifetime</code> interval.  (Ctrl-C also works and correctly frees all resources.) </p><br><p>  The same set of configuration traits and implementations can be used to create a system consisting of <a href="https://github.com/Primetalk/distributed-compilable-configuration/blob/master/src/main/scala/ru/primetalk/config/example/echo/TwoJvmConfig.scala">two separate nodes</a> : </p><br><div class="spoiler">  <b class="spoiler_title">Configuration for two nodes</b> <div class="spoiler_text"><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeServerConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SigTermLifecycleConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeId</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">NodeIdImpl</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nodeId</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">NodeServer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">portNumber</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">PortNumber</span></span> = <span class="hljs-number"><span class="hljs-number">8080</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NodeClientConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientConfig</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FiniteDurationLifecycleConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// NB! dependency specification def echoServiceDependency = NodeServerConfig.echoService def pollInterval: FiniteDuration = 1.second def lifetime: FiniteDuration = 10500.milliseconds // additional 0.5 seconds so that there are 10 request, not 9. def testMessage: String = "dolly" }</span></span></code> </pre> </div></div><br><p>  Important!  Notice how the services are bound.  We specify a service implemented by one node as an implementation of the method of the dependency of another node.  The type of dependency is checked by the compiler, since  contains the type of protocol.  At startup, the dependency will contain the correct target node identifier.  With this scheme, we specify the port number exactly once and always guaranteed to refer to the correct port. </p><br><div class="spoiler">  <b class="spoiler_title">Implementation of two system nodes</b> <div class="spoiler_text"><p>  For this configuration, we use the same service implementation unchanged.  The only difference is that now we have two objects that implement different sets of services: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TwoJvmNodeServerImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeroServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IO</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoServiceService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SigIntLifecycleServiceImpl</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">EchoConfig</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-type"><span class="hljs-type">SigTermLifecycleConfig</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TwoJvmNodeClientImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeroServiceImpl</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IO</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoClientService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FiniteDurationLifecycleServiceImpl</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">EchoClientConfig</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-type"><span class="hljs-type">FiniteDurationLifecycleConfig</span></span> }</code> </pre> <br><p>  The first node implements the server and needs only server configuration.  The second node implements the client and uses a different part of the configuration.  Both nodes also need lifetime control.  The server node runs indefinitely until <code>SIGTERM</code> is stopped, and the client node ends some time later.  See the <a href="https://github.com/Primetalk/distributed-compilable-configuration/blob/master/src/main/scala/ru/primetalk/config/example/echo/TwoJvmStarterApp.scala">launch application</a> . </p></div></div><br><h4 id="obschiy-process-razrabotki">  General development process </h4><br><p>  Let's see how this configuration approach affects the overall development process. </p><br><p>  The configuration will be compiled along with the rest of the code and an artifact (.jar) will be generated.  It seems to make sense to put the configuration into a separate artifact.  This is due to the fact that we can have many configurations based on the same code.  Again, you can generate artifacts that correspond to different configuration branches.  Along with the configuration, dependencies on specific versions of libraries are saved and these versions are saved forever, whenever we decide to deploy this version of configuration. </p><br><p>  Any configuration change turns into a code change.  And therefore, every such <br>  The change will be covered by the usual quality assurance process: </p><br><p>  Ticket in the bugtracker -&gt; PR -&gt; review -&gt; merging with the corresponding branches -&gt; <br>  integration -&gt; deployment </p><br><p>  The main consequences of implementing a compiled configuration: </p><br><ol><li><p>  The configuration will be coordinated on all nodes of the distributed system.  By virtue of the fact that all nodes receive the same configuration from a single source. </p><br></li><li><p>  It is problematic to change the configuration in only one of the nodes.  Therefore, configuration drift is unlikely. </p><br></li><li><p>  It becomes more difficult to make small changes to the configuration. </p><br></li><li><p>  Most of the configuration changes will occur as part of the overall development process and will be reviewed. </p><br></li></ol><br><p>  Do I need a separate repository to store the production-configuration?  This configuration may contain passwords and other secret information, access to which we would like to restrict.  Based on this, it seems to make sense to store the final configuration in a separate repository.  You can divide the configuration into two parts ‚Äî one containing the publicly available configuration settings and the other containing the restricted access parameters.  This will allow most developers to have access to common parameters.  This separation is easy to achieve using intermediate traits containing default values. </p><br><h3 id="vozmozhnye-variacii">  Possible variations </h3><br><p>  Let's try to compare the compiled configuration with some common alternatives: </p><br><ol><li>  Text file on the target machine. </li><li>  Centralized key-value storage ( <code>etcd</code> / <code>zookeeper</code> ). </li><li>  Process components that can be reconfigured / restarted without restarting the process. </li><li>  Storage configuration is out of artifact and version control. </li></ol><br><p>  Text files provide considerable flexibility in terms of small changes.  The system administrator can go to the remote site, make changes to the appropriate files and restart the service.  For large systems, however, this flexibility may be undesirable.  From the changes made there are no traces in other systems.  Nobody reviews the changes.  It is difficult to establish exactly who made the changes and for what reason.  Changes are not tested.  If the system is distributed, the administrator may forget to make a corresponding change on other nodes. </p><br><p>  (It should also be noted that the use of the compiled configuration does not close the possibility of using text files in the future. It is enough to add a parser and validator giving the same type of <code>Config</code> output, and you can use text files. From this it follows that the complexity of the system with the compiled configuration is somewhat less than the complexity of a system that uses text files, because additional code is required for text files.) </p><br><p>  Centralized key-value storage is a good mechanism for distributing the meta-parameters of a distributed application.  We need to decide what the configuration parameters are, and what is just data.  Suppose we have a function <code>C =&gt; A =&gt; B</code> , and the parameters <code>C</code> rarely change, and the data <code>A</code> - often.  In this case, we can say that <code>C</code> is the configuration parameters, and <code>A</code> is the data.  It seems that the configuration parameters differ from the data in that they generally change less frequently than the data.  Also, data usually comes from one source (from the user), and configuration parameters from another (from the system administrator). </p><br><p>  If rarely changing parameters need to be updated without restarting the program, then this can often lead to a complication of the program, because we need to somehow deliver the parameters, store, parse and check, handle incorrect values.  Therefore, from the point of view of reducing the complexity of the program, it makes sense to reduce the number of parameters that may change during the course of the program (or not to support such parameters at all). </p><br><p>  From the point of view of this post, we will distinguish between static and dynamic parameters.  If the logic of the service requires changing the parameters during the program, then we will call these parameters dynamic.  Otherwise, the parameters are static and can be configured using a compiled configuration.  For dynamic reconfiguration, we may need a mechanism for restarting parts of the program with new parameters in the same way as restarting operating system processes.  (In our opinion, it is desirable to avoid real-time reconfiguration, as the complexity of the system increases. If possible, it is better to use the standard OS capabilities for restarting processes.) </p><br><p>  One important aspect of using static configuration that makes people consider dynamic reconfiguration is the time it takes for the system to reboot after the configuration has been updated (downtime).  In fact, if we need to make changes to the static configuration, we will have to restart the system for the new values ‚Äã‚Äãto take effect.  The downtime problem has a different urgency for different systems.  In some cases, you can schedule a reboot at a time when the load is minimal.  In case continuous service is required, it is possible to implement <a href="https://aws.amazon.com/blogs/aws/elb-connection-draining-remove-instances-from-service-with-care/">"drain connections" (AWS ELB connection draining)</a> .  At the same time, when we need to reboot the system, we start a parallel instance of this system, switch the balancer to it, and wait until the old connections are completed.  After all the old connections have ended, we turn off the old instance of the system. </p><br><p>  Consider now the issue of storing the configuration inside or outside the artifact.  If we store the configuration inside the artifact, then, at a minimum, we had the opportunity to verify the correctness of the configuration during the assembly of the artifact.  If the configuration is outside a controlled artifact, it is difficult to track who made the changes to this file and why.  How important is it?  In our opinion, for many production-systems it is important to have a stable and high-quality configuration. </p><br><p>  The artifact version allows you to determine when it was created, which values ‚Äã‚Äãit contains, which functions are enabled / disabled, who is responsible for any change in the configuration.  Of course, storing the configuration inside the artifact requires some effort, so you need to make an informed decision. </p><br><h3 id="za-i-protiv">  Pros and cons </h3><br><p>  I would like to highlight the pros and cons of the proposed technology. </p><br><h4 id="preimuschestva">  Benefits </h4><br><p>  Below is a list of the main features of the compiled configuration of a distributed system: </p><br><ol><li>  Static configuration check.  Lets you be sure that <br>  configuration is correct. </li><li>   .         .   Scala      ,   . ,    <br> trait'    ,     ,    val',    (DRY)    .        ( <code>Seq</code> , <code>Map</code> ,  ). </li><li> DSL.  Scala    ,   DSL.        ,         , ,           .  , ,     . </li><li>     .    ,           ,       ,    ,   .        ,          .       ,       . </li><li>    .    ,    ,        . </li><li>   .          ,     . </li><li>  .     ,      .     . (  ,     ,     ,     ,     -.)       ‚Äî    .  , ,    ,       ,    . </li><li>  .          ,         .   , ,        .                .        .       ,       production'. </li><li>  Modularity.    ,            .  ,           ,    ‚Äî   .      production- . </li><li>  Testing.     mock-,     ,   . </li><li>  .                  .  , , ,     . </li></ol><br><h4 id="nedostatki-i-ogranicheniya">    </h4><br><p>               .    : </p><br><ol><li>  .       production',    .        .          .           . </li><li>  .  ,      ,        . </li><li> .      ,     ,    .    /      . </li><li>   .   DevOps    .             . </li><li>    .               (CI/CD).      . </li></ol><br><p>       ,      : </p><br><ol><li>      ,    ,        .    ,    Cake Pattern'     , , <code>HList</code>     (case class')   . </li><li>     ,     : ( <code>package</code> , <code>import</code> ,  ; <code>override def</code> '  ,    ).    ,    DSL.  ,    (, XML),       . </li><li>            . </li></ol><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>                  Scala.                 xml-   .   ,      Scala,          (  Kotlin, C#, Swift, ...).         , ,  ,    ,    ,   . </p><br><p> ,      .       . </p><br><p>     : </p><br><ol><li>         . </li><li>   DSL        . </li><li>         . ,       ,  (1)      ; (2)       . </li></ol><br><h3 id="blagodarnosti">  Acknowledgments </h3><br><p>     ,          . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/447694/">https://habr.com/ru/post/447694/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447682/index.html">Space data center: 24 hours before launch</a></li>
<li><a href="../447684/index.html">How in the office to show company values ‚Äã‚Äã(without posters and slogans)</a></li>
<li><a href="../447686/index.html">A very important parameter of LED lamps, of which very few people know</a></li>
<li><a href="../447688/index.html">To the question of bitset</a></li>
<li><a href="../447692/index.html">What DBMS do you use for Atlassian products?</a></li>
<li><a href="../447696/index.html">Why cities resist Amazon Go, first cashless stores</a></li>
<li><a href="../447698/index.html">Red Hogwarts: Academician without a diploma</a></li>
<li><a href="../447700/index.html">Emotional flexibility is the key to personal growth.</a></li>
<li><a href="../447702/index.html">There is no perfect mathematical circle.</a></li>
<li><a href="../447704/index.html">Climbing Elbrus - Reconnaissance. Technical Part 1. Registers, stacks and other technical details</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>