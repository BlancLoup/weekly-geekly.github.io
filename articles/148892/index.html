<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Place Lucene index in RAM using Azul Zing JVM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The entire Google search index has been located in RAM memory for at least 5 years. Why not try the same search index for Lucene? 

 Recently, RAM has...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Place Lucene index in RAM using Azul Zing JVM</h1><div class="post__text post__text-html js-mediator-article"> The entire Google search index has been located in RAM memory for at least 5 years.  Why not try the same search index for Lucene? <br><br>  Recently, RAM has become very inexpensive, so for high-loaded resources, it is quite reasonable to expect a serious performance improvement due to the placement of the search index entirely in RAM. <br><br>  The obvious question is - can we try to load the entire index into the <code>RAMDirectory</code> class provided by Lucene? <br><a name="habracut"></a><br>  Unfortunately, this class is known for creating a very serious load on the garbage collector (GC): each file is presented as a list of fragments of the type <code>byte[1024]</code> .  Also, it contains unnecessary synchronization mechanisms: if the application updates the index (that is, not only searches), the problem of how to save the changes made in the <code>RAMDirectory</code> back to the disk is a problem.  Start time is also significantly slowed down, due to the need for the initial loading of the index into memory.  Faced with this list of problems, Lucene developers often recommend using <code>RAMDirectory</code> only for small indexes or for testing purposes, and in other cases rely on the memory management mechanisms of the operating system, and access it using the <code>MMapDirectory</code> class. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Despite these problems with the <code>RAMDirectory</code> class, developers are working to improve it, and many users are already using it in their projects. <br><br>  I recently learned about the Java <a href="http://www.azulsystems.com/products/zing/whatisit">Zing</a> virtual machine developed by <a href="http://azulsystems.com/">Azul</a> , which provides a pause-free garbage collector, even for very large heap volumes.  Those.  theoretically, a large load on the memory generated by the <code>RAMDirectory</code> class <code>RAMDirectory</code> not be a problem for Zing.  Let's check it out!  But first, let's make a brief explanation about how important it is to test the response time for all requests, and not to measure the average temperature in the hospital. <br><br><h5>  Percentiles for search query response time </h5><br>  By default, the utilities in the <a href="http://code.google.com/a/apache-extras.org/p/luceneutil/">luceneutil suite</a> measure the <i>average</i> response time, discarding extremely interesting extreme values.  This is done due to the fact that these utilities are designed to test the algorithms and the efficiency of the changes made to them, specifically ignoring random deviations made by extraneous delays at the level of the operating system, disk subsystem, garbage collector, etc. <br><br>  But for real-world search applications, what really matters is the total response time for all search queries.  Search is inherently an interactive process: the user sits and waits for the search result to return to him, and then clicks on the links.  If even 1% of requests take a lot of time, then this is already a serious problem!  Users are impatient, and very quickly move to competitors. <br><br>  Therefore, I modified lucenutil to separate the load client ( <a href="http://code.google.com/a/apache-extras.org/p/luceneutil/source/browse/sendTasks.py">sendTasks.py</a> ) into a separate module, which saves the response time for all requests;  as well as scripts ( <a href="http://code.google.com/a/apache-extras.org/p/luceneutil/source/browse/loadGraph.py">loadGraph.py</a> and <a href="http://code.google.com/a/apache-extras.org/p/luceneutil/source/browse/responseTimeGraph.py">responseTimeGraph.py</a> ) for plotting response time.  Also, the <a href="http://code.google.com/a/apache-extras.org/p/luceneutil/source/browse/responseTimeTests.py">responseTimeTests.py</a> directly launching script was developed for executing a series of tests, with increasing load (requests / sec), automatically stopping the testing when the load begins to exceed the server's performance.  As a nice addition, this approach allows you to measure the actual performance of the server, and not to extrapolate it from the averages. <br><br>  For the most accurate simulation of the time of sending real requests, the client sends them in accordance with the Poisson distribution.  The testing script works in one stream, and if we send requests at a speed of 200 requests per second, and the server for some reason died for 5 seconds, the request queue will grow to 1000. Unfortunately, a lot of load tests behave differently, and Get a separate client thread for each client being emulated. <br><br>  The client works (via ssh) on a separate machine, which is an important point, because the Lucene server (and not only the JVM) periodically sags in performance (for example, a swap occurs), which can slow down the load client and thus distort the results .  Ideally, the client runs on a dedicated machine, and does not experience any pauses.  Additionally, the Python garbage collector is disabled on the client to eliminate its negative impact. <br><br><h5>  Testing on Wikipedia </h5><br>  To test Zing, I indexed the full base of English-language Wikipedia as of 2.05.2012, having a volume of 28.78 GB of plain text, representing 33.3 million documents, about 1Kb in size, including built-in fields and term vectors.  Because of this, I can highlight results using the <code>FastVectorHighlighter</code> class.  As a result, the index turned out to be 78 GB.  For each test, the server loads the full index into <code>RAMDirectory</code> , after which the client sends requests from the list of the 500th most severe (the most common terms in the documents).  At the same time, the server re- <code>updateDocument</code> documents ( <code>updateDocument</code> ) at a speed of about 100 documents per second (~ 100 Kb / s). <br><br>  Each test was performed within an hour, the first 5 minutes required for warming up were excluded from the register.  The maximum heap capacity was 140 GB ( <code>-Xmx 140G</code> ).  To get a basic level of performance, I also tested <code>MMapDirectory</code> , with a maximum heap capacity of 4 GB.  The machine has 32 processor cores (64 with hyper-threading enabled) and 512 GB of RAM, the server is configured to work in 40 threads. <br><br>  I tested various load levels (queries / sec), starting at 50 (minimal) and up to 275 (very large), and then built graphs illustrating the perceptions of response time for various configurations.  The default parallel Oracle GC behaved terribly slow (Tens of seconds to clear the memory) so I didn‚Äôt even include it in the resulting report.  The new G1 collector turned out to be even slower at launch speed (it took 6 hours to load the index into <code>RAMDirectory</code> , as opposed to 900 seconds when using a competitive CMS collector), and during operation, requests experienced delays of more than 100 seconds, therefore I also did not include the results in the report (This was a surprise as G1 is positioned to work with large heap).  Thus, I tested three configurations: CMS, with its default settings and using the <code>MMapDirectory</code> class as the base level, as well as CMS and Zing, using the <code>RAMDirectory</code> class. <br><br>  On the minimum load (50 requests / sec), Zing showed good performance, providing minimal response time, even for the worst cases, while the CMS showed quite a long response time for a sufficiently large number of cases, even when using <code>MMapDirectory</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a5f/135/d3e/a5f135d3e88f29ca5ca50fe1402ec851.png" alt="image"><br><br>  To estimate the saturation limit of each of the configurations, I plotted the response time for 99% of cases and for different levels of load: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/522/219/07d/52221907d21f9566b76f514a33255741.png" alt="image"><br><br>  From this graph it can be concluded that for a bunch of <code>CMS + MMa</code> p, peak performance falls on a level somewhere between 100 and 150 requests / sec. Whereas, when using <code>RAMDirectory</code> , this peak falls on a level somewhere between 225 and 250 requests / sec.  This is a terrific performance boost!  This result is all the more interesting because if you measure the average response time, then the difference in performance between <code>RAMDirectory</code> and <code>MMapDirectory</code> not so noticeable. <br><br>  Let's build the same graph, but without the results for <code>CMS + MMapDirectory</code> and also remove the results for a load of 275 queries / s (as it clearly goes beyond the capabilities of our equipment): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a38/fbe/579/a38fbe5798ff4640382965b5c0044d9f.png" alt="image"><br><br>  For the 99% percentile, the Zing performance remains stable, while the CMS begins to show a long response time, starting at a load of 100 requests / sec.  Let's look at the figures with a load of 225 requests / sec, which is closest to the saturation limit and when using <code>RAMDirectory</code> together with CMS and Zing: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d23/822/48a/d2382248aa8fd78dbc518f722b8b9823.png" alt="image"><br><br>  The time spent on pauses is already significantly longer here than with a load of 50 requests / sec: Already starting with a percentile of 95%, the response time becomes too long: 4479 ms or more. <br><br><h5>  Zing works! </h5><br>  These tests demonstrate that when using the Zing garbage collector, a very short response time is achieved, even at extreme loads, when the application has a heap of 140 GB in size, and the Lucene index is 78 GB in <code>RAMDirectory</code> and is fully loaded into <code>RAMDirectory</code> .  Moreover, the application performance, measured in the number of requests per second, also significantly increases (approximately twice in the example), and also allows you to safely use <code>RAMDirectory</code> even for large indices, if they are running Zing. <br><br>  Most interestingly, Azul recently announced the availability of JVM Zing for open-source developers to use for development and testing purposes. </div><p>Source: <a href="https://habr.com/ru/post/148892/">https://habr.com/ru/post/148892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148884/index.html">Embedding Code Inspections in the Development Process</a></li>
<li><a href="../148885/index.html">Reading the latest news feed on the news site that you visit daily, is it fundamentally for you to have the time of its publication next to the news headline?</a></li>
<li><a href="../148886/index.html">Class for playing audio from iOS apps</a></li>
<li><a href="../148887/index.html">The principle of "confidence" of high-quality web design</a></li>
<li><a href="../148889/index.html">Five facts about the Belarusian labor market QA specialists</a></li>
<li><a href="../148893/index.html">Continuous integration in the cloud</a></li>
<li><a href="../148894/index.html">One day from our life</a></li>
<li><a href="../148895/index.html">We hand over positions?</a></li>
<li><a href="../148896/index.html">About how we vorpsimanii teskkt</a></li>
<li><a href="../148897/index.html">Video review of the laptop (slikbuk) HP ENVY 6</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>