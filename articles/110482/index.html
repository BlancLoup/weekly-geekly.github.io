<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Data Deduplication - NetApp Approach</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Data deduplication is a technology by which redundant data is detected and eliminated in disk storage. As a result, this reduces the amount of physica...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Data Deduplication - NetApp Approach</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/2f/0e/2f0e821c8910a318f90e7bb52ebdd4de.jpg" alt="image"><br>  <b><a href="http://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B5%25D0%25B4%25D1%2583%25D0%25BF%25D0%25BB%25D0%25B8%25D0%25BA%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F_%25D0%25B4%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D1%2585">Data deduplication</a></b> is a technology by which redundant data is detected and eliminated in disk storage.  As a result, this reduces the amount of physical media for storing the same amount of data. <br>  Data deduplication is one of the hottest topics in data storage systems of the last two or three years.  After all, it is obvious that in the huge amount of data that modern storage systems now have to store, inevitably there are duplicates and identical data, by eliminating which it would be possible to significantly reduce storage volumes. <br>  Perhaps the most successful were the implementation of deduplication technologies in the field of disk backup systems (for example, EMC Avamar, Data Domain), but NetApp was the first to announce the possibility of using deduplication for the so-called ‚Äúprimary storage‚Äù, that is, the main ‚Äúcombat‚Äù active data storage, as she was able to offer deduplication technology that practically does not reduce the productivity of his work. <br>  Today I would like to tell you how and by what means it was possible, and why it is not yet possible with others. <br><a name="habracut"></a><br>  So, deduplication is the elimination of duplicate data when it is stored on storage disks.  How? <br>  Under the common name "deduplication" can be hid at once a number of different implementations.  The simplest of these is the implementation of deduplication at the ‚Äúfile‚Äù level.  This is something that has long been implemented in "UNIX-like" file systems using the "links" mechanism.  The same physical block chain can be addressed from different points in the file system.  If, for example, the same standard library is used without modification by many different programs, then instead of copying the same file to dozens of places on the disk, we store one copy and replace the rest with a link.  When an OS or an application accesses the file system for this file, the file system transparently redirects this reference to that single instance via a link. <br><br>  But what to do if a new version of the library was released, which, although it differs by only a couple of hundred bytes of content, is already a whole different file?  Such a mechanism will not work.  It also does not work for ‚Äúnon-file‚Äù data, for example, in SAN storages operating on FC or iSCSI. It is for this reason that the link mechanisms, or ‚Äúfile deduplication‚Äù, are currently used in a relatively limited way.  Now, if it were possible to link to part of the content via a link! <br><br>  Such a mechanism began to be called sub-file or block deduplication.  It is no longer implemented at the level of the standard UNIX-like file system, since links in it can only be addressed to files, and to files as a whole. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If you recall my article on the foundation of all NetApp storage systems, the WAFL file structure, you will see why NetApp was so interested in deduplication.  After all, sub-file, block deduplication is absolutely naturally implemented in terms of WAFL, where ‚Äúeverything is links‚Äù to storage blocks. <br><br>  Where can deduplication be applied? <br>  I have already mentioned the backup storage, and in this area deduplication has been used for a relatively long time and successfully (often the same narrowly modified content, extensive files, user documents, including copies, for example, in different folders different users,).  But there are other promising applications. <br>  One of them is storing virtual machine data in a VMware ESX server virtualization environment, MS Hyper-V, Xen Server, and so on. <br>  However, using deduplication methods that work well with backups will most often fail.  No one wants to pay for space by a catastrophic drop in disk storage performance, as often happens. <br>  What is suitable for backups is not suitable for primary storage. <br>  It is necessary not only to eliminate duplicates, but also to do this in such a way that performance does not suffer. <br><br>  What makes deduplication so effective on virtual infrastructure data? <br>  Let me give you some of the most egregious example.  Suppose you are deploying a server virtualization system in a VMware environment, and you have a dozen Windows or Linux servers in the ESX data servers, each performing its own task.  All virtual machines of the same type, of course, are deployed from a previously prepared ‚Äútemplate‚Äù containing the reference OS, with all the necessary patches, settings and service packs. <br>  To create a new server, you simply copy this template and get a new, already configured and updated virtual machine consisting of individual settings file and a large ‚Äúvirtual disk‚Äù file containing all the files of the ‚Äúguest OS‚Äù and its applications. <br><br>  But at the same time, for a dozen of such virtual machines, you have a dozen almost completely identical virtual disks with folders / Windows / System32 (or / usr) inside, differing in only a few tens of kilobytes of individual settings in the registry and configuration files. <br>  Despite the fact that, formally, they are almost identical in content, each virtual machine will use its own ‚ÄúC:‚Äù drive on its storage system for a dozen gigabytes.  Multiplied by ten virtual machines, it already gives a weighty figure. <br>  Even more egregious situations are possible in the case of VDI (Virtual Desktop Infrasructure), where the number of ‚Äúvirtual desktops‚Äù can amount to hundreds, and they all, as a rule, use the same OS. <br><br>  The practice of using deduplication on these virtual disk files shows that the results of space savings often reach 75-90% of the initially occupied volume, "without deduplication". <br>  This is quite tempting, without much risk and overhead, without sacrificing performance, to free up on a terabyte of storage 750-900 gigabytes previously occupied by images of virtual machines of volume. <br><br>  Due to the fact that deduplication is carried out at the "sub-file" block level, different and not only identical files can be deduplicated, if only they have fragments of identical content within themselves within one 4KB block of the file system. <br><br>  Deduplication can be carried out directly at the time of writing data to discs, it is called "online deduplication", or it can be implemented by a "postprocess" offline. <br><br>  Rejecting the "online" deduplication, the one that occurs immediately upon receipt of data, Something we certainly lose. <br>  For example, if we record strongly duplicated data, say 1TB, of which 900GB are zeros, we will first have to allocate a place for the recording, 1TB in size, fill it with our ‚Äúzeroes by 90%‚Äù, and only then, during the deduplication process, 90% this space will become free. <br><br>  However, "offline" deduplication gives us a lot of very significant advantages. <br><ol><li>  We can use more efficient and accurate (read: slow and ‚Äúprocessor intensive‚Äù) duplicate data detection algorithms.  We do not need to make compromises in order not to overload the processor and not to reduce the performance of the storage system with deduplication. </li><li>  We can analyze and process significantly large amounts of data, since in the case of offline, we have available for analysis and use for deduplication all storage space, and not just the current, directly recorded portion of data. </li><li>  Finally, we can do deduplication when and where it is convenient for us. </li></ol><br><br>  Thus, it is not surprising that NetApp storage systems have chosen to use the ‚Äúoffline‚Äù method, because it allowed them to do deduplication with minimal impact on the actual disk performance of the system. <br>  As far as I know, today NetApp is the only manufacturer of storage systems that use deduplication, which is not afraid to officially recommend its use for so-called primary data, that is, basic, operational data, and not just backups and archives. <br><br>  How physically is the mechanism used in NetApp deduplication? <br>  We often hear that the NetApp storage systems FC and SAS hard drives use a ‚Äúnon-standard sector size‚Äù of 520, instead of 512 bytes.  ‚ÄúNon-standard‚Äù in quotes, because, oddly enough, it sounds, but the 520-byte sector (512b data + 8b CRC) should be considered ‚Äústandard‚Äù today, since it is this value that is approved by the ‚ÄúT10 committee‚Äù, an organization engaged in development and approval of standards in the field of SCSI.  Alas, quite a few storage systems have followed this new standard (except for NetApp, I only know EMC Clariion, as well as the highend-class systems, such as EMC Symmetrix and HDS USP), and using this sector format gives many correct and useful bonuses in operation. introducing additional protection against <a href="http://blog.aboutnetapp.ru/archives/294">non-monitored</a> RAID damage to the contents of a recorded sector.  The probability of such errors is very low, but still non-zero. <br>  However, in addition to this protection, NetApp uses such additional 8 bytes per sector to organize its data deduplication mechanism. <br><br><img src="https://habrastorage.org/storage/habraeffect/0a/ea/0aea7b0d2e469a4d85ba75691977ee58.png" alt="image">  (pic) <br><br>  The data block in WAFL is 4096 bytes.  A data block is something in file systems sometimes referred to as a ‚Äúdisk cluster‚Äù, a single addressable piece of data, not to be confused with a ‚Äúhigh availability‚Äù computer cluster.  This block, as you can see, consists of 8 sectors of 512 bytes. <br>  As I said earlier, each of these 512 bytes of data is ‚Äúgiven‚Äù at the system disk level another 8 bytes of CRC.  So, for a 4KB WAFL block, we have 64 bytes of the CRC ‚Äúchecksum‚Äù. <br>  The CRC has one big plus - it is very quickly and simply calculated.  However, there is also a minus - a so-called ‚Äúhash-collision‚Äù is possible, a situation when two blocks of different contents have the same hash result.  If we are guided only by the results of the comparison of the hashes, then we may well take for identical (and one of them to permanently delete) two blocks of different contents.  This probability is small, but it exists, and I‚Äôm sure you don‚Äôt want it to happen to your data. <br>  How to deal with hash collision?  The solution is to extend the hash and complicate the calculation algorithm.  However, this option is very resource-intensive, especially with regard to the storage system processor.  That is why CAS systems are Content-Addressable Storage, so-called ‚Äúfirst-generation deduplication,‚Äù for example, EMC Centera, VERY slow to write, and only suitable for archival storage of less-changing documents. <br>  But for online deduplicating, we most often simply have no other option. <br><br>  However, ‚Äúgoing offline‚Äù we get many new features at once, without being tied to the actual process of writing data to disk. <br>  The deduplication process, working in the background, makes up the base of the hashes of all blocks of the disk volume, and, by sorting it, gets a list of ‚Äúdata duplication suspects‚Äù.  Further, having received this list, and having sharply reduced the circle of ‚Äúsuspects‚Äù, and the volume of further work, the deduplication process goes through the disk, and over all potential duplicates it performs a trivial byte-by-step comparison operation.  And only after making sure that the contents of the considered blocks coincide completely and unconditionally, one of them frees up at the file system level, and the other changes the inode pointer, which previously pointed to the now released block.  The mechanism is somewhat similar to the mechanism of links in UNIX file systems, only applied not to files, but directly to blocks of file system data. <br><br>  ‚ÄúWhat prevents such a mechanism to apply on a regular file system?‚Äù - you ask.  If you read my previously published post, about <a href="http://habrahabr.ru/company/netapp/blog/99832/">the WAFL device</a> , you can easily answer your question.  Because on these file systems data blocks can be subsequently changed, overwritten.  Imagine that we have two different files, A and B, each consisting of three data blocks (4096Kb each), it so happens that the average of these three blocks is the same for both files (the other two are different).  We find this out, we use such ‚Äúlinks‚Äù, and instead of a link to the middle block of file B, we establish a link to the second block of file A. <br><br><img src="https://habrastorage.org/storage/habraeffect/2b/cc/2bccb35699c95c299713911c38465f65.png" alt="image"><br><br><img src="https://habrastorage.org/storage/habraeffect/e6/8c/e68c81bac806e5146d03086ed59a6614.png" alt="image"><br><br>  All is well, until any program needs to change this second block in any of these files.  By changing the contents of one file, we automatically change the contents of the second file as well.  Which, generally speaking, did not plan to change, it has its own content, and it belongs to a completely different task.  It just so happened that in the middle it turned out to be the same piece as the other file (for example, trivially, a sequence of zeros), until this file was changed. <br>  And what will happen if the block is changed?  Nothing good.  It turns out that the program, without knowing it, changed the contents of a completely extraneous file.  Now imagine that there are a hundred of these files in different places, and if some of them are read at the same time? <br><br><img src="https://habrastorage.org/storage/habraeffect/a8/b6/a8b6d06c6157154e06ab6e5e62c33b30.png" alt="image"><br><br>  This could work for backups, which are usually written only once, and no longer change, but absolutely not suitable for active ‚Äúprimary data‚Äù, which can be changed arbitrarily. <br><br>  As you remember from the <a href="http://habrahabr.ru/company/netapp/blog/99832/">article about the WAFL device</a> , it is designed in such a way that the block once written is no longer overwritten and changed as long as the file exists, and as long as there is at least one link from the active file system or any snapshot to the block.  And if you need to write a change to the file data, from the pool of free blocks, the place where the recording is made is allocated, then the pointer of the active file system is rearranged to this block (and the snapshot pointers remain on the previous blocks, so we have access to the new file contents simultaneously, "Active file system", and to its old contents, in a snapshot, if it was made. <br><br><img src="https://habrastorage.org/storage/habraeffect/cb/a3/cba3ef6578b77b053ac7d09713ecd716.png" alt="image"><br><br>  Such a storage device scheme is a guarantee that the situation of undesirable changes in the contents inside the file will not occur. <br>  Once recorded, blocks are guaranteed not to change, and we can perform any operations we need over them, being sure of their continued immutability, for example, replacing blocks with duplicate content with a link to a block with a single copy of this ‚Äúcontent‚Äù. <br><br>  Probably the most frequently asked question about deduplication will be: How does deduplication affect the performance of the storage system using it? <br><br>  First, it is necessary to take into account that, as mentioned above, deduplication, as a process, occurs ‚Äúoffline‚Äù, searching, finding and eliminating duplicate data blocks is a process with a background, the lowest priority, lower than that of workload processes.  Thus, even with running deduplication (which can be assigned to the lowest load hours), the controller's processor resources to the detriment of the workload are not involved. <br><br>  Secondly, although the deduplicated volumes of data have somewhat large amounts of associated metadata, which theoretically can increase the load on the system with large volumes of I / O, most users do not notice the effect of reducing the performance of deduplicated data at all.  And in some cases, by reducing read volumes and better cache load (and NetApp cache knows and can properly use deduplicated data), even an increase in performance can be observed, for example, during times of the so-called 'boot storm', simultaneous loading of several dozen or even hundreds of virtual machines when the vast majority of data read from disks are the same OS files loaded into memory for many different machines. <br><br>  However, nevertheless, NetApp gives <a href="http://www.netwell.ru/docs/netapp/tr-3505_rus_deduplication_best_practices.pdf">a</a> ‚Äúconservative‚Äù recommendation <a href="http://www.netwell.ru/docs/netapp/tr-3505_rus_deduplication_best_practices.pdf">in the documentation</a> to expect a performance degradation of between 5-10% in the worst combination of stored data load, sizing and testing deduplication before making a decision about ‚Äúoutput to production‚Äù.  For admins, it will be nice to know that if any undesirable effects are detected, the data at any time can be painlessly ‚Äúde-deduplicated‚Äù and ‚Äúpumped out‚Äù to its original state. <br><br>  Nevertheless, I repeat, numerous reviews of practical installations indicate the absence of any noticeable negative effect on performance at all. <br>  Saving space on tasks that are well amenable to deduplication, for example, on the contents of virtual machine disks, shows a saving of space <a href="http://blog.colovirt.com/2008/11/14/netapp-enabling-deduplication-asis-on-a-volume/">from 50%</a> (half of the volume previously occupied on disks) <a href="http://blog.colovirt.com/2008/11/14/netapp-enabling-deduplication-asis-on-a-volume/">to 75%</a> (three quarters of the previously occupied volume is released). <br><br>  By the way, deduplication, along with other NetApp technologies, such as RAID-DP, already described by Thin Provisioning, and snapshots, which was briefly in the WAFL article, allowed NetApp to announce an unprecedented <a href="http://www.netapp.com/us/solutions/infrastructure/virtualization/guarantee.html">50%</a> share of the industry <a href="http://www.netapp.com/us/solutions/infrastructure/virtualization/guarantee.html">saving</a> two years ago. <a href="http://www.netapp.com/us/solutions/infrastructure/virtualization/guarantee.html">guarantee</a> ", according to which NetApp ensures that the same amount of virtual machine data stored on any third-party storage system will fit on NetApp by half the amount of disks.  And in case of non-fulfillment of this promise - to deliver free missing disks.  However, as I know, nobody asked for the disks. <br><br>  And finally, it should be said that the data deduplication function is available on any NetApp storage system for free, and usually a license to activate it comes by default with any storage system, and if you suddenly had a system sold without it, you can get it for free from your vendor . </div><p>Source: <a href="https://habr.com/ru/post/110482/">https://habr.com/ru/post/110482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../110475/index.html">Report on the second meeting of the Apple Developers Community</a></li>
<li><a href="../110476/index.html">What is the difference between real testers and fake?</a></li>
<li><a href="../110478/index.html">5 major mistakes online stores</a></li>
<li><a href="../110479/index.html">3D buildings from OpenStreetMap</a></li>
<li><a href="../110480/index.html">Adobe (ADBE): the fourth quarter of 2010 (August - November)</a></li>
<li><a href="../110484/index.html">Guru Plug Server Standart - server-in-charge</a></li>
<li><a href="../110487/index.html">Holiday sale of games for iPhone</a></li>
<li><a href="../110488/index.html">Microsoft will introduce Windows for ARM processors in January</a></li>
<li><a href="../110490/index.html">The history of the development of Asterisk in detail</a></li>
<li><a href="../110492/index.html">Shop2CD - creation of PHPShop satellite sites and catalog copies on CD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>