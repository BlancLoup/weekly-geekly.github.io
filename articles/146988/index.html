<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with Java VisualVM during load testing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developing any large WEB application, sooner or later the question arises of conducting load testing. Such a question arose in our project. How w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with Java VisualVM during load testing</h1><div class="post__text post__text-html js-mediator-article">  When developing any large WEB application, sooner or later the question arises of conducting load testing.  Such a question arose in our project.  How we solved it you can learn from this article. <br><br><h4>  Actually, what are we going to do </h4><br>  The task was set as follows: <br><br>  It is necessary that the application withstand a load of at least 1500 simultaneous users who will work according to the following scenario: <br>  1. Open the application page <br>  2. Login to the system <br>  3. Downloading a large list of records from the database <br>  4. Logout <br><a name="habracut"></a><br><h4>  Characters </h4><br>  Application deployed on <b>IBM WebSphere Application Server 7</b> <br>  <b>Apache JMeter 2.7</b> was chosen as a load tool. <br>  We will see the test results using <b>Java VisualVM</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  How to make it all work? </h4><br><h5>  We configure Application Server </h5><br>  First, let's deploy our application to the <b>Application Server (hereinafter WAS).</b> <br>  1. In the address bar of the browser, enter 'https: //% hostname%: 9043 / ibm / console / logon.jsp <br>  2. Using the login and administrator password WAS get into the admin console itself <br><br><img src="https://habrastorage.org/storage2/d16/51c/81c/d1651c81c6dca0544496a0b872f53f76.png"><br><br>  3. Go to <b>Applications -&gt; Application Types -&gt; WebSphere enterprise applications</b> and get to the page: <br>  <b>Enterprise Applications</b> <br>  Use this page to manage installed applications.  A single application can be deployed to multiple servers. <br><br>  After installing the application (using the cherished Install button), our console will look like this: <br><br><img src="https://habrastorage.org/storage2/d73/066/bf1/d73066bf1b576a163fdc3e7c897845ae.png"><br><br>  The red rectangle highlights the main project application.  The rest are auxiliary modules. <br><br>  Fine!  We coped with it.  Now you need to configure WAS for working with Java VisualVM.  To do this, in the same AdminConsole, you must perform the following steps: <br>  1. <b>Servers -&gt; Server Types -&gt; WebSphere application servers -&gt; server1 -&gt; Java and Process Management -&gt; Process definition -&gt; Java Virtual Machine</b> <br><br>  Choose: <br>  <b>Flag</b> <br>  Debug Mode [false] <br><br>  <b>Debug arguments</b> <br>  -Xdebug -Xrunjdwp: transport = dt_socket, address = 52772, suspend = n, server = y, -Dwas.debug.mode = false <br><br>  <b>Generic JVM arguments</b> <br>  -Dclient.encoding.override = UTF-8 -Dfile.encoding = UTF-8 -Djavax.management.builder.initial = -Djava.rmi.server.hostname =% hostname% -Dcom.sun.management.jmxremote -Dcom. sun.management.jmxremote.port = 8686 -Dcom.sun.management.jmxremote.ssl = false -Dcom.sun.management.jmxremote.authenticate = false <br>  * In the -Djava.rmi.server.hostname = argument, instead of% hostname%, you must specify the name of the host on which WAS is installed.  % Signs are not put. <br><br><img src="https://habrastorage.org/storage2/0af/208/78b/0af20878b09da22ce6f05f518e776ff9.png"><br><br><h5>  Customize Java VisualVM </h5><br>  After setting the arguments and restarting the WAS service, you need to configure <b>Java VisualVM itself</b> <br>  1. If you have Sun JDK 6u7 and higher, then you already have VisualVM.  It is recommended to work with the latest version of Sun JDK 7, Java VisualVM is located in the $ JAVA_HOME \ jdk1.7.0 \ bin \ jvisualvm directory <br>  Also Java VisualVM can be downloaded <a href="http://java.net/projects/visualvm">separately.</a> <br>  2. Run Java VisualVM.  When you first start VisualVM may ask for a username and password, do not deny it <br>  3. General view of Java VisualVM <br><br><img src="https://habrastorage.org/storage2/035/73b/658/03573b65864dddc5d64852ee69285b62.png"><br><br>  As you can see, several applications were locally defined, including VisualVM itself. <br><br>  4. In the "Tools -&gt; Plug-ins" menu on the Available Plugins tab, the available plug-ins are displayed, if you wish, select and install the necessary ones.  For our purpose, they will not be needed, but it is worth knowing about them. <br>  5. Add the remote host for which the previous settings were made: <br><br><img src="https://habrastorage.org/storage2/9a1/1e8/bfa/9a11e8bfa8d4e15c9141c4382c0f4a15.png"><br><br>  6. Add JMX Connection.  Be sure to specify port 8686 after the host name and click OK <br><br><img src="https://habrastorage.org/storage2/7d5/20e/46a/7d520e46a74b5c242a9b8c5b16af9bec.png"><br><br>  7. After connecting to the remote host, select Open JMX Connection and you will be taken to the Overview of the desired process. <br><br><img src="https://habrastorage.org/storage2/b49/f74/525/b49f745253fdf1f03bb77dc8f75f9661.png"><br><br>  Here we will be interested in the Sampler tab (aka profiler).  The profiler has two modes: CPU and Memory.  The first profiles the methods in terms of the time spent in them, the second in terms of the objects created and destroyed.  Unfortunately Memory sampling is not supported for remote applications. <br>  For a more detailed view, select the desired method and click the Snapshot button, which will bring up a tree of methods (classes / packages) used for further analysis. <br><br><h6>  Important! </h6><br>  It is worth paying attention to the fact that this performance profiler is <b>instrumental</b> .  That is, rewrites the application code, adding calls to it in the profiler. <br>  Instrument profilers have rather large overheads, but they give the most accurate results.  The work of such a profiler can quite strongly distort the operation of the application, but the overhead in theory will be evenly distributed across all methods. <br><br><h5>  Create a project in JMeter </h5><br>  How to create a project in JMeter on Habr√© has already been written repeatedly, besides, no one has canceled manuals, so this part of the article will be told only about the nuances that we encountered. <br><br><h6>  Localhost </h6><br>  As the wonderful <a href="http://jmeter.apache.org/usermanual/jmeter_proxy_step_by_step.pdf">manual</a> says, to work in JMeter you need to Configure your browser as follows: <br><br><img src="https://habrastorage.org/storage2/51c/d2b/a7c/51cd2ba7c985b4b6a0fa8ac15f23e898.png"><br><br>  But what to do if you work in Russia, and the application server is deployed in the Dnepropetrovsk CR, and besides, the corporate IT security policy blocks all connections that do not use the necessary Proxy is not written there.  It was also found that if you work through the corporate proxy, the record in the Recording Controller did not go. <br><br>  In our case, the following "fake ears" helped: <br>  We connected to the application through the corporate Proxy, then in the browser settings, we changed the settings to localhost, reloaded the page and (wonderfully!) Worked on the remote host through localhost.  Then we had from the power of 5-7 minutes to record the script at a pace of ‚Äúwild panic‚Äù, after which the automatic configuration script changed the Proxy settings to the previous ones. <br><br><h6>  Name is Legion! </h6><br>  Create users and feed them JMeter. <br>  A simple script was written that added 1500 entries to the tUsers table with unique logins TEST1-TEST1500.  The password was all the same: 123456 <br>  Next to JMeter was added element SV Data Set Config <br><br><img src="https://habrastorage.org/storage2/eab/34d/0b3/eab34d0b35291d4634cd45f25bfb9fa5.png"><br><br>  Now in the tree of recorded requests, we can find the element responsible for the login to the system.  We had this ... / userLogin.web, which had the following meaning: <br>  LoginService | login | java.lang.String / 2004016611 | TEST1 | 1 | 2 | 3 | 4 | 1 | 5 | 6 | <br>  Here we see our login and password.  Why JMeter recorded the password 123456 as 1 | 2 | 3 | 4 | 1 | 5 | 6 |  still remains a mystery to me. <br><br>  Now our task is as follows: <br>  1. Create a * .csv file and place there 1500 view records <br>  LoginService | login | java.lang.String / 2004016611 | TEST1 | 1 | 2 | 3 | 4 | 1 | 5 | 6 | <br>  . <br>  . <br>  . <br>  LoginService | login | java.lang.String / 2004016611 | TEST1500 | 1 | 2 | 3 | 4 | 1 | 5 | 6 | <br>  2. Put this file in the same directory with the project <br>  3. Show JMeter to take them from this file. <br><br>  Small difficulties arose at the first stage. <br>  Copy to cells A1 and A2 <br>  LoginService | login | java.lang.String / 2004016611 | TEST1 <br>  LoginService | login | java.lang.String / 2004016611 | TEST2 <br>  Excel and stretch to A1500 <br>  LoginService | login | java.lang.String / 2004016611 | TEST1500 <br>  no problems.  Everything was also simple with the remaining part 1 | 2 | 3 | 4 | 1 | 5 | 6 |, which we copied 1,500 times without changes to cells B1-B1500.  But after transferring all this stuff into a text file, it turned out not very nice: <br>  LoginService | login | java.lang.String / 2004016611 | TEST1 |  1 | 2 | 3 | 4 | 1 | 5 | 6 | <br><br>  It is clear that the extra spaces are completely useless to us.  But how to remove them?  Pens to edit 1500 entries - not our method.  Having opened the file through Notepad ++, we tried to remove these spaces with the help of Replace, but, unfortunately, for it there is absolutely no difference for 1 where there is a space or 10. It does not see them and can only replace characters. <br>  Then EmEditor came to our rescue.  He calmly does all this: <br><br><img src="https://habrastorage.org/storage2/d8e/965/816/d8e9658169f1ebd58327eccd8468dd5a.png"><br><br>  After this incident, EmEditor has grown a lot in my eyes.  As practice has shown, this text editor helps out in other cases, for example, when you need to change something in the * .xml file of an already deployed application.  The same notebook or Notepad ++ gives up on this task and swears at access denied, but EmEditor does not. <br><br>  Renamed the prepared text file to 1500.csv and put it in the same folder as the project. <br><br>  Now it remains to explain JMeter how to use all this. <br>  To do this, in the SV Data Set Config we specify the file and set the name of the variable <br><br><img src="https://habrastorage.org/storage2/007/09a/565/00709a565b211f6cfa46a4ac9655eab8.png"><br><br>  And in ... / userLogin.web we specify this variable in the form $ {VariableName} <br><br><img src="https://habrastorage.org/storage2/721/311/b5f/721311b5f3600d7e1824ae28adad0a25.png"><br><br><h5>  We increase a bunch </h5><br>  In the apache-jmeter-2.7 \ bin directory, find the jmeter.bat file and open it with your favorite text editor. <br>  Find part there <br><br><img src="https://habrastorage.org/storage2/997/052/0ab/9970520ab056cf1f906602df98bb32c6.png"><br><br>  And for comfortable work we replace <br>  set HEAP = -Xms512m -Xmx512m <br>  on <br>  set HEAP = -Xms1024m -Xmx1024m <br>  This is also written in the jmeter startup manual (2.4 Running JMeter) <br><br><h6>  Finishing touches </h6><br>  Now we have almost everything ready to run the script.  It remains only to connect via RDP to our remote host and check that everything is fine (remove the parameters of the application server before testing): <br><br><img src="https://habrastorage.org/storage2/4bc/317/58c/4bc31758cbd8a9ba2c98fe9057b34d13.png"><br><br>  As you can see, everything is within reason.  We also look at how much memory the process of java.exe takes, which itself means WAS. <br><br><h4>  Test it's your time </h4><br>  We run the test and see how 1500 virtual users happily rushed into our long-suffering application.  In the meantime, we again switch to the remote table and see what happens there: <br><br><img src="https://habrastorage.org/storage2/a68/fcc/6a2/a68fcc6a21888bde41d98a2f1acdfa20.png"><br><br>  The application server CPU was 100% occupied during the entire test, which is not good at all.  So fall not long. <br>  We look now in VisualVM, the picture is not very joyful: <br><br><img src="https://habrastorage.org/storage2/bc4/44a/6cb/bc444a6cbe84b5edceb00d2d862628c6.png"><br><br>  Go to Sampler and see what CPU loads like this: <br><br><img src="https://habrastorage.org/storage2/274/5e7/449/2745e7449dd5c5fc76e9947bbe798b3f.png"><br><br>  Look in the SystemError log of the sphere: <br><br>  R log4j: WARN Continuable parsing error 209 and column 14 <br>  R log4j: WARN The content of an element of type "logger" must match "(param *, level?, Appender-ref *)". <br>  R log4j: WARN No appenders could be found for logger (org.springframework.web.context.support.XmlWebApplicationContext). <br>  R log4j: WARN Please initialize the log4j system properly. <br>  R log4j: WARN See <a href="http://logging.apache.org/log4j/1.2/faq.html">logging.apache.org/log4j/1.2/faq.html#noconfig</a> for more info. <br><br>  ... and we understand who is to blame. <br><br>  We check our assumption. <br>  To do this, find the folder with the deployed application in% WAS_HOME% \ AppServer \ profiles \ AppSrv01 \ installedApps \% ‚Äã‚ÄãHostName% Node01Cell \ app.ear \ app.war \ WEB-INF \.  We find there the file log4j.xml and in it wherever there are constructions of the form 'level value = "ANY LEVEL", we replace this level with the value off.  After this, we restart the WAS service. <br><br>  Run the test again: <br><br><img src="https://habrastorage.org/storage2/298/720/af7/298720af736f3d302caba18e183d9e98.png"><br><br>  It is quite another matter! <br><br><h4>  results </h4><br>  In this article, we reviewed the full cycle of setting up the environment for conducting load testing of a WEB application.  It is clear that the case with log4j alone was not limited; many other improvements were subsequently carried out, but I hope that the main point of the work is clear. <br><br>  If you have any questions, I will be happy to answer them.  Thanks for attention. <br><img src="http://habr.habrastorage.org/post_images/afa/19d/045/afa19d045b2bce238895a5f2856f9174.gif" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/146988/">https://habr.com/ru/post/146988/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../146982/index.html">% username%, and where did you start immersion in programming?</a></li>
<li><a href="../146983/index.html">Web development on node.js and express. We study node.js in practice</a></li>
<li><a href="../146984/index.html">Integration tests with Maven, JUnit and Spring</a></li>
<li><a href="../146986/index.html">Tutoronline.ru: online tutorial call on the Internet. How it works?</a></li>
<li><a href="../146987/index.html">About the power interchange with examples</a></li>
<li><a href="../146989/index.html">What paper periodicals do you read,%% username?</a></li>
<li><a href="../146990/index.html">Scalaxi again offers to go somewhere ...</a></li>
<li><a href="../146991/index.html">Up to Windows 8 you can upgrade for $ 39.99</a></li>
<li><a href="../146993/index.html">Using OpenCL in Python</a></li>
<li><a href="../146997/index.html">Do you plan to upgrade from Windows 7 to Windows 8?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>