<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Altera + OpenCL: we open the core</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 In the last article, I launched a simple OpenCL example on Altera's FPGA: 


// ACL kernel for adding two input vectors __kernel void vector...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Altera + OpenCL: we open the core</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/24d/b7d/6d4/24db7d6d40c34705b697925ebf922a21.jpg"><br><br>  Hello! <br><br>  In the <a href="http://habrahabr.ru/company/metrotek/blog/269009/">last article,</a> I launched a simple OpenCL example on Altera's FPGA: <br><pre><code class="hljs pgsql">// ACL kernel <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> adding two <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> vectors __kernel <span class="hljs-type"><span class="hljs-type">void</span></span> vector_add( __global const uint *<span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> x, __global const uint *<span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> y, __global uint *<span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> z ) { // <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">work</span></span> item <span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = get_global_id(<span class="hljs-number"><span class="hljs-number">0</span></span>); // <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> the vector elements z[<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>] = x[<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>] + y[<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>]; }</code> </pre> <br>  I deliberately did not go into details and showed the tip of the iceberg: the development process, the assembly of the project, the launch on the system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      During the preparation of the first article, it became wildly interesting to me what these lines turn into (from the FPGA).  Understanding the architecture will enable something to optimize and understand what resources are going for, as well as what is good and bad for this system. <br><br>  In this article we will try to open the core and find answers to the following questions: <br><ul><li>  What is its architecture? </li><li>  How is it configured?  How to get the data for processing? </li><li>  At what frequency does it work?  How is this determined? </li><li>  Is it possible to simulate only the core in RTL simulators? </li><li>  What blocks occupy the most resources?  Is it possible to somehow optimize it? </li></ul><br>  Let's take a look at his insides!  Welcome under the cut! <br><a name="habracut"></a><br><a name="altera_vision"></a><br><h2>  How does Altera see it </h2><br>  Before intently studying the project for FPGA, let's turn to various presentations from the vendor: what do they tell about the implementation in a high-level (marketing) language. <br><br>  I recommend to look a great presentation, introduction to OpenCL from Altera <br>  <a href="http://tcfpga.org/fpga2013/openCL_tutorial.pdf"><b>Harnessing the Power of FPGAs using Altera's OpenCL Compiler</b></a> ( <b>carefully</b> , more than a hundred slides, ~ 16 MB). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cc7/ab8/33b/cc7ab833b2fb4c58795c064cae7b302b.png" alt="image"><br><br>  The firmware consists of: <br><ul><li>  IP cores that provide access to the periphery (PCIe, external memory (DDR, QDR)). </li><li>  The kernels realized by the principle of the conveyor.  They are computed, described in the OpenCL kernels. </li><li>  Infrastructure: <b>Global</b> and <b>Local Memory Interconnect</b> . </li></ul><br>  Interconnect is the division of a common bus between modules that are masters and slaves (master and slave). <br><br>  In our case, wizards are the <b>cores</b> that read / write data in both global memory (this can be either host memory or external memory) or local (internal) memory, which can be called a cache.  As a result of the process of arbitration and multiplexing of data, modules appear, which, as we will see below, can consume a significant amount of resources. <br><br>  For convenience, the communication protocol between modules is standardized.  Altera uses <b>Avalon-</b> type interfaces in its projects: <b>Avalon-MM</b> (Memory Mapped) and <b>Avalon-ST</b> (Streaming).  I will not dwell on this in detail: the reader can independently read about it <a href="https://www.altera.com/content/dam/altera-www/global/en_US/pdfs/literature/manual/mnl_avalon_spec.pdf">here</a> .  In this article, most of the interconnect will be the Avalon-MM interface. <br><br>  Once again I will emphasize that all this is obtained <b>automatically</b> from the kernel description on OpenCL. <br><br><h2>  Post update results </h2><br>  In the last article I described the build results based on the work on the Quartus 14.1 version. <br>  Version 15.1 was released not long ago, and I decided to see if there were any big differences.  To do this, I regenerated the source and rebuilt them with a new version. <br><br>  Alas, in the OpenCL visualizer and profiler there were no changes (seemingly): their appearance still leaves much to be desired. <br><br>  <a href="">Build report</a> with <b>--profile</b> (with profiling counters): <br><pre> <code class="hljs cs">+-----------------------------------------------------------------------------------+ ; Fitter Summary ; +---------------------------------+-------------------------------------------------+ ; Fitter Status ; Successful - Sun Nov <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> ; ; Quartus Prime Version ; <span class="hljs-number"><span class="hljs-number">15.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Build <span class="hljs-number"><span class="hljs-number">185</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>/<span class="hljs-number"><span class="hljs-number">21</span></span>/<span class="hljs-number"><span class="hljs-number">2015</span></span> SJ Standard Edition ; ; Family ; Cyclone V ; ; Device ; <span class="hljs-number"><span class="hljs-number">5</span></span>CSEMA5F31C6 ; ; Timing Models ; Final ; ; <span class="hljs-function"><span class="hljs-function">Logic </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">utilization</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ALMs</span></span></span><span class="hljs-function">)</span></span> ; <span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">472</span></span> / <span class="hljs-number"><span class="hljs-number">32</span></span>,<span class="hljs-number"><span class="hljs-number">070</span></span> ( <span class="hljs-number"><span class="hljs-number">17</span></span> % ) ; ; Total registers ; <span class="hljs-number"><span class="hljs-number">10409</span></span> ; ; Total pins ; <span class="hljs-number"><span class="hljs-number">103</span></span> / <span class="hljs-number"><span class="hljs-number">457</span></span> ( <span class="hljs-number"><span class="hljs-number">23</span></span> % ) ; ; Total block memory bits ; <span class="hljs-number"><span class="hljs-number">127</span></span>,<span class="hljs-number"><span class="hljs-number">344</span></span> / <span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">065</span></span>,<span class="hljs-number"><span class="hljs-number">280</span></span> ( <span class="hljs-number"><span class="hljs-number">3</span></span> % ) ; ; Total RAM Blocks ; <span class="hljs-number"><span class="hljs-number">44</span></span> / <span class="hljs-number"><span class="hljs-number">397</span></span> ( <span class="hljs-number"><span class="hljs-number">11</span></span> % ) ; ; Total PLLs ; <span class="hljs-number"><span class="hljs-number">2</span></span> / <span class="hljs-number"><span class="hljs-number">6</span></span> ( <span class="hljs-number"><span class="hljs-number">33</span></span> % ) ; ; Total DLLs ; <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">4</span></span> ( <span class="hljs-number"><span class="hljs-number">25</span></span> % ) ; +---------------------------------+-------------------------------------------------+</code> </pre><br><br>  Compared with the previous version of the compiler, the project has lost approximately 100 ALM. <br><br>  But the assembly <a href="https://github.com/johan92/altera_opencl_sandbox/blob/master/vector_add/bin_vector_add/top.fit.rpt_no_profile">report</a> without profiling counters: <br><pre> <code class="hljs cs">+-----------------------------------------------------------------------------------+ ; Fitter Summary ; +---------------------------------+-------------------------------------------------+ ; Fitter Status ; Successful - Sun Nov <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> ; ; Quartus Prime Version ; <span class="hljs-number"><span class="hljs-number">15.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Build <span class="hljs-number"><span class="hljs-number">185</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>/<span class="hljs-number"><span class="hljs-number">21</span></span>/<span class="hljs-number"><span class="hljs-number">2015</span></span> SJ Standard Edition ; ; Family ; Cyclone V ; ; Device ; <span class="hljs-number"><span class="hljs-number">5</span></span>CSEMA5F31C6 ; ; Timing Models ; Final ; ; <span class="hljs-function"><span class="hljs-function">Logic </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">utilization</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ALMs</span></span></span><span class="hljs-function">)</span></span> ; <span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">552</span></span> / <span class="hljs-number"><span class="hljs-number">32</span></span>,<span class="hljs-number"><span class="hljs-number">070</span></span> ( <span class="hljs-number"><span class="hljs-number">14</span></span> % ) ; ; Total registers ; <span class="hljs-number"><span class="hljs-number">7991</span></span> ; ; Total pins ; <span class="hljs-number"><span class="hljs-number">103</span></span> / <span class="hljs-number"><span class="hljs-number">457</span></span> ( <span class="hljs-number"><span class="hljs-number">23</span></span> % ) ; ; Total block memory bits ; <span class="hljs-number"><span class="hljs-number">127</span></span>,<span class="hljs-number"><span class="hljs-number">344</span></span> / <span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">065</span></span>,<span class="hljs-number"><span class="hljs-number">280</span></span> ( <span class="hljs-number"><span class="hljs-number">3</span></span> % ) ; ; Total RAM Blocks ; <span class="hljs-number"><span class="hljs-number">44</span></span> / <span class="hljs-number"><span class="hljs-number">397</span></span> ( <span class="hljs-number"><span class="hljs-number">11</span></span> % ) ; ; Total PLLs ; <span class="hljs-number"><span class="hljs-number">2</span></span> / <span class="hljs-number"><span class="hljs-number">6</span></span> ( <span class="hljs-number"><span class="hljs-number">33</span></span> % ) ; ; Total DLLs ; <span class="hljs-number"><span class="hljs-number">1</span></span> / <span class="hljs-number"><span class="hljs-number">4</span></span> ( <span class="hljs-number"><span class="hljs-number">25</span></span> % ) ; +---------------------------------+-------------------------------------------------+</code> </pre><br><br>  As you can see, about 1000 ALM occupy the profiling counters and logic that "reads" them. <br>  In the future, it is this report that we will use to analyze what it takes. <br><br><h2>  First look at the project </h2><br>  Let me remind you that the project is laid out on <a href="https://github.com/johan92/altera_opencl_sandbox/tree/master/vector_add/bin_vector_add">a githaba</a> . <br><br>  The project file is called straightforwardly: <b>top.qpf</b> (QPF - Quartus Project File), the most important module is <b>top.v</b> , which in fact contains an instance of the <b>system</b> module and a simple counter that is displayed on the LEDs. <br><br><h3>  system (4535 ALM) </h3><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/9c4/2ff/2cb/9c42ff2cb817483a61880fdc7c13c445.png"></a> <br><br>  <b>system</b> is an auto-generation module using <a href="https://www.altera.com/products/design-software/fpga-design/quartus-ii/quartus-ii-subscription-edition/qts-qsys.html">Qsys</a> .  Qsys is a GUI-ishna tool that allows you to connect different IP blocks, automatically generating the code for the modules that are needed for the interconnect, switching from one frequency to another, etc. <br><br>  Modules: <br><ul><li>  <b>vector_add_system (2141 ALM)</b> is a module that implements what we wrote in the <b>vector_add</b> core. </li><li>  <b>acl_iface (2343 ALM)</b> is an infrastructure that provides more convenient access and interaction with the kernel. </li></ul><br>  Interfaces: <br><ul><li>  <b>avs_vector_add_cra</b> - Avalon-MM for managing the kernel. </li><li>  <b>avm_memgmem0_port_0_0_rw</b> - Avalon-MM for accessing DDR memory.  The data width is 256 bits. </li></ul><br><br><h3>  acl_iface (2343 ALM) </h3><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/059/8c0/6bf/0598c06bfc0b2df17cbb926a5213ba59.png"></a> <br>  Modules: <br><ul><li>  <b>pll (0 ALM)</b> : <abbr title="phase-locked loop">PLL</abbr> that receives a <b>clock pll_outclk0</b> (100 MHz) from <b>config_clk</b> (50 MHz, comes from an external oscillator). </li><li>  <b>acl_kernel_clk (1057 ALM)</b> : another PLL: it generates a shred that is sent to the kernel.  It has an interesting nuance: we'll talk about it in more detail later. </li><li>  <b>acl_kernel_interface (439 ALM)</b> : provides the "interaction" of the core and the processor (via the control interface and interrupt). </li><li>  <b>clock_cross_kernel_mem1 (82 ALM)</b> : he is engaged in the "coordination" of interfaces that operate at different frequencies ( <abbr title="clock domain crossing"><a href="https://en.wikipedia.org/wiki/Clock_domain_crossing">CDC</a></abbr> ). </li><li>  <b>hps (0 ALM)</b> : this is a HPS instance (Hard Processor System).  No logic in the FPGA, he does not take, because  this is the hardware core. </li></ul><br>  Interfaces: <br><ul><li>  <b>f2h_sdram0</b> - Avalon-MM interface for accessing DDR memory.  The data width is 256 bits, and the operating frequency is <b>pll_outclk0</b> (100 MHz). </li><li>  <b>h2f_lw</b> - AXI interface.  Through it, the CPU (ARM) has the ability to manage and configure the system using the control / status registers of the kernel, etc. </li></ul><br><br>  If we add up the total capacity of these modules, the amount will not converge.  The fact is that Qsys does not show <b>interconnect</b> modules by default.  To display them, you must click <b>Show System With Qsys Interconnect</b> in the <b>System</b> menu.  After that you can see that there are modules of the form <b>mm_interconnect_ *</b> , which occupy 568 and 195 ALM. <br><br><h3>  vector_add_system (2141 ALM) </h3><br>  The architecture of this module cannot be viewed in the GUI: to understand how it works, we dive into Verilog. <br><br>  An approximate diagram looks like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/d06/c9d/f02/d06c9df020a0d51e97f4f8c2bb019263.png" alt="image"><br><ul><li>  <b>vector_add_system_interconnect_ * (443 ALM)</b> - interconnect modules that conduct arbitration and multiplexing of the <b>avm_memgmem0_port_0_0_rw</b> interface </li><li>  <b>LSU_X (235)</b> , <b>LSU_Y (239)</b> - read data from global memory for vectors (kernel arguments <b>x</b> and <b>y,</b> respectively). </li><li>  <b>LSU_Z (424 ALM)</b> - writes the result of the calculations to global memory (argument <b>z</b> ). </li><li>  <b>acl_id_iterator (228 ALM)</b> , <b>acl_work_group_dispatcher (149 ALM)</b> - they issue a task to be performed by the kernel (they show which element should be processed). </li><li>  <b>acl_kernel_finish_detector (144 ALM)</b> - determines when the kernel has finished its work. </li></ul><br>  Note: <br>  LSU modules are instances of a single module ( <b>lsu_top</b> ) and are named <b>lsu_local_bb0_ld_</b> , <b>lsu_local_bb0_ld__u0</b> and <b>lsu_local_bb0_st_add</b> .  For convenience, I gave them more "humane" names.  We'll talk more about LSU below. <br><br>  How the kernel works: <br><ul><li>  There is a setup through CRA, processing is started. </li><li>  <b>LSU_X</b> and <b>LSU_Y</b> receive ‚Äúcommands‚Äù to read the data and make requests to the global memory. </li><li>  The read data is buffered in memory ( <abbr title="First Input First Output">FIFO</abbr> ) until data from both <b>LSUs</b> are ready. </li><li>  As soon as the data is in both FIFOs, they are sent to the pipeline that performs the addition. </li><li>  The result is in <b>LSU_Z</b> , where they wait for the opportunity to be written to global memory. </li><li>  As soon as the desired number of elements is processed, and all the results are recorded in memory (there are no pending entries), the <b>kernel_finish_detector</b> is triggered ‚Äî the <b>kernel_irq</b> interrupt is <b>set</b> . </li></ul><br>  It is important to note that the three <b>LSUs</b> will fight among themselves for a single access interface to the global memory - they are masters of the Avalon-MM interface. <br><br>  The conveyor, which I designated in the scheme as <b>add_pipeline</b> , is actually not placed in a separate module: it is simply located in the <a href=""><b>vector_add.v</b></a> file in the <b>vector_add_basic_block_0</b> module. <br><br>  The line itself, which adds up two 32-bit numbers, looks like this: <br><pre> <code class="hljs lisp">assign local_bb0_add = (<span class="hljs-name"><span class="hljs-name">rstag_3to3_bb0_ld__u0</span></span> + rstag_3to3_bb0_ld_)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br>  The logical elements that will be created from this line and do all the useful work. <br>  All the rest is the infrastructure that drives the data to this logic. <br><br><h4>  LSU (Load Store Unit) </h4><br>  The most interesting module of this kernel is LSU.  Let's see how it works. <br><br>  <a href=""><b>lsu_top</b></a> is in fact a wrapper over other <b>lsu_ *</b> -modules, which are selected depending on the parameters <b>READ</b> and <b>STYLE</b> . <br><br>  Of all the varieties, we will have only two: <br><ul><li>  <b>LSU_READ_STREAMING</b> - <b>LSU_X</b> , <b>LSU_Y</b> (READ = 1, STYLE = "STREAMING") </li><li>  <b>LSU_WRITE_STREAMING</b> - <b>LSU_Z</b> (READ = 0, STYLE = "STREAMING") </li></ul><br><br><h5>  LSU_READ_STREAMING </h5><br><img src="https://habrastorage.org/files/ba9/34a/8df/ba934a8df116453b92a2e785452ca9ee.png"><br>  Pay attention to the parameters of the module: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">BURSTCOUNT_WIDTH</span></span> = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">MEMORY_SIDE_MEM_LATENCY</span></span> = <span class="hljs-number"><span class="hljs-number">89</span></span>;</code> </pre><br>  <b>BURSTCOUNT_WIDTH</b> shows the width of the <b>avm_burstcount</b> signal - when queried by the Avalon-MM interface, the number of words that must be read during the <a href="https://en.wikipedia.org/wiki/Burst_mode_%2528computing%2529">transaction is located there</a> . <br><br>  If the signal width is equal to five, then the maximum value of the wave is equal to 16. This clearly follows from the <a href="https://www.altera.com/content/dam/altera-www/global/en_US/pdfs/literature/manual/mnl_avalon_spec.pdf">specification</a> : <br><pre> <code class="hljs vhdl">The value <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the maximum burstcount <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> must be a power <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>. A burstcount interface <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">width</span></span> n can encode a max burst <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> size <span class="hljs-number"><span class="hljs-number">2</span></span>^(n-<span class="hljs-number"><span class="hljs-number">1</span></span>). <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> example, a <span class="hljs-number"><span class="hljs-number">4</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span> burstcount <span class="hljs-keyword"><span class="hljs-keyword">signal</span></span> can support a maximum burst count <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>. The minimum burstcount <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>.</code> </pre><br><br>  This means that a maximum of 16 256-bit words will be read in a single request ‚Äî these are 4096 Kbit or 128 32-bit numbers (we add 32-bit integers). <br><br>  <b>MEMORY_SIDE_MEM_LATENCY</b> affects the number of FIFO words in <b>lsu_burst_read_master</b> .  This FIFO is used to buffer readable data from global memory. <br><br>  How is the number of words for it determined: <br><pre> <code class="hljs vhdl">localparam MAXBURSTCOUNT=<span class="hljs-number"><span class="hljs-number">2</span></span>**(BURSTCOUNT_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>); // Parameterize the FIFO depth based <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> the <span class="hljs-string"><span class="hljs-string">"drain"</span></span> rate <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FIFO // <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> the worst <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> you need memory latency + burstcount, but <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> the kernel // <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> slow <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> pull data <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> we can overlap the <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> burst <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> that. Also // since you can<span class="hljs-symbol"><span class="hljs-symbol">'t</span></span> backpressure responses, you need at least a full burst // <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> space. // <span class="hljs-literal"><span class="hljs-literal">Note</span></span> the burst_read_master requires a fifo depth &gt;= MAXBURSTCOUNT + <span class="hljs-number"><span class="hljs-number">5</span></span>. This // hardcoded <span class="hljs-number"><span class="hljs-number">5</span></span> latency could result <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> half the bandwidth <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> burst <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> // latency <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> small, hence double it so we can double <span class="hljs-keyword"><span class="hljs-keyword">buffer</span></span>. localparam _FIFO_DEPTH = MAXBURSTCOUNT + <span class="hljs-number"><span class="hljs-number">10</span></span> + ((MEMORY_SIDE_MEM_LATENCY * WIDTH_BYTES + MWIDTH_BYTES - <span class="hljs-number"><span class="hljs-number">1</span></span>) / MWIDTH_BYTES); // This fifo doesn<span class="hljs-symbol"><span class="hljs-symbol">'t</span></span> affect the pipeline, round <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> power <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> localparam FIFO_DEPTH = <span class="hljs-number"><span class="hljs-number">2</span></span>**$clog2(_FIFO_DEPTH);</code> </pre><br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">_FIFO_DEPTH</span></span> = <span class="hljs-number"><span class="hljs-number">16</span></span> + <span class="hljs-number"><span class="hljs-number">10</span></span> + ((<span class="hljs-number"><span class="hljs-number">89</span></span> * <span class="hljs-number"><span class="hljs-number">4</span></span> + <span class="hljs-number"><span class="hljs-number">32</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>)/<span class="hljs-number"><span class="hljs-number">32</span></span>) = <span class="hljs-number"><span class="hljs-number">39</span></span>    ,   : FIFO_DEPTH = <span class="hljs-number"><span class="hljs-number">64</span></span></code> </pre><br><br>  <b>Conclusion</b> : <br>  A buffer (cache) of 64 words of 256 bits will be allocated. <br><br>  In fact, to fix this fact, it was not necessary to pick the source: just look at the <b>RAM Summary</b> section of the report from the build.  Our calculation turned out to be correct, and the report shows that 7 M10K blocks will be used.  Seven blocks is 10240 bits * 7 = 70 Kbps, instead of the expected 256 bits * 64 = 16 Kbps. <br><br>  Why did it happen? <br>  In FPGA, internal memory is a lot of small blocks that can be configured differently. <br>  You can see how to configure the M10K block (namely, it forms the basis of the Cyclone V chip family) <a href="https://documentation.altera.com/">here</a> . <br><br>  The maximum word length in a memory block is 40 bits, if you need to create a word in 256 bits, then you need 256/40 = 6.4 -&gt; 7 blocks, which turned out.  Due to the fact that the number of words in memory is 64, each block will be configured as 64x40, and the remaining 75% of memory will simply not be used. <br><br>  What affects the size of the bursts and the size of the cache? <br><ul><li>  The more birst, the more we can read in one request, but at the same time the remaining requests to the memory will be blocked (we have three masters who want to communicate with external memory). </li><li>  The larger the cache, the more data there is in the "stock" for processing while a new piece of data is being read.  I do not know the minuses of the larger cache, except for the consumption of resources.  In this case, it was possible to make a cache with the number of words equal to 256 and the same number of M10K blocks would be spent. </li></ul><br><h5>  LSU_WRITE_STREAMING </h5><br><img src="https://habrastorage.org/files/49d/bc3/05a/49dbc305a0514c08be294d475dc6a51c.png"><br>  The incoming 32-bit data (the result of addition) are put in turn into their FIFO.  As soon as <b>MAXBURSTCOUNT</b> is typed in each of them (for this module this parameter is also equal to 16), then a write-to-memory transaction occurs.  Each of these FIFOs has a data width of 32. There are eight such FIFOs (256/32). <br><br>  What is the amount of data calculated these fifoshki <br><br>  Calculation take from the code <b>lsu_streaming_write</b> .  For this module parameter.  <b>MEMORY_SIDE_MEM_LATENCY</b> is 32. <br><pre> <code class="hljs lisp">localparam MAXBURSTCOUNT=2**(<span class="hljs-name"><span class="hljs-name">BURSTCOUNT_WIDTH-1</span></span>)<span class="hljs-comment"><span class="hljs-comment">; localparam __FIFO_DEPTH=2*MAXBURSTCOUNT + (MEMORY_SIDE_MEM_LATENCY * WIDTH + MWIDTH - 1) / MWIDTH; localparam _FIFO_DEPTH= ( __FIFO_DEPTH &gt; MAXBURSTCOUNT+4 ) ? __FIFO_DEPTH : MAXBURSTCOUNT+5; // This fifo doesn't affect the pipeline, round to power of 2 localparam FIFO_DEPTH= 2**($clog2(_FIFO_DEPTH));</span></span></code> </pre><br><pre> <code class="hljs markdown">MAXBURSTCOUNT = 2^4 = 16 <span class="hljs-emphasis"><span class="hljs-emphasis">__FIFO_</span></span>DEPTH = 2 <span class="hljs-bullet"><span class="hljs-bullet">* 16 + ( 32 *</span></span> 32 + 256 - 1)/256 = 36 + 5 = 41 <span class="hljs-emphasis"><span class="hljs-emphasis">_FIFO_</span></span>DEPTH = 41      : FIFO_DEPTH = 64</code> </pre><br>  We confirm with the report: 64 * 32 = 2048 bits (1 M10K). <br><br>  Since the FIFO is completely separate, one M10K block is allocated to each FIFO, which results in 8 M10K blocks, versus 7 M10K blocks in <b>lsu_read_streaming</b> . <br><br>  Why did 8 FIFO, although it was possible to make one, but wide?  Most likely this is easier to do (do not separately store the number of valid words). <br><br><h5>  How are LSU parameters calculated? </h5><br>  Let's try to figure out where such numbers came from: <br>  There is a suspicion that these settings are taken from a file that describes the board <b>(altera / 15.1 / hld / board / de1soc / de1soc_sharedonly / board_spec.xml)</b> . <br><br>  Find the line that is associated with the global memory: <br><pre> <code class="hljs xml"> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- One DDR3-800 DIMM, 256-bit data --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">global_mem</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">max_bandwidth</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"6400"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">interface</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"acl_iface"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">port</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"kernel_mem0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"slave"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"256"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxburst</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">latency</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"240"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0x00000000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0x40000000"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">global_mem</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  For an explanation of these parameters, refer to the <b><a href="https://www.altera.com/content/dam/altera-www/global/en_US/pdfs/literature/hb/opencl-sdk/ug_aocl_custom_platform_toolkit.pdf">Altera SDK for OpenCL: Custom Platform Toolkit User Guide</a></b> , <b>XML Elements, Attributes, and Parameters chapter in the board_spec.xml File</b> . <br><br>  <b>max_bandwidth</b> - the <i>current configuration.</i>  <i>The Altera Offline Compiler is suitable for the application and the board.</i>  <i>Compute this bandwidth value from datasheets of your memories.</i> <br><br><div class="spoiler">  <b class="spoiler_title">Transfer</b> <div class="spoiler_text">  <b>max_bandwidth</b> - The <i>maximum bandwidth of all interfaces for global memory.</i>  <i>Altera Offline Compiler uses max_bandwidth to select the architecture that is best suited for a particular card and application.</i>  <i>Calculate these values ‚Äã‚Äãbased on the parameters of the memory used.</i> <br></div></div><br><br>  Unfortunately, there are no explanations in which units and how it counts: on the one hand, the profiler <a href="">wrote</a> 6400 MB / s, on the other hand, according to calculations of 6400 MB / s, nothing is obtained: 400 (MHz, DDR clock frequency) * 32 (bit, width data signal on DDR-interface) * 2 (work on two fronts) = 25600 Mb / s = 3200 MB / s.  Or should be considered in both directions? <br><br>  <b>max_burst</b> - <i>Maximum burst size for the slave interface.</i> <br><div class="spoiler">  <b class="spoiler_title">Transfer</b> <div class="spoiler_text">  <b>max_burst</b> - The <i>maximum burstsize for the slave (slave) interface.</i> <br></div></div><br><br>  In our case - 16, which gives BURSTCOUNT_WIDTH = 5. But why 16, exactly?  The <b>fpga2hps_sdram</b> interface supports <b>max_burstcount</b> = 128. 16 - is this some kind of magic number, fits all?  :) <br><br>  <b>latency</b> - <i>anonymous integer</i>  <i>The card reads the card.</i>  <i>For example, the Altera DDR3 memory controller running at 200 MHz with clock-crossing bridges has a latency of approximately 240 ns.</i> <br><br><div class="spoiler">  <b class="spoiler_title">Transfer</b> <div class="spoiler_text">  <b>latency</b> - <i>An integer that indicates the time in nanoseconds required</i> <i><br></i>  <i>memory interface for the answer.</i>  <i>The delay is the time from the read request to the receipt of data in the kernel.</i>  <i>For example, the Altera DDR3 controller, operating at 200 MHz in conjunction with a module for switching to another frequency, has a delay of about 240 ns.</i> <br></div></div><br><br>  <abbr title="although I doubt because for other boards and other types of DDR this number is repeated all the time">Suppose</abbr> that in our case there is also a delay of 240 ns.  Obviously, the dimension of <b>MEMORY_SIDE_MEM_LATENCY</b> is the number of <b>ticks</b> (and the comment suggests: <i>Latency in cycles between LSU and memory</i> ). <br><br>  We will conduct several experiments, changing the values ‚Äã‚Äãin <b>board_spec.xml</b> ( <b>maxburst</b> , <b>latency</b> ) and the core structure (the number of arguments that are added ( <b>readers</b> )).  We follow the value of the <b>MEMORY_SIDE_MEM_LATENCY</b> parameter for both modules ( <b>LSU_X</b> (lsu_read_streaming) and <b>LSU_Z</b> (lsu_write_streaming)). <br><br><pre> <code class="hljs ruby"><span class="hljs-params"><span class="hljs-params">|--------------------------------------------------------|</span></span> <span class="hljs-params"><span class="hljs-params">| maxburst |</span></span> latency <span class="hljs-params"><span class="hljs-params">| readers |</span></span> MEMORY_SIDE_MEM_LATENCY <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|-------------------------|</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> LSU_X <span class="hljs-params"><span class="hljs-params">| LSU_Z |</span></span> <span class="hljs-params"><span class="hljs-params">|--------------------------------------------------------|</span></span> <span class="hljs-params"><span class="hljs-params">| 16 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">| 1 |</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-params"><span class="hljs-params">| 16 |</span></span> <span class="hljs-params"><span class="hljs-params">| 16 |</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-params"><span class="hljs-params">| 1 |</span></span> <span class="hljs-number"><span class="hljs-number">45</span></span> <span class="hljs-params"><span class="hljs-params">| 16 |</span></span> <span class="hljs-params"><span class="hljs-params">| 16 |</span></span> <span class="hljs-number"><span class="hljs-number">240</span></span> <span class="hljs-params"><span class="hljs-params">| 1 |</span></span> <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-params"><span class="hljs-params">| 16 |</span></span> <span class="hljs-params"><span class="hljs-params">|--------------------------------------------------------|</span></span> <span class="hljs-params"><span class="hljs-params">| 16 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">| 2 |</span></span> <span class="hljs-number"><span class="hljs-number">41</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-params"><span class="hljs-params">| 16 |</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-params"><span class="hljs-params">| 2 |</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-params"><span class="hljs-params">| 16 |</span></span> <span class="hljs-number"><span class="hljs-number">240</span></span> <span class="hljs-params"><span class="hljs-params">| 2 |</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-params"><span class="hljs-params">|--------------------------------------------------------|</span></span> <span class="hljs-params"><span class="hljs-params">| 16 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">| 3 |</span></span> <span class="hljs-number"><span class="hljs-number">57</span></span> <span class="hljs-params"><span class="hljs-params">| 48 |</span></span> <span class="hljs-params"><span class="hljs-params">| 16 |</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-params"><span class="hljs-params">| 3 |</span></span> <span class="hljs-number"><span class="hljs-number">77</span></span> <span class="hljs-params"><span class="hljs-params">| 48 |</span></span> <span class="hljs-params"><span class="hljs-params">| 16 |</span></span> <span class="hljs-number"><span class="hljs-number">240</span></span> <span class="hljs-params"><span class="hljs-params">| 3 |</span></span> <span class="hljs-number"><span class="hljs-number">105</span></span> <span class="hljs-params"><span class="hljs-params">| 48 |</span></span> <span class="hljs-params"><span class="hljs-params">|--------------------------------------------------------|</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">| 1 |</span></span> <span class="hljs-number"><span class="hljs-number">41</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-params"><span class="hljs-params">| 1 |</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-number"><span class="hljs-number">240</span></span> <span class="hljs-params"><span class="hljs-params">| 1 |</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-params"><span class="hljs-params">|--------------------------------------------------------|</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">| 2 |</span></span> <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-params"><span class="hljs-params">| 64 |</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-params"><span class="hljs-params">| 2 |</span></span> <span class="hljs-number"><span class="hljs-number">93</span></span> <span class="hljs-params"><span class="hljs-params">| 64 |</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-number"><span class="hljs-number">240</span></span> <span class="hljs-params"><span class="hljs-params">| 2 |</span></span> <span class="hljs-number"><span class="hljs-number">121</span></span> <span class="hljs-params"><span class="hljs-params">| 64 |</span></span> <span class="hljs-params"><span class="hljs-params">|--------------------------------------------------------|</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">| 3 |</span></span> <span class="hljs-number"><span class="hljs-number">105</span></span> <span class="hljs-params"><span class="hljs-params">| 96 |</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-params"><span class="hljs-params">| 3 |</span></span> <span class="hljs-number"><span class="hljs-number">125</span></span> <span class="hljs-params"><span class="hljs-params">| 96 |</span></span> <span class="hljs-params"><span class="hljs-params">| 32 |</span></span> <span class="hljs-number"><span class="hljs-number">240</span></span> <span class="hljs-params"><span class="hljs-params">| 3 |</span></span> <span class="hljs-number"><span class="hljs-number">153</span></span> <span class="hljs-params"><span class="hljs-params">| 96 |</span></span> <span class="hljs-params"><span class="hljs-params">|--------------------------------------------------------|</span></span></code> </pre><br>  What dependences are traced: <br><ul><li>  With increasing latency and fixing <b>maxburst</b> and <b>readers</b> <b>LSU_X_MEMORY_SIDE_MEM_LATENCY</b> increases by a value equal to latency / 5.  Most likely 5 is 5 ns (are we sent to the magic frequency of 200 MHz?). </li><li>  As the number of readers increases, <b>LSU_X_MEMORY_SIDE_MEM_LATENCY</b> increases by the value of the birst. </li><li>  <b>LSU_Z_MEMORY_SIDE_MEM_LATENCY</b> linearly depends on the number of elements that want to access the global memory and on the maximum bursts. </li></ul><br>  Formulas are seen: <br><ul><li>  <b>LSU_X_MEMORY_SIDE_MEM_LATENCY</b> = 9 + <b>readers</b> * <b>maxburst</b> + <b>latency</b> / 5.  (9 is either some kind of magic number, or one more characteristic of the nucleus, to which I didn‚Äôt get to the bottom. Perhaps this is the total kernel delay). </li><li>  <b>LSU_Z_MEMORY_SIDE_MEM_LATENCY</b> = <b>maxburst</b> * <b>readers</b> . </li></ul><br>  <b>Note</b> : <br>  These formulas are only for a specific kernel (implementation); for another, everything can be different. <br><br><h2>  At what frequency does the core work </h2><br>  The core clock is <b>generated by the acl_kernel_clk</b> module. <br>  It is based on the PLL, which can dynamically reconfigure (change the output frequency). <br><br>  If we open this module in Qsys or <a href=""><b>system_acl_iface_acl_kernel_clk_kernel_pll.v</b></a> , then we will see that this PLL generates two signals - 140 MHz ( <b>kernel_clk</b> ) and 280 MHz ( <b>kernel_clk2x</b> ).  Immediately I will say that <b>kernel_clk2x is</b> not used anywhere. <br><br>  Does it mean that the core will always (and any) only work at 140 MHz and cannot be overclocked at all?  Of course <b>not</b> . <br>  140 MHz is the setting for this particular board. <br><br>  Depending on what logical elements are used and how they are connected, the value of the clock frequency at which the circuit will work without failures can be different.  I touched on this issue in the <a href="http://habrahabr.ru/post/235037/">article</a> about pipelining. <br><br>  The task of the compiler is to arrange primitives (logical elements, memory blocks, etc.) so as to satisfy the specified frequency requirement.  It means that: <br><ul><li>  he is not trying to find a location that will give the most maximum clock frequency. </li><li>  if, for some time, he goes over the arrangement of elements in the chip, he understands that he cannot part, he leaves one of the best options (which was during the search). </li></ul><br>  Suppose instead of 140 MHz, <b>Quartus</b> shows a maximum clock frequency of 135 MHz.  It means that: <br><ul><li>  the compiler ensures that if you submit 135 MHz, the calculations will occur correctly, nothing will hang, etc. (if there are no algorithmic errors in the code itself, of course). </li><li>  If you apply 140 MHz, it may happen that everything will be fine.  Or maybe not.  It depends on the chip - chips with one marking may differ slightly, so the compiler is reinsured and calculates for the worst case. </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Most often, after rebuilding the FPGA project, developers look at the build report and ask if the circuit has run out of frequency. </font><font style="vertical-align: inherit;">We in the last article just took a binary and stitched it. </font><font style="vertical-align: inherit;">What happens if the compiler does not fit into the 140 MHz? </font><font style="vertical-align: inherit;">Calculations will be wrong? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order to hide this problem from the developers, Altera made a very interesting piece (probably the most interesting thing I unearthed when I was playing with the Altera OpenCL SDK):</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After the build is completed, the script </font></font><a href=""><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adjust_plls.tcl is called</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It receives the maximum allowed frequency for the kernel ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fmax</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), and generates files ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pll_rom.mif</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pll_rom.hex</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), which are used to initialize the ROM in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pll_rom</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> module </font><font style="vertical-align: inherit;">.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When the FPGA is loaded, the specified frequency (140 MHz) is applied to the logic. </font><font style="vertical-align: inherit;">Before starting the kernel, the data from the ROM is read, and using these factors, the PLL is rebuilt (through the reconfiguration interface). </font><font style="vertical-align: inherit;">As soon as the reconfiguration is completed, the necessary frequency is already being fed to the kernel.</font></font></li></ul><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">    tcl-  ROM   m, n, k, c0, c1,  <abbr title="  "> </abbr> ,    <a href="https://www.altera.com/en_US/pdfs/literature/an/an661.pdf">   Altera PLL</a> . <br></div></div><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the core will be filed the frequency that you can apply. </font><font style="vertical-align: inherit;">If the logic turned out to be too capacious, and it was not possible to meet the specified number, then the calculations will not break - they will simply go slower.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the permissible frequency is higher, then the PLL will be tuned to this value (the calculations will speed up). </font><font style="vertical-align: inherit;">Search location, which will give the maximum frequency will not. </font><font style="vertical-align: inherit;">If there is a feeling that you can ‚Äúoverclock‚Äù, then it is better to manually raise the bar at the PLL frequency.</font></font></li></ul><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We simplify assembly a little </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before we continue to learn how to build and configure the kernel, I will make a small digression, which can help you if you want to make some changes (to the kernel) or to debug on the hardware. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let me remind </font></font><a href="http://habrahabr.ru/company/metrotek/blog/269009/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the development process</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vector_add.aocx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">, which contains the FPGA firmware, is obtained from </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vector_add.cl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The problem is that if you made any changes to the Quartus project, they will not fall into </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* .aocx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , since </font><font style="vertical-align: inherit;">When restarting the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aoc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility </font><font style="vertical-align: inherit;">, the ‚Äúdefault project‚Äù is copied and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verilog IP is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> regenerated </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Thus, your changes will be lost. </font><b><font style="vertical-align: inherit;">Aoc</font></b></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a binary, but you can see that when you call: </font></font><br><pre> <code class="hljs pgsql">$ aoc device/vector_add.cl -o bin/vector_add.aocx <span class="hljs-comment"><span class="hljs-comment">--board de1soc_sharedonly --profile -v</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a script run on a pearl </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aoc.pl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which already does all the useful work. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can directly call this script without using the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aoc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility </font><font style="vertical-align: inherit;">.</font></font><br><pre> <code class="hljs pgsql">$ /home/ish/altera/<span class="hljs-number"><span class="hljs-number">15.1</span></span>/quartus/linux64/perl/bin/perl /home/ish/altera/<span class="hljs-number"><span class="hljs-number">15.1</span></span>/hld/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/lib/perl/acl/aoc.pl device/vector_add.cl <span class="hljs-comment"><span class="hljs-comment">--board de1soc_sharedonly --profile -v</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It's good that the script is written in an interpreted language, which means we can figure out what it does and make its own changes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the very beginning of the script, various variables are described that are configured via keys (including those hidden from the user in the help). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, there is found the key </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--quartus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which causes only the assembly of the quarter and the packing of the necessary parts in the * .aocx file. There will be no regeneration of the project (source code). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, for additional convenience, you can display the assembly log on the console. To do this, you need to specify empty lines in the call to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysystem_full</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function as stdout and stderr </font><font style="vertical-align: inherit;">:</font></font><br><pre> <code class="hljs php">$return_status = mysystem_full( {<span class="hljs-string"><span class="hljs-string">'time'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'time-label'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Quartus compilation'</span></span>, <span class="hljs-string"><span class="hljs-string">'stdout'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'stderr'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>}, $synthesize_cmd);</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we can easily make any changes to the project (play with optimizations, add SignalTap) and just cause rebuilding only the project for the FPGA, and not the whole kernel with the clang call and code regeneration. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To check this, I added SignalTap to the interfaces (as well as added 15 second sleep after loading the kernel and starting the calculations, so that I could connect using the debugger).</font></font><br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/4ca/d12/ed6/4cad12ed602cd52d8f1847af42dfbc17.png" alt="image"></a> <br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How is the kernel managed </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avs_vector_add_cra</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> interface </font><font style="vertical-align: inherit;">serves to configure the kernel: data is written to the addresses of the registers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unfortunately, I did not find a register card in open access and how to tweak it, so I‚Äôll have to do a little research. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All registers are described in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vector_add.v</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and have adequate names. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">They are 64-bit: [31: 0] denote the lower 32 bits, and [63:32] - the oldest.</font></font><br><pre> <code class="hljs css">0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">status</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">profile</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">work_dim</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[63:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">workgroup_size</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x6</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">global_size</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x6</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[63:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">global_size</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x7</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">global_size</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x7</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[63:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">num_groups</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">num_groups</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[63:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">num_groups</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">local_size</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[63:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">local_size</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xA</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">local_size</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xA</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[63:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">global_offset</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xB</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">global_offset</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xB</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[63:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">global_offset</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">kernel_arguments</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">input_x</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[63:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">kernel_arguments</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[63:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">input_x</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[63:32]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">kernel_arguments</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[95:64]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">input_y</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[63:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">kernel_arguments</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[127:96]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">input_y</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[63:32]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">kernel_arguments</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[159:128]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">input_z</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[63:32]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">kernel_arguments</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[191:160]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">input_z</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[63:32]</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Based on the names, you can try to configure and launch something at random, but let's not take the risk, but just find out what is written in what order. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's write down all transactions on this interface (using SignalTap'a):</font></font><br><pre> <code class="hljs ruby">---------------------------------------------- <span class="hljs-params"><span class="hljs-params">| addr |</span></span> write_data <span class="hljs-params"><span class="hljs-params">| byte_enable |</span></span> ---------------------------------------------- <span class="hljs-params"><span class="hljs-params">| 0x5 |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x00000001</span></span> <span class="hljs-params"><span class="hljs-params">| 0x0F |</span></span> <span class="hljs-params"><span class="hljs-params">| 0x5 |</span></span> <span class="hljs-number"><span class="hljs-number">0x000F4240</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-params"><span class="hljs-params">| 0xF0 |</span></span> ---------------------------------------------- <span class="hljs-params"><span class="hljs-params">| 0x6 |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x000F4240</span></span> <span class="hljs-params"><span class="hljs-params">| 0x0F |</span></span> <span class="hljs-params"><span class="hljs-params">| 0x6 |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000001</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-params"><span class="hljs-params">| 0xF0 |</span></span> ---------------------------------------------- <span class="hljs-params"><span class="hljs-params">| 0x7 |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x00000001</span></span> <span class="hljs-params"><span class="hljs-params">| 0x0F |</span></span> <span class="hljs-params"><span class="hljs-params">| 0x7 |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000001</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-params"><span class="hljs-params">| 0xF0 |</span></span> ---------------------------------------------- <span class="hljs-params"><span class="hljs-params">| 0x8 |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x00000001</span></span> <span class="hljs-params"><span class="hljs-params">| 0x0F |</span></span> <span class="hljs-params"><span class="hljs-params">| 0x8 |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000001</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-params"><span class="hljs-params">| 0xF0 |</span></span> ---------------------------------------------- <span class="hljs-params"><span class="hljs-params">| 0x9 |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x000F4240</span></span> <span class="hljs-params"><span class="hljs-params">| 0x0F |</span></span> <span class="hljs-params"><span class="hljs-params">| 0x9 |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000001</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-params"><span class="hljs-params">| 0xF0 |</span></span> ---------------------------------------------- <span class="hljs-params"><span class="hljs-params">| 0xA |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x00000001</span></span> <span class="hljs-params"><span class="hljs-params">| 0x0F |</span></span> <span class="hljs-params"><span class="hljs-params">| 0xA |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-params"><span class="hljs-params">| 0xF0 |</span></span> ---------------------------------------------- <span class="hljs-params"><span class="hljs-params">| 0xB |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-params"><span class="hljs-params">| 0x0F |</span></span> <span class="hljs-params"><span class="hljs-params">| 0xB |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-params"><span class="hljs-params">| 0xF0 |</span></span> ---------------------------------------------- <span class="hljs-params"><span class="hljs-params">| 0xC |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x20100000</span></span> <span class="hljs-params"><span class="hljs-params">| 0x0F |</span></span> <span class="hljs-params"><span class="hljs-params">| 0xC |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-params"><span class="hljs-params">| 0xF0 |</span></span> ---------------------------------------------- <span class="hljs-params"><span class="hljs-params">| 0xD |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x20500000</span></span> <span class="hljs-params"><span class="hljs-params">| 0x0F |</span></span> <span class="hljs-params"><span class="hljs-params">| 0xD |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-params"><span class="hljs-params">| 0xF0 |</span></span> ---------------------------------------------- <span class="hljs-params"><span class="hljs-params">| 0xE |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x20900000</span></span> <span class="hljs-params"><span class="hljs-params">| 0x0F |</span></span> <span class="hljs-params"><span class="hljs-params">| 0xE |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-params"><span class="hljs-params">| 0xF0 |</span></span> ---------------------------------------------- <span class="hljs-params"><span class="hljs-params">| 0x0 |</span></span> <span class="hljs-number"><span class="hljs-number">0x00000000</span></span> <span class="hljs-number"><span class="hljs-number">0x00000001</span></span> <span class="hljs-params"><span class="hljs-params">| 0x0F |</span></span> ----------------------------------------------</code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">byte_enable</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "selects" in which register bytes to write: so, within the very first transaction, 0x00000001 was written to the lower 32 bits of the register 0x5 (the upper 32 bits did not change). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Watching transactions in SignalTap may not always be convenient: on the host you can enable additional debugging through environment variables. They can be found in the chapter </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Troubleshooting </font></font></b> <a href="https://www.altera.com/content/dam/altera-www/global/en_US/pdfs/literature/hb/opencl-sdk/ug_aocl_s5_net_platform.pdf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Altera Stratix V Network Reference Platform Porting Guide</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We need the variable </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACL_HAL_DEBUG</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . We expose its value to 2, and run the host application </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vector_add</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><pre> <code class="hljs ruby">root@socfpga<span class="hljs-symbol"><span class="hljs-symbol">:~/myvectoradduint</span></span><span class="hljs-comment"><span class="hljs-comment"># export ACL_HAL_DEBUG=2 root</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@socfpga</span></span></span><span class="hljs-comment">:~/myvectoradduint# ./vector_add // &lt;  &gt; :: Launching kernel 0 on accelerator 0. :: Writing inv image [ 0] @ 0x28 := 1 :: Writing inv image [ 4] @ 0x2c := f4240 :: Writing inv image [ 8] @ 0x30 := f4240 :: Writing inv image [12] @ 0x34 := 1 :: Writing inv image [16] @ 0x38 := 1 :: Writing inv image [20] @ 0x3c := 1 :: Writing inv image [24] @ 0x40 := 1 :: Writing inv image [28] @ 0x44 := 1 :: Writing inv image [32] @ 0x48 := f4240 :: Writing inv image [36] @ 0x4c := 1 :: Writing inv image [40] @ 0x50 := 1 :: Writing inv image [44] @ 0x54 := 0 :: Writing inv image [48] @ 0x58 := 0 :: Writing inv image [52] @ 0x5c := 0 :: Writing inv image [56] @ 0x60 := 20100000 :: Writing inv image [60] @ 0x64 := 0 :: Writing inv image [64] @ 0x68 := 20500000 :: Writing inv image [68] @ 0x6c := 0 :: Writing inv image [72] @ 0x70 := 20900000 :: Writing inv image [76] @ 0x74 := 0 :: Accelerator 0 reporting status 2. :: Accelerator 0 is done.</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You may notice that 0x28 is a byte offset of the 5th 64-bit register. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It can be seen that the addresses and data coincide, however, in this debug there is no information about the transaction in the zero register (even if </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACL_HAL_DEBUG is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> set to five). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting result:</font></font><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">work_dim</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 0x1 - because </font><font style="vertical-align: inherit;">we have a one-dimensional vector.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">workgroup_size</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 0xF4240 or 1,000,000.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">global_size</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 0xF4240 for the first dimension and 0x1 for all others.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">num_groups</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 0x1 for all dimensions.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">local_size</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is 0xF4240 for the first dimension and 0x1 for all others.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">global_offset</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 0x0 for all measurements.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input_x</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input_y</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input_z</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 0x20100000, 0x20500000, 0x20900000, respectively.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> After tuning the kernel, the least significant bit of the zero register is jerked, which starts the calculations. </font></font><br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">   ,      . <br>         <b>status</b> ? <br>     ? <br></div></div><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Core simulation </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we understand how to configure the kernel - let's simulate it! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is very convenient that the kernel has only two interfaces - one for configuration, the other for reading data (there is also an interface (one signal size) for setting an interrupt - but this is not so interesting for us). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To simulate a kernel, we need to do everything as in real life:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> configure it (now we know what sequence to write, and the interface is relatively simple). </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> provide access to the global memory where buffers are allocated and data is stored. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Of course, we don‚Äôt really want to simulate any Linux and host application, so as a first approximation we can limit ourselves to the following scheme: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/bba/fc2/838/bbafc2838b21b366dbc577a3b7c2173c.png" alt="image"><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cra_driver</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a driver for configuring the kernel.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vector_add_system</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the kernel that we simulate ( </font></font><abbr title="device (design) under test"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DUT</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avalon_mm_clock_crossing</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - transfer of data from the frequency of the kernel (140 MHz) to the frequency of reading from the controller (100 MHz) and back.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prepare_data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are simple tasks that write data to buffers </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> before starting the simulation.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avalon_mm_interconnect</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - multiplexing and arbitration of two Avalon-MM interfaces.</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ddr3_contoller</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ddr3_model</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Altera Hard Memory Controller and DDR3 simulation models. </font><font style="vertical-align: inherit;">The model and controller settings are the same as those used in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hps</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> module </font><font style="vertical-align: inherit;">.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The driver for configuring the kernel is just a sequential call to the next task with the kernel settings that we dug out thanks to SignalTap: </font></font><br><pre> <code class="hljs perl">task cra_write( input bit [<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] _addr, bit [<span class="hljs-number"><span class="hljs-number">63</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] _data, bit [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] _byteenable ); $display(<span class="hljs-string"><span class="hljs-string">"%m: _addr = 0x%x, _data = 0x%x, _byteenable = 0x%x"</span></span>, _addr, _data, _byteenable ); @( posedge clk ); cra_addr &lt;= _addr; cra_wr_data &lt;= _data; cra_byteenable &lt;= _byteenable; cra_wr_en &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'b0; @( posedge clk ); cra_wr_en &lt;= 1'</span></span>b1; @( posedge clk ); cra_wr_en &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'b0; // dummy waiting repeat (10) @( posedge clk ); endtask</span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs vhdl">initial <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wait</span></span>( ram_init_done ); <span class="hljs-keyword"><span class="hljs-keyword">wait</span></span>( test_data_init_done ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h5</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h000F424000000000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hF0</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h5</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000100000000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hF0</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h6</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h00000000000F4240</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0F</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h6</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000100000000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hF0</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h7</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000000000001</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0F</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h7</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000100000000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hF0</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h8</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000000000001</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0F</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h8</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000100000000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hF0</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h9</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h00000000000F4240</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0F</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h9</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000100000000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hF0</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hA</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000000000001</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0F</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hA</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hF0</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hB</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0F</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hB</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hF0</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hC</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000020100000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0F</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hC</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hF0</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hD</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000020500000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0F</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hD</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hF0</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hE</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000020900000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0F</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hE</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hF0</span></span> ); cra_write( <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000000000000001</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0F</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the preparation of data for which it is necessary to make a calculation, we write a similar task that will be written into memory at addresses that have been filled in in advance. (We don‚Äôt need to ask anyone (the system) to allocate addresses). For the demonstration, it is not necessary to write down 2x1000000 numbers as necessary according to the conditions of the problem - a couple of thousand is enough to see how it works. If we do not write the data, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will be read from memory </font><font style="vertical-align: inherit;">( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unknown value</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), since nothing was written to these cells. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We look at the simulation result (all the numbers on the timeframes in hexadecimal form) (it is better to open the screenshots in a separate window): The </font><b><font style="vertical-align: inherit;">start</font></b><font style="vertical-align: inherit;"> signal comes</font></font><br> <a href=""><img src="https://habrastorage.org/files/0dd/5aa/489/0dd5aa489a53459c9d3791fcd1c3a123.png"></a> <br><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and after several cycles, both LSUs simultaneously issue a request to read data with a bursts size equal to 0x10 = 16. Interestingly, three requests are first received only from </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LSU_X</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and then from </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LSU_Y</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : this is seen by the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avm_waitrequest</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> signal, the </font><b><font style="vertical-align: inherit;">read</font></b><font style="vertical-align: inherit;"> request is accepted only when there is a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">waitrequest</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> equals zero. Why requests do not alternate, as one would expect - this is a question to the sheduller and interconnect to global memory. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why were there three requests? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The number of words in the FIFO in LSU is 64, and one would expect 4 read requests, but this trick was done there:</font></font><br><pre> <code class="hljs objectivec">parameter READTHRESHOLD = FIFODEPTH - MAXBURSTCOUNT - <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">assign</span></span> too_many_reads_pending = (reads_pending + fifo_used) &gt;= READTHRESHOLD; <span class="hljs-comment"><span class="hljs-comment">// make sure there are fewer reads posted than room in the FIFO</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We sent 3 read requests (3 x 16 = 48 words): there is still room for 16 words, but the reading will stop until four words are spent. There will be no small bursts out of 12, because This module does not know how (and there is no special reason for this - to spend extra logic). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After some time, come to read the data (see the signal. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LSU_X_avm_readdatavalid</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) and shortly exposed signal </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LSU_X_o_valid</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , informs that 32-bit data in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LSU_X_o_readdata</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ready for further processing, but we caulk: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LSU_X_i_stall</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is set to one. The fact is that the conveyor that will add data has no data from </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LSU_Y</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Therefore everything shuts up until </font><b><font style="vertical-align: inherit;">LSU_Y_avm_readdatavalid</font></b><font style="vertical-align: inherit;"> comes</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and set </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LSU_Y_o_valid</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next clock after that comes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LSU_Z_i_valid</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which notifies LSU_Z_i_writedata of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vadidity</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : the addition </font><b><font style="vertical-align: inherit;">pipeline has</font></b><font style="vertical-align: inherit;"> worked for one clock. </font><b><font style="vertical-align: inherit;">LSU_Z</font></b><font style="vertical-align: inherit;"> waits for the accumulation of the required amount of data: this is of course 16,256-bit words and performs a write transaction. In parallel, </font><b><font style="vertical-align: inherit;">LSU_X</font></b><font style="vertical-align: inherit;"> and </font><b><font style="vertical-align: inherit;">LSU_Y</font></b><font style="vertical-align: inherit;"> make their read transactions as they empty their FIFOs. Note that </font><b><font style="vertical-align: inherit;">LSU_X_i_stall</font></b><font style="vertical-align: inherit;"> and </font><b><font style="vertical-align: inherit;">LSU_Y_i_stall are</font></b><font style="vertical-align: inherit;"> not cocked, which means </font><font style="vertical-align: inherit;">that the </font><b><font style="vertical-align: inherit;">pipeline</font></b><font style="vertical-align: inherit;"> does not shut up and each clock receives new data.</font></font><br> <a href=""><img src="https://habrastorage.org/files/afc/38d/5b2/afc38d5b2eac4e229c1c66974ef549e4.png"></a> <br><br> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br><br> <a href=""><img src="https://habrastorage.org/files/3b2/785/4f2/3b27854f2d7c4b809e4c2d41103d4536.png"></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After seeing a lot of the number of transactions, it is clear that no more plugging occurs. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Due to the fact that the pipeline never stops (except at the very beginning), it is clear that it works with maximum performance, and that it is the narrow link in this simple example. Since reading takes place in 256-bit words, it makes sense to organize parallel addition of eight 32-bit numbers - then the bottle is most likely to occur in memory access. Used </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> proc eed number of adders special meaning does not</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thanks to the simulation, we can make some changes to the RTL code (for example, the length of the bursts or the size of the caches) in order to see how this will affect the speed of the calculations and very quickly see the answer: you do not need to wait 10-15 minutes for this to rebuild the whole project with Quartus - just run the simulation in the simulator. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, some architectural changes need to be made through editing the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* .cl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file (for example, using special directives): you can regenerate the code, and also run the simulation and see the resulting gain without assembling the entire project.</font></font><br><br><h2>  Conclusion </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have learned what the </font></font><a href=""><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vector_add</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> core is </font><a href=""><b><font style="vertical-align: inherit;">turning</font></b></a><font style="vertical-align: inherit;"> from the FPGA and how it is configured. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, many issues that would have arisen for FPGA developers (if they had written from scratch) were resolved:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cache sizes </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> architecture </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Interconnect made and interface arbitration </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> automatic adjustment of the clock frequency to the resulting value </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Of course, not the fact that what is done automatically is the most optimal. </font></font><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">   ,      Quartus'a (    ,  )  ¬´¬ª. <br>      ,   : <br><ul><li>   </li><li>   </li><li>   </li><li>  </li></ul><br>  ,      :    ‚Äî        FPGA. <br><br>  ,  ,        FPGA ,   <b>Advisor</b> ',    GUI    ,   .      (  Altera). <br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Low-level optimization and manual tuning is the very last step. </font><font style="vertical-align: inherit;">Do you often climb into assembler after building gcc? </font><font style="vertical-align: inherit;">First you need to carry out a high-level optimization in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* .cl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and play around with the settings of Quartus. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is good that there is an opportunity to simulate the core: you can estimate its performance without having iron (board) on your hands.</font></font><br><br>  Thanks for attention!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I will be glad to questions and comments in the comments or in personal mail. </font></font></div><p>Source: <a href="https://habr.com/ru/post/269925/">https://habr.com/ru/post/269925/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269909/index.html">Errors are values</a></li>
<li><a href="../269915/index.html">Divide means multiply</a></li>
<li><a href="../269917/index.html">A library that helps bridge the conceptual gap between OOP and DB during testing using ORM - LinqTestable</a></li>
<li><a href="../269919/index.html">The digest of interesting materials for the mobile developer # 127 (October 26 - November 1)</a></li>
<li><a href="../269923/index.html">Immersion cooling reaches new heights: 250 kW per bitFury rack</a></li>
<li><a href="../269927/index.html">What we have learned by developing the backend</a></li>
<li><a href="../269931/index.html">How to draw curves graphics in the style of XKCD</a></li>
<li><a href="../269933/index.html">Pitfalls of backup in hybrid storage systems</a></li>
<li><a href="../269935/index.html">Operating System Migration History</a></li>
<li><a href="../269937/index.html">PHP Digest number 73 - interesting news, materials and tools (October 18 - November 5, 2015)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>