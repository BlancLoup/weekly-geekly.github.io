<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We program the BitTorrent client. Pure Delphi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It has been 8 years since Igor Antonov (Spider_NET) has written an article about creating a torrent client in C # , but the simplest example of how to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We program the BitTorrent client. Pure Delphi</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/aea/cd2/09b/aeacd209bfe3d90f47a4557cb787f5e3.png" align="left">  It has been 8 years since <a href="http://iantonov.me/">Igor Antonov (Spider_NET) has</a> written an article about <a href="http://iantonov.me/page/programmiruem-torrent-klient-na-sdelphis-c">creating a torrent client in C #</a> , but the simplest example of how to do this in Delphi has not yet appeared on the network. <br><br>  In order to dispel doubts about the ineffectiveness of the Delphi language in such a "difficult" matter as writing a full-fledged bittorrent client, I decided to write this article. <br><br>  At once I will say that our Delphi torrent client will be open source and will support almost all modern bittorrent technologies, including DHT, magnet links, sequential downloads, etc. <br><a name="habracut"></a><br>  An online search for Delphi client source codes yielded results, but these results were far from ideal.  The first result was the long-abandoned <a href="http://torrenttorque.sourceforge.net/">Torrent Torque</a> (2007), with the alpha version.  TorrentTorque failed to compile and test normally. <br>  The next search result turned out to be <a href="http://aresgalaxy.sourceforge.net/">Ares Galaxy</a> , little-known in Runet, which turned out to be quite workable and even popular in some countries a torrent client.  Having suffered from compilation, I still managed to try out the desired code, but it turned out to be flawed, which, as it turned out, the developers hadn‚Äôt been fixed for a long time.  In addition, Ares Galaxy is written in Delphi 7, which means that to compile in newer versions of RAD Studio you need to rewrite a huge amount of code.  But this did not stop me and I found another way out to solve this problem. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Having started to understand the source code of Ares Galaxy, I found out that many operations are performed in one thread, which, as a result, briefly stops the download process of all torrents in the list.  Therefore, I decided to correct the flaws and put procedures that slow down the execution of the code into separate threads. <br><br>  Having received a positive result, I decided to place the source code on sourceforge.net.  The code was executed in the form of the BTService dll-library, with the use of a plug-in system, which Alexander Alekseev told in detail in his series <a href="http://www.gunsmoker.ru/2011/12/delphi.html">‚ÄúDevelopment of a plug-in system‚Äù</a> .  So, using such a plugin system, it is possible to create a bittorrent client in any RAD Studio compiler and not only in Delphi, but also in other programming languages.  The BTService library and its sources are available at the link: <a href="http://btservice.sourceforge.net/">http://btservice.sourceforge.net/</a> <br><br>  So, let's start writing a simple client based on the BTService library. <br><br>  We will execute the client interface in the classical style, with a minimal set of components, but so that the main functionality of the library is visible. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0d5/467/65d/0d546765db3bd9ada9bc19961dd05890.png"><br><br>  Five buttons on the toolbar: add a magnet link, add a torrent, create a torrent, start a torrent, and stop a torrent. <br><br>  The list of torrents will be displayed in a standard TListView.  The lists of files, connected peers and trackers will also be placed on the TListView, which will be displayed accordingly when you open the TPageControl tabs.  Well, at the bottom of the main form StatusBar, which will display a magnet link selected in the torrent list, four torrent states and total download and upload speeds for all torrents in the list. <br><br>  Now let's sort through the events of creating, starting and stopping torrents. <br><br>  We will not describe all the details related to the creation of the torrent and the specification of the bittorrent protocol.  Igor did this before us in his article <a href="http://www.vr-online.ru/content/kodim-bittorrent-klient-chast-pervaja-4622">‚ÄúCode BitTorrent Client.</a>  <a href="http://www.vr-online.ru/content/kodim-bittorrent-klient-chast-pervaja-4622">Part One</a> .  All the code that creates the torrent is available in the BTService library.  Who is interested in its implementation, see the source of the library.  Well, I just indicate the code that interacts with the library. <br><br>  To begin, create a form "Create a new torrent."  On which we place three buttons: ‚ÄúAdd file‚Äù, ‚ÄúAdd folder‚Äù and ‚ÄúCreate‚Äù.  Add TPageControl.  Place the main parameters on the first tab.  The parameter ‚ÄúPart Size‚Äù will be executed in TCombobox, ‚ÄúStart download‚Äù and ‚ÄúPrivate torrent‚Äù will be executed in TCheckBox.  On the other tabs of the TPageControl we will place the TMemo fields, which add the addresses of the trackers, web sites and comments to the torrent file.  The process of creating a torrent will be displayed on two TProgressBar.  The first will show the execution of a hash of a single file, and the other will show the overall process of hashing all torrent files. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/bfb/df4/728/bfbdf47287956bad96e1e36ab2780d97.png"></a> <br><br>  For the button ‚ÄúAdd file‚Äù the code will be as follows: <br><br><pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TfCreateTorrent</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnAddFileClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FormStyle := fsNormal; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> OpenDialog1.Execute <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ComboBox1.Text := PChar(OpenDialog1.Filename); <span class="hljs-comment"><span class="hljs-comment">//   btnCreate.Enabled := true; end; FormStyle := fsStayOnTop; end;</span></span></code> </pre> <br>  For the ‚ÄúAdd folder‚Äù button, the code will be as follows: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TfCreateTorrent</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnAddFolderClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> chosenDirectory: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FormStyle := fsNormal; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> SelectDirectory(<span class="hljs-string"><span class="hljs-string">' : '</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, chosenDirectory) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ComboBox1.Text := chosenDirectory; <span class="hljs-comment"><span class="hljs-comment">//   btnCreate.Enabled := true; end; FormStyle := fsStayOnTop; end;</span></span></code> </pre><br>  That is, in the ‚ÄúSource selection‚Äù field (ComboBox1.Text), the path of the file or folder is added, depending on whether we want to add to the torrent, one file or several files in the folder. <br><br>  Next, on the button ‚ÄúCreate‚Äù we write the code: <br><br><div class="spoiler">  <b class="spoiler_title">Code to create a torrent file</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TfCreateTorrent</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnCreateClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> BTCreateTorrent: IBTCreateTorrent; X: Integer; FindBTPlugin: Boolean; Id: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ButtonSave <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ComboBox1.Text[length(ComboBox1.Text)] = <span class="hljs-string"><span class="hljs-string">'\'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ComboBox1.Text := copy(ComboBox1.Text, <span class="hljs-number"><span class="hljs-number">1</span></span>, length(ComboBox1.Text) - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> FileExists(ComboBox1.Text) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> SaveDialog1.Filter := <span class="hljs-string"><span class="hljs-string">'Torrent Files (*.torrent)|*.torrent'</span></span>; SaveDialog1.Filename := ComboBox1.Text + <span class="hljs-string"><span class="hljs-string">'.torrent'</span></span>; SaveDialog1.DefaultExt := <span class="hljs-string"><span class="hljs-string">'Torrent files (*.torrent)'</span></span>; FormStyle := fsNormal; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> SaveDialog1.Execute <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FormStyle := fsStayOnTop; TorrentFileName := SaveDialog1.Filename; <span class="hljs-comment"><span class="hljs-comment">//     - ButtonSave := False; btnCreate.Caption := ''; EnterCriticalSection(TorrentSection); try for X := 0 to Plugins.Count - 1 do begin if (Supports(Plugins[X], IBTCreateTorrent, BTCreateTorrent)) then //   IBTCreateTorrent,    - begin FindBTPlugin := true; break; end; end; finally LeaveCriticalSection(TorrentSection); end; if FindBTPlugin then begin Id := IntToStr(CreateTorrentID) EnterCriticalSection(TorrentSection); try try BTCreateTorrent.SingleFileTorrent((Id), (ComboBox1.Text), (SaveDialog1.Filename), (mmoComment.Lines.Text), (GetAnnounceURL), (mmWebSeeds.Lines.Text), CheckBox2.checked, ComboBox2.ItemIndex, False, False, '', '', '', ''); //   -   BTService    except end; finally LeaveCriticalSection(TorrentSection); end; repeat application.ProcessMessages; EnterCriticalSection(TorrentSection); try try GetInGeted(BTCreateTorrent.GetInfoTorrentCreating(Id)); //       except end; finally LeaveCriticalSection(TorrentSection); end; if (Stop) and (not(GetedStatus = 'stoped')) then begin EnterCriticalSection(TorrentSection); try try BTCreateTorrent.StopCreateTorrentThread(Id); //   - except end; finally LeaveCriticalSection(TorrentSection); end; end; WaitingCreation; if (Stop) and (not(GetedStatus = 'stoped')) then begin EnterCriticalSection(TorrentSection); try try BTCreateTorrent.StopCreateTorrentThread(Id); //   - except end; finally LeaveCriticalSection(TorrentSection); end; end; sleep(10); until (GetedStatus = 'completed') or (GetedStatus = 'stoped'); end; try ReleaseCreateTorrentThread(BTCreateTorrent, Id); //    - except end; if (GetedStatus = 'completed') then begin sGauge2.Position := sGauge2.Max; sGauge1.Position := sGauge1.Max; StatusBar1.Panels[0].Text := ' -  !'; if CheckBox1.checked then StartTorrent; end; if (GetedStatus = 'stoped') then begin StatusBar1.Panels[0].Text := '.'; end; Stop := False; btnCreate.Enabled := true; ButtonSave := true; btnCreate.Caption := ''; end; end else if DirectoryExists(ComboBox1.Text) then begin SaveDialog1.Filter := 'Torrent Files (*.torrent)|*.torrent'; SaveDialog1.Filename := ComboBox1.Text + '.torrent'; SaveDialog1.DefaultExt := 'Torrent files (*.torrent)'; FormStyle := fsNormal; if SaveDialog1.Execute then begin FormStyle := fsStayOnTop; TorrentFileName := SaveDialog1.Filename; //     - ButtonSave := False; btnCreate.Caption := ''; EnterCriticalSection(TorrentSection); try for X := 0 to Plugins.Count - 1 do begin if (Supports(Plugins[X], IBTCreateTorrent, BTCreateTorrent)) then //   IBTCreateTorrent,    - begin FindBTPlugin := true; break; end; end; finally LeaveCriticalSection(TorrentSection); end; if FindBTPlugin then begin Id := IntToStr(CreateTorrentID) EnterCriticalSection(TorrentSection); try try BTCreateTorrent.CreateFolderTorrent((Id), (ComboBox1.Text), (SaveDialog1.Filename), (mmoComment.Lines.Text), (GetAnnounceURL), (mmWebSeeds.Lines.Text), CheckBox2.checked, ComboBox2.ItemIndex, False, False, '', '', '', ''); //   -   BTService     except end; finally LeaveCriticalSection(TorrentSection); end; repeat application.ProcessMessages; EnterCriticalSection(TorrentSection); try GetInGeted(BTCreateTorrent.GetInfoTorrentCreating(Id)); //       finally LeaveCriticalSection(TorrentSection); end; if (Stop) and (not(GetedStatus = 'stoped')) then begin EnterCriticalSection(TorrentSection); try try BTCreateTorrent.StopCreateTorrentThread(Id); //   - except end; finally LeaveCriticalSection(TorrentSection); end; end; WaitingCreation; if (Stop) and (not(GetedStatus = 'stoped')) then begin EnterCriticalSection(TorrentSection); try try BTCreateTorrent.StopCreateTorrentThread(Id); //   - except end; finally LeaveCriticalSection(TorrentSection); end; end; sleep(10); until (GetedStatus = 'completed') or (GetedStatus = 'stoped'); EnterCriticalSection(TorrentSection); try try ReleaseCreateTorrentThread(BTCreateTorrent, Id); //    - except end; finally LeaveCriticalSection(TorrentSection); end; if (GetedStatus = 'completed') then begin sGauge2.Position := sGauge2.Max; sGauge1.Position := sGauge1.Max; StatusBar1.Panels[0].Text := ' -  !'; if CheckBox1.checked then StartTorrent; end; if (GetedStatus = 'stoped') then begin StatusBar1.Panels[0].Text := '.'; end; Stop := False; btnCreate.Enabled := true; ButtonSave := true; btnCreate.Caption := ''; end; end; end else begin Stop := False; btnCreate.Enabled := true; ButtonSave := true; btnCreate.Caption := ''; end; end else begin Stop := true; btnCreate.Enabled := False; ButtonSave := true; StatusBar1.Panels[0].Text := ' ...'; btnCreate.Caption := '...'; end; end;</span></span></code> </pre><br></div></div><br>  As can be seen from the code, the first thing is the selection of the directory to save the torrent.  And then there is a search for the IBTCreateTorrent interface, which is responsible for calling the SingleFileTorrent procedure from the BTService plugin.  This procedure starts the process of creating a torrent file with the contents of a single file, and the CreateFolderTorrent procedure is launched for the file folder.  After that, a repeat loop is launched, in which a periodic call to the GetInfoTorrentCreating function occurs, which returns the result of actions from the plug-in in the process of creating a torrent and information about the percentage of hashing performed.  If the result is returned GetedStatus = 'completed', then the process of creating a torrent completed successfully and you can exit the cycle. <br><br>  To add a torrent to the list, create a form ‚ÄúAdd torrent‚Äù.  Let's place two buttons on it: ‚ÄúDownload‚Äù and ‚ÄúAdd to list‚Äù.  The first will add the torrent to the list and immediately begin the download process, and the second will simply add the torrent to the list to wait for subsequent actions on it.  To display information about the torrent, add TEdit ("Torrent file:"), TComboBox ("Save to:"), TLabel ("Torrent name:", "Description:", "Date:") and the TListView list, which will be show the contents of torrent files and folders. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/fc3/154/f44/fc3154f44de391577c75109e09981727.png"></a> <br><br><div class="spoiler">  <b class="spoiler_title">Code add and download torrent</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TfAddTorrent</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnDownloadClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> AddTask(true, false) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> close; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TfAddTorrent</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Now: Boolean; ShowPrev: Boolean)</span></span></span><span class="hljs-function">:</span></span> Boolean; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> find: Boolean; TorrentDataSL: TStringList; X: Integer; DataTask: TTask; BTPluginAddTrackers: IBTServicePluginAddTrackers; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := false; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Trim(HashValue) = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> MessageBox(Handle, PChar(<span class="hljs-string"><span class="hljs-string">'        -'</span></span>), PChar(Options.<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>), MB_OK <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> MB_ICONWARNING <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> MB_TOPMOST); <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; find := false; <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> TasksList.LockList <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> X := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> DataTask := Items[X]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> DataTask.Status &lt;&gt; tsDeleted <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> DataTask.HashValue = HashValue <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> find := true; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> TasksList.UnLockList; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> find <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> MessageBox(Application.Handle, PChar(<span class="hljs-string"><span class="hljs-string">'   ,     .      ?'</span></span>), PChar(Options.<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>), MB_OKCANCEL <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> MB_ICONWARNING) = ID_OK <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> X := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Plugins.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Supports(Plugins[X], IBTServicePluginAddTrackers, BTPluginAddTrackers)) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> BTPluginAddTrackers.AddTrackers(HashValue, trackers); <span class="hljs-comment"><span class="hljs-comment">//    - except end; break; end; end; end; Exit; end; TorrentDataSL := TStringList.Create; try TorrentDataSL.Insert(0, BoolToStr(true)); if Now then TorrentDataSL.Insert(1, BoolToStr(true)) else TorrentDataSL.Insert(1, BoolToStr(false)); TorrentDataSL.Insert(2, Edit1.Text); TorrentDataSL.Insert(3, ExcludeTrailingBackSlash(cbDirectory.Text)); TorrentDataSL.Insert(4, IntToStr(0)); TorrentDataSL.Insert(5, Edit2.Text); AddTorrent(TorrentDataSL.Text, HashValue, Now, ShowPrev); finally TorrentDataSL.Free; end; try ForceDirectories(ExcludeTrailingBackSlash(cbDirectory.Text)); except end; SaveTasksList; Result := true; end; function TfAddTorrent.AddTorrent(TorrData: string; HashValue: string; Now: Boolean; ShowPrev: Boolean): Boolean; var AddDataTask: TTask; AddedData: TStringList; CreaName, CreatedName: string; Plugin2: IAddDownload; IndexPlugin2: Integer; Silent: Boolean; Down: Boolean; begin Result := false; AddedData := TStringList.Create; try AddedData.Text := TorrData; try Silent := StrToBool(AddedData[0]); Down := StrToBool(AddedData[1]); except Down := true; Silent := true; end; if Silent then begin AddDataTask := TTask.Create; AddDataTask.TorrentFileName := AddedData[2]; //    - AddDataTask.HashValue := HashValue; // info hash AddDataTask.LinkToFile := 'magnet:?xt=urn:btih:' + AnsiLowerCase(AddDataTask.HashValue); // magnet- AddDataTask.Directory := ExcludeTrailingBackSlash(AddedData[3]); //       AddDataTask.ID := Options.LastID + 1; //     Options.LastID := AddDataTask.ID; CreaName := AddedData[5]; CreaName := trimleft(CreaName); CreaName := trimright(CreaName); CreatedName := CreaName; AddDataTask.FileName := CreatedName; //       AddDataTask.Description := ''; if CheckBox1.Checked then AddDataTask.ProgressiveDownload := true //     else AddDataTask.ProgressiveDownload := false; //     if Down then AddDataTask.Status := tsQueue //     else AddDataTask.Status := tsReady; //     AddDataTask.TotalSize := SizeTorrent; //      AddDataTask.LoadSize := 0; AddDataTask.TimeBegin := 0; AddDataTask.TimeEnd := 0; AddDataTask.TimeTotal := 0; AddDataTask.MPBar := TAMultiProgressBar.Create(nil); //   Plugin2 := nil; DeterminePlugin2('bittorrent', IServicePlugin, Plugin2, IndexPlugin2); if Plugin2 &lt;&gt; nil then if Plugins[IndexPlugin2] &lt;&gt; nil then if (Plugins[IndexPlugin2].TaskIndexIcon &gt; 0) then AddDataTask.TaskServPlugIndexIcon := Plugins[IndexPlugin2] .TaskIndexIcon else begin if pos('magnet:?', AnsiLowerCase(AddDataTask.LinkToFile)) = 1 then AddDataTask.TaskServPlugIndexIcon := 34; end; TasksList.Add(AddDataTask); Result := true; PostMessage(Options.MainFormHandle, WM_MYMSG, 0, 12345); if Now then LoadTorrentThreads.Add(TLoadTorrent.Create(false, AddDataTask, true)); //      end; finally AddedData.Free; end; end;</span></span></code> </pre><br></div></div><br>  The procedure for adding a torrent is checked for the presence of info hash in the list of torrents.  If info hash is found, then instead of adding a torrent to the list, you will be prompted to add tracker addresses from the torrent BTPluginAddTrackers.AddTrackers (HashValue, trackers), otherwise the addition of the torrent to the list will continue.  After adding a torrent to the TasksList.Add (AddDataTask) list, a TLoadTorrent stream will be created (uTorrentThreads module), which will launch the BTPlugin.StartTorrent (DataTorrent) torrent and which will also run a repeat loop that checks the status and receives torrent information every second GetedData: = BTPlugin.GetInfoTorrent (DataTask.HashValue). <br><br>  The TListView OnData event is responsible for displaying the information received: <br><br><div class="spoiler">  <b class="spoiler_title">Display code received information</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TfMainForm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lvTasksData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject; Item: TListItem)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i: Integer; Task: TTask; Procent, Procent2: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; EndPoint: Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> TasksList.LockList <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> i = Item.<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Task := Items[Item.<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>]; <span class="hljs-comment"><span class="hljs-comment">//   case Task.Status of tsReady: Item.ImageIndex := 0; //   tsQueue: Item.ImageIndex := 1; //   tsError: Item.ImageIndex := 2; //   tsErroring: Item.ImageIndex := 2; //    tsLoading: Item.ImageIndex := 3; //  tsStoping: Item.ImageIndex := 4; //  tsStoped: Item.ImageIndex := 5; //  tsLoad: Item.ImageIndex := 6; //  tsProcessing: Item.ImageIndex := 8; //  tsSeeding: Item.ImageIndex := 9; //  tsBittorrentMagnetDiscovery: Item.ImageIndex := 10; // Magnet- tsDelete: Item.ImageIndex := 11; //  tsDeleted: Item.ImageIndex := 11; //  end; Item.SubItems.Add(Task.FileName); //   Item.SubItems.Add(Task.LinkToFile); //  Item.SubItemImages[1] := 12; //  case Task.Status of tsReady: Item.SubItems.Add(''); tsQueue: Item.SubItems.Add(' '); tsError: Item.SubItems.Add(''); tsErroring: Item.SubItems.Add(''); tsLoading: begin if Task.TotalSize &gt; 0 then begin Procent := FloatToStr((Task.LoadSize / Task.TotalSize) * 100); begin EndPoint := pos(',', Procent); if EndPoint &lt;&gt; 0 then begin Procent2 := copy(Procent, 1, EndPoint + 1); Item.SubItems.Add(Procent2 + '% ' + ''); end else begin try Procent2 := FloatToStrF(StrToInt(Procent), ffFixed, 6, 1); except end; Item.SubItems.Add(Procent2 + '% ' + ''); end; end; end else Item.SubItems.Add(''); end; tsStoping: Item.SubItems.Add(''); tsStoped: if (Task.TotalSize &gt; 0) then Item.SubItems.Add(FloatToStrF((Task.LoadSize / Task.TotalSize) * 100, ffFixed, 6, 1) + '% ' + '') else Item.SubItems.Add('0% ' + ''); tsLoad: Item.SubItems.Add(''); tsProcessing: Item.SubItems.Add(''); tsSeeding: Item.SubItems.Add(''); tsBittorrentMagnetDiscovery: Item.SubItems.Add('Magnet-'); tsDelete: Item.SubItems.Add(''); tsDeleted: Item.SubItems.Add(''); tsFileError: Item.SubItems.Add(' '); tsAllocating: Item.SubItems.Add(''); tsFinishedAllocating: Item.SubItems.Add(' '); tsRebuilding: Item.SubItems.Add(''); tsJustCompleted: Item.SubItems.Add(''); tsCancelled: Item.SubItems.Add(''); tsUploading: Item.SubItems.Add(''); tsStartProcess: Item.SubItems.Add(''); end; if Task.Speed &gt; 0 then begin Item.SubItems.Add(GetTimeStr((Task.TotalSize - Task.LoadSize) div Task.Speed)); //  end else Item.SubItems.Add(''); if Task.TotalSize &gt; 0 then Item.SubItems.Add(BytesToText(Task.TotalSize)) //  else Item.SubItems.Add(''); Item.SubItems.Add(BytesToText(Task.LoadSize)); //  if Task.Speed &gt; 0 then Item.SubItems.Add(BytesToText(Task.Speed) + '/s') //  else Item.SubItems.Add(''); if Task.NumConnectedSeeders &gt; 0 then Item.SubItems.Add(IntToStr(Task.NumConnectedSeeders)) //  else Item.SubItems.Add(''); if Task.NumConnectedLeechers &gt; 0 then Item.SubItems.Add(IntToStr(Task.NumConnectedLeechers)) //  else Item.SubItems.Add(''); if Task.UploadSpeed &gt; 0 then Item.SubItems.Add(BytesToText(Task.UploadSpeed) + '/s') //   else Item.SubItems.Add(''); if Task.UploadSize &gt; 0 then Item.SubItems.Add(BytesToText(Task.UploadSize)) //  else Item.SubItems.Add(''); break; end; end; finally TasksList.UnLockList; end; end;</span></span></code> </pre><br></div></div><br>  Here we come to the time of testing.  Although the client code is complete, I decided to supplement it with a progress bar, which I placed in our client‚Äôs status bar, instead of displaying a magnet link, which is already displayed in the list of torrents.  We need this in order to see how the download takes place, sequentially or not. <br>  After compilation, launch our client, add the torrent to the list by clicking on the "Add torrent" button.  We will add one torrent without setting the ‚ÄúSequential download‚Äù label, and on the other we will install this label and wait for the download to start.  As a result, during the download we should see the following picture: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/93f/5b8/f51/93f5b8f51af909cffd787a679cf4aa8f.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/cdd/168/b71/cdd168b716460e8a4b879eca5564ba56.png"><br><br>  In other words, when a torrent is selected in the list, in which we have set the ‚ÄúSequential upload‚Äù label, the download occurs sequentially, while for the other torrent, the injection of parts of the torrent occurs selectively, without a sequence. <br><br>  As a result, we received a valid torrent client, fully implemented in the Delphi language and non-inferior to the functionality of modern clients.  BTService bittorrent library sources and DelphiTorrent client sources (examples directory) are available via SVN: <a href="https://svn.code.sf.net/p/btservice/svn/">svn.code.sf.net/p/btservice/svn</a> <br><br>  We have created a torrent client that can only be used in Windows.  Therefore, we should expect a continuation in which I will talk about creating a client for the Android OS and IOS, as there are all prerequisites for this. </div><p>Source: <a href="https://habr.com/ru/post/260339/">https://habr.com/ru/post/260339/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260329/index.html">Run docker compose on Windows</a></li>
<li><a href="../260331/index.html">Run HP ALM tests using Jenkins</a></li>
<li><a href="../260333/index.html">OS Day in Innopolis</a></li>
<li><a href="../260335/index.html">How to calculate load average</a></li>
<li><a href="../260337/index.html">MMORPG without unnecessary details: Open Source</a></li>
<li><a href="../260343/index.html">Radix Compact sorting algorithm. Part 1: implementation on the CPU</a></li>
<li><a href="../260347/index.html">DevConf :: PHP already this Friday - the program is formed, on the sidelines we will tell how the conference site was transferred to Laravel 5</a></li>
<li><a href="../260349/index.html">Launched a new cloud service AzureLine</a></li>
<li><a href="../260351/index.html">PHP 7 Alpha 1. What's new</a></li>
<li><a href="../260355/index.html">Manage dependencies in iOS applications correctly: Typhoon device</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>