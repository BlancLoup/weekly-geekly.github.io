<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Understanding the xCAT server deployment and maintenance system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In continuation of the theme of our previous article , today we will talk about the tool that we use every day. 

 If your activity is somehow connect...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Understanding the xCAT server deployment and maintenance system</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://badoo.com/"><img src="https://habrastorage.org/storage1/7c701b54/3bbd50f8/586fe987/3c371d85.png" align="left"></a>  In continuation of the theme of our <a href="http://habrahabr.ru/company/badoo/blog/133387/">previous article</a> , today we will talk about the tool that we use every day. <br><br>  If your activity is somehow connected with the installation and configuration of large quantities of equipment, then the material, in our opinion, will be useful and interesting for you. <br><br>  Any engineer who manages <a href="http://badoo.com/">Badoo's</a> fleet of servers, the most popular dating network on the Internet, does not even want to remember that you had to manually edit a DHCP server configuration, collect images for network PXE loading ... We want to tell you where and how Our company has successfully used the xCAT software solution. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First of all, let us designate the initial conditions within which we will describe the situation: <br><ul><li>  The main distribution is <a href="http://en.wikipedia.org/wiki/SUSE_Linux_Enterprise_Server">SLES</a> 11 or SLES 11 SP 1 (mostly the second); </li><li>  The latest stable version of <a href="http://en.wikipedia.org/wiki/XCAT">xCAT</a> , a ready package for the specified distribution (the installation process is described in detail on the product home page); </li><li>  multiple <a href="http://en.wikipedia.org/wiki/VLAN">vlans</a> ; </li><li>  A large number of new or existing servers. </li></ul>  Returning to our first article, which we also recommend to <a href="http://habrahabr.ru/company/badoo/blog/133387/">read</a> , let's stop at the place where we need to prepare the configuration of the DHCP server, or rather, add information about new servers to it.  From this moment we begin to actively use xCAT. <br><br>  xCAT is a server park management system that has the following features: <br><ul><li>  maintaining the current state of the DHCP server </li><li>  maintaining the current state of DNS zones and performing dynamic updates, </li><li>  support of the current state of the <a href="http://en.wikipedia.org/wiki/TFTP">TFTP</a> server (which is very important for us), </li><li>  creating images to install the OS, </li><li>  <a href="http://en.wikipedia.org/wiki/Preboot_Execution_Environment">PXE</a> server support, </li><li>  support of the current status of static routes on servers, </li><li>  display the current status of any previously configured server, </li><li>  management of server groups based on the logic specified by us. </li></ul>  The biggest advantage of the xCAT system is that it is not a completely new product, but in some ways a synthesis of all previously known, i.e.  during operation, the engineer does not have to learn the new syntax, which undoubtedly affects the speed of mastering the program. <br><br>  Briefly describe the process of <b>initial configuration of the product</b> . <br><ol><li>  We go to the project site, select the appropriate distribution, we get a description of the installation process. </li><li>  Install the required packages. </li><li>  Install directly xCAT-server. </li></ol> Then proceed to <b>configure</b> . <br><br>  The main commands to control (add, change, check input): <i>tabedit</i> and <i>tabdump</i> <br><br>  Rule the main system configuration file: <br> <code>tabedit site</code> <br> <br>  Key points to pay attention to: <br><br>  <code>"installdir","/install"</code> is the directory where xCAT will add all system images for installation, and various post scripts are located here.  In the case of an http installation of the system, the directory will be accessible via the web interface.  Also there will be templates for automatic installation of the system. <br>  <code>"ipmiretries","3"</code> - attempts to connect to the server management interface. <br>  <code>"ipmitimeout","2"</code> - no comments. <br>  <code>"master","master_server_name"</code> is the name of the master server that should be resolved, and you should also have it in the <i>/ etc / hosts file</i> . <br>  <code>"tftpdir","/tftpboot"</code> is the path to the directory where the files required for PXE boot will be located, also the TFTP server should have access to the directory, because it will be the one that will distribute the pxe-boot images. <br>  <code>"xcatconfdir","/etc/xcat"</code> - path to the directory with xCAT configuration files. <br>  <code>"timezone","GMT"</code> - time zone. <br>  <code>"useNmapfromMN","yes"</code> - use nmap on the master server to display the status of hosts (including nodestat hostname) <br> <code>"dhcpinterfaces","ethN,!remote!"</code>  - interfaces on which the DHCP server responds to DHCP requests.  (The first is the physical interface, the second is for the VLAN, where our server is registered as the issuing address) <br>  <code>"nameservers","1.1.1.1"</code> - addresses of DNS servers, where after issuing a <i>lease</i> our server will try to send information about the <a href="http://en.wikipedia.org/wiki/PTR_Record">PTR</a> record for the host. <br><br>  This configuration is quite enough for familiarization, as well as for a test run of the xCAT server. <br><br>  Now we try to add access to an unprivileged user. <br><br>  For this you need: <br>  - presence of the user in the system; <br>  - issue and sign certificates on xCAT-server <br> <code>/opt/xcat/share/xcat/scripts/setup-local-client.sh username</code> <br> <br>  We <i>get the $ HOME / .xcat directory</i> , with the following content: <br> <code>ca.pem <br> client-cert.pem <br> client-cred.pem <br> client-key.pem <br> client-req.pem</code> <br> <br>  - add user information to service tables xCAT.  In this case, we give the user maximum authority, for this we will execute <br> <code>tabedit policy</code> <br> <br>  and add a line like this: <br> <code>username,allow</code> <br> <br>  After the actions we have done, the user gets access to manage the xCAT server. <br><br>  Next, to create an installation repository, we need to have <b>images of the operating systems</b> that we are going to use. <br><br>  XCAT includes the copycds utility, which works in the following scenario: <br> <code>copycds [{-n|--name|--osver}=distroname] [{-a|--arch}=architecture] 1st.iso [2nd.iso ‚Ä¶]</code> <br> <br>  Thus, if we have an installation DVD image, then simply execute <br> <code>copycds PATH_TO_ISO SLES-11-DVD-x86_64-GM-DVD1.iso</code> <br> <br>  xCAT will automatically detect the version of the operating system (if not, <i>--osver</i> ), then copy everything to a local disk (in our case, <i>/ install / sles11</i> ) <br><br>  xCat also has a set of configurations for a standard installation, which are located in the <i>/ opt / xcat / share / xcat / install / directory</i> , but are of no interest to us, so we create our installation profile and locate it along the way <br>  <i>/install/custom/install/DISTRNAME/Templatename.tmpl</i> . <br><br>  Note: in the case of SuSe, Linux is an xml file that <a href="http://en.wikipedia.org/wiki/Yast">YaST</a> will help us to do (although it is easier to write it yourself, having familiarized yourself with the structure and composition of the parameters on the manufacturer's website). <br><br>  As soon as the typical installation template is ready, it remains only to add new machines and start <b>installing the OS</b> , which will be discussed below. <br><br>  For the correct installation procedure, we will need information: <br>  1) about the servers on which we are going to install the OS, <br>  2) the hostname of each server, <br>  3) about the subnets that we plan to use, <br>  4) compliance with hostame-ip, <br>  5) about the details of access to the server management interface. <br><br>  Returning to our <a href="http://habrahabr.ru/company/badoo/blog/133387/">previous article</a> , we remember that all the necessary information we have, it remains only to add it to xCAT, which we demonstrate: <br><br>  1. Add server groups to the system: <br> <code>nodeadd depl[1-200] groups=depl</code> <br> <br>  2. Add information about server management interfaces (suppose they are named like this: <i>depl [1-200] ipmi</i> ): <br> <code>nodeadd depl[1-200]ipmi groups=depl_ipmi</code> <br> <br>  3. We talked about the fact that we have a subnet (VLAN) in which all the new equipment is located.  We describe subnets as follows: <br><br> <code>#netname,net,mask,mgtifname,gateway,dhcpserver,tftpserver,nameservers,ntpservers,logservers,dynamicrange,nodehostname,comments,disable <br> <br> tabedit networks <br> <br> "depl_vlan","2.2.2.0","255.255.255.0","!remote!","2.2.2.1",,"1.1.1.1","5.5.5.5","6.6.6.6",,"2.2.2.200-2.2.2.254",,, <br> "depl_vlan_ipmi","3.3.3.0","255.255.255.0","!remote!","3.3.3.1",,"1.1.1.1","5.5.5.5","6.6.6.6",,"3.3.3.200-3.3.3.3.254",,,</code> <br> <br>  Note: because  xCat configures the DHCP server, and stores information about fixed addresses in a file with <i>leases</i> , it is advisable to use fixed addresses of hosts that do not fall within the dynamic range in order to avoid possible problems with the loss of servers in the subnets. <br><br>  4. Add information about the MAC addresses of the main server interfaces, as well as management interfaces: <br><br> <code>#node,interface,mac,comments,disable <br> <br> tabedit mac <br> <br> "depl1","eth0","MAC1",, <br> "depl2","eth0","MAC2",, <br> "depl3","eth0","MAC3",, <br> "depl1ipmi","eth0","ipmi_MAC1",, <br> "depl2ipmi","eth0","ipmi_MAC2‚Äù,, <br> "depl3ipmi","eth0","ipmi_MAC3",, <br> ...</code> <br> <br>  Hint: in the last article we talked about the <i>nodes</i> file, with which we work closely, we will add information about MAC addresses to it, then it will be enough to execute <br><br> <code>cat nodes | awk {'print "\""$1"\",\"eth0\",\""$15"\""'}</code> <br> <br>  and get the output records of the form <br><br> <code>"depl1","eth0","MAC1",,</code> <br> <br>  The same for management interfaces: <br><br> <code>cat nodes | awk {'print "\""$1"manage\",\"eth0\",\""$10"\""'} <br> <br> "depl1ipmi","eth0","ipmi_MAC1",,</code> <br> <br>  5. Add information about hostame - ip compliance: <br><br> <code>#node,ip,hostnames,otherinterfaces,comments,disable <br> <br> tabedit hosts <br> <br> "depl1","2.2.2.2","depl1","depl1ipmi:3.3.3.2",, <br> "depl2","2.2.2.3","depl2","depl2ipmi:3.3.3.3",, <br> "depl3","2.2.2.4","depl3","depl3ipmi:3.3.3.4",, <br> ...</code> <br> <br>  We can generate these settings using a simple command: <br> <code>for i in `seq 1 200`; do echo '"depl$i'","2.2.2.'$[$i+1]'","depl'$i'","depl'$i'manage:3.3.3.'$[$i+1]'",,'; done</code> <br> <br>  6. Edit the options for virtual consoles and their speeds (here we can use all new machines to belong to the same group: in the end we only need one line instead of two hundred.): <br><br> <code>#node,power,mgt,cons,termserver,termport,conserver,serialport,serialspeed,serialflow,getmac,comments,disable <br> <br> tabedit nodehm <br> <br> "testgroup","ipmi","ipmi",,,,"1","1","115200",,,,</code> <br> <br>  7. <i>We rule the noderes</i> table: <br><br> <code>#node,servicenode,netboot,tftpserver,nfsserver,monserver,nfsdir,installnic,primarynic,discoverynics,cmdinterface,xcatmaster,current_osimage,next_osimage,nimserver,comments,disable <br> <br> tabedit noderes <br> <br> "depl",,"pxe","1.1.1.1","1.1.1.1",,,,,,,,,,,,</code> <br> <br>  8. Add information about the type of our servers, as well as the method of installing the OS: <br><br> <code>#node,os,arch,profile,provmethod,supportedarchs,nodetype,comments,disable <br> <br> tabedit nodetype <br> <br> "depl","sles11.1","x86_64","Templatename","install",,"osi",,</code> <br> <br>  In this case, we use the <i>install</i> method ‚Äî system installation; you can use <i>netboot</i> ‚Äî for network booting, as well as for performing service procedures. <br><br>  9. Add information about the compliance of the main server interface and its management interface: <br><br> <code>#node,bmc,bmcport,username,password,comments,disable <br> <br> tabedit ipmi <br> <br> "depl","/\z/ipmi/","0",‚Äùipmi_username‚Äù,"ipmi_password",,</code> <br> <br>  Here we also cheat and we will not indicate separately the correspondence for each server, but use the group.  Considering that the naming of the management interface is nothing more than the addition of ipmi to the hostname of the server, this is exactly what we need.  And we take into account that the username &amp; password for IPMI is the same for all servers, which is also indicated in the table. <br><br>  10. Now we generate the configuration of the <i>/ etc / hosts file</i> : <br> <code>makehosts</code> <br> <br>  11. Create a configuration for the DHCP server: <br> <code>makedhcp -a -n</code> <br> <br>  You can view information on any node: <br> <code>lsdef nodename</code> <br> <br>  Now the server is ready to start the installation process. <br><br>  12. We carry out: <br> <code>nodeset depl[1-10] install</code> <br> <br>  Instead of <i>depl [1-10] it is</i> allowed to use the group name or comma-separated list. <br>  At this stage, we get the configuration for PXE-loading on each host in <i>/tftpboot/pxelinux.cfg/</i> and a copy of the auto-installation file in <i>/ install / autoinst /</i> . <br><br>  13. We give the server a command to boot from the network interface at the next boot. <br> <code>rsetboot depl[1-10] net</code> <br> <br>  14. We send the server to reboot. <br> <code>rpower depl[1-10] boot</code> <br> <br>  Then we can observe the installation process in server consoles, or configure the <i>conserver</i> (this feature is not considered in this article). <br><br>  Last of all, we collect an <b>image for network boot</b> .  In Badoo, images are used to diagnose, restore and ‚Äúrevitalize‚Äù problem equipment, prepare non-standard hardware, and conduct performance tests. <br><br>  To do this, execute the <i>genimage</i> command ‚Äî it will launch an uncomplicated wizard, by answering whose questions we will get an image of the system in <br> <code>/install/netboot/$DISTR/$ARCH/profile_name</code> <br> <br>  The resulting image can be changed and edited at its discretion, after which you should run <br> <code>packimage -o $DISTR -p profile_name -a $ARCH</code> <br> <br>  So we get a ready-made netboot image to which we send our servers: <br><br> <code>nodeset depl[11-200] netboot=$DISTR-$ARCH-profile_name <br> <br> rsetboot depl[11-200] net <br> <br> rpower depl[11-200] boot</code> <br> <br>  It is advisable to put public keys into the netboot image, but you can use the access details from the passwd table ( <i>tabedit passwd</i> ) <br><br>  After all the preparatory procedures on the servers are completed, we start the OS installation on them - we will get the result in 15 minutes. <br><br>  It remains only to place all our servers in the required subnets, after which they pass through <a href="http://en.wikipedia.org/wiki/Puppet_(software)">Puppet</a> , which installs the necessary software individually, in groups, and also sets the necessary system parameters. <br><br>  In conclusion, I would like to note that in the presence of a system of this kind, it is enough for an engineer to give the necessary commands, making a minimum of effort to configure the servers. <br><br>  Of course, today we told far from all the advantages of the xCAT system and the intricacies of setting up, such moments as the management of hypervisors, as well as virtual servers on them through xCAT, were left out of the article;  installation and management of the xCAT server via a web interface, access to server consoles from the management server. <br><br>  We will be happy to continue the cycle of articles on the above topics, if they cause your interest, which you can always tell us in the comments. </div><p>Source: <a href="https://habr.com/ru/post/134228/">https://habr.com/ru/post/134228/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134220/index.html">Failover proxy server based on Squid in the Windows domain</a></li>
<li><a href="../134221/index.html">Singltons version 5.3 in 5.2</a></li>
<li><a href="../134222/index.html">Training course. Loading data from the Entity Framework in an ASP.NET MVC application</a></li>
<li><a href="../134225/index.html">Your own 3D scanner</a></li>
<li><a href="../134227/index.html">Vibroy - vibrodynamic with high-quality sound</a></li>
<li><a href="../134231/index.html">We work with EMS on violation of the delivery time of packages - instructions</a></li>
<li><a href="../134233/index.html">iPhone Gloss.ua 3.0 with a poster for 16 cities of Ukraine</a></li>
<li><a href="../134235/index.html">A living example of applying a flexible approach to software development in a Russian startup</a></li>
<li><a href="../134237/index.html">HTML5 Camp - as it were</a></li>
<li><a href="../134238/index.html">How to make a computer security competition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>