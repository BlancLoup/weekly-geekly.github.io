<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Register global keystrokes using JNA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, in this article I will tell you how to register global keystrokes from Java under Windows, Linux, BSD and Mac OSX using the excellent JNA libra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Register global keystrokes using JNA</h1><div class="post__text post__text-html js-mediator-article">  Hello, in this article I will tell you how to register global keystrokes from Java under Windows, Linux, BSD and Mac OSX using the excellent <a href="http://jna.java.net/">JNA</a> library. <br><br><h4>  What is JNA for? </h4><br>  Java is difficult with the desktop; for some things you need to write bridges to interact with the operating system.  One of these functionalities is global hotkeys, which are very popular in audio players, when even in the hidden state the program can be controlled using certain keyboard shortcuts or media buttons.  JNA comes to the rescue - add-on jni and libffi to call native libraries, it supports almost all popular platforms, has been developed for a long time and is very stable. <br><br>  For Java, there are already some fairly stable libraries for all platforms: <a href="http://melloware.com/products/jintellitype/index.html">JIntelliType</a> for Windows, which even supports media buttons, <a href="http://sourceforge.net/projects/jxgrabkey/">JXGrabKey</a> for Linux systems, and <a href="https://bitbucket.org/agynamix/ossupport-connector">ossuport-connector</a> for Mac OSX.  However, they all use jni, have a different interface, and it is not always convenient to work with libraries on jni, because you need to prescribe paths to native libraries, deal with system capacity, etc. Plus, this will be an interesting exercise in using JNA, because this task You can make it completely on java with a fairly small effort and get easily supported cross-platform code. <br><a name="habracut"></a><br><h4>  Windows </h4><br>  The easiest way to work with global hotkeys in Windows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  <font color="#000000">public</font> <font color="#000000">class</font> User32 <font color="#009900">{</font> <br>  <font color="#000000">static</font> <font color="#009900">{</font> <br>  <font color="#000000">Native</font> .  <font color="#006633">register</font> <font color="#009900">(</font> NativeLibrary. <font color="#006633">getInstance</font> <font color="#009900">(</font> <font color="#0000ff">"user32"</font> , W32APIOptions. <font color="#006633">DEFAULT_OPTIONS</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> MOD_ALT <font color="#339933">=</font> 0x0001 <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> MOD_CONTROL <font color="#339933">=</font> 0x0002 <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> MOD_SHIFT <font color="#339933">=</font> 0x0004 <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> MOD_WIN <font color="#339933">=</font> 0x0008 <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> WM_HOTKEY <font color="#339933">=</font> 0x0312 <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">native</font> <font color="#000066">boolean</font> RegisterHotKey <font color="#009900">(</font> Pointer hWnd, <font color="#000066">int</font> id, <font color="#000066">int</font> fsModifiers, <font color="#000066">int</font> vk <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">native</font> <font color="#000066">boolean</font> UnregisterHotKey <font color="#009900">(</font> Pointer hWnd, <font color="#000066">int</font> id <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">native</font> <font color="#000066">boolean</font> PeekMessage <font color="#009900">(</font> MSG lpMsg, Pointer hWnd, <font color="#000066">int</font> wMsgFilterMin, <font color="#000066">int</font> wMsgFilterMax, <font color="#000066">int</font> wRemoveMsg <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">class</font> MSG <font color="#000000">extends</font> Structure <font color="#009900">{</font> <br>  <font color="#000000">public</font> Pointer hWnd <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> message <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> wParam <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> lParam <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> time <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> x <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> y <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  Here we use the so-called <a href="">direct mapping</a> .  Besides the fact that it is faster, it is easier to work with it, since you can make static import and use the methods as native ones.  We need three methods from User32: <br><ul><li>  <a href="http://msdn.microsoft.com/en-us/library/ms646309%2528v%3Dvs.85%2529.aspx">RegisterHotKey</a> - actually registers hotkey.  The first parameter can be set to null, since we have no window.  The second parameter is the unique number of our hotkey, generated by us, it will later be used to identify the hotkey and to delete it via <a href="http://msdn.microsoft.com/en-us/library/ms646327%2528v%3Dvs.85%2529.aspx">UnregisterHotKey</a> .  In fsModifiers, we write what modifiers we need (ctrl, shift, alt or win).  In vk we write virtual code.  Interestingly, the virtual codes used in KeyEvent in AWT almost always coincide with <a href="http://msdn.microsoft.com/en-us/library/dd375731%2528v%3Dvs.85%2529.aspx">virtual codes</a> in Windows: <br><br><blockquote>  <font color="#666666">// register the combination WIN + F</font> <br>  RegisterHotKey <font color="#009900">(</font> <font color="#000066">null</font> , <font color="#cc66cc">1</font> , 0x8, <font color="#003399">KeyEvent</font> . <font color="#006633">VK_F</font> <font color="#009900">)</font> <font color="#339933">;</font> </blockquote><br></li><li>  <a href="http://msdn.microsoft.com/en-us/library/ms644943%2528v%3Dvs.85%2529.aspx">PeekMessage</a> - checks incoming messages and clogs them into the MSG structure.  This uses the non-blocking PeekMessage call instead of the blocking GetMessage due to the fact that all methods must be called from one thread and we need to be able to control this thread: <br><blockquote>  MSG msg <font color="#339933">=</font> <font color="#000000">new</font> MSG <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">while</font> <font color="#009900">(</font> listen <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000000">while</font> <font color="#009900">(</font> PeekMessage <font color="#009900">(</font> msg, <font color="#000066">null</font> , <font color="#cc66cc">0</font> , <font color="#cc66cc">0</font> , PM_REMOVE <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> msg. <font color="#006633">message</font> <font color="#339933">==</font> WM_HOTKEY <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#003399">System</font> .  <font color="#006633">out</font> .  <font color="#006633">println</font> <font color="#009900">(</font> <font color="#0000ff">"Yattaaaa. Hotkey with id"</font> <font color="#339933">+</font> msg. <font color="#006633">wParam</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#003399">Thread</font> .  <font color="#006633">sleep</font> <font color="#009900">(</font> <font color="#cc66cc">300</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> </blockquote><br>  Here we register a combination of WIN + F and check messages every 300 ms. </li></ul><br><h4>  X11 </h4><br>  Unfortunately, it will not be possible to use direct mapping for X11, as this for some reason causes errors when working with FreeBSD.  Mapping looks a bit more complicated: <br><br><blockquote>  <font color="#000000">public</font> <font color="#000000">interface</font> X11 <font color="#000000">extends</font> Library <font color="#009900">{</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> X11 Lib <font color="#339933">=</font> <font color="#009900">(</font> X11 <font color="#009900">)</font> <font color="#000000">Native</font> .  <font color="#006633">loadLibrary</font> <font color="#009900">(</font> <font color="#0000ff">"X11"</font> , X11. <font color="#000000">class</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> GrabModeAsync <font color="#339933">=</font> <font color="#cc66cc">1</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> KeyPress <font color="#339933">=</font> <font color="#cc66cc">2</font> <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> ShiftMask <font color="#339933">=</font> <font color="#009900">(</font> <font color="#cc66cc">1</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> LockMask <font color="#339933">=</font> <font color="#009900">(</font> <font color="#cc66cc">1</font> <font color="#339933">&lt;&lt;</font> <font color="#cc66cc">1</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> ControlMask <font color="#339933">=</font> <font color="#009900">(</font> <font color="#cc66cc">1</font> <font color="#339933">&lt;&lt;</font> <font color="#cc66cc">2</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> Mod1Mask <font color="#339933">=</font> <font color="#009900">(</font> <font color="#cc66cc">1</font> <font color="#339933">&lt;&lt;</font> <font color="#cc66cc">3</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> Mod2Mask <font color="#339933">=</font> <font color="#009900">(</font> <font color="#cc66cc">1</font> <font color="#339933">&lt;&lt;</font> <font color="#cc66cc">4</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> Mod3Mask <font color="#339933">=</font> <font color="#009900">(</font> <font color="#cc66cc">1</font> <font color="#339933">&lt;&lt;</font> <font color="#cc66cc">5</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> Mod4Mask <font color="#339933">=</font> <font color="#009900">(</font> <font color="#cc66cc">1</font> <font color="#339933">&lt;&lt;</font> <font color="#cc66cc">6</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> Mod5Mask <font color="#339933">=</font> <font color="#009900">(</font> <font color="#cc66cc">1</font> <font color="#339933">&lt;&lt;</font> <font color="#cc66cc">7</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> Pointer XOpenDisplay <font color="#009900">(</font> <font color="#003399">String</font> name <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> NativeLong XDefaultRootWindow <font color="#009900">(</font> Pointer display <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">byte</font> XKeysymToKeycode <font color="#009900">(</font> Pointer display, <font color="#000066">long</font> keysym <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> XGrabKey <font color="#009900">(</font> Pointer display, <font color="#000066">int</font> code, <font color="#000066">int</font> modifiers, NativeLong root, <font color="#000066">int</font> ownerEvents, <font color="#000066">int</font> pointerMode, <font color="#000066">int</font> keyBoardMode <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> XUngrabKey <font color="#009900">(</font> Pointer display, <font color="#000066">int</font> code, <font color="#000066">int</font> modifiers, NativeLong root <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> XNextEvent <font color="#009900">(</font> Pointer display, XEvent event <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> XPending <font color="#009900">(</font> Pointer display <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> XCloseDisplay <font color="#009900">(</font> Pointer display <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">class</font> XEvent <font color="#000000">extends</font> Union <font color="#009900">{</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> type <font color="#339933">;</font> <br>  <font color="#000000">public</font> XKeyEvent xkey <font color="#339933">;</font> <br>  <font color="#000000">public</font> NativeLong <font color="#009900">[</font> <font color="#009900">]</font> pad <font color="#339933">=</font> <font color="#000000">new</font> NativeLong <font color="#009900">[</font> <font color="#cc66cc">24</font> <font color="#009900">]</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">class</font> XKeyEvent <font color="#000000">extends</font> Structure <font color="#009900">{</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> type <font color="#339933">;</font>  <font color="#666666">// of event</font> <br>  <font color="#000000">public</font> NativeLong serial <font color="#339933">;</font>  <font color="#666666">// # of last request processed by server</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> send_event <font color="#339933">;</font>  <font color="#666666">// true if this came from a SendEvent request</font> <br>  <font color="#000000">public</font> Pointer display <font color="#339933">;</font>  <font color="#666666">// public display the event was read from</font> <br>  <font color="#000000">public</font> NativeLong window <font color="#339933">;</font>  <font color="#666666">// "event" window it is reported relative to</font> <br>  <font color="#000000">public</font> NativeLong root <font color="#339933">;</font>  <font color="#666666">// root window that the event occurred on</font> <br>  <font color="#000000">public</font> NativeLong subwindow <font color="#339933">;</font>  <font color="#666666">// child window</font> <br>  <font color="#000000">public</font> NativeLong time <font color="#339933">;</font>  <font color="#666666">// milliseconds</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> x, y <font color="#339933">;</font>  <font color="#666666">// pointer x, y coordinates in event window</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> x_root, y_root <font color="#339933">;</font>  <font color="#666666">// coordinates relative to root</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> state <font color="#339933">;</font>  <font color="#666666">// key or button mask</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> keycode <font color="#339933">;</font>  <font color="#666666">// detail</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> same_screen <font color="#339933">;</font>  <font color="#666666">// same screen flag</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> </blockquote><br><ul><li>  XOpenDisplay, XCloseDisplay, XDefaultRootWindow - receive and close the default display and root window. </li><li>  XKeysymToKeycode - converts a character (character descriptions are taken in <a href="">keysymdef.h</a> ) into a key code, you will need it later: <br><blockquote>  <font color="#666666">// for letters and numbers, the symbol number also corresponds to the value in KeyEvent</font> <br>  <font color="#000066">byte</font> code <font color="#339933">=</font> XKeysymToKeycode <font color="#009900">(</font> display, <font color="#003399">KeyEvent</font> . <font color="#006633">VK_F</font> <font color="#009900">)</font> <font color="#339933">;</font> <br></blockquote></li><li>  XGrabKey, XUngrabKey - register and delete hotkeys.  In code, the value obtained earlier with XKeysymToKeycode is written here, modifiers are written into modifiers, and the root value is written from XDefaultRootWindow.  The remaining values ‚Äã‚Äãare clogged with units.  Interestingly, in X11, the pressed ScrollLock, NumLock, CapsLock, and some other Lock are also considered modifiers, so instead of one hotkey, you have to register 16 for each possible combination: <br><blockquote>  <font color="#666666">// this hack is found in the global hotkey plugin in the deadbeef player</font> <br>  <font color="#000000">for</font> <font color="#009900">(</font> <font color="#000066">int</font> flags <font color="#339933">=</font> <font color="#cc66cc">0</font> <font color="#339933">;</font> flags <font color="#339933">&lt;</font> <font color="#cc66cc">16</font> <font color="#339933">;</font> i <font color="#339933">++</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000066">int</font> ret <font color="#339933">=</font> modifiers <font color="#339933">;</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> <font color="#009900">(</font> flags <font color="#339933">&amp;</font> <font color="#cc66cc">1</font> <font color="#009900">)</font> <font color="#339933">! =</font> <font color="#cc66cc">0</font> <font color="#009900">)</font> <br>  ret <font color="#339933">| =</font> LockMask <font color="#339933">;</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> <font color="#009900">(</font> flags <font color="#339933">&amp;</font> <font color="#cc66cc">2</font> <font color="#009900">)</font> <font color="#339933">! =</font> <font color="#cc66cc">0</font> <font color="#009900">)</font> <br>  ret <font color="#339933">| =</font> Mod2Mask <font color="#339933">;</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> <font color="#009900">(</font> flags <font color="#339933">&amp;</font> <font color="#cc66cc">4</font> <font color="#009900">)</font> <font color="#339933">! =</font> <font color="#cc66cc">0</font> <font color="#009900">)</font> <br>  ret <font color="#339933">| =</font> Mod3Mask <font color="#339933">;</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> <font color="#009900">(</font> flags <font color="#339933">&amp;</font> <font color="#cc66cc">8</font> <font color="#009900">)</font> <font color="#339933">! =</font> <font color="#cc66cc">0</font> <font color="#009900">)</font> <br>  ret <font color="#339933">| =</font> Mod5Mask <font color="#339933">;</font> <br>  XGrabKey <font color="#009900">(</font> display, code, ret, root, <font color="#cc66cc">1</font> , GrabModeAsync, GrabModeAsync <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// XUngrabKey (display, code, ret, root);</font> <br>  <font color="#009900">}</font> <br></blockquote><br>  Also, unlike Windows, where deleting a hotkey when the program exits is optional, if you do not call XUngrabKey, then X will keep it until restarting. <br></li><li>  XPending and XNextEvent - check for availability and extract the following event: <br><blockquote>  <font color="#000000">while</font> <font color="#009900">(</font> listening <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000000">while</font> <font color="#009900">(</font> Lib. <font color="#006633">XPending</font> <font color="#009900">(</font> display <font color="#009900">)</font> <font color="#339933">&gt;</font> <font color="#cc66cc">0</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  Lib.  <font color="#006633">XNextEvent</font> <font color="#009900">(</font> display, event <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> event. <font color="#006633">type</font> <font color="#339933">==</font> KeyPress <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// read our event from union XEvent</font> <br>  <font color="#666666">// JNA does not know which field to fill in the union,</font> <br>  <font color="#666666">// so he needs to tell which of the fields to count.</font> <br>  XKeyEvent xkey <font color="#339933">=</font> <font color="#009900">(</font> XKeyEvent <font color="#009900">)</font> event.  <font color="#006633">readField</font> <font color="#009900">(</font> <font color="#0000ff">"xkey"</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#666666">// clear garbage modifiers</font> <br>  <font color="#000066">int</font> state <font color="#339933">=</font> xkey.  <font color="#006633">state</font> <font color="#339933">&amp;</font> <font color="#009900">(</font> ShiftMask <font color="#339933">|</font> ControlMask <font color="#339933">|</font> Mod1Mask <font color="#339933">|</font> Mod4Mask <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#003399">System</font> .  <font color="#006633">out</font> .  <font color="#006633">println</font> <font color="#009900">(</font> <font color="#0000ff">"Yattaaaa, hotkey with code:"</font> <font color="#339933">+</font> xkey. keycode <font color="#339933">+</font> <font color="#0000ff">"and modifiers:"</font> <font color="#339933">+</font> state <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#003399">Thread</font> .  <font color="#006633">sleep</font> <font color="#009900">(</font> <font color="#cc66cc">300</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> </blockquote><br></li></ul><br><h4>  Mac osx </h4><br>  The basis of the code for Mac OSX was made up by the workings of <a href="http://lists.apple.com/archives/Java-dev/2010/Jul/msg00146.html">Torsten Uhlmann</a> , the author of ossupport-connector: <br><br><blockquote>  <font color="#000000">public</font> <font color="#000000">interface</font> Carbon <font color="#000000">extends</font> Library <font color="#009900">{</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> Carbon Lib <font color="#339933">=</font> <font color="#009900">(</font> Carbon <font color="#009900">)</font> <font color="#000000">Native</font> .  <font color="#006633">loadLibrary</font> <font color="#009900">(</font> <font color="#0000ff">"Carbon"</font> , Carbon. <font color="#000000">class</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> cmdKey <font color="#339933">=</font> 0x0100 <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> shiftKey <font color="#339933">=</font> 0x0200 <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> optionKey <font color="#339933">=</font> 0x0800 <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> controlKey <font color="#339933">=</font> 0x1000 <font color="#339933">;</font> <br><br>  <font color="#666666">// OS_TYPE concatenates string characters into int</font> <br>  <font color="#000000">private</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> kEventClassKeyboard <font color="#339933">=</font> OS_TYPE <font color="#009900">(</font> <font color="#0000ff">"keyb"</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">private</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> typeEventHotKeyID <font color="#339933">=</font> OS_TYPE <font color="#009900">(</font> <font color="#0000ff">"hkid"</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">private</font> <font color="#000000">static</font> <font color="#000000">final</font> <font color="#000066">int</font> kEventParamDirectObject <font color="#339933">=</font> OS_TYPE <font color="#009900">(</font> <font color="#0000ff">"----"</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> Pointer GetEventDispatcherTarget <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> <font color="#000066">int</font> InstallEventHandler <font color="#009900">(</font> Pointer inTarget, EventHandlerProcPtr inHandler, <font color="#000066">int</font> inNumTypes, EventTypeSpec <font color="#009900">[</font> <font color="#009900">]</font> inList, Pointer inUserData, PointerByReference outRef <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> RegisterEventHotKey <font color="#009900">(</font> <font color="#000066">int</font> inHotKeyCode, <font color="#000066">int</font> inHotKeyModifiers, EventHotKeyID. <font color="#006633">ByValue</font> inHotKeyID, Pointer inTarget, <font color="#000066">int</font> inOptions, PointerByReference outRef <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> GetEventParameter <font color="#009900">(</font> Pointer inEvent, <font color="#000066">int</font> inName, <font color="#000066">int</font> inDesiredType, Pointer outActualType, <font color="#000066">int</font> inBufferSize, IntBuffer outActualSize, EventHotKeyID outData <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> RemoveEventHandler <font color="#009900">(</font> Pointer inHandlerRef <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> UnregisterEventHotKey <font color="#009900">(</font> Pointer inHotKey <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> <font color="#000000">class</font> EventTypeSpec <font color="#000000">extends</font> Structure <font color="#009900">{</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> eventClass <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> eventKind <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">class</font> EventHotKeyID <font color="#000000">extends</font> Structure <font color="#009900">{</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> signature <font color="#339933">;</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> id <font color="#339933">;</font> <br><br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">class</font> ByValue <font color="#000000">extends</font> EventHotKeyID <font color="#000000">implements</font> Structure.  <font color="#006633">ByValue</font> <font color="#009900">{</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#000000">public</font> <font color="#000000">static</font> <font color="#000000">interface</font> EventHandlerProcPtr <font color="#000000">extends</font> Callback <font color="#009900">{</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> callback <font color="#009900">(</font> Pointer inHandlerCallRef, Pointer inEvent, Pointer inUserData <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> </blockquote><br><ul><li>  GetEventDispatcherTarget - gets a link to the system event handler </li><li> InstallEventHandler - adds our handler to this event handler.  Unlike other platforms, in Carbon, events come asynchronously via callback: <br><blockquote>  eventHandlerReference <font color="#339933">=</font> <font color="#000000">new</font> PointerByReference <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// actually the handler itself</font> <br>  keyListener <font color="#339933">=</font> <font color="#000000">new</font> EventHandler <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#666666">// JNA magic to create an array from one structure</font> <br>  EventTypeSpec <font color="#009900">[</font> <font color="#009900">]</font> eventTypes <font color="#339933">=</font> <font color="#009900">(</font> EventTypeSpec <font color="#009900">[</font> <font color="#009900">]</font> <font color="#009900">)</font> <font color="#009900">(</font> <font color="#000000">new</font> EventTypeSpec <font color="#009900">(</font> <font color="#009900">)</font> . <font color="#006633">ToArray</font> <font color="#009900">(</font> <font color="#cc66cc">1</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  eventTypes <font color="#009900">[</font> <font color="#cc66cc">0</font> <font color="#009900">]</font> .  <font color="#006633">eventClass</font> <font color="#339933">=</font> kEventClassKeyboard <font color="#339933">;</font> <br>  eventTypes <font color="#009900">[</font> <font color="#cc66cc">0</font> <font color="#009900">]</font> .  <font color="#006633">eventKind</font> <font color="#339933">=</font> kEventHotKeyPressed <font color="#339933">;</font> <br><br>  <font color="#000066">int</font> status <font color="#339933">=</font> lib.  <font color="#006633">InstallEventHandler</font> <font color="#009900">(</font> Lib. <font color="#006633">GetEventDispatcherTarget</font> <font color="#009900">(</font> <font color="#009900">)</font> , keyListener, <font color="#cc66cc">1</font> , eventTypes, <font color="#000066">null</font> , eventHandlerReference <font color="#009900">)</font> <font color="#339933">;</font> </blockquote><br>  Here we specify that we will process keyboard messages, namely pressing hot keys. <br>  The eventHandlerReference comes back link to the handler that is needed in RemoveEventHandler. <br><br>  The event handler looks like this: <br><blockquote>  <font color="#000000">private</font> <font color="#000000">class</font> EventHandler <font color="#000000">implements</font> Carbon.  <font color="#006633">EventHandlerProcPtr</font> <font color="#009900">{</font> <br>  <font color="#000000">public</font> <font color="#000066">int</font> callback <font color="#009900">(</font> Pointer inHandlerCallRef, Pointer inEvent, Pointer inUserData <font color="#009900">)</font> <font color="#009900">{</font> <br>  EventHotKeyID eventHotKeyID <font color="#339933">=</font> <font color="#000000">new</font> EventHotKeyID <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// get event parameters</font> <br>  <font color="#000066">int</font> ret <font color="#339933">=</font> lib.  <font color="#006633">GetEventParameter</font> <font color="#009900">(</font> inEvent, kEventParamDirectObject, typeEventHotKeyID, <font color="#000066">null</font> , eventHotKeyID. <font color="#006633">Size</font> <font color="#009900">(</font> <font color="#009900">)</font> , <font color="#000066">null</font> , eventHotKeyID <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000000">if</font> <font color="#009900">(</font> ret <font color="#339933">! =</font> <font color="#cc66cc">0</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  logger.  <font color="#006633">warning</font> <font color="#009900">(</font> <font color="#0000ff">"Could not get event parameters. Error code:"</font> <font color="#339933">+</font> ret <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <font color="#000000">else</font> <font color="#009900">{</font> <br>  <font color="#666666">// Get and handle event id here</font> <br>  <font color="#000066">int</font> eventId <font color="#339933">=</font> eventHotKeyID.  <font color="#006633">id</font> <font color="#339933">;</font> <br>  logger.  <font color="#006633">info</font> <font color="#009900">(</font> <font color="#0000ff">"Received event id:"</font> <font color="#339933">+</font> eventId <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#000000">return</font> <font color="#cc66cc">0</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> </blockquote><br></li><li>  RegisterEventHotKey - registers a hotkey.  At the entrance is the key code.  The code table is <a href="http://classicteck.com/rbarticles/mackeyboard.php">here</a> .  Next, a list of modifiers.  Then the EventHotKeyID.ByValue structure, into which our identifier and four-letter signature are clogged.  ByValue is used because by default structures are passed by reference, and we need by value.  A reference to this hotkey is returned, which is used in the UnregisterEventHotKey: <br><br><blockquote>  EventHotKeyID.  <font color="#006633">ByValue</font> hotKeyReference <font color="#339933">=</font> <font color="#000000">new</font> EventHotKeyID.  <font color="#006633">ByValue</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  hotKeyReference.  <font color="#006633">id</font> <font color="#339933">=</font> <font color="#cc66cc">1</font> <font color="#339933">;</font> <br>  hotKeyReference.  <font color="#006633">signature</font> <font color="#339933">=</font> OS_TYPE <font color="#009900">(</font> <font color="#0000ff">"hk01"</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  PointerByReference gMyHotKeyRef <font color="#339933">=</font> <font color="#000000">new</font> PointerByReference <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#000066">int</font> status <font color="#339933">=</font> lib.  <font color="#006633">RegisterEventHotKey</font> <font color="#009900">(</font> code, modifiers, hotKeyReference, Lib. <font color="#006633">GetEventDispatcherTarget</font> <font color="#009900">(</font> <font color="#009900">)</font> , <font color="#cc66cc">0</font> , gMyHotKeyRef <font color="#009900">)</font> <font color="#339933">;</font> </blockquote><br></li></ul><br><br><h4>  Conclusion </h4><br>  In general, everything is quite simple, although there were some problems, such as crashes when using direct mapping on FreeBSD, JNA‚Äôs failure to get boolean in XGrabKey on an int, strange errors when passing a structure by reference, and not in Carbon, errors generated by X11 if the hotkey is already busy, which just cut down the program, the difficulty of finding any documentation on Carbon. <br><br>  All this code is compiled into the <a href="https://github.com/tulskiy/jkeymaster">jkeymaster</a> library under the LGPL 3 license. The interface is based on KeyStroke from Swing; for Windows and X11, you can register media buttons ‚Äî Play / Pause, Stop, Next Track, Previous Track. <br><br>  Comments and patches are welcome. <br><br>  ps The post is written by <a href="https://habrahabr.ru/users/tulskiy/" class="user_link">tulskiy</a> , which, thanks to <a href="https://habrahabr.ru/users/mgarin/" class="user_link">mgarin, is</a> now in place.  So all the benefits to him. </div><p>Source: <a href="https://habr.com/ru/post/124567/">https://habr.com/ru/post/124567/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../124558/index.html">The most expected update "ProGorod"</a></li>
<li><a href="../124561/index.html">Apple vs Android: Show me innovation!</a></li>
<li><a href="../124562/index.html">US authorities accuse Internet activist of downloading 4 million scientific articles</a></li>
<li><a href="../124563/index.html">Yandex search and Rambler mail migrate from FreeBSD to Linux</a></li>
<li><a href="../124564/index.html">Creating a radio station. From idea to implementation</a></li>
<li><a href="../124569/index.html">Linux received a video from Microsoft as a present for its 20th anniversary</a></li>
<li><a href="../124570/index.html">Google helps fight viruses</a></li>
<li><a href="../124571/index.html">Online entropy password generator</a></li>
<li><a href="../124572/index.html">Cisco will fire 6500 employees and sell the plant in Mexico</a></li>
<li><a href="../124573/index.html">Setting up the environment on Mac OS and building a standalone application with PySide / PyQt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>