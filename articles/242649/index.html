<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lattice inheritance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Inheritance, with seeming simplicity, often leads to complex structures resisting change. Class hierarchies grow like a real forest. 
 The goal of inh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Lattice inheritance</h1><div class="post__text post__text-html js-mediator-article">  Inheritance, with seeming simplicity, often leads to complex structures resisting change.  Class hierarchies grow like a real forest. <br>  The goal of inheritance is to bind the code (set of methods) to the minimum set of properties of an entity (usually an object) that it provides and which it needs.  It simplifies reuse, testing and code analysis.  But the sets of properties over time become very large, begin to intersect in a non-trivial way.  And in the structure of classes there are mixins and other multiple inheritance. <br>  Making changes in the depth of the hierarchy becomes problematic, you have to think in advance about ‚Äúdependency injection‚Äù, to develop and use complex refactoring tools. <br><br>  Is it possible to avoid all this?  It is worth trying - let the methods be tied to a set of characteristic properties of the object (tags), and the inheritance hierarchy is built automatically according to the nesting of these sets. <br><br>  Let us develop a hierarchy for game characters.  Part of the code will be common to all characters - it is tied to an empty set of properties.  The code responsible for their display will be presented in the form of options for OpenGL and DirectX different versions.  Something will depend on the character's race, something on the presence and type of magical abilities, and so on.  Character tags are primary.  They are listed explicitly and not inherited.  And the implementation is inherited depending on the set of tags (by nesting).  Thus, the ability to fire MANPADS will not be available to the kangaroo, because it was inherited from the infantryman. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The idea of ‚Äã‚Äãthis approach was proposed by Dmitry Kim.  The author did not embody it in the code, I will try to correct this omission. <br>  Implementing this approach on Clojure, as usual, on <a href="">github</a> . <br><a name="habracut"></a><br>  The implementation of this method of inheritance is made on top of the Clojure system of generalized functions (multimethods). <br>  Each multimethod defined with defmulti is associated with a hierarchy and dispatching function, which maps arguments to elements (or an array of elements) of the hierarchy.  Usually the elements of the hierarchy are data types, but in their hierarchies you can also use ‚Äúkeywords‚Äù and ‚Äúsymbols‚Äù, which will mark data related to the desired type. <br>  The specific implementation of the method for the hierarchy element is specified using defmetod. <br>  It looks like this: <br><pre><code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">use</span></span> 'inheritance.grid) (<span class="hljs-name"><span class="hljs-name">def</span></span> grid (<span class="hljs-name"><span class="hljs-name">make-grid-hierarchy</span></span>)) (<span class="hljs-name"><span class="hljs-name">defmulti</span></span> canFly <span class="hljs-string"><span class="hljs-string">"  "</span></span> (<span class="hljs-name"><span class="hljs-name">grid-dispatch1</span></span>) <span class="hljs-symbol"><span class="hljs-symbol">:hierarchy</span></span> #'grid) (<span class="hljs-name"><span class="hljs-name">defmulti</span></span> canFireball <span class="hljs-string"><span class="hljs-string">"   "</span></span> (<span class="hljs-name"><span class="hljs-name">grid-dispatch1</span></span>) <span class="hljs-symbol"><span class="hljs-symbol">:hierarchy</span></span> #'grid) (<span class="hljs-name"><span class="hljs-name">defmulti</span></span> canFire <span class="hljs-string"><span class="hljs-string">"  "</span></span> (<span class="hljs-name"><span class="hljs-name">grid-dispatch1</span></span>) <span class="hljs-symbol"><span class="hljs-symbol">:hierarchy</span></span> #'grid) (<span class="hljs-name"><span class="hljs-name">defmethod</span></span> canFly (<span class="hljs-name"><span class="hljs-name">get-grid-node</span></span> {} #'grid) [p] false) <span class="hljs-comment"><span class="hljs-comment">;     (defmethod canFly (get-grid-node {:magic :air} #'grid) [p] true) ;    -  (defmethod canFly (get-grid-node {:limbs :wings} #'grid) [p] true) ;   (defmethod canFireball (get-grid-node {} #'grid) [p] false) ;      (defmethod canFireball (get-grid-node {:magic :fire, :limbs :hands} #'grid) [p] (&gt; (:mana p) 0)) ;       - ,   . (defmethod canFire (get-grid-node {} #'grid) [p] false) ; , ,     (defmethod canFire (get-grid-node {:limbs :hands} #'grid) [p] true) ;     (defmethod canFire (get-grid-node {:magic :fire} #'grid) [p] (&gt; (:mana p) 0)) ;       (defmethod canFire (get-grid-node {:magic :fire, :limbs :hands} #'grid) [p] true) ;     - Clojure   ,      (def mage ((with-grid-node {:magic :fire, :limbs :hands :race :mage} #'grid) {:mana 100, :power 5})) (def barbar ((with-grid-node {:magic :none, :limbs :hands :race :human} #'grid) {:power 500})) (def phoenix ((with-grid-node {:magic :fire, :limbs :wings :race :mage} #'grid) {:mana 200, :power 4})) (def elf ((with-grid-node {:magic :air, :limbs :hands :race :elf} #'grid) {:mana 300, :power 13})) (canFire elf) ; true (canFireball elf) ; false (canFly elf) ; true (canFly mage) ; false (canFire mage) ; true</span></span></code> </pre> <br><br>  How does it work: <br>  First you need to create a hierarchy - this will be the usual Clojure hierarchy, with a table displaying a set of tags (in the form of an associative array) to a member in the hierarchy.  The table is initially empty and is stored in the meta-information of the hierarchy object. <br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defn</span></span> make-grid-hierarchy <span class="hljs-string"><span class="hljs-string">"   "</span></span> [] (<span class="hljs-name"><span class="hljs-name">let</span></span> [h (<span class="hljs-name"><span class="hljs-name">make-hierarchy</span></span>)] <span class="hljs-comment"><span class="hljs-comment">;    (with-meta h (assoc (or (meta h) {}) :grid-hierarchy-cache {})))) ;      </span></span></code> </pre><br><br>  Each set of tags used must be registered in the hierarchy - a symbol is created for it and included in the correct place of the hierarchy, and the corresponding entry in the table is added so that this symbol can be found.  Calculating the correct place in the hierarchy is the basis of this method of managing inheritance. <br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defn</span></span> register-grid-node <span class="hljs-string"><span class="hljs-string">"     "</span></span> [ho] (<span class="hljs-name"><span class="hljs-name">let</span></span> [nl (<span class="hljs-name"><span class="hljs-name">get</span></span> (<span class="hljs-name"><span class="hljs-name">meta</span></span> h) <span class="hljs-symbol"><span class="hljs-symbol">:grid-hierarchy-cache</span></span> {})] (<span class="hljs-name"><span class="hljs-name">if-let</span></span> [s (<span class="hljs-name"><span class="hljs-name">nl</span></span> o)] <span class="hljs-comment"><span class="hljs-comment">;       [hs] ;        (let [s (symbol (str o)) ;   -    hn (reduce (fn [h [tr n]] ;     (if (and (subobj? tr o) ;          (not (isa? hsn))) ; Clojure      , ;     (derive hsn) (if (and (subobj? o tr) (not (isa? hns))) ;       (derive hns) h))) h nl)] [(with-meta hn ;         (assoc (or (meta h) {}) :grid-hierarchy-cache (assoc nl os))) s])))) ;       </span></span></code> </pre><br><br>  Now we need to learn how to associate a type from a certain lattice site, given by a set of tags, with data that we consider to belong to this type. <br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defn</span></span> with-grid-node <span class="hljs-string"><span class="hljs-string">" ,      "</span></span> [nh] (<span class="hljs-name"><span class="hljs-name">let</span></span> [s (<span class="hljs-name"><span class="hljs-name">get-grid-node</span></span> nh)] (<span class="hljs-name"><span class="hljs-name">fn</span></span> [v] (<span class="hljs-name"><span class="hljs-name">with-meta</span></span> v (<span class="hljs-name"><span class="hljs-name">assoc</span></span> (<span class="hljs-name"><span class="hljs-name">or</span></span> (<span class="hljs-name"><span class="hljs-name">meta</span></span> v) {}) <span class="hljs-symbol"><span class="hljs-symbol">:grid-node</span></span> s)))))</code> </pre><br>  To avoid repeated searches on the node table, this function gets the character corresponding to the node and returns a closure that adds this character to the meta information of its argument. <br><br>  Dispatch functions are simple. <br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">defn</span></span> grid-dispatch <span class="hljs-string"><span class="hljs-string">"     "</span></span> [] (<span class="hljs-name"><span class="hljs-name">fn</span></span> [&amp; v] (<span class="hljs-name"><span class="hljs-name">vec</span></span> (<span class="hljs-name"><span class="hljs-name">map</span></span> (<span class="hljs-name"><span class="hljs-name">fn</span></span> [a] (<span class="hljs-symbol"><span class="hljs-symbol">:grid-node</span></span> (<span class="hljs-name"><span class="hljs-name">meta</span></span> a))) v)))) (<span class="hljs-name"><span class="hljs-name">defn</span></span> grid-dispatch1 <span class="hljs-string"><span class="hljs-string">"    "</span></span> [] (<span class="hljs-name"><span class="hljs-name">fn</span></span> [v &amp; _] (<span class="hljs-symbol"><span class="hljs-symbol">:grid-node</span></span> (<span class="hljs-name"><span class="hljs-name">meta</span></span> v))))</code> </pre><br><br>  I have already <a href="http://ru-declarative.livejournal.com/4711.html">tried to implement</a> such inheritance in Common Lisp.  But I do not know the MOP device, and that implementation is not built into CLOS and is not very efficient. </div><p>Source: <a href="https://habr.com/ru/post/242649/">https://habr.com/ru/post/242649/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242631/index.html">Sync music and gaming events on Unity</a></li>
<li><a href="../242639/index.html">Perfect transfer and universal references in C ++</a></li>
<li><a href="../242643/index.html">Create a portfolio based on photos from Instagram</a></li>
<li><a href="../242645/index.html">‚ÄúNever say never‚Äù or working with timezone correctly</a></li>
<li><a href="../242647/index.html">The simplest SMTP server for development</a></li>
<li><a href="../242653/index.html">New profession at the first attempt or sincerity at the interview</a></li>
<li><a href="../242657/index.html">Puppet. Part 1: An Introduction to Hiera</a></li>
<li><a href="../242659/index.html">As I suddenly cut interest in the texts</a></li>
<li><a href="../242665/index.html">About the applied aspects of managing people in an organization or where are the children?</a></li>
<li><a href="../242669/index.html">The digest of interesting materials for mobile developer # 78 (November 2-9)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>