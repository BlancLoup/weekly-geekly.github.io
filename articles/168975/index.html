<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with sensors in Android, or a service to record readings from the accelerometer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 A year ago, the article ‚ÄúCollecting sensor readings from an Android smartphone‚Äù was published on Habr√©, where a method of obtaining dat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with sensors in Android, or a service to record readings from the accelerometer</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  A year ago, the article <a href="http://habrahabr.ru/post/137678/">‚ÄúCollecting sensor readings from an Android smartphone‚Äù was</a> published on Habr√©, where a method of obtaining data from an accelerometer was considered (by the way, there is <a href="http://habrahabr.ru/post/119360/">an older post</a> that tells the same thing).  Recently, I was given a similar task.  It was necessary to create an application (I decided to call it ‚ÄúSensor Logger‚Äù), recording readings from the accelerometer to a file in the <u>background</u> .  In this article I will try to show how you can use services and intentions, how to work with text files, and also how to send data from the service to the Activity. <a name="habracut"></a><br>  <code>SensorManager</code> don‚Äôt see much point in telling about taking readings from sensors, <code>SensorEventListener</code> and <code>SensorManager</code> classes.  cited above two articles, which detail this. <br><br>  It is assumed that this project will be educational for the reader, since for me it was exactly that.  Until now, I have never written in Java and have not worked with the Android SDK. <br><br><h4>  As it turned out, not everything is so simple </h4><br>  In the above articles, examples were considered when sensors were taken in the main Activity.  They turned out to be only partially applicable to my task.  For there is a fly in the ointment: the <a href="http://developer.android.com/reference/android/app/Activity.html">life cycle of the Activity</a> .  Obviously, it will not be possible to write data to the file in the background if the Activity class does this, therefore, after reading a number of articles, it was decided to write a service that will record the sensor readings. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Pro services in Android </h4><br>  In Android, there is a <a href="http://developer.android.com/reference/android/app/Service.html">Service</a> class that allows you to perform application tasks in the background (it is worth noting that the service and Activity are working in the same thread) while the phone is locked or the application is minimized.  The service does not require a UI, but it can transmit information to the Activity (for example, for display) or other services. <br><br><h4>  Starting the service, receiving readings from the accelerometer, writing to a file </h4><br>  Consider the process of starting the service ( <code>onStartCommand</code> method) <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SuppressLint</span></span>(<span class="hljs-string"><span class="hljs-string">"DefaultLocale"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SensorLoggerService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SensorEventListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SensorManager sm; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BufferedOutputStream outStream; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> OutputStreamWriter sWriter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String appDirString; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Calendar cal; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long startTime; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String date_format = <span class="hljs-string"><span class="hljs-string">"yyyy-MM-dd_HH-mm-ss"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Boolean first = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStartCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent intent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> startId)</span></span></span><span class="hljs-function"> </span></span>{ sm = (SensorManager) getSystemService(SENSOR_SERVICE); appDirString = intent.getStringExtra(MainActivity.APP_DIR); rec_start(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onStartCommand(intent, flags, startId); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rec_start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { String filename = currentDateToString()+<span class="hljs-string"><span class="hljs-string">".txt"</span></span>; File appDir = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(appDirString); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!appDir.exists()) appDir.mkdirs(); File file = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(appDir, filename); outStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferedOutputStream(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(file)); Toast.makeText(getApplicationContext(), appDirString+filename,Toast.LENGTH_SHORT).show(); sWriter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OutputStreamWriter(outStream); Toast.makeText(getApplicationContext(), getString(R.string.record_started),Toast.LENGTH_SHORT).show(); sm.registerListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,sm.getDefaultSensor(Sensor.TYPE_ACCELEROMETER), sm.SENSOR_DELAY_NORMAL); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Throwable t1) { Toast.makeText(getApplicationContext(), <span class="hljs-string"><span class="hljs-string">"Exception: "</span></span> + t1.toString(), Toast.LENGTH_LONG).show(); } }</code> </pre><br>  When the service starts, the object of the <code>SensorManager</code> type (variable <code>sm</code> ) is initialized.  This class in Android is designed to work with sensors (you can read about it in the following articles in the introduction, as well as in the <a href="http://developer.android.com/reference/android/hardware/SensorManager.html">documentation</a> ). <br><br>  At the next stage, the service receives the name of the directory (using the <a href="http://developer.android.com/reference/android/content/Intent.html">Intent</a> - intent) into which it is necessary to record files with readings (if not, the program will create the necessary folder) and open for writing a file whose name is the date and time the service was started.  The <code>currentDateToString</code> method, which returns the date and time as a string, is responsible for generating the file name. <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SuppressLint</span></span>(<span class="hljs-string"><span class="hljs-string">"SimpleDateFormat"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">currentDateToString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SimpleDateFormat sdf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleDateFormat(date_format); cal = Calendar.getInstance(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sdf.format(cal.getTime()); }</code> </pre><br>  After opening the file, we begin to take readings from the sensors. <br><br>  When the state of any of the sensors <code>onSensorChanged</code> , the <code>onSensorChanged</code> method is <code>onSensorChanged</code> , inside which there is a check on which sensor the event occurred, and if it is an accelerometer, then the readings that came are recorded in the file and sent to the Application Activity (a new intention is created and <code>sendBroadcast</code> function): <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSensorChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SensorEvent event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(event.sensor.getType()==Sensor.TYPE_ACCELEROMETER) writeData(event.values); } <span class="hljs-meta"><span class="hljs-meta">@SuppressLint</span></span>(<span class="hljs-string"><span class="hljs-string">"DefaultLocale"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> values[])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ cal = Calendar.getInstance(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(first) { startTime = cal.getTimeInMillis(); first = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } Long currentTime = cal.getTimeInMillis()-startTime; String data = Long.toString(currentTime)+String.format(<span class="hljs-string"><span class="hljs-string">" %f %f %f\n"</span></span>, values[<span class="hljs-number"><span class="hljs-number">0</span></span>],values[<span class="hljs-number"><span class="hljs-number">1</span></span>],values[<span class="hljs-number"><span class="hljs-number">2</span></span>]); sWriter.write(data); Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(MainActivity.BROADCAST_ACTION); intent.putExtra(MainActivity.VAL1, values[<span class="hljs-number"><span class="hljs-number">0</span></span>]); intent.putExtra(MainActivity.VAL2, values[<span class="hljs-number"><span class="hljs-number">1</span></span>]); intent.putExtra(MainActivity.VAL3, values[<span class="hljs-number"><span class="hljs-number">2</span></span>]); sendBroadcast(intent); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Throwable t1) { Toast.makeText(getApplicationContext(), <span class="hljs-string"><span class="hljs-string">"Exception: "</span></span> + t1.toString(), Toast.LENGTH_SHORT) .show(); } }</code> </pre><br>  In Activity, receiving messages from a service is implemented using the <a href="http://developer.android.com/reference/android/content/BroadcastReceiver.html">BroadcastReciever</a> class, which accepts intentions sent using the <code>sendBroadcast</code> function.  Consider the <code>rec_start</code> method from the Activity class: <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String BROADCAST_ACTION = <span class="hljs-string"><span class="hljs-string">"SensorLoggerServiceRecieve"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rec_start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Intent startServiceIntent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,SensorLoggerService.class) .putExtra(APP_DIR, appDirString); startService(startServiceIntent); rec=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; button_rec_off.setEnabled(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); button_rec_on.setEnabled(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); intentFlt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntentFilter(BROADCAST_ACTION); br = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BroadcastReceiver() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> val1 = intent.getFloatExtra(VAL1, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> val2 = intent.getFloatExtra(VAL2, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> val3 = intent.getFloatExtra(VAL3, <span class="hljs-number"><span class="hljs-number">0</span></span>); x_label.setText(<span class="hljs-string"><span class="hljs-string">"X: "</span></span>+String.valueOf(val1)); y_label.setText(<span class="hljs-string"><span class="hljs-string">"Y: "</span></span>+String.valueOf(val2)); z_label.setText(<span class="hljs-string"><span class="hljs-string">"Z: "</span></span>+String.valueOf(val3)); } }; registerReceiver(br, intentFlt); }</code> </pre><br>  The <code>button_rec_off, button_rec_on</code> objects are objects of the <code>Button</code> class, and <code>x_label, y_label</code> and <code>z_label</code> are <code>TextView</code> . <br>  In this method, the service is started, the BroadcastReciever is initialized and the intentions filter is created (the <a href="http://developer.android.com/reference/android/content/IntentFilter.html">IntentFilter</a> class). <br><br>  It is worth noting that my code also provides methods for stopping the recording process.  The source code and * .apk can be downloaded in the repository.  Link below. <br><br><h4>  Instead of conclusion </h4><br>  In conclusion of the above, I will provide links to resources that helped me learn the basics of developing for Android: <br><ul><li>  Project <a href="http://startandroid.ru/ru/">startandroid.ru</a> - a huge number of code examples with explanations </li><li>  <a href="http://www.ozon.ru/context/detail/id/6752687/">Reto Meier</a> 's book - the book explains everything in an accessible and understandable way. </li><li>  <a href="http://developer.android.com/reference/android/hardware/SensorManager.html">ServiceManager documentation</a> </li></ul><br>  Source Code and * .apk laid out on the <a href="https://bitbucket.org/lex_t/sensorlogger">repository</a> </div><p>Source: <a href="https://habr.com/ru/post/168975/">https://habr.com/ru/post/168975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../168965/index.html">Pocketbook Touch: software solves</a></li>
<li><a href="../168967/index.html">Reliability SSD drives and monitoring tools</a></li>
<li><a href="../168969/index.html">What and in what volume you need to know php programmer</a></li>
<li><a href="../168971/index.html">Useful stuff when developing in C # under AutoCAD</a></li>
<li><a href="../168973/index.html">Replacing standard select in browser</a></li>
<li><a href="../168977/index.html">HTML with images in DOC in PHP with your own hands</a></li>
<li><a href="../168979/index.html">Results of a uniform rating of web studios 2013</a></li>
<li><a href="../168981/index.html">Monitor the health of HP Proliant servers at nagios / icinga. Plugins check_hpasm and check_ilo2_health.pl</a></li>
<li><a href="../168983/index.html">The buzz around Nokia‚Äôs early collapse is unjustified, or what are analysts keeping back?</a></li>
<li><a href="../168985/index.html">About long life and imminent death of magnetic stripe cards</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>