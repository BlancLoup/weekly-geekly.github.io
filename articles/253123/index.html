<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Making the code cleaner: What can be fixed in the Linux kernel</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Surely many would like to try to change something in the Linux kernel for the better, but do not know where to start. I want to describe a few problem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Making the code cleaner: What can be fixed in the Linux kernel</h1><div class="post__text post__text-html js-mediator-article">  Surely many would like to try to change something in the Linux kernel for the better, but do not know where to start.  I want to describe a few problems that can be fixed by everyone, and with an example, show the way from finding a problem to publishing a fix in the mailing list.  In the course of the story, the reader will get acquainted with some auxiliary utilities. <br><a name="habracut"></a><br>  From year to year, the same trivial problems, often associated with not knowing any standard practices, utilities or extensions that exist in the Linux kernel, roam from the driver to the driver. <br><br>  Here is a brief list of these kinds of problems: <br><ul><li>  <a href="https://habr.com/ru/post/253123/">typos and clerks</a> in the documentation and comments </li><li>  <a href="https://habr.com/ru/post/253123/">own implementation of displaying the</a> contents of structures or their fields on the screen </li><li>  <a href="https://habr.com/ru/post/253123/">own implementation of algorithms</a> that are already provided in the core library </li><li>  <a href="https://habr.com/ru/post/253123/">definition of existing constants</a> and data types </li></ul><br><br><a name="ExistsTypo"></a><br><h3>  <font color="blue">Typos and Tips</font> </h3>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Typos and clerks in the documentation and comments - this is not uncommon.  One person, namely Lucas De Marchi, developed a special utility <a href="https://github.com/lucasdemarchi/codespell">codespell</a> to catch such typos. <br><br>  The following example will tell everything about itself. <br><br>  Clone the kernel: <br><pre><code class="bash hljs">mkdir ~/devel <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/devel git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/devel/linux-next</code> </pre> <br>  <i>Please note that we will work with the most recent, that is, with the linux-next tree.</i> <br><br>  We make a test launch of <code>codespell</code> : <br><pre> <code class="bash hljs">$ codespell.py drivers/staging/unisys drivers/staging/unisys/include/guestlinuxdebug.h:138: doesnt ==&gt; doesn<span class="hljs-string"><span class="hljs-string">'t</span></span></code> </pre><br>  Now fix: <br><pre> <code class="bash hljs">$ codespell.py -w -i 3 drivers/staging/unisys * doesnt show, so we doesnt ==&gt; doesn<span class="hljs-string"><span class="hljs-string">'t (Y/n) y FIXED: drivers/staging/unisys/include/guestlinuxdebug.h</span></span></code> </pre><br>  Look what happened: <br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/drivers/staging/unisys/include/guestlinuxdebug.h +++ b/drivers/staging/unisys/include/guestlinuxdebug.h @@ -135,7 +135,7 @@ enum event_pc { /* POSTCODE event identifier tuples */ #define POSTCODE_SEVERITY_ERR DIAG_SEVERITY_ERR #define POSTCODE_SEVERITY_WARNING DIAG_SEVERITY_WARNING #define POSTCODE_SEVERITY_INFO DIAG_SEVERITY_PRINT /* TODO-&gt; Info currently - * doesnt show, so we + * doesn't show, so we * set info=warning */ /* example call of POSTCODE_LINUX_2(VISOR_CHIPSET_PC, POSTCODE_SEVERITY_ERR); * Please also note that the resulting postcode is in hex, so if you are</span></span></code> </pre><br><br><a name="OwnP"></a><br><h3>  <font color="blue">Own implementation of the output</font> </h3><br><br>  Not so much a problem as an improvement in the readability of the code and micro-optimization: often a significant decrease in the memory consumed on the stack when the function is called, a decrease in the number of passed qualifiers in vsnprintf (). <br><br>  Earlier, I described the <a href="http://habrahabr.ru/post/252453/">special extensions of the% p specifier</a> in the kernel; now it‚Äôs the turn to apply the knowledge gained. <br><br><a name="ToPH"></a><br>  For simplicity, take the pattern <br>  <b>% 02x [-:]% 02x [-:]% 02x</b> .  It allows you to find the transmission of several bytes through the stack, which can be replaced by the extension <b>% * ph [CDN]</b> . <br><br>  Let's look in the code: <br><pre> <code class="bash hljs">$ git grep -n -i -e <span class="hljs-string"><span class="hljs-string">'%02x[-: ]%02x[-: ]%02x'</span></span> drivers/staging/unisys drivers/staging/unisys/virtpci/virtpci.c:1313: <span class="hljs-string"><span class="hljs-string">"[%d:%d] VNic:%02x:%02x:%02x:%02x:%02x:%02x num_rcv_bufs:%d mtu:%d"</span></span>,</code> </pre><br><br>  What we will do next, I will describe the <a href="https://habr.com/ru/post/253123/">example</a> below.  In the meantime, proceed to the following problem areas. <br><br><a name="OwnA"></a><br><h3>  <font color="blue">Own implementation of algorithms</font> </h3><br><br>  Here, for example, take drivers / staging / fbtft / fbtft-bus.c, lines 99-100: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; pad; i++) *buf++ = <span class="hljs-number"><span class="hljs-number">0x000</span></span>;</code> </pre><br>  pad is defined as u16 and can be in the range from 0 to 3, that is, from 0 to 6 bytes.  As we know, memset () is a terribly optimized function, especially on small sizes.  Why not apply? <br><br>  Or another example from the same driver, namely drivers / staging / fbtft / fbtft-core.c, lines 1091-1096: <br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">/* make debug message */</span></span> msg[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; i; j++) { <span class="hljs-built_in"><span class="hljs-built_in">snprintf</span></span>(str, <span class="hljs-number"><span class="hljs-number">128</span></span>, <span class="hljs-string"><span class="hljs-string">" %02X"</span></span>, buf[j]); <span class="hljs-built_in"><span class="hljs-built_in">strcat</span></span>(msg, str); }</code> </pre><br>  People did not know that there is bin2hex () in the kernel, not to mention that strcat () is completely superfluous - snprintf () adds the terminating '\ 0'. <br><br>  Try modifying yourself. <br><br><div class="spoiler">  <b class="spoiler_title">Has someone already seen how to simplify?</b> <div class="spoiler_text">  In fact, the buffer is needed to output the dump in hexadecimal, so we delete the loop, the msg variable and replace it all with either the <b>% * ph</b> specifier with the transmitted length i, or the print_hex_bytes () call. <br><br>  Please note further on the code there is a similar, it is possible for the company and to optimize it: lines 1192-1202. <br></div></div><br><br><a name="ExistsConstants"></a><br><h3>  <font color="blue">Defining existing constants and data types</font> </h3><br><br>  Returning to the unisys driver, run the following command: <br><pre> <code class="bash hljs">$ git grep -n MAX_MACADDR_LEN drivers/staging/unisys/ drivers/staging/unisys/common-spar/include/channels/iochannel.h:190:<span class="hljs-comment"><span class="hljs-comment">#ifndef MAX_MACADDR_LEN drivers/staging/unisys/common-spar/include/channels/iochannel.h:191:#define MAX_MACADDR_LEN 6 /* number of bytes‚Ä¶ drivers/staging/unisys/common-spar/include/channels/iochannel.h:192:#endif ‚Ä¶  ‚Ä¶</span></span></code> </pre><br><br>  However, it is worth noting that the MAC address length constant has long been defined in the kernel as ETH_ALEN.  I'm sure the maintainers will gladly accept a patch from you, replacing their definition with a standard nuclear one. <br><br><a name="Example1"></a><br><h3>  <font color="blue">Correction example</font> </h3><br><br>  We proceed smoothly to practice.  <a href="https://habr.com/ru/post/253123/">Above,</a> we found a place where when outputting several bytes, the transmission of each of them through the stack is used. <br><br>  If we look at the code, we will see the following: <br><pre> <code class="cpp hljs">str_pos += scnprintf(vbuf + str_pos, len - str_pos, <span class="hljs-string"><span class="hljs-string">"[%d:%d] VNic:%02x:%02x:%02x:%02x:%02x:%02x num_rcv_bufs:%d mtu:%d"</span></span>, tmpvpcidev-&gt;bus_no, tmpvpcidev-&gt;device_no, tmpvpcidev-&gt;net.mac_addr[<span class="hljs-number"><span class="hljs-number">0</span></span>], tmpvpcidev-&gt;net.mac_addr[<span class="hljs-number"><span class="hljs-number">1</span></span>], tmpvpcidev-&gt;net.mac_addr[<span class="hljs-number"><span class="hljs-number">2</span></span>], tmpvpcidev-&gt;net.mac_addr[<span class="hljs-number"><span class="hljs-number">3</span></span>], tmpvpcidev-&gt;net.mac_addr[<span class="hljs-number"><span class="hljs-number">4</span></span>], tmpvpcidev-&gt;net.mac_addr[<span class="hljs-number"><span class="hljs-number">5</span></span>], tmpvpcidev-&gt;net.num_rcv_bufs, tmpvpcidev-&gt;net.mtu);</code> </pre><br>  And it turns out that someone is displaying the MAC address!  Well, we can easily use a special qualifier extension - <b>% pM</b> . <br><br>  Let's replace and look at the result: <br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/drivers/staging/unisys/virtpci/virtpci.c +++ b/drivers/staging/unisys/virtpci/virtpci.c @@ -1310,15 +1310,10 @@ static ssize_t info_debugfs_read(struct file *file, char __user *buf, tmpvpcidev-&gt;scsi.max.cmd_per_lun); } else { str_pos += scnprintf(vbuf + str_pos, len - str_pos, - "[%d:%d] VNic:%02x:%02x:%02x:%02x:%02x:%02x num_rcv_bufs:%d mtu:%d", + "[%d:%d] VNic:%pM num_rcv_bufs:%d mtu:%d", tmpvpcidev-&gt;bus_no, tmpvpcidev-&gt;device_no, - tmpvpcidev-&gt;net.mac_addr[0], - tmpvpcidev-&gt;net.mac_addr[1], - tmpvpcidev-&gt;net.mac_addr[2], - tmpvpcidev-&gt;net.mac_addr[3], - tmpvpcidev-&gt;net.mac_addr[4], - tmpvpcidev-&gt;net.mac_addr[5], + tmpvpcidev-&gt;net.mac_addr, tmpvpcidev-&gt;net.num_rcv_bufs, tmpvpcidev-&gt;net.mtu); }</span></span></code> </pre><br>  It seems to be quite good - less by 5 lines and variables on the stack.  It is necessary to compile the result.  I will not describe in detail how this is done, I will only indicate that it will be necessary to enable the driver in the configuration using options: <br><blockquote>  CONFIG_STAGING = y <br>  CONFIG_UNISYSPAR = y <br>  CONFIG_UNISYS_VIRTPCI = m <br></blockquote><br>  Save our change to the tree with <code>git commit -a -s</code> and format it as a patch. <br><pre> <code class="bash hljs">$ git format-patch HEAD~1 0001-staging-unisys-print-MAC-address-via-pM.patch</code> </pre><br>  Next, we use the wonderful <code>get_maintainter.pl</code> script to find out who needs to be informed personally. <br><pre> <code class="bash hljs">$ scripts/get_maintainer.pl --git-min-percent=67 --nor --norolestats 00* Benjamin Romer &lt;benjamin.romer@unisys.com&gt; David Kershner &lt;david.kershner@unisys.com&gt; Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt; sparmaintainer@unisys.com devel@driverdev.osuosl.org linux-kernel@vger.kernel.org</code> </pre><br>  We send our patch to the addresses: <br><pre> <code class="bash hljs">$ git send-email --cc-cmd <span class="hljs-string"><span class="hljs-string">'scripts/get_maintainer.pl --git-min-percent=67 --nor --nol --norolestats'</span></span> 00* 0001-staging-unisys-print-MAC-address-via-pM.patch Who should the emails be sent to (<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> any)? devel@driverdev.osuosl.org, sparmaintainer@unisys.com Message-ID to be used as In-Reply-To <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the first email (<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> any)? ‚Ä¶ Send this email? ([y]es|[n]o|[q]uit|[a]ll): y</code> </pre><br>  Here is a <a href="http://driverdev.linuxdriverproject.org/pipermail/driverdev-devel/2015-March/066848.html">letter</a> . <br><br>  UPDATE: Already in the kernel: <a href="https://git.kernel.org/cgit/linux/kernel/git/gregkh/staging.git/commit/%3Fh%3Dstaging-next%26id%3D9a836c0a6310e6e970ff63d030d7213c874ae7af">9-836c0a6310e6e9</a> . </div><p>Source: <a href="https://habr.com/ru/post/253123/">https://habr.com/ru/post/253123/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253107/index.html">Yboard - Yii bulletin board engine</a></li>
<li><a href="../253111/index.html">Create effective styles for carousels</a></li>
<li><a href="../253115/index.html">Review of the most interesting materials on data analysis and machine learning ‚Ññ39 (March 9 - 15, 2015)</a></li>
<li><a href="../253119/index.html">Random and phantom domains (random subdomain, phantom domain), DDoS attack on caching DNS</a></li>
<li><a href="../253121/index.html">Beginner's HTTP caching headers guide</a></li>
<li><a href="../253125/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ151 (March 9 - 15, 2015)</a></li>
<li><a href="../253127/index.html">Experience using Freenet</a></li>
<li><a href="../253131/index.html">CSS Sans - a font written in CSS</a></li>
<li><a href="../253133/index.html">Perl 6 Lexical Variables</a></li>
<li><a href="../253135/index.html">PHP Digest number 58 - interesting news, materials and tools (February 22 - March 16, 2015)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>