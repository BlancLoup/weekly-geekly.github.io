<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How did we get access to the database of banned resources</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Welcome, habrasoobschestvu. 

 The most discussed news of the current week in RuNet, of course, is the adoption of Law No. 139-FZ and its consequences...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How did we get access to the database of banned resources</h1><div class="post__text post__text-html js-mediator-article">  Welcome, habrasoobschestvu. <br><br>  The most discussed news of the current week in RuNet, of course, is the adoption of Law No. 139-FZ and its consequences.  Due to the fact that <a href="http://www.netangels.ru/">our company</a> provides hosting services, we needed access to the full registry base in order to promptly respond to the addition of our customers' resources to the database.  This is due to the fact that we need to inform customers about the blocking of their resources, because in the case of, for example, blocking the web hosting server's ip, other clients may suffer as well or no fault.  Unfortunately, obtaining such access turned out to be not the most obvious, so we would like to share the result of this quest. <br><br><img src="https://habrastorage.org/storage2/d98/713/3f5/d987133f52b4e367795e6130834b5e7f.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the article we would like to focus on the technical aspect and avoid discussing the ethical-political side of the issue, because  any active user has already managed to express his dissatisfaction on this topic, regret the root-tracker with Lurkomoryem and think about the topic of circumventing the ban on resources earlier. <br><br><a name="habracut"></a><br>  Currently, access to a single registry of prohibited resources is assumed to be of two types: <br><br><ol><li>  For all Internet users in the form of a search on the <a href="http://zapret-info.gov.ru/">main page of the registry</a> .  Each request requires captcha, in addition, the form, in fact, solves the problem of obtaining information about locking a particular resource known in advance, because  if the site is banned by url, then entering into the form a domain name will not give any result.  Example: <s>ww.xapka.com</s> is empty, <s>http://www.xapka.com/</s> - information about blocking. </li><li>  In the form of a full dump of the database of prohibited resources in the section <a href="http://zapret-info.gov.ru/tooperators/">"communication operators"</a> .  It is possible to access either through a <a href="http://zapret-info.gov.ru/tooperators/form/">web form</a> with the need to enter a captcha, or through a SOAP-service.  WSDL address: <a href="http://www.zapret-info.gov.ru/services/OperatorRequest/%3Fwsdl">www.zapret-info.gov.ru/services/OperatorRequest/?wsdl</a> . </li></ol><br>  In the second case, each request for unloading the database must be signed with EDS, in the format PKCS # 7 and the unlinked signature must be sent along with the request.  Ideally, we imagined something like this: we buy EDS, take the Debian we are used to, put the appropriate software there to automatically sign requests, write a script that communicates with the zapret-info server via SOAP, generates a request, signs it, downloads a dump and a number of heuristics methods checks to see if any of the resources in the list apply to us. <br><br>  It would seem that everything is simple, but in fact it turned out to be somewhat more complicated and longer. <br><br><h3>  EDS </h3><br>  The zapret-info server does not provide any ‚Äúsandbox‚Äù in which it would be possible to test the work of the script without a valid EDS, so the very first thing is to take care of its acquisition. <br><br>  You can buy a certificate to create a qualified electronic signature in a <a href="http://www.reestr-pki.ru/tsl.html">trusted certification authority</a> .  By default, all CAs for signing documents suggest using programs from the CryptoPRO family (CryptoARM, cryptcp).  Unfortunately, using this variety of software products overshadows a few facts: <br><br><ul><li>  If the CryptoPRO license is part of the EDS package, then most likely it is intended for Windows. </li><li>  CryptoPRO itself does not know how to sign, and tools that can - require a separate license and purchase. </li><li>  There are still questions about licensing (whether we need a license for 1 workplace, or for 1 server). </li></ul><br>  Therefore, a quick search on the Internet brought us to the information that using simple actions with Rutoken, we can <a href="http://forum.rutoken.ru/topic/1639/">teach</a> us <a href="http://forum.rutoken.ru/topic/1639/">how to use</a> OpenSSL, which we are used to.  A brief brief of our actions is: <br><br><ol><li>  Export key in PKCS # 12 format from a cryptocontainer in Windows using the utility <a href="http://www.lissi-crypto.ru/products/utils/p12fromcsp/">P12FromGostCSP</a> </li><li>  Convert it to PEM </li><li>  Register parameters in the openssl.conf config <br>  At the very beginning, before the sections: <br><pre><code class="bash hljs">openssl_conf = openssl_def
</code></pre><br>
   :<br>
<pre><code class="bash hljs">[openssl_def]
engines=engine_section

[engine_section]
gost=gost_section

[gost_section]
engine_id=gost
default_algorithms=ALL
</code></pre></li>
<li> ,         :<br>
<pre><code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Test"</span></span> &gt; document.txt
$ openssl smime -sign -binary -signer ~/sign/gost.crt -inkey ~/sign/gost_nopass.key -outform PEM -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> document.txt -out document.txt.sign
</code></pre></li>
</ol><br>
    <a href="http://www.gosuslugi.ru/pgu/eds">  </a> ( ¬´,   PKCS#7¬ª).     ‚Äî   .<br>
<br>
<h3> </h3><br>
      ,   .    ,        : ¬´!      ¬ª.            :<br>
<br>
<ul>
<li>     XML-,   .</li>
<li> xml-  windows-1251.</li>
<li>XML declaration string     (..     ,      ,      ).</li>
</ul><br>
       .       SOAP sendRequest(),    base64      ,    <a href="http://zapret-info.gov.ru/tooperators/form/"> </a>.   ,         ( getResult(),      ).<br>
,            .      :<br>
<blockquote> !    (              <a href="http://www.zapret-info.gov.ru/tooperators/">www.zapret-info.gov.ru/tooperators</a>)<br>
</blockquote><br>
<br>
          : <a href="">support@rsoc.ru</a>,      ,              .           zip-,        .<br>
<br>
<h3></h3><br>
   ,        .    : <br>
1. ,     ;<br>
2.   ‚Äî  ,  ,  ;<br>
3.       ;<br>
4.    ‚Äî   ,          .<br>
<br>
<h4> :</h4><br>
<ul>
<li>     SOAP-   <a href="">suds</a></li>
<li>lxml.builder     xml declaration string,     xml   - :<br>
<pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime
<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dateutil.tz <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tzlocal
<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> lxml <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> etree
<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> lxml.builder <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> E

request_xml = E.request(
    E.requestTime(datetime.now(tzlocal()).isoformat()),
    E.operatorName(settings.NETANGELS_OPERATOR_NAME),
    E.inn(settings.NETANGELS_INN),
    E.ogrn(settings.NETANGELS_OGRN),
    E.email(settings.NETANGELS_EMAIL),
)
<span class="hljs-comment"><span class="hljs-comment">#         utf-8 :-(</span></span>
request_str = etree.tostring(request_xml, xml_declaration=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, encoding=<span class="hljs-string"><span class="hljs-string">'windows-1251'</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"'"</span></span>, <span class="hljs-string"><span class="hljs-string">'"'</span></span>)
</code></pre></li>
</ul><br>
<h3></h3><br>
<ul>
<li>  linux   : ¬´       ?¬ª             Windows :-)</li>
<li>       ,      .</li>
<li>       ¬´¬ª,       .</li>
<li> ,      ,      .</li>
</ul></div><p>Source: <a href="https://habr.com/ru/post/158891/">https://habr.com/ru/post/158891/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../158877/index.html">100 days of curiosity</a></li>
<li><a href="../158881/index.html">How can a wife help freelancers?</a></li>
<li><a href="../158885/index.html">WiFi: who is to blame: Windows 8 or Intel</a></li>
<li><a href="../158887/index.html">Overview and configuration of deduplication tools in Windows Server 2012</a></li>
<li><a href="../158889/index.html">For Linux came out Skype 4.1</a></li>
<li><a href="../158893/index.html">From cassettes to online streaming</a></li>
<li><a href="../158895/index.html">What each developer needs to know about character encodings and character sets for working with text, part 2</a></li>
<li><a href="../158897/index.html">Should I use freemium model? Part 2</a></li>
<li><a href="../158903/index.html">Support the Motorola petition for opening the bootloader</a></li>
<li><a href="../158905/index.html">Centralized exception handling in Node.JS. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>