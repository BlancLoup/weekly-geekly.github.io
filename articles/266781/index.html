<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Logging JDBC requests and their parameters in an existing application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this publication, we will look at how to incorporate logging of jdbc operations into an existing application without recompiling and recompiling it...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Logging JDBC requests and their parameters in an existing application</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/a29/9f4/f4f/a299f4f4fb244d12a5250481d050723f.png"><br><br>  In this publication, we will look at how to incorporate logging of jdbc operations into an existing application without recompiling and recompiling it.  This will make it possible to log the parameters of requests that the program fills, and many other aspects of working with jdbc. <br><a name="habracut"></a><br>  Well, if you have the opportunity to add <a href="https://github.com/arthurblake/log4jdbc">log4jdbc</a> to the assembly application. <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.googlecode.log4jdbc<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>log4jdbc<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  And use <b>net.sf.log4jdbc.DriverSpy</b> when creating a connection. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If this is not possible, aspectj-scripting will help you with logging jdbc operations. <br><br>  The experimental program remains the SonarQube, as in the articles about <a href="http://habrahabr.ru/post/264415/">hawt.io/h2</a> and <a href="http://habrahabr.ru/post/265741/">CRaSH-ssh</a> .  These articles discussed in more detail the configuration process and the principle of work of aspectj-scripting and provides step-by-step instructions. <br><br>  To log jdbc operations, change the parameters for running the jvm sonar: <br>  sonar.web.javaAdditionalOpts = -javaagent: <b>aspectj-scripting-1.0-agent.jar</b> -Dorg.aspectj.weaver.loadtime.configuration = config: file: <b>h2_jdbc.xml</b> <br><br>  It also requires the availability of the jvm <a href="">aspectj-scripting</a> agent and the h2_jdbc.xml configuration file: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">aspects</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>com.github.igorsuhorukov.JdbcLog<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span>AROUND<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pointcut</span></span></span><span class="hljs-tag">&gt;</span></span>execution(* org.apache.commons.dbcp.BasicDataSource.getConnection())<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pointcut</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">process</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">expression</span></span></span><span class="hljs-tag">&gt;</span></span> log4jdbcresultUrls = com.github.smreed.dropship.MavenClassLoader.forMavenCoordinates("com.googlecode.log4jdbc:log4jdbc:1.2").getURLs(); slf4jresultUrls = com.github.smreed.dropship.MavenClassLoader.forMavenCoordinates("org.slf4j:slf4j-simple:1.6.0").getURLs(); resultUrls = new java.net.URL[log4jdbcresultUrls.length + slf4jresultUrls.length]; System.arraycopy(log4jdbcresultUrls, 0, resultUrls, 0, log4jdbcresultUrls.length); System.arraycopy(slf4jresultUrls, 0, resultUrls, log4jdbcresultUrls.length, slf4jresultUrls.length); log4jdbcLoader = new java.net.URLClassLoader(resultUrls, Thread.currentThread().getContextClassLoader()); log4jdbcLoader.loadClass("net.sf.log4jdbc.ConnectionSpy"); currentLoader = java.lang.Thread.currentThread().getContextClassLoader(); java.lang.Thread.currentThread().setContextClassLoader(log4jdbcLoader); res = new net.sf.log4jdbc.ConnectionSpy(joinPoint.proceed()); java.lang.Thread.currentThread().setContextClassLoader(currentLoader); res; <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">expression</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">process</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">aspects</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  This aspect allows you to intercept the getConnection () call of the BasicDataSource class from the common-dbcp library and return the wrapper ConnectionSpy to connect to the database.  At the same time, classes from log4jdbc become available in the application by creating their own class loader from maven artifacts in the local repository.  aspectj-scripting loads artifacts com.googlecode.log4jdbc: log4jdbc: 1.2 and org.slf4j: slf4j-simple: 1.6.0 based on the configuration you specified above.  This works thanks to the fact that we passed two additional parameters at the start of jvm: " <b>-javaagent</b> " to start the aspectj-scripting agent and <b>-Dorg.aspectj.weaver.loadtime.configuration</b> to transfer configuration to it.  And the aspectj agent instruments the application classes when they are loaded. <br><br>  The following loggers are available in the log4jdbc library: <br><br><ul><li>  jdbc.sqlonly - Logs only SQL </li><li>  jdbc.sqltiming - Logs SQL and runtime </li><li>  jdbc.audit - Logs all JDBC API calls, except for working with ResultSet </li><li>  jdbc.resultset - All calls to the ResultSet are logged </li><li>  jdbc.connection - Opening and closing connections are logged, useful to find connections for leaks </li></ul><br>  Finally, here are some examples from the SonarQube logs, the web part of which is written in ruby ‚Äã‚Äãand runs in jruby: <br><br>  [jdbc.connection] 2. Connection <b>opened</b> <br>  [jdbc.connection] 81. Connection <b>closed</b> <br>  [jdbc.sqltiming] select * from schema_migrations <b>{executed in 4 msec}</b> <br>  [jdbc.audit] 7. PreparedStatement.  <b>setString (1, "sonar.core.id")</b> returned <br>  [jdbc.audit] 9. PreparedStatement <b>.setTimestamp (1, 2015-08-09 18: 49: 08.205)</b> returned <br>  [jdbc.audit] 9. PreparedStatement.  <b>setFetchSize (200)</b> returned <br>  [jdbc.audit] 14. Connection.  <b>prepareStatement</b> (update metrics set best_value = ?, delete_historical_data = ?, description = ?, direction = ?, domain = ?, enabled = ?, hidden = ?, short_name = ?, optimized_best_value = ?, origin = ?, qualitative = ?, val_type =?, user_managed =?, worst_value =? where id =?) returned net.sf.log4jdbc.PreparedStatementSpy@6e22c0e5 <br>  [jdbc.resultset] 2. ResultSet.  <b>getMetaData ()</b> returned <b>rsMeta0: columns = 1</b> <br>  [jdbc.resultset] 2. ResultSet.  <b>getType ()</b> returned <b>1003</b> <br>  [ <b>jdbc.sqlonly</b> ] select ar.id from analysis_reports ar where ar.report_status = 'PENDING' and not exists (select 1 from analysis_reports ar2 where ar.project_key = ar2.project_key and ar2.report_status = 'WORKING') created_at asc, ar.id asc <br><br>  An example, described in the article, you can see in the screencast: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/1GXmKTHl8l8%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhiJz2h8QxJYAC_NzB5hUMe8vBLnIQ" frameborder="0" allowfullscreen=""></iframe><br><br>  So, we were able to modify the jvm SonarQube configuration so that all the calls to the Jdbc API application with their parameters were recorded in its log file.  I hope this publication will be useful to you and you will find other ways to use aspect-oriented programming for existing java programs. </div><p>Source: <a href="https://habr.com/ru/post/266781/">https://habr.com/ru/post/266781/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266767/index.html">The digest of interesting materials for the mobile # 120 developer (September 7-13)</a></li>
<li><a href="../266773/index.html">MVVM nuances in Ext JS when developing components</a></li>
<li><a href="../266775/index.html">The most outdated infrastructure you can buy for money.</a></li>
<li><a href="../266777/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 176 (September 7 - 13, 2015)</a></li>
<li><a href="../266779/index.html">We write our own Bitcoin payment gateway</a></li>
<li><a href="../266783/index.html">About the habits of our users and technical support</a></li>
<li><a href="../266785/index.html">Unsolvable problems and lower bounds. Lecture by Alexander Shen in Yandex</a></li>
<li><a href="../266789/index.html">What is an antivirus for?</a></li>
<li><a href="../266791/index.html">HP Software Management and Monitoring Systems Overview</a></li>
<li><a href="../266795/index.html">RailsClub 2015: Interview with Vladimir Yartsev</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>