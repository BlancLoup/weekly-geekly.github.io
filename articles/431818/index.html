<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Compare PHP FPM, PHP PPM, Nginx Unit, React PHP and RoadRunner</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Testing was done using Yandex Tank. 
 Symfony 4 and PHP 7.2 were used as applications. 
 The goal was to compare the characteristics of services under...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Compare PHP FPM, PHP PPM, Nginx Unit, React PHP and RoadRunner</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/fk/hu/2y/fkhu2yx-ka6-lgomyrmgvgsqzvm.png"><br><br>  Testing was done using Yandex Tank. <br>  Symfony 4 and PHP 7.2 were used as applications. <br>  The goal was to compare the characteristics of services under different loads and find the best option. <br>  For convenience, everything is collected in docker-containers and lifted using docker-compose. <br>  There are a lot of tables and graphs under the cut. <a name="habracut"></a><br><p>  The source code is <a href="https://github.com/mrsuh/php-load-test">here</a> . <br>  All command examples described in the article should be executed from the project directory. </p><br><h2 id="prilozhenie">  application </h2><br><p>  The application runs on symfony 4 and php 7.2. </p><br><p>  It responds to only one route and returns: </p><br><ul><li>  random number; </li><li>  environment; </li><li>  pid of the process; </li><li>  the name of the service with which it works; </li><li>  php.ini variables. </li></ul><br><p>  Sample answer: </p><br><pre><code class="bash hljs">curl <span class="hljs-string"><span class="hljs-string">'http://127.0.0.1:8000/'</span></span> | python -m json.tool { <span class="hljs-string"><span class="hljs-string">"env"</span></span>: <span class="hljs-string"><span class="hljs-string">"prod"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"php-fpm"</span></span>, <span class="hljs-string"><span class="hljs-string">"pid"</span></span>: 8, <span class="hljs-string"><span class="hljs-string">"random_num"</span></span>: 37264, <span class="hljs-string"><span class="hljs-string">"php"</span></span>: { <span class="hljs-string"><span class="hljs-string">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"7.2.12"</span></span>, <span class="hljs-string"><span class="hljs-string">"date.timezone"</span></span>: <span class="hljs-string"><span class="hljs-string">"Europe/Paris"</span></span>, <span class="hljs-string"><span class="hljs-string">"display_errors"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"error_log"</span></span>: <span class="hljs-string"><span class="hljs-string">"/proc/self/fd/2"</span></span>, <span class="hljs-string"><span class="hljs-string">"error_reporting"</span></span>: <span class="hljs-string"><span class="hljs-string">"32767"</span></span>, <span class="hljs-string"><span class="hljs-string">"log_errors"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"memory_limit"</span></span>: <span class="hljs-string"><span class="hljs-string">"256M"</span></span>, <span class="hljs-string"><span class="hljs-string">"opcache.enable"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"opcache.max_accelerated_files"</span></span>: <span class="hljs-string"><span class="hljs-string">"20000"</span></span>, <span class="hljs-string"><span class="hljs-string">"opcache.memory_consumption"</span></span>: <span class="hljs-string"><span class="hljs-string">"256"</span></span>, <span class="hljs-string"><span class="hljs-string">"opcache.validate_timestamps"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"realpath_cache_size"</span></span>: <span class="hljs-string"><span class="hljs-string">"4096K"</span></span>, <span class="hljs-string"><span class="hljs-string">"realpath_cache_ttl"</span></span>: <span class="hljs-string"><span class="hljs-string">"600"</span></span>, <span class="hljs-string"><span class="hljs-string">"short_open_tag"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } }</code> </pre> <br><p>  PHP is configured in each container: </p><br><ul><li>  OPcache enabled; </li><li>  bootstrap cache is configured using composer; </li><li>  php.ini settings are in line with <a href="https://symfony.com/doc/current/performance.html">best symfony practices</a> . </li></ul><br><p>  Logs are written to stderr: <br>  /config/packages/prod/monolog.yaml </p><br><pre> <code class="plaintext hljs">monolog: handlers: main: type: stream path: "php://stderr" level: error console: type: console</code> </pre> <br><p>  The cache is written to / dev / shm: <br>  /src/Kernel.php </p><br><pre> <code class="php hljs">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Kernel</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseKernel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCacheDir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;environment === <span class="hljs-string"><span class="hljs-string">'prod'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'/dev/shm/symfony-app/cache/'</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;environment; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getProjectDir() . <span class="hljs-string"><span class="hljs-string">'/var/cache/'</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;environment; } } } ...</code> </pre> <br><p>  Each docker-compose runs three main containers: </p><br><ul><li>  Nginx - reverse proxy server; </li><li>  App - prepared application code with all dependencies; </li><li>  PHP FPM \ Nginx Unit \ Road Runner \ React PHP - application server. </li></ul><br><p>  Request processing is limited to two instances of the application (by the number of processor cores). </p><br><h2 id="servisy">  Services </h2><br><h3 id="php-fpmhttpphpnetmanualruinstallfpmphp">  <a href="http://php.net/manual/ru/install.fpm.php">PHP FPM</a> </h3><br><p>  PHP process manager.  Written in C. </p><br><p>  Pros: </p><br><ul><li>  no need to keep track of memory; </li><li>  No need to change anything in the app. </li></ul><br><p>  Minuses: </p><br><ul><li>  for each PHP request must initialize the variables. </li></ul><br><p>  The command to run the application with docker-compose: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> docker/php-fpm &amp;&amp; docker-compose up -d</code> </pre> <br><h3 id="php-ppmhttpsgithubcomphp-pmphp-pm">  <a href="https://github.com/php-pm/php-pm">PHP PPM</a> </h3><br><p>  PHP process manager.  Written in PHP. </p><br><p>  Pros: </p><br><ul><li>  initializes variables once and then uses them; </li><li>  There is no need to change anything in the application (there are ready-made modules for symfony / Laravel, Zend, CakePHP). </li></ul><br><p>  Minuses: </p><br><ul><li>  need to keep track of memory. </li></ul><br><p>  The command to run the application with docker-compose: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> docker/php-ppm &amp;&amp; docker-compose up -d</code> </pre> <br><h3 id="nginx-unithttpsunitnginxorg">  <a href="https://unit.nginx.org/">Nginx unit</a> </h3><br><p>  Application server from the Nginx team.  Written in C. </p><br><p>  Pros: </p><br><ul><li>  you can change the configuration of the HTTP API; </li><li>  You can run multiple instances of the same application at the same time with different configurations and language versions; </li><li>  no need to keep track of memory; </li><li>  No need to change anything in the app. </li></ul><br><p>  Minuses: </p><br><ul><li>  for each PHP request must initialize the variables. </li></ul><br><p>  To transfer environment variables from the nginx-unit configuration file, you need to fix php.ini: </p><br><pre> <code class="plaintext hljs">; Nginx Unit variables_order=E</code> </pre> <br><p>  The command to run the application with docker-compose: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> docker/nginx-unit &amp;&amp; docker-compose up -d</code> </pre> <br><h3 id="react-phphttpsreactphporg">  <a href="https://reactphp.org/">React PHP</a> </h3><br><p>  Library for event programming.  Written in PHP. </p><br><p>  Pros: </p><br><ul><li>  c using the library, you can write a server that will initialize the variables only once and continue to work with them. </li></ul><br><p>  Minuses: </p><br><ul><li>  you must write the code for the server; </li><li>  need to monitor the memory. </li></ul><br><p>  If you use the <strong>--reboot-kernel-after-request</strong> flag for the worker, the symfony Kernel will be reinitialized for each request.  With this approach, you do not need to monitor the memory. </p><br><div class="spoiler">  <b class="spoiler_title">Code worker</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env php &lt;?php use App\Kernel; use Symfony\Component\Debug\Debug; use Symfony\Component\HttpFoundation\Request; require __DIR__ . '/../config/bootstrap.php'; $env = $_SERVER['APP_ENV'] ?? $_ENV['APP_ENV'] ?? 'dev'; $debug = (bool)($_SERVER['APP_DEBUG'] ?? $_ENV['APP_DEBUG'] ?? ('prod' !== $env)); if ($debug) { umask(0000); Debug::enable(); } if ($trustedProxies = $_SERVER['TRUSTED_PROXIES'] ?? $_ENV['TRUSTED_PROXIES'] ?? false) { Request::setTrustedProxies(explode(',', $trustedProxies), Request::HEADER_X_FORWARDED_ALL ^ Request::HEADER_X_FORWARDED_HOST); } if ($trustedHosts = $_SERVER['TRUSTED_HOSTS'] ?? $_ENV['TRUSTED_HOSTS'] ?? false) { Request::setTrustedHosts(explode(',', $trustedHosts)); } $loop = React\EventLoop\Factory::create(); $kernel = new Kernel($env, $debug); $kernel-&gt;boot(); $rebootKernelAfterRequest = in_array('--reboot-kernel-after-request', $argv); /** @var \Psr\Log\LoggerInterface $logger */ $logger = $kernel-&gt;getContainer()-&gt;get('logger'); $server = new React\Http\Server(function (Psr\Http\Message\ServerRequestInterface $request) use ($kernel, $logger, $rebootKernelAfterRequest) { $method = $request-&gt;getMethod(); $headers = $request-&gt;getHeaders(); $content = $request-&gt;getBody(); $post = []; if (in_array(strtoupper($method), ['POST', 'PUT', 'DELETE', 'PATCH']) &amp;&amp; isset($headers['Content-Type']) &amp;&amp; (0 === strpos($headers['Content-Type'], 'application/x-www-form-urlencoded')) ) { parse_str($content, $post); } $sfRequest = new Symfony\Component\HttpFoundation\Request( $request-&gt;getQueryParams(), $post, [], $request-&gt;getCookieParams(), $request-&gt;getUploadedFiles(), [], $content ); $sfRequest-&gt;setMethod($method); $sfRequest-&gt;headers-&gt;replace($headers); $sfRequest-&gt;server-&gt;set('REQUEST_URI', $request-&gt;getUri()); if (isset($headers['Host'])) { $sfRequest-&gt;server-&gt;set('SERVER_NAME', current($headers['Host'])); } try { $sfResponse = $kernel-&gt;handle($sfRequest); } catch (\Exception $e) { $logger-&gt;error('Internal server error', ['error' =&gt; $e-&gt;getMessage(), 'trace' =&gt; $e-&gt;getTraceAsString()]); $sfResponse = new \Symfony\Component\HttpFoundation\Response('Internal server error', 500); } catch (\Throwable $e) { $logger-&gt;error('Internal server error', ['error' =&gt; $e-&gt;getMessage(), 'trace' =&gt; $e-&gt;getTraceAsString()]); $sfResponse = new \Symfony\Component\HttpFoundation\Response('Internal server error', 500); } $kernel-&gt;terminate($sfRequest, $sfResponse); if ($rebootKernelAfterRequest) { $kernel-&gt;reboot(null); } return new React\Http\Response( $sfResponse-&gt;getStatusCode(), $sfResponse-&gt;headers-&gt;all(), $sfResponse-&gt;getContent() ); }); $server-&gt;on('error', function (\Exception $e) use ($logger) { $logger-&gt;error('Internal server error', ['error' =&gt; $e-&gt;getMessage(), 'trace' =&gt; $e-&gt;getTraceAsString()]); }); $socket = new React\Socket\Server('tcp://0.0.0.0:9000', $loop); $server-&gt;listen($socket); $logger-&gt;info('Server running', ['addr' =&gt; 'tcp://0.0.0.0:9000']); $loop-&gt;run();</span></span></code> </pre> </div></div><br><p>  The command to run the application with docker-compose: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> docker/react-php &amp;&amp; docker-compose up -d --scale php=2</code> </pre> <br><h3 id="road-runnerhttpsgithubcomspiralroadrunnerwikiabout-roadrunner">  <a href="https://github.com/spiral/roadrunner/wiki/About-RoadRunner">Road runner</a> </h3><br><p>  Web server and PHP process manager.  Written in Golang. </p><br><p>  Pros: </p><br><ul><li>  You can write a worker who will initialize the variables only once and continue to work with them. </li></ul><br><p>  Minuses: </p><br><ul><li>  it is necessary to write the code for the worker; </li><li>  need to monitor the memory. </li></ul><br><p>  If you use the <strong>--reboot-kernel-after-request</strong> flag for the worker, the symfony Kernel will be reinitialized for each request.  With this approach, you do not need to monitor the memory. </p><br><div class="spoiler">  <b class="spoiler_title">Code worker</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env php &lt;?php use App\Kernel; use Spiral\Goridge\SocketRelay; use Spiral\RoadRunner\PSR7Client; use Spiral\RoadRunner\Worker; use Symfony\Bridge\PsrHttpMessage\Factory\DiactorosFactory; use Symfony\Bridge\PsrHttpMessage\Factory\HttpFoundationFactory; use Symfony\Component\Debug\Debug; use Symfony\Component\HttpFoundation\Request; require __DIR__ . '/../config/bootstrap.php'; $env = $_SERVER['APP_ENV'] ?? $_ENV['APP_ENV'] ?? 'dev'; $debug = (bool)($_SERVER['APP_DEBUG'] ?? $_ENV['APP_DEBUG'] ?? ('prod' !== $env)); if ($debug) { umask(0000); Debug::enable(); } if ($trustedProxies = $_SERVER['TRUSTED_PROXIES'] ?? $_ENV['TRUSTED_PROXIES'] ?? false) { Request::setTrustedProxies(explode(',', $trustedProxies), Request::HEADER_X_FORWARDED_ALL ^ Request::HEADER_X_FORWARDED_HOST); } if ($trustedHosts = $_SERVER['TRUSTED_HOSTS'] ?? $_ENV['TRUSTED_HOSTS'] ?? false) { Request::setTrustedHosts(explode(',', $trustedHosts)); } $kernel = new Kernel($env, $debug); $kernel-&gt;boot(); $rebootKernelAfterRequest = in_array('--reboot-kernel-after-request', $argv); $relay = new SocketRelay('/tmp/road-runner.sock', null, SocketRelay::SOCK_UNIX); $psr7 = new PSR7Client(new Worker($relay)); $httpFoundationFactory = new HttpFoundationFactory(); $diactorosFactory = new DiactorosFactory(); while ($req = $psr7-&gt;acceptRequest()) { try { $request = $httpFoundationFactory-&gt;createRequest($req); $response = $kernel-&gt;handle($request); $psr7-&gt;respond($diactorosFactory-&gt;createResponse($response)); $kernel-&gt;terminate($request, $response); if($rebootKernelAfterRequest) { $kernel-&gt;reboot(null); } } catch (\Throwable $e) { $psr7-&gt;getWorker()-&gt;error((string)$e); } }</span></span></code> </pre> </div></div><br><p>  The command to run the application with docker-compose: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> docker/road-runner &amp;&amp; docker-compose up -d</code> </pre> <br><h2 id="testirovanie">  Testing </h2><br><p>  Testing was done using Yandex Tank. <br>  The application and Yandex Tank were on different virtual servers. </p><br><p>  Characteristics of the virtual server with the application: <br>  <strong>Virtualization</strong> : KVM <br>  <strong>CPU</strong> : 2 cores <br>  <strong>RAM</strong> : 4096 MB <br>  <strong>SSD</strong> : 50 GB <br>  <strong>Connection</strong> : 100MBit <br>  <strong>OS</strong> : CentOS 7 (64x) </p><br><p>  Tested services: </p><br><ul><li>  php-fpm </li><li>  php-ppm </li><li>  nginx unit </li><li>  road-runner </li><li>  road-runner-reboot (with the <strong>--reboot-kernel-after-request</strong> flag) </li><li>  react-php </li><li>  react-php-reboot (with the <strong>--reboot-kernel-after-request</strong> flag) </li></ul><br><p>  Php-fpm-80 service added for 1000/1000 rps tests <br>  For it, the php-fpm configuration was used: </p><br><pre> <code class="plaintext hljs">pm = dynamic pm.max_children = 80</code> </pre> <br><p>  Yandex Tank determines in advance how many times he needs to shoot at the target, and does not stop until the ammo runs out.  Depending on the speed of the service response, the test time may be longer than specified in the test configuration.  Because of this, the graphics of different services may have different lengths.  The slower the service responds, the longer its schedule will be. </p><br><p>  For each service and configuration Yandex Tank was conducted only one test.  Because of this, the numbers may be inaccurate.  It was important to evaluate the characteristics of the services relative to each other. </p><br><h2 id="100-rps">  100 rps </h2><br><h3 id="konfiguraciya-phantom-yandex-tank">  Phantom Yandex Tank configuration </h3><br><pre> <code class="plaintext hljs">phantom: load_profile: load_type: rps schedule: line(1, 100, 60s) const(100, 540s)</code> </pre> <br><h3 id="ssylki-s-detalnym-otchetom">  Links with a detailed report </h3><br><ul><li>  php-fpm <a href="https://overload.yandex.net/150666">https://overload.yandex.net/150666</a> </li><li>  php-ppm <a href="https://overload.yandex.net/150670">https://overload.yandex.net/150670</a> </li><li>  nginx-unit <a href="https://overload.yandex.net/150675">https://overload.yandex.net/150675</a> </li><li>  road-runner <a href="https://overload.yandex.net/150681">https://overload.yandex.net/150681</a> </li><li>  road-runner-reboot <a href="https://overload.yandex.net/151961">https://overload.yandex.net/151961</a> </li><li>  react-php <a href="https://overload.yandex.net/150697">https://overload.yandex.net/150697</a> </li><li>  react-php-reboot <a href="https://overload.yandex.net/152063">https://overload.yandex.net/152063</a> </li></ul><br><h3 id="percentili-vremeni-otveta">  Percentile response time </h3><br><table><thead><tr><th></th><th>  95% (ms) </th><th>  90% (ms) </th><th>  80% (ms) </th><th>  50% (ms) </th><th>  HTTP OK (%) </th><th>  HTTP OK (count) </th></tr></thead><tbody><tr><td>  php-fpm </td><td>  9.9 </td><td>  6.3 </td><td>  4.35 </td><td>  3.59 </td><td>  100 </td><td>  57030 </td></tr><tr><td>  php-ppm </td><td>  9.4 </td><td>  6 </td><td>  3.88 </td><td>  3.16 </td><td>  100 </td><td>  57030 </td></tr><tr><td>  nginx unit </td><td>  eleven </td><td>  6.6 </td><td>  4.43 </td><td>  3.69 </td><td>  100 </td><td>  57030 </td></tr><tr><td>  road-runner </td><td>  8.1 </td><td>  5.1 </td><td>  3.53 </td><td>  2.92 </td><td>  100 </td><td>  57030 </td></tr><tr><td>  road-runner-reboot </td><td>  12 </td><td>  8.6 </td><td>  5.3 </td><td>  3.85 </td><td>  100 </td><td>  57030 </td></tr><tr><td>  react-php </td><td>  8.5 </td><td>  4.91 </td><td>  3.29 </td><td>  2.74 </td><td>  100 </td><td>  57030 </td></tr><tr><td>  react-php-reboot </td><td>  13 </td><td>  8.5 </td><td>  5.5 </td><td>  3.95 </td><td>  100 </td><td>  57030 </td></tr></tbody></table><br><h3 id="monitoring">  Monitoring </h3><br><table><thead><tr><th></th><th>  cpu median (%) </th><th>  cpu max (%) </th><th>  memory median (MB) </th><th>  memory max (MB) </th></tr></thead><tbody><tr><td>  php-fpm </td><td>  9.15 </td><td>  12.58 </td><td>  880.32 </td><td>  907.97 </td></tr><tr><td>  php-ppm </td><td>  7.08 </td><td>  13.68 </td><td>  901.72 </td><td>  913.80 </td></tr><tr><td>  nginx unit </td><td>  9.56 </td><td>  12.54 </td><td>  923.02 </td><td>  943.90 </td></tr><tr><td>  road-runner </td><td>  5.57 </td><td>  8.61 </td><td>  992.71 </td><td>  1,001.46 </td></tr><tr><td>  road-runner-reboot </td><td>  9.18 </td><td>  12.67 </td><td>  848.43 </td><td>  870.26 </td></tr><tr><td>  react-php </td><td>  4.53 </td><td>  6.58 </td><td>  1,004.68 </td><td>  1,009.91 </td></tr><tr><td>  react-php-reboot </td><td>  9.61 </td><td>  12.67 </td><td>  885.92 </td><td>  892.52 </td></tr></tbody></table><br><h3 id="grafiki">  Charts </h3><br><img src="https://habrastorage.org/webt/ok/9u/py/ok9upykku7x_gy7gal5dq1yfa2m.png"><br><p>  Graph 1.1 Average response time per second </p><br><img src="https://habrastorage.org/webt/an/_b/z8/an_bz8p8tg8dmac-k9brr6lergc.png"><br><p>  Chart 1.2 Average processor load per second </p><br><img src="https://habrastorage.org/webt/lx/61/xa/lx61xaarcbvpauk4gzkhfxjk9gm.png"><br><p>  Chart 1.3 Average Memory Consumption Per Second </p><br><h2 id="500-rps">  500 rps </h2><br><h3 id="konfiguraciya-phantom-yandex-tank-1">  Phantom Yandex Tank configuration </h3><br><pre> <code class="plaintext hljs">phantom: load_profile: load_type: rps schedule: line(1, 500, 60s) const(500, 540s)</code> </pre> <br><h3 id="ssylki-s-detalnym-otchetom-1">  Links with a detailed report </h3><br><ul><li>  php-fpm <a href="https://overload.yandex.net/150705">https://overload.yandex.net/150705</a> </li><li>  php-ppm <a href="https://overload.yandex.net/150710">https://overload.yandex.net/150710</a> </li><li>  nginx-unit <a href="https://overload.yandex.net/150711">https://overload.yandex.net/150711</a> </li><li>  road-runner <a href="https://overload.yandex.net/150715">https://overload.yandex.net/150715</a> </li><li>  road-runner-reboot <a href="https://overload.yandex.net/152011">https://overload.yandex.net/152011</a> </li><li>  react-php <a href="https://overload.yandex.net/150717">https://overload.yandex.net/150717</a> </li><li>  react-php-reboot <a href="https://overload.yandex.net/152064">https://overload.yandex.net/152064</a> </li></ul><br><h3 id="percentili-vremeni-otveta-1">  Percentile response time </h3><br><table><thead><tr><th></th><th>  95% (ms) </th><th>  90% (ms) </th><th>  80% (ms) </th><th>  50% (ms) </th><th>  HTTP OK (%) </th><th>  HTTP OK (count) </th></tr></thead><tbody><tr><td>  php-fpm </td><td>  13 </td><td>  8.4 </td><td>  5.3 </td><td>  3.69 </td><td>  100 </td><td>  285030 </td></tr><tr><td>  php-ppm </td><td>  15 </td><td>  9 </td><td>  4.72 </td><td>  3.24 </td><td>  100 </td><td>  285030 </td></tr><tr><td>  nginx unit </td><td>  12 </td><td>  eight </td><td>  5.5 </td><td>  3.93 </td><td>  100 </td><td>  285030 </td></tr><tr><td>  road-runner </td><td>  9.6 </td><td>  6 </td><td>  3.71 </td><td>  2.83 </td><td>  100 </td><td>  285030 </td></tr><tr><td>  road-runner-reboot </td><td>  14 </td><td>  eleven </td><td>  7.1 </td><td>  4.45 </td><td>  100 </td><td>  285030 </td></tr><tr><td>  react-php </td><td>  9.3 </td><td>  5.8 </td><td>  3.57 </td><td>  2.68 </td><td>  100 </td><td>  285030 </td></tr><tr><td>  react-php-reboot </td><td>  15 </td><td>  12 </td><td>  7.2 </td><td>  4.21 </td><td>  100 </td><td>  285030 </td></tr></tbody></table><br><h3 id="monitoring-1">  Monitoring </h3><br><table><thead><tr><th></th><th>  cpu median (%) </th><th>  cpu max (%) </th><th>  memory median (MB) </th><th>  memory max (MB) </th></tr></thead><tbody><tr><td>  php-fpm </td><td>  41.68 </td><td>  48.33 </td><td>  1,006.06 </td><td>  1,015.09 </td></tr><tr><td>  php-ppm </td><td>  33.90 </td><td>  48.90 </td><td>  1,046.32 </td><td>  1,055.00 </td></tr><tr><td>  nginx unit </td><td>  42.13 </td><td>  47.92 </td><td>  1,006.67 </td><td>  1,015.73 </td></tr><tr><td>  road-runner </td><td>  24.08 </td><td>  28.06 </td><td>  1,035.86 </td><td>  1,044.58 </td></tr><tr><td>  road-runner-reboot </td><td>  46.23 </td><td>  52.04 </td><td>  939.63 </td><td>  948.08 </td></tr><tr><td>  react-php </td><td>  19.57 </td><td>  23.42 </td><td>  1,049.83 </td><td>  1,060.26 </td></tr><tr><td>  react-php-reboot </td><td>  41.30 </td><td>  47.89 </td><td>  957.01 </td><td>  958.56 </td></tr></tbody></table><br><h3 id="grafiki-1">  Charts </h3><br><img src="https://habrastorage.org/webt/c-/_1/4t/c-_14taximv1ifxdlpalgybfyyq.png"><br><p>  Graph 2.1 Average response time per second </p><br><img src="https://habrastorage.org/webt/g4/ql/9s/g4ql9sqqt3sf9tvtivr0pc1g0ne.png"><br><p>  Graph 2.2 Average CPU load per second </p><br><img src="https://habrastorage.org/webt/rd/b1/30/rdb1300ij_nmcntsalodw-j5pca.png"><br><p>  Graph 2.3 Average Memory Consumption Per Second </p><br><h2 id="1000-rps">  1000 rps </h2><br><h3 id="konfiguraciya-phantom-yandex-tank-2">  Phantom Yandex Tank configuration </h3><br><pre> <code class="plaintext hljs">phantom: load_profile: load_type: rps schedule: line(1, 1000, 60s) const(1000, 60s)</code> </pre> <br><h3 id="ssylki-s-detalnym-otchetom-2">  Links with a detailed report </h3><br><ul><li>  php-fpm <a href="https://overload.yandex.net/150841">https://overload.yandex.net/150841</a> </li><li>  php-fpm-80 <a href="https://overload.yandex.net/153612">https://overload.yandex.net/153612</a> </li><li>  php-ppm <a href="https://overload.yandex.net/150842">https://overload.yandex.net/150842</a> </li><li>  nginx-unit <a href="https://overload.yandex.net/150843">https://overload.yandex.net/150843</a> </li><li>  road-runner <a href="https://overload.yandex.net/150844">https://overload.yandex.net/150844</a> </li><li>  road-runner-reboot <a href="https://overload.yandex.net/152068">https://overload.yandex.net/152068</a> </li><li>  react-php <a href="https://overload.yandex.net/150846">https://overload.yandex.net/150846</a> </li><li>  react-php-reboot <a href="https://overload.yandex.net/152065">https://overload.yandex.net/152065</a> </li></ul><br><h3 id="percentili-vremeni-otveta-2">  Percentile response time </h3><br><table><thead><tr><th></th><th>  95% (ms) </th><th>  90% (ms) </th><th>  80% (ms) </th><th>  50% (ms) </th><th>  HTTP OK (%) </th><th>  HTTP OK (count) </th></tr></thead><tbody><tr><td>  php-fpm </td><td>  11050 </td><td>  11050 </td><td>  9040 </td><td>  195 </td><td>  80.67 </td><td>  72627 </td></tr><tr><td>  php-fpm-80 </td><td>  3150 </td><td>  1375 </td><td>  1165 </td><td>  152 </td><td>  99.85 </td><td>  89895 </td></tr><tr><td>  php-ppm </td><td>  2785 </td><td>  2740 </td><td>  2685 </td><td>  2545 </td><td>  100 </td><td>  90030 </td></tr><tr><td>  nginx unit </td><td>  98 </td><td>  80 </td><td>  60 </td><td>  21 </td><td>  100 </td><td>  90030 </td></tr><tr><td>  road-runner </td><td>  27 </td><td>  15 </td><td>  7.1 </td><td>  3.21 </td><td>  100 </td><td>  90030 </td></tr><tr><td>  road-runner-reboot </td><td>  1110 </td><td>  1100 </td><td>  1085 </td><td>  1060 </td><td>  100 </td><td>  90030 </td></tr><tr><td>  react-php </td><td>  23 </td><td>  13 </td><td>  5.6 </td><td>  2.86 </td><td>  100 </td><td>  90030 </td></tr><tr><td>  react-php-reboot </td><td>  28 </td><td>  24 </td><td>  nineteen </td><td>  eleven </td><td>  100 </td><td>  90030 </td></tr></tbody></table><br><h3 id="monitoring-2">  Monitoring </h3><br><table><thead><tr><th></th><th>  cpu median (%) </th><th>  cpu max (%) </th><th>  memory median (MB) </th><th>  memory max (MB) </th></tr></thead><tbody><tr><td>  php-fpm </td><td>  12.66 </td><td>  78.25 </td><td>  990.16 </td><td>  1,006.56 </td></tr><tr><td>  php-fpm-80 </td><td>  83.78 </td><td>  91.28 </td><td>  746.01 </td><td>  937.24 </td></tr><tr><td>  php-ppm </td><td>  66.16 </td><td>  91.20 </td><td>  1,088.74 </td><td>  1,102.92 </td></tr><tr><td>  nginx unit </td><td>  78.11 </td><td>  88.77 </td><td>  1,010.15 </td><td>  1,062.01 </td></tr><tr><td>  road-runner </td><td>  42.93 </td><td>  54.23 </td><td>  1,010.89 </td><td>  1,068.48 </td></tr><tr><td>  road-runner-reboot </td><td>  77.64 </td><td>  85.66 </td><td>  976.44 </td><td>  1,044.05 </td></tr><tr><td>  react-php </td><td>  36.39 </td><td>  46.31 </td><td>  1,018.03 </td><td>  1,088.23 </td></tr><tr><td>  react-php-reboot </td><td>  72.11 </td><td>  81.81 </td><td>  911.28 </td><td>  961.62 </td></tr></tbody></table><br><h3 id="grafiki-2">  Charts </h3><br><img src="https://habrastorage.org/webt/dg/jj/aa/dgjjaai8hatos_bdzj7eb0adnqm.png"><br><p>  Graph 3.1 Average response time per second </p><br><img src="https://habrastorage.org/webt/7x/2v/g4/7x2vg4kue4ufutvkuujkdqzn73y.png"><br><p>  Graph 3.2 Average response time per second (without php-fpm, php-ppm, road-runner-reboot) </p><br><img src="https://habrastorage.org/webt/nb/xv/ob/nbxvobvhcq07zhrcpbg_y6z_boc.png"><br><p>  Chart 3.3 Average processor load per second </p><br><img src="https://habrastorage.org/webt/to/hm/bn/tohmbnpfhofpgl8wfqvyrw6pcog.png"><br><p>  Graph 3.4 Average memory consumption per second </p><br><h2 id="10000-rps">  10,000 rps </h2><br><h3 id="konfiguraciya-phantom-yandex-tank-3">  Phantom Yandex Tank configuration </h3><br><pre> <code class="plaintext hljs">phantom: load_profile: load_type: rps schedule: line(1, 10000, 30s) const(10000, 30s)</code> </pre> <br><h3 id="ssylki-s-detalnym-otchetom-3">  Links with a detailed report </h3><br><ul><li>  php-fpm <a href="https://overload.yandex.net/150849">https://overload.yandex.net/150849</a> </li><li>  php-fpm-80 <a href="https://overload.yandex.net/153615">https://overload.yandex.net/153615</a> </li><li>  php-ppm <a href="https://overload.yandex.net/150874">https://overload.yandex.net/150874</a> </li><li>  nginx-unit <a href="https://overload.yandex.net/150876">https://overload.yandex.net/150876</a> </li><li>  road-runner <a href="https://overload.yandex.net/150881">https://overload.yandex.net/150881</a> </li><li>  road-runner-reboot <a href="https://overload.yandex.net/152069">https://overload.yandex.net/152069</a> </li><li>  react-php <a href="https://overload.yandex.net/150885">https://overload.yandex.net/150885</a> </li><li>  react-php-reboot <a href="https://overload.yandex.net/152066">https://overload.yandex.net/152066</a> </li></ul><br><h3 id="percentili-vremeni-otveta-3">  Percentile response time </h3><br><table><thead><tr><th></th><th>  95% (ms) </th><th>  90% (ms) </th><th>  80% (ms) </th><th>  50% (ms) </th><th>  HTTP OK (%) </th><th>  HTTP OK (count) </th></tr></thead><tbody><tr><td>  php-fpm </td><td>  11050 </td><td>  11050 </td><td>  11050 </td><td>  1880 </td><td>  70.466 </td><td>  317107 </td></tr><tr><td>  php-fpm-80 </td><td>  3260 </td><td>  3140 </td><td>  1360 </td><td>  1145 </td><td>  99.619 </td><td>  448301 </td></tr><tr><td>  php-ppm </td><td>  2755 </td><td>  2730 </td><td>  2695 </td><td>  2605 </td><td>  100 </td><td>  450015 </td></tr><tr><td>  nginx unit </td><td>  1020 </td><td>  1010 </td><td>  1000 </td><td>  980 </td><td>  100 </td><td>  450015 </td></tr><tr><td>  road-runner </td><td>  640 </td><td>  630 </td><td>  615 </td><td>  580 </td><td>  100 </td><td>  450015 </td></tr><tr><td>  road-runner-reboot </td><td>  1130 </td><td>  1120 </td><td>  1110 </td><td>  1085 </td><td>  100 </td><td>  450015 </td></tr><tr><td>  react-php </td><td>  1890 </td><td>  1090 </td><td>  1045 </td><td>  58 </td><td>  99.996 </td><td>  449996 </td></tr><tr><td>  react-php-reboot </td><td>  3480 </td><td>  3070 </td><td>  1255 </td><td>  91 </td><td>  99.72 </td><td>  448753 </td></tr></tbody></table><br><h3 id="monitoring-3">  Monitoring </h3><br><table><thead><tr><th></th><th>  cpu median (%) </th><th>  cpu max (%) </th><th>  memory median (MB) </th><th>  memory max (MB) </th></tr></thead><tbody><tr><td>  php-fpm </td><td>  5.57 </td><td>  79.35 </td><td>  984.47 </td><td>  998.78 </td></tr><tr><td>  php-fpm-80 </td><td>  85.05 </td><td>  92.19 </td><td>  936.64 </td><td>  943.93 </td></tr><tr><td>  php-ppm </td><td>  66.86 </td><td>  82.41 </td><td>  1,089.31 </td><td>  1,097.41 </td></tr><tr><td>  nginx unit </td><td>  86.14 </td><td>  93.94 </td><td>  1,067.71 </td><td>  1,069.52 </td></tr><tr><td>  road-runner </td><td>  73.41 </td><td>  82.72 </td><td>  1,129.48 </td><td>  1,134.00 </td></tr><tr><td>  road-runner-reboot </td><td>  80.32 </td><td>  86.29 </td><td>  982.69 </td><td>  984.80 </td></tr><tr><td>  react-php </td><td>  73.76 </td><td>  82.18 </td><td>  1,101.71 </td><td>  1,105.06 </td></tr><tr><td>  react-php-reboot </td><td>  85.77 </td><td>  91.92 </td><td>  975.85 </td><td>  978.42 </td></tr></tbody></table><br><img src="https://habrastorage.org/webt/xy/rs/s2/xyrss2tfxufvlvkf7gnw0_tcukw.png"><br><p>  Chart 4.1 Average response time per second </p><br><img src="https://habrastorage.org/webt/hk/je/sw/hkjeswjegk41myz-9e-jhh3y0_y.png"><br><p>  Graph 4.2 Average response time per second (without php-fpm, php-ppm) </p><br><img src="https://habrastorage.org/webt/cb/df/rx/cbdfrxtbgwtpkokjwbbgd2sjsxy.png"><br><p>  Chart 4.3 Average processor load per second </p><br><img src="https://habrastorage.org/webt/qf/qj/as/qfqjasvxfvy97bykrwckqguzwx0.png"><br><p>  Graph 4.4 Average memory consumption per second </p><br><h2 id="itogi">  Results </h2><br><p>  Here are collected graphs showing the change in the characteristics of services depending on the load.  When viewing charts it is worth considering that not all services answered 100% of requests. </p><br><img src="https://habrastorage.org/webt/uh/pc/vd/uhpcvdx0nczsku53ojpjvrikccu.png"><br><p>  Chart 5.1 95% response time percentile </p><br><img src="https://habrastorage.org/webt/va/oc/_u/vaoc_uj-wlybxghwhu_snmr7jkq.png"><br><p>  Graph 5.2 95% response percentile (without php-fpm) </p><br><img src="https://habrastorage.org/webt/bw/gu/xc/bwguxcwuo3w4j4_blvrr1-qlcdk.png"><br><p>  Chart 5.3 Maximum CPU Load </p><br><img src="https://habrastorage.org/webt/xh/r8/mx/xhr8mxqo3en9o-qv4zrbzayu1vs.png"><br><p>  Chart 5.4 Maximum Memory Consumption </p><br><p>  The best solution (without changing the code), in my opinion, is the Nginx Unit process manager.  He shows good results in speed of response and has the support of the company. </p><br><p>  In any case, the development approach and tools must be chosen individually, depending on your workload, server resources, and developer capabilities. </p><br><p>  <strong>UPD</strong> <br>  Php-fpm-80 service added for 1000/1000 rps tests <br>  For it, the php-fpm configuration was used: </p><br><pre> <code class="plaintext hljs">pm = dynamic pm.max_children = 80</code> </pre> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/431818/">https://habr.com/ru/post/431818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../431802/index.html">Problem personalities among project managers</a></li>
<li><a href="../431804/index.html">How to work with exceptions in DDD</a></li>
<li><a href="../431806/index.html">Palm Phone tested: the verdict - the developers have suffered a complete fiasco</a></li>
<li><a href="../431810/index.html">Test run with a three-axis accelerometer</a></li>
<li><a href="../431816/index.html">December 3, SpaceX will try to launch the first stage of the launch vehicle for the third time.</a></li>
<li><a href="../431820/index.html">Start to the ISS and braking at the asteroid</a></li>
<li><a href="../431822/index.html">De facto closed source: arguments in favor of understandable software</a></li>
<li><a href="../431824/index.html">On the website ‚ÄúM.Video‚Äù accidentally opened information on the smartphone from ‚ÄúYandex‚Äù a few days before the presentation.</a></li>
<li><a href="../431828/index.html">Digital events in Moscow from December 3 to 9</a></li>
<li><a href="../431830/index.html">Chromium Extension: Creation, Publication, Experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>