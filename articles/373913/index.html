<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Arduino! What's next? We make a bike computer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How it was 


 My father was fond of electronics. Home was a soldering iron, wires, a bunch of radio components. He easily repaired TVs, refrigerators...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Arduino! What's next? We make a bike computer</h1><div class="post__text post__text-html js-mediator-article"><h1>  How it was </h1><br><p>  My father was fond of electronics.  Home was a soldering iron, wires, a bunch of radio components.  He easily repaired TVs, refrigerators - as a hobby.  I was always there. </p><br><p>  When I was 10 years old, they gave me a radio designer, I think many had one. </p><br><p><img src="https://habrastorage.org/webt/59/e6/3f/59e63fac0d75b087214427.jpeg"><br><br></p><p>  I collected all the schemes on it, I liked how they worked.  I studied all the major radio components.  Then they bought a radio constructor - "radio in the case."  It was necessary to solder already, he, too, was soon ready and worked perfectly.  I continued to make small schemes.  Boards - varnish and glass tubes.  But then I got into programming.  I mastered C, then C ++.  At the end of the university, he began working as a programmer, which is what he is doing to this day. </p><br><h1>  Arduino </h1><br><p>  When my son grew up, I decided to teach him electronics too.  He took his old dusty designer and ... his son "threw out."  What is this trash, why do I need to squeak in different tones.  Some not interesting schemes.  I thought, and began to look, than it is possible to replace it.  Connoisseurs and other designers, were in general similar.  And here I stumbled upon the Arduino.  Here is what you need.  Electronics and programming in one bottle. </p><br><p><img src="https://habrastorage.org/webt/59/e6/3f/59e63fac34232366111093.jpeg"><br clear="left"></p><br><p>  We bought a board and started programming, and studying electronics.  Having done various tasks, having bought a bunch of sensors, the question arose of what to do next.  The son asked - and what can be really done on the Arduino?  We brainstormed and made a list of interesting, useful devices that would be interesting to do.  Began to think how we will do them.  The first was our bike computer. <a name="habracut"></a>  We just had bikes for the whole family, so they had to be equipped with a powerful computing center on the microcontroller.  We sketched the program in Arduino, the sensors - the buttons, everything worked fine.  It remains the case for small - to collect everything in a box and use. </p><br><p>  I wanted to teach my son how to solder, and to show that if you want, you can make a beautiful compact modern device yourself, and not buy it.  I had to remember the old skills.  How has everything changed ... </p><br><p>  My familiar output resistors have been replaced with SMD components.  Very complex boards could be made at home with a laser printer.  Schemes can be tested in simulators.  There is a lot of information on the Internet, schemes, courses on programming.  I began to understand all this. </p><br><h1>  Select the components for the bike computer scheme </h1><br><p>  Everything should be inexpensive.  If it burns, then it's not a pity.  This is the first device.  We looked at what is sold on the market.  As a rule, all cycling computers are mounted on the steering wheel, have a screen, are protected from rain, have one or two sensors (on the wheel and on the pedals).  They can calculate mileage, show current speed, cadence (number of revolutions of the pedals), travel time, calories burned and other indicators. </p><br><p>  Screen decided to exclude.  As a rule, they are either expensive (in the form of ready-made boards) or difficult to solder (for example, a cellular screen), and it complicates the program a lot.  We already had the practice of communicating with the bluetooth module.  He decided to take and replace the screen. </p><br><p><img src="https://habrastorage.org/webt/59/e6/3f/59e63fac42a2c925131923.jpeg"><br clear="left"></p><br><p>  The screen, as a result, will be a smartphone, but we will rarely look there, the device is autonomous, and the screen will be needed mainly to view the trip results or intermediate data.  The Bluetooth module allows you to program the instrument on the go, start metering, organize a competition - all this is easy. </p><br><p>  We decided to add a sound - a squeaker, so you can signal different events.  I really liked the idea that the cadence should be at least 80, and that's what we will squeak about.  As a tweeter - a speaker from a cell phone: </p><br><img src="https://habrastorage.org/webt/59/e6/3f/59e63fac4f2a7028436761.jpeg"><br><br><p>  The batteries are pretty tired, we decided to master the batteries.  We had a small battery from a children's helicopter - and we take it, then it turned out?  that such a hard to buy, changed to LIR2450. </p><br><p><img src="https://habrastorage.org/webt/59/e6/3f/59e63fac6d5f4711870938.png"><br clear="left"></p><br><p>  Choose a case.  Like this one from the company Gainta. </p><br><p><img src="https://habrastorage.org/webt/59/e6/3f/59e63fac70be6162429591.jpeg"><br clear="left"></p><br><p>  They have a very wide range of enclosures.  True, there is a minimum amount of purchase, bought immediately in advance, and other devices, too. </p><br><p>  The microcontroller is of course ATMEGA, as on the Arduino.  How much does it cost - more than 100 rubles in Moscow.  Strange, in China ready Arduino only 200r.  I decided to choose a replacement - Attiny, but she did not really like it.  I began to dig, and accidentally stumbled upon a series of stm8, stm8s003f3p only 20 rubles, despite the fact that there is a whole periphery.  Fine!  We will do on it.  True Wednesday is different, but there is C, who I knew.  Also, the advantage was the presence of a normal debugger, which is what the Arduino lacked! </p><br><p>  We select charging circuits li-ion.  Pretty quickly, I went to the chip TP4056 - 10p, although in China - we order a dozen - they will come in handy.  The overdischarge protection board is built into the battery - so it is not needed.  But in principle, the STM8 has a 3c switching threshold, so protection boards are not particularly needed. </p><br><p>  All - the scheme is ready, the components are selected.  I need a ST-link programmer, I bought it ready in Moscow, as it turned out later, it's expensive, but oh well.  Our first scheme: </p><br><p><img src="https://habrastorage.org/webt/59/e6/3f/59e63fac947f6608953477.jpeg"><br clear="left"></p><br><h1>  We make the board and everything is soldered, the device is ready </h1><br><p>  Made a fee.  LUT method did not work.  Found a new method - by cold transfer of toner, using acetone.  It turned out a great fee, though of course with small jambs, the method was then brought to the ideal.  We use so far.  The fee is ready.  We are waiting for chips from China (TP4056 is not realistic to buy from us).  Everything has arrived.  We begin to solder and see that when wiring the charging chip, we chose the wrong case, the names of SO8, MSOP8 are very similar!  But the board is ready, redoing laziness, in the second version we take into account!  We remove the charging function and do it on a separate board.  Wiring all closes as necessary. </p><br><p><img src="https://habrastorage.org/webt/59/e6/3f/59e63fac9b15e727214077.jpeg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </p><p>  Putting it all in the case - both mounting holes are not there.  All right it does not matter, we fasten upside down, and we beat with foam rubber.  Fasten the button - not attached.  Fill with hot melt - falls off.  As a result, we do this: </p><br><p><img src="https://habrastorage.org/webt/59/e6/3f/59e63facb0a3c061171677.jpeg"><br clear="left"></p><br><p>  For the future - it was better to make a button on the board right away!  We fasten the squeaker - a bunch of wires, everything gets in the way, but it works. </p><br><p><img src="https://habrastorage.org/webt/59/e6/3f/59e63facbf8d3524426130.jpeg"><br clear="left"></p><br><h1>  Go to the programming </h1><br><p>  To facilitate the work of the son, I had to hold a small lecture that instead of one function, you need to write another: </p><br><ul><li>  digitalWrite = GPIO_WriteHigh <br></li><li>  digitalRead = GPIO_ReadInputPin <br></li><li>  pinMode = GPIO_Init <br></li><li>  Delay - write yourself <br></li><li>  millis () - not needed, switched to a millisecond timer and interrupt, very convenient. <br></li></ul><br>  Began to write a program.  Timers, buttons, all through interrupts.  We wrote a test program and started testing.  The first line of code - turn on the bluetooth module.  And here we get the crisis of the "brain."  How much time is killed to solve the problem.  Turn on the bluetooth module and ... MK is overloaded.  What's wrong, everything works, the capacitors are in place, the module consumes 30 mA, but does not work.  After 2 weeks of painful checks, tests and various tips on the forums - the reason is found.  There are capacitors on the bluetooth module board, when the module is quickly turned on, they are charged, the power supply of the MK sags sharply and it overloads.  As a result, we limit the power line of the module through a resistor of 10 ohms (picked up by experience) - everything works fine.  It was more correct to feed the module from a separate LDO. <br><br><p>  The first test mini program is ready - food, we count the speed and give it to the phone.  Turn on - squeak barely audible.  It turned out the food is not 5v and therefore quiet.  Add on a separate mini shawl - trazistor - excellent - audible loud. </p><br><p><img src="https://habrastorage.org/webt/59/e6/3f/59e63facd2779563660035.jpeg"><br clear="left"></p><br><p>  We fasten to the bike, we plan to mount it on the steering wheel, solder long wires, make two sensors from the handle, fill it with hot melt.  We tried, and it turned out that it is easier to mount on the rear fork.  Wires collected and tied - not needed.  As a magnet - children's designer. </p><br><p><img src="https://habrastorage.org/webt/59/e6/3f/59e63facdc447358769353.jpeg"><br clear="left"></p><br><p>  So let's go.  Instead of one turn - thousands.  What kind of nonsense.  We understand, yeah, the bounce of contacts, set delays - it works fine.  Checking the speed is the same as the GPS on the phone.  We start to engage in energy savings.  The device must sleep for a very long time and work economically. </p><br><h1>  Energy saving. </h1><br><p>  The main goal, on one charge, the device should work for a very long time.  There is no switch, we will use sleep mode.  The device should turn itself on, external interrupts from the reed switch, turn itself off, if there is no movement for 2 minutes, then we turn off.  And most importantly, he must himself collect statistics on trips and keep it in memory.  Long thought how to determine what is one trip?  And they decided that if there was no movement for 3 hours, then the trip was over, and the bike was at home.  In order not to work for 3 hours in full mode, it was decided to use the sleep mode, with the auto-wake-up timer.  The timer can be started for a maximum of 30 seconds, so we wake up every 30 seconds, reduce the counter, and so on until 3 hours have passed.  How did it go - the trip is finished fix the data.  Debugging this algorithm was not easy, the compiler tried every time to prevent code optimization.  But in the end, everything turned out. </p><br><p>  According to the theoretical calculation, the device should sleep for more than a year, the MK in sleep mode is 4mk, if everything is turned off, fine.  We program sleep mode - we check.  Sleeps 3 weeks and the battery sits down.  Instead of 4, from where we have more than 200.  Again we check everything, and we see that LDO consumes 200 microns in the passive mode. !!!  Found  Need to change the scheme!  While testing further. </p><br><h1>  Additional functions </h1><br><p>  Unlike the bike computers on the market, they decided to add functionality.  Our device should be able to: </p><br><ul><li>  keep statistics for the last 4 trips, and store it all in non-volatile memory <br></li><li>  count calories only when pedaling <br></li><li>  count the active travel time when the speed was more than 4 km / h <br></li><li>  be able to control the speed and cadence, and in case of violation of the selected mode, notify with sound <br></li><li>  programmed via bluetooth: clearing memory, displaying information about past trips, setting parameters - weight, wheel diameter, speed control parameters <br></li><li>  take into account not the average speed, but the speed at which they traveled most of the time.  This is necessary, for example, for the case when you drive an hour, then rest for 30 minutes, then drive again, stand again for 5 minutes.  There has always been a different speed.  5 minutes drove up the hill, 10 seconds from the mountain.  As a result, the average speed will not be indicative at all.  But the speed with which we drove the most time - what we need <br></li></ul><br>  We add all these functions.  The task is not simple, but interesting - working with arrays, conditions.  At the next new function, we receive a message - the program memory is over.  MK has only 8 KB.  Pity what can be done?  We start to analyze the log, where everything went, and we see that in the standard library there is a debugging mode and it is turned on, turn off - we get an additional 2kb of memory.  Now enough.  As a result, all the functions got in, and a little bit more remained. <br><br><p>  We should also talk about the STM8 microcontroller itself.  All this time he showed himself just fine.  What just did not do with him, by mistake.  And the food was fed plus to the minus - alive, and the legs were fed HIGH, when short-circuited to the ground, also alive.  In general, a fairly reliable microcontroller.  I liked working in the debugger.  Almost like a computer.  The simulator helped to debug complex functions, is also convenient.  In general, at this price, the microcontroller is just great.  And there is also a version with 32k flash on board, for 60 rubles, generally super. </p><br><h1>  Final version </h1><br><p>  The son is very pleased, the device works as they wanted!  We arrange races, we ride with him all summer, it turned out that in one walk we drove more than 14 km, we had not thought about it before.  In terms of its functions, the device turned out to be better than the purchased one, it's a pity that the screen is missing!  But literally after a month of use you forget about the screen, occasionally you look at the statistics, the device itself notifies the rest.  The Cadence Control function works fine, it helps to select the desired speed mode. </p><br><p>  For the rest of the family, we are making a new scheme and reworking the fee.  We take into account the errors: </p><br><ul><li>  replace the squeaker with a louder HC0903A <br></li><li>  remove LDO with MK, leave it for bluetooth, for pairing a simple divider on the resistors <br></li><li>  Add usb connector - it's more convenient to charge <br></li><li>  Add a corner button immediately to the board - there are no extra wires <br></li><li>  One reed switch was removed in the case, and the second, for the pedals left on the wire, the connector was removed - almost complete absence of wires. <br></li></ul><br>  We skated all summer, for 3 months the battery never had to be charged. <br><br><p>  The project is very satisfied.  It turned out from the layout on the Arduino, to the final product - how to swim across the ocean, even on such a simple device.  So many many minor flaws no one expected to meet.  But in practice they checked that it was not so difficult to switch to another class of microcontrollers, they turned out to be very similar to each other.  It is a pity that smt8 is not so common.  But, if you write a simple program, then the standard library from ST is enough, all the drivers are there - UART, I2C, SPI, ADC, EEPROM. </p><br><p>  Let's sum up.  The real device is ready, it benefits, it still works.  The new version is completely satisfied.  The son showed him to all his friends - he is just great.  What and you want!  If you are still testing what your Arduino is capable of, then think about which device you need to buy, and make it yourself!  You will get a lot of pleasure and experience. </p><br><p>  If you are interested in making the same bike computer, then all the project information is on <a href="https://github.com/myowndevice/velo">github</a> .  The only thing I highly recommend is to write the firmware yourself in order to earn experience!  By making this device, you will learn: </p><br><ul><li>  Dilute Boards in Kicad <br></li><li>  Make boards at home <br></li><li>  Solder smd components <br></li><li>  Program microcontrollers <br></li></ul></div><p>Source: <a href="https://habr.com/ru/post/373913/">https://habr.com/ru/post/373913/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../373903/index.html">"Mail of Russia" offers to reduce the duty-free threshold for online purchases of up to 50 euros</a></li>
<li><a href="../373905/index.html">Why not shout at your HDD</a></li>
<li><a href="../373907/index.html">AI instead of HR: HYIP or new recruiting opportunities?</a></li>
<li><a href="../373909/index.html">We analyze three water-proof readers: a different approach to protection and radically different results.</a></li>
<li><a href="../373911/index.html">Creating 3D Models with DJI and Agisoft Photoscan Drone</a></li>
<li><a href="../373915/index.html">Smart Wi-Fi outlet: from idea to design and launch</a></li>
<li><a href="../373917/index.html">Top 3D Shop invites video bloggers</a></li>
<li><a href="../373919/index.html">AlphaGo Zero's AI platform honed the skill of playing go without human intervention</a></li>
<li><a href="../373921/index.html">The power of known physical interactions</a></li>
<li><a href="../373923/index.html">Switch PRIMES and its leader Rob Roy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>