<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Two-factor authentication on the site using a USB token. Now for Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In one of our previous articles, we talked about the importance of two-factor authentication on corporate portals of companies. Last time, we demonstr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Two-factor authentication on the site using a USB token. Now for Linux</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/if/ba/dd/ifbaddvhncdnbsktyvxxh6zkkkg.png"></div><br>  In <a href="https://habr.com/ru/company/aktiv-company/blog/412809/">one of our previous articles,</a> we talked about the importance of two-factor authentication on corporate portals of companies.  Last time, we demonstrated how to set up secure authentication in the IIS web server. <br><br>  In the comments we were asked to write instructions for the most common web servers for Linux - nginx and Apache. <br><br>  You asked - we wrote. <br><a name="habracut"></a><br><h2>  What you need to start? </h2><br><ul><li>  Any modern Linux distribution.  I did a test setup in MX Linux 18.2_x64.  This is certainly not a server distribution, but for Debian there are hardly any differences.  For other distributions, the paths to libraries / configs may vary slightly. </li><li>  Token.  We continue to use the <a href="https://www.rutoken.ru/products/all/rutoken-ecp-pki/">PKI e</a> -signature <a href="https://www.rutoken.ru/products/all/rutoken-ecp-pki/">Rutoken</a> model, which is ideally suited for high-speed performance for corporate use. </li><li>  To work with a token in Linux, you must install the following packages: <br>  libccid libpcsclite1 pcscd pcsc-tools opensc </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jy/7l/no/jy7lno_ntxphhd3mmqrrcgptxni.jpeg"></div><br><h2>  Issuing certificates </h2><br>  In previous articles, we relied on the fact that server and client certificates will be issued using Microsoft CA.  But since we are setting up everything in Linux, then at the same time we‚Äôll tell you about an alternative way to write these certificates - without leaving Linux. <br>  As a CA, we will use XCA ( <a href="https://hohnstaedt.de/xca/">https://hohnstaedt.de/xca/</a> ), which is available in any modern Linux distribution.  All actions that we will perform in XCA can be done in the command line mode using the utilities OpenSSL and pkcs11-tool, but for greater simplicity and clarity in this article, we will not give them. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Beginning of work </h3><br><ol><li>  Install: <br><br><pre><code class="bash hljs">$ apt-get install xca</code> </pre> </li><li>  And run: <br><br><pre> <code class="bash hljs">$ xca</code> </pre> </li><li>  Create our database for CA - /root/CA.xdb <br>  We recommend storing the Certificate Authority database in a folder where only the administrator has access.  This is important for protecting the private keys of root certificates, which are used to sign all other certificates. </li></ol><br><h3>  Create keys and root CA certificate </h3><br>  The public key infrastructure (PKI) is based on a hierarchical system.  Central to this system is the root certification authority or root CA.  His certificate and must be created first. <br><br><ol><li>  Create a private key for CA RSA-2048.  To do this, on the <b>Private Keys</b> tab, click <b>New Key</b> and select the appropriate type. </li><li>  Set the name for the new key pair.  I called it - CA Key. </li><li>  We write out the CA certificate itself, using the created key pair.  To do this, go to the <b>Certificates</b> tab and click <b>New Certificate</b> . </li><li>  Be sure to choose <b>SHA-256</b> , because the use of SHA-1 can no longer be considered safe. </li><li>  As a template, be sure to select <b>[default] CA.</b>  Do not forget to click on <b>Apply all</b> , otherwise the template does not apply. </li><li>  On the <b>Subject</b> tab, select our key pair.  There you can fill in all the main fields of the certificate. </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ob/xf/7t/obxf7tawfryfu_rvb_7kmlet_si.png"></div><br><h3>  Create keys and https server certificate </h3><br><ol><li>  Similarly, we create the RSA-2048 private key for the server, I called it - Server Key. </li><li>  When creating a certificate, choose that the server certificate must be signed on the CA certificate. </li><li>  Do not forget to choose <b>SHA-256</b> . </li><li>  As a template, select <b>[default] HTTPS_server</b> .  Click on <b>Apply all</b> . </li><li>  Then on the <b>Subject</b> tab, select our key and fill in the required fields. </li></ol><br><img src="https://habrastorage.org/webt/9u/jc/wf/9ujcwfioxqhgm6piabwczsdipwu.png"><br><h3>  Create keys and certificate for user </h3><br><ol><li>  The user's private key will be stored on our token.  To work with it you need to install the PKCS # 11 library from our site.  For popular distributions, we distribute ready-made packages that are here - <a href="https://www.rutoken.ru/support/download/pkcs/">https://www.rutoken.ru/support/download/pkcs/</a> .  We also have builds for arm64, armv7el, armv7hf, e2k, mipso32el, which can be taken in our SDK - <a href="https://www.rutoken.ru/developers/sdk/">https://www.rutoken.ru/developers/sdk/</a> .  In addition to linux builds, there are also builds for macOS, freebsd, and android. </li><li>  Add a new PKCS # 11 Provider to the XCA.  To do this, go to the <b>Options</b> menu on the tab <b>PKCS # 11 Provider</b> . </li><li>  Click <b>Add</b> and select the path to the PKCS # 11 library.  In my case, this is \ usr \ lib \ librtpkcs11ecp.so. </li><li>  We will need a formatted token Rutoken e-signature PKI.  Download rtAdmin utility - <a href="https://dev.rutoken.ru/pages/viewpage.action%3FpageId%3D7995615">https://dev.rutoken.ru/pages/viewpage.action?pageId=7995615</a> </li><li>  We carry out <br><br><pre> <code class="bash hljs">$ rtAdmin -f -q -z /usr/lib/librtpkcs11ecp.so -u &lt;PIN- &gt;</code> </pre> </li><li>  As the key type, select - RSA-2048 key on Rutoken EDS PKI.  I called this key Client Key. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/78/0d/pv/780dpvwi4n2ndih7xg-bdneicec.png"></div></li><li>  Enter the PIN.  And we are waiting for the completion of the hardware generation of the key pair. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7t/hh/vv/7thhvv919wmmkqb7phwiedalagm.png"></div></li><li>  We create a certificate for the user by analogy with the server certificate.  This time, select the <b>[default] HTTPS_client template</b> and do not forget to click <b>Apply all</b> . </li><li>  On the <b>Subject</b> tab enter user information.  We reply affirmatively to the request for saving the token certificate. </li></ol><br>  As a result, on the <b>Certificates</b> tab in XCA, you should get something like this. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/td/jb/9w/tdjb9wzqlfbfjnp9or_fsnj00k8.png"></div><br>  This minimum set of keys and certificates is enough to begin setting up the servers directly. <br><br>  To configure, we need to export the CA certificate, server certificate and server's private key. <br><br>  To do this, select the desired entry on the appropriate tab in the XCA and click <b>Export</b> . <br><br><h2>  Nginx </h2><br>  I will not write how to install and run an nginx server - there are enough articles on the Internet on this subject, not to mention official documentation.  We proceed immediately to setting up HTTPS and two-factor authentication by token. <br><br>  Add the following lines to the server section in nginx.conf: <br><br><pre> <code class="plaintext hljs">server { listen 443 ssl; ssl_verify_depth 1; ssl_certificate /etc/nginx/Server.crt; ssl_certificate_key /etc/nginx/ServerKey.pem; ssl_client_certificate /etc/nginx/CA.crt; ssl_verify_client on; }</code> </pre> <br>  A detailed description of all the parameters relating to the ssl configuration in nginx can be found here - <a href="http_ssl_module.html">https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_client_certificate</a> <br><br>  I will only briefly describe those that I myself asked: <br><br><ul><li>  ssl_verify_client - indicates that you need to check the certificate trust chain. </li><li>  ssl_verify_depth - determines the depth of the trusted root certificate search in the chain.  Since we have a client certificate immediately signed on the root certificate, then the depth is set to 1. If the user's certificate subscribes to an intermediate CA, then 2 must be specified in this parameter, and so on. </li><li>  ssl_client_certificate - specifies the path to the trusted root certificate, which is used when checking the trust to the user's certificate. </li><li>  ssl_certificate / ssl_certificate_key - indicate the path to the server certificate / private key. </li></ul><br>  Do not forget to run nginx -t to check that there are no typos in the config, and all the files are where necessary and so on. <br><br>  And actually everything!  As you can see the setup is very simple. <br><br><h2>  Checking work in Firefox </h2><br>  Since we do everything completely in Linux, we will assume that our users also work in Linux (if they have Windows, then <a href="https://habr.com/ru/company/aktiv-company/blog/412809/">see the instructions for setting up browsers in the previous article</a> . <br><br><ol><li>  Launch Firefox. </li><li>  Let's try to go in at the beginning without a token.  We get this picture: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qk/sh/rg/qkshrgktxjp1ryytdfe3trauj_4.png"></div></li><li>  Go to <b>about: preferences # privacy</b> , and go to <b>Security Devices ...</b> </li><li>  Click <b>Load</b> to add a new PKCS # 11 Device Driver and specify the path to our librtpkcs11ecp.so. </li><li>  To check that the certificate is seen, you can go to the <b>Certificate Manager</b> .  You will be prompted to enter a PIN code.  After correct input, you can verify that our certificate with a token appeared on the <b>Your Certificates</b> tab. </li><li>  Now we go with the token.  Firefox offers to choose a certificate that will be selected on the server.  Choose our certificate. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/f-/vk/1h/f-vk1h6nt5vn0qpql0fnccseaeg.png"></div></li><li>  PROFIT! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yu/ia/gg/yuiaggrfptx5kgtkcd3fl8ukagg.png"></div></li></ol><br>  The configuration is performed once, and as seen in the certificate request window, we can save our selection.  After that, at each entrance to the portal, we will only need to insert a token and enter the user's PIN-code, which was set during formatting.  After such authentication, the server already knows which user logged on to it and you can no longer make any additional windows for checking, but immediately let the user into his personal account. <br><br><h2>  Apache </h2><br>  As with nginx, no one should have problems installing apache.  If you do not know how to install this web-server, just use the official documentation. <br><br>  And we start setting up our HTTPS and two-factor authentication: <br><br><ol><li>  First you need to activate mod_ssl: <br><br><pre> <code class="bash hljs">$ a2enmod ssl</code> </pre> </li><li>  And then enable the default HTTPS site settings: <br><br><pre> <code class="bash hljs">$ a2ensite default-ssl</code> </pre> </li><li>  Now edit the configuration file: /etc/apache2/sites-enabled/default-ssl.conf: <br><br><pre> <code class="plaintext hljs"> SSLEngine on SSLProtocol all -SSLv2 SSLCertificateFile /etc/apache2/sites-enabled/Server.crt SSLCertificateKeyFile /etc/apache2/sites-enabled/ServerKey.pem SSLCACertificateFile /etc/apache2/sites-enabled/CA.crt SSLVerifyClient require SSLVerifyDepth 10</code> </pre> <br>  As you can see, the names of the parameters almost coincide with the names of the parameters in nginx, so I will not explain them.  Again, who are interested in the details - welcome to the documentation. <br>  Now we restart our server: <br><br><pre> <code class="bash hljs">$ service apache2 reload $ service apache2 restart</code> </pre> <br></li><br>  As you see, you can configure two-factor authentication on any web server, which is in Windows, that in Linux it is one hour maximum.  And setting up browsers takes about 5 minutes.  Many people believe that setting up and working with two-factor authentication is difficult and incomprehensible.  I hope our article a little bit, but debunks this myth. </ol></div><p>Source: <a href="https://habr.com/ru/post/457886/">https://habr.com/ru/post/457886/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457866/index.html">Unit testing in Laravel</a></li>
<li><a href="../457872/index.html">How to manage time and stop procrastinating?</a></li>
<li><a href="../457874/index.html">Why are employees coming back? Stories left and returned</a></li>
<li><a href="../457876/index.html">Translation: IEEE 802.15.4z Standard. What awaits us in the future?</a></li>
<li><a href="../457884/index.html">Sovereign Online - Clarifying Orders</a></li>
<li><a href="../457888/index.html">Mutation Testing: Testing Tests</a></li>
<li><a href="../457892/index.html">Professor who beat roulette</a></li>
<li><a href="../457894/index.html">Work with Proxmox Cluster: Installation, Network Configuration, ZFS, Common Problem Solving</a></li>
<li><a href="../457896/index.html">Zimbra and server overload protection</a></li>
<li><a href="../4579/index.html">Digital TV: investments set the stage for growth</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>