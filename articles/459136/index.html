<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fake Blue Pill</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am a big fan of the blue pill design boards. They are very good in terms of price / features. Actually, my love for them is noticeable from the Apri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fake Blue Pill</h1><div class="post__text post__text-html js-mediator-article">  I am a big fan of the blue pill design boards.  They are very good in terms of price / features.  Actually, my love for them is noticeable from the <a href="https://habr.com/ru/post/445160/">April Fools article about pedal firmware for playing the balalaika</a> . <br><br><img src="https://habrastorage.org/webt/6s/wd/xg/6swdxgpdmolly9ywvdylhvgmuj8.png"><br><br>  It is in the order of things to open a box with such boards and quickly take one to solve some problems.  That's right, I recently took another board, flashed it with a well-debugged and tested ‚Äúfirmware‚Äù and ... got an unidentified USB device.  I took another fee, ‚Äúflashed‚Äù it, the device worked there.  There would be an end, but I wonder what the matter is.  Therefore, as the weekend came, I took up a detailed study of why it does not work. <br><a name="habracut"></a><br>  In general, before ‚Äúflashing‚Äù the boards, I am convinced that the test, poured by the manufacturer, is working: the LED is flashing.  So I was sure that the processor was generally alive.  What then is to blame?  Perhaps the USB line or quartz. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The lines were all fine, the quartz did not start.  But it may not start for a variety of reasons.  Its launch is performed programmatically, already in the depths of the <b>main ()</b> function. Well, fine, we start debugging the program. <br><br>  All anything, but the debugger does not exit the <b>main ()</b> function.  The program "hangs" somewhere between the launch and this function. <br><br><img src="https://habrastorage.org/webt/ko/es/xj/koesxjk9g7tdmkfbvgciacfru1a.png"><br><br>  We stop the program: quite expectedly, we are in the <b>HardFault</b> handler. <br><br><img src="https://habrastorage.org/webt/3t/ij/c8/3tijc8kk_f5o_cyy0ivc95mnk9o.png"><br><br><img src="https://habrastorage.org/webt/_k/oj/9w/_koj9wd0mzpqfulrmwhacwa7_py.png"><br><br>  What brings us here?  We reset the address counter: <br><br><img src="https://habrastorage.org/webt/ng/mh/ch/ngmhchhxo_va_3_ip0r9z_6nnk4.png"><br><br>  And we begin to gently walk through the program.  Here, on this line, everything dies; we use at least <b>Step</b> operation, even <b>Step Over</b> . <br><br><img src="https://habrastorage.org/webt/sa/4k/-1/sa4k-1gc061eyl4i94sv4pwg14a.png"><br><br>  Merry Keil ... Well, nothing.  We reset everything once again (RST), click the ‚Äúmouse‚Äù on the disassembler window and step there.  In this case, we can understand that everything dies inside the <b>__scatterload</b> function. <br><br><img src="https://habrastorage.org/webt/i9/nw/ps/i9nwpsk8ig7ck8yai1v7i7re0_y.png"><br><br>  In general, if everything dies in this function, there is already a reason to look at whether the type of controller is confused.  But no, that's right (I also checked the settings, but this firmware works in other boards). <br><br><img src="https://habrastorage.org/webt/tn/fg/ok/tnfgokogkw2yvys7_drk5n9ted4.jpeg"><br><br>  Good.  Again, everything is reset and we are already tracing this function.  After a few tests, freezes and discharges we find the guilty line ... <br><br><img src="https://habrastorage.org/webt/k6/3z/tz/k63ztz99gszkoxsafwjxid7jvmm.png"><br><br>  Yes Yes.  Everything dies while keeping the registers on the stack.  At the same time, on the left you can see that SP is equal to 0x200030A0.  We look at the documentation for the controller: <br><br><img src="https://habrastorage.org/webt/0v/u1/u6/0vu1u6su1xs0fahgqoxxajp1fmm.png"><br><br>  We look, what window is selected for SRAM: <br><br><img src="https://habrastorage.org/webt/tb/iu/im/tbiuimemokbgv9fnercmrybq-mm.png"><br><br>  That's right.  The stack pointer (SP) is in the allowed range.  So what is to blame?  Let's try to cheatfully change the SP value from 0x200030A0, say, to 0x200020A0, since the debugger allows it ... Chpok!  The hang in the specified line has stopped!  So, our memory crystal is not 20 kilobytes.  And how much?  After checking several times, we find out that the last working value of SP is 0x20002800.  That is, 10 kilobytes.  This corresponds to the STM32F103C6 crystal.  Before us sawn chip.  Alas. <br><br>  All anything, but the boards from this lot in my rather big box are easy to distinguish.  They have a special color of jumpers and a very beautiful emerald LED (the others have a less pleasant shade of green).  Therefore, they easily stand out from the pile of other cards.  Of course, I checked them.  Of course, the whole party was cut through (I took a dozen). <br><br>  What to do with this is not clear.  When I got three pieces in the top ten boards that didn‚Äôt have a regular test: the LED did not blink (therefore I‚Äôm not checking them selectively, but totally), I was butting the seller for a week.  He "turned on the fool."  Constantly interested in what I want to do, promised to help with advice.  And I again and again repeated to him that I stupidly connected to the power supply, seven motherboards blink an eye, three - no.  So they are dead.  And he again his barrel organ.  And so a week.  But there everything was obvious.  Did not pass the regular test.  Here the regular test passes, it does not need a lot of memory.  How to prove that a fake has come is not clear.  And if you can prove it, then all the same, according to the rules of Ali Express, you need to send the goods back.  In general, everything looks like hopelessness.  And most importantly, the final seller did not have malicious intent.  I took another batch from him, later.  Everything is fine there.  He himself was let down. <br><br>  Anyway, I inform the public that this is how it happens.  Check the boards not only for general performance, but also for real performance.  True, what to do if there is a discrepancy is not clear. <br><br>  The article has another practical use.  It shows how you can quickly find the reason why suddenly the board does not work if the matter is not the complete inoperability of the controller (it responds to the SWD debug port). </div><p>Source: <a href="https://habr.com/ru/post/459136/">https://habr.com/ru/post/459136/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459120/index.html">Modular Embedded Computers UNO-1000/2000 Series</a></li>
<li><a href="../459128/index.html">Japanese interfaces in the real world</a></li>
<li><a href="../45913/index.html">Live cook book: our culinary and software hobby</a></li>
<li><a href="../459130/index.html">Careful error handling in microservices</a></li>
<li><a href="../459134/index.html">Experience using BDD</a></li>
<li><a href="../459138/index.html">How Huawei secret key got into Cisco router firmware</a></li>
<li><a href="../45914/index.html">Using third-party brands in a startup</a></li>
<li><a href="../459140/index.html">Implant placement: how is it done?</a></li>
<li><a href="../459142/index.html">Building an animated linear graph of a moving average in R. Retrieving data through the NBA API</a></li>
<li><a href="../459146/index.html">Product Design Digest June 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>