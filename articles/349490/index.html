<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Auto-clean and reload print server print service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A short but useful script for admins. There is a printer server with 34 printers, and it is stuck in the print queue, usually it happens when a depart...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Auto-clean and reload print server print service</h1><div class="post__text post__text-html js-mediator-article">  A short but useful script for admins.  There is a printer server with 34 printers, and it is stuck in the print queue, usually it happens when a department printer is sent in for repair, and the other department wants them to send a document to a non-existing printer.  CPU load rises and can reach 100%. <br><br>  Having received such a situation several times, and finding that the print server can stand with a processor load of 30-50% a week (!) Until the admin sees it.  In order to solve this problem and unload the staff, a small script was drafted, it is extremely simple and it has many analogs, I decided to post it here because it proved its usefulness again and again. <br><br><img src="https://habrastorage.org/webt/gt/6e/lv/gt6elvfjrcvfdb2d8xeny1lciqq.jpeg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We have broken three printers in a row, we removed them for repair, and users of other departments continued to send jobs to the queue, as a result, auto cleaning and overloading of the print service saved us from work at that moment when we were busy repairing physical equipment. <br><a name="habracut"></a><br>  In order to remove the load from the processor, you need to clear the print jobs in the <b>C: \ Windows \ System32 \ spool \ PRINTERS \</b> directory. All files in the directory are simply deleted when the service is stopped: <br><br><pre><code class="hljs vbscript"><span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-Service *spool* | <span class="hljs-keyword"><span class="hljs-keyword">Stop</span></span>-Service -Force -Verbose Start-Sleep -Seconds <span class="hljs-number"><span class="hljs-number">5</span></span> $path = <span class="hljs-string"><span class="hljs-string">"C:\Windows\System32\spool\PRINTERS\"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-ChildItem $path -File | Remove-Item -Force -Verbose <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-Service Spooler | Start-Service -Verbose</code> </pre> <br>  For administrative notification, we first save - who, what document, what size and where it was printed.  At the same time an example of how to create objects. <br><br><pre> <code class="hljs mel">#            $temp = Get-Printer | Get-PrintJob #     $Jobs = @() #          foreach ( $p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $temp ) { #    [ordered]      #         #      ,      #        -      #           html  $props = [ordered]@{ ID = $p.Id PrinterName = $p.PrinterName UserName = $p.UserName DocumentName = $p.DocumentName DataType = $p.Datatype SubmittedTime = $p.SubmittedTime Size = $p.Size JobTime = $p.JobTime PagesPrinted = $p.PagesPrinted TotalPages = $p.TotalPages Status = $p.Status } #        $props $obj = New-Object -TypeName PSObject -Property $props #     $Jobs += $obj } #      $Jobs</code> </pre><br>  When working, it is desirable to create objects. <br><br><ul><li>  First, reuse better; </li><li>  It's easier to add new properties - just insert a line in $ props and get a property for all objects; </li><li>  It is better to sort \ record \ output \ merge \ filter; </li><li>  Personally, I find it easier to combine the properties of several objects into one and output further as one, it is easier to work. <br><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="hljs mel">Function Get-NBTName { #     NBTSTAT,     $data=nbtstat /n | Select-String <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span> | where {$_ -notmatch <span class="hljs-string"><span class="hljs-string">"__MSBROWSE__"</span></span>} #      $lines=$data | foreach { $_.Line.Trim() } #         #          $lines | foreach { $temp=$_ -split <span class="hljs-string"><span class="hljs-string">"\s+"</span></span> [PSCustomObject]@{ Name=$temp[<span class="hljs-number"><span class="hljs-number">0</span></span>] NbtCode=$temp[<span class="hljs-number"><span class="hljs-number">1</span></span>] Type=$temp[<span class="hljs-number"><span class="hljs-number">2</span></span>] Status=$temp[<span class="hljs-number"><span class="hljs-number">3</span></span>] } } }</code> </pre> <br>  And now we call <b>Get-NBTName |</b>  <b>sort type |</b>  <b>Format-Table ‚ÄìAutosize</b> <br><br>  The output will be a set of objects of something like: <br><br><pre> <code class="hljs xml">Name NbtCode Type Status ---- ------- ---- ------ MYCOMPANY <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">1E</span></span></span><span class="hljs-tag">&gt;</span></span> GROUP Registered MYCOMPANY <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">00</span></span></span><span class="hljs-tag">&gt;</span></span> GROUP Registered MYCOMPANY <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">1D</span></span></span><span class="hljs-tag">&gt;</span></span> UNIQUE Registered CLIENT2 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">00</span></span></span><span class="hljs-tag">&gt;</span></span> UNIQUE Registered CLIENT2 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">20</span></span></span><span class="hljs-tag">&gt;</span></span> UNIQUE Registered</code> </pre><br></div></div></li></ul><br>  We want to have diagnostic information at the time of the spooler reload for this purpose, we will add a list of processes with loading on the processor and memory: <br><br><pre> <code class="hljs mel">#    $temp = Get-Process | <span class="hljs-keyword"><span class="hljs-keyword">sort</span></span> -Property cpu -Descending #     $proc = @() foreach ( $p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $temp ) { #     $props = [ordered]@{ Name=$p.ProcessName CPU_total_in_seconds=$p.CPU PhysicallMemory_in_Mb=$p.WS/<span class="hljs-number"><span class="hljs-number">1</span></span>mb ProcessID=$p.Id } #     $obj = New-Object -TypeName PSObject -Property $props #      $proc += $obj } $proc</code> </pre><br>  To make a decision that it is time to overload the spooler, the counts are taken from the processor and if they exceed the threshold within 5 seconds, it is considered that it is time to reload.  This scheme is not optimal, for example, when installing updates, such a load may be kept, but for operational work and daily activities it proved to be sufficient, therefore, I leave it as it is: <br><br><pre> <code class="hljs mel">#  ,     <span class="hljs-number"><span class="hljs-number">95</span></span>   $cfi = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( $i=<span class="hljs-number"><span class="hljs-number">1</span></span>; $i -le <span class="hljs-number"><span class="hljs-number">5</span></span>; $i++ ) { Start-Sleep -Seconds <span class="hljs-number"><span class="hljs-number">1</span></span> #    $load = Get-WmiObject win32_Processor | <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> -Property LoadPercentage Write-Host <span class="hljs-string"><span class="hljs-string">"CPU load $load"</span></span> -ForegroundColor Green <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($($load.LoadPercentage) -gt <span class="hljs-number"><span class="hljs-number">95</span></span>) { $cfi = $cfi + <span class="hljs-number"><span class="hljs-number">1</span></span> Write-Host <span class="hljs-string"><span class="hljs-string">"indicator is $cfi"</span></span> -ForegroundColor Green } }</code> </pre><br>  The script must be added to the scheduler to run every 5-10 minutes. <br><br>  We use the method described <a href="https://habrahabr.ru/post/279005/">here</a> with a few changes to send a letter. <br><br>  Sending mail is a separate function, because  it is used in other places, you need to change the address of the mail server <b>'SMTPServer' = 'Exchange.domain.ru'</b> to your server in this place: <br><br><pre> <code class="hljs perl">$params = @{<span class="hljs-string"><span class="hljs-string">'To'</span></span>=$MailAddress <span class="hljs-string"><span class="hljs-string">'From'</span></span>=<span class="hljs-string"><span class="hljs-string">'bot@domain.local'</span></span> <span class="hljs-string"><span class="hljs-string">'Subject'</span></span>=<span class="hljs-string"><span class="hljs-string">"$Subject $Date"</span></span> <span class="hljs-string"><span class="hljs-string">'Body'</span></span>=$MailBody <span class="hljs-string"><span class="hljs-string">'BodyAsHTML'</span></span>=$True <span class="hljs-string"><span class="hljs-string">'SMTPServer'</span></span>=<span class="hljs-string"><span class="hljs-string">'Exchange.domain.ru'</span></span> } Send-MailMessage @params -Encoding $encoding</code> </pre><br>  And replace the address <b>admin@domain.ru</b> with the address to which the administrative notification should go here: <br><br><pre> <code class="hljs perl">Send-ToAdmin -MailAddress <span class="hljs-string"><span class="hljs-string">'admin@domain.ru'</span></span> -Style $Style -Subject <span class="hljs-string"><span class="hljs-string">'  -    100%'</span></span> -Body $Body -Header1 $header</code> </pre><br>  In the original edition of the script was able to extract the DLL loaded into memory for each process in order to catch the "buggy" driver.  This edition is removed because  generates too much info, was implemented via <b>ListDll</b> , but generated a very large list. <br><br>  Full script code: <br><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">#</span></span></span><span class="hljs-tag">   ,           #&gt;</span></span> $StyleYellowSimple = @' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">body</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">background-color</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">#ffffff</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">font-family</span></span></span><span class="css">:Tahoma; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">font-size</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">12pt</span></span></span><span class="css">; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">td</span></span></span><span class="css">, </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">th</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">1px</span></span></span><span class="css"> solid black; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border-collapse</span></span></span><span class="css">:collapse; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">th</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">color</span></span></span><span class="css">:white; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">background-color</span></span></span><span class="css">:black; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">table</span></span></span><span class="css">, </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">tr</span></span></span><span class="css">, </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">td</span></span></span><span class="css">, </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">th</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">padding</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">2px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0px</span></span></span><span class="css"> } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">table</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">font-family</span></span></span><span class="css">: </span><span class="hljs-string"><span class="css"><span class="hljs-string">"Lucida Sans Unicode"</span></span></span><span class="css">, </span><span class="hljs-string"><span class="css"><span class="hljs-string">"Lucida Grande"</span></span></span><span class="css">, Sans-Serif; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">font-size</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">14px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border-radius</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">10px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border-spacing</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">text-align</span></span></span><span class="css">: center; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">th</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">background</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">#BCEBDD</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">color</span></span></span><span class="css">: white; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">text-shadow</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">1px</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">1px</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">#2D2020</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">padding</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">10px</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">20px</span></span></span><span class="css">; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">th</span></span></span><span class="css">, </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">td</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border-style</span></span></span><span class="css">: solid; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border-width</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">1px</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">1px</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border-color</span></span></span><span class="css">: white; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">th</span></span></span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">:first-child</span></span></span><span class="css">, </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">td</span></span></span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">:first-child</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">text-align</span></span></span><span class="css">: left; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">th</span></span></span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">:first-child</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border-top-left-radius</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">10px</span></span></span><span class="css">; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">th</span></span></span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">:last-child</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border-top-right-radius</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">10px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border-right</span></span></span><span class="css">: none; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">td</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">padding</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">10px</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">20px</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">background</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">#F8E391</span></span></span><span class="css">; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">tr</span></span></span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">:last-child</span></span></span><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">td</span></span></span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">:first-child</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border-radius</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">10px</span></span></span><span class="css">; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">tr</span></span></span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">:last-child</span></span></span><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">td</span></span></span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">:last-child</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border-radius</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">10px</span></span></span><span class="css"> </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; } </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">tr</span></span></span><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">td</span></span></span><span class="hljs-selector-pseudo"><span class="css"><span class="hljs-selector-pseudo">:last-child</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">border-right</span></span></span><span class="css">: none; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> '@ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">#</span></span></span><span class="hljs-tag">       </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">       #&gt;</span></span> function Send-ToAdmin { Param ( [string]$MailAddress = 'admin@domain.ru', [string]$Subject = 'Test message', [string]$Header1, [string]$Body, [string]$Style ) BEGIN {} PROCESS { Write-Verbose 'definiting CSS' <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">#</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Switch</span></span></span><span class="hljs-tag"> ($</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Style</span></span></span><span class="hljs-tag">) { '</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">YellowSimple</span></span></span><span class="hljs-tag">' { $</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">head</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">$StyleYellowSimple;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">break</span></span></span><span class="hljs-tag"> } '</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BlueSimple</span></span></span><span class="hljs-tag">' { $</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">head</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">$StyleBlueSimple;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">break</span></span></span><span class="hljs-tag"> } '</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DataTable</span></span></span><span class="hljs-tag">' {$</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">head</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">$StyleResposTable;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">break</span></span></span><span class="hljs-tag"> } </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">default</span></span></span><span class="hljs-tag"> { $</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">head</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">$StyleYellowSimple;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">break</span></span></span><span class="hljs-tag"> } }#&gt;</span></span> $head = $StyleYellowSimple $encoding = [System.Text.Encoding]::UTF8 $Date = Get-Date $MailBody = ConvertTo-HTML -head $head -PostContent $Body -PreContent "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>$Subject. Date:$Date<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>$Header1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>" | Out-String Write-Verbose "Sending e-mail. Address: $MailAddress" $params = @{'To'=$MailAddress 'From'='bot@domain.local' 'Subject'="$Subject $Date" 'Body'=$MailBody 'BodyAsHTML'=$True 'SMTPServer'='Exchange.domain.ru' } Send-MailMessage @params -Encoding $encoding } END{} } $cfi = 0 for( $i=1; $i -le 5; $i++ ) { Start-Sleep -Seconds 1 $load = Get-WmiObject win32_Processor | select -Property LoadPercentage Write-Host "CPU load $load" -ForegroundColor Green if ($($load.LoadPercentage) -gt 95) { $cfi = $cfi + 1 Write-Host "indicator is $cfi" -ForegroundColor Green } } if ($cfi -gt 2) { #     $temp = Get-Process | sort -Property cpu -Descending $proc = @() foreach ( $p in $temp ) { $props = [ordered]@{ Name=$p.ProcessName CPU_total_in_seconds=$p.CPU PhysicallMemory_in_Mb=$p.WS/1mb ProcessID=$p.Id } $obj = New-Object -TypeName PSObject -Property $props $proc += $obj } $temp = Get-Printer | Get-PrintJob $Jobs = @() foreach ( $p in $temp ) { $props = [ordered]@{ ID = $p.Id PrinterName=$p.PrinterName UserName=$p.UserName DocumentName=$p.DocumentName DataType=$p.Datatype SubmittedTime=$p.SubmittedTime Size=$p.Size JobTime=$p.JobTime PagesPrinted=$p.PagesPrinted TotalPages=$p.TotalPages Status=$p.Status } $obj = New-Object -TypeName PSObject -Property $props $Jobs += $obj } #    Write-Host " " -ForegroundColor Green Get-Service *spool* | Stop-Service -Force -Verbose Start-Sleep -Seconds 5 $path = "C:\Windows\System32\spool\PRINTERS\" Get-ChildItem $path -File | Remove-Item -Force -Verbose Get-Service Spooler | Start-Service -Verbose $frag1 = $proc | ConvertTo-Html -As table -Fragment -PreContent '<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>     <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>' | Out-String $frag2 = $Jobs | ConvertTo-Html -As table -Fragment -PreContent '<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>      <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span>        ( )' | Out-String $Body = '<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span>    ..     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span>' $Body = $Body + $frag2 + '<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span>' $Body = $Body + $frag1 + '<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span>---------------------------------------------------------------------------<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span>  <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">H2</span></span></span><span class="hljs-tag">&gt;</span></span>          <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">H2</span></span></span><span class="hljs-tag">&gt;</span></span>' $Date = Get-Date $header = "$Date  " $Style = 'YellowSimple' Send-ToAdmin -MailAddress 'admin@domain.ru' -Style $Style -Subject '  -    100%' -Body $Body -Header1 $header }</code> </pre><br>  The script must be added to the scheduler to run every 5-10 minutes. <br><br>  ‚Üí <a href="http://winitpro.ru/index.php/2016/04/12/prinuditelnaya-ochistka-ocheredi-pechati-v-windows/">Link to alternative script</a> </div><p>Source: <a href="https://habr.com/ru/post/349490/">https://habr.com/ru/post/349490/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349478/index.html">[Yekaterinburg, Announcement] Botters of the Galaxy CodingHub in the Contour office</a></li>
<li><a href="../349480/index.html">Why computer chips become faster to "grow old" and what to do about it</a></li>
<li><a href="../349482/index.html">Why Python is so good at scientific computing.</a></li>
<li><a href="../349484/index.html">Media queries in responsive design 2018</a></li>
<li><a href="../349488/index.html">Girlish joys in the interior - not a pink shelf with Internet radio and RGB lighting</a></li>
<li><a href="../349492/index.html">Immer: a new approach to immunity in JavaScript</a></li>
<li><a href="../349494/index.html">Ask the creator of Vue.js a question</a></li>
<li><a href="../349496/index.html">Conduit - lightweight service mesh for Kubernetes</a></li>
<li><a href="../349500/index.html">How many developers and how few programmers ...</a></li>
<li><a href="../349502/index.html">Zane Lackey: ‚ÄúYou should not invest in security, just to meet the requirements of the law‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>