<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Singleton, service locator and tests in iOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I am Bogdan, I work in the mobile team of a Badoo iOS developer. 

 In this article, we will look at using the Singleton and Service locator...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Singleton, service locator and tests in iOS</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  I am Bogdan, I work in the mobile team of a Badoo iOS developer. <br><br>  In this article, we will look at using the Singleton and Service locator patterns in iOS and discuss why they are often called antipatterns.  I will tell how and where they should be applied, keeping the code suitable for testing. <br><br><img src="https://habrastorage.org/webt/f8/u5/rs/f8u5rsuurzfm3k4g_65bilzxske.jpeg"><br><a name="habracut"></a><br><h2>  Singleton </h2><br>  Singleton is a class that has only one instance at a time. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Even if you have just begun iOS programming, you most likely have already encountered such singletones as <code>UIApplication.shared</code> and <code>UIDevice.current</code> .  These objects are entities that exist in the real world in a single copy, so it is quite logical that in the application they are one by one. <br><br>  Singleton is quite simply implemented in Swift: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> shared = <span class="hljs-type"><span class="hljs-type">SomeManager</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() { } } ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> manager = <span class="hljs-type"><span class="hljs-type">SomeManager</span></span>.shared manager.doWork()</code> </pre><br>  Note that the initializer is private, so we cannot allocate a new instance of the class directly, like <code>SomeManager()</code> , and must get access through <code>SomeManager.shared</code> . <br><br>  <code>let managerA = SomeManager.shared //</code> correctly <br>  <code>let managerB = SomeManager() //</code> wrong, compilation error <br><br>  At the same time, UIKit is not always consistent with its singletons, for example, <code>UIDevice()</code> creates for you a new instance of a class that contains information about the same device (quite meaningless), while <code>UIApplication()</code> throws an exception at runtime during execution. <br><br>  An example of a lazy (delayed) initialization of a singleton: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> _shared: <span class="hljs-type"><span class="hljs-type">SomeManager?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> shared: <span class="hljs-type"><span class="hljs-type">SomeManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> instance = <span class="hljs-type"><span class="hljs-type">SomeManager</span></span>._shared <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-type"><span class="hljs-type">SomeManager</span></span>._shared = <span class="hljs-type"><span class="hljs-type">SomeManager</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">SomeManager</span></span>._shared! } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() { } }</code> </pre><br>  It is important to understand that a lazy launch can affect the state of your application.  For example, if your singletons are subscribed to notifications, make sure that there are no similar lines in the code: <br><br><pre> <code class="php hljs">_ = SomeManager.shared <span class="hljs-comment"><span class="hljs-comment">// initialization of a lazy singleton to achieve a side-effect</span></span></code> </pre> <br>  This means that you rely on implementation nuances.  Instead, I recommend making your singletons explicitly defined and either allowing them to exist forever or linking important applications with status of a user session. <br><br><h2>  How to understand that an entity should be a singleton </h2><br>  In object-oriented programming, we try to divide the real world into classes and their objects, so if an object in your domain exists in the singular, it should be a singleton. <br><br>  For example, if we create autopilot for a particular car, then this car is a singleton, since there can not be more than one specific car.  On the other hand, if we make an application for a car factory, then the Automobile object cannot be a singleton because there are a lot of cars in the factory, and all of them are relevant to our application. <br><br>  In addition to this, it is worth asking yourself the question: ‚ÄúIs there a situation in which an application can exist without this object?‚Äù <br><br>  If the answer is positive, then even considering that the object is a singleton, storing it with a static variable can be a very bad idea.  In the autopilot example, this would mean that if information about a particular car comes from the server, it will not be available when the application starts.  Therefore, this particular car is an example of a singleton that is dynamically created and destroyed. <br><br>  Another example is an application requiring the ‚ÄúUser‚Äù entity.  Even if the application is useless, as long as you are not logged in, it still works, even if you have not entered your data.  This means that the user is a singleton with a limited lifetime.  For more information read <a href="https://www.objc.io/issues/13-architecture/singletons/">this article</a> . <br><br><h2>  Abuse of singletons </h2><br>  Singletons, like ordinary objects, can be in different states.  But singletons are global objects.  This means that their state is projected onto all objects in the application, which allows an arbitrary object to make decisions based on the general state.  This makes the application extremely difficult to understand and debug.  Access to a global object from any application level violates the <a href="https://en.wikipedia.org/wiki/Principle_of_least_privilege">principle of minimal privileges</a> and interferes with our attempts to control dependencies. <br><br>  Consider this <code>UIImageView</code> extension a counterexample: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIImageView</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downloadImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(from url: URL)</span></span></span></span> { <span class="hljs-type"><span class="hljs-type">NetworkManager</span></span>.shared.downloadImage(from: url) { image <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.image = image } } }</code> </pre><br>  This is a very convenient way to load an image, but <code>NetworkManager</code> is a hidden variable that is not accessible from the outside.  In this case, <code>NetworkManager</code> works asynchronously on a separate thread of execution, but the <code>downloadImage</code> method does not have a termination closure, from which it can be concluded that the method is synchronous.  So until you open the implementation, you won‚Äôt understand in any way whether the image was loaded after the method was called or not. <br><br> <code>imageView.downloadImage(from: url) <br> print(String(describing: imageView.image)) //</code>  <code>imageView.downloadImage(from: url) <br> print(String(describing: imageView.image)) //</code> image already set or not? <br><br><h2>  Singletons and unit testing </h2><br>  If you conduct unit testing of the above extension, you will understand that your code makes a network request and that you can‚Äôt influence it in any way! <br><br>  The first thing that comes to mind is to enter helper methods in <code>NetworkManager</code> and call them in <code>setUp()/tearDown()</code> : <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NetworkManager</span></span></span><span class="hljs-class"> </span></span>{ ‚Ä¶ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnOnTestingMode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnOffTestingMode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stubbedImage: <span class="hljs-type"><span class="hljs-type">UIImage!</span></span> }</code> </pre><br>  But this is a very bad idea, since you have to write a production code that is only suitable for supporting tests.  Moreover, you can accidentally use these methods in the production code itself. <br><br>  Instead, you can follow the principle of "tests exceed encapsulation" and create a public setter for a static variable that holds a singleton.  Personally, I think this is also a bad idea, because I do not perceive the environment, functioning only thanks to the promises of programmers not to do anything wrong. <br><br>  The best solution, in my opinion, would be to cover the Network Service protocol and implement it as an obvious dependency. <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImageDownloading</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downloadImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(from url: URL, completion: </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(UIImage)</span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>) } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NetworkManager</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImageDownloading</span></span></span><span class="hljs-class"> </span></span>{ } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIImageView</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downloadImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(from url: URL, imageDownloader: ImageDownloading)</span></span></span></span> { imageDownloader.downloadImage(from: url) { image <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.image = image } } }</code> </pre><br>  This will allow us to use a fake implementation (mock implementation) and conduct unit testing.  We can also use different implementations and easily switch between them.  Walkthrough: <a href="https://medium.com/flawless-app-stories/the-complete-guide-to-network-unit-testing-in-swift-db8b3ee2c327">medium.com/flawless-app-stories/the-complete-guide-to-network-unit-testing-in-swift-db8b3ee2c327</a> <br><br><h2>  Service </h2><br>  A service is an autonomous entity responsible for executing one business activity that may have other services as dependencies. <br><br>  Also, the service is a great way to ensure the independence of business logic from UI elements (screens / UIViewControllers). <br><br>  A good example is the UserService (or Repository), which contains a link to the current unique user (only one instance can exist in a specific period of time) and simultaneously to other users of the system.  Service is an excellent candidate for the role of the source of truth for your application. <br><br>  Services are a great way to separate screens from each other.  Suppose you have a user entity.  You can manually transfer it as a parameter to the next screen, and if the user changes on the next screen, you get it in the form of feedback: <br><br><img src="https://habrastorage.org/webt/9g/7l/6n/9g7l6nx3a612rn6rqeie6higmtk.png"><br><br>  Alternatively, screens can change the current user in the UserService and listen for user changes from the service: <br><br><img src="https://habrastorage.org/webt/vz/eg/yd/vzegydyol1_kbnfl9hqilhwmjba.png"><br><br><h2>  Service locator </h2><br>  A service locator is an object that holds and provides access to services. <br><br>  Its implementation may look like this: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceLocating</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getService</span></span></span><span class="hljs-function">&lt;T&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">T?</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceLocator</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceLocating</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> services: <span class="hljs-type"><span class="hljs-type">Dictionary</span></span>&lt;<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Any</span></span>&gt; = [:] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typeName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(some: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Any</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">String</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (some <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-type"><span class="hljs-type">Any</span></span>.<span class="hljs-type"><span class="hljs-type">Type</span></span>) ? <span class="hljs-string"><span class="hljs-string">"\(some)"</span></span> : <span class="hljs-string"><span class="hljs-string">"\(some.dynamicType)"</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addService</span></span></span><span class="hljs-function">&lt;T&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(service: T)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> key = typeName(<span class="hljs-type"><span class="hljs-type">T</span></span>) services[key] = service } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getService</span></span></span><span class="hljs-function">&lt;T&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">T?</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> key = typeName(<span class="hljs-type"><span class="hljs-type">T</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> services[key] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? <span class="hljs-type"><span class="hljs-type">T</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> shared: <span class="hljs-type"><span class="hljs-type">ServiceLocator</span></span>() }</code> </pre><br>  This may seem like a tempting substitute for dependency injection, since you don‚Äôt have to explicitly pass the dependency: <br><br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentUserProviding</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">currentUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">User</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentUserProvider</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentUserProviding</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">currentUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">String</span></span> { ... } }</code> </pre><br>  Register service: <br><br><pre> <code class="hljs css">... <span class="hljs-selector-tag"><span class="hljs-selector-tag">ServiceLocator</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.shared</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.addService</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">CurrentUserProvider</span></span>() <span class="hljs-selector-tag"><span class="hljs-selector-tag">as</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">CurrentUserProviding</span></span>) ...</code> </pre><br>  Access the service through the service locator: <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">viewDidLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> userProvider: <span class="hljs-type"><span class="hljs-type">UserProviding?</span></span> = <span class="hljs-type"><span class="hljs-type">ServiceLocator</span></span>.shared.getService() <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> provider = userProvider <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">assertionFailure</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.user = provider.currentUser() }</code> </pre><br>  And you can still replace the services provided for testing: <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.setUp() <span class="hljs-type"><span class="hljs-type">ServiceLocator</span></span>.shared.addService(<span class="hljs-type"><span class="hljs-type">MockCurrentUserProvider</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-type"><span class="hljs-type">CurrentUserProviding</span></span>) }</code> </pre><br>  But in fact, if you use the services locator in this way, it can bring you more trouble than good.  The problem is that, outside the user service, you cannot understand which services are being used at the moment, that is, the dependencies are implicit.  Now imagine that the class you wrote is a public component of the framework.  How does the framework user understand that he should register the service? <br><br><h2>  Service Locator Abuse </h2><br>  If you have thousands of tests running and suddenly they start to fail, you can not immediately understand that the system under test has a service with a hidden dependency. <br><br>  Moreover, when you add or remove a dependency on a service (or deep dependencies) from an object, a compilation error does not appear in your tests, due to which you would have to update the test.  Your test may not even start failing at once, remaining ‚Äúgreen‚Äù for a while, and this is the worst scenario, since eventually the tests begin to fail after some ‚Äúunrelated‚Äù changes in the service. <br><br>  Running the failed tests separately will lead to different results due to poor isolation caused by the common service locator. <br><br><h2>  Service Locator and Unit Testing </h2><br>  The first reaction to the described scenario may be the refusal to use service locators, but in fact it is very convenient to retain links in services, not transfer them as transitive dependencies, and avoid heaps of parameters for factories.  Instead, it‚Äôs better to ban the use of the service locator in the code that we are going to test! <br><br>  I suggest using the factory-level services locator in the same way that you would enter a singleton.  A typical screen factory would then look like this: <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EditProfileFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">func</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">createEditProfile</span></span></span><span class="hljs-class">() -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIViewController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> userProvider: <span class="hljs-type"><span class="hljs-type">UserProviding?</span></span> = <span class="hljs-type"><span class="hljs-type">ServiceLocator</span></span>.shared.getService() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> viewController = <span class="hljs-type"><span class="hljs-type">EditProfileViewController</span></span>(userProvider: userProvider!) } }</code> </pre><br>  In the unit test, we will not use the service locator.  Instead, we will constantly send our mock objects: <br><br><pre> <code class="hljs erlang">... EditProfileViewController(userProvider: MockCurrentUserProvider()) ...</code> </pre><br><h2>  Is there a way to improve everything? </h2><br>  What if we decide not to use static variables for singletons in our own code?  This will make the code more reliable.  And if we ban this expression: <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> shared: <span class="hljs-type"><span class="hljs-type">ServiceLocator</span></span>()</code> </pre> <br>  then even the most illiterate novice developer will not be able to use our service locator directly and circumvent our formal requirement of introducing it as a constant dependency. <br>  Therefore, we will be forced to store explicit references to the service locator (for example, as a property of the application delegate) and pass all services to the service locator as a necessary variable. <br><br>  All factories and flow controllers / routers will have at least one dependency if they need any service: <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EditProfileFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">func</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">createEditProfile</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">serviceLocator</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceLocating</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIViewController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> userProvider: <span class="hljs-type"><span class="hljs-type">UserProviding?</span></span> = serviceLocator.getService() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> viewController = <span class="hljs-type"><span class="hljs-type">EditProfileViewController</span></span>(userProvider: userProvider!) } }</code> </pre><br>  In this way, we get a code that is perhaps less convenient, but much more secure.  For example, it will not allow us to access the factory from the View layer, since the service locator is simply not available from there, and the action will be redirected to the router / flow controller. <br><br><h2>  Conclusion </h2><br>  We have analyzed the problems arising from the use of the Singleton and Locator of Services patterns.  It became clear that the main part of the problems arises due to implicit dependencies and access to the global state.  Introducing explicit dependencies and reducing the number of entities that have access to the global state improves the reliability and testability of the code.  Now it's time to reconsider whether singltons and services are used correctly in your project! </div><p>Source: <a href="https://habr.com/ru/post/344506/">https://habr.com/ru/post/344506/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344494/index.html">Do not succumb to HYIP, or why the price of Bitcoin does not reflect its real value.</a></li>
<li><a href="../344496/index.html">New spyware StrongPity2 replaced FinFisher in a cyber espionage campaign with the possible participation of an Internet provider</a></li>
<li><a href="../344498/index.html">PHP dependency management</a></li>
<li><a href="../344502/index.html">TypeScript basics for developing Angular applications</a></li>
<li><a href="../344504/index.html">Avito iOS Winter Edition - video, photos, slides, reviews</a></li>
<li><a href="../344508/index.html">Dependency injection and unit implementation using Castle Windsor and NHibernate</a></li>
<li><a href="../344510/index.html">How does MEGA Belaya Dacha work: we open a shopping center on the other side</a></li>
<li><a href="../344512/index.html">We invite you to the results of the competition for data analysis</a></li>
<li><a href="../344514/index.html">We start the django-application in Docker on Vagrant under Windows</a></li>
<li><a href="../344516/index.html">Extended Validation not working</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>