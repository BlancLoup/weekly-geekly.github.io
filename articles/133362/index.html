<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Client-side canvas cropper</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On one of the projects, it was necessary to make a crochet for avatars uploaded by users. Standard solutions, such as Jcrop, after selecting the area,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Client-side canvas cropper</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/8f29405f/a45f08b5/117e7581/f635c9ab.jpg" align="right">  On one of the projects, it was necessary to make a crochet for avatars uploaded by users.  Standard solutions, such as Jcrop, after selecting the area, send coordinates to the server, and the image itself needs to be cropped on the server.  Meanwhile, modern browsers have already reached the point where such actions can be performed immediately on the client.  This prompted me to write <a href="http://evrone.github.com/evroneCrop/">my crooner</a> using canvas, which would perform all actions on the client and send the finished image as a base64 string to the server.  In addition to speeding up and unloading the server, it also allows us to immediately change the user's avatar on the page, without uploading it from the server. <br><br><a name="habracut"></a><br><br><h4>  Technology and Challenge </h4><br>  Kropalka was written in <a href="http://jashkenas.github.com/coffee-script/">CoffeeScript</a> , a small language compiled into JavaScript.  Framed jingle in the form of a plugin for jQuery.  After loading the image, we set a croaker on it - it will draw a canvas over the image with the possibility of selecting the area.  After each change of the selected area, the new picture is recorded in the data of the image and it can be easily accessed from outside.  Kropalka should allow you to include a preview, set a fixed aspect ratio and set the selection immediately after activation.  And, of course, the cropper should work in all major browsers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Implementation </h4><br>  The selection area and the corners over which the area can be stretched are represented by the class <code>Rect</code> .  There is nothing magic in it - properties with coordinates, methods for determining the hitting of a point and updating coordinates.  The <code>EvroneCrop</code> class <code>EvroneCrop</code> responsible for creating a canvas, drawing it on top of the image, hanging handlers and saving the cropped image in data. <br><br>  To save the resulting image, a temporary canvas element is created, coordinates are calculated based on the original image size, using the <code>drawImage()</code> method, the selected area is drawn to the temporary canvas, and using the <code>toDataURL()</code> method from the <code>canvas</code> we obtain the resulting image, which can be passed as base64 to the server and save. <br><br>  In our case, the following code (Ruby) is used for saving on the server: <br><pre> <code class="ruby hljs">encoded_image = params[<span class="hljs-symbol"><span class="hljs-symbol">:image</span></span>].sub(<span class="hljs-string"><span class="hljs-string">'data:image/png;base64,'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) avatar_io = FilelessIO.new(Base64.decode64(encoded_image)) avatar_io.original_filename = <span class="hljs-string"><span class="hljs-string">"avatar.png"</span></span> <span class="hljs-comment"><span class="hljs-comment">#  ,    CarrierWave Rails.logger.info "IO: #{avatar_io.inspect}" </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@user</span></span></span><span class="hljs-comment">.avatar = avatar_io </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@user</span></span></span><span class="hljs-comment">.save</span></span></code> </pre><br><br>  When creating a crook, you can pass the following parameters: <br><pre> <code class="javascript hljs">$(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).evroneCrop({ <span class="hljs-attr"><span class="hljs-attr">preview</span></span>: <span class="hljs-string"><span class="hljs-string">'#preview1'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//  img,     size: {w: 150, h: 150}, //   ratio: 1, //   ,    -  setSelect: 'center', //    log: true //   });</span></span></code> </pre><br>  All parameters are optional.  <a href="http://evrone.github.com/evroneCrop/">Demo</a> . <br><br>  <code>setSelect</code> can take the <code>center</code> value, automatically calculate the center of the image and the size of the selection, or it can take an object <code>{x:0, y: 0, w: 100, h: 100}</code> and set the selection to a specified position.  If you have the <code>ratio</code> parameter set, you do not need to transfer the height in the object for <code>setSelect</code> . <br><br>  <code>ratio</code> takes a number greater than zero and fixes the sides with a ratio of lengths equal to that number.  For example, you can pass 1 for a square or 16/9 for an aspect ratio of 16 to 9. <br><br><h5>  Browser troubles </h5><br>  The resulting tool works in all major browsers - Chrome, Firefox&gt; 4, Safari, Opera&gt; 11, IE 9. There are plans to write a fallback in flash for IE8.  It was originally planned to use <a href="http://code.google.com/p/explorercanvas/">google excanvas</a> , but that, as it turned out, does not provide such a method necessary for our task as <code>toDataURL();</code>  There is a way out with sales on a <a href="http://code.google.com/p/fxcanvas/">flash</a> , but hands have not reached it yet. <br><br>  Kropalka is still damp, for example, the minimum and maximum size has not yet been implemented, but it lies on the <a href="https://github.com/evrone/evroneCrop">githaba</a> , it works, and it develops slowly. </div><p>Source: <a href="https://habr.com/ru/post/133362/">https://habr.com/ru/post/133362/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133355/index.html">Styling applications part two</a></li>
<li><a href="../133356/index.html">Candidates of Sciences may cancel, but will not</a></li>
<li><a href="../133357/index.html">Little known Java features. The second part of</a></li>
<li><a href="../133358/index.html">Office of the company Beeline</a></li>
<li><a href="../133360/index.html">PVS-Studio: analyze the Doom 3 code</a></li>
<li><a href="../133363/index.html">Cheat Sheet for NPM Package Manager</a></li>
<li><a href="../133364/index.html">How much does it cost not to implement MRM?</a></li>
<li><a href="../133366/index.html">Scrape the bottom of the barrel!</a></li>
<li><a href="../133367/index.html">Acer Allegro - my opinion</a></li>
<li><a href="../133368/index.html">Appiny - discounts for geeks!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>