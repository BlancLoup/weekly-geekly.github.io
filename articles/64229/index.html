<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementation of a small asynchronous server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The purpose of the publication of this topic is to present to the audience Habrahabr the code of a small asynchronous server written in Python using a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementation of a small asynchronous server</h1><div class="post__text post__text-html js-mediator-article">  The purpose of the publication of this topic is to present to the audience Habrahabr the code of a small asynchronous server written in Python using almost ‚Äúbare‚Äù sockets. <br><br>  I had to write a lot of applications that work as network services.  These services were written in different languages, under different load, and each time the implementation of a new service was somewhat different from the previous one.  Under Habrakat, I give an example of quite successful, in my opinion, the implementation of the "training" server, accompanying the code with my comments as needed. <br><a name="habracut"></a><br><h2>  Introductory word </h2><br>  So, at the beginning a few words about what the server actually does.  Since it is a learning example, its task is quite simple: when starting up, create a socket listening port;  when the client connects, start sending information to him  As information, customers receive an endless stream of digits of Pi calculated on the server.  The server generates digits only when at least one client is connected to it, remembering the already generated sequence.  When all clients are disconnected, the generation is suspended, the server waits for a new connection. <br><br>  The server implementation is single-threaded.  The advantage of this approach is the absence of an additional overhead projector in the form of a separate stream or even a separate instance of the application that would arise when using other frequently used techniques. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      By and large, this difference can hardly be called decisive, since  Python is nevertheless an interpreted language and introduces its own restrictions on the scope of use, but in the long term we can use the threads ‚Äúsaved‚Äù with such an architecture in the application to perform any parallel computational tasks. <br><br>  Before proceeding, I strongly recommend <a href="http://narod.ru/disk/10838745000/pypi.py.html">downloading the code</a> and reading it fluently.  Also, the code can be viewed online on <a href="http://showmecode.com/code/9833/">Showroom</a> . <br>  To start the server, users of UNIX-like systems can execute the following commands: <br><blockquote>  chmod + x ./pypi.py <br>  ./pypi.py </blockquote><br>  To connect to the server, you can use the following command: <br><blockquote>  telnet 127.0.0.1 45067 </blockquote><br><br><h2>  Parsing code </h2><br>  The core of the application is the main () function, which starts the dispatch cycle of the <a href="http://docs.python.org/library/asyncore.html">asyncore</a> module: <br><blockquote>  <font color="#ff7700">def</font> main <font>(</font> <font>)</font> : <br>  <font color="#ff7700">try</font> : <br>  <font color="#dc143c">asyncore</font> .  <font>loop</font> <font>(</font> <font color="#ff4500">0.1</font> , <font color="#008000">True</font> , Server <font>(</font> <font color="#483d8b">'127.0.0.1'</font> <font>)</font> <font>)</font> <br>  <font color="#ff7700">except</font> <font color="#008000">KeyboardInterrupt</font> : <br>  <font color="#ff7700">print</font> <font color="#483d8b">' <font color="#000099">\ n</font> Bye: - *'</font> <br>  <font color="#dc143c">sys</font> .  <font>exit</font> <font>(</font> <font color="#ff4500">0</font> <font>)</font> <br><br>  <font color="#ff7700">if</font> __name__ == <font color="#483d8b">'__main__'</font> : <br>  main <font>(</font> <font>)</font> <br></blockquote><br>  The asyncore module provides a loop function that accepts four optional arguments: (1) timeout, (2) the preference flag of the poll mechanism over the usual select, (3) the dictionary of socket descriptors, (4) the number of iterations.  Important for us is the third parameter, to which we have transferred functions to the newly created server object. <br><br>  Thanks to the ‚Äúspecial Python magic‚Äù, the Server class is inherited from both the dispatcher class from the asyncore module and the dict dictionary class, which allows it to act simultaneously as a server socket and storage socket descriptors of all connected clients. <br><br>  The start of the Server class declaration looks like this: <br><blockquote>  <font color="#ff7700">class</font> Server <font>(</font> dispatcher, <font color="#008000">dict</font> <font>)</font> : <br>  writable = <font color="#ff7700">lambda</font> x: <font color="#008000">False</font> <br><br>  <font color="#ff7700">def</font> <font color="#0000cd">__init__</font> <font>(</font> <font color="#008000">self</font> , host = <font color="#008000">None</font> , port = 0xB00B <font>)</font> : <br>  dispatcher.  <font color="#0000cd">__init__</font> <font>(</font> <font color="#008000">self</font> <font>)</font> <br><br>  <font color="#008000">self</font> .  <font>create_socket</font> <font>(</font> AF_INET, SOCK_STREAM <font>)</font> <br>  <font color="#008000">dict</font> .  <font color="#0000cd">__init__</font> <font>(</font> <font color="#008000">self</font> , <font>{</font> <font color="#008000">self</font> . <font>fileno</font> <font>(</font> <font>)</font> : <font color="#008000">self</font> <font>}</font> <font>)</font> <br><br>  <font color="#008000">self</font> .  <font>set_reuse_addr</font> <font>(</font> <font>)</font> <br>  <font color="#008000">self</font> .  <font>bind</font> <font>(</font> <font>(</font> host, port <font>)</font> <font>)</font> <br>  <font color="#008000">self</font> .  <font>listen</font> <font>(</font> 0xA <font>)</font> <br><br>  <font color="#008000">self</font> .  <font>dataSource</font> = PiGenerator <font>(</font> <font>)</font> </blockquote><br>  In the constructor, the object is first initialized as a server socket handler, and then as a dictionary consisting of one entry ‚Äî the socket descriptor of the server itself, pointing to the server object.  It is important that the socket is created by the create_socket function <em>before the</em> dictionary is initialized, since  before creating a socket, we could not get its handle.  Then, the server socket is bound to the port on the specified host, a wiretap is started, and a digit generator of the pi number is created, which will later be used to generate a stream of data to the client. <br><br>  After the dispatch cycle is started, the main part of the work falls on the asyncore module, which, when a new client is connected, will call the server object's handle_accept method to handle the incoming connection: <br><blockquote>  <font color="#ff7700">def</font> handle_accept <font>(</font> <font color="#008000">self</font> <font>)</font> : <br>  sock, <font>(</font> host, port <font>)</font> = <font color="#008000">self</font> .  <font>accept</font> <font>(</font> <font>)</font> <br>  <font color="#ff7700">print</font> <font color="#483d8b">'new client from% s:% d'</font> <font color="#66cc66">%</font> <font>(</font> host, port <font>)</font> <br><br>  stream = Stream <font>(</font> <font color="#008000">self</font> . <font>dataSource</font> <font>)</font> <br>  <font color="#008000">self</font> <font>[</font> sock.  <font>fileno</font> <font>(</font> <font>)</font> <font>]</font> = Client <font>(</font> sock, <font color="#008000">self</font> , stream <font>)</font> </blockquote><br>  Inside the handler method, a new client is directly accepted using the accept function, which returns the newly created socket for communication with the client and a pair of host ports from which the connection occurred.  After receiving the client's socket, the server creates a new data stream (implemented by the Stream class) to read data from the generator.  After that, a new client object is added to the list of clients, initialized by the newly created data stream. <br><br>  The client reads data from a stream inside the writable () method: <br><blockquote>  <font color="#ff7700">def</font> writable <font>(</font> <font color="#008000">self</font> <font>)</font> : <br>  data = <font color="#008000">self</font> .  <font>stream</font> .  <font>read</font> <font>(</font> <font>)</font> <br>  <font color="#ff7700">if</font> data == <font color="#008000">None</font> : <br>  <font color="#ff7700">print</font> <font color="#483d8b">'client finished reading'</font> <br>  <font color="#008000">self</font> .  <font>close</font> <font>(</font> <font>)</font> <br>  <font color="#ff7700">return</font> <font color="#008000">false</font> <br><br>  <font color="#008000">self</font> .  <font>buffer</font> + = data <br>  <font color="#ff7700">return</font> <font color="#008000">len</font> <font>(</font> <font color="#008000">self</font> . <font>buffer</font> <font>)</font> <font color="#66cc66">&gt;</font> <font color="#ff4500">0</font> </blockquote><br>  The writable method is called by the asyncore module for each socket before the next iteration of the dispatch loop to find out whether it is necessary to check accessibility for a given socket for writing.  We use this to try to read the data from the stream and report the need to write if there is data in the stream.  If the stream returns None, it means that there will be no more data in it and the socket is closed.  In this example, this situation should not occur, because  numbers are generated infinitely. <br><br>  Learning about the availability of a write operation for the client socket, asyncore calls the handle_write () method, which sends the data previously read from the stream through the socket: <br><blockquote>  <font color="#ff7700">def</font> handle_write <font>(</font> <font color="#008000">self</font> <font>)</font> : <br>  sent = <font color="#008000">self</font> .  <font>send</font> <font>(</font> <font color="#008000">self</font> . <font>buffer</font> <font>)</font> <br>  <font color="#008000">self</font> .  <font>buffer</font> = <font color="#008000">self</font> .  <font>buffer</font> <font>[</font> sent: <font>]</font> </blockquote><br>  The generator and the flow are closely related to each other by implementing the <a href="http://ru.wikipedia.org/wiki/%25D0%259D%25D0%25B0%25D0%25B1%25D0%25BB%25D1%258E%25D0%25B4%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C_%2528%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F%2529">observer</a> pattern.  The generator acts as an observable object and provides the subscribe and unsubscribe methods, respectively, for subscribing to events and unsubscribing from them: <br><blockquote>  <font color="#ff7700">class</font> PiGenerator <font>(</font> <font color="#008000">list</font> <font>)</font> : <br>  <font color="#ff7700">def</font> subscribe <font>(</font> <font color="#008000">self</font> , obj <font>)</font> : <br>  <font color="#008000">self</font> .  <font>lock</font> .  <font>acquire</font> <font>(</font> <font>)</font> <br>  <font color="#ff7700">try</font> : <br>  <font color="#008000">self</font> .  <font>append</font> <font>(</font> obj <font>)</font> <br>  <font color="#008000">self</font> ._notify <font>(</font> obj = obj <font>)</font> <br>  <font color="#ff7700">finally</font> : <br>  <font color="#008000">self</font> .  <font>lock</font> .  <font>release</font> <font>(</font> <font>)</font> <br><br>  <font color="#ff7700">if</font> <font color="#ff7700">not</font> <font color="#008000">self</font> .  <font>calculator</font> : <br>  <font color="#008000">self</font> .  <font>calculator</font> = PiCalcThread <font>(</font> <font color="#008000">self</font> , <font color="#008000">self</font> . <font>lock</font> <font>)</font> <br>  <font color="#008000">self</font> .  <font>calculator</font> .  <font>start</font> <font>(</font> <font>)</font> <br>  <font color="#ff7700">else</font> : <br>  <font color="#ff7700">if</font> <font color="#008000">len</font> <font>(</font> <font color="#008000">self</font> <font>)</font> <font color="#66cc66">&gt;</font> <font color="#ff4500">0</font> : <br>  <font color="#008000">self</font> ._resumeCalculator <font>(</font> <font>)</font> <br><br>  <font color="#ff7700">def</font> unsubscribe <font>(</font> <font color="#008000">self</font> , obj <font>)</font> : <br>  <font color="#008000">self</font> .  <font>lock</font> .  <font>acquire</font> <font>(</font> <font>)</font> <br>  <font color="#008000">self</font> .  <font>remove</font> <font>(</font> obj <font>)</font> <br>  <font color="#008000">self</font> .  <font>lock</font> .  <font>release</font> <font>(</font> <font>)</font> <br><br>  <font color="#ff7700">if</font> <font color="#008000">len</font> <font>(</font> <font color="#008000">self</font> <font>)</font> <font color="#66cc66">&lt;</font> = <font color="#ff4500">0</font> : <br>  <font color="#008000">self</font> ._pauseCalculator <font>(</font> <font>)</font> </blockquote><br>  The generation of numbers is directly implemented by a separate class PiCalcThread, which performs calculations in a separate thread, therefore, a lock mechanism is used to synchronize the operations of adding and deleting a subscription.  Using the same lock object, the thread is suspended in the absence of subscribed threads.  When a new thread is subscribed using the _notify () method, the digits counted and saved to it are sent to it, if it is not the first subscribed thread. <br><br>  The _notify () method runs over the subscribed threads and calls the update method, passing new digits to the stream: <br><blockquote>  <font color="#ff7700">def</font> _notify <font>(</font> <font color="#008000">self</font> , digits = <font color="#008000">None</font> , obj = <font color="#008000">None</font> <font>)</font> : <br>  objs = <font>[</font> obj <font>]</font> <font color="#ff7700">if</font> obj <font color="#ff7700">else</font> <font color="#008000">self</font> <br>  digits = digits <font color="#ff7700">or</font> <font color="#008000">self</font> .  <font>digits</font> <br><br>  <font color="#ff7700">for</font> obj <font color="#ff7700">in</font> objs: <br>  obj.  <font>update</font> <font>(</font> digits <font>)</font> </blockquote><br>  The update () method of the stream simply adds new data to the existing ones: <br><blockquote>  <font color="#ff7700">def</font> update <font>(</font> <font color="#008000">self</font> , data <font>)</font> : <br>  <font color="#008000">self</font> .  <font>data</font> + = data </blockquote><br>  The digit generation flow class of Pi uses the algorithm proposed by Jeremy Gibbons in the <a href="http://web.comlab.ox.ac.uk/oucl/work/jeremy.gibbons/publications/spigot.pdf">Unbounded Spigot Algorithm for the Digits of Pi</a> document: <br><blockquote>  <font color="#ff7700">class</font> PiCalcThread <font>(</font> Thread <font>)</font> : <br>  <font color="#ff7700">def</font> <font color="#0000cd">__init__</font> <font>(</font> <font color="#008000">self</font> , buffer, lock <font>)</font> : <br>  Thread.  <font color="#0000cd">__init__</font> <font>(</font> <font color="#008000">self</font> <font>)</font> <br>  <font color="#008000">self</font> .  <font>buffer</font> = buffer <br>  <font color="#008000">self</font> .  <font>lock</font> = lock <br><br>  <font color="#ff7700">def</font> run <font>(</font> <font color="#008000">self</font> <font>)</font> : <br>  q, r, t, k, n, l = <font color="#ff4500">1</font> , <font color="#ff4500">0</font> , <font color="#ff4500">1</font> , <font color="#ff4500">1</font> , <font color="#ff4500">3</font> , <font color="#ff4500">3</font> <br><br>  <font color="#ff7700">while</font> <font color="#008000">true</font> : <br>  <font color="#ff7700">if</font> <font color="#ff4500">4</font> <font color="#66cc66">*</font> q + rt <font color="#66cc66">&lt;</font> n <font color="#66cc66">*</font> t: <br>  <font color="#008000">self</font> .  <font>lock</font> .  <font>acquire</font> <font>(</font> <font>)</font> <br>  <font color="#008000">self</font> .  <font>buffer</font> .  <font>newDigits</font> <font>(</font> <font color="#008000">str</font> <font>(</font> n <font>)</font> <font>)</font> <br>  <font color="#008000">self</font> .  <font>lock</font> .  <font>release</font> <font>(</font> <font>)</font> <br><br>  q, r, t, k, n, l = <font>(</font> <font color="#ff4500">10</font> <font color="#66cc66">*</font> q, <font color="#ff4500">10</font> <font color="#66cc66">*</font> <font>(</font> rn <font color="#66cc66">*</font> t <font>)</font> , t, k, <font>(</font> <font color="#ff4500">10</font> <font color="#66cc66">*</font> <font>(</font> <font color="#ff4500">3</font> <font color="#66cc66">*</font> q + r <font>)</font> <font>)</font> / t - <font color="#ff4500">10</font> <font color="#66cc66">*</font> n, l <font>)</font> <br>  <font color="#ff7700">else</font> : <br>  q, r, t, k, n, l = <font>(</font> q <font color="#66cc66">*</font> k, <font>(</font> <font color="#ff4500">2</font> <font color="#66cc66">*</font> q + r <font>)</font> <font color="#66cc66">*</font> l, t <font color="#66cc66">*</font> l, k + <font color="#ff4500">1</font> , <font>(</font> q <font color="#66cc66">*</font> <font>(</font> <font color="#ff4500">7</font> <font color="#66cc66">*</font> k + <font color="#ff4500">2</font> <font>)</font> + r <font color="#66cc66">*</font> l <font>)</font> / <font>(</font> t <font color="#66cc66">*</font> l <font>)</font> , l + <font color="#ff4500">2</font> <font>)</font> <br><br>  <font color="#dc143c">time</font> .  <font>sleep</font> <font>(</font> <font color="#ff4500">0.001</font> <font>)</font> </blockquote><br>  The run () method infinitely calculates the next digit of the Pi number and again, using a lock, reports it to the generator, which in turn passes it to the data streams subscribing to the generator.  An artificial delay is added so that the server does not generate too much data flow per unit time. <br><br>  To highlight the syntax in the preparation of the material used resource <a href="http://highlight.hohli.com/">http://highlight.hohli.com/</a> .  I really hope that this article will be useful to someone, although the description turned out to be muddled with a sufficiently large amount. </div><p>Source: <a href="https://habr.com/ru/post/64229/">https://habr.com/ru/post/64229/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../64220/index.html">Successful Twitter Recipe</a></li>
<li><a href="../64221/index.html">Usability of ATMs and express payment terminals</a></li>
<li><a href="../64223/index.html">OpenSource Electronic diaries system</a></li>
<li><a href="../64224/index.html">Setting VIM indents</a></li>
<li><a href="../64227/index.html">Photosounder: editing a sonogram</a></li>
<li><a href="../64230/index.html">iWallet - wallet with memory</a></li>
<li><a href="../64231/index.html">How to legalize iPhone, imported into Ukraine from abroad</a></li>
<li><a href="../64236/index.html">Holiday sale!</a></li>
<li><a href="../64238/index.html">GNU or Linux?</a></li>
<li><a href="../64239/index.html">Question Win7 connoisseurs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>