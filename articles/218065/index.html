<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ceph: Cloud Storage without compromise</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear readers! 

 Modern clouds used for hosting purposes raise the bar for storage infrastructure requirements high. In order for a client to r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ceph: Cloud Storage without compromise</h1><div class="post__text post__text-html js-mediator-article">  Hello, dear readers! <br><br>  Modern clouds used for hosting purposes raise the bar for storage infrastructure requirements high.  In order for a client to receive a quality service, a variety of properties must be inherent in the storage system: <br><ul><li>  high storage reliability </li><li>  high availability of data, i.e. minimal downtime during accidents </li><li>  high access speed and minimal delays </li><li>  low storage cost </li><li>  various application features: cloning, snapshots, etc. </li></ul><br>  Neither RAID-arrays, nor "iron" storage systems are able to solve all the listed tasks simultaneously.  That is why Software-defined storage is becoming increasingly common in the hosting industry.  One of the brightest representatives of SDS is a distributed repository called Ceph. <br><br>  We decided to tell about this wonderful product, which is used in <a href="http://www.inktank.com/customers/">CERN</a> , <a href="http://habrahabr.ru/company/2gis/blog/199504/">2GIS</a> , <a href="http://habrahabr.ru/company/mailru/blog/215691/">Mail.ru</a> and in our <a href="http://flops.ru/">cloud hosting</a> . <br><img src="https://habrastorage.org/getpro/habr/post_images/511/21a/c56/51121ac560d6b80153bc45277687f2c2.jpg" alt="image"><br><a name="habracut"></a><br><h4>  What is Ceph? </h4><br>  Ceph is a fault-tolerant distributed data storage operating over TCP.  One of the basic properties of Ceph is scalability to petabyte sizes.  Ceph provides a choice of three different abstractions for working with storage: an abstraction of object storage (RADOS Gateway), a block device (RADOS Block Device) or a POSIX-compatible file system (CephFS). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  Object Storage Abstraction </h6><br>  The object storage abstraction (RADOS Gateway, or RGW) together with the FastCGI server allows using Ceph to store user objects and provides an API that is compatible with S3 / Swift.  Habr√© already had <a href="http://habrahabr.ru/post/180415/">an article</a> on how to quickly configure Ceph and RGW.  In the object storage mode, Ceph has long been successfully used in production by a number of companies. <br><br><h6>  Block device abstraction </h6><br>  The abstraction of a block device (originally RADOS Block Device, or RBD) allows the user to create and use virtual block devices of arbitrary size.  The RBD software interface allows you to work with these devices in read / write mode and perform service operations ‚Äî resizing, cloning, creating and returning to a snapshot, etc. <br><br>  The QEMU hypervisor contains a driver for working with Ceph and provides virtual machines with access to RBD block devices.  Therefore, Ceph is now supported in all popular cloud orchestration solutions - OpenStack, CloudStack, ProxMox.  RBD is also ready for industrial use. <br><br><h6>  Abstraction of a POSIX-compatible file system </h6><br>  CephFS is a POSIX-compatible file system that uses Ceph as storage.  Despite the fact that CephFS is not production-ready and does not yet have a significant industrial application, here on Habr√© there is already an <a href="http://habrahabr.ru/post/179823/">instruction for setting it up</a> . <br><br><h4>  Terminology </h4><br>  Below are the main entities of Ceph. <br><br>  <b>Metadata server (MDS)</b> is an auxiliary daemon to ensure the synchronous state of files at CephFS mount points.  The active copy + reserves scheme works, and there is only one active copy within the cluster. <br><br>  <b>Mon (Monitor)</b> is an element of Ceph infrastructure that provides data addressing within the cluster and stores information about the topology, state and distribution of data within the repository.  A client wishing to access a rbd block device or a file on a mounted cephfs receives from the monitor the name and position of the rbd header, a special object that describes the position of other objects related to the requested abstraction (block device or file) and then communicates with all the OSDs involved in file storage. <br><br>  <b>Object (Object)</b> - a block of data of a fixed size (4 MB by default).  All information stored in Ceph is quantized by such blocks.  To avoid confusion, we emphasize that these are not user objects from Object Storage, but objects used for the internal presentation of data in Ceph. <br><br>  <b>OSD (object storage daemon)</b> is an entity that is responsible for storing data, the main building block of a Ceph cluster.  Multiple OSDs can be located on one physical server, each of which has a separate physical data storage. <br><br>  <b>An OSD map (OSD Map)</b> is a map that associates to each placement group a set of one Primary OSD and one or more Replica OSD.  The distribution of placement groups (PG) across the OSD storage nodes is described by an osdmap map slice, which shows the positions of all PGs and their replicas.  Each change in the location of the PG in the cluster is accompanied by the release of a new OSD card, which is distributed to all participants. <br><br>  <b>A Placement Group (PG)</b> is a logical group that unites a variety of objects, designed to simplify addressing and synchronization of objects.  Each object is only in one placement group.  The number of objects participating in the placement group is not regulated and may vary. <br><br>  <b>Primary OSD</b> - The OSD selected as the Primary for this placement group.  Client IO is always served by the OSD, which is Primary for the placement of the group in which the client is interested in a data block (object).  Asynchronous Primary OSD replicates all data to Replica OSD. <br><br>  <b>RADOS Gateway (RGW)</b> is an auxiliary daemon acting as a proxy for the supported object storage APIs.  It supports geographically separated installations (for different pools, or, in Swift view, regions) and active-backup mode within the same pool. <br><br>  <b>Replica OSD (Secondary)</b> - OSD, which is not Primary for this placement group and is used for replication.  The client never communicates with them directly. <br><br>  <b>Replication factor (RF)</b> - data storage redundancy.  The replication factor is an integer and shows how many copies of the same object a cluster stores. <br><br><h4>  Ceph architecture </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/c91/dd9/4f5/c91dd94f5f299352fb6535dc2a0f2926.png" alt="arch-diag1"><br><br>  The main types of daemons in Ceph are two - monitors (MON) and storage-nodes (OSD).  RGW and MDS daemons do not participate in data distribution, being ancillary services.  Monitors are combined into a quorum and communicate over a <a href="http://en.wikipedia.org/wiki/Paxos_%2528computer_science%2529">PAXOS-like</a> protocol.  Actually, the cluster is operational as long as the majority of participants of the configured quorum remains in it, that is, in a split-brain situation in the middle and an even number of participants, only one part will survive, because the previous elections in PAXOS automatically reduced the number of active participants to an odd number .  If most of the quorum is lost, the cluster is ‚Äúfrozen‚Äù for any operations, preventing possible discrepancy of the recorded or read data until the minimum quorum is restored. <br><br><h4>  Data Recovery and Rebalance </h4><br>  The loss of the appearance of one of the copies of the object leads to the transition of the object and the placement group containing it to the degraded state and to release a new OSD (osdmap).  The new map contains the new location of the lost copy of the object and, if after a specified time the lost copy does not return, the missing copy will be restored elsewhere to keep the number of copies determined by the replication factor.  Operations performed at the time of such an error will automatically switch to one of the available copies.  In the worst case, their delay will be measured in units of seconds. <br><br>  An important feature of Ceph is that all cluster rebalancing operations take place in the background simultaneously with user I / O.  If the client accesses an object that is in the recovering state, Ceph will out of the queue restore the object and its copies, and then execute the client's request.  This approach ensures minimal latency I / O, even when the cluster recovery is in full swing. <br><br><h4>  Cluster data distribution </h4><br>  One of the most important features of Ceph is the ability to fine-tune replication set by the <a href="http://ceph.com/docs/master/rados/operations/crush-map/">CRUSH</a> rules ‚Äî a powerful and flexible mechanism based on <a href="http://en.wikipedia.org/wiki/Jenkins_hash_function">randomly</a> distributed PG across the OSD group based on the rules (weight, state of node, ban on placement in the same group of nodes).  By default, OSDs have a weight based on the amount of free space at the corresponding mount point at the time the OSD is inserted into the cluster and obey the data distribution rule, which prohibits keeping two copies of one PG on one node.  CRUSHMAP - a description of the distribution of data - can be modified under the rules that prohibit keeping the second copy within the same rack, thereby ensuring fault tolerance at the departure level of the entire rack. <br><br>  Theoretically, this approach allows for real-time geo-replication, but in practice this can only be used in Object Storage mode, since in CephFS and RBD modes, operation delays will be too great. <br><br><h4>  Alternatives and Benefits of Ceph </h4><br>  The most qualitative and congenial free cluster FS are GlusterFS.  It is supported by RedHat and has some advantages (for example, localizes Primary a copy of the data next to the client).  However, our tests showed some lag of GlusterFS in terms of performance and poor responsiveness when rebuilding.  Other serious disadvantages are the lack of CoW (including in the forecasted future) and low community activity. <br><br>  The advantage of Ceph over other cluster storage systems is the lack of single points of failure and almost zero maintenance costs for recovery operations.  Redundancy and resistance to accidents laid at the level of design and gets a gift. <br><br>  Possible replacements are divided into two types - cluster fs for supercomputers (GPFS / Luster / etc.) And cheap centralized solutions like iSCSI or NFS.  The first type is rather difficult to maintain and is not sharpened to operate in conditions of failed equipment - freezing I / O, which is especially sensitive when exporting a mount point to a computational node, does not allow the use of similar fs in the public segment.  The drawbacks of ‚Äúclassic‚Äù solutions are fairly well understood - the lack of scalability and the need to lay out a topology for failover at the hardware level, which leads to an increase in cost. <br><br>  With Ceph, restoring and rebuilding a cluster is really unnoticeable, with virtually no impact on client I / O.  That is, the degraded cluster for Ceph is not an extraordinary situation, but just one of the working states.  As far as we know, no other open source software storage system has this feature sufficient for its use in the public cloud, where the planned cessation of service is impossible. <br><br><h4>  Performance </h4><br>  As mentioned at the beginning of the article, the data in Ceph are quantized in fairly small portions and pseudo-randomly distributed over OSD.  This leads to the fact that the real I / O of each Ceph client is fairly evenly spread across all the disks in the cluster.  As a result: <br><ol><li>  Reduces the intensity of the struggle between customers for disk resource </li><li>  The upper bar of the theoretically possible intensity of work with the block device grows </li><li>  As a result of Clauses 1 and 2, each client receives significantly higher specific limits on iops and bandwidth than the classical approach can give for the same money. </li></ol><br>  There are other reasons for Ceph performance.  All write operations first get into the OSD log, and then, without delaying the client, are asynchronously transferred to the persistent file storage.  Therefore, placing a log on an SSD that is recommended in the Ceph documentation speeds up write operations many times over. <br><br><h4>  Goals and Results </h4><br>  Two years ago, Ceph bribed us with its impressive capabilities.  Although many of them at that time did not work perfectly, we decided to build a cloud on it.  In the following months, we faced a number of problems that gave us a lot of unpleasant moments. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2bb/cd1/7fe/2bbcd17fe4552b373b2c0afe53282963.gif" alt="image"><br><br>  For example, immediately after the <a href="http://habrahabr.ru/company/performix/blog/166839/">public release a</a> year ago, we found that rebuilding a cluster affects its responsiveness more than we would like.  Or that a certain type of operation leads to a significant increase in the latency of subsequent operations.  Or that in certain (fortunately, rare) conditions, the client virtual machine may hang on the I / O.  Anyway, the bugfix for half a year has done its job, and today we are absolutely confident in our storage system.  Well, in the process of eliminating difficulties, we acquired a number of debugging and monitoring tools.  One of them is the monitoring of the duration of all operations with block devices (at the moment the cluster serves several thousand read / write operations every second).  This is what the report on the latency in our admin panel looks like today: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/747/c7c/e34/747c7ce34e3386696523915470452e93.png" alt="image"><br>  The minimum duration of operations is marked green on the graph, the maximum is red, the median is turquoise.  Impressive, isn't it? <br><br>  Although the data storage system has long been absolutely stable, these tools still help us in solving everyday tasks and at the same time confirm the excellent quality of our service with numbers. <br><br>  Ultimately, Ceph allowed us to provide: <br><ul><li>  reduced IO latency to good local SSD values </li><li>  upgrade of all storage disks from 1Tb to 4Tb models in a mode imperceptible for users </li><li>  hardware failure of one node is invisible to users as an event </li><li>  thanks to live migration and using Ceph hardware and software updates occur with zero downtime </li><li>  snapshots, cloning, incremental diffs have found their application in production and delight customers </li><li>  ultra low prices for services </li></ul><br>  Flops.ru remains the only one in Russia and one of the few hosters in the world who use Ceph in production.  Thanks to Ceph, we succeeded in realizing what the visionary posts often write about the future of clouds - to combine computational nodes and storage nodes on regular hardware and achieve indicators close to the values ‚Äã‚Äãof enterprise "shelves" without increasing cost.  Well, since the money saved is the same as the money earned, we were able to reduce the prices of services to almost the level of Western discounters.  This is easily seen by looking at our rates. <br><br>  If you use dedicated hosting in your work - we suggest you try our services in action and evaluate the benefits of Ceph.  You do not need to pay anything - a two-week trial period and a test balance of 500 rubles can be activated immediately after registration. <br><br>  In the following posts we will look at the practical side of using Ceph, talk about the features that have appeared in our country over the past year (and there are a lot of them) and dwell in more detail on the benefits of using SSD. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/218065/">https://habr.com/ru/post/218065/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../218053/index.html">Symmetry numbers</a></li>
<li><a href="../218055/index.html">How to celebrate Cosmonautics Day?</a></li>
<li><a href="../218057/index.html">A small toy "Minesweeper" not in 30 lines</a></li>
<li><a href="../218061/index.html">Do not make (in) equality in JavaScript look worse than they are.</a></li>
<li><a href="../218063/index.html">Distributed video encoding</a></li>
<li><a href="../218067/index.html">Build 2014. Hot news for Windows and Windows Phone developers</a></li>
<li><a href="../218073/index.html">The working environment "Deodar" for Linux</a></li>
<li><a href="../218075/index.html">Scientists have received new images of brain neurons</a></li>
<li><a href="../218085/index.html">Net neutrality: is there a boy?</a></li>
<li><a href="../218087/index.html">Internet Explorer 11 for Windows updates and IE11 announcement for Windows Phone 8.1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>