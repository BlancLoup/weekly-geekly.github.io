<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing reference counting or life without GC (almost)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, Habr! 

 Many people think that the system language and the garbage collector are incompatible concepts. In some situations, indeed, the col...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing reference counting or life without GC (almost)</h1><div class="post__text post__text-html js-mediator-article"> Good day, Habr! <br><br>  Many people think that the system language and the garbage collector are incompatible concepts.  In some situations, indeed, the collector may cause some problems. <br><br>  As you most likely <a href="https://habrahabr.ru/post/260151/">know</a> , in D the garbage collector is partly optional.  But manual memory management is the last century. <br>  Therefore, today I will show how you can implement garbage collection yourself through a ‚Äúsemi-automatic‚Äù reference counting, as well as at the same time minimize calls to the built-in garbage collection runtime based on memory scanning. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  We will solve the problem of counting references to pointers, classes and arrays. <br>  Two things should be discussed right away: why we will not completely reject GC in this article and why reference counting is ‚Äúsemi-automatic‚Äù. <br>  A complete rejection of GC implies the use of the @nogc attribute for the entire code, but there is one BUT.  The <code>IAllocator</code> interface, which we will use, allows us to create and destroy class instances correctly with a single command (correctly, calling all constructors and all destructors of the class hierarchy), but the functions that do this are not marked as @nogc and not to inflate the article implement them independently (partly in the last article it was considered). <br>  Reference counting will be ‚Äúsemi-automatic‚Äù, since at this stage of language development it is impossible to automatically execute some code when transferring or assigning reference types (classes and arrays), therefore we will call this code ourselves, but we will try to make it as hidden as possible. <br><br>  Let's start with the implementation of allocator. <br><pre> <code class="hljs perl">static this() { RC.affixObj = allocatorObject(RC.affix); } //    struct RC { static: alias affix = AffixAllocator!(Mallocator,size_t,size_t).instance; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    IAllocator affixObj; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      auto make(T,A...)( auto <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> A args ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> incRef( affixObj.make!T(args) ); } //      ,     private void dispose(T)( T* p ) { affixObj.dispose(p); } private void dispose(T)( T p ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( is(T == class) || is(T == interface) ) { affixObj.dispose(p); } // affix.prefix( void[] p ),  p --   , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      ,     <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> size_t refCount(T)( T p ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( is(T == class) || is(T == interface) ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> affix.prefix( (cast(void*)p)[<span class="hljs-number"><span class="hljs-number">0</span></span>..__traits(classInstanceSize,T)] ); } <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> size_t refCount(T)( T* p ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> affix.prefix( (cast(void*)p)[<span class="hljs-number"><span class="hljs-number">0</span></span>..T.sizeof] ); } //  ,     auto incRef(T)( auto <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> T p ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( p is null ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; refCount(p)++; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; } //  ,    , null    <span class="hljs-number"><span class="hljs-number">0</span></span> auto decRef(T)( T p ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( p is null ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( refCount(p) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ) { refCount(p)--; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( refCount(p) == <span class="hljs-number"><span class="hljs-number">0</span></span> ) { dispose(p); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; } }</code> </pre><br>  At the core of our allocator is the <code>Mallocator</code> , an allocator that works through C-shny <code>malloc</code> and <code>free</code> .  We wrapped it in <code>AffixAllocator</code> .  It is parameterized by the present real allocator and 2 data types.  When allocating <code>AffixAllocator</code> allocate a little more: the size of the <code>Prefix</code> and <code>Suffix</code> types (respectively, the second and third template parameters).  As you can guess, the prefix is ‚Äã‚Äãlocated before the memory allocated for the object, and the suffix after.  In our case, <code>Prefix</code> and <code>Suffix</code> are <code>size_t</code> , and just the prefix will impersonate the reference count. <br>  Such an approach allows using existing classes without modification, since information on the number of links is stored outside the object. <br><br>  Now we can create and destroy class objects and pointers using our allocator. <br><pre> <code class="hljs pgsql"> auto p = RC.make!<span class="hljs-type"><span class="hljs-type">int</span></span>( <span class="hljs-number"><span class="hljs-number">10</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">is</span></span>( typeof(p) == <span class="hljs-type"><span class="hljs-type">int</span></span>* ) ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( *p == <span class="hljs-number"><span class="hljs-number">10</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( RC.refCount(p) == <span class="hljs-number"><span class="hljs-number">1</span></span> ); p = RC.decRef(p); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( p <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> );</code> </pre><br>  Already something, but for the time being it is not interesting: only make increments the counter for us, then increment and decriminalize it ourselves. <br><br>  Add a wrapper that will do some things for us. <br><pre> <code class="hljs coffeescript">struct RCObject(T) { T obj; alias obj <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ,    obj     RCObject <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) { incRef(); } <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   --   <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>( T o ) { obj = o; incRef(); } <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    --   <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>            (     RC.make) package static auto make( T o ) { RCObject!T ret; ret.obj = o; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> nothrow       std.experimental.allocator ~<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>() nothrow { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( obj <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> decRef(); <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception e) { <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> std.experimental.logger; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> errorf( <span class="hljs-string"><span class="hljs-string">"ERROR: "</span></span>, e ); <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception e) {} } } void incRef() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( obj <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; RC.incRef(obj); } <span class="hljs-regexp"><span class="hljs-regexp">///  obj         void decRef() { if( obj is null ) return; assert( refCount &gt; 0, "not null object have 0 refs" ); obj = RC.decRef(obj); } size_t refCount() @property const { if( obj is null ) return 0; return RC.refCount(obj); } //        ,      void opAssign(X=this)( auto ref RCObject!T r ) { decRef(); obj = r.obj; incRef(); } ///</span></span>        T,   void opAssign(X=<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)( auto ref T r ) { decRef(); obj = r; incRef(); } } <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   auto rcMake(T,A...)( A args ){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RCObject!(T).make( RC.make!T(args) ); }</code> </pre><br>  Now we have scope-dependent reference counting and we can do this: <br><pre> <code class="hljs swift"> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ch</span></span></span><span class="hljs-class"> </span></span>{ } { <span class="hljs-type"><span class="hljs-type">RCObject!</span></span><span class="hljs-type"><span class="hljs-type">Ch</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>; { auto a = rcMake!<span class="hljs-type"><span class="hljs-type">Ch</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span>( a.refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); auto b = a; <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span>( a.refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span>( b.refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> = a; <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span>( a.refCount == <span class="hljs-number"><span class="hljs-number">3</span></span> ); <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span>( b.refCount == <span class="hljs-number"><span class="hljs-number">3</span></span> ); <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>.refCount == <span class="hljs-number"><span class="hljs-number">3</span></span> ); b = rcMake!<span class="hljs-type"><span class="hljs-type">Ch</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span>( a.refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span>( b.refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>.refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); b = rcMake!<span class="hljs-type"><span class="hljs-type">Ch</span></span>(); <span class="hljs-comment"><span class="hljs-comment">//    ,    assert( a.refCount == 2 ); assert( b.refCount == 1 ); assert( c.refCount == 2 ); } assert( c.refCount == 1 ); }</span></span></code> </pre><br>  This is already something!  But what about the arrays?  Add work with arrays to our allocator: <br><pre> <code class="hljs cs">... <span class="hljs-function"><span class="hljs-function">T[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeArray</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T,A...</span></span></span><span class="hljs-function">)(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> size_t length </span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> incRef( affixObj.makeArray!T(length) ); } <span class="hljs-function"><span class="hljs-function">T[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeArray</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T,A...</span></span></span><span class="hljs-function">)(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> size_t length, auto </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T init </span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> incRef( affixObj.makeArray!T(length,init) ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T</span></span></span><span class="hljs-function">)(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> T[] arr </span></span></span><span class="hljs-function">)</span></span> { affixObj.dispose(arr); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ref</span></span></span><span class="hljs-function"> size_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refCount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T</span></span></span><span class="hljs-function">)(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> T[] arr </span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> affix.prefix( cast(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>[])arr ); } ...</code> </pre><br>  And we implement a wrapper for arrays. <br><div class="spoiler">  <b class="spoiler_title">It is not much different from object wrapping.</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">struct RCArray(T) { //    ,   private T[] orig; //      T[] <span class="hljs-keyword"><span class="hljs-keyword">work</span></span>; private <span class="hljs-type"><span class="hljs-type">void</span></span> init( T[] origin, T[] <span class="hljs-keyword"><span class="hljs-keyword">slice</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">slice</span></span> !<span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">slice</span></span>.ptr &gt;= origin.ptr &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">slice</span></span>.ptr &lt; origin.ptr + origin.length, "slice is not in original" ); orig = origin; incRef(); <span class="hljs-keyword"><span class="hljs-keyword">work</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">slice</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? orig : <span class="hljs-keyword"><span class="hljs-keyword">slice</span></span>; static <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( isRCType!T ) //     <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> w; <span class="hljs-keyword"><span class="hljs-keyword">work</span></span> ) w.incRef; //      } /// <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> <span class="hljs-keyword"><span class="hljs-keyword">work</span></span> this; this(this) { incRef(); }   this( T[] orig, T[] <span class="hljs-keyword"><span class="hljs-keyword">slice</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ) { init( orig, <span class="hljs-keyword"><span class="hljs-keyword">slice</span></span> ); } /// <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> <span class="hljs-keyword"><span class="hljs-keyword">increment</span></span> ref package static auto make( T[] o ) { RCArray!T ret; ret.orig = o; ret.work = o; return ret; } //    auto opSlice( size_t i, size_t j ) { return RCArray!T( orig, work[i..j] ); } void opAssign(X=this)( auto ref RCArray!T arr ) { decRef(); init( arr.orig, arr.work ); } void incRef() { if( orig is null ) return; RC.incRef(orig); } void decRef() { if( orig is null ) return; assert( refCount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, "not null object have 0 refs" ); orig = RC.decRef(orig); } size_t refCount() @property const { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( orig <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RC.refCount(orig); } ~this() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( refCount ) { //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ) { static <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( isRCType!T ) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> w; orig ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( w.refCount ) w.incRef; } static <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( isRCType!T ) //    <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> w; <span class="hljs-keyword"><span class="hljs-keyword">work</span></span> ) w.decRef; decRef; } } } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> isRCType(T) { static <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">is</span></span>( TE == RCObject!X, X ) || <span class="hljs-keyword"><span class="hljs-keyword">is</span></span>( TE == RCArray!X, X ) ) enum isRCType = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> enum isRCType = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre><br></div></div><br>  but there are some fundamental points: <ol><li>  in a wrapper for arrays we store an array of allocated memory and a working slice </li><li>  in the constructor, if the elements are wrappers, increase the reference count for the elements of the working slice </li><li>  in the destructor in the same situation we reduce </li></ol><br>  Also in the destructor there is a small logical hack: let's say we only have a cut of the array, and the wrapper on the original array has sunk into oblivion.  Then it turns out that the reference counter for <code>orig</code> is 1, which means that if the serse is also deleted, then <code>dispose</code> will be called for the original ( <code>orig</code> ) array, this will result in objects taken from the original array but not falling into will reduce the number of references and can be deleted.  To prevent this from happening, we add +1 to each element that already has more than 1. Then there will be a decrease in the working set, this will allow to leave 1 more for the elements of the original array that were not included in the working set and when the original array was deleted, their counter will not reach zero. <br><br>  All this together allows us to do these things: <br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> A { <span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>; this( <span class="hljs-type"><span class="hljs-type">int</span></span> i ) { <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>=i; } } <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> RCA = RCObject!A; { RCA obj; { RCArray!RCA tmp1; { RCArray!RCA tmp2; { auto arr = rcMakeArray!RCA(<span class="hljs-number"><span class="hljs-number">6</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>( <span class="hljs-type"><span class="hljs-type">int</span></span> i, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> a; arr ) a = rcMake!A(i); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">0</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">1</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">2</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">3</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">4</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">5</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); tmp1 = arr[<span class="hljs-number"><span class="hljs-number">1.</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">0</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">1</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">2</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">3</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">4</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">5</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); tmp2 = arr[<span class="hljs-number"><span class="hljs-number">3.</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">0</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">1</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">2</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">3</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">3</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">4</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">5</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); obj = tmp2[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">0</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">1</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">2</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">3</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">4</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">4</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( arr[<span class="hljs-number"><span class="hljs-number">5</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( tmp1[<span class="hljs-number"><span class="hljs-number">0</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( tmp1[<span class="hljs-number"><span class="hljs-number">1</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( tmp1[<span class="hljs-number"><span class="hljs-number">2</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">3</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( obj.refCount == <span class="hljs-number"><span class="hljs-number">3</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( tmp2[<span class="hljs-number"><span class="hljs-number">0</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">3</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( tmp2[<span class="hljs-number"><span class="hljs-number">0</span></span>].obj.<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> == <span class="hljs-number"><span class="hljs-number">3</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( tmp2[<span class="hljs-number"><span class="hljs-number">1</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( tmp2[<span class="hljs-number"><span class="hljs-number">1</span></span>].obj.<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> == <span class="hljs-number"><span class="hljs-number">4</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( tmp1[<span class="hljs-number"><span class="hljs-number">0</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( tmp1[<span class="hljs-number"><span class="hljs-number">1</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( tmp1[<span class="hljs-number"><span class="hljs-number">2</span></span>].refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( obj.refCount == <span class="hljs-number"><span class="hljs-number">2</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>( obj.refCount == <span class="hljs-number"><span class="hljs-number">1</span></span> ); } //        <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br>  Although the code is not marked as <code>@nogc</code> , it does not refer to the embedded GC.  And as we know, <s>don‚Äôt touch and don‚Äôt smell,</s> don‚Äôt excrete through GC and it will not collect. <br><br>  That's all, I hope you have something new podcherpnuli) <br><br>  The code is designed as a <a href="https://code.dlang.org/packages/rc">dub</a> package. <br>  Sorts on <a href="https://github.com/deviator/rc">github</a> . <br><br>  This is not a finished library, but for now just a sketch, it requires many more improvements. <br>  I would be very happy to help, if not by deed, so by advice. </div><p>Source: <a href="https://habr.com/ru/post/304074/">https://habr.com/ru/post/304074/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../304060/index.html">Record of the webinar "What's new in Kerio Control 9.1"</a></li>
<li><a href="../304062/index.html">Comparison of eCPM ad networks on personal experience</a></li>
<li><a href="../304068/index.html">"Cloud Technologies in Russia" - the first joint forum of Huawei and RUVDS was held in Moscow</a></li>
<li><a href="../304070/index.html">Secrets of the most effective people (part 2)</a></li>
<li><a href="../304072/index.html">dlang-requests - type python-requests, only for D</a></li>
<li><a href="../304078/index.html">Making a cool Single Page Application on basis.js - part 1, introductory theoretical</a></li>
<li><a href="../304080/index.html">Knocking out to government agencies or what to do if in the open data someone is wrong?</a></li>
<li><a href="../304082/index.html">Developing a script to compare people's tastes</a></li>
<li><a href="../304090/index.html">Russian Post delivers - you are now laughing, but it‚Äôs the most reliable</a></li>
<li><a href="../304092/index.html">Passed the hackathon on the Yii Framework in TACC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>