<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>APT1: resistant intrusion pattern</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last part of our material on the Mandiant report on the APT1 group, we talked about the main findings that were made by the company at the conc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>APT1: resistant intrusion pattern</h1><div class="post__text post__text-html js-mediator-article">  In the last part of our material on the Mandiant report on the APT1 group, we talked about the main findings that were made by the company at the conclusion of the investigation.  We will not repeat this information again, you can read it <a href="http://habrahabr.ru/company/eset/blog/170285/">here</a> .  In today's post we will talk about the internal structure of this attack and the schemes that were used to compromise and invade networks of enterprises.  We also note that, from the point of view of the possibilities of malicious code, these attacks do not represent anything conceptually new and the schemes that have been used have been known for a long time. <br><br><a name="habracut"></a><img src="https://habrastorage.org/storage2/59c/769/a21/59c769a21bda99981e78efc589b4d41d.jpg"><br><br>  <b>Nature of attack</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  APT1 has a well-defined attack methodology, honed over the years and focused on stealing huge amounts of information.  The attack begins with aggressive phishing, with which malicious code is delivered to the victim‚Äôs computer, and ends with the theft of data that is compressed and sent to the APT1 servers.  This cycle can be repeated several times.  The malicious code families that participated in these attacks were constantly updated and refined.  APT1 used the adaptation or targeting scheme of these attacks for a specific environment, which made them rather effective.  In addition, immediately before the attack begins, so-called initial intelligence is carried out, i.e., gathering information about a potential victim company and its employees.  This allows you to achieve a certain level of targeting. <br></blockquote><br>  <b>"Letter for you"</b> <br><br><blockquote>  The initial compromise is the method by which attackers make initial penetration into the organization‚Äôs network.  As with most other groups, APT1 uses phishing as the primary method of initial compromise.  Sent emails contain a malicious file in an attachment, or a link from the message text leads to it.  The subject of the letter, like its text, is usually sent to a specific recipient.  Mail accounts from which these messages were sent were registered in the names of people who were familiar to the recipient, for example: a colleague, a company manager, an employee of the IT department.  As a real example, the following is one of such emails addressed to a Mandiant employee. <br><br><img src="https://habrastorage.org/storage2/9fd/55f/504/9fd55f504ab16e9638ec1fbfc98a7f1d.jpg"><br>  Fig.  Phishing email sent by APT1 (Kevin Mandia - CEO Mandiant). <br><br>  The obvious catch here is that [at] rocketmail [dot] com is not Kevin's internal corporate account in Mandiant and instead uses the free rocketmail service [dot] com.  The word "here" contains a hyperlink, passing on which you can download the file Internal_Discussion_Press_Release_In_Next_Week8.zip.  This archive contains a malicious executable file that installs a backdoor on a computer (in this case, WEBC2-TABLE).  [ <i>Mandiant uses its malware family naming scheme</i> ].  Some more names of such archives are presented below: <br><br>  2012ChinaUSAviationSymposium.zip <br>  Employee-Benefit-and-Overhead-Adjustment-Keys.zip <br>  MARKET-COMMENT-Europe-Ends-Sharply-Lower-On-Data-Yields-Jump.zip <br>  Negative_Reports_Of_Turkey.zip <br><br>  The topics that attackers use in letters are very diverse.  As we see, in this case we are talking about a targeted attack. <br></blockquote><br><img src="https://habrastorage.org/storage2/bfa/28b/aff/bfa28baffd1d6803122be7523bc7153b.jpg"><br><br>  <b>Getting access</b> <br><br><blockquote>  The access phase includes actions that are taken by APT1 to ensure access to the organization‚Äôs network from outside.  APT1 accesses the victim's computer as soon as the backdoor is installed on the system.  Accordingly, the <b>purpose of the backdoor is to open access to a computer compromised by it to hackers</b> .  Malicious code also receives and receives commands from a remote C &amp; C server.  As soon as it is installed in the system, the connection to the C &amp; C takes place and the commands are expected from it.  In this case, when opening outgoing connections, it is possible to go unnoticed by the firewall installed on the computer. <br><br>  We found that <b>in some cases, APT1 used public backdoors, such as Poison Ivy or Gh0st RAT</b> .  In most cases, they apparently used their own developments and we documented 42 families of such backdoors.  We have divided these families into two categories: loaders [ <i>in the original version: ‚Äúbeachhead‚Äù, but one of their main functions is loading other files</i> ] and regular ones (full-featured). <br><br>  Loaders contain a minimum of features.  They are used to perform such simple tasks as retrieving files, collecting basic information about the system, loading and executing ordinary (full-featured) backdoors.  We also call such backdoor loaders WEBC2 and this family is probably the most well-known type of APT1 backdoors.  WEBC2 is designed for downloading a web page from a C &amp; C server.  He expects that this web page contains special html tags, searches for them and tries to interpret the commands between.  Older versions of WEBC2 tried to find commands between HTML comments, newer ones use other types of tags for this.  In accordance with our observations, we can confirm that APT1 used WEBC2 backdoors as early as July 2006. However, we observed one of the samples - WEBC2-KT3 with a compilation date from 2004-01-03, i.e., backdoors of this type, presumably Were in development since 2004. We collected more than 400 WEBC2 samples and assume that APT1 had direct access to the developers of this malware, since the constant release of its new versions, which participated in these attacks for 6 years, is obvious.  Listed below are the lines extracted from the threat executables, which indirectly indicate a continuing development process. <br><br>  sample a <br>  MD5: d7aa32b7465f55c368230bb52d52d885 <br>  Compile date: 2012-02-23 <br>  \ work \ code \ 2008-7-8muma \ mywork \ winInet_winApplication2009-8-7 \ mywork \ aaaaaaa2012-2-23 \ Release \ aaaaaaa.pdb <br><br>  sample B <br>  MD5: c1393e77773a48b1eea117a302138554 <br>  Compile date: 2009-08-07 <br>  D: \ work \ code \ 2008-7-8muma \ mywork \ winInet_winApplication2009-8-7 \ mywork \ aaaaaaa \ Release \ aaaaaaa.pdb <br><br>  Some list of WEBC2 families [ <i>Mandiant classification</i> ]: <br><br>  <b>WEBC2-AUSOV</b> <b><br></b>  <b>WEBC2-ADSPACE</b> <b><br></b>  <b>WEBC2-BOLID</b> <b><br></b>  <b>WEBC2-CLOVER</b> <b><br></b>  <b>WEBC2-CSON</b> <b><br></b>  <b>WEBC2-DIV</b> <b><br></b>  <b>WEBC2-GREENCAT</b> <b><br></b>  <b>WEBC2-HEAD</b> <b><br></b>  <b>WEBC2-KT3</b> <b><br></b>  <b>WEBC2-QBP</b> <b><br></b>  <b>WEBC2-RAVE</b> <b><br></b>  <b>WEBC2-TABLE</b> <b><br></b>  <b>WEBC2-TOCK</b> <b><br></b>  <b>WEBC2-UGX</b> <b><br></b>  <b>WEBC2-YAHOO</b> <b><br></b>  <b>WEBC2-Y21K</b> <br><img src="https://habrastorage.org/storage2/529/641/943/529641943b99025e0a7ce9b6e151dce8.jpg" alt="image" align="right"><br>  In general, WEBC2 backdoors provide the APT1 with the following features: <br><ul><li>  Start the command line interpreter process (cmd.exe). </li><li>  Download executable files and run them for execution. </li><li>  They have a "sleep" mode, remaining in an inactive state for some time. </li></ul><br>  The usual non-WEBC2 backdoor interacts with the command C &amp; C server via the HTTP protocol, or using its own protocol that the code authors wrote for this purpose.  This type of backdoor provides attackers with the following capabilities on a compromised computer: <br><ul><li>  Various file and directory operations. </li><li>  File transfer, both ways. </li><li>  Process management </li><li>  Modification of the registry. </li><li>  Removing screenshots of the user's desktop. </li><li>  Keylogger </li><li>  Track cursor movement. </li><li>  Run command line. </li><li>  Remote access via remote desktop. </li><li>  Collect passwords. </li><li>  Getting a list of users. </li><li>  Get a list of visible computers on the network. </li><li>  Sleep mode (malicious code will be inactive). </li><li>  Perform user change operation (log off). </li><li>  Turn off the computer. </li></ul><br>  Fig.  List of families and chronology of compilation dates. <br><br>  The BISCUIT backdoor is a good example, in terms of the set of commands it supports, which APT1 builds into ‚Äúregular‚Äù backdoors.  APT1 has been used and continuously refined by BISCUIT since 2007. It has been used in attacks to this day. <br><br><img src="https://habrastorage.org/storage2/ee8/7d2/0d2/ee87d20d274932acd620329540b905f4.jpg"><br>  Some backdoors, for disguise, try to imitate legitimate traffic.  Mandiant identified some of these protocols and the families in which they are used: MSN Messenger (MACROMAIL), Jabber / XMPP (GLOOXMAIL), Gmail Calendar (CALENDAR).  This masking provided some legitimacy mode for the traffic transmitted to C &amp; C.  In addition to this, many APT1 backdoors used SSL encryption for connections to C &amp; C.  In Appendix F, we provide a list of public SSL certificates that have been used for this purpose. </blockquote><br>  <b>Privilege escalation</b> <br><br><blockquote>  [ <i>It is not entirely clear why this stage of the attack was named that way.</i>  <i>Apparently, for APT, privilege escalation means just such a tactic</i> .] Raising privileges includes getting usernames and passwords from various accounts.  With their help, you can access other resources in a compromised environment and administrator accounts.  In addition to the username and password, APT1 can access PKI, VPN certificates, computers with increased access levels, or other resources.  To obtain logins and passwords of administrator credentials, the password hashes are dumped from a PC, server, or domain controller.  APT1 uses publicly available tools for this.  List of used dumpers: <br><ul><li>  cachedump </li><li>  fgdump </li><li>  gsecdump </li><li>  lslsass </li><li>  mimikatz </li><li>  pass-the-hash toolkit </li><li>  pwdump7 </li><li>  pwdumpx </li></ul></blockquote><br>  <b>Collection of information</b> <br><br><blockquote>  At this stage, APT1 collects information about the environment of the compromised computer.  Like most APTs (and not APTs), APT1 uses built-in OS commands to investigate a compromised system and its network environment.  When they have access to the command line interpreter, they execute these commands in it, sometimes batch files are also used to speed up the collection of information.  The following code from the batch file was used in at least four cases of intrusions. <br><br><img src="https://habrastorage.org/storage2/9d7/d31/df8/9d7d31df827f4c4713b70ac761029cbc.jpg"><br><br>  The script performs the following actions and saves the results to a text file: <br><ul><li>  Gets a list of settings for network connections. </li><li>  Gets a list of running services. </li><li>  Gets a list of running processes. </li><li>  Gets a list of user accounts in the system. </li><li>  Gets the list of accounts that belong to the Administrators group. </li><li>  Gets a list of current network connections. </li><li>  Gets a list of connected network resources. </li><li>  Gets a list of other machines on the network. </li><li>  For a domain controller, gets lists of accounts according to global groups in domains. </li></ul></blockquote><br>  <b>Maintaining presence</b> <br><br><blockquote>  At this stage, APT1 takes measures to obtain permanent, long-term control over key systems in a compromised network.  This is done in three ways: <br><ul><li>  APT1 installs new backdoors to various systems on the network during their stay on the compromised network.  Thus, even if one of them is deleted, their other modifications will remain on the network.  We usually found several backdoor families in a compromised network. </li><li>  APT1 exploits stolen VPN credentials.  We found that the attackers used the stolen Lokins and VPN passwords to enter compromised VPNs, but only when using a single-factor authentication mechanism to enter the VPN.  Thus, they entered secure VPN networks under legal user accounts. </li><li>  APT1 also compromises the web servers used in the organization‚Äôs network. </li></ul><br></blockquote><br>  <b>Transfer stolen data to APT1 servers</b> <br><br><blockquote> Before sending data directly to a remote server, they are packed into an archive.  Often, for these purposes, use the usual RAR using password protection.  Batch scripts are sometimes used for this purpose.  An example of one of them. <br><br><img src="https://habrastorage.org/storage2/99f/326/59a/99f32659a6654c70aa405101d40122bb.png"><br><br>  After creating the necessary archives, the malicious code on the side of the compromised network sends this data to the APT1 servers.  FTP can be used for transmission.  Also backdoors implement their own protocols for this.  Often the archives are so large that they are broken apart for onward transmission. <br><br><img src="https://habrastorage.org/storage2/790/8b6/cd8/7908b6cd80b0bdf0cf52e67650b8f00a.png"><br><br>  Unlike other APT groups that we tracked, APT1 used two special, unique tools to send stolen data to APT1 email - GETMAIL and MAPIGET. </blockquote><br>  <b>APT1 in the media</b> <br><br><blockquote>  APT1 activity was recorded in various publications, notes and articles.  At the same time, it is quite difficult to compile these sources together, since often different names are used when referring to APT1.  In addition, many analysts wrote about tools that were used in other Chinese APTs.  The table below gives a comparison of the pseudonyms of groups mentioned by other companies with APT1. <br><br><img src="https://habrastorage.org/storage2/6bb/9c2/7a0/6bb9c27a0b75ea86f4fc060fecb1856e.png"><br><ul><li>  The earliest known public infrastructure report APT1 belongs to the Japanese division of Symantec Corporation.  The report mentions sb.hugesoft.org, which was registered to a person known as ‚ÄúUgly Gorilla‚Äù. </li><li>  In September 2012, well-known journalist Brian Krebs on his blog reported on the compromise of Telvent Canada Ltd (now Schneider Electric).  We attribute this incident to the activities of APT1, based on the tools and infrastructure they use, to gain access to their network. </li><li>  SCADA published a report on recorded invasion operations using phishing in June 2012. AlienVault analyzed the relevant malicious code.  According to the indicators of compromise that were included in the report, we attributed this to APT1. </li><li>  In November 2012, Bloomberg journalist Chloe Whiteaker wrote about the Comment Group, describing the tools and domains used in APT1. </li></ul></blockquote><br>  <b>Example backdoor used by APT1</b> <br><br>  Appendix F (The Malware Arsenal) contains a list of families of threats that were used by APT1 for various purposes.  This list is really impressive.  We will consider one of these threats - AURIGA. <br><blockquote>  Main features of AURIGA: <br><ul><li>  Contains keylogger and functionality to track the movement of the cursor. </li><li>  Creation / completion of processes. </li><li>  Transfer files to the server and download them from there. </li><li>  Collecting information about the system. </li><li>  Getting logins and passwords. </li><li>  Hides your network connections. </li><li>  Hides its processes (DKOM). </li><li>  Implements code in processes. </li><li>  Provides remote desktop access. </li><li>  May shut down the system. </li><li>  Takes screenshots. </li></ul><br>  All collected information is encrypted using DES.  Interaction with C &amp; C is carried out through port 443, but it does not use SSL or TLS.  The keylogger stores information in the% WINDIR% \ System32 \ config \ sam.sav file.  It can provide an interactive session to the cmd.exe command interpreter, and the session data will be encrypted using DES.  The backdoor copies the% SYSTEMROOT% \ system32 \ cmd.exe command interpreter file to% SYSTEMROOT% \ system32 \ ati.exe.  Further, in the new ati.exe file, it replaces strings of the type ‚Äúmicrosoft corp.‚Äù With ‚Äúsuperhard corp.‚Äù.  The ati.exe file is deleted after the session is completed. <br><br>  Logins and passwords are collected using the HKEY_CURRENT_USER \ Software \ Microsoft \ Internet Account Manager \ Accounts registry key and values: <br><ul><li>  POP3 User Name </li><li>  HTTPMail User Name </li><li>  HTTPMail Password2 </li><li>  Hotmail </li><li>  POP3 Server </li><li>  POP3 Password2 </li></ul><br>  The riodrv32.sys driver can inject the malicious dll into the processes indicated to it.  It marks its presence in the system with the device \ Device \ rio32drv and a link to it \ DosDevices \ rio32drv.  It can also hide the IP address from the list of network connections.  The driver interacts with the user mode via IOCTL, here are some of them: <br><ul><li>  0x2A7B8008.  Remember IP address to hide. </li><li>  0x2A7B800C.  Embed dll in the process. </li><li>  0x2A7B8018.  Hide process by id. </li></ul><br>  From the driver: d: \ drizt \ projects \ auriga \ branches \ stone_ ~ 1 \ server \ exe \ i386 \ riodrv32.pdb </blockquote><br><br><img src="https://habrastorage.org/storage2/2ec/a8d/32c/2eca8d32c2808694164af073987688c5.jpg"></div><p>Source: <a href="https://habr.com/ru/post/170553/">https://habr.com/ru/post/170553/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../170541/index.html">Building Android Applications Using AIR SDK 3.6 on Linux</a></li>
<li><a href="../170543/index.html">Making flexible graphene ionics using a regular DVD-drive</a></li>
<li><a href="../170545/index.html">Introduction to Bayesian Methods</a></li>
<li><a href="../170549/index.html">Say a word about a poor mockup</a></li>
<li><a href="../170551/index.html">Hours on gas-discharge indicators</a></li>
<li><a href="../170557/index.html">Attempt to translate and voice acting video at home</a></li>
<li><a href="../170559/index.html">And about the clock</a></li>
<li><a href="../170561/index.html">Mozilla introduced the commercial version of Firefox OS and plans to promote its OS</a></li>
<li><a href="../170563/index.html">From jQuery to Backbone</a></li>
<li><a href="../170565/index.html">Emmet v1.0 released</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>