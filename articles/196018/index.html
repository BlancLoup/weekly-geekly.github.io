<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Store the session on the client to simplify application scaling (3rd of 12 articles on Node.js from the Mozilla Identity team)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator: This is the third article from the cycle about Node.js from the Mozilla Identity team that deals with the Persona project. This a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Store the session on the client to simplify application scaling (3rd of 12 articles on Node.js from the Mozilla Identity team)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/1cd/114/dcc/1cd114dccef67edc3ab87f77457332d9.jpg" align="left">  <i><b>From the translator:</b> This is the third article from the <a href="https://hacks.mozilla.org/category/a-node-js-holiday-season/">cycle about Node.js</a> from the Mozilla Identity team that deals with the <a href="http://ru.wikipedia.org/wiki/Mozilla_Persona">Persona</a> project.</i>  <i>This article is about Persona‚Äôs method of storing session data on the client.</i> <i><br></i> <div class="spoiler">  <b class="spoiler_title">All articles of the cycle:</b> <div class="spoiler_text"><ol><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/195494/">Hunting for memory leaks in Node.js</a> " </li><li>  "We <a href="http://habrahabr.ru/company/nordavind/blog/195686/">load Node to the eyeballs</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196018/">Store the session on the client to simplify application scaling</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196358/">Frontend performance. Part 1 - concatenation, compression, caching</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196518/">We write a server that does not fall under load</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196818/">Frontend performance. Part 2 - we cache dynamic content using etagify</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197166/">Taming Web Application Configurations with node-convict</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197370/">Frontend performance. Part 3 - font optimization</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197566/">Localization of Node.js Applications. Part 1</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198154/">Localization of Node.js Applications. Part 2: Toolkit and Process</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198252/">Localization of Node.js Applications. Part 3: Localization in Action</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198590/">Awsbox - PaaS infrastructure for deploying Node.js applications in the Amazon cloud</a> " </li></ol><br></div></div><br><br><hr><br>  Static websites scale well.  They are easy to cache, and do not need to constantly synchronize data on multiple servers. <br><br>  Unfortunately, most web applications need to store state information in order to offer users personalized pages.  If users can register on the site, then we need to store the session.  The most common way is to set a cookie with a random session ID, and to keep the details on the server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Site scaling with state storage </h4><br>  If you need to scale such a site, there are three options: <br><br><ol><li>  Replicate session data between all servers. </li><li>  Use a central repository to which all servers will access. </li><li>  Assign a specific server to each user. </li></ol><br>  All of these approaches have disadvantages: <br><br><ol><li>  Replication degrades performance and increases complexity. </li><li>  Central storage limits scaling and leads to additional delays. </li><li>  Binding users to specific servers leads to problems when the server is shut down. </li></ol><br>  However, after thinking a bit, you can come up with a fourth way: store all session data on the client. <br><a name="habracut"></a><br><h4>  Storing sessions on the client </h4><br>  Storing session data in a browser has several obvious advantages: <br><br><ol><li>  Data is always available, regardless of which server serves the client. </li><li>  No need to store state on the server. </li><li>  No need to synchronize status information between servers. </li><li>  You can add new servers very easily. </li></ol><br>  But there is one big problem: the data stored by the client cannot be trusted.  For example, if you store a user ID in a cookie, then it can override it and get access to someone else‚Äôs account. <br><br>  Although this problem seems insurmountable, it has a solution: to store data in a secure container.  Thus, it is no longer necessary to trust the client - he has no opportunity to substitute them unnoticed. <br><br>  In practice, this means that the data in the cookie must be encrypted and signed with the key stored on the server.  This is exactly what the client-sessions module does. <br><br><h4>  node-client-sessions </h4><br>  The <a href="https://github.com/mozilla/node-client-sessions">node-client-sessions</a> for Node.js replaces the standard middleware modules of the Connect <a href="http://www.senchalabs.org/connect/session.html">session</a> framework and the <a href="http://www.senchalabs.org/connect/cookieParser.html">cookie-parser</a> .  Here's how to include it in a simple application for Express: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> clientSessions = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"client-sessions"</span></span>); app.use(clientSessions({ <span class="hljs-attr"><span class="hljs-attr">secret</span></span>: <span class="hljs-string"><span class="hljs-string">'0GBlJZ9EKBt2Zbi2flRPvztczCewBxXK'</span></span> <span class="hljs-comment"><span class="hljs-comment">// set this to a long random string! }));</span></span></code> </pre> <br>  You can then set the property values ‚Äã‚Äãof the <code>req.session</code> object: <br><pre> <code class="javascript hljs">app.get(<span class="hljs-string"><span class="hljs-string">'/login'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">)</span></span>{ req.session.username = <span class="hljs-string"><span class="hljs-string">'JohnDoe'</span></span>; });</code> </pre><br>  and read them: <br><pre> <code class="javascript hljs">app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">)</span></span>{ res.send(<span class="hljs-string"><span class="hljs-string">'Welcome '</span></span> + req.session.username); });</code> </pre><br>  To close the session, use the <code>reset()</code> method: <br><pre> <code class="javascript hljs">app.get(<span class="hljs-string"><span class="hljs-string">'/logout'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ req.session.reset(); });</code> </pre><br><h4>  Instant Persona Session Closing </h4><br>  One of the main disadvantages of storing sessions on the client is that the server can no longer close sessions on its own. <br><br>  When storing session data on the server, it is enough just to delete session data from the database, after which all cookies on all clients will indicate a non-existing record.  When data is stored on the client, the server cannot be sure that the data has been deleted in all browsers.  In other words, it is not so easy to synchronize the new state of the server (the user has ended the session) with the state on the client (the session is open). <br><br>  To lessen the severity of the problem a bit, client-sessions keep the session lifetime in the cookie.  Before unpacking data from an encrypted container, the server will check if they are expired.  If yes, then he will ignore this data and will consider that the session is closed. <br><br>  Although the scheme with setting the time of life works well, especially if the time is not very long, in the case of Persona we needed a way to immediately close the session on all clients if the user changed the password. <br><br>  We still had to keep a small amount of state on the server.  <a href="https://github.com/mozilla/browserid/commit/1b0444d85700a951edc74a0bf7ad5581b2cbfedd">We did this</a> by adding one field to the database table on the server and to the cookie. <br><br>  Each API call that accesses session data now reads this field in the database and compares it with a similar field in the cookie.  If they do not match, the session is considered closed. <br><br>  Excessive access to the database is, of course, not very good, but, fortunately, we already had to read from the table with user data on almost every call, so the session identifier could be obtained without unnecessary overhead.  So that you could quickly start experimenting with the module, we wrote a small <a href="https://github.com/fmarier/node-client-sessions-sample">demo application</a> . <br><br><hr><br><br><div class="spoiler">  <b class="spoiler_title">All articles of the cycle:</b> <div class="spoiler_text"><ol><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/195494/">Hunting for memory leaks in Node.js</a> " </li><li>  "We <a href="http://habrahabr.ru/company/nordavind/blog/195686/">load Node to the eyeballs</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196018/">Store the session on the client to simplify application scaling</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196358/">Frontend performance. Part 1 - concatenation, compression, caching</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196518/">We write a server that does not fall under load</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/196818/">Frontend performance. Part 2 - we cache dynamic content using etagify</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197166/">Taming Web Application Configurations with node-convict</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197370/">Frontend performance. Part 3 - font optimization</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/197566/">Localization of Node.js Applications. Part 1</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198154/">Localization of Node.js Applications. Part 2: Toolkit and Process</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198252/">Localization of Node.js Applications. Part 3: Localization in Action</a> " </li><li>  " <a href="http://habrahabr.ru/company/nordavind/blog/198590/">Awsbox - PaaS infrastructure for deploying Node.js applications in the Amazon cloud</a> " </li></ol><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/196018/">https://habr.com/ru/post/196018/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../196002/index.html">Derby.js Warrior's Way</a></li>
<li><a href="../196006/index.html">Collaboration of Aastra Blustar 8000i and Cisco CUCM 9.0 video terminals</a></li>
<li><a href="../196008/index.html">We write our book</a></li>
<li><a href="../196012/index.html">A new war has begun for Vkontakte. Durov threatened with dismissal</a></li>
<li><a href="../196014/index.html">Faces of Facebook: All FB users on one page</a></li>
<li><a href="../196020/index.html">The success story of Open Source in France: the total cost of ownership of the national gendarmerie computer park fell by 40%</a></li>
<li><a href="../196022/index.html">The history of the pirate scene</a></li>
<li><a href="../196024/index.html">Ely Belutin and creative thinking</a></li>
<li><a href="../196026/index.html">Robots, projectors, image processing: video "Box"</a></li>
<li><a href="../196030/index.html">Making css sprites more responsive on retina-displays and not only [less]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>