<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search for odd performance reasons</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Finally, it is useful to study the Java bytecode in detail, and almost immediately an interesting question arose in my head. There is a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search for odd performance reasons</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Finally, it is useful to study the Java bytecode in detail, and almost immediately an interesting question arose in my head.  There is an <b>NOP</b> instruction that does nothing.  So, how does this ‚Äúnothing‚Äù affect performance?  Actually, the process of studying this and described in the post. <br><br><h4>  Disclaimer </h4><br>  The story itself, first of all, is not about how it really works, but about what mistakes you should beware of when measuring performance. <br><a name="habracut"></a><br><h4>  Instruments </h4><br>  Let's start with the main thing: how all the measurements were carried out.  The <a href="http://asm.ow2.org/">ASM</a> library was used to generate the code, the <a href="http://openjdk.java.net/projects/code-tools/jmh/">JMH was</a> used to create the benchmark <a href="http://openjdk.java.net/projects/code-tools/jmh/">itself</a> . <br><br>  In order not to use reflection, a small interface was created: <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Getter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, a class was generated that implements the <b>get</b> method: <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">I NOP ... NOP LDC 20 IRETURN</span></span></code> </pre><br>  You can insert an arbitrary number of feet. <br><br><div class="spoiler">  <b class="spoiler_title">Full code generator</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleGetterClassLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassLoader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String GENERATED_CLASS_NAME = <span class="hljs-string"><span class="hljs-string">"other.GeneratedClass"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ClassLoader myClassLoader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleGetterClassLoader(); <span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>(<span class="hljs-string"><span class="hljs-string">"unchecked"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Getter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newInstanceWithNOPs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nopCount)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Class&lt;?&gt; clazz = Class.forName(GENERATED_CLASS_NAME + <span class="hljs-string"><span class="hljs-string">"_"</span></span> + nopCount, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, myClassLoader); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (Getter) clazz.newInstance(); } <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Class&lt;?&gt; findClass(<span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> String name) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> ClassNotFoundException { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!name.startsWith(GENERATED_CLASS_NAME)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassNotFoundException(name); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nopCount = Integer.parseInt(name.substring(GENERATED_CLASS_NAME.length() + <span class="hljs-number"><span class="hljs-number">1</span></span>)); ClassWriter cw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassWriter(<span class="hljs-number"><span class="hljs-number">0</span></span>); cw.visit(V1_5, ACC_PUBLIC, name.replace(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, getInternalName(Object.class), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{getInternalName(Getter.class)}); { MethodVisitor mv = cw.visitMethod(ACC_PUBLIC, <span class="hljs-string"><span class="hljs-string">"&lt;init&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"()V"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); mv.visitCode(); mv.visitVarInsn(ALOAD, <span class="hljs-number"><span class="hljs-number">0</span></span>); mv.visitMethodInsn(INVOKESPECIAL, getInternalName(Object.class), <span class="hljs-string"><span class="hljs-string">"&lt;init&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"()V"</span></span>); mv.visitInsn(RETURN); mv.visitMaxs(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); mv.visitEnd(); } { MethodVisitor mv = cw.visitMethod(ACC_PUBLIC, <span class="hljs-string"><span class="hljs-string">"get"</span></span>, <span class="hljs-string"><span class="hljs-string">"()I"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); mv.visitCode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nopCount; i++) { mv.visitInsn(NOP); } mv.visitLdcInsn(<span class="hljs-number"><span class="hljs-number">20</span></span>); mv.visitInsn(IRETURN); mv.visitMaxs(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); mv.visitEnd(); } cw.visitEnd(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes = cw.toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defineClass(name, bytes, <span class="hljs-number"><span class="hljs-number">0</span></span>, bytes.length); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Benchmark</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@State</span></span>(Scope.Benchmark) <span class="hljs-meta"><span class="hljs-meta">@OutputTimeUnit</span></span>(TimeUnit.MICROSECONDS) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bench</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Getter nop_0; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Getter nop_10; ... <span class="hljs-meta"><span class="hljs-meta">@Setup</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ nop_0 = newInstanceWithNOPs(<span class="hljs-number"><span class="hljs-number">0</span></span>); nop_10 = newInstanceWithNOPs(<span class="hljs-number"><span class="hljs-number">10</span></span>); ... } <span class="hljs-meta"><span class="hljs-meta">@GenerateMicroBenchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nop_0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nop_0.get(); } <span class="hljs-meta"><span class="hljs-meta">@GenerateMicroBenchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nop_10</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nop_10.get(); } ...</code> </pre><br></div></div><br><br><h4>  Search for truth </h4><br>  First, 2 tests were launched: without knobs and since 2000. <br><br><pre> <code class="java hljs">Benchmark Mode Samples Mean Mean error Units b.Bench.nop_0 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">838</span></span>,<span class="hljs-number"><span class="hljs-number">753</span></span> <span class="hljs-number"><span class="hljs-number">48</span></span>,<span class="hljs-number"><span class="hljs-number">962</span></span> ops/us b.Bench.nop_2000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">298</span></span>,<span class="hljs-number"><span class="hljs-number">428</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">965</span></span> ops/us</code> </pre><br>  And immediately I made a very powerful conclusion: "Stupid JIT does not cut the legs, but translates them into machine ones." <br><div class="spoiler">  <b class="spoiler_title">Question to experts:</b> <div class="spoiler_text">  If this were true, would the measurement result be similar?  Or would it be something completely different? </div></div><br>  But this, nevertheless, was a hypothesis, and I really wanted to test it.  First, I made sure that these methods are really compiled by JIT, then I looked into what.  Naturally, the assembler obtained was completely identical.  And here I realized that I did not understand something.  The executable code is the same, and the performance is 2.5 times different.  Strange. <br><br>  Then I really wanted to look at the type of dependence. <br><pre> <code class="java hljs">Benchmark Mode Samples Mean Mean error Units b.Bench.nop_0 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">813</span></span>,<span class="hljs-number"><span class="hljs-number">010</span></span> <span class="hljs-number"><span class="hljs-number">71</span></span>,<span class="hljs-number"><span class="hljs-number">510</span></span> ops/us b.Bench.nop_2000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">302</span></span>,<span class="hljs-number"><span class="hljs-number">589</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">360</span></span> ops/us b.Bench.nop_10000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">268</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">017</span></span> ops/us</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Hidden knowledge</b> <div class="spoiler_text">  This measurement is generally gorgeous.  3 points and all from different sequences. </div></div><br>  It is worth noting here that for a new point, whether the compilation takes place or what happens at the output, I did not look at all.  Automatically suggested that everything is the same as at 0 / 2k.  What was a mistake. <br><br>  I looked at it, and made the following far-reaching conclusion: "Dependence is very strongly non-linear."  But, what is more important, in this place I began to suspect that the real thing here was not in the feet themselves, but in the size of the method. <br><br>  The next thought was that our methods are virtual, which means they are stored in a table of virtual methods.  Maybe the table itself is size sensitive?  For verification, I simply transferred the code to static methods, and, of course, nothing has changed at all. <br><div class="spoiler">  <b class="spoiler_title">Question to experts 2</b> <div class="spoiler_text">  Was this thought a complete nonsense?  Or was there something sensible in her? </div></div><br><br>  Further, from misunderstanding, it is useful to look for what has the size of the method.  The answer was found in the openjdk source: <br><pre> <code class="cpp hljs"> develop(intx, HugeMethodLimit, <span class="hljs-number"><span class="hljs-number">8000</span></span>, \ <span class="hljs-string"><span class="hljs-string">"Don't compile methods larger than this if "</span></span> \ <span class="hljs-string"><span class="hljs-string">"+DontCompileHugeMethods"</span></span>)</code> </pre><br>  Interestingly, just between 2k and 10k.  Calculate the size of my method: 3 bytes on ‚Äúreturn 20‚Äù, 7997 remains. <br><pre> <code class="java hljs">Benchmark Mode Samples Mean Mean error Units b.Bench.nop_0 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">797</span></span>,<span class="hljs-number"><span class="hljs-number">376</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">998</span></span> ops/us b.Bench.nop_2000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">306</span></span>,<span class="hljs-number"><span class="hljs-number">795</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">243</span></span> ops/us b.Bench.nop_7997 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">303</span></span>,<span class="hljs-number"><span class="hljs-number">314</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">161</span></span> ops/us b.Bench.nop_7998 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">335</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">001</span></span> ops/us b.Bench.nop_10000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">269</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">000</span></span> ops/us</code> </pre><br>  Guess this boundary is clear.  It remains to understand what is happening up to 8000 bytes.  Add points: <br><pre> <code class="java hljs">Benchmark Mode Samples Mean Mean error Units b.Bench.nop_0 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">853</span></span>,<span class="hljs-number"><span class="hljs-number">499</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>,<span class="hljs-number"><span class="hljs-number">847</span></span> ops/us b.Bench.nop_10 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">845</span></span>,<span class="hljs-number"><span class="hljs-number">861</span></span> <span class="hljs-number"><span class="hljs-number">112</span></span>,<span class="hljs-number"><span class="hljs-number">504</span></span> ops/us b.Bench.nop_100 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">867</span></span>,<span class="hljs-number"><span class="hljs-number">068</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>,<span class="hljs-number"><span class="hljs-number">681</span></span> ops/us b.Bench.nop_500 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">304</span></span>,<span class="hljs-number"><span class="hljs-number">116</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">665</span></span> ops/us b.Bench.nop_1000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">299</span></span>,<span class="hljs-number"><span class="hljs-number">295</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">745</span></span> ops/us b.Bench.nop_2000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">306</span></span>,<span class="hljs-number"><span class="hljs-number">495</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">578</span></span> ops/us b.Bench.nop_7997 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">301</span></span>,<span class="hljs-number"><span class="hljs-number">322</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">992</span></span> ops/us b.Bench.nop_7998 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">335</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">005</span></span> ops/us b.Bench.nop_10000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">269</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">004</span></span> ops/us b.Bench.nop_25000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">105</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">007</span></span> ops/us b.Bench.nop_50000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">053</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">001</span></span> ops/us</code> </pre><br>  The first thing that pleases us here is that after jit has disconnected, linear dependence is very clearly visible.  What exactly coincides with our expectation, since  each NOP must be explicitly processed. <br><br>  The next thing that the eye falls on is a strong feeling that up to 8k is not just some kind of dependency, but just 2 constants.  Another 5 minutes of manual binary search, and the border is found. <br><pre> <code class="java hljs">Benchmark Mode Samples Mean Mean error Units b.Bench.nop_0 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">805</span></span>,<span class="hljs-number"><span class="hljs-number">466</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">074</span></span> ops/us b.Bench.nop_10 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">862</span></span>,<span class="hljs-number"><span class="hljs-number">027</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">756</span></span> ops/us b.Bench.nop_100 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">861</span></span>,<span class="hljs-number"><span class="hljs-number">462</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>,<span class="hljs-number"><span class="hljs-number">881</span></span> ops/us b.Bench.nop_322 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">863</span></span>,<span class="hljs-number"><span class="hljs-number">176</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">385</span></span> ops/us b.Bench.nop_323 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">303</span></span>,<span class="hljs-number"><span class="hljs-number">677</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">130</span></span> ops/us b.Bench.nop_500 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">299</span></span>,<span class="hljs-number"><span class="hljs-number">368</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">143</span></span> ops/us b.Bench.nop_1000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">302</span></span>,<span class="hljs-number"><span class="hljs-number">884</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">373</span></span> ops/us b.Bench.nop_2000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">306</span></span>,<span class="hljs-number"><span class="hljs-number">682</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">598</span></span> ops/us b.Bench.nop_7997 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">301</span></span>,<span class="hljs-number"><span class="hljs-number">457</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">209</span></span> ops/us b.Bench.nop_7998 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">337</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">001</span></span> ops/us b.Bench.nop_10000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">268</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">004</span></span> ops/us b.Bench.nop_25000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">107</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">002</span></span> ops/us b.Bench.nop_50000 thrpt <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">053</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">000</span></span> ops/us</code> </pre><br>  Almost everything, it remains to understand what is it abroad.  Calculate: 3 + 322 == 325. We are looking for what kind of magic 325, and find a certain key- <b>XX: FreqInlineSize</b> <br><blockquote>  FreqInlineSize is 325 on modern 64bit Linux </blockquote><br>  and its description of the docks: <br><blockquote>  Integer quotation of instructions for instructions. </blockquote><br><br>  Hooray!  Finally, everything came together.  So we found the dependence of the performance on the size of the method (of course, "with other things being equal"). <br>  1. JIT + inline <br>  2. JIT <br>  3. honest interpretation <br><br><h4>  Conclusion </h4><br>  As I said at the beginning, the main thing to pay attention to is not real behavior.  It turned out to be rather trivial, and I am sure it is described in the dock (I did not read, I don‚Äôt know)  My main message is that it is very important to trust common sense, and if the measurement results even slightly differ from it, or simply seem incomprehensible, then you should definitely check and re-check everything. <br><br>  I hope someone this post seemed interesting. <br><br><h4>  PS </h4><br>  I always counted both 8000 and 325 in bytes inclusive.  It seems that it was necessary to do this in the instructions non-inclusive. <br><br><div class="spoiler">  <b class="spoiler_title">Question for connoisseurs 3</b> <div class="spoiler_text">  Why precisely 325 and 8000?  Are these random numbers, or is there something behind them? </div></div></div><p>Source: <a href="https://habr.com/ru/post/215355/">https://habr.com/ru/post/215355/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215343/index.html">AST Transformations - First Step to Heavy Substances</a></li>
<li><a href="../215345/index.html">Problems with the code? Help the team write better code. Tips from Dino Esposito</a></li>
<li><a href="../215347/index.html">Who should be in the 21st century, if dad and grandfather are energy people?</a></li>
<li><a href="../215351/index.html">Channel aggregation and IP traffic balancing for storage</a></li>
<li><a href="../215353/index.html">We collect the pocket laser</a></li>
<li><a href="../215357/index.html">BitSorting Algorithm with complexity O (n)</a></li>
<li><a href="../215361/index.html">Turn Zalman into Noctua (or fan upgrade)</a></li>
<li><a href="../215363/index.html">Automation of system integration testing</a></li>
<li><a href="../215367/index.html">Proxmox 3.1: installation details out of the box</a></li>
<li><a href="../215369/index.html">TFS Build Sequences</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>