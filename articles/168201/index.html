<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Objective C. Practice. Events and "dead" objects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many probably know that when working with property change events using key-value observing, there is a very convenient mechanism that prevents the app...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Objective C. Practice. Events and "dead" objects</h1><div class="post__text post__text-html js-mediator-article"> Many probably know that when working with property change events using key-value observing, there is a very convenient mechanism that prevents the application of ‚Äúmeter‚Äù objects that are call recipients.  In fact, the first dead object ‚Äúknocks‚Äù the application, when an event arrives at it, this is natural, since the object no longer exists and no methods can be called for it. <br><br>  The search for such objects could be difficult if it were not for the remarkable thing in the debugging thing called <code>NSKVODeallocateBreak</code> , which allows you to interrupt the execution of the application at the moment when the object subscribed to the events is destroyed in order to track its lifetime and remove the problem. <br><br>  In the process of working on the class that I used for the events, I wanted to create a similar mechanism, since it is rather difficult to predict errors in the event logic, and insurance would not hurt here. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This article is designed for developers who have experience with the platform and who know how the life cycle of an object is determined.  If you have certain gaps in this area (and I have even repeatedly met even experienced developers who do not know how the link counter works and doesn‚Äôt represent what <code>@synthesize</code> unfolds), then you can read <a href="http://virtualmind.ru/2012/03/19/properties-in-objective-c-in-deep/">my old article on this issue.</a> .  The rest I ask to the table. <br><br><a name="habracut"></a>  So what do we want?  We want that as soon as an object that is subscribed to an event through the <a href="http://habrahabr.ru/post/168179/">mechanism described in the previous release</a> is destroyed, we get information about this in the debugger. <br><br>  What is needed for this?  The obvious solution is to somehow intercept the <code>dealloc</code> call of the signatory object when subscribing to an event and report it to the developer.  However, here's a bad luck - it is impossible to intercept <code>dealloc</code> standard means (or, at least, I have not found such a method). <br><br>  Fortunately, Objective C makes it quite beautiful to get around this limitation with its runtime.  I <a href="http://codeshaker.blogspot.ru/2012/01/calling-original-overridden-method-from.html">spotted the</a> idea of ‚Äã‚Äãthis solution in a <a href="http://codeshaker.blogspot.ru/2012/01/calling-original-overridden-method-from.html">note by a certain codeshaker</a> , and it turned out to be incredibly beautiful and elegant.  Redoing it to fit my needs, I received the following code: <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObjectDeallocInfo</span></span></span><span class="hljs-class">) -(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dealloc_override</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObjectDeallocInfo</span></span></span><span class="hljs-class">) +(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load</span></span></span><span class="hljs-class"> </span></span>{ method_exchangeImplementations(class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(dealloc)), class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(dealloc_override))); } -(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)dealloc_override { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> dealloc_override]; } <span class="hljs-keyword"><span class="hljs-keyword">@end</span></span></code> </pre> <br><br>  In fact, this code replaces the dealloc handler method with our dealloc handler dealloc, and the seemingly recursive call <code>[self dealloc_override]</code> actually now leads to the standard method. <br><br>  The second question is where to store information about the connection of our signatory object with an event object.  Use static dictionary?  No, it means increasing the number of problems.  Fortunately, runtime will help us here too - it turns out that a dictionary for properties-extensions is already associated with any object in Objective-C and we just need to use it. <br><br>  We define some unique identifier of our property. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* AW_EVENTHANDLER_KEY = (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)<span class="hljs-number"><span class="hljs-number">0x2781</span></span>;</code> </pre> <br><br>  Now we tie it to the <code>NSObject</code> class, using the same category that we used to override the method. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObjectDeallocInfo</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assign</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AWEventHandlersList</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attachedEventHandler</span></span></span><span class="hljs-class">; -(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dealloc_override</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObjectDeallocInfo</span></span></span><span class="hljs-class">) +(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load</span></span></span><span class="hljs-class"> </span></span>{ method_exchangeImplementations(class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(dealloc)), class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(dealloc_override))); } -(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)dealloc_override { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> dealloc_override]; } -(AWEventHandlersList *)attachedEventHandler { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (AWEventHandlersList *)objc_getAssociatedObject(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, AW_EVENTHANDLER_KEY); } -(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)setAttachedEventHandler:(AWEventHandlersList *)attachedEventHandler { objc_setAssociatedObject(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, AW_EVENTHANDLER_KEY, attachedEventHandler, OBJC_ASSOCIATION_ASSIGN); } <span class="hljs-keyword"><span class="hljs-keyword">@end</span></span></code> </pre> <br><br>  Now any object of type <code>NSObject</code> has a virtual property <code>attachedEventHandler</code> , which we will use to store the information we need. <br><br>  We extend the code of the <code>AWEventHandlersList</code> class <code>AWEventHandlersList</code> that it writes the object of the <code>AWEventHandlersList</code> in this field and add a method that returns <code>YES</code> if the object is subscribed to the event. <br><br><pre> <code class="objectivec hljs">-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)addReceiver:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)receiver delegate:(SEL)delegate { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> removeReceiver:receiver delegate:delegate]; [receiver setAttachedEventHandler:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; [_handlers addObject:[AWEventHandler handlerWithTarget:receiver method:delegate]]; } -(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)removeReceiver:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)receiver delegate:(SEL)delegate { [receiver setAttachedEventHandler:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(AWEventHandler *handler <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [[_handlers <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>] autorelease]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(handler.method == delegate &amp;&amp; handler.target == receiver) [_handlers removeObject:handler]; } -(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)isReceiverInList:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)receiver { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(AWEventHandler *handler <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _handlers) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(handler.target == receiver) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } -(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)clearReceivers { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(AWEventHandler *handler <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _handlers) [handler.target setAttachedEventHandler:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; [_handlers removeAllObjects]; }</code> </pre> <br><br>  Now it becomes quite simple to realize what it was for the sake of - checking for the moment of the deployment of the object. <br><br><pre> <code class="objectivec hljs">-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)dealloc_override { AWEventHandlersList *handler = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.attachedEventHandler; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(handler) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([handler isReceiverInList:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"Event handler (%@) target is released while subscribed"</span></span>, handler.name); [<span class="hljs-built_in"><span class="hljs-built_in">NSException</span></span> raise:<span class="hljs-string"><span class="hljs-string">@"E_HANDLERRELEASED"</span></span> format:<span class="hljs-string"><span class="hljs-string">@"Event handler (%@) target is released while subscribed"</span></span>, handler.name]; } [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> dealloc_override]; }</code> </pre> <br><br>  Now, if an object was destroyed while it is subscribed to an event, an exception will be thrown.  Best of all, an exception is thrown in the place where the object's destructor is triggered, which allows you to see the error stack in crash reports. <br><br>  Thus, in just 15 minutes we have made our debugging life somewhat easier. </div><p>Source: <a href="https://habr.com/ru/post/168201/">https://habr.com/ru/post/168201/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../168187/index.html">How to build Adobe Air app for Mac OS AppStore</a></li>
<li><a href="../168189/index.html">License Manager for 1C in a virtual environment + monitoring in Zabbix</a></li>
<li><a href="../168191/index.html">Analysis of the design methodology: errors, situations and useful conclusions from them</a></li>
<li><a href="../168195/index.html">Understanding hashCode () and equals ()</a></li>
<li><a href="../168197/index.html">Learning robot control by IR remote</a></li>
<li><a href="../168205/index.html">5 components of an advanced online store</a></li>
<li><a href="../168207/index.html">Surveillance on the knee - the tricks of the camera selection</a></li>
<li><a href="../168217/index.html">"Debriefing" - Episode 33 - Special: Moscow voyage of the Amazon</a></li>
<li><a href="../168219/index.html">How to start flying on your own, without risking your life</a></li>
<li><a href="../168221/index.html">LitRes.ru is trying to "squeeze" the business of the authors of the application "reader"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>