<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple Connection Pool without DataSource in Java</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It's no secret that in Java EE Connection Pool is implemented using Data Source. An example implementation in Apache Tomcat can be found at this link:...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple Connection Pool without DataSource in Java</h1><div class="post__text post__text-html js-mediator-article">  It's no secret that in Java EE Connection Pool is implemented using Data Source.  An example implementation in Apache Tomcat can be found at this link: <a href="http://habrahabr.ru/post/101342/">habrahabr.ru/post/101342</a> .  But what to do if we use only Java SE and we need to organize multi-threaded access to the database using the Connection Pool scheme.  After all, we don‚Äôt have an application server in this case, therefore, we cannot use Data Source, and we will probably have to use java.sql.DriverManager to create connections to the database.  You can also use something from this article to replace this approach: <a href="http://docs.oracle.com/javase/jndi/tutorial/ldap/connect/pool.html">docs.oracle.com/javase/jndi/tutorial/ldap/connect/pool.html</a> .  Most likely, this approach has already been implemented by someone in Java, at least I have not found such an implementation on the network.  And I decided to invent my bike.  It would be nice if in the search engine when searching for the <i>Connection pool in Java, a</i> link to this article was added, supplemented and edited from the comments and additions from habr.ru, and this article would be useful to someone.  If it became interesting, then I ask for cat. <br><a name="habracut"></a><br>  We implement everything in the form of a class, the constructor of which takes as input the initial number of connections in the pool and connection parameters to the database (the name of the class being loaded from the driver and the connection string along with the user name and password).  Let's call the class ConnectionPool, its constructor will look like: <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConnectionPool</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String url, String driver, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> initConnCnt)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Class.forName(driver); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.url = url; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; initConnCnt; i++) { availableConns.addElement(getConnection()); } }</code> </pre> <br>  url is a connection string, for MS SQL Server it will look like: jdbc: sqlserver: //192.168.0.1; databaseName = dbname; username = username; password = pwd.  You can separate the username and password, transfer them separately to the DriverManager.  Here everything is in one place, at least it seemed so more convenient to me.  One of the valid drivers for working with MS SQL Server is as follows: com.microsoft.sqlserver.jdbc.SQLServerDriver. <br>  In this class two vectors should be declared: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Vector&lt;Connection&gt; availableConns = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector&lt;Connection&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Vector&lt;Connection&gt; usedConns = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector&lt;Connection&gt;();</code> </pre><br>  The first will contain a list of available compounds, the second list used at any time. <br>  In addition, the url variable is defined, which will store the connection string to the database: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String url;</code> </pre><br>  The constructor uses the getConnection function, which simply creates a new connection.  Its implementation is as follows: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Connection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Connection conn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { conn = DriverManager.getConnection(url); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> conn; }</code> </pre><br>  So, we have a vector availableConns, filled with Connections in the number of initConnCnt pieces, none of which are currently used directly for their intended purpose, i.e.  to access the database.  Now we‚Äôll write the retrieve function, this function takes the next Connection from the availableConns and adds it to the usedConns, then returns this connection, thus it becomes used: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> Connection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">retrieve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SQLException </span></span>{ Connection newConn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (availableConns.size() == <span class="hljs-number"><span class="hljs-number">0</span></span>) { newConn = getConnection(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { newConn = (Connection) availableConns.lastElement(); availableConns.removeElement(newConn); } usedConns.addElement(newConn); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newConn; }</code> </pre><br>  The logic is clear: first we check whether there are free connections, if not, we create a new connection, if there is, then we extract the last element from the availableConns and remove it from the vector of free connections.  Then we just add a connection or retrieve it from the list of free ones to the list used by the line. <pre> <code class="java hljs">usedConns.addElement(newConn);</code> </pre><br>  and return this connection.  Of course, synchronized is indispensable.  How else?  Access is multi-threaded, all of a sudden the same connection will be allocated to two threads!  When the connection is no longer needed, we perform the reverse operation, in other words putback: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">putback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Connection c)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NullPointerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (usedConns.removeElement(c)) { availableConns.addElement(c); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NullPointerException(<span class="hljs-string"><span class="hljs-string">"Connection not in the usedConns"</span></span>); } } }</code> </pre><br>  The logic is also understandable and does not require declarations. <br>  Then you can, if necessary, write a bunch of additional functions that provide access to additional information, for example, the function for getting the number of free connections will look like this: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAvailableConnsCnt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> availableConns.size(); }</code> </pre><br>  Fully all class: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.sql.Connection; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.sql.DriverManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.sql.SQLException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Vector; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConnectionPool</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Vector&lt;Connection&gt; availableConns = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector&lt;Connection&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Vector&lt;Connection&gt; usedConns = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector&lt;Connection&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String url; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConnectionPool</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String url, String driver, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> initConnCnt)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Class.forName(driver); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.url = url; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; initConnCnt; i++) { availableConns.addElement(getConnection()); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Connection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Connection conn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { conn = DriverManager.getConnection(url); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> conn; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> Connection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">retrieve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SQLException </span></span>{ Connection newConn = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (availableConns.size() == <span class="hljs-number"><span class="hljs-number">0</span></span>) { newConn = getConnection(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { newConn = (Connection) availableConns.lastElement(); availableConns.removeElement(newConn); } usedConns.addElement(newConn); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newConn; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">putback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Connection c)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NullPointerException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (usedConns.removeElement(c)) { availableConns.addElement(c); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NullPointerException(<span class="hljs-string"><span class="hljs-string">"Connection not in the usedConns array"</span></span>); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAvailableConnsCnt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> availableConns.size(); } }</code> </pre><br>  upd.  changed the putback according to the comment. <br></div><p>Source: <a href="https://habr.com/ru/post/229199/">https://habr.com/ru/post/229199/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../229187/index.html">Games for NES / Famicom / Dandy through the eyes of a programmer</a></li>
<li><a href="../229189/index.html">Custom javascript events</a></li>
<li><a href="../229191/index.html">PHP Zend certification today</a></li>
<li><a href="../229195/index.html">Overview of the firewall and intrusion prevention system of a new generation of SourceFire FirePower</a></li>
<li><a href="../229197/index.html">Firefly Alpha lightweight reusable booster design</a></li>
<li><a href="../229203/index.html">HP Network Simulator is available for public use!</a></li>
<li><a href="../229205/index.html">How to tame a dragon using Intel technology?</a></li>
<li><a href="../229211/index.html">How to eat whale or the story of creating a line of mobile products</a></li>
<li><a href="../229213/index.html">Learning Java EE 7</a></li>
<li><a href="../229215/index.html">Completion of Livolo light load switches</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>