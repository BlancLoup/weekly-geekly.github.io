<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Workflow in Document Approval System</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When a .NET developer hears the words ‚ÄúYou need to add workflow to the project,‚Äù the first thing that comes to mind is the idea of ‚Äã‚Äãtaking on Windows...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Workflow in Document Approval System</h1><div class="post__text post__text-html js-mediator-article">  When a .NET developer hears the words ‚ÄúYou need to add workflow to the project,‚Äù the first thing that comes to mind is the idea of ‚Äã‚Äãtaking on Windows Workflow Foundation. <br><br>  In 2010, we chose WF as a document flow engine. <br><br>  The arguments are simple: <br><ul><li>  Is free; </li><li>  Built into Visual Studio; </li><li>  There is a lot of information about using WF on the Internet. </li></ul><br>  For a year and a half (from August 2010 to February 2012) of using WF, we faced a lot of various problems in meeting customer requirements.  In the end, we were forced to abandon Windows Workflow Foundation and make our implementation of State Machine. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article I will talk about the main problems that we faced, and how to solve (or not solved). <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  In my opinion, there are two articles that describe well the use of WF in the Document Approval System. <br>  For WWF 3: <a href="http://www.codeproject.com/Articles/17964/Document-approval-workflow-system">‚ÄúDocument approval workflow system‚Äù</a> ; <br>  For WWF 4: <a href="http://habrahabr.ru/company/luxoft/blog/182746/">"Overview of Windows Workflow Foundation on the example of building an electronic document management system</a> . <a href="http://habrahabr.ru/company/luxoft/blog/182746/">"</a> <br><br>  They describe well, but describe only the tip of the iceberg. <br><br>  In short, these articles describe how: <br><ul><li>  Draw a diagram; </li><li>  How to move the document on the route; </li><li>  How to specify traffic conditions. </li></ul><br>  The implementation of even these simple operations requires very substantial labor costs and is not complete without crutches and dances with a tambourine.  We danced with this tambourine. <br><br>  Unlike a colleague from Luxoft, I <s>plucked up courage and</s> laid out our implementation of the workflow module on WWF 3.5 "as is" in public access. <br><br>  URL: <a href="https://github.com/optimajet/WorkflowEngine.NET/tree/master/Other/WorkflowFoundation/Budget.Server">Budget.Server</a> <br><div class="spoiler">  <b class="spoiler_title">Brief information about the project</b> <div class="spoiler_text">  The project consists of two parts: client WinForms-application and server part. <br>  The link published source of the server. <br>  The server part is responsible for document circulation and integration with external systems. <br><br>  <b>Workflow</b> schemes are in the <b>Budget2.Workflow</b> project (We used WWF 3.5, but the same problems remained in WWF 4). <br>  API for working with workflow in the file: <b>Budget.Server \ API \ Services \ WorkflowAPI.cs</b> <br></div></div><br>  So let's go. <br><br><h2>  How we fought Workflow Foundation </h2><br>  You connected WF to the project, learned how to move the document along the route, indicated the conditions for changing status.  How to do this is written in the articles that I cited above. <br><br>  Then the fun begins ... <br><br><img src="https://habrastorage.org/files/260/089/9cd/2600899cdcb642219be503ea10fae011.jpeg"><br><br><h4>  Getting a list of available commands for a user </h4><br>  WF does not support Commands and Actors (the author of the document, the head of the author, the controller, the manager). <br>  It needs to be implemented independently.  Moreover, if in the WWF 4 version you can get a list of Bookmarks, then in version 3.5 this could not be done and you had to store the list of commands for each state separately. <br><br><img src="https://habrastorage.org/files/51b/232/a83/51b232a83b2046f49b3b799047c8fb3c.jpg"><br><br>  I will quote the author from the above article: <br><blockquote>  In addition, a separate set of metadata is separately stored for each General activity: launch privileges, document types for which the activity is allowed to run, Dynamic LINQ expression to the document for testing the launch capability, and others. </blockquote><br>  For <b>each</b> activity <b>separately,</b> you need to specify a set of metadata, by which then you need to check access. <br>  That's right, we did the same. <br>  Once this can be done, keeping it up to date is difficult. <br><br><h4>  Getting the list of incoming documents </h4><br>  We implement this requirement after the scheme has been implemented in WF. <br>  The problem was simple enough: we could determine <i>if the user could agree on a specific document at the current stage</i> , but <i>we could not get a list of all the users who could agree on a document at this stage</i> .  In the system of the order of 300-400 users, the problem was not solved by sorting. <br><br>  This forced us to write a filter that made a selection of documents available for approval by the current user, depending on the user's roles, his place in the hierarchy of departments, document attributes and other parameters. <br><br><img src="https://habrastorage.org/files/499/f7e/87e/499f7e87e00c4468a440f5b284fa0f27.jpg"><br><br><div class="spoiler">  <b class="spoiler_title">Filter example</b> <div class="spoiler_text">  Process statuses are listed in enum BillDemandStateEnum. <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetFilter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { List&lt;Guid&gt; deputyIds = DeputyEmployeeRepository.GetReplaceableEmployeeIdentityIds(DocumentType.BillDemand,EmployeeRepository.CurrentEmployee, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> idsString = StringUtil.GetString(deputyIds); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> opSubfilter = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format( <span class="hljs-string"><span class="hljs-string">"SELECT dbd.{0} FROM {1} dbd INNER JOIN {2} ON dbd.{0} = {3} INNER JOIN {4} ON {5} = {6} LEFT OUTER JOIN {7} ON dbd.{0} = {8} AND {9} = {10} WHERE {11} IS NULL"</span></span>, BillDemandTableBase.SelectColumn_Id, BillDemandTableBase.DEFAULT_NAME, BillDemandDistributionTableBase.DEFAULT_NAME, BillDemandDistributionTableBase.FilterColumn_BillDemandDistribution_BillDemandId, DemandTableBase.DEFAULT_NAME, BillDemandDistributionTableBase.FilterColumn_BillDemandDistribution_DemandId, DemandTableBase.FilterColumn_Demand_Id, WorkflowSightingTableBase.DEFAULT_NAME, WorkflowSightingTableBase.FilterColumn_WorkflowSighting_EntityId, DemandTableBase.FilterColumn_Demand_ExecutorStructId, WorkflowSightingTableBase.FilterColumn_WorkflowSighting_ItemId, WorkflowSightingTableBase.FilterColumn_WorkflowSighting_Id ); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> limitSubfilter = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format( <span class="hljs-string"><span class="hljs-string">"SELECT {0} FROM {1} WHERE {2} = {3} AND {4} = {5} AND {6} IS NULL AND {7} IN ({8}) "</span></span>, WorkflowSightingTableBase.SelectColumn_Id, WorkflowSightingTableBase.DEFAULT_NAME, BillDemandTableBase.FilterColumn_BillDemand_Id, WorkflowSightingTableBase.FilterColumn_WorkflowSighting_EntityId, WorkflowSightingTableBase.SelectColumn_StateId, BillDemandTableBase.FilterColumn_BillDemand_BillDemandStateId, WorkflowSightingTableBase.SelectColumn_SightingTime, WorkflowSightingTableBase.SelectColumn_SighterId, idsString); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> filter = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format( <span class="hljs-string"><span class="hljs-string">"({0} IN ({1},{2}) AND {3} IN ({4})) OR ( EXISTS ({5}) )"</span></span>, BillDemandTableBase.FilterColumn_BillDemand_BillDemandStateId, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) BillDemandStateEnum.Draft, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) BillDemandStateEnum.PostingAccounting, BillDemandTableBase.FilterColumn_BillDemand_AuthorId, idsString, limitSubfilter); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SecurityHelper.IsPrincipalsInRole(deputyIds, SecurityHelper.ControllerRoleId)) filter += <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">" OR {0} = {1}"</span></span>, BillDemandTableBase.FilterColumn_BillDemand_BillDemandStateId, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) BillDemandStateEnum.UPKZControllerSighting); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SecurityHelper.IsPrincipalsInRole(deputyIds, SecurityHelper.CuratorRoleId)) filter += <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">" OR {0} = {1}"</span></span>, BillDemandTableBase.FilterColumn_BillDemand_BillDemandStateId, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) BillDemandStateEnum.UPKZCuratorSighting); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SecurityHelper.IsPrincipalsInRole(deputyIds, SecurityHelper.UPKZHeadRoleId)) filter += <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">" OR {0} = {1}"</span></span>, BillDemandTableBase.FilterColumn_BillDemand_BillDemandStateId, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) BillDemandStateEnum.UPKZHeadSighting); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SecurityHelper.IsPrincipalsAccountant(deputyIds, BudgetPart)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CommonSettings.CheckAccountingInFilial) { filter += <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">" OR ({0} = {1} AND {2} = '{3}')"</span></span>, BillDemandTableBase.FilterColumn_BillDemand_BillDemandStateId, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) BillDemandStateEnum.InAccounting, BillDemandTableBase.FilterColumn_BillDemand_FilialId, EmployeeRepository.CurrentEmployeeFilialId); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { filter += <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">" OR ({0} = {1})"</span></span>, BillDemandTableBase.FilterColumn_BillDemand_BillDemandStateId, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)BillDemandStateEnum.InAccounting ); } } List&lt;Guid&gt; deputyDivisionHeads = SecurityHelper.GetPrincipalsDivisionHead(deputyIds, BudgetPart); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (deputyDivisionHeads.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> currentEmployeeChildrenStructs = EmployeeRepository.CurrentEmployeeChildrenStructs.Replace(<span class="hljs-string"><span class="hljs-string">"("</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>).Replace(<span class="hljs-string"><span class="hljs-string">")"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> deputyDevisionHeadString = StringUtil.GetString(deputyDivisionHeads); filter += <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format( <span class="hljs-string"><span class="hljs-string">" OR ({0} = {1} AND EXISTS (SELECT vp.Id FROM [dbo].[vStructDivisionParentsAndThis] vp INNER JOIN {2} e ON vp.ParentId = e.{3} WHERE vp.Id = {4} AND e.{5} IN ({6})))"</span></span>, BillDemandTableBase.FilterColumn_BillDemand_BillDemandStateId, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)BillDemandStateEnum.HeadInitiatorSighting, EmployeeRepository.DEFAULT_NAME, EmployeeRepository.SelectColumn_StructDivisionId, BillDemandTableBase.FilterColumn_AuthorStructDivision_Id, EmployeeRepository.SelectColumn_SecurityTrusteeId, deputyDevisionHeadString ); filter += <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format( <span class="hljs-string"><span class="hljs-string">" OR ({0} = {1} AND {2} &gt; 0 AND EXISTS ({3} AND {4} IN ({5}) AND dbd.{6} = {7}))"</span></span>, BillDemandTableBase.FilterColumn_BillDemand_BillDemandStateId, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) BillDemandStateEnum.LimitManagerSighting, BillDemandTableBase.FilterColumn_BillDemand_BudgetPartId, opSubfilter, DemandTableBase.FilterColumn_Demand_ExecutorStructId, currentEmployeeChildrenStructs, BillDemandTableBase.SelectColumn_Id, BillDemandTableBase.FilterColumn_BillDemand_Id); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> filter; }</code> </pre> <br></div></div><br>  These filters took us 2 weeks. <br><br><h4>  Schema versioning </h4><br>  There is no built-in versioning and updating process schema in Windows Workflow Foundation 3.5. <br>  The situation hasn't changed in WF 4 - <a href="http://weblogs.asp.net/gabriellopez/version-handling-in-workflow-foundation-4">Version handling in Workflow Foundation 4</a> . <br><br><img src="https://habrastorage.org/files/4fd/5ea/94b/4fd5ea94b3ed4ac6a0ecd0f3db26b0ec.jpg"><br><br>  If the process is running, then updating the march pattern is simply not possible.  To update the scheme you need to have an old scheme and dance a little with a tambourine.  We danced for about a week or two, but made a more or less working <a href="">mechanism for updating the schemes</a> .  Now our project is regularly updated with DDL with the names Workflow.xxx.dll, where xxx is the number of the old version. <br><br><h4>  Reconciliation history ... with enumeration of future stages </h4><br>  The implementation of the matching history is a trivial thing.  It is necessary to save information in the nameplate who, when and on which button is pressed.  But the simple story of client reconciliation did not suit. <br><br>  The client wanted the system to show the list of remaining stages for approval (future stages) and for each such stage list the list of users who can approve the document separated by commas. <br><br><img src="https://habrastorage.org/files/59f/ba4/dd5/59fba4dd5b6241f5ac41f6014251ea9d.jpg"><br><br>  On this dance tambourine around the WF we are bored.  Began to think how would we part with ... WF. <br><br><blockquote>  By the way, now we are solving this problem once or twice: there is a special mode in our product - Pre-Execution mode.  Which allows you to make a single run along the route and form future stages and potential coordinators. </blockquote><br><br><h4>  ‚ÄúGive us a designer‚Äù </h4><br>  To give the client a designer from WF, for obvious reasons, we could not.  I do not remember how, but somehow convinced the client that you should not do this at this stage. <br><br><img src="https://habrastorage.org/files/72b/220/e69/72b220e69f654045b73fde8f785b89fb.jpg"><br><br><h4>  Dynamically add states to a schema </h4><br>  A year later, the client wanted the new states from a special directory to be added to the document‚Äôs route according to certain conditions. <br><br><img src="https://habrastorage.org/files/48b/001/b62/48b001b62f39466f922db6a30fcc1ec8.jpg"><br><br>  We could not find a single example where the mechanism for generating the process diagram would be shown.  Therefore, they did not even try to do it.  We asked the client to wait a couple of months while we migrate from WF to our development.  The customer is treated with understanding.  Thank you very much for it. <br><br>  <i>If someone implemented a similar case on WF, share an example, it is very interesting to look at it.</i> <br><br><h4>  Support </h4><br>  After successful implementation, the development of the system has not stopped.  New requirements were received regularly. <br>  We made changes to the route map and after each update we received bugs from the series: <br><br><ul><li>  Why doesn't the user see the document that needs to be agreed? </li><li>  Why does the user see the document but cannot agree? </li><li>  Why does the user agree on the document, and his error takes off? </li></ul><br>  This is a typical situation for cases where the logic is duplicated (part of the conditions in WF, part in the metadata, part in the SQL filter for incoming). <br><br>  Added to this is the fact that the WF gave out incomprehensible errors that clearly could not be interpreted.  Several times I had to go to the site to the client. <br><br><h2>  Let's sum up </h2><br>  If you make an information system where there is a coordination function, then with a 99% probability you will encounter most of the cases listed above.  Not every company can afford to implement this on WF.  Not every customer will be willing to pay for it. <br><br>  For ourselves, we made a choice - we wrote our Workflow Engine .NET engine and successfully apply it in our projects. <br>  In it, we took into account our experience in implementing a class of systems - the Document Approval System. <br><br><img src="https://habrastorage.org/files/ba2/255/321/ba2255321e7e47589ce2f9d486be6a20.jpg"></div><p>Source: <a href="https://habr.com/ru/post/248525/">https://habr.com/ru/post/248525/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248509/index.html">Qt Android and system audio control dialog</a></li>
<li><a href="../248511/index.html">Website without backend: user authentication in BaaS parse.com through social networks</a></li>
<li><a href="../248517/index.html">CMakeProjectManager2: a bit of convenience when working with CMake in Qt Creator</a></li>
<li><a href="../248519/index.html">PID problem 1 zombie reaping in Docker</a></li>
<li><a href="../248521/index.html">We collect bad data - 2. 1.5 years later, about how not to publish open data</a></li>
<li><a href="../248527/index.html">How to write great pull requests</a></li>
<li><a href="../248529/index.html">HP server conference online ‚Äî only 10 days to win 2 tablets</a></li>
<li><a href="../248531/index.html">Ubiquiti lightning protection. Recommendations for connecting devices without a grounding screw on the case</a></li>
<li><a href="../248535/index.html">10 reasons why you are not a tester</a></li>
<li><a href="../248539/index.html">Calculating the time of sunset and sunrise on the coordinates of the Android device using earthtools</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>