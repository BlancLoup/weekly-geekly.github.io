<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Autoconfiguration with Puppet and AWS Cloud Formation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So the day came when it was necessary to put aside cookbooks, recipes, a chef's knife and a little work with puppets. 
 To begin with, the formulation...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Autoconfiguration with Puppet and AWS Cloud Formation</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/200/79c/fe5/20079cfe55c72ed0ce9ed5b9ac52108a.jpg" alt="image" align="left">  So the day came when it was necessary to put aside cookbooks, recipes, a chef's knife and a little work with puppets. <br>  To begin with, the formulation of the problem is rather trivial - to arrange for developers the ability to quickly and easily deploy the environment.  Mandatory requirement - for autoconfiguration to use <a href="http://puppetlabs.com/puppet/puppet-enterprise">Puppet Enterprise</a> <a name="habracut"></a><br>  So, in more detail about the necessary environment.  It will consist of two components, the first one is FrontEnd, the functions of which are performed by the IIS server, the second one is BackEnd, which will contain some actually developed Worker service and the MongoDB database.  Both components, as already understood, will be implemented on Windows Server.  The sources for the FrontEnd content and the Worker service will be taken from AWS S3, where they are regularly added every night by Jenkins. <br><br><h5>  Create Cloud Fromation Template </h5><br>  Implementing a Cloud Formation template that will start two Windows servers is absolutely not difficult.  It is much more interesting to figure out how to tell Puppet what configuration to apply to these servers. <br>  In the official documentation, Puppet proposes applying regular expressions to the client‚Äôs hostname, which in our case is not convenient to use, since the AWN Amazon hostname is issued automatically and can change after the instance's stop-start, that is, I would be forced to invent a post-start script that should change the hostname of the machine and only then start the puppet agent. <br>  Having rummaged still in documentation, I found that it is necessary - <a href="http://docs.puppetlabs.com/guides/custom_facts.html">Custom External Facts</a> .  For those who work with Chef Server, the facts are the equivalent of attributes. <br>  To add your facts to the Windows machine, you need to create a bat or ps1 file of the following content and put it in " <b>C: \ ProgramData \ PuppetLabs \ facter \ facts.d \"</b> . <br><pre><code class="dos hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> node_role=frontend <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> app_version=Build1.<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Where serverRole is, as the name implies, the role that will be assigned to the server, and buildNumber is the version of the application that will be downloaded from S3 AWS. <br>  This file will be created by the Cloud Formation template. <br><div class="spoiler">  <b class="spoiler_title">DevEnv.tmpl</b> <div class="spoiler_text"><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"AWSTemplateFormatVersion"</span></span> : <span class="hljs-string"><span class="hljs-string">"2010-09-09"</span></span>, <span class="hljs-string"><span class="hljs-string">"Description"</span></span> : <span class="hljs-string"><span class="hljs-string">"Developers Stack"</span></span>, <span class="hljs-string"><span class="hljs-string">"Parameters"</span></span> : { <span class="hljs-string"><span class="hljs-string">"KeyName"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Description"</span></span> : <span class="hljs-string"><span class="hljs-string">"Key-pair name"</span></span>, <span class="hljs-string"><span class="hljs-string">"Type"</span></span> : <span class="hljs-string"><span class="hljs-string">"String"</span></span> }, <span class="hljs-string"><span class="hljs-string">"SuffixName"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Description"</span></span> : <span class="hljs-string"><span class="hljs-string">"Suffix for all created resources"</span></span>, <span class="hljs-string"><span class="hljs-string">"Type"</span></span> : <span class="hljs-string"><span class="hljs-string">"String"</span></span> }, <span class="hljs-string"><span class="hljs-string">"FrontEndInstanceType"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Type"</span></span> : <span class="hljs-string"><span class="hljs-string">"String"</span></span>, <span class="hljs-string"><span class="hljs-string">"Default"</span></span> : <span class="hljs-string"><span class="hljs-string">"m1.small"</span></span>, <span class="hljs-string"><span class="hljs-string">"AllowedValues"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"m1.small"</span></span>, <span class="hljs-string"><span class="hljs-string">"m1.medium"</span></span>, <span class="hljs-string"><span class="hljs-string">"m1.large"</span></span>, <span class="hljs-string"><span class="hljs-string">"m1.xlarge"</span></span>], <span class="hljs-string"><span class="hljs-string">"Description"</span></span> : <span class="hljs-string"><span class="hljs-string">"EC2 instance type"</span></span> }, <span class="hljs-string"><span class="hljs-string">"BackEndInstanceType"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Type"</span></span> : <span class="hljs-string"><span class="hljs-string">"String"</span></span>, <span class="hljs-string"><span class="hljs-string">"Default"</span></span> : <span class="hljs-string"><span class="hljs-string">"m1.small"</span></span>, <span class="hljs-string"><span class="hljs-string">"AllowedValues"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"m1.small"</span></span>, <span class="hljs-string"><span class="hljs-string">"m1.medium"</span></span>, <span class="hljs-string"><span class="hljs-string">"m1.large"</span></span>, <span class="hljs-string"><span class="hljs-string">"m1.xlarge"</span></span>], <span class="hljs-string"><span class="hljs-string">"Description"</span></span> : <span class="hljs-string"><span class="hljs-string">"EC2 instance type"</span></span> }, <span class="hljs-string"><span class="hljs-string">"PuppetServer"</span></span>: { <span class="hljs-string"><span class="hljs-string">"Description"</span></span> : <span class="hljs-string"><span class="hljs-string">"Puppet Server URL"</span></span>, <span class="hljs-string"><span class="hljs-string">"Type"</span></span> : <span class="hljs-string"><span class="hljs-string">"String"</span></span>, <span class="hljs-string"><span class="hljs-string">"Default"</span></span> : <span class="hljs-string"><span class="hljs-string">"ec2-231-231-123-123.us-west-2.compute.amazonaws.com"</span></span> }, <span class="hljs-string"><span class="hljs-string">"Zone"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Type"</span></span> : <span class="hljs-string"><span class="hljs-string">"CommaDelimitedList"</span></span>, <span class="hljs-string"><span class="hljs-string">"Description"</span></span> : <span class="hljs-string"><span class="hljs-string">"The Availability Zone "</span></span>, <span class="hljs-string"><span class="hljs-string">"Default"</span></span> : <span class="hljs-string"><span class="hljs-string">"us-west-2c"</span></span> }, <span class="hljs-string"><span class="hljs-string">"BuildVersion"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Type"</span></span> : <span class="hljs-string"><span class="hljs-string">"String"</span></span>, <span class="hljs-string"><span class="hljs-string">"Description"</span></span> : <span class="hljs-string"><span class="hljs-string">"Version of application build"</span></span> }, <span class="hljs-string"><span class="hljs-string">"RoleName"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Type"</span></span> : <span class="hljs-string"><span class="hljs-string">"String"</span></span>, <span class="hljs-string"><span class="hljs-string">"Description"</span></span> : <span class="hljs-string"><span class="hljs-string">"Instance IAM role"</span></span>, <span class="hljs-string"><span class="hljs-string">"Default"</span></span> : <span class="hljs-string"><span class="hljs-string">"WebInstance"</span></span> }, <span class="hljs-string"><span class="hljs-string">"SecurityGroup"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Type"</span></span> : <span class="hljs-string"><span class="hljs-string">"String"</span></span>, <span class="hljs-string"><span class="hljs-string">"Description"</span></span> : <span class="hljs-string"><span class="hljs-string">"Default security group for stack"</span></span>, <span class="hljs-string"><span class="hljs-string">"Default"</span></span> : <span class="hljs-string"><span class="hljs-string">"taws-security-group"</span></span> } }, <span class="hljs-string"><span class="hljs-string">"Mappings"</span></span> : { <span class="hljs-string"><span class="hljs-string">"WindowsInstanceType"</span></span> : { <span class="hljs-string"><span class="hljs-string">"t1.micro"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Arch"</span></span> : <span class="hljs-string"><span class="hljs-string">"64"</span></span> }, <span class="hljs-string"><span class="hljs-string">"m1.small"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Arch"</span></span> : <span class="hljs-string"><span class="hljs-string">"64"</span></span> }, <span class="hljs-string"><span class="hljs-string">"m1.medium"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Arch"</span></span> : <span class="hljs-string"><span class="hljs-string">"64"</span></span> }, <span class="hljs-string"><span class="hljs-string">"m1.large"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Arch"</span></span> : <span class="hljs-string"><span class="hljs-string">"64"</span></span> }, <span class="hljs-string"><span class="hljs-string">"m1.xlarge"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Arch"</span></span> : <span class="hljs-string"><span class="hljs-string">"64"</span></span> } }, <span class="hljs-string"><span class="hljs-string">"WindowsRegionMap"</span></span> : { <span class="hljs-string"><span class="hljs-string">"us-east-1"</span></span> : { <span class="hljs-string"><span class="hljs-string">"AMI"</span></span> : <span class="hljs-string"><span class="hljs-string">"ami-e55a7e8c"</span></span> }, <span class="hljs-string"><span class="hljs-string">"us-west-2"</span></span> : { <span class="hljs-string"><span class="hljs-string">"AMI"</span></span> : <span class="hljs-string"><span class="hljs-string">"ami-1e53c82e"</span></span> }, <span class="hljs-string"><span class="hljs-string">"us-west-1"</span></span> : { <span class="hljs-string"><span class="hljs-string">"AMI"</span></span> : <span class="hljs-string"><span class="hljs-string">"ami-b687b1f3"</span></span> }, <span class="hljs-string"><span class="hljs-string">"eu-west-1"</span></span> : { <span class="hljs-string"><span class="hljs-string">"AMI"</span></span> : <span class="hljs-string"><span class="hljs-string">"ami-5f3ad728"</span></span> }, <span class="hljs-string"><span class="hljs-string">"ap-southeast-1"</span></span> : { <span class="hljs-string"><span class="hljs-string">"AMI"</span></span> : <span class="hljs-string"><span class="hljs-string">"ami-96cd98c4"</span></span> }, <span class="hljs-string"><span class="hljs-string">"ap-southeast-2"</span></span> : { <span class="hljs-string"><span class="hljs-string">"AMI"</span></span> : <span class="hljs-string"><span class="hljs-string">"ami-ab4a2daa"</span></span> }, <span class="hljs-string"><span class="hljs-string">"ap-northeast-1"</span></span> : { <span class="hljs-string"><span class="hljs-string">"AMI"</span></span> : <span class="hljs-string"><span class="hljs-string">"ami-133fa329"</span></span> }, <span class="hljs-string"><span class="hljs-string">"sa-east-1"</span></span> : { <span class="hljs-string"><span class="hljs-string">"AMI"</span></span> : <span class="hljs-string"><span class="hljs-string">"ami-bd3d9ba0"</span></span> } } }, <span class="hljs-string"><span class="hljs-string">"Resources"</span></span> : { <span class="hljs-string"><span class="hljs-string">"FrontEnd"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Type"</span></span> : <span class="hljs-string"><span class="hljs-string">"AWS::EC2::Instance"</span></span>, <span class="hljs-string"><span class="hljs-string">"Properties"</span></span> : { <span class="hljs-string"><span class="hljs-string">"KeyName"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"KeyName"</span></span> }, <span class="hljs-string"><span class="hljs-string">"ImageId"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Fn::FindInMap"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"WindowsRegionMap"</span></span>, { <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"AWS::Region"</span></span> }, <span class="hljs-string"><span class="hljs-string">"AMI"</span></span> ]}, <span class="hljs-string"><span class="hljs-string">"InstanceType"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"FrontEndInstanceType"</span></span> }, <span class="hljs-string"><span class="hljs-string">"IamInstanceProfile"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"RoleName"</span></span> }, <span class="hljs-string"><span class="hljs-string">"SecurityGroups"</span></span> : [{ <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"SecurityGroup"</span></span> }], <span class="hljs-string"><span class="hljs-string">"Tags"</span></span> : [ {<span class="hljs-string"><span class="hljs-string">"Key"</span></span> : <span class="hljs-string"><span class="hljs-string">"Name"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Fn::Join"</span></span> : [<span class="hljs-string"><span class="hljs-string">""</span></span>,[{<span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"SuffixName"</span></span>},<span class="hljs-string"><span class="hljs-string">"-DEV-FrontEnd"</span></span>]]}} ], <span class="hljs-string"><span class="hljs-string">"UserData"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Fn::Base64"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Fn::Join"</span></span> : [<span class="hljs-string"><span class="hljs-string">""</span></span>, [ <span class="hljs-string"><span class="hljs-string">"&lt;powershell&gt;\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$MsiUrl = \"https://s3-us-west-2.amazonaws.com/mybucket/puppet.msi\"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$downloadPath = \"c:\\puppet.msi\"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$webClient = New-Object System.Net.WebClient\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$webClient.DownloadFile($MsiUrl, $downloadPath)\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$process = Start-Process -File $downloadPath -arg \"/qn /norestart\" -PassThru |wait-process\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$PublicHostName = Invoke-RestMethod -Uri http://169.254.169.254/latest/meta-data/public-hostname -Method Get\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"Clear-Content 'C:\\ProgramData\\PuppetLabs\\puppet\\etc\\puppet.conf'\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"Add-Content 'C:\\ProgramData\\PuppetLabs\\puppet\\etc\\puppet.conf' \"[main]\", \"runinterval=300\", \"certname=$PublicHostName\", \"server="</span></span>,{ <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"PuppetServer"</span></span> },<span class="hljs-string"><span class="hljs-string">"\", \"environment="</span></span>,{ <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"PuppetEnvironment"</span></span> },<span class="hljs-string"><span class="hljs-string">"\"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"Add-Content 'C:\\ProgramData\\PuppetLabs\\facter\\facts.d\\facts.bat' \"@echo off\", \"echo node_role=frontend\", \"echo app_version="</span></span>,{ <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"BuildVersion"</span></span> },<span class="hljs-string"><span class="hljs-string">"\"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"Restart-Service pe-puppet\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$MsiUrl = \"https://s3-us-west-2.amazonaws.com/mybucket/7zip.msi\"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$downloadPath = \"c:\\7zip.msi\"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$webClient = New-Object System.Net.WebClient\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$webClient.DownloadFile($MsiUrl, $downloadPath)\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$process = Start-Process -File $downloadPath -arg \"/qn \" -PassThru |wait-process\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;/powershell&gt;\n"</span></span> ]]}} } }, <span class="hljs-string"><span class="hljs-string">"BackEnd"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Type"</span></span> : <span class="hljs-string"><span class="hljs-string">"AWS::EC2::Instance"</span></span>, <span class="hljs-string"><span class="hljs-string">"Properties"</span></span> : { <span class="hljs-string"><span class="hljs-string">"KeyName"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"KeyName"</span></span> }, <span class="hljs-string"><span class="hljs-string">"ImageId"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Fn::FindInMap"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"WindowsRegionMap"</span></span>, { <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"AWS::Region"</span></span> }, <span class="hljs-string"><span class="hljs-string">"AMI"</span></span> ]}, <span class="hljs-string"><span class="hljs-string">"InstanceType"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"BackEndInstanceType"</span></span> }, <span class="hljs-string"><span class="hljs-string">"IamInstanceProfile"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"RoleName"</span></span> }, <span class="hljs-string"><span class="hljs-string">"SecurityGroups"</span></span> : [{ <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"SecurityGroup"</span></span> }], <span class="hljs-string"><span class="hljs-string">"Tags"</span></span> : [ {<span class="hljs-string"><span class="hljs-string">"Key"</span></span> : <span class="hljs-string"><span class="hljs-string">"Name"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Fn::Join"</span></span> : [<span class="hljs-string"><span class="hljs-string">""</span></span>,[{<span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"SuffixName"</span></span>},<span class="hljs-string"><span class="hljs-string">"-DEV-BackEnd"</span></span>]]}} ], <span class="hljs-string"><span class="hljs-string">"UserData"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Fn::Base64"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Fn::Join"</span></span> : [<span class="hljs-string"><span class="hljs-string">""</span></span>, [ <span class="hljs-string"><span class="hljs-string">"&lt;powershell&gt;\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$MsiUrl = \"https://s3-us-west-2.amazonaws.com/mybucket/puppet.msi\"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$downloadPath = \"c:\\puppet.msi\"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$webClient = New-Object System.Net.WebClient\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$webClient.DownloadFile($MsiUrl, $downloadPath)\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$process = Start-Process -File $downloadPath -arg \"/qn /norestart\" -PassThru |wait-process\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$PublicHostName = Invoke-RestMethod -Uri http://169.254.169.254/latest/meta-data/public-hostname -Method Get\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"Clear-Content 'C:\\ProgramData\\PuppetLabs\\puppet\\etc\\puppet.conf'\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"Add-Content 'C:\\ProgramData\\PuppetLabs\\puppet\\etc\\puppet.conf' \"[main]\", \"runinterval=300\", \"certname=$PublicHostName\", \"server="</span></span>,{ <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"PuppetServer"</span></span> },<span class="hljs-string"><span class="hljs-string">"\", \"environment="</span></span>,{ <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"PuppetEnvironment"</span></span> },<span class="hljs-string"><span class="hljs-string">"\"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"Add-Content 'C:\\ProgramData\\PuppetLabs\\facter\\facts.d\\facts.bat' \"@echo off\", \"echo node_role=backend\", \"echo app_version="</span></span>,{ <span class="hljs-string"><span class="hljs-string">"Ref"</span></span> : <span class="hljs-string"><span class="hljs-string">"BuildVersion"</span></span> },<span class="hljs-string"><span class="hljs-string">"\"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"Restart-Service pe-puppet\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$MsiUrl = \"https://s3-us-west-2.amazonaws.com/mybucket/7zip.msi\"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$downloadPath = \"c:\\7zip.msi\"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$webClient = New-Object System.Net.WebClient\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$webClient.DownloadFile($MsiUrl, $downloadPath)\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"$process = Start-Process -File $downloadPath -arg \"/qn \" -PassThru |wait-process\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;/powershell&gt;\n"</span></span> ]]}} } } }, <span class="hljs-string"><span class="hljs-string">"Outputs"</span></span> : { <span class="hljs-string"><span class="hljs-string">"FrontEndPublicDnsName"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Description"</span></span> : <span class="hljs-string"><span class="hljs-string">"Public IP address of FrontEnd"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Fn::Join"</span></span> : [<span class="hljs-string"><span class="hljs-string">""</span></span>,[{ <span class="hljs-string"><span class="hljs-string">"Fn::GetAtt"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"FrontEnd"</span></span>, <span class="hljs-string"><span class="hljs-string">"PublicDnsName"</span></span> ] }]]} }, <span class="hljs-string"><span class="hljs-string">"BackEndPublicDnsName"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Description"</span></span> : <span class="hljs-string"><span class="hljs-string">"Public IP address of BackEnd"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span> : { <span class="hljs-string"><span class="hljs-string">"Fn::Join"</span></span> : [<span class="hljs-string"><span class="hljs-string">""</span></span>,[{ <span class="hljs-string"><span class="hljs-string">"Fn::GetAtt"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"BackEnd"</span></span>, <span class="hljs-string"><span class="hljs-string">"PublicDnsName"</span></span> ]}]]} } } }</code> </pre><br></div></div><br>  Parameters that are used in the template: <br><ul><li>  KeyName - Key Name for Access </li><li>  SuffixName - A certain suffix that will be added to the Name tag (this may be the initials of the developer) </li><li>  FrontEndInstanceType - Shape Type for FrontEnd </li><li>  BackEndInstanceType - Shape Type for BackEnd </li><li>  PuppetServer - Url Your Puppet Server </li><li>  Zone - The zone in which the servers will be created. </li><li>  BuildVersion - Version of the application to be taken from S3 </li><li>  RoleName - IAM Role created in advance with ‚ÄúS3 Read-Only‚Äù rights </li><li>  SecurityGroup - Also pre-established security group </li></ul><br>  IAM Role and Security Group can be created by the same template, it will be even more correct.  In my example, this is not done in order to simplify understanding. <br>  In the UserData section, the puppet agent, 7zip is downloaded and installed, and puppet.conf and facts.bat are generated. <br>  With Cloud Formation finished, it's time to move on to setting up Puppet. <br><br><h5>  Configure Puppet Server Enterprise </h5><br>  To install Puppet Server Enterprise, you only need to download the <a href="http://puppetlabs.com/misc/pe-files/previous-releases">installer archive</a> , unpack and run puppet-server-installer.  To enable automatic client registration on the server, you need to create the <b>/etc/puppetlabs/puppet/autosign.conf</b> file <b>with the</b> following content: <br><pre> <code class="bash hljs">*</code> </pre><br>  Create the necessary modules.  Modules are some kind of kukbuk in Chef.  They are located in the <b>/ etc / puppetlabs / puppet / modules</b> folder. <br>  Simplified module structure: <br><ul><li>  <code>my_module/</code> - Directory name will be the name of the module. <br><ul><li>  <code>manifests/</code> - Contains module manifests. <br><ul><li>  <code>init.pp</code> - Contains one class <strong><code>my_module</code> .</strong>  <strong>The class name must be the same as the module name.</strong> </li><li>  <code>other_class.pp</code> - Contains another class of the module <strong><code>my_module::other_class</code> .</strong> </li></ul></li><li>  <code>files/</code> - Contains files that will be downloaded by the client. </li><li>  <code>lib/</code> - Contains plugins, custom facts </li><li>  <code>templates/</code> - Contains templates that can be used in the module <br><ul><li>  <code>component.erb</code> - This manifest will be available in the module as <code>template('my_module/component.erb')</code> . </li></ul></li></ul></li></ul><br>  First, add the necessary modules from PuppetLabs for IIS installation and management. <br><pre> <code class="bash hljs">puppet module install dism puppet module install opentable-iis</code> </pre><br>  Now we need to tweak the manifest for opentable-iis a bit <br><div class="spoiler">  <b class="spoiler_title">/etc/puppetlabs/puppet/modules/nodes/manifests/init.pp</b> <div class="spoiler_text">  class iis { <br>  iis :: manage_app_pool {"$ {fqdn}": <br>  enable_32_bit =&gt; true <br>  managed_runtime_version =&gt; 'v4.0', <br>  } -&gt; 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      iis :: manage_site {"$ {fqdn}": <br>  site_path =&gt; 'C: \ MyAppPath', <br>  port =&gt; '80', <br>  ip_address =&gt; '*', <br>  host_header =&gt; "$ {fqdn}", <br>  app_pool =&gt; "$ {fqdn}" <br>  } <br><br>  } <br></div></div><br>  I got seven modules (maybe the number will increase further). <br><ol><li>  <b>nodes</b> - the module that will, based on the value of <b>node_role</b> , connect the next necessary module <br><div class="spoiler">  <b class="spoiler_title">/etc/puppetlabs/puppet/modules/nodes/manifests/init.pp</b> <div class="spoiler_text">  class nodes { <br>  if "$ {node_role}" == "backend" { <br>  include backend <br>  } <br>  if "$ {node_role}" == "frontend" { <br>  include frontend <br>  } <br>  } <br></div></div><br></li><li>  <b>getbuild</b> - this module is needed for downloading and unpacking the application archive from AWS S3. <br><div class="spoiler">  <b class="spoiler_title">/etc/puppetlabs/puppet/modules/getbuild/manifests/init.pp</b> <div class="spoiler_text">  class getbuild { <br>  file {'c: \ config': <br>  ensure =&gt; 'directory' <br>  } -&gt; <br>  file {'c: \ Build': <br>  ensure =&gt; 'directory' <br>  } -&gt; <br>  exec {'download_build': <br>  creates =&gt; "c: \\ config \\ $ {app_version}", <br>  path =&gt; $ :: path, <br>  command =&gt; "powershell.exe -executionpolicy unrestricted start-bitstransfer -source <a href="https://s3-us-west-2.amazonaws.com/mybucket/">s3-us-west-2.amazonaws.com/mybucket</a> $ {app_version} -Destination 'c: \\ config \\'", <br>  } -&gt; <br>  exec {'app_install': <br>  creates =&gt; "c: \\ Build \ CustomBackendService.exe.config", <br>  command =&gt; "\" c: \\ Program Files \\ 7-Zip \\ 7z.exe \ "xc: \\ config \\ $ {app_version} -oC: \\ Build", <br>  } <br><br>  } <br></div></div><br></li><li>  <b>mongodb</b> - a module for installing MongoDB <br><div class="spoiler">  <b class="spoiler_title">/etc/puppetlabs/puppet/modules/mongodb/manifests/init.pp</b> <div class="spoiler_text">  class mongodb { <br>  file {'c: / config': <br>  ensure =&gt; directory, <br>  } -&gt; <br>  file {'c: /config/mongodb.zip': <br>  ensure =&gt; file, <br>  mode =&gt; '0777', <br>  source =&gt; 'puppet: ///modules/mongodb/mongodb-win32-x86_64-v2.4-latest.zip', <br>  } -&gt; <br>  file {'c: / MongoDB': <br>  ensure =&gt; directory, <br>  } -&gt; <br>  file {'c: / MongoDB / bin': <br>  ensure =&gt; directory, <br>  } -&gt; <br>  file {'c: / MongoDB / Data': <br>  ensure =&gt; directory, <br>  } -&gt; <br>  file {'c: / MongoDB / logs': <br>  ensure =&gt; directory, <br>  } -&gt; <br>  exec {'mongodb-unzip': <br>  creates =&gt; 'c: /MongoDB/bin/mongod.exe', <br>  command =&gt; "" c: \\ Program Files \\ 7-Zip \\ 7z.exe "ec: \\ config \ mongodb.zip -oC: \\ MongoDB \\ bin ', <br>  } -&gt; <br>  exec {'mongodb-install': <br>  creates =&gt; 'c: /MongoDB/logs/mongodb.log', <br>  command =&gt; "" c: \\ MongoDB \\ mongod.exe "--dbpath = c: \\ MongoDB \\ Data --port 27017 - logpath = c: \\ MongoDB \ logs \\ mongodb.log - install --serviceName mongodb --serviceDisplayName "MongoDB Server" --serviceDescription "MongoDB Server" ', <br>  } -&gt; <br>  exec {'mongodb-run': <br>  path =&gt; $ :: path, <br>  command =&gt; 'powershell.exe start-service mongodb' <br>  } <br>  } <br></div></div><br></li><li>  <b>api</b> - module for installing an application on FrontEnd <br><div class="spoiler">  <b class="spoiler_title">/etc/puppetlabs/puppet/modules/api/manifests/init.pp</b> <div class="spoiler_text">  class api { <br><br>  include getbuild <br><br>  dism {'IIS-WebServerRole': <br>  ensure =&gt; present, <br>  } -&gt; <br><br>  dism {'IIS-WebServer': <br>  ensure =&gt; present, <br>  require =&gt; Dism ['IIS-WebServerRole'], <br>  } <br><br>  } <br></div></div><br></li><li>  <b>worker</b> - module for installing the application on BackEnd <br><div class="spoiler">  <b class="spoiler_title">/etc/puppetlabs/puppet/modules/worker/manifests/init.pp</b> <div class="spoiler_text">  class worker { <br>  include getbuild <br>  exec {'service_install': <br>  creates =&gt; "c: \\ Build \\ Custom.AWS.BackendService.InstallLog", <br>  command =&gt; "c: \\ Build \\ Custom.AWS.BackendService.exe -install", <br>  } -&gt; <br>  exec {'service-run': <br>  path =&gt; $ :: path, <br>  command =&gt; 'powershell.exe start-service Custom.AWS.Backend' <br>  } <br>  } <br></div></div><br></li><li>  <b>frontend</b> - a module that connects all the necessary modules for FrontEnd to work <br><div class="spoiler">  <b class="spoiler_title">/etc/puppetlabs/puppet/modules/frontend/manifests/init.pp</b> <div class="spoiler_text">  class frontend { <br>  include api <br>  include iis <br>  } <br></div></div><br></li><li>  <b>backend</b> - a module that connects all the necessary modules for running BackEnd <br><div class="spoiler">  <b class="spoiler_title">/etc/puppetlabs/puppet/modules/backend/manifests/init.pp</b> <div class="spoiler_text">  class backend { <br>  include mongodb <br>  include worker <br>  } <br></div></div><br></li></ol><br><br>  In my manifestos, I used the <b>exec</b> resource almost everywhere.  With the properly selected <b>creates</b> option, this resource works flawlessly. <br>  More detail on one of the examples: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> { <span class="hljs-string"><span class="hljs-string">'mongodb-unzip'</span></span>: creates =&gt; <span class="hljs-string"><span class="hljs-string">'c:/MongoDB/bin/mongod.exe'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'"c:\\Program Files\\7-Zip\\7z.exe" ec:\\config\mongodb.zip -oC:\\MongoDB\\bin'</span></span>, }</code> </pre><br>  If the executable file <b>c: /MongoDB/bin/mongod.exe is</b> missing, the archive will be unpacked. <br><br>  Now, for convenience, you can create a task in your favorite CI system, for example <a href="http://jenkins-ci.org/">Jenkins</a> , place a script there to launch the Cloud Formation template and developers will be able to expand the environment in one click. <br><br>  That's all.  I hope this guide will be useful ... <br>  If among those who have read this article, there will be experts on the use of Puppet, I will hear your opinion with great gratitude. </div><p>Source: <a href="https://habr.com/ru/post/208710/">https://habr.com/ru/post/208710/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../208694/index.html">How to send a letter when you do not know gmail</a></li>
<li><a href="../208700/index.html">How sophomores their desktop environment wrote</a></li>
<li><a href="../208704/index.html">Budget SSH Tunnel to I2P Underwater World for Reindeer Herders</a></li>
<li><a href="../208706/index.html">Transfer of Google Analytics tracks to third-party domains without javascript</a></li>
<li><a href="../208708/index.html">Juniper JNCIE-ENT Network Expert Certification History</a></li>
<li><a href="../208714/index.html">CoolRF: DIY-dimmer and LED-lamps, is there a friendship?</a></li>
<li><a href="../208716/index.html">Algorithms and search data structures. Lectures and courses from Yandex</a></li>
<li><a href="../208718/index.html">C ++ idioms. Static visitor</a></li>
<li><a href="../208722/index.html">How to increase the conversion and the average check site search</a></li>
<li><a href="../208726/index.html">We program Raspberry Pi on bare iron</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>