<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Qt Model Tricks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 In this short article I will teach you one interesting trick with models that can be implemented using Qt's MVC framework. 

 Baseline data f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Qt Model Tricks</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br>  In this short article I will teach you one interesting trick with models that can be implemented using Qt's MVC framework. <br><br><h4>  Baseline data for the trick. </h4><br>  Two-level tree model: <br><pre><code class="hljs php">|<span class="hljs-keyword"><span class="hljs-keyword">Parent</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> -----Child <span class="hljs-number"><span class="hljs-number">1</span></span> -----Child N |<span class="hljs-keyword"><span class="hljs-keyword">Parent</span></span> N -----Child <span class="hljs-number"><span class="hljs-number">1</span></span> -----Child N</code> </pre> <br><br>  List Model: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">Item1</span></span> Item2 Item3</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a result of the trick, we will get a model combining the two models above: <br><pre> <code class="hljs ruby"><span class="hljs-params"><span class="hljs-params">|Parent 1 ------Child 1 ------Child N |</span></span>Parent N ------Child <span class="hljs-number"><span class="hljs-number">1</span></span> ------Child N <span class="hljs-params"><span class="hljs-params">|Item1 |</span></span>Item2 <span class="hljs-params"><span class="hljs-params">|Item3</span></span></code> </pre> <br><br><h4>  Let's start the implementation. </h4><br>  And so how to do it?  I think you already guessed that you can do this by using QAbstractProxyModel.  And no!  Unfortunately, the standard QAbstractProxyModel class can convert only one source model (which is also not bad).  Therefore, we will write our ModelJoinerProxy, which will compose our two source models into one. <br>  And so proceed: <br><br><a name="habracut"></a><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//  QAbstractItemModel     //   Qt class ModelJoinerProxy : public QAbstractItemModel { Q_OBJECT public: ModelJoinerProxy(QObject *parent = 0); QModelIndex index(int row, int column, const QModelIndex &amp;parent = QModelIndex()) const; QModelIndex parent(const QModelIndex &amp;child) const; int rowCount(const QModelIndex &amp;parent) const; int columnCount(const QModelIndex &amp;parent) const; QVariant data(const QModelIndex &amp;index, int role) const; Qt::ItemFlags flags(const QModelIndex &amp;index) const; //     1   virtual void setSourceModel1(QAbstractItemModel *sourceModel1); //     2   virtual void setSourceModel2(QAbstractItemModel *sourceModel2); //         virtual QModelIndex mapToSource(const QModelIndex &amp;) const; //         virtual QModelIndex mapFromSource(const QModelIndex &amp;) const; private slots: void source_dataChanged(QModelIndex, QModelIndex); void source_rowsAboutToBeInserted(QModelIndex p, int from, int to); void source_rowsInserted(QModelIndex p, int, int); void source_rowsAboutToBeRemoved(QModelIndex, int, int); void source_rowsRemoved(QModelIndex, int, int); void source_modelReset(); private: QAbstractItemModel *m1; QAbstractItemModel *m2; };</span></span></code> </pre> <br><br>  Our mediator model is a two-tier tree model, to achieve this we <br>  We redefine index (..) and parent (..) as if we are building a model of a regular tree. <br>  Next we need our model to have the correct number of rows and columns, <br>  (for simplicity, the number of columns in the original models and the intermediary model will be = 1) <br>  for this we override rowCount (....) and columnCount (.....). <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ModelJoinerProxy::rowCount(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QModelIndex &amp;parent) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//1  if (!parent.isValid()) count = m1-&gt;rowCount() + m2-&gt;rowCount(); //2  else if (parent.internalId() == -1) { //            m1 , //         if ( parent.row() &lt; m1-&gt;rowCount() ) count = m1-&gt;rowCount( m1-&gt;index(parent.row(),0) ); //                 //            else if ( parent.row() &gt; (m1-&gt;rowCount()-1) &amp;&amp; parent.row() &lt; (m1-&gt;rowCount() + m2-&gt;rowCount()) ) count = m2-&gt;rowCount(m2-&gt;index(parent.row()-m1-&gt;rowCount(), 0)); } return count; } int ModelJoinerProxy::columnCount(const QModelIndex &amp;parent) const { return 1; }</span></span></code> </pre> <br><br>  Now the most interesting thing is that we need to convert the indexes of our models so that they can <br>  interact with each other. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//         QModelIndex ModelJoinerProxy::mapToSource(const QModelIndex &amp; proxy) const { //       if ( proxy.row() &lt; m1-&gt;rowCount() &amp;&amp; !proxy.parent().isValid()) { return m1-&gt;index(proxy.row(),0) ; } //       if ( proxy.parent().isValid()) { return m1-&gt;index(proxy.row(),0, m1-&gt;index( proxy.parent().row(),0) ); } //     if ( proxy.row() &gt; (m1-&gt;rowCount()-1) &amp;&amp; proxy.row() &lt; (m1-&gt;rowCount() + m2-&gt;rowCount()) ) { int offset = (proxy.row() - m1-&gt;rowCount()); return m2-&gt;index(offset, 0); } return QModelIndex(); } //        QModelIndex ModelJoinerProxy::mapFromSource(const QModelIndex &amp;source) const { QModelIndex proxy; if (source.model() == m1) { //    if (!source.parent().isValid()) { proxy = index(source.row(), 0); } //    else { QModelIndex source_parent = index(source.parent().row() ,0); proxy = index(source.row(), 0, source_parent); } } //  if (source.model() == m2) { int offset = m1-&gt;rowCount() + source.row(); proxy = index(offset, 0); } return proxy; }</span></span></code> </pre> <br><br>  Now it only remains to redefine data (...) so that our model can give the data to the views (and to all whom we want). <br><br><pre> <code class="cpp hljs">QVariant ModelJoinerProxy::data(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QModelIndex &amp;index, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> role) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!index.isValid()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QVariant(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mapToSource(index).data(role); }</code> </pre> <br><br>  It is also necessary to connect all the necessary signals of source models to the corresponding slots of our model.  This is necessary in order for our model to react to any changes in source models. <br>  For example: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ModelJoinerProxy::setSourceModel1(QAbstractItemModel *sourceModel1) { m1 = sourceModel1; connect(m1, SIGNAL(dataChanged(QModelIndex,QModelIndex)), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, SLOT(source_dataChanged(QModelIndex,QModelIndex))); ........ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ModelJoinerProxy::setSourceModel2(QAbstractItemModel *sourceModel2) { m2 = sourceModel2; connect(m2, SIGNAL(dataChanged(QModelIndex,QModelIndex)), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, SLOT(source_dataChanged(QModelIndex,QModelIndex))); ........</code> </pre> <br><br>  and implement the slots themselves <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ModelJoinerProxy::source_dataChanged(QModelIndex tl, QModelIndex br) { QModelIndex p_tl = mapFromSource(tl); QModelIndex p_br = mapFromSource(br); <span class="hljs-function"><span class="hljs-function">emit </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dataChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p_tl, p_br)</span></span></span></span>; }</code> </pre> <br><br>  Well, that's all, our mediator model is ready, it remains only to connect the original models to it, and the mediator model itself to connect to the view.  You can optionally make it editable by overriding setData (...) <br><br><h4>  Conclusion </h4><br>  And why is all this really necessary?  I can not find the right words, but I think that people who <br>  The topic touched upon by me is really close to everyone.  For example, in my current project, a hierarchy of about 15 proxy models (self-written + standard) and only one source data model are added.  Without proxy models, this would take a lot more code, and as a result more bugs, problems with model synchronization, and so on. <br><br>  I hope that after reading this article, you will discover a new look at MVC in Qt, and you can do it yourself <br>  convert your data structures to fit your GUI needs. <br>  In general, it would be nice to have on hand an addition to MVC Qt consisting of a couple dozen of similar models of intermediaries.  For example, if you wanted to group your data by any parameters, use the mediator model for grouping, and so on. <br><br>  Many thanks to <a href="http://habrahabr.ru/users/yshurik/" class="user_link">yshurik</a> for patience and irreplaceable advice. </div><p>Source: <a href="https://habr.com/ru/post/126995/">https://habr.com/ru/post/126995/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126988/index.html">How to do the projects necessary to people, or why startups do not fly up</a></li>
<li><a href="../126989/index.html">Chrome Hackathon & Contest in St. Petersburg</a></li>
<li><a href="../126990/index.html">Do you use FirePHP in your projects?</a></li>
<li><a href="../126993/index.html">SaaS solutions, as a convenient continuation of outsourcing</a></li>
<li><a href="../126994/index.html">Windows 8: USB 3.0 support and smart file copying</a></li>
<li><a href="../126998/index.html">Good company conflict management</a></li>
<li><a href="../127002/index.html">What is better for you: mailto or form of sending a message from the site?</a></li>
<li><a href="../127004/index.html">Russian Wiki Encyclopedia "Tradition" now contains 27,000 articles</a></li>
<li><a href="../127005/index.html">Creating a horizontal scroll with gradient and arrows</a></li>
<li><a href="../127006/index.html">Short URLs on Google Maps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>