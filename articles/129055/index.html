<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing Perl Modules in Gentoo</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The biggest drawback of the Perl language ecosystem is the management of modules (another candidate for this role is the long-term Perl6 , but not abo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing Perl Modules in Gentoo</h1><div class="post__text post__text-html js-mediator-article"><img src="http://cdn.pimg.net/images/camel_head.png" alt="image" align="left">  The biggest drawback of the <a href="http://www.perl.org/">Perl</a> language ecosystem is the management of modules (another candidate for this role is the long-term <a href="http://www.perl6.org/">Perl6</a> , but not about it).  What is curious, the biggest advantage of this same ecosystem is the presence of a single archive of <a href="http://www.cpan.org/">CPAN</a> modules.  Amazingly, we were able to assemble and organize the modules, but we didn‚Äôt implement a convenient installation / update / removal. <br><br><h4>  A wealth of choice ... or another TIMTOWTDI </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/530/9f8/758/5309f875894dd400f0a8600c3924feda.png" alt="image" align="right">  There are many alternative approaches to this problem (and their number also indirectly indicates that none of them solves the problem well enough): <a href="">cpan</a> , <a href="http://search.cpan.org/~bingos/CPANPLUS/bin/cpanp">cpanplus</a> , <a href="">cpanminus</a> , <a href="">pip</a> , <a href="http://search.cpan.org/~markov/CPAN-Site/bin/cpansite">cpansite</a> , <a href="http://search.cpan.org/~rjbs/CPAN-Mini/bin/minicpan">minicpan</a> / <a href="http://search.cpan.org/~mithaldu/CPAN-Mini-Inject/bin/mcpani">mcpani</a> , <a href="http://search.cpan.org/~gugod/App-perlbrew/bin/perlbrew">perlbrew</a> , <a href="http://search.cpan.org/~tokuhirom/App-cpanoutdated/bin/cpan-outdated">cpan-outdated</a> , <a href="http://search.cpan.org/~miyagawa/cpan-listchanges/bin/cpan-listchanges">cpan -listchanges</a> , <a href="">local :: lib</a> , ... <br><br>  So we can have: <ul><li>  Several versions of perl itself (of course, each with its own global modules), including  installed in the user's home directory (see perlbrew). </li><li>  Global (available at start of perl) and local (connected from any directory / directories, usually located inside a separate project or in the user's home directory) modules. </li><li>  Global modules come in three types: core (that comes with perl), site (manually set by the admin) and vendor (installed by your OS package manager). </li><li>  All global modules are in the subdirectories "number.version.perl /", and no one automatically cleans these directories.  And when you install the new version of perl, new similar directories are created.  And perl loads modules from directories of all available previous versions.  So multiply core + site + vendor by the number of perl updates ‚Äî that‚Äôs the number of directories / options that your global modules are in. </li><li>  Sources of modules are also different: CPAN, local mirrors-overlays of CPAN with private modules, just their own or downloaded from the Internet modules missing in the CPAN-compatible system. </li></ul>  And all this joy must be administered: install, update, ... In Gentoo, to simplify the administration of global Perl modules, there is a <a href="">g-cpan utility</a> , so I want to tell you a little about it. <br><a name="habracut"></a><br><h4>  Workspace </h4><br>  To begin with, we specify a little what conditions we usually have to work in: <ol><li>  We are not talking about installing our modules on hosting, we <b>work with a whole server</b> / servers. </li><li>  <b>Several of our Perl projects are</b> running on this server. </li><li>  All who actively write on Perl write their modules.  And not all of its modules can and should be laid out on the CPAN.  All those who work on several projects use the same modules in different projects.  Therefore, this situation sooner or later leads to the need to raise the local CPAN mirror / overlay for its modules in order to be able to install and update them with ‚Äúregular‚Äù means - this does not solve the problem as a whole, but life becomes easier.  So <b>support for a local CPAN mirror / overlay is needed</b> . </li><li>  The question always arises: to put the necessary modules for the project (and its own and CPAN) globally (remember, we have our own server), or locally.  There can be no definite answer here, there are arguments both for and against both approaches.  I decided for myself this way: since it is necessary to administer (install, update, track outdated / full of holes versions, delete) <i>all</i> installed modules, and since it is impossible to assemble all the modules in one place (it‚Äôs impossible to get rid of global modules, because they are used by other system-wide applications, and completely without local modules, can‚Äôt be <i>managed</i> in most projects either), then you need to at least <i>minimize the number of such places and the total number of installed modules</i> .  What leads us to the fact that <b>most modules should be installed globally</b> , and locally you need to install modules only if the versions of global modules are not compatible with a specific project.  Yes, the main disadvantage of this approach is that updating global modules can break some projects - but firstly, in my experience, this happens quite rarely, and secondly, use a test server and check all updates on it before installing them on working servers - this should be done anyway, right?  :) As a last resort, the workstation of the main developer will be suitable for the role of the test server, but minimal testing of updates is necessary. </li></ol>  We have already made our life a bit easier by limiting the installation of modules from a CPAN-compatible local mirror / overlay (see cpansite) and installing most of the modules in a single copy globally.  The next problem: there are three global installation sites for the modules - <b>core, site and vendor</b> .  And because of this, conflicts often arise.  Previously, Gentoo‚Äôs priority was vendor-site-core.  Because of this, manually installed via cpan / cpanplus / etc.  In the site modules were often not available, because  vendor was an outdated version.  And utilities like cpan could infinitely update modules, not realizing that this does not work.  This was solved by removing all the modules from vendor, and manually typing them into /etc/portage/profile/package.provided so that the portage did not install them again (after which it was necessary to follow closely during system updates, so that the portage did not install the packages from dev- perl / * or perl-core / *, and, if necessary, install these packages via cpan and write them in package.provided).  Now site-vendor-core priority, but this also doesn‚Äôt completely solve the problem: some (and maybe I didn‚Äôt check) core modules, when updated with a utility like cpan, are not installed in the site, but in the core, on top of those versions which came together with perl itself.  This creates two unexpected effects: first, if the vendor has a different version of these core modules (from perl-core / * packages), then, despite the ‚Äúupdate‚Äù of the module, the cpan utility will still use the older version from vendor;  and secondly, reinstalling the dev-lang / perl package (for example, caused by revdep-rebuild) rolls back all updates of core modules installed manually via cpan. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  g-cpan </h4><br>  Given the above problems, as well as the inconvenience of "regular" tools like cpan / cpanplus, we smoothly approach that it would be great for all global modules to install, update and delete portazh means, like all other packages in the system.  If we completely abandon the manual installation of modules in the site, then all the problems of priorities / module overlapping / perl reinstallation will also be resolved.  Unfortunately, portage has packages for only a small part of CPAN modules, and of course there are no packages for our own private modules.  To solve this problem, the g-cpan utility was developed - it can generate packages for any CPAN modules (including private modules from a CPAN-compatible mirror / overlay) and either save them in a local overlay or simply install it on the fly.  When I tried to use it a few years ago, it didn‚Äôt work very well and was practically useless.  But now it is already fully functional - at least I managed to install ~ 300 modules, and only for one of them I had to manually edit the ebuild. <br><br>  As a side effect of using g-cpan, we are able to build standard Gentoo-shny binary packages for Perl modules on one server, and install them on other servers very quickly (the usual installation of modules, especially with testing, takes hours, and some modules also require interaction during installation). <br><br><h5>  Installation and Setup </h5><ol><li>  We put: <br><pre><code class="bash hljs">emerge g-cpan</code> </pre> </li><li>  You need to set an overlay where g-cpan will create ebuilds: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"GCPAN_OVERLAY=/usr/local/portage"</span></span> &gt;&gt; /etc/make.conf</code> </pre> </li><li>  We set our own list of CPAN mirrors (which includes our local mirror / overlay as the first item).  The easiest way to copy an already configured list is from cpan: <br><pre> <code class="bash hljs">cpanmirrors=$(cpan -J | perl -0777 -ne <span class="hljs-string"><span class="hljs-string">'eval;print"@{$CPAN::Config-&gt;{urllist}}"'</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"cpan </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$cpanmirrors</span></span></span><span class="hljs-string">"</span></span> &gt;&gt; /etc/portage/mirrors</code> </pre> </li><li>  Whether it is necessary to test the modules during installation - everyone decides for himself, but I prefer to run the tests, especially for my own modules.  To force testing of perl-modules during installation, you need to add the ability to set your own hooks to entire package categories.  One possible approach is to create the /etc/portage/bashrc.d/ directory and the following file / etc / portage / bashrc: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Useful variables and functions: # # EBUILD_PHASE= # clean # setup # unpack # compile # test # install # preinst # prerm # postrm # cleanrm # postinst # clean # # CATEGORY = app-admin # PF = eselect-opengl-1.0.6-r1 # P = eselect-opengl-1.0.6 # PN = eselect-opengl # PVR = 1.0.6-r1 # PV = 1.0.6 # PR = r1 (will be "r0" for packages without -r) # # einfo () # elog () # ewarn () # eerror () if [ "x${EBUILD_PHASE}" != "x" ]; then if [ -x "/etc/portage/bashrc.d/${CATEGORY}.${EBUILD_PHASE}" ]; then source "/etc/portage/bashrc.d/${CATEGORY}.${EBUILD_PHASE}" fi if [ -x "/etc/portage/bashrc.d/${CATEGORY}/${PF}.${EBUILD_PHASE}" ]; then source "/etc/portage/bashrc.d/${CATEGORY}/${PF}.${EBUILD_PHASE}" elif [ -x "/etc/portage/bashrc.d/${CATEGORY}/${P}.${EBUILD_PHASE}" ]; then source "/etc/portage/bashrc.d/${CATEGORY}/${P}.${EBUILD_PHASE}" elif [ -x "/etc/portage/bashrc.d/${CATEGORY}/${PN}.${EBUILD_PHASE}" ]; then source "/etc/portage/bashrc.d/${CATEGORY}/${PN}.${EBUILD_PHASE}" fi fi</span></span></code> </pre>  after which you can enable testing of all packages in the perl-core / *, dev-perl / * and perl-gcpan / * categories: <br><pre> <code class="bash hljs">cat &lt;&lt;<span class="hljs-string"><span class="hljs-string">'EOF'</span></span> &gt;/etc/portage/bashrc.d/perl_module_test FEATURES=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$FEATURES</span></span></span><span class="hljs-string"> test"</span></span> SRC_TEST=<span class="hljs-string"><span class="hljs-string">"do"</span></span> EOF cat &lt;&lt;<span class="hljs-string"><span class="hljs-string">'EOF'</span></span> &gt;/etc/portage/bashrc.d/perl_module_notest SRC_TEST= EOF chmod +x /etc/portage/bashrc.d/perl_module_* ln -s perl_module_test /etc/portage/bashrc.d/perl-core.test ln -s perl_module_test /etc/portage/bashrc.d/dev-perl.test ln -s perl_module_test /etc/portage/bashrc.d/perl-gcpan.test</code> </pre>  and, if necessary, disable testing of some modules or somehow influence it: <br><pre> <code class="bash hljs">mkdir /etc/portage/bashrc.d/dev-perl ln -s ../perl_module_notest /etc/portage/bashrc.d/dev-perl/Crypt-SSLeay.test ln -s ../perl_module_notest /etc/portage/bashrc.d/dev-perl/Shell-EnvImporter.test ln -s ../perl_module_notest /etc/portage/bashrc.d/dev-perl/Term-ReadLine-Perl.test cat &lt;&lt;<span class="hljs-string"><span class="hljs-string">'EOF'</span></span> &gt;/etc/portage/bashrc.d/dev-perl/Inline.test MAKEOPTS=-j1 EOF chmod +x /etc/portage/bashrc.d/dev-perl/Inline.test</code> </pre><br></li><li>  Further, usually on the CPAN the most recent versions of the modules are the most stable.  This is all the more true for our private modules.  So it makes sense to force the installation of the latest versions: <br><pre> <code class="bash hljs">cat &lt;&lt;<span class="hljs-string"><span class="hljs-string">'EOF'</span></span> &gt;&gt;/etc/portage/package.keywords perl-core/* dev-perl/* virtual/perl-* <span class="hljs-comment"><span class="hljs-comment"># avoid depending on ~x86 sys-libs/readline dev-perl/Term-ReadLine-Gnu -~x86 # avoid depending on ~x86 sci-mathematics/pari dev-perl/math-pari -~x86 EOF</span></span></code> </pre><br></li><li>  Now we need to update the CPAN index for g-cpan.  Theoretically, g-cpan has an option --cpan_reload for this, but in the current version (0.16.2) it does not work.  And since g-cpan uses the cpan utility index, you can work around this problem by running cpan and executing ‚Äúcpan&gt; reload index‚Äù. </li><li>  Prepare a list of modules used by all Perl scripts on the server.  I have managed high-rise sh-pipelines, but probably you should write a Perl script for this, and post it in the comments to this article.  :) </li><li>  We generate ebuilds for them (this will automatically create ebuilds and for dependency modules): <br><pre> <code class="bash hljs">g-cpan -g Module::Name1 Module::Name2 ‚Ä¶</code> </pre>  There is a small chance that for some modules you will have to correct with handles /usr/local/portage/perl-gcpan/Module-Name/Module-Name-version.ebuild.  (I have so far only got one: Crypt :: MatrixSSL.) </li><li>  Remove the directory / usr / lib / perl5 / site_perl / *.  <b>CAUTION</b> , at this moment, most Perl scripts on this server will break.  Unfortunately, if site modules are not removed before installing vendor modules (which have lower priority), then during installation and testing of vendor modules, problems may arise due to the fact that site versions of modules already installed in vendor will be used.  However, problems are usually solved, so if you can‚Äôt afford to ‚Äúbreak the system‚Äù for a while, then install vendor modules first, but don‚Äôt forget to delete the catalog with site modules after that. </li><li>  Remove all perl modules from /etc/portage/profile/package.provided. </li><li>  We first install the modules required portage (if package.provided was used and they are not installed now): <br><pre> <code class="bash hljs">emerge -uDNa @world</code> </pre>  and then you need (it makes sense to put the Test :: * modules first, then Math :: * - this will speed up the installation of the rest).  We repeat installation attempt several times, since  not all modules correctly spelled dependencies: <br><pre> <code class="bash hljs">until emerge -uDN --keep-going y \ Test-Deep Test-Differences Test-Distribution ‚Ä¶ \ Math-BigInt-GMP math-pari ‚Ä¶ \ ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> -p <span class="hljs-string"><span class="hljs-string">"Press &lt;Enter&gt; to try again"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br></li></ol><h5>  Update </h5><br>  The g-cpan utility does not provide a complete equivalent of "cpan&gt; upgrade" <br><pre> <code class="bash hljs">g-cpan -u</code> </pre>  will update only modules for which packages created g-cpan (i.e. from the perl-gcpan / * category, and packages from perl-core / * and dev-perl / * will not be updated).  But this may not be so bad - in the end, to update these modules, it is usually enough to copy and rename the ebuild from perl-core / * or dev-perl / * to / usr / local / portage.  But there is a possibility of more subtle control over the installed versions of the modules and a convenient rollback to previous versions. <br><br><h4>  Summary </h4><br>  In my opinion, g-cpan really simplifies the management of globally installed Perl modules.  And in spite of the huge ‚ÄúInstallation‚Äù section of 11 points, in fact there is nothing really complicated there (well, apart from determining which modules you need to install :)). <br><br>  Successes in establishing order on servers! </div><p>Source: <a href="https://habr.com/ru/post/129055/">https://habr.com/ru/post/129055/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129047/index.html">Russian Code Cup: Final Round Results</a></li>
<li><a href="../129048/index.html">Installing GSM-alarm in the country</a></li>
<li><a href="../129050/index.html">UTorrent adds support for Android and iOS devices</a></li>
<li><a href="../129051/index.html">change head HP!</a></li>
<li><a href="../129052/index.html">Password research</a></li>
<li><a href="../129057/index.html">A business angel from the USA, who has worked with more than 100 startups, will perform on September 26 in St. Petersburg</a></li>
<li><a href="../129059/index.html">Announcement CastingCode.tv: screencasts programmers at work</a></li>
<li><a href="../129060/index.html">The simplest logical circuit. Part 1: General Information on Logic Circuits and Simple Logic Modules</a></li>
<li><a href="../129064/index.html">Jython-console of your application</a></li>
<li><a href="../129065/index.html">New Arduino: USB hardware in the controller, ARM-architecture and WiFi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>