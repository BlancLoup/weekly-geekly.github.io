<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Debugging of complex web applications - an effective buggy on the production-servers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 Today I‚Äôll tell you how on combat servers during a load, in dust and dirt, it is effective to catch bottlenecks in the performance of large ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Debugging of complex web applications - an effective buggy on the production-servers</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  Today I‚Äôll tell you how on combat servers during a load, in dust and dirt, it is effective to catch bottlenecks in the performance of large web applications in PHP, as well as to look for and fix "non-standard" errors.  We successfully use many of the described techniques on our cloud service <a href="http://www.bitrix24.ru/">Bitrix24</a> . <br>  Information, I hope, will be useful for system administrators and developers serving complex web projects, as well as managers who want to build an effective and fast process of finding and eliminating the bottlenecks and errors of PHP projects. <br><img src="https://habrastorage.org/storage2/97f/56e/b01/97f56eb010da1110e9bc24134a44fb3e.jpg"><br><a name="habracut"></a><br><br><h4>  Full Testing Myth </h4><br><img src="https://habrastorage.org/storage2/341/807/264/34180726462176654eb20841d292de2c.jpg"><br>  There is such a kind and bright myth from <a href="http://ru.wikipedia.org/wiki/%25D0%25AD%25D0%25BA%25D1%2581%25D1%2582%25D1%2580%25D0%25B5%25D0%25BC%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">XP / TDD</a> that you can cover the web application with 100% modular and functional tests, write a bunch of <a href="http://seleniumhq.org/">Selenium</a> tests that click on the system outside and without any fear to bring improvements to the system and upload it to the battle through the <a href="http://ru.wikipedia.org/wiki/%25D0%259D%25D0%25B5%25D0%25BF%25D1%2580%25D0%25B5%25D1%2580%25D1%258B%25D0%25B2%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B5%25D0%25B3%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">process of continuous integration</a> :-) This romance from the category of ‚Äúto love to the grave and change before dying‚Äù, fortunately, is far from reality and that is why: <br><ol><li>  Requirements for the web project will constantly change, CONSTANTLY, until the very launch.  In theory, they can be fixed, of course, but before launching, the manager must be drawn with a Nazi smile and the words ‚Äúurgent, today.‚Äù </li><li>  If you cover everything with tests according to your conscience, there will not be enough programmers and time, believe me.  Often there are deviations of the type of writing <a href="http://en.wikipedia.org/wiki/Mock_object">mock-objects</a> to <a href="http://aws.amazon.com/">the Amazon API</a> , you can still test the operating system system calls :-) </li><li>  If the layout often changes on a web project it will be difficult, it is very difficult to keep <a href="http://seleniumhq.org/">Selenium-</a> tests up to date </li><li>  Some things, such as site stability under load, are not easy to test.  It is necessary to break your head and come up with a load scheme that looks like a real one, but it will be different anyway. </li><li>  We intuitively trust ... a programming language, and it may contain bugs that will appear completely suddenly.  So why don't we cover it with PHP tests? </li><li>  etc. </li></ol><br>  In general, if you still believe that tests will protect you 100% of the problems and should be 2 times more than the code, then you can not read - programming is not for romantics :-) <br><img src="https://habrastorage.org/storage2/fbd/b7c/794/fbdb7c7943b10d93f5d0cb060fa4f2ac.jpg"><br>  Nevertheless, and everyone understands this, you need to write tests.  For key things, for system modules - you need to write and keep up to date.  For other tasks, you can write test plans and test with the ‚Äúhuman factor‚Äù by clicking the testers department on all the web solution pages before each update, carefully observing errors in the logs and collecting feedback from users. <br>  Thus, if your project is still alive and successfully working on the network, you most likely use both unit tests, functional tests, and <a href="http://seleniumhq.org/">Selenium</a> , and a variant of the process of continuous integration with the version control system and the labor of testers.  At the same time, you understand that errors will necessarily be leaked to the combat servers and you need to learn how to quickly find and fix them.  The main idea here is to lay straws in a reasonable amount and keep efficient weapons at the ready, capable of cutting off any head or performance problem with lightning speed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  PHP Debugging Tools </h4><br>  Many projects cost the var_dump and echo team :-), however, as they become more complex, developers will likely install something like <a href="http://xdebug.org/">XDebug</a> or <a href="http://www.ibm.com/developerworks/ru/library/os-php-zenddebug/">Zend Debugger</a> on local servers ‚Äî which makes it reasonable and really easy to debug a web application if you learn use these things wisely. <br>  XDebug is very often useful in <a href="http://habrahabr.ru/post/31463/">the collection mode of a trace</a> .  Sometimes, without a trace, it is simply impossible to catch an error or a bottleneck in performance. <br>  Nevertheless, there is one weighty but - these tools create a serious load on the web project and include them on the combat servers - it is dangerous.  The tools will help you to ‚Äúlick‚Äù the code on the local servers, but ‚Äúsurvive in battle‚Äù, unfortunately, will not help. <br><br><h4>  Debugging in combat </h4><br><br><h5>  Log everything </h5><br>  It is very useful if the load allows, to include on the combat servers the log files of nginx, apache, php-fpm, to keep your log files of business operations (creating special orders, export from 1C-Bitrix to SAP, etc.). <br>  If you have a <a href="http://www.1c-bitrix.ru/products/cms/features/webcluster.php">web cluster</a> or just a lot of servers with PHP - try to collect logs from these machines on one machine, where they are centrally monitored.  On <a href="http://www.bitrix24.ru/">Bitrix24</a> , we use <a href="http://en.wikipedia.org/wiki/Syslog-ng">syslog-ng</a> for this.  Having a PHP error log from all servers of the cluster on one machine, in one file, you don‚Äôt have to run around with machines with your eyes wide open in case of an accident.  Run the <a href="http://ru.wikipedia.org/wiki/GNU_Screen">screen</a> and you know what is happening. <br><br><h5>  "Fighting" profiler - xhprof </h5><br>  Fortunately, PHP developers and administrators, colleagues from Facebook wrote and posted for common use an excellent and useful "combat" profiler - <a href="http://pecl.php.net/package/xhprof">xhprof</a> .  If you are not familiar with this tool - study it.  It is adjusted in 2 clicks, and benefits by 5 tons. <br><img src="https://habrastorage.org/storage2/146/48b/c10/14648bc106a13e06929336056e7efd9c.jpg"><br>  The most important thing is that you can turn it on in combat, because  it practically does not create a load on PHP (percentages). <br>  It allows you to see the hit performance profile: <br><img src="https://habrastorage.org/storage2/a35/907/d7d/a35907d7dd099605afef2cb877b75cb6.png"><br>  And also a critical path - what was the same thing that slowed down the battle: <br><img src="https://habrastorage.org/storage2/46c/36c/2ac/46c36c2ac66033ef27bc240b9cc50923.png"><br>  And it fits well with the built-in debugging tool of the Bitrix platform (if you have a web solution on this platform) - xhprof can be launched at combat at peak loads, and <a href="http://www.1c-bitrix.ru/products/cms/features/perfmon.php">a performance monitor</a> when the load does not go off scale or on development / testing servers. <br><br><h5>  Dynamic tracing </h5><br>  If you have a <a href="http://www.1c-bitrix.ru/products/cms/features/webcluster.php">web cluster</a> , it is often convenient to automate the process of dynamic profiling.  The essence is simple - the profiler is always on, after the page is executed, we check the hit time and if it is longer, for example, 2 seconds, we save the trace to a file.  Yes, it adds an extra 50-100 ms, so you can turn on the system if necessary or turn on each, for example, the tenth hit. <br><pre><code class="php hljs">auto_prepend_file.php: <span class="hljs-comment"><span class="hljs-comment">//     ,     if (isset($_GET['profile']) &amp;&amp; $_GET['profile']=='Y') { setcookie("my_profile", "Y"); } if (isset($_GET['profile']) &amp;&amp; $_GET['profile']=='N') { setcookie("my_profile", "",time() - 3600); } if ( !( isset($_GET['profile']) &amp;&amp; $_GET['profile']=='N') &amp;&amp; ( $_COOKIE['my_profile']=='Y' || ( isset($_GET['profile']) &amp;&amp; $_GET['profile']=='Y') ) &amp;&amp; extension_loaded('xhprof') ) { xhprof_enable(); }</span></span></code> </pre> <br><br><pre> <code class="php hljs">dbconn.php: <span class="hljs-comment"><span class="hljs-comment">//     ,       PHP (http://php.net/manual/ru/function.microtime.php) //Forcing storing trace, if req.time &gt; N secs $profile_force_store = false; $ar_pinba = pinba_get_info(); if ($ar_pinba['req_time']&gt;2) $profile_force_store=true; ... if ($profile_force_store || ( !(isset($_GET['profile']) &amp;&amp; $_GET['profile']=='N') &amp;&amp; ( $_COOKIE['my_profile']=='Y' || ( isset($_GET['profile']) &amp;&amp; $_GET['profile']=='Y' )) &amp;&amp; extension_loaded('xhprof') ) { $xhprof_data = xhprof_disable(); $XHPROF_ROOT = realpath(dirname(__FILE__)."/perf_stat"); include_once $XHPROF_ROOT . "/xhprof_lib/utils/xhprof_lib.php"; include_once $XHPROF_ROOT . "/xhprof_lib/utils/xhprof_runs.php"; // save raw data for this profiler run using default // implementation of iXHProfRuns. $xhprof_runs = new XHProfRuns_Default(); // save the run under a namespace "xhprof_foo" $run_id = $xhprof_runs-&gt;save_run($xhprof_data, "xhprof_${_SERVER["HTTP_HOST"]}_".str_replace('/','_',$_SERVER["REQUEST_URI"]));</span></span></code> </pre><br>  Thus, if the hit was longer than 2 seconds, we save it in a temporary folder on the server.  Then, on the monitoring machine, you can bypass the server and pick up traces for centralized analysis from them (example for virtual hosts in Amazon): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash HOSTS=`as-describe-auto-scaling-groups mygroup | grep -i 'INSTANCE' | awk '{ print $2}' | xargs ec2-describe-instances | grep 'INSTANCE' | awk '{print $4}'` for HOST in $HOSTS ; do scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -p -i /home/trace_loader/.ssh/id_rsa "trace_loader@${HOST}:/tmp/*xhprof*" /my_profiles done</span></span></code> </pre><br>  Now you have query traces collected in one place for more than 2 seconds - it will take about 30 minutes to write a web interface to view them in a sorted order by date. Part of the business process is ready - every trace is actually a TOR for web application optimization him specialists from the development. <br><br><h4>  Dive deeper - strace </h4><br>  Sometimes the profiler and log files do not allow you to determine the cause of the problem.  However, when debugging (XDebug) on ‚Äã‚Äãdevelopment servers, the problem cannot be reproduced.  One thing remains, to understand what is happening at the time of the occurrence of events on the combat server.  There is often an invaluable help to the system call tracer, such as <a href="http://en.wikipedia.org/wiki/Strace">strace</a> .  Just do not need to fall into a stupor at the sight of Linux system calls - believe me, a little patience, 2-3 coffee mugs and you will understand the idea and be able to catch the most subtle errors and bottlenecks on the combat servers :-) <br>  You need to properly "hook" the tracer to PHP processes.  There are often a lot of processes running, in different pools, they are constantly quenched and raised (often, to protect against memory leaks, the process lasts for example 100 hits): <br> <code>ps aux | grep php <br> root 24166 0.0 0.0 391512 4128 ? Ss 11:47 0:00 php-fpm: master process (/etc/php-fpm.conf) <br> nobody 24167 0.0 0.6 409076 48168 ? S 11:47 0:00 php-fpm: pool www1 <br> nobody 24168 0.0 0.4 401736 30780 ? S 11:47 0:00 php-fpm: pool www1 <br> nobody 24169 0.0 0.5 403276 39816 ? S 11:47 0:00 php-fpm: pool www1 <br> nobody 24170 0.0 1.0 420504 83376 ? S 11:47 0:01 php-fpm: pool www1 <br> nobody 24171 0.0 0.6 408396 49884 ? S 11:47 0:00 php-fpm: pool www1 <br> nobody 24172 0.0 0.5 404476 40348 ? S 11:47 0:00 php-fpm: pool www2 <br> nobody 24173 0.0 0.4 404124 35992 ? S 11:47 0:00 php-fpm: pool www2 <br> nobody 24174 0.0 0.5 404852 42400 ? S 11:47 0:00 php-fpm: pool www2 <br> nobody 24175 0.0 0.4 402400 35576 ? S 11:47 0:00 php-fpm: pool www2 <br> nobody 24176 0.0 0.4 403576 35804 ? S 11:47 0:00 php-fpm: pool www2 <br> nobody 24177 0.0 0.7 410676 55488 ? S 11:47 0:00 php-fpm: pool www3 <br> nobody 24178 0.0 0.6 409912 53432 ? S 11:47 0:00 php-fpm: pool www3 <br> nobody 24179 0.1 1.3 435216 106892 ? S 11:47 0:02 php-fpm: pool www3 <br> nobody 24180 0.0 0.7 413492 59956 ? S 11:47 0:00 php-fpm: pool www3 <br> nobody 24181 0.0 0.4 402760 35852 ? S 11:47 0:00 php-fpm: pool www3 <br> nobody 24182 0.0 0.4 401464 37040 ? S 11:47 0:00 php-fpm: pool www4 <br> nobody 24183 0.0 0.5 404476 40268 ? S 11:47 0:00 php-fpm: pool www4 <br> nobody 24184 0.0 0.9 409564 72888 ? S 11:47 0:01 php-fpm: pool www4 <br> nobody 24185 0.0 0.5 404048 40504 ? S 11:47 0:00 php-fpm: pool www4 <br> nobody 24186 0.0 0.5 403004 40296 ? S 11:47 0:00 php-fpm: pool www4 <br></code> <br>  In order not to chase the changing idshnikami PHP processes, you can put them temporarily short time of life: <br> <code>pm.max_children = 5 <br> pm.start_servers = 5 <br> pm.min_spare_servers = 5 <br> pm.max_spare_servers = 5 <br> <br> <b>pm.max_requests = 100</b> <br></code> <br>  and run strace like this: <br><br>  strace -p 24166 -f -s 128 -tt -o trace.log <br><br>  Those.  we hang it on the rutovy process and when new descendants appear, it will automatically start treating them too.  Simply. <br>  Now it is desirable to start writing PHP process logs in the PHP log files so that you can quickly match a long hit from the log with a specific process process: <br> <code>access.log = /opt/php/var/log/www.access.log <br> access.format = "%R # %{HTTP_HOST}e # %{HTTP_USER_AGENT}e # %t # %m # %r # %Q%q # %s # %f # %{mili}d # %{kilo}M # %{user}C+%{system}C # <b>%p</b> " <br></code> <br>  It now remains to wait for the victim to appear, for example, a long hit: <br> <code>[24-May-2012 11:43:49] WARNING: [pool www1] child 22722, script '/var/www/html/myfile.php' (request: "POST /var/www/html/myfile.php") executing too slow (38.064443 sec), logging <br> <br> - # mysite.ru # Mozilla/5.0 (Windows NT 6.1; WOW64; rv:12.0) Gecko/20100101 Firefox/12.0 # 24/May/2012:11:43:11 +0400 # POST # /var/www/html/myfile.php # # 200 # /var/www/html/myfile.php # <b>61131.784</b> # 6656 # 0.03+0.03 # <b>22722</b> <br></code> <br><br><h4>  We treat system calls </h4><br><img src="https://habrastorage.org/storage2/a2b/330/663/a2b330663b07f8a4ebf6f63343fdad51.jpg"><br>  The first is that the system calls are low-level ‚Äúelementary‚Äù operations that the program communicates with the operating system ‚Äî they build all of the IT universe with different programming languages ‚Äã‚Äãand technologies and there are not very many of them (like a small number of processor commands and an infinite number of languages ‚Äã‚Äãand dialects above stack).  The second thing you need to understand is that the PHP commands of the web project are executed strictly one after the other in the framework of ONE PROCESS.  Therefore, in the trace you need to filter the process of a suspicious hit - 22722: <br><br>  cat trace.log |  grep '22722' |  less <br><br>  The time of the hit is known from the log, it remains to see what happened during the construction of the page and why it hung so long (the trace was edited a little). <br>  Visible queries to the database and answers: <br> <code>24167 12:47:50.252654 write(6, "u\0\0\0\3select name, name, password ...", 121) = 121 <br> 24167 12:47:50.252915 read(6, "pupkin, 123456"..., 16384) = 458 <br></code> <br>  File accesses: <br><br> <code>24167 12:47:50.255299 open("/var/www/html/myfile.php", O_RDONLY) = 7 <br></code> <br><br>  Interaction with memcached: <br><br> <code>24167 12:47:50.262654 sendto(9, "add mykey 0 55 1\r\n1\r\n", 65, MSG_DONTWAIT, NULL, 0) = 65 <br> 24167 12:47:50.263151 recvfrom(9, "STORED\r\n", 8192, MSG_DONTWAIT, NULL, NULL) = 8 <br> ... <br> 24167 12:47:50.282681 sendto(9, "delete mykey 0\r\n", 60, MSG_DONTWAIT, NULL, 0) = 60 <br> 24167 12:47:50.283998 recvfrom(9, "DELETED\r\n", 8192, MSG_DONTWAIT, NULL, NULL) = 9 <br></code> <br><br>  And here we see, for example, why the hit is frozen: <br> <code>22722 11:43:11.487757 sendto(10, "delete mykey 0\r\n", 55, MSG_DONTWAIT, NULL, 0) = 55 <br> 22722 11:43:11.487899 poll([{fd=10, events=POLLIN|POLLERR|POLLHUP}], 1, 1000) = 1 ([{fd=10, revents=POLLIN}]) <br> 22722 11:43:11.488420 recvfrom(10, "DELETED\r\n", 8192, MSG_DONTWAIT, NULL, NULL) = 9 <br> 22722 11:43:11.488569 sendto(10, "delete mykey2 0\r\n", 60, MSG_DONTWAIT, NULL, 0) = 60 <br> 22722 11:43:11.488714 poll([{fd=10, events=POLLIN|POLLERR|POLLHUP}], 1, 1000) = 1 ([{fd=10, revents=POLLIN}]) <br> 22722 11:43:11.489215 recvfrom(10, "DELETED\r\n", 8192, MSG_DONTWAIT, NULL, NULL) = 9 <br> 22722 11:43:11.489351 close(10) = 0 <br> 22722 11:43:11.489552 gettimeofday({1337845391, 489591}, NULL) = 0 <br> 22722 11:43:11.489695 gettimeofday({1337845391, 489727}, NULL) = 0 <br> 22722 11:43:11.489855 nanosleep({0, 100000}, NULL) = 0 <br> 22722 11:43:11.490155 nanosleep({0, 200000}, NULL) = 0 <br> 22722 11:43:11.490540 nanosleep({0, 400000}, NULL) = 0 <br> 22722 11:43:11.491121 nanosleep({0, 800000}, NULL) = 0 <br> 22722 11:43:11.492103 nanosleep({0, 1600000}, NULL) = 0 <br> 22722 11:43:11.493887 nanosleep({0, 3200000}, NULL) = 0 <br> 22722 11:43:11.497269 nanosleep({0, 6400000}, NULL) = 0 <br> 22722 11:43:11.503852 nanosleep({0, 12800000}, NULL) = 0 <br> 22722 11:43:11.516836 nanosleep({0, 25600000}, NULL) = 0 <br> 22722 11:43:11.542620 nanosleep({0, 51200000}, NULL) = 0 <br> 22722 11:43:11.594019 nanosleep({0, 102400000}, NULL) = 0 <br> 22722 11:43:11.696619 nanosleep({0, 204800000}, NULL) = 0 <br> 22722 11:43:11.901622 nanosleep({0, 409600000}, NULL) = 0 <br> 22722 11:43:12.311430 nanosleep({0, 819200000}, &lt;unfinished ...&gt; <br> 22722 11:43:13.130867 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:13.131025 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:14.769688 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:14.770104 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:16.408860 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:16.409048 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:18.047808 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:18.048103 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:19.686947 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:19.687085 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22724 11:43:20.227224 &lt;... lstat resumed&gt; 0x7fff00adb080) = -1 ENOENT (No such file or directory) <br> 22722 11:43:21.325824 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:21.326219 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:22.964830 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:22.965126 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:24.603692 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:24.604117 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:26.250371 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:26.250580 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:27.889372 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:27.889614 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:29.534127 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:29.534313 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:31.173004 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:31.173273 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:32.812113 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:32.812531 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:34.451236 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:34.451554 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:36.090229 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:36.090317 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22724 11:43:36.522722 fstat(12, &lt;unfinished ...&gt; <br> 22723 11:43:36.622833 &lt;... gettimeofday resumed&gt; {1337845416, 622722}, NULL) = 0 <br> 22722 11:43:37.729696 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:37.730033 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22724 11:43:39.322722 gettimeofday( &lt;unfinished ...&gt; <br> 22722 11:43:39.368671 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:39.368930 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:41.007574 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:41.007998 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:42.646895 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:42.647140 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22720 11:43:43.022722 fstat(12, &lt;unfinished ...&gt; <br> 22720 11:43:43.622722 munmap(0x7fa1e736a000, 646) = 0 <br> 22722 11:43:44.285702 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:44.285973 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:45.926593 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:45.926793 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:47.566124 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:47.566344 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22722 11:43:49.205103 &lt;... nanosleep resumed&gt; NULL) = 0 <br> 22722 11:43:49.205311 nanosleep({1, 638400000}, &lt;unfinished ...&gt; <br> 22719 11:43:49.440580 ptrace(PTRACE_ATTACH, 22722, 0, 0 &lt;unfinished ...&gt; <br></code> <br>  At first, there were calls to memcached: write / read socket 10, then the socket was successfully closed (‚Äúclose‚Äù = 0), then the code contained a call to usleep in a loop and the exit condition did not work because of the previously closed socket.  As a result, the cause was able to determine - quickly and correct the code. <br><br>  Do not hesitate to unix system calls, they are simple and straightforward.  Many objects in the system are represented as files and sockets.  For any call, you can quickly get embedded information: <br>  man 2 open <br>  man 2 sendto <br>  man 2 nanosleep <br><br>  If you do not have these manuals, you can put them like this (on CentOS6): <br>  yum install man-pages <br><br>  You can also view the latest system call documentation on the <a href="http://man7.org/linux/man-pages/dir_section_2.html">web</a> or from the console: ‚Äúman syscalls‚Äù. <br>  After spending a little time understanding how PHP works at the operating system level, you will get a secret weapon in your hands that allows you to quickly find and remove almost any bottleneck of a high-load web project! <br><br><h4>  Total </h4><br><ol><li>  We repeated the basic methods and tools for debugging PHP web applications of any degree of complexity. </li><li>  We considered the options for organizing a simple and effective business process of finding problems on combat servers. </li><li>  We learned how to catch "complex" cases and bottlenecks using xhprof and strace on "combat" servers. </li><li>  We tasted the linux system calls and learned how to interpret them. </li></ol><br><br>  Good luck to everyone, stable web projects, reliable hosting and a relaxing, serene vacation!  And, of course, I invite everyone to our new cloud project deployed in the Amazon - <a href="http://www.bitrix24.ru/">‚ÄúBitrix24‚Äù</a> ! </div><p>Source: <a href="https://habr.com/ru/post/144482/">https://habr.com/ru/post/144482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144473/index.html">New Ukraine on Yandex.Maps</a></li>
<li><a href="../144474/index.html">Shedding light on the HP ProLiant iLO Management Engine</a></li>
<li><a href="../144476/index.html">Job Fair 2012 in TIT SFU (Taganrog)</a></li>
<li><a href="../144477/index.html">Zabbix 2.0 released</a></li>
<li><a href="../144479/index.html">Facebook will give gifts</a></li>
<li><a href="../144485/index.html">The creator of the botnet Bredolab received 4 years in prison</a></li>
<li><a href="../144486/index.html">Mind games. We understand with Intel HD graphics. And play?</a></li>
<li><a href="../144487/index.html">Steps to optimize capture pages</a></li>
<li><a href="../144488/index.html">We write REST application on Sinatra and we fasten Redactor. Part 2</a></li>
<li><a href="../144489/index.html">thn.gs - in order not to remember</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>