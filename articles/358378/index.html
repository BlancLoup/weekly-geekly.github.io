<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Testing phones with Arduino</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In 2016, Habr√© attracted a lot of attention to the post of Alexey Lavrenyuk ‚ÄúWe measure battery consumption on mobile devices. Experiment in Yandex. A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Testing phones with Arduino</h1><div class="post__text post__text-html js-mediator-article">  In 2016, Habr√© attracted a lot of attention to the <a href="https://habr.com/company/yandex/blog/311046/">post of</a> <b>Alexey Lavrenyuk</b> ‚ÄúWe measure battery consumption on mobile devices.  Experiment in Yandex.  A year later, at our conference, <b>Heisenbug,</b> Alexey, together with his colleague <b>Timur Torubarov,</b> presented the report ‚ÄúTesting phones with the help of Arduino‚Äù: some of this report coincided with the habrapost, but there was a lot of new information.  And now the circle is closed: we made a text version of the report so that all this new information will appear on Habr√©. <br><br>  How to measure the power consumption of the application?  Why do 10,000 measurements per second instead of 500?  Which smartphones are harder to drill?  How to kill the iPhone in a completely unexpected way?  In the text under the cut - all this and more.  Also attach the video report: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/FRWvJpwyYrU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br><h2>  Introduction </h2><br>  <b>Timur Torubarov:</b> <br>  I would like to start with a greeting greeting to the guys from Badoo: we listened to your <a href="https://habr.com/post/354500/">report</a> yesterday, it was very cool.  Who has not heard - we recommend, the guys there talked about testing geolocation in Badoo and about power consumption during geolocation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But, unlike them, firstly, we dug deeper into the topic of energy consumption, and secondly, during testing we suffered a lot of iPhones in the physical sense! <br><br>  <b>Alexey Lavrenyuk:</b> <br>  People are surprised ‚Äúyou and Timur are load testers, which is what you are drilling iPhones‚Äù.  How did we get started?  The developers came to us and said: ‚ÄúWe here choose which library to use: write it yourself or buy a paid one.  We need to compare the prototype and the free version of the external library on different parameters, in particular, on energy consumption. ‚Äù  We were engaged in performance, so they came to us. <br><br>  How to measure the power consumption of the application?  A person takes two phones, on one puts one version of the application, on the other, puts both in his pockets.  Badoo guys said yesterday that there is a difference between what pocket to put.  In fact, there are still a lot of options, how the difference may appear: whether you downloaded the phone, put it on the table, phone revision, etc. In general, there are no two identical phones.  Then you walk with these two phones for three days and see which one is faster discharged, that is, it takes you three days to do one test. <br><br>  We then tested this case and chose to write our bicycle, but at the same time we realized that we need to learn how to measure energy consumption.  And faster than three days.  We walked around, asked who needed it, and realized that it was necessary to measure not only on Android, but also on the iPhone, on laptops, potentially on tablets, on anything up to the Apple Watch. <br><br>  We do not want to spend human resources on this and walk for three days with laptops, but we want to do this automatically, preferably for each commit.  And we also need to measure energy consumption with great frequency, that is, many, many times per second, I will tell you more about this in more detail. <br><br>  Our report outline: <br><br><ul><li>  Why we did not take ready multimeter, which is full on the market </li><li>  How we made our multimeter </li><li>  How we improved it in accordance with the requirements of different teams. </li><li>  What from our project can be downloaded in open source </li><li>  How to use it and what results can be obtained </li></ul><br><br><h2>  As they usually do </h2><br>  Let's start with the multimeters.  How is this usually done?  There are a lot of software metrics on the phones, maybe energy consumption can also be collected? <br><br>  We thought so too.  Here is the standard IPhone interface for the IPhone, which collects many different metrics and power consumption, too; the black arrow indicates power consumption: <br><br><img src="https://habrastorage.org/webt/z5/rs/e4/z5rse4j95y0my9wlrtozfzzprem.jpeg"><br><br>  The trick is that the CPU consumption graph shows that it changed during the test, but the power consumption for the entire test did not change at all 1/20. <br><br>  Does anyone know what 1/20 is?  And we did not know.  1/20 is not 1/20 mA, not 1/20 W / h or something physical, it means that the phone will work in this mode for another 20 hours.  Such is the encrypted metric of the iPhone. <br><br>  Android is better: it is Linux, there is / proc, you can conveniently read metrics programmatically.  But there is a nuance. <br><br><img src="https://habrastorage.org/webt/pi/6h/lc/pi6hlcvyybehlpaknbqtouyrns8.jpeg"><br><br>  On Nexus, for example, this metric changes every 20 seconds.  And we, as already said, need many times a second.  On some phones, this metric is in other places, or it shows something strange, we could not decipher, there is no documentation. <br><br>  On some phones, this metric does not exist at all, we searched for it, then came across a <a href="https://stackoverflow.com/a/2808574">branch of</a> StackOverflow, where a person also searched for this metric for a specific phone model, and finally realized that there was simply no chip that measures current in the phone.  And he realized that the only way is to take a multimeter and measure. <br><br>  We need to test a lot of different devices, we will never find a universal way to collect metrics quickly.  Therefore, we decided to build our multimeter. <br><br>  Naturally, first looked at what is on the market. <br><br>  Firstly, there are digital oscilloscopes: complex, expensive, powerful, with a bandwidth of several MHz, i.e.  we can make millions of measurements per second.  First, they stand like a wing of the Boeing.  And we need to drive parallel tests, many, many tests for each release, for each application of Yandex, that is, all this needs to be multiplied by a couple of dozen or even more in the future, and we get an irresponsible amount.  In addition, these devices are not designed for this.  We just need to collect the metric, then analyze it separately.  And these devices are able to display the metric on the screen, its frequency characteristics, that is, they are for detailed signal analysis. <br><br>  Then we stumbled upon a project called Power Monitor - this is a device designed specifically for collecting metrics from phones.  But it didn‚Äôt suit us either, because it is being sold as a black box: it‚Äôs impossible to climb into it, to correct something for our needs.  The software works under Windows, and we have Linux everywhere, we need to push it into automation.  In general, difficult. <br><br>  After we began to develop our piece, we stumbled upon the batt0r project.  They are very similar to us, these are guys from different institutions (including Stanford).  They published a couple of articles, we gathered various useful information (I‚Äôll refer to them a little), but then they went to work at Google, and after that we couldn‚Äôt contact them.  And the articles are gone, the old links no longer open. <br><br><h2>  How we made our multimeter </h2><br>  In general, we decided to build our multimeter, found a scheme on the Internet. <br><br><img src="https://habrastorage.org/webt/_e/sf/mt/_esfmtxlc1qggo5mo9foe7c9w8u.jpeg"><br><br>  I have never built anything from electronics before, only programmed.  The scheme is simple, includes a shunt - this is a resistor, the current through which the phone is powered, passes through it, and a potential difference is formed.  This potential difference is small, not directly measured with Arduino (we decided to start using Arduino, because this is a simple, cheap start).  To consider this Arduino, we need to increase this potential difference, this is done using an instrumental amplifier, it is also on the diagram. <br><br>  We implemented this scheme, simply poke the wires into the breadboard.  There you can see the Arduino, amplifier, shunt and the connected phone. <br><br><img src="https://habrastorage.org/webt/hi/xs/wn/hixswnoqssown68yrsznllz2qxw.jpeg"><br><br>  We measured first in the break of the USB cable, because it is simple: I cut the wire in half, put a shunt in there, and everything is measured.  We had this proof of concept. <br><br><img src="https://habrastorage.org/webt/ej/l0/u8/ejl0u81sek9wttvgiud61k2rzj0.jpeg"><br><br>  We got the first charts.  Here we have the Power Monitor on the table, we compared the results with it - we understood that it works fine, we measure something, we must continue. <br><br>  Next we need to get rid of the measurements in the USB break.  Otherwise, the phone will charge the battery before you consume current, and you will not measure this process, and you will not see how much the phone consumes at this particular moment.  Therefore, the only option is to pull out the battery, power the phone outside from any source.  In this case, the phone can no longer accumulate, and see the actual current power consumption. <br><br><img src="https://habrastorage.org/webt/k4/o3/kn/k4o3kno3bawgkbtt0ejkiecj2em.jpeg"><br><br>  Timur is sorting the IPhone to get a battery out of there.  Modern batteries are smart devices, they are not just two wires from a battery, but also a microcontroller. <br><br><img src="https://habrastorage.org/webt/ze/19/7n/ze197n9xuqqimf_1gx_joc8rk3w.jpeg"><br><br>  It looks like this, we cut it off from the IPhone battery, it has a convenient connector that can connect it back.  And we got soldered directly to this controller, that is, we didn‚Äôt buy a 4-wire connector somewhere, and implement some kind of logic inside. <br><br><img src="https://habrastorage.org/webt/yv/vs/ub/yvvsub0qydkcu6p7tsufgqgfbhq.jpeg"><br><br>  So, we soldered to this controller.  The next question is: how can developers give it away now?  It looks scary, you whisk away from the table - everything will break, you must somehow close the case back. <br><br>  In the article about battOr it is proposed to make a flexible printed circuit board, which can be pulled out of the case into the slit.  This, firstly, costs a lot of money, and secondly, not every telephone will be able to be withdrawn, because they are tightly closed.  Therefore, we decided to apply the Russian engineering solution.  Here it is: <br><br><img src="https://habrastorage.org/webt/si/g0/hc/sig0hcgskzirkffp8cs4lhvzgqc.jpeg"><br><br>  We began to drill phones.  IPhones are drilled very well, conveniently, they are aluminum.  Some phones are glass, they are badly drilled, cracked. <br><br><img src="https://habrastorage.org/webt/qs/2q/ug/qs2qugqracpp30xg4zfxzlrqiri.jpeg"><br><br>  We removed from them a wire with a connector, it is plugged only with one side, you will not mix up the polarity.  At that time, the finished solution looked like this: a box that the developer connects to the computer's USB port, and the phone connects to the box, and everything works on his local machine. <br><br><img src="https://habrastorage.org/webt/f3/ds/ic/f3dsicpki6noxowq6gvfqwodyts.jpeg"><br><br>  The parameters of our device then were as follows: <br>  The maximum measured current is 3A, for telephones it is enough.  For tablets it may not be enough, but we have ideas on how to defeat it. <br><br>  The resolution of the ADC in Arduino is 10 bit, which means that we have 1024 gradations, with which we measure the input voltage or current. <br><br>  The frequency of measurements at the Arduino, then was 500 samples per second.  This was the first decision in the forehead, and we thought that this was enough for everyone, like Bill Gates with his "640 kilobytes of memory."  Then they came to us from the team of the mobile browser, showed an article about battOr and said that this is not enough.  We said ‚Äúwhy do you need more than 500 measurements per second, this is so complete‚Äù.  They say: ‚ÄúWell, look, battOr lead this case: they took Chrome with Safari and compared the time of drawing one frame of video on YouTube.  We saw that Safari is better in energy efficiency than Chrome.  They localized the place in the code in which this energy was consumed, sawed it out, repaired Chrome, built new graphics and saw that they now coincide with Safari. ‚Äù <br><br><img src="https://habrastorage.org/webt/0r/hn/uk/0rhnuk2n9cg0ffedsjmnjapid_m.jpeg"><br><br>  One frame of video is 16 milliseconds, and during these 16 ms we must have time to make a lot of measurements.  If we measure with a frequency of 500 samples per second, then we get one point in 2 ms, and here we need more.  But how much more do we need? <br><br>  We took another Arduino (Arduino Due), were able to get a million samples per second from the box.  They built graphs and saw that they are quite smooth, so, in principle, 10 thousand measurements per second are enough. <br><br>  We managed to overclock Arduino Nano, to which we initially launched on 500 samples per second, up to 10,000. To do this, we had to not use standard library functions, but write our own, which directly pull registers.  Library functions are rather slow due to the fact that they are universal.  By modifying the firmware, we managed to increase the frequency of collecting our metrics.  And we have growth potential, we can use other cores - for example, STM32, we literally soldered this thing during the week and soon we will use it, I hope that it will work even better than Arduino. <br><br>  The most interesting thing is that we learned how to collect a metric in real-time: just flipping through Facebook on your phone, you can see which page of your friend consumes more energy.  However, while we do not use it, we try to use automatic methods.  It is also interesting that this million points on the screen in real-time is drawn in Python, it just amazes me. <br><br>  The next task that we faced after the acceleration of our piece of iron is synchronization.  What do you need to synchronize there?  The fact is that on the phone, on the Arduino, and on the computer the clock is different, they must either be synchronized first, and then measured so that your logs are then matched with the consumption schedule, or you must first take the logs and then synchronize them. <br><br>  How can these logs be synchronized with the phone?  The article about battOr describes the method of how they do it, and we decided to go the same way.  We generate bursts of energy consumption on the phone, for example, using a flashlight: we light a flashlight - consumption increases, we quench - consumption decreases.  Thus, we make a square signal, and then generate the same signal, but already, clean.  It turns out two graphs, one real, the other generated, and we compare them, moving our reference along the original signal.  And we are looking for a point where they correlate as much as possible with each other, here it is: <br><br><img src="https://habrastorage.org/webt/x7/11/w6/x711w6re6tupiopsmgtfuss3iiu.jpeg"><br><br>  We tried to do this, at first we had an approach in the forehead: count cross-correlation, move, count cross-correlation.  There were two problems with this approach.  First: it takes a very long time to read a few minutes for one test.  When our tester downloaded the results, he waits for a few minutes until the synchronization is calculated, this is bad.  And, secondly, we did not always find the very peak that we need, sometimes shifted in one direction or another.  Disclaimer: ‚ÄúI‚Äôm not a real welder,‚Äù but I‚Äôll try to explain the math we‚Äôve applied to solve these two problems. <br><br><img src="https://habrastorage.org/webt/6e/hj/_h/6ehj_hhej149exvc5vli1oddrve.jpeg"><br><br>  First, we applied the fast Fourier transform.  Cross-correlation is equivalent to a convolution with a signal deployed along the Y axis.  That is, we put a minus before the time in the signal or in the reference, and we consider the convolution, we obtain a cross-correlation.  This is the first thought.  Second: there is an FFT convolution algorithm, which is much faster than if you count it on the forehead.  Our synchronization was considered a few minutes, and with this algorithm we count less than a second per test. <br><br><img src="https://habrastorage.org/webt/mv/ud/lm/mvudlmuiao_2ybzbde08oraeefs.jpeg"><br><br>  How convolution works: we translate our function, our reference into the frequency domain.  That is, we had a graph, where the horizontal axis is time, and it became a graph, where the horizontal axis is frequency.  Then we multiply these two resulting graphics, and convert it back to the time domain.  We do this with the help of the fast Fourier transform, it sounds difficult, but in Python one line, like this: <br><br><img src="https://habrastorage.org/webt/v5/7f/d1/v57fd13jcc8h3bmr-m1ivb4g-ik.jpeg"><br><br>  I brought math to show that Python is cool!  Thus we solved the problem with the performance of our synchronization.  The next problem with instability.  Where does she even come from?  Here is a typical graph that we then observed, which was unstable: <br><br><img src="https://habrastorage.org/webt/uz/yp/_w/uzyp_wfjnl0cuqd9t_ie1l80fbu.jpeg"><br><br>  On it is our reference, it is clear that it coincides with the flashlight flash.  Green - cross-correlation graph.  And this chart has a problem: the difference between the peaks in height is not so big, and we still have noises on our chart due to the fact that we poke the screen, we move the shutter, where the flashlight turns on, with our hands, and this graph can shift to the right, for example, and this happens in different cases, sometimes happens, sometimes not. <br><br>  We tried to flash the program code in random order.  There was also a problem here - sometimes it worked well, sometimes not so much.  And we thought that there probably was some kind of optimal waveform for it to match well.  I began to search the Internet, came across a very interesting lecture <br>  about how the plane flies over the ice of Antarctica and measures the thickness of the ice. <br><br><img src="https://habrastorage.org/webt/ul/za/al/ulzaal21kf8mgcuijkprpt98pe4.jpeg"><br><br>  It turned out that they use the same thing.  The aircraft emits a signal, takes the signal back, and looks for a correlation with the reference. <br><br>  Here is the resulting picture, they found the thickness of the ice: <br><br><img src="https://habrastorage.org/webt/pb/u6/dq/pbu6dqtkr8dzpmqywmz7olge1-0.jpeg"><br><br>  And they had the same problem.  It is connected with the fact that when you take a random signal and are looking for a correlation with yourself ... <br><br><img src="https://habrastorage.org/webt/3s/mm/on/3smmonskj5mgxsz0s5mjzl_phpk.jpeg"><br><br>  Here, at the upper left, there is a random signal, a bit of noise is added there, and below it is a cross-correlation with oneself, just shifted.  And it is clear that the peak is not very pronounced there.  But when you take a signal with increasing frequency (upper right), then you get a signal with a pronounced peak (lower right). <br><br>  We also began to flash software flashlight with increasing frequency.  This is how it looks on the chart: <br><br><img src="https://habrastorage.org/webt/c9/bg/sw/c9bgswjmxe2302-sffr_1qwpgaa.jpeg"><br><br>  And our synchronization began to work much more stable.  The vertical yellow lines on the graph are the flashlight flash from the logs, the blue lines are the current consumption.  And on the right we see events from the logs, only the flashlight flash is displayed here, but in fact you can see there all the events from the logs and compare them with the original schedule. <br><br>  Now about how a typical test looks, from the point of view of a tester or a developer.  First, we can drive our tests manually. <br><br>  How it happens: we take the phone, disconnect USB (I‚Äôll explain why later), start recording measurements, blink the flashlight manually or using a special application, then do something on the phone, perform some scenarios that we want to measure stop the measurement recording, connect the USB back, download logs from the phone, they are automatically synchronized and loaded into our system for reports. <br><br>  With the help of such tests, we were able to make different measurements, for example, to compare different music applications by average power consumption during the scenario: <br><br><img src="https://habrastorage.org/webt/ph/7q/iz/ph7qiznlaq5n7ydj7m5nmjzzxgg.jpeg"><br><br>  Compare browser consumption during cold start, following links and other scenarios: <br><br><img src="https://habrastorage.org/webt/eh/1z/rs/eh1zrsdlhs3-aveb-ksyhgaf-fm.jpeg"><br><br>  But we, realizing that there are few manual tests, because testers cannot save enough time to measure everything, so we began to think how to automate all this. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For automation, first of all we had to solve the problem with the fact that the phone, when connected via USB, begins to be powered not from a battery, but from USB. There is no universal solution: someone turns off consumption by software, but this cannot be done everywhere, especially on the IPhone. </font></font><br><br><img src="https://habrastorage.org/webt/km/64/ea/km64eanqvtjfgx5rzr1s4kk5yna.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, we came up with a wire that does not give the phone more than 20 mA. It is arranged simply: there is one field-effect transistor (or, if you need to switch the current level, several field-effect transistors). </font></font><br><br><img src="https://habrastorage.org/webt/yv/wv/iw/yvwviwa2kr8yixo3reewkkfr-kc.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And we began to distribute all these wires for automatic tests. But this is not the only problem that has arisen. There is a problem with this circuit; it lies in the fact that you cannot connect USB.</font></font><br><br><img src="https://habrastorage.org/webt/y-/ud/xn/y-udxn4g5arq0hutd3jw0mslkb8.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Because you have a loop on the ground, and a minus on the phone, and a USB ground on the phone are different things, there is a potential difference between them, and you start to have a current, we first solved this with the help of these 10 kOhm resistors, t. e. your current is not so big, but it spoiled our measurements. </font></font><br><br><img src="https://habrastorage.org/webt/dy/ey/eh/dyeyehovr9teaiw8arfhsdrdpzg.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And we decided to add a galvanic isolation to our circuit. Made on the basis of a special chip, a signal passes through it, but the current does not pass, and we had to bring out our ADC. That is, first we used an analog-to-digital converter in the microcontroller, and now we have installed a separate chip that measures the voltage directly from the sensor.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The external ADC we chose better than the one that stands in the Arduino, and it has a bit more. </font><font style="vertical-align: inherit;">But in the picture above you can find a file. </font><font style="vertical-align: inherit;">Timur may, because his condenser flew in the forehead once, and now he is looking well. </font><font style="vertical-align: inherit;">Otgadka - under the spoiler.</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">    ,   ,        ,    : <br><br><img src="https://habrastorage.org/webt/qa/nq/qd/qanqqdstiuizxxc9az66f4lzb-4.jpeg"><br><br>  ,   ,     ,    ,           . <br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The process of automatic testing in our country looks something like this. </font><font style="vertical-align: inherit;">We send a test list (our test script, config) to the server. </font><font style="vertical-align: inherit;">The server starts the recording of measurements, automatically flashes a flashlight, then we run a test build, this is a JAR-nickname on the phone. </font></font><br><br><img src="https://habrastorage.org/webt/nc/o0/yr/nco0yrorrw9lvu_-ila1mfdbegi.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then everything is loaded into our analytical system, and there we see different graphs. </font><font style="vertical-align: inherit;">Different teams in different ways, this is the example of the browser command:</font></font><br><br><img src="https://habrastorage.org/webt/4z/np/w8/4znpw8qmz568mbvadn3rcuwtbcq.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">They have tests divided into so-called suites. </font><font style="vertical-align: inherit;">One suite is a set of tests for a specific browser functionality: only the network is testing something, only the UI is testing something. </font><font style="vertical-align: inherit;">And when such a suite starts to run, they log the tag ‚Äúwe started testing the UI‚Äù, when it ends - ‚Äúwe finished testing the UI‚Äù. </font><font style="vertical-align: inherit;">We combine the logs with the consumption schedule and select fragments on the consumption graph when it was tested. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, we can follow the regressions, how the consumption of a specific test suite changes from version to browser version: UI, network, etc. </font></font><br><br><img src="https://habrastorage.org/webt/wj/qx/qh/wjqxqhzw8d18nfe20g10lxx5y1s.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we select fragments, we can run each test several times to collect statistics on them so that the most stable results are obtained, and then we build regression graphs.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now Timur will tell you how to do this at home. </font></font><br><br><h2>  How to do it </h2><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Timur Torubarov:</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> You, probably, got bored, Alexey told about all sorts of complicated things, about mathematics, microcontrollers. And I will entertain. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alexey has already told that we are on load testers, and we are doing Yandex.Tank. And with Volta, this is the name of our project, we did the same thing: we put it </font></font><a href="https://github.com/yandex-load/volta"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">into the open source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , you can download it, touch it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But ‚Äúdo not repeat it at home‚Äù: the technique is expensive, especially the iPhone, so do everything at your own peril and risk, and either be very careful or prepare ten iPhones in advance.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, we want to do, for example, that my Android would live out until the evening, so that all people‚Äôs phones would live longer, the manufacturers would take care, including software, how the hardware itself works, and optimize their software as they could. </font></font><br><br><img src="https://habrastorage.org/webt/28/tm/gh/28tmghgn0okieofrxozfnbr8su0.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's try to assemble such a box, which was told by Alexey, with his own hands, quickly and from improvised means. Here are three components: a current sensor, a power supply unit and a microcontroller, each of these components can be bought on AliExpress for 50 rubles.</font></font><br><br><img src="https://habrastorage.org/webt/tk/eu/sh/tkeusht67oscu1tdconsjzkeotc.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First we need food. We took a ready-made board based on the XL4005 module, 50 rubles on Aliexpress, this is a DC-DC step down voltage converter. We feed it from a laptop power supply, which is almost free of charge in the helpdesk, because when replacing laptops, employees donate old ones together with power supplies, their whole mountain lies, we come and pick up the boxes. They say thank you, but they probably don‚Äôt know what we are doing with them later. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But not all power supplies are suitable, you need to carefully measure the potential difference between the minus output and USB, so as not to burn anything (for example, a new Macbook).</font></font><br><br><img src="https://habrastorage.org/webt/4p/to/pp/4ptoppuxwjedud5v_ijcrxm4otg.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notebook power supplies are powered by 220 V, and geoservice guys were not very comfortable testing their applications with geolocation: they walked down the street around the office with a large seven-kilogram UPS with lead batteries, with a laptop, with our box and phone. It‚Äôs okay to go around Yandex‚Äôs office like that, people don‚Äôt ask questions, but it‚Äôs better not to come to the railway station. </font></font><br><br><img src="https://habrastorage.org/webt/8y/sz/1y/8ysz1yfj00lbajow7wclksllnu4.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Especially for them, we made a box that is powered by a battery. And it writes data to the SD card, you can then go somewhere to the office, download, download the backend and everything works fine. It is convenient to go on business trips, the guys with such things went to Belarus, there were no questions. By the way, it works from the cigarette lighter: Alexey's Kia cee'd passed the test.</font></font><br><br><img src="https://habrastorage.org/webt/nv/bv/2_/nvbv2_eon5jqbx-_8b1drjytyns.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second component of this box is a current sensor, bought on AliExpress for 50 rubles, very convenient. It converts current to voltage, one ampere to one volt. We, accordingly, interrogate it by the microcontroller. The measurement range is from zero to three amps, it fits us perfectly. But he has a problem: there is no electrical isolation, about which Alexey has already spoken. </font></font><br><br><img src="https://habrastorage.org/webt/wy/df/ot/wydfotexjssdk7jkohi4z1wujau.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not do this. </font></font><br><br><img src="https://habrastorage.org/webt/q-/mp/jr/q-mpjraauweff9n6tfszfw5yymi.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next is the microcontroller. You can take the Arduino Nano, to the surprise, it costs 50 rubles on AliExpress, it has a built-in ADC and it is convenient to write firmware: either in the Arduino Studio or in the Platformio IDE. We took Platformio IDE, because it is installed from the console with one command, and the firmware is clogged with one command, super.</font></font><br><br><img src="https://habrastorage.org/webt/m4/bz/m6/m4bzm6ojwnfdfu_ssescq2h1v40.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Putting it all together, it looks like this: power, current sensor, microcontroller and telephone, which is powered by a power supply unit through a current sensor. </font></font><br><br><img src="https://habrastorage.org/webt/2w/xu/cw/2wxucw73i1mdohuqlbkgvyu-j4c.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fill the firmware on the microcontroller, ready-made firmware can be taken from us, there are both for 500 samples per second, and for 10,000, it is poured in with one command. For automation, for some console pieces - this is the perfect solution. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After we have collected the box, we need to prepare the phone. </font></font><br><br><img src="https://habrastorage.org/webt/hq/w1/av/hqw1av1lk794khj1jrucab_eypu.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alexey included this video in the presentation, because he wanted to play a trick on me and see how I‚Äôll get out ... In general, I don‚Äôt know what I was guided by when I did it on my knees, but not exactly by safety.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a portable box that we collect for geo-services. In general, you need to prepare a phone. The algorithm is very simple: you need to disassemble it, pull out the battery, cut off the controller from the battery, solder the wires to them and assemble them back. But the phones are all different, and this is a problem. </font></font><br><br><img src="https://habrastorage.org/webt/0g/s5/qs/0gs5qswfraid4z0jklv0wwko7de.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a whole bunch of problems (especially the iPhone): there are fragile elements, unreliable loops. For example, this is the story: when we disassembled the iPhone 5, found a bunch of cables going to the display, and they all attached to the motherboard with a metal cover. The cover is screwed to the motherboard with four bolts, and all four are the same size but different lengths. Do you understand what the trick is? If the screw is not screwed in the wrong place, it breaks through the motherboard, and it‚Äôs almost solid on the iPhone: it's very difficult to fix this thing.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the same time, the difference in length is something in the region of 0.1 millimeter, it is not visible to the eye. That is, if you have not read it, then you do not know about it. But in the end, all the forums are filled with amateurs, who disassembled, then collected and stumbled upon it. And so we also lost the iPhone 5. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We also don‚Äôt like glass cell phones. One Korean company, whose batteries have recently come on fire, still loves to glue everything and loves glass cases. We are not so much not to love this company, but to disassemble its phones is a problem for us. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And after we have prepared the box, prepared the phone, we just have to install the software. We use Python and install with the command ‚Äúpip install volta‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is how it looks under the hood:</font></font><br><br><img src="https://habrastorage.org/webt/z4/cd/mg/z4cdmgma1xhayxobotshgy107xi.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I show this only for you to understand that we have thought over everything there. Do not understand this. I wrote this for two months. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And now I will show the demo how we are testing the real Yandex browser application. </font></font><br><br><img src="https://habrastorage.org/webt/o4/ao/w1/o4aow1qsqq74jwv8f6nj2ipsama.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We use Jupyter Notebook, Python pandas - all these jokes, because we are load testers, we love statistics. We will work with Volta, as with the library. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We import the library, create the config, specify the path to the device, the type of the box (binary), and the voltage. Voltage is set arbitrarily, as you screwed it onto DC-DC. And create a class Voltabox, start the data collection, start test.</font></font><br><br><img src="https://habrastorage.org/webt/x6/qr/pm/x6qrpm8uocuckprnztym456kw28.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data is collected. We can read one second of this data, at the output we get the pandas dataframe. Let's make describe, look and see that in the dataframe for 1 second there are 10,000 values ‚Äã‚Äã(this is a box of 10 kHz), and an average consumption of 116 mA. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We perform tests, stop recording with the command volta_box.end_test (), now for speed we will not do this. Stopping the test, perform a couple of functions. One of them reads out the data from the queue with the results and prepares them, collects them into the necessary dataframe. The second builds on the prepared data graphics, we show them. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In principle, since the code lies in the open source, we will not comment on it now to every comma. The main thing: we build graphs, we prepare data, it turns out that such beauty, on which nothing is clear.</font></font><br><br><img src="https://habrastorage.org/webt/zr/sy/we/zrsywe8xvfijdtkhd4fmgsxh0wc.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blue is current consumption. There are a lot of values, which is why it is so noisy, and for clarity, we built a red moving average, a moving average. Now we will understand what is happening on this chart. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the process of tests, we collect logs from the phone, and we can record various events in logsat, then get them to the computer, and then automatically put them on the charts (using the synchronization that Alexei spoke about). And we see the events of the inclusion of something on the phone, I do not remember what we included here. It was a test with some build of Yandex. Browser, there was a patch there that the developer wrote overnight (probably, having reached Balmer Peak).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, he wanted to quickly roll in the prod, says: "Look, I have such a patch, it will bring a lot of money, let's test it." The manager's eyes lit up: "Let's roll," we began to test. We took two applications, without a patch and after, and began to compare. The first launch with the patch, the second without the patch. Select a second of these sections, reduce it all to one chart and see:</font></font><br><br><img src="https://habrastorage.org/webt/hz/gg/ea/hzggea4vxb1c_nnsjs72-ceni64.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have a certain Baseline, it is indicated in gray, this is when the phone just lies with the display on. We have a blue line - this is a test run without a patch. And we have a red line, which probably brings a lot of money, but for some reason it is above all. And here is a very controversial situation: if there is a lot of benefit, maybe it can be rolled out, and in the future it can be paid. But, most likely, the developer will rework and finish something so that it works optimally and does not hurt users, because if the user has a battery because of us, we will suffer. Because he will leave.</font></font><br><br><img src="https://habrastorage.org/webt/za/10/dm/za10dmzja2m42fjl-vumpgrweqo.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We've got a bunch of metrics, and then we can work with them, compare, count quantile, average - now we will not go deep into analytics. </font><font style="vertical-align: inherit;">It is important that we managed to assemble a device from available tools that would measure energy consumption and move away from percentages and three-day tests for metrics with which you can already work, which can be compared, by which you can build a regression, back-to-back tests and all these familiar things that are pleasant and convenient to work with. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At parting, I demonstrate Nexus: you see, it has no back cover, no battery, not even a power button ... I could switch on the same, but I don‚Äôt remember the pin code. </font><font style="vertical-align: inherit;">The guys from the browser reinsured.</font></font><br><br><img src="https://habrastorage.org/webt/ho/rb/y7/horby7ucndxdgsb3rpt2cq7bi4y.png"><br><br>  Useful links: <br><br><ul><li> <a href="https://t.me/joinchat/Bvb4RgvBER4pdC0F2v1jbw"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Volta telegram chat</font></font></a> </li><li> <a href="https://github.com/yandex-load/volta"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Volta source code</font></font></a> </li><li> <a href="https://rezonit.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Print boards</font></font></a> </li><li> <a href="https://solderpoint.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SMD soldering and not only</font></font></a> </li><li> <a href="https://diptrace.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Board design</font></font></a> </li></ul><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Like this report? </font><font style="vertical-align: inherit;">Please note that this week </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Heisenbug 2018 Piter</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will take </font><b><font style="vertical-align: inherit;">place</font></b><font style="vertical-align: inherit;"> , where there will also be </font></font><a href="https://heisenbug-piter.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a number of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> interesting speeches. </font><font style="vertical-align: inherit;">For example, Yandex will be presented again this time, in two presentations at once: </font></font><a href="https://heisenbug-piter.ru/talks/2018/spb/6vm8srckjooygusg6quem8/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúCrowdsourcing in testing‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://heisenbug-piter.ru/talks/2018/spb/yxgdkomdbus8ooeeeeemm/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúAtlas - your new PageObject guide‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br></blockquote></div><p>Source: <a href="https://habr.com/ru/post/358378/">https://habr.com/ru/post/358378/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358368/index.html">Industrial IoT: Demand Study</a></li>
<li><a href="../358370/index.html">[Friday] Chewie, we are wrapped</a></li>
<li><a href="../358372/index.html">From Augmented Reality to Kotlin: How Mobius 2018 Piter Passed</a></li>
<li><a href="../358374/index.html">As I built the year extension for the browser that reads articles by voice (with synchronization in the podcast)</a></li>
<li><a href="../358376/index.html">How we organized data storage cheaper than Amazon Simple Storage Service by 35%</a></li>
<li><a href="../358380/index.html">Selection of core events for 2018: all about IaaS, IT infrastructure and Big Data</a></li>
<li><a href="../358382/index.html">Why does Google reduce the ‚Äúlifetime‚Äù of cookies received via HTTP?</a></li>
<li><a href="../358384/index.html">Marvin Minsky "The Emotion Machine": Chapter 3 "Learning from Failures"</a></li>
<li><a href="../358388/index.html">Cooking 1C-Reporting in Linux</a></li>
<li><a href="../358390/index.html">Modern automotive industry - educational program. Prologue</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>