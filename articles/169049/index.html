<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manage Network Folders with PowerShell</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We publish the second part of the translation of the article File Server Management with Windows PowerShell . In the first part, we looked at how to b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Manage Network Folders with PowerShell</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/storage2/552/fb0/ecc/552fb0ecc229f4d58aa660ef7008b1f2.png"><br>  We publish the second part of the translation of the article <a href="http://www.windowsitpro.com/content1/topic/windows-powershell-file-server-management-143789/catpath/windows-powershell">File Server Management with Windows PowerShell</a> .  In the <a href="http://habrahabr.ru/company/netwrix/blog/168377/">first part,</a> we looked at how to build network folder reports using PowerShell. <br>  This time, our focus is on issues such as creating a network folder, delegating access to it and stopping sharing. <br><br><h4>  Create new folders </h4><br>  Now let's take a look at how PowerShell can be used to create and manage files and folders.  Everything that I will demonstrate, you can use in PS 2.0 and 3.0 (although in PS 3.0 you can simplify the examples I've given).  Managing a file server in PowerShell 2.0 requires accessing WMI and writing complex scripts.  In PowerShell 3.0, especially if you have Windows Server 2012, this type of management is greatly simplified.  That's what I'm going to consider. <br>  Everything we need is already available in the <b>SMBShare</b> module, which is installed by default on my Windows 8 machine. The commands in this module will allow us to manage folders locally and remotely.  I'm not going to dwell on each team in detail - they are pretty much the same type;  I recommend reading help and examples.  We will start by using the <b>New-SMBShare command</b> to create a new folder. <br>  You need to do this in a couple of steps.  Since the folder should be on a remote server, I will set up a remote PowerShell session: <br><pre><code class="vbscript hljs">$session=<span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-PSSession -ComputerName SRV2K12RC</code> </pre> <br><a name="habracut"></a><br>  Of course, I can use the interactive session, but we are faced with the task of automation, so I use the <b>Invoke-Command command</b> .  First, I will create a new folder: <br><br><pre> <code class="vbscript hljs">invoke-command -ScriptBlock {mkdir c:\shares\companyfiles}-Session $session</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And now the hard part.  I want to set these NTFS permissions so that <i>JDHLAB \ Domain Users</i> have Change permissions (Change).  To do this, you need to create a new access rule that changes the list of access rules and reapplies them to the folder.  Example 6 shows an example script: <br>  <b>Example 6: Creating, modifying and applying access rules</b> <br><br><pre> <code class="vbscript hljs">$sb={ Param($path) $du=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-object System.Security.AccessControl.FileSystem AccessRule <span class="hljs-string"><span class="hljs-string">"jdhlab\domain users"</span></span>,<span class="hljs-string"><span class="hljs-string">"Modify"</span></span>,<span class="hljs-string"><span class="hljs-string">"allow"</span></span> $acl = <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-ACL $path $acl.AddAccessRule($du) <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-Acl -Path $path -AclObject $acl }</code> </pre><br><br>  In Example 6, I made it so that the path parameter can be reused. <br><br><pre> <code class="vbscript hljs">Invoke-Command -ScriptBlock $sb -Session $session -ArgumentList c:\shares\companyfiles</code> </pre><br><br>  There are ways to simplify this process, but for purposes of clarity, we will keep everything as it is.  Now we are ready to create a new folder. <br>  I can use this session, but I want to demonstrate how you can use the <b>New-SmbShare command</b> to remotely connect to a file server: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-SmbShare -Name Files -Path c:\shares\companyfiles -CimSession SRV2K12RC -FullAccess <span class="hljs-string"><span class="hljs-string">"jdhlab\domain admins"</span></span> -ChangeAccess Everyone -Description <span class="hljs-string"><span class="hljs-string">"Company files"</span></span></code> </pre><br><br>  Access to the default folder is Read Only (ReadOnly).  I gave domain admins Full Control over the folder, and I gave everyone else the rights to change (Change).  This path is relative to the remote computer, which should work under PS 3.0. <br><br><h4>  Advanced folder settings </h4><br><br>  You can get information about a folder at any time by using the <b>Get-SMBShare command</b> , as you can see in Figure 9. You can do a couple more things with our folders, for example, to encrypt the SMB connection, which enumeration mode and caching type to use for folders.  I'm going to use <b>Set-SMBShare</b> to make a flexible setup for the folder I just created.  Let's see it on example 7. <br><br>  Example 7: Flexible folder configuration <br><br><pre> <code class="vbscript hljs">PS C:\&gt; <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-SmbShare -Name Files -EncryptData $<span class="hljs-literal"><span class="hljs-literal">True</span></span> -FolderEnumerationMode AccessBased -CachingMode Documents -CimSession SRV2K12RC Confirm Are you sure you want <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> perform this action? SRV2K12RC: Performing operation <span class="hljs-comment"><span class="hljs-comment">'Modify' on Target '*,Files'. [Y] Yes [A] Yes to All [N] No [L] No to All [S] Suspend [?] Help (default is "Y"):</span></span></code> </pre><br><br><img src="https://habrastorage.org/storage2/ec2/0ad/06f/ec20ad06f24ca36ebf42fe877cbfcddf.jpg"><br><br>  The above applies to a single folder, but you can easily use <b>Get-SMBShare</b> to extract all folders and then transfer them to <b>Set-SMBShare</b> and apply changes to them all: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-SMBShare -CimSession SRV2K12RC -Special $<span class="hljs-literal"><span class="hljs-literal">False</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-SmbShare -EncryptData $<span class="hljs-literal"><span class="hljs-literal">True</span></span> -Confirm:$<span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre><br><br>  This command will extract all folders (except administrative folders) on computer <i>SRV2K12RC</i> and set the <b>EncryptData</b> property to <b>True</b> .  I don‚Äôt want to confirm every action, so the <b>Confirm</b> switch is set to <b>False</b> .  <b>Set-SMBshare</b> does not write anything into the pipeline, in the event that you do not use <b>‚ÄìPassthr</b> u.  As you can see, I was able to change everything with the help of a single command. <br><br><h4>  Deleting network folders </h4><br><br>  Finally, delete the network folder.  The code in Example 8 completely disables sharing of the folder I just created.  Is it possible to make it easier?  Of course, the folder structure is still on the file server. <br><br>  <b>Example 8: Delete the network folder</b> <br><br><pre> <code class="vbscript hljs">PS C:\&gt; Remove-SmbShare -Name Files -CimSession SRV2K12RC Confirm Are you sure you want <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> perform this action? SRV2K12RC: Performing operation <span class="hljs-comment"><span class="hljs-comment">'Remove-Share' on Target '*,Files'. [Y] Yes [A] Yes to All [N] No [L] No to All [S] Suspend [?] Help (default is "Y"):</span></span></code> </pre><br><br><h4>  Bringing together </h4><br><br>  And now let's summarize everything in one script.  Without going into details of the code, I note that the commands can be run in parallel.  For example, after creating a folder, I create a network folder and set NTFS permissions at the same time, see example 9. <br><br>  <b>Example 9: Create a network folder and set NTFS permissions</b> <br><br><pre> <code class="vbscript hljs">Workflow <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-FileShare { Param( [<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>]$Name, [<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>]$Path, [<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>]$Principal, [<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>]$<span class="hljs-built_in"><span class="hljs-built_in">Right</span></span>=<span class="hljs-string"><span class="hljs-string">"Modify"</span></span> ) #    . Sequence { #  Write-Verbose -Message <span class="hljs-string"><span class="hljs-string">"Creating new folder $path on $pscomputername"</span></span> $newfolder = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-Item -Path $path -ItemType Directory } # . Sequence { Parallel { #      InlineScript { Write-Verbose -Message <span class="hljs-string"><span class="hljs-string">"Modifying NTFS permissions"</span></span> Write-Verbose -Message <span class="hljs-string"><span class="hljs-string">"Creating entry for $using:principal with a right of $using:Right"</span></span> $entry=<span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-Object -<span class="hljs-built_in"><span class="hljs-built_in">typename</span></span> System.Security .AccessControl.FileSystemAccessRule -argumentlist $using:Principal,$using:<span class="hljs-built_in"><span class="hljs-built_in">Right</span></span>,<span class="hljs-string"><span class="hljs-string">"allow"</span></span> #  ACL $acl = <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-ACL -path $using:path #   $acl.AddAccessRule($entry) Write-Verbose -Message <span class="hljs-string"><span class="hljs-string">"Applying the new ACL"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-Acl -Path $using:path -AclObject $acl } #inline #  . Write-Verbose -message <span class="hljs-string"><span class="hljs-string">"Creating the file share $name"</span></span> $newshare = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-SmbShare -Name $name -Path $path -Description <span class="hljs-string"><span class="hljs-string">"File share for $principal"</span></span> -EncryptData $<span class="hljs-literal"><span class="hljs-literal">True</span></span> -FolderEnumerationMode AccessBased -CachingMode Documents -FullAccess <span class="hljs-string"><span class="hljs-string">"$env:userdomain\domain admins"</span></span> -ChangeAccess $Principal } #Parallel } #sequence # . Sequence { Parallel { Write-Verbose -Message <span class="hljs-string"><span class="hljs-string">"Getting the new share"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-SmbShare -Name $name Write-Verbose -Message <span class="hljs-string"><span class="hljs-string">"Getting the new share access"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-SmbShareAccess -Name $name } }</code> </pre><br><br>  This script creates a new network folder, assigns permissions to a user or group.  I can run it from under Windows 8 or on a Windows Server 2012 file server using the following command (which should be entered in one line): <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-FileShare -Name adeco -Path c:\shares\adeco -Principal jdhlab\adeco -<span class="hljs-built_in"><span class="hljs-built_in">Right</span></span> <span class="hljs-string"><span class="hljs-string">"FullControl"</span></span> -PSComputerName SRV2K12RC</code> </pre><br><br>  The process will take a couple of seconds.  The results in the screenshot below. <br><br><img src="https://habrastorage.org/storage2/e0e/fa5/e3a/e0efa5e3a402edbd84faa104b6e13516.jpg"><br><br>  There is nothing wrong with using an ordinary GUI for the same.  However, if you need specialized reports or you want to automate this process, PowerShell is the best fit. <br><br>  All examples can be downloaded <a href="">here</a> .  The author also recommends visiting the forums on <a href="http://powershell.org/">PowerShell.org</a> for all issues related to PowerShell. </div><p>Source: <a href="https://habr.com/ru/post/169049/">https://habr.com/ru/post/169049/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../169035/index.html">Key figures of the IT labor market (January 2012 - January 2013)</a></li>
<li><a href="../169037/index.html">PocketBook SURFpad Review</a></li>
<li><a href="../169039/index.html">What do Win32 / Redyms and TDL4 have in common?</a></li>
<li><a href="../169043/index.html">Leap Motion. Unpacking and small overview</a></li>
<li><a href="../169047/index.html">How to quickly create a survey on your site using Google forms?</a></li>
<li><a href="../169051/index.html">Responsive design using camera</a></li>
<li><a href="../169055/index.html">Optical flux calculation using the Lucas-Canada method. Theory</a></li>
<li><a href="../169059/index.html">Judgments, conclusions, syllogisms ... or the achievements of ancient logic in one post</a></li>
<li><a href="../169061/index.html">Bill Gates Answers Reddit User Questions</a></li>
<li><a href="../169063/index.html">Wireless charging available on Google Play</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>