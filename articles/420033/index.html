<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we started registering cash desks for our clients</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="According to the amendments to 54-FZ, since July of this year, almost all commercial enterprises are obliged to use online cash registers that transmi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we started registering cash desks for our clients</h1><div class="post__text post__text-html js-mediator-article">  According to the amendments to 54-FZ, since July of this year, almost all commercial enterprises are obliged to use online cash registers that transmit data via the Internet to the tax service.  To acquire such a device, you will have to buy a cash register and a fiscal storage device, sign a contract and pay for the services of a fiscal data operator, register with two personal accounts of the FTS and CRF, enter details into the cash register, and receive a paper registration report.  Well, you will also need an electronic digital signature, otherwise you will have to come to the FTS and personally stand in a queue. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3a9/fb3/9b6/3a9fb39b680344c3f892804eb41b1a11.png"><br><br>  We decided to save our customers from all this horror by making a service that automatically registers everything almost in one click.  About this now and tell. <br><a name="habracut"></a><br><h2>  Why do we need it </h2><br>  You already understood, checkout is a tedious multi-level quest, but this is not the only problem.  At each stage, a zoo of interfaces awaits, the forms of which will have to be filled in manually with registration data for each cash desk, as well as a full set of relevant bugs (separate hello tax requirements for using IE browsers, Yandex Browser or Satellite).  Hundreds of opportunities to make mistakes, spoil the procedure and start over.  And if you install 5-10 cash registers, the chance of error when entering the same details grows significantly.  Not to mention the unproductive time wasting and figuring out why the personal tax office refuses to accept the token that ‚Äúswallowed‚Äù perfectly just yesterday. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/cz/bk/qn/czbkqnhvog24qqgwodhckwfyhew.png"><br><br>  And when we felt the brunt of the above described tragedy, we decided to take on the development. <br><br><h2>  Stages of registration </h2><br>  Several parties are involved in the registration of the cashier at once.  This is the tax service (FTS), the OFD is the operator of fiscal data, through which the cash departments interact with the tax authority, a certificate authority, issuing electronic signatures and, as a rule, a little confused entrepreneur who is lost in the bureaucratic twists and turns.  We wanted to intervene in their relationship, so much so that we could take on all the difficulties. <br><br>  Conventionally, the procedure is divided into two stages: <br><br>  Registration of the cash register - the data of the specific apparatus are sent to the FTS, and in response comes the registration number. <br><br>  Fiscalization - activation of the cash register using the registration number of the car assigned by the FTS. <br><br>  First of all, we went to our partners to work with them on the first stage. <br><br><h2>  API for FTS </h2><br>  We are not the first to think about automating registration.  Many said that they were doing something in this area, that the development was in progress, but no one had a ready-made external interface.  One of the operators of fiscal data was provided by the API - almost ready to interact with the tax. <br><br>  At that time, a total of about 80 test applications were sent using the protocol.  We believed that the interface would soon work at full capacity, and began to implement and test on "plugs". <br><br>  Going out on the prod, we realized that our tests and the real application are different, like day and night.  The ‚Äústubs‚Äù that we received from the CRF included only the success mock, reproduced the successful scenario.  In fact, to achieve the very ‚Äúsuccess‚Äù was not easy. <br><br>  The hits were: applications on the side of the partners, unworked for several days, lack of feedback from the FTS and CRF, signature errors and our favorite ‚Äúunknown error‚Äù.  The FTS protocol turned out to be poorly documented and, often, responded with unspecified failures, for which it is not clear what caused them.  There is still no clear specification.  So the first time we tested the protocol, and, together with the CRF, we made decisions on how to respond to certain responses of the FTS in specific cases. <br><br><h2>  Cash API </h2><br>  While part of the team was studying the behavior of the FTS systems in practice, the work did not stand still.  In parallel, we arranged negotiations with the manufacturers of cash desks, suggested that they implement data exchange from us to their platform, from platform to cash register and in the reverse order for setting up automatic fiscalization of cash registers. <br><br>  We selected a pair of universal monoblock solutions.  Cashier Evotor with touch screens and Drimkas - for those of the customers that are accustomed to the good old buttons and consider additional functionality redundant.  Models are different: with and without a scanner. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ro/r7/dc/ror7dcretvhsilz3yiw12judrxi.png"></div><br>  If the OPD had its own API in readiness, then for the cash contractors it had to be developed from scratch.  Otherwise it is impossible to make all registration data to the cashier automatically, without manual input. <br><br>  The colleagues achieved success by setting up interaction through their platform, and soon they were ready: an API for opening a client‚Äôs personal account and a proprietary protocol for managing the cash register. <br><br><img src="https://habrastorage.org/webt/wy/5h/hr/wy5hhrv-agl7qmya0x9pnpbppde.png"><br><br>  Our suppliers were the first to set up automatic filing of registration information at the box office.  And soon, the API will make it easy to deregister and re-register cash. <br><br>  Now, when we are negotiating with other cash vendors, one of the key requirements is the support of this interface. <br><br><h2>  Anatomy of autoregistration </h2><br>  After we learned how to work with the FTS and implemented an API for transferring registration data to the cash register with vendors, it was time to link it all into a single system and establish a registration procedure. <br><br>  This is the task of choosing the right architecture, which would allow controlling the asynchronous registration of the cash register both at the CRF, at the Federal Tax Service, and at the vendor.  Since they respond to requests with a delay, the process is extended over time and has a large number of integrations with external systems.  Because of this, we had to write two applications in Java. <br><br>  The Job service communicates directly with the CRF and the box office system.  For example, we send customer data to the CRF and expect to receive a registration number in response. <br><br>  Job service polls the status of the application at regular intervals.  He asks and asks again until the result is answered.  The registration number is saved, Job transfers the application to the next stage and fiscalization begins. <br><br>  If at first, we closely followed the passage of requests and manually studied every error that the system gave, now the process is automated. <br><br>  We immediately determine the cause of the error.  And in case of massive problems, monitoring systems were set up, which fix anomalies indicating major failures at the FTS or CRF.  The client learns about the problems in a single case: if, in response to a request, we receive a specific reject, a reasoned refusal to register. <br><br>  The second application, CashReg, is a processing system where the status model is presented, represented in a relational form. <br><br>  It was developed on the basis of the API provided by vendors and the CRF, and included all possible transitions for each class participating in the registration process.  The status model allows you to avoid internal errors and eliminate deviations from the standard algorithm for processing the application. <br><br>  So, if an application is in one status for too long, for example, it does not receive a registration number for several hours, or the CRF will indicate the wrong stage or status of the application in the response, CashReg reports an error. <br><br>  Of course, to control the procedure needed admin panel.  She works with the group of support for trade decisions, serving and accompanying cash registers during registration.  Now only two employees are involved in this, but their working interface is not complicated, and the process of preparing the cash desk, thanks to the refusal of manual data entry, is simple.  So, we can quickly and easily scale the department. <br><br>  All three components of the registration system do not imply high loads, because they are deployed in virtual environments. <br><br><h2>  How is the application processing? </h2><br>  All this required that the client, having left the application in his personal account, in a few days put the activated cash desk at the counter ready for work. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f14/777/abe/f14777abe2e59529a31a321dcfbe01ca.png"></div><br>  From the point of view of internal cuisine, the magic of auto-registration looks a bit more complicated.  Having left the application in the personal account, the client gives us legal consent to issue the electronic signature and complete the entire procedure on his behalf. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/36e/5ef/ccb/36e5efccba0427be9fef8324a50323c3.png"></div><br>  Information about the company, registration data for a specific store and signer (for example, the general director) is extracted from the banking bases.  They are updated in SPARK, pass scoring and enter the master system at the cash registers. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ae4/749/b78/ae4749b7824fe74ebc8ddefb2d952955.png"></div><br>  Then an application is created in CASHREG.  It is displayed as a new task in the admin panel of an employee from the trade decision support group.  He sees which cash register and fiscal drive the client needs.  The employee finds the required device in the warehouse, selects the fiscal drive, barcode their serial numbers and confirms the application.  So specific devices are attached to it that will be delivered to the client.  At this moment, the CRF receives a request: ‚Äúform an application for registration of such and such a cash register for such a company‚Äù. <br><br>  The file sent by the CRF in response is certified by an electronic signature and, using the CRF API, sent to the tax authorities.  There the checkout is assigned a registration number. <br><br>  Now the full package of documents at the box office goes to the manufacturer of the cash register (yes, they are also involved here).  In parallel, the task appears in the admin panel - fiscalize the very cashier.  This means that the employee simply includes the cashier.  The vendor‚Äôs system ‚Äúsees‚Äù that the device has been contacted and loads all the necessary registration data into its memory automatically.  Errors during manual entry are excluded, the same details fall into the FTS, and the cashier. <br><br>  The cashier prints a registration report - something for which everything was started.  The fiscal data from the report: date of printing, signature, fiscal sign, serve as confirmation that the box office is ready to work.  These details are again sent to the CRF. <br><br>  Immediately after the CRF generates a registration report, we sign it for the client, and the ready box office leaves with a courier. <br><br><img src="https://habrastorage.org/webt/dc/cs/et/dccsetgp8qnjvcijl84ra3n6vu0.png"><br><br>  The CRF has yet to prepare a registration card, but it can be not waited.  It will be available in electronic form in the client‚Äôs personal account in two or three days. <br><br><h2>  Conclusion </h2><br>  To implement this project, about twenty employees from the entire bank and many more specialists from our partners, CRF and cash vendors distracted themselves from the usual tasks, but their efforts were not in vain. <br><br>  The average time to get a registration number, with the exception of the most negative cases, is three hours.  In general, the whole procedure takes 5-6 hours.  90% of registrations complete with success.  At the moment, about 1000 applications have already been processed. <br><br>  In general, as you understand, we in our company love such cases, which can seriously simplify the life of a huge number of people.  Solving such problems you feel that you are doing something really useful. <br><br>  PS If you're interested, you can read how we <a href="https://habr.com/company/tinkoff/blog/358356/">filed our ATM</a> .  And with data exchange protocols. </div><p>Source: <a href="https://habr.com/ru/post/420033/">https://habr.com/ru/post/420033/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../420021/index.html">Why do you need Splunk? IoT and industrial data</a></li>
<li><a href="../420023/index.html">State saving in android applications</a></li>
<li><a href="../420025/index.html">Smart farm. What will it be?</a></li>
<li><a href="../420029/index.html">As we in 1C: Enterprise, we solve systems of algebraic equations</a></li>
<li><a href="../420031/index.html">Drawing with Render Targets in the Unreal Engine</a></li>
<li><a href="../420035/index.html">GUI on Golang: GTK + 3</a></li>
<li><a href="../420037/index.html">Stream with several cameras made from scrap materials</a></li>
<li><a href="../420041/index.html">War of TypeScript or Conquest of Enum</a></li>
<li><a href="../420045/index.html">Bunker for the date: how I was allowed to walk on the data center RUVDS on the territory of the space plant</a></li>
<li><a href="../420049/index.html">The book "The Man Talking. Evolution and language "</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>