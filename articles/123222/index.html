<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>My experience with AOP and PostSharp</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A long time ago, I researched PostSharp quite well and even started using it for my own development. He even managed to write a screencast and a coupl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>My experience with AOP and PostSharp</h1><div class="post__text post__text-html js-mediator-article">  A long time ago, I researched <a href="http://www.sharpcrafters.com/" title="http://www.sharpcrafters.com/">PostSharp</a> quite well and even started using it for my own development.  He even managed to write a <a href="" title="http://spbalt.net/content/Dmitri_Nesteruk_AOP.wmv">screencast</a> and a couple of articles on this topic.  Unfortunately, with PostSharp I didn‚Äôt happen at all afterwards, and for reasons of occasional requests from the community on ‚Äúhow?  why? ‚Äù, I decided to write this post to dot the i. <br><a name="habracut"></a><br><h3>  Free cheese in a mousetrap </h3><br>  PostSharp allows you to stick functionality into existing code by rewriting IL-a.  This idea is nothing new, and <a href="http://nesteruk.wordpress.com/2010/02/19/%25D0%25BC%25D0%25BD%25D0%25BE%25D0%25B6%25D0%25B5%25D1%2581%25D1%2582%25D0%25B2%25D0%25B5%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5-%25D0%25BD%25D0%25B0%25D1%2581%25D0%25BB%25D0%25B5%25D0%25B4%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5-%25D0%25B2-c-%25D1%2581-%25D0%25B8%25D1%2581%25D0%25BF%25D0%25BE%25D0%25BB/" title="http://nesteruk.wordpress.com/2010/02/19/%D0%BC%D0%BD%D0%BE%D0%B6%D0%B5%D1%81 %D1822D0%B2%D0 % B5% D0% BD% D0% BD% D0% BE% D0% B5-% D0% BD% D0% B0% D1% 81% D0% BB% D0% B5% D0% B4% D0% BE% D0% B2% D0% B0% D0% BD% D0% B8% D0% B5-% D0% B2-c-% D1% 81% D0% B8% D1% 81% D0% BF% D0% BE% D0% BB /">to write an MSBuild Task</a> that will do ILDASM, change something in IL, and then do ILASM is a rather trivial task.  At one time I did just that in order to remove the obfuscator metadata from the assembly.  (It is still a mystery to me why obfuscators intentionally help the crackers by telling them exactly what they were used for.) <br><br>  The essence of PostSharp is that you can declaratively take and mark, for example, a method, saying that each of its calls will occur in a separate thread: <br><br><pre><code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">WorkerThread</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ‚ãÆ }</code> </pre> <br>  PostSharp in the post-compilation process takes this method and rewrites it, replacing a simple method call with some <code>Task.Factory.StartNew(() =&gt; { /*   */ });</code>  .  It looks good and, let's be honest, it works. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But there are a number of problems.  For example, such code is difficult to manage.  That is, I cannot suddenly take it and say that in a separate thread only Class A methods will now be executed, and Class B methods will be blocking.  Moreover, I cannot really explain to users of my API that the method implements non-standard behavior ‚Äî they will continue to think that the method blocks, and write asynchronous calls <em>on top of it</em> , which will not lead to anything good. <br><br>  As for documenting, they can argue with me - they say once the attribute is present, then everything should be clear.  But here everything is not so simple either - for example, I <em>categorically dislike</em> that the attribute is present at all after compilation.  And that was the problem of PostSharp - he was trying to pull his library along, while a rational approach to the question suggests that in the good way <em>no libraries are needed</em> , because  we have a local rewriting of IL, and that's it. <br><br><h3>  Habituation effect </h3><br>  I had a huge class marked with the attribute <code>[NotifyPropertyChanged]</code> - I think you already understood what he was doing.  And everything would be as good, but in practice I was worried about several things. <br><br>  First, the code for implementing INotifyPropertyChanged was stupid through the aspect - it was so complex and unreadable that I was afraid to touch it even when I needed it. <br><br>  Secondly, at the <em>compilation</em> stage the object itself did not implement <code>INotifyPropertyChanged</code> and, accordingly, access to this interface had to be 'forged' through a double caste. <br><br>  Third, the attribute approach was all-or-nothing.  For example, I could receive notifications on the read-write properties, but when I wanted to change this property also generated <code>NotifyPropertyChanged()</code> on the read-only property <a href="http://www.codeproject.com/KB/cs/depanalyser.aspx" title="http://www.codeproject.com/KB/cs/depanalyser.aspx">dependent on it</a> , problems started here. <br><br>  As a result, I did a simple thing: I deleted PostSharp from the project and made the <a href="http://activemesa.com/r2p" title="http://activemesa.com/r2p">implementation of INPC through ReSharper</a> .  In other words, I stupidly automated the process of creating code, drove it through all the properties, and then manually corrected those from which I needed something special. <br><br><h3>  Alternatives? </h3><br>  It seems to me that anything is better than rewriting IL manually.  The ideal for me is to use the compiler object model for manipulating structures, i.e.  in fact, the approach for which the compiler is expanded.  The programming language <a href="http://boo.codehaus.org/" title="http://boo.codehaus.org">Boo</a> allows you to do this, Nemerle too, but as for C # 5, then no one can give any guarantees - we do not know what metaprogramming mechanisms will be in the next version. <br><br>  Another option is code generation.  Its advantage is that at least you can see what is happening, because  we only compile the code, without any post-build magic.  Naturally, code generation works best when it uses some kind of parser like the one built into ReSharper.  Through <a href="http://confluence.jetbrains.net/display/ReSharper/ReSharper%2B6%2BPlugin%2BDevelopment" title="http://confluence.jetbrains.net/display/ReSharper/ReSharper+6+Plugin+Development">the ReSharper API,</a> you can create very crazy things by manipulating code.  For example, the problem of notifications for dependent variables is easily solved at the level of a separate daemon (analyzer), which can step along dependencies and tell us what needs to be added where. <br><br>  Option three is to make your DSL.  If the task does not fall on a simple C #, perhaps it has no place in it.  Write <a href="http://www.codeproject.com/KB/dotnet/dslfsharp.aspx" title="http://www.codeproject.com/KB/dotnet/dslfsharp.aspx">DSL in the same F #</a> , or in some other language, or use for example <a href="http://www.jetbrains.com/mps/" title="http://www.jetbrains.com/mps/">MPS</a> to design this DSL and produce anything from it.  Yes, this is the same code generation only from a different angle, but at least this approach is less deceptive: it does not try to squeeze incompatible concepts into the limitations of one or another language. <br><br>  That's all.  Please note that my attitude towards AOP / PostSharp is just my personal opinion.  If everything works for you - it's great, write about it!  ‚ñ† </div><p>Source: <a href="https://habr.com/ru/post/123222/">https://habr.com/ru/post/123222/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123216/index.html">More about Python descriptors</a></li>
<li><a href="../123217/index.html">Competition from iLab: prize - Playbook!</a></li>
<li><a href="../123219/index.html">One-two-three-four-five, I am going to present</a></li>
<li><a href="../123220/index.html">The play "Developing a multiplayer online game." Part 1: Architecture</a></li>
<li><a href="../123221/index.html">Solaris Container (zone). Creation and administration. Part 1</a></li>
<li><a href="../123223/index.html">My subjective experience with SSD</a></li>
<li><a href="../123225/index.html">Search office fermer.mobi</a></li>
<li><a href="../123226/index.html">Answers to Habra from Skolkovo</a></li>
<li><a href="../123227/index.html">GTD, MLO and BlackBerry</a></li>
<li><a href="../123228/index.html">Lion sent for gold</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>