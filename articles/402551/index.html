<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FMA3 instructions in Ryzen tightly hang up the operating system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As it turned out, the execution of some specific FMA3 instructions on an AMD Ryzen processor leads to a critical OS crash. 

 Instructions like FMA3 (...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FMA3 instructions in Ryzen tightly hang up the operating system</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/geektimes/post_images/ef0/f3f/1fa/ef0f3f1fa15cc51a8fc1424db30e13ef.jpg"><br><br>  As it turned out, the execution of some specific FMA3 instructions on an AMD Ryzen processor leads to a critical OS crash. <br><br>  Instructions like FMA3 (Fused-Multiply-Add) are supported by both Intel (in Haswell) and AMD.  These instructions are of type <code>d = round(a √ó b + c)</code> , where <i>d</i> must be in the same register as <i>a</i> , <i>b,</i> or <i>c</i> .  For comparison, the FMA4 instructions only support AMD (in Buldozer and later processors).  There <i>a</i> , <i>b</i> , <i>c</i> and <i>d</i> can be in different registers. <br><a name="habracut"></a><br>  A processor bug was found in <a href="https://github.com/Mysticial/Flops/tree/master/version2">Flops version2</a> , a simple and little-known utility for testing CPUs.  It should be noted that the developer of this utility, Alexander "Mystical" Yee (Alexander "Mystical" Yee) positions it as a specific testing utility that is sensitive to the microarchitecture of processors.  In other benchmarks, the bug never showed up. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The Flops version2 utility comes with specific binaries for all major x64 architectures (Core2, Bulldozer, Sandy Bridge, Piledriver, Haswell, Skylake).  But at the moment, neither among binary builds <a href="https://github.com/Mysticial/Flops/tree/master/version2/binaries-windows">for Windows</a> , nor <a href="https://github.com/Mysticial/Flops/tree/master/version2/binaries-linux">for Linux is</a> there a version for testing Zen.  Therefore, now for testing Ryzen used binaries of other architectures, namely the closest Haswell.  The above-mentioned error with the FMA3 instructions was <a href="http://forum.hwbot.org/showthread.php%3Ft%3D167605">discovered two weeks</a> ago by the author of the Flops program when he launched the test with the stock binary for Haswell on a computer of the following configuration: <br><br><ul><li>  Ryzen 7 1800X </li><li>  Asus Prime B350M-A (BIOS 0502) </li><li>  4 x 8GB Corsair CMK32GX4M4A2400C14 @ 2133 MHz </li><li>  Windows 10 Anniversary Update </li></ul><br>  Suddenly it was found that the system usually freezes when performing the following operation: <br><br> <code>Single-Precision - 128-bit FMA3 - Fused Multiply Add:</code> <br> <br>  Sometimes the test passes this operation successfully, but still hangs on some other operation in the future. <br><br>  The developer explains that his test is open source, and if you don‚Äôt trust the results, you can take and compile the binary in Visual Studio and recheck the results. <br><br>  Alexander understood how much attention he would attract when reporting an error in the advertised processor.  Therefore, he repeatedly rechecked the results.  The processor hung the system at all clock speeds.  And when working in single-threaded mode, the system hung each core. <br><br>  There remained some probabilities that the cause of the malfunction may still be not in the processor, but in something else.  For example, in a specific motherboard, in a specific BIOS, in a specific operating system ... What else could it be? <br><br>  The developer shared the results with his colleagues so that they could test other versions of Zen on their computers.  Crashes were confirmed for other processors, on different motherboards, under different versions of Windows and under Linux. <br><br>  In the first days after Alex‚Äôs call, five Ryzen processors were launched by tests.  Here are the results: <br><br>  <b>Confirmed failures:</b> <br><ul><li>  1800X + Asus Prime B350M-A (BIOS 0502) </li><li>  1700 + Asus Prime B350M-A (BIOS ???) </li><li>  1700 + Asus Crosshair VI Hero </li><li>  1700 + Asus Crosshair VI Hero (BIOS 5803) (two G.Skill + Kingston memory banks) </li><li>  1800X + Asus Crosshair VI Hero (Windows 7) - once passed the test, many times failed. </li></ul><br>  <b>Confirmed trouble free operation:</b> <br><ul><li>  not yet </li></ul><br>  The benchmark developer checked all FMA variants (128 bits, 256 bits, single precision, double precision of numbers).  In all cases, the computer tightly hung. <br><br>  Only one detail haunted him: although the test was written correctly, for some reason the hangup did not occur in other benchmarks, such as prime95 and y-cruncher, although they also use FMA in testing. <br><br>  So some uncertainty remained. <br><br>  In the end, on March 16, an official <a href="http://forum.hwbot.org/showpost.php%3Fp%3D480524%26postcount%3D25">message</a> was received from a representative of AMD that the bug would be fixed in the new <a href="http://review.coreboot.org/cgit/coreboot.git/tree/src/vendorcode/amd">AGESA</a> (AMD Generic Encapsulated Software Architecture) code - a protocol that is also used to initialize AMD processor cores.  In other words, the company's specialists checked and confirmed the bug.  Later, representatives of AMD <a href="http://www.digitaltrends.com/computing/ryzen-amd-bios-fix-fma3-crash/">officially confirmed the bug in the comments for the media</a> . <br><br>  Fortunately, such a bug can be fixed without replacing the hardware, but simply by updating the microcode.  The bug is minor, so it will not cause processor feedback or any other problems for the company.  In fact, in actual work conditions, hardly anyone can ever encounter this bug, it doesn‚Äôt affect the performance of the computer or the performance of the processor. <br><br>  The bad news is that attackers can use it for DoS attacks.  That is, mainly this error is a problem of information security.  After all, an ordinary user program that works in user mode, and not at the kernel level of the OS, should not hang the system tightly.  But it happens. <br><br>  The fact that the test was run on a binary for a different architecture is not so important.  Any processor must successfully reproduce tests from any binary if it supports the appropriate set of instructions, the author of the benchmark writes.  But even if you run the test using incompatible instructions, the program should not hang the system tightly. <br><br>  The danger of a security vulnerability is exacerbated by the fact that you can run malicious code even from under a virtual machine, it will still suspend the entire system.  A computer with a new Ryzen processor can hang any malware.  Perhaps even through the browser. <br><br>  As already mentioned, AMD is working on updating the AGESA protocol.  After that, patches will be released for all versions of BIOS in all motherboards. </div><p>Source: <a href="https://habr.com/ru/post/402551/">https://habr.com/ru/post/402551/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../402541/index.html">Content Clarifier - an application that aims to improve the quality of life of autists</a></li>
<li><a href="../402543/index.html">Moscow providers' revenues fall after market saturation</a></li>
<li><a href="../402545/index.html">Why are American farmers bypassing DRM tractors with Ukrainian firmware - an analysis of the situation</a></li>
<li><a href="../402547/index.html">Checking passwords from the hacker base iCloud</a></li>
<li><a href="../402549/index.html">Bauman Racing Team - a story with a taste of speed</a></li>
<li><a href="../402553/index.html">Why do blockchain musicians?</a></li>
<li><a href="../402559/index.html">Pile Super Power</a></li>
<li><a href="../402561/index.html">XYZPrinting Polymerization Chamber Overview</a></li>
<li><a href="../402563/index.html">Myofascial relaxation with BlackRoll: universal massage rollers for athletes and not only</a></li>
<li><a href="../402565/index.html">Why programmers suck</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>