<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to find a girl in 250 microseconds</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In contrast to Europe and America, cautious attitude prevails in dating sites. However, the hope of clicking on the magic button and finding love does...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to find a girl in 250 microseconds</h1><div class="post__text post__text-html js-mediator-article">  In contrast to Europe and America, cautious attitude prevails in dating sites.  However, the hope of clicking on the magic button and finding love does not go out in the hearts of many.  And we have to justify this hope.  Of course, we do not promise to immediately find the ideally suitable ‚Äúhalf‚Äù, but it is simply obliged to offer dozens, hundreds or, in some cases, thousands of options that meet your exact requirements.  What we are doing, and very quickly. <br><br>  The average database search of 11 million questionnaires with 4 to 30 parameters each takes us an average of 3.5 milliseconds.  And at the same time, besides the search for the demon servcher of the ‚ÄúMamba‚Äù, it performs the following, including not quite traditional tasks: <br><ul><li>  for each particular questionnaire gives her place in the search (each user, entering her profile, sees the message "You are on the N place in the search") </li><li>  issues a specific profile from the list on the primary key </li><li>  performs a direct search for the questionnaire according to the specified parameters </li></ul><br>  In spite of the fact that our search was developed from the very beginning on its own, from time to time there were thoughts to use something already known, run-in and guaranteed to be effective.  Well, and if we think about searching, Sphinx comes to mind first. <a name="habracut"></a>  At some point we decided to check whether he could give us significant advantages, and were somewhat surprised at the results obtained.  On a test base of 2 million Sphinx questionnaires showed an average result of 100-120 ms in, depending on the request, while we (only because it was a test) included only a part of the fields in the index.  Our search on the same base and on the same equipment spends from 0.2 to 1.1 ms per request. <br><br> <code>Sphinx: source - mysql,   int   sql_attr_uint.    .</code> <br> <br>  As further practice showed, half the success of the search lies in creating the right index.  In our understanding, the correct index is the one that best fits the search tasks and provides the highest processing speed.  After a general analysis of the base, it was decided to divide the index into several parts: <br><ul><li>  questionnaires located in Moscow and the region with photographs (this is the most frequently requested type of questionnaire) </li><li>  VIP users index (VIP users have certain advantages, including in the search results, therefore they are processed separately) </li><li>  full index of all types of questionnaires for all fields of each questionnaire </li></ul><br>  But the main tricks are hidden in the structure of each part of the general index, which are constructed as follows: <br><ul><li>  questionnaires are divided into blocks of 256 profiles in the block </li><li>  each block is put in the index: first the first bit of the first field of each form, then the second bit of each form, etc. Thus, the data of one bit from the field of all the forms go in a row </li></ul><br>  What does this mean for search?  For example, we have an index for the fields ‚Äúgender‚Äù and ‚Äúage‚Äù, where gender can take the values ‚Äã‚Äã‚ÄúM‚Äù and ‚ÄúF‚Äù, and age - from 18 to 21. Imagine that a user wants to find a girl of 20 years old (i.e. conditions satisfy only one value of each field). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Suppose we have such questionnaires (1 block is shown, since the minimum allowable age is 18, then 18 years old is coded as 0000, 19 as 0010, 20 as 0100, and so on) <br><br><img src="https://habrastorage.org/storage2/6a6/66b/718/6a666b718e59d39ea11dd29142d10455.png"><br><br>  After processing, the following index is obtained (the first bit is selected in bold, before and after): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9f2/c6c/605/9f2c6c6055686c7946cfcf8a6f8fc361.png" alt="image"></div><br><br>  For some fields, the value is kept non-compact.  For example, the present age field takes 64 values.  You can store 1 bit for a possible value, that is, the field will take 64 bits, but the search will take only 1 operation, and a search by range - 2 operations.  A more traditional option is to store it as a number, then it will take log2 (64) = 6 bits, but a search for a specific age will take 6 operations, and a search over a range of more than 12 (the exact value depends on the length of the comparison condition recorded as DNF). <br><br>  The search process itself is as follows: <br><ul><li>  daemon accepts and parses request </li><li>  memory is allocated for the results (by bit for each profile in the index) </li><li>  the memory segment is allocated for the compiled request, the execution flag is set </li><li>  this segment is written: <br><ul><li>  initialization code, loop header </li><li>  For each field for which you want to filter the result, a code is written that checks the value of this field. </li><li>  end of the cycle, checking the boundaries, counting the number of found </li></ul></li><li>  this segment is launched through the usual long jump </li></ul><br>  The most interesting is the field verification code.  In the results segment, each questionnaire corresponds to 1 bit, which indicates whether the questionnaire is suitable for the query or not. <br><br>  Processing the request is as follows: <br><br><img src="https://habrastorage.org/storage2/63b/e78/ca6/63be78ca61376d62108ce9a61e755de9.png"><br><br>  After that, it remains only to go through the bitmap with the result and see which forms have 1. <br><br>  In our example, the result will be 00010, that is, only the questionnaire number 4 satisfies the query. <br><br>  The ‚ÄúMamba‚Äù search daemon is invoked from a significant portion of all pages on the site.  I think it is worth noting that, along with several other ‚Äúmain‚Äù demons, it uses the JSON-RPC protocol and generally creates a ‚Äúsingle demonic space‚Äù. <br><br>  The real search statistics is as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3ac/df4/294/3acdf4294a5eb560e862f7c056ed4cd1.png" alt="Requests to search by profile id"><br>  Fig.  1 Requests for search by profile id (schedule from one server) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bdd/399/aca/bdd399aca02644c4a511357c5fea93fc.png" alt="Requests for search by parameters"><br>  Fig.  2 Requests for search by parameters (schedule from one server) <br><br>  In total, the search runs on two machines, the peak performance of one is 20k of searching for profiles using parameters with a full calculation of the number of profiles found per second (this is the longest operation, the others work much faster).  The workload is about 800 rps of search + 1000 rps to get a place + 1500 rps to get personal data. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d74/83e/dcb/d7483edcb543e4e74c0cb9e82b2b27d6.png" alt="Finding the place of the questionnaire in the search results"><br>  Fig.  3 Displaying the place of the questionnaire in the search results (schedule from one server) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7fa/278/b3e/7fa278b3ee19bf6a7203250d0269f689.png" alt="image"><br>  Distribution of the total response time (i.e., taking into account network interaction) from all (two) search servers.  The average is 2.5 ms, the median is 1.5 ms, 5% of requests take more than 10 ms, and 1% of requests take more than 15 ms. </div><p>Source: <a href="https://habr.com/ru/post/144084/">https://habr.com/ru/post/144084/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144077/index.html">Startup Unglue.it frees books from copyright through crowdfunding</a></li>
<li><a href="../144079/index.html">Detailed rules for the Hack2Own contest on PHDays 2012</a></li>
<li><a href="../144080/index.html">How to get rid of perspective distortion. The usefulness of the function Crop Perspective in Adobe Photoshop</a></li>
<li><a href="../144081/index.html">9 floors</a></li>
<li><a href="../144083/index.html">Startup time to market</a></li>
<li><a href="../144085/index.html">The Chinese broke into the mini-computer market</a></li>
<li><a href="../144086/index.html">Transport of St. Petersburg, iOS application</a></li>
<li><a href="../144088/index.html">Facebook Credits are becoming increasingly popular.</a></li>
<li><a href="../144089/index.html">Charisma Phone: Sony Xperia P Review</a></li>
<li><a href="../144090/index.html">PressAbout.us will work with the press for you.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>