<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to work with async / await in JavaScript cycles</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How to run asynchronous loops in order or in parallel in JavaScript? 


 Before doing asynchronous magic, I want to remind you of the classic synchron...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to work with async / await in JavaScript cycles</h1><div class="post__text post__text-html js-mediator-article"><p>  How to run asynchronous loops in order or in parallel in JavaScript? </p><br><p>  Before doing asynchronous magic, I want to remind you of the classic synchronous loops. </p><a name="habracut"></a><br><h2 id="sinhronnye-cikly">  Synchronous loops </h2><br><p>  A long time ago I wrote cycles in this way (maybe you too): </p><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; array.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> item = array[i]; <span class="hljs-comment"><span class="hljs-comment">//  -  item }</span></span></code> </pre> <br><p>  This cycle is good and fast.  But he has a lot of problems with readability and support.  After a while, I got used to his better version: </p><br><pre> <code class="javascript hljs">array.forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  -  item });</span></span></code> </pre> <br><p>  JavaScript language is developing very quickly.  There are new features and syntax.  One of my favorite improvements is <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">async / await</a> . </p><br><p>  Now I use this syntax quite often.  And sometimes there are situations when I need to do something with the elements of the array asynchronously. </p><br><h2 id="asinhronnye-cikly">  Asynchronous loops </h2><br><p>  How to use <code>await</code> in a loop body?  Let's just try to write an asynchronous function and wait for the task of processing each element: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processArray</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">array</span></span></span><span class="hljs-function">) </span></span>{ array.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">//       //     ! await func(item); }) }</span></span></code> </pre> <br><p>  This code will generate an error.  Why?  Because we cannot use <code>await</code> inside a synchronous function.  As you can see, <code>processArray</code> is an asynchronous function.  But the anonymous function that we use for <code>forEach</code> is <strong>synchronous</strong> . </p><br><p>  What can you do about it? </p><br><h3 id="1-ne-dozhidatsya-rezultata-vypolneniya">  1. Do not wait for the execution result </h3><br><p>  We can define an anonymous function as asynchronous: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processArray</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">array</span></span></span><span class="hljs-function">) </span></span>{ array.forEach(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (item) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> func(item); }) <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Done!'</span></span>); }</code> </pre> <br><p>  But <code>forEach</code> will not wait for the task to complete.  <code>forEach</code> is a synchronous operation.  It will simply start the task and go on.  Check on a simple test: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> setTimeout(resolve, <span class="hljs-number"><span class="hljs-number">300</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delayedLog</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    await  Promise //    delay await delay(); console.log(item); } async function processArray(array) { array.forEach(async (item) =&gt; { await delayedLog(item); }) console.log('Done!'); } processArray([1, 2, 3]);</span></span></code> </pre> <br><p>  In the console we will see: </p><br><pre> <code class="plaintext hljs">Done! 1 2 3</code> </pre> <br><p>  In some situations this may be a normal result.  But still, in most variants, this is not the appropriate logic. </p><br><h3 id="2-obrabotka-cikla-posledovatelno">  2. Processing the loop sequentially </h3><br><p>  To wait for the result of the execution of the loop body, we need to return to the good old "for" loop.  But this time we will use its new version with the <code>for..of</code> construction (thanks to <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Iteration_protocols">Iteration Protocol</a> ): </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processArray</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">array</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> array) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> delayedLog(item); } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Done!'</span></span>); }</code> </pre> <br><p>  This will give us the expected result: </p><br><pre> <code class="plaintext hljs">1 2 3 Done!</code> </pre> <br><p>  Each array element will be processed sequentially.  But we can start the cycle in parallel! </p><br><h3 id="3-obrabotka-cikla-parallelno">  3. Cycle processing in parallel </h3><br><p>  You need to slightly change the code to start operations in parallel: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processArray</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">array</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  "map"    const promises = array.map(delayedLog); //       await Promise.all(promises); console.log('Done!'); }</span></span></code> </pre> <br><p>  This code can run several <code>delayLog</code> tasks in parallel.  But be careful with large arrays.  Too many tasks may be too hard for the CPU and memory. </p><br><p>  Also, please do not confuse the "parallel tasks" from the example with real parallelism and threads.  This code does not guarantee parallel execution.  Everything depends on the loop body (in the example, this is <code>delayedLog</code> ).  Network requests, webworkers and some other tasks can be executed in parallel. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/435084/">https://habr.com/ru/post/435084/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435074/index.html">Vulnerabilities of Kyivstar: 1) analysis of the previous post about passwords + 2) info about purchases passing through the services of Kyivstar</a></li>
<li><a href="../435076/index.html">How marketers working with Google monetize our discomfort</a></li>
<li><a href="../435078/index.html">What if artificial intelligence makes actors immortal?</a></li>
<li><a href="../435080/index.html">Guide: Thymeleaf + Spring. Part 2</a></li>
<li><a href="../435082/index.html">Silicon Valley Yoda</a></li>
<li><a href="../435086/index.html">What does it cost us to build a PCI-E riser</a></li>
<li><a href="../435088/index.html">Chinese streaming giant Tencent Music came out for an IPO - what it means and what to expect competitors</a></li>
<li><a href="../435090/index.html">Hyundai motor group introduced the concept of wireless charging and autonomous parking</a></li>
<li><a href="../435094/index.html">Gamepad from Sega Mega Drive and Raspberry Pi Part 2 (the final six-button)</a></li>
<li><a href="../435096/index.html">The effect of warm tube radio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>