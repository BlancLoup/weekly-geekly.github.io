<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to get a neighbor or Karaoke on GStreamer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue to master the GStreamer framework. As promised, today we will consider in more detail the work with the bus and the processing of messages...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to get a neighbor or Karaoke on GStreamer</h1><div class="post__text post__text-html js-mediator-article">  We continue to master the GStreamer framework.  As promised, today we will consider in more detail the work with the bus and the processing of messages of various types.  And in the practical section, we will write a small console karaoke.  So, let's begin. <br><br><img src="https://habrastorage.org/files/874/24f/b39/87424fb396f94d8c830be11f53167ad6.png" alt="image"><br><a name="habracut"></a><br><h4>  Tire </h4><br>  Let me remind you that the application on GStreamer consists of various elements placed in a conveyor and interconnected.  Each element in the course of its work can generate messages of different types (described below).  A bus is used to collect these messages and deliver them in turn to the main application flow. <br><br>  Each pipeline has a built-in bus by default, i.e.  it does not need to be created or customized.  The tire is removed from the conveyor by the following function: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">GstBus * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gst_pipeline_get_bus</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GstPipeline *pipeline)</span></span></span></span></code> </pre> <br>  There are two ways to process messages on the bus - asynchronous and synchronous.  The first way is that a handler is connected to the bus, which after receiving a message performs some actions.  This is done using functions: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">guint </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gst_bus_add_watch</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GstBus *bus, GstBusFunc func, gpointer user_data)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gst_bus_add_signal_watch</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GstBus *bus)</span></span></span></span></code> </pre><br>  It is worth noting that both of these functions have advanced options (* _full), with the help of which a more fine-tuning of the handler is possible. <br>  The second way is to constantly poll the bus for messages.  This is done using the function: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">GstMessage *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gst_bus_poll</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GstBus *bus, GstMessageType events, GstClockTime timeout)</span></span></span></span></code> </pre><br>  At the same time, it is possible to take only certain types of messages from the queue, as well as to adjust the duration of the poll. <br><br><h4>  Messages </h4><br>  Each message is characterized by its source, type, and time stamp.  Most often, there is no need to respond to each type of message, but it is highly desirable to handle at least error messages.  There are a lot of types, here are the most common: <br><br><ul><li>  Errors, warnings and informational messages </li><li>  End of Stream messages </li><li>  Tags </li><li>  State changes </li></ul><br>  You can approach the issue of processing messages on the other hand, namely, to connect only to the signals of interest to us in the following form: <br><br><pre> <code class="cpp hljs">g_signal_connect (bus, <span class="hljs-string"><span class="hljs-string">"message::error"</span></span>, G_CALLBACK (cb_message_error), <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)</code> </pre><br>  <b>Important!</b>  If you want the handler to continue to respond to messages, it must return TRUE.  If, however, to register the return FALSE, then after processing the tracking of messages by this handler will stop. <br><br><h4>  Practice </h4><br>  Now let's write an application that plays an mp3 file and suppresses a certain frequency range (which includes the vocal range) in it using the audiokaraoke element.  In this case, we get the track without vocals.  Also the text of the song from the file (in UTF-8 encoding) is output to the console. <br><br>  The conveyor will look like this: <br><br><img src="https://habrastorage.org/files/c39/51f/360/c3951f360a464cd3926332b7777780c8.png" alt="image"><br><br>  Make sure you have the Ugly plug-in set (gst-plugins-ugly) installed, since it includes Mad mp3 decoder. <br><br>  And here is the program itself: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;gst/gst.h&gt; #define SUPRESS_LEVEL 1.0 //  0.0  1.0 #define MONO_LEVEL 1.0 //  0.0  1.0 #define FILTER_BAND 220.0 //  0.0  441.0 #define FILTER_WIDTH 100.0 //  0.0  100.0 static GMainLoop *loop; static gboolean my_bus_callback (GstBus *bus, GstMessage *message, gpointer data) { switch (GST_MESSAGE_TYPE (message)) { case GST_MESSAGE_ERROR: { GError *err; gchar *debug; gst_message_parse_error (message, &amp;err, &amp;debug); g_print ("Error: %s\n", err-&gt;message); g_error_free (err); g_free (debug); g_main_loop_quit (loop); break; } case GST_MESSAGE_EOS: { g_print ("\n\nYou've got 100 points!\n"); g_main_loop_quit (loop); break; } default: break; } /*  TRUE,   ,       */ return TRUE; } int main (int argc, char * argv[]) { if (argc != 3) { g_printerr("Usage: %s audiofile.mp3 lyricsfile.txt\n", argv[0]); return -1; } GstElement *pipeline, *audiosrc, *parser, *decoder, *converter, *karaoke, *audiosink; GstElement *textsrc, *textsink; GstStateChangeReturn ret; GstBus *bus; guint bus_watch_id; /*  */ gst_init(NULL, NULL); /*   */ pipeline = gst_element_factory_make ("pipeline", "pipe"); audiosrc = gst_element_factory_make ("filesrc", "audiosrc"); parser = gst_element_factory_make ("mpegaudioparse", "parser"); decoder = gst_element_factory_make ("mad", "decoder"); converter = gst_element_factory_make ("audioconvert", "converter"); karaoke = gst_element_factory_make ("audiokaraoke", "karaoke"); audiosink = gst_element_factory_make ("autoaudiosink", "audiosink"); textsrc = gst_element_factory_make ("filesrc", "textsrc"); textsink = gst_element_factory_make ("fdsink", "textsink"); if (!pipeline || !audiosrc || !parser || !decoder || !converter || !karaoke || !audiosink || !textsrc || !textsink) { g_printerr ("Unable to create some elements\n"); return -1; } /*     */ gst_bin_add_many (GST_BIN(pipeline), audiosrc, parser, decoder, converter, karaoke, audiosink, textsrc, textsink, NULL); /*    */ if (gst_element_link_many (audiosrc, parser, decoder, converter, karaoke, audiosink, NULL) != TRUE) { g_printerr ("Unable to link some elements\n"); gst_object_unref(pipeline); return -1; } if (gst_element_link (textsrc, textsink) != TRUE) { g_printerr ("Unable to link text with textsink\n"); gst_object_unref(pipeline); return -1; } /*    */ g_object_set (audiosrc, "location", argv[1], NULL); g_object_set (textsrc, "location", argv[2], NULL); g_object_set (karaoke, "level", SUPRESS_LEVEL, "mono-level", MONO_LEVEL, "filter-band", FILTER_BAND, "filter-width", FILTER_WIDTH, NULL); /*   */ ret = gst_element_set_state (pipeline, GST_STATE_PLAYING); if ( ret == GST_STATE_CHANGE_FAILURE ) { g_printerr ("Unable to set pipeline to the playing state\n"); gst_object_unref (pipeline); return -1; } /*          */ bus = gst_element_get_bus (pipeline); bus_watch_id = gst_bus_add_watch (bus, my_bus_callback, NULL); gst_object_unref (bus); /*     */ loop = g_main_loop_new (NULL, FALSE); g_main_loop_run (loop); /*   */ gst_element_set_state (pipeline, GST_STATE_NULL); gst_object_unref (pipeline); g_source_remove (bus_watch_id); g_main_loop_unref (loop); return 0; }</span></span></span></span></code> </pre><br>  We compile as usual <br><pre> <code class="bash hljs">$ gcc -Wall -o karaoke karaoke.c $(pkg-config --libs --cflags gstreamer-1.0)</code> </pre><br>  and run <br><pre> <code class="bash hljs">$ ./karaoke audiofile.mp3 lyricsfile.txt</code> </pre><br><h4>  results </h4><br>  I tried to run the application (with the default filter settings) on the following songs: <br><table><tbody><tr><th>  Song </th><th>  Effect </th></tr><tr><td>  Tool - Parabola </td><td>  Not bad cut vocals, but suppressed a lot of instrumental (especially the flageoles in solo) </td></tr><tr><td>  At the Drive-In - Rolodex Propaganda </td><td>  The instrumental is well preserved, but the vocals are quite strong (apparently, due to its height) </td></tr><tr><td>  Radiohead - Jigsaw Falling into Place </td><td>  It turned out pretty interesting here - the main vocal was crushed, and the backing remained </td></tr><tr><td>  U2 - Raised by Wolves </td><td>  The guitar is kept almost perfect. </td></tr></tbody></table><br>  It is clear that the result strongly depends on the settings of the filter and on the song itself, so you can play with its parameters specified via #define and see what happens. </div><p>Source: <a href="https://habr.com/ru/post/254417/">https://habr.com/ru/post/254417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254403/index.html">SaltStack: Pre-generation of passwords for use in services</a></li>
<li><a href="../254407/index.html">White paper on the availability of PhoneGap</a></li>
<li><a href="../254409/index.html">Payler 2.0 - work on the creation of a new site</a></li>
<li><a href="../254413/index.html">Grid, Data Grouping and OData</a></li>
<li><a href="../254415/index.html">Become the master of loading Linux</a></li>
<li><a href="../254419/index.html">Assembler for simulation tasks. Part 1: guest assembler</a></li>
<li><a href="../254423/index.html">How to create and earn SaaS | Part 17 | Personal data and medical secrets in the cloud</a></li>
<li><a href="../254425/index.html">JSONB requests in PostgreSQL</a></li>
<li><a href="../254429/index.html">Driver packs and their indices</a></li>
<li><a href="../254431/index.html">Quite simple about minimal perfect graph-based hashing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>