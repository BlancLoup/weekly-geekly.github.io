<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Storing php sessions in Redis with locks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The standard mechanism for storing user session data in php is storage in files. However, when an application is running on multiple servers for load ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Storing php sessions in Redis with locks</h1><div class="post__text post__text-html js-mediator-article">  The standard mechanism for storing user session data in php is storage in files.  However, when an application is running on multiple servers for load balancing, there is a need to store session data in a storage accessible by each application server.  In this case, <i>Redis</i> is well suited for storing sessions. <br><br>  The most popular solution is the <a href="https://github.com/phpredis/phpredis">phpredis</a> extension.  It is enough to install the extension and configure php.ini and the sessions will be automatically saved in Redis without changing the application code. <br><br>  However, this solution has the disadvantage of not blocking the session. <br><a name="habracut"></a><br>  When using the standard session storage mechanism in files, an open session locks the file until it is closed.  With several simultaneous access to the session, new requests will wait until the previous one closes the session.  However, when using phpredis, there is no such blocking mechanism.  With multiple asynchronous requests, a race occurs at the same time, and some data recorded in the session may be lost. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is easy to check.  We send asynchronously 100 requests to the server, each of which writes its own parameter to the session, then we count the number of parameters in the session. <br><br><div class="spoiler">  <b class="spoiler_title">Test script</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> session_start(); $cmd = $_GET[<span class="hljs-string"><span class="hljs-string">'cmd'</span></span>] ?? ($_POST[<span class="hljs-string"><span class="hljs-string">'cmd'</span></span>] ?? <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ($cmd) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'result'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span>(count($_SESSION)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"set"</span></span>: $_SESSION[<span class="hljs-string"><span class="hljs-string">'param_'</span></span> . $_POST[<span class="hljs-string"><span class="hljs-string">'name'</span></span>]] = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: $_SESSION = []; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;script src="https://code.jquery.com/jquery-1.11.3.js"&gt;&lt;/script&gt; &lt;script&gt; $(document).ready(function() { for(var i = 0; i &lt; 100; i++) { $.ajax({ type: "post", url: "?", dataType: "json", data: { name: i, cmd: "set" } }); } res = function() { window.location = "?cmd=result"; } setTimeout(res, 10000); }); &lt;/script&gt; '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; }</code> </pre> <br></div></div><br>  As a result, we get that in the session there are not 100 parameters, but 60-80.  The rest of the data we lost. <br>  Of course, there will not be 100 simultaneous requests in real-world applications, but practice shows that even with two asynchronous simultaneous requests, the data written by one of the requests is quite often erased by the other.  Thus, using the phpredis extension to store sessions is unsafe and can lead to data loss. <br><br>  As one of the solutions to the problem - your <b>SessionHandler</b> , which supports locks. <br><br><h3>  Implementation </h3><br>  To set the session lock, set the lock key value to a randomly generated (based on uniqid) value.  The value must be unique so that any parallel query cannot access. <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lockSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sessionId)</span></span></span><span class="hljs-function"> </span></span>{ $attempts = (<span class="hljs-number"><span class="hljs-number">1000000</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lockMaxWait) / <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;spinLockWait; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;token = uniqid(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lockKey = $sessionId . <span class="hljs-string"><span class="hljs-string">'.lock'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $attempts; ++$i) { $success = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;redis-&gt;set( <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRedisKey(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lockKey), <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;token, [ <span class="hljs-string"><span class="hljs-string">'NX'</span></span>, ] ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($success) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;locked = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } usleep(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;spinLockWait); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br>  The value is set with the <i>NX</i> flag, that is, installation occurs only if there is no such key.  If such a key exists, make another attempt after some time. <br><br>  You can also use a limited key lifetime in radish, however, the script runtime can be changed after the key is installed, and the parallel process can access the session before it is finished working with it in the current script.  When the script is completed, the key is deleted in any case. <br><br>  When unlocking a session when the script is finished, use the <i>Lua</i> script to delete the key: <br><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unlockSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $script = &lt;&lt;&lt;LUA <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> redis.call(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, KEYS[<span class="hljs-number"><span class="hljs-number">1</span></span>]) == ARGV[<span class="hljs-number"><span class="hljs-number">1</span></span>] then <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redis.call(<span class="hljs-string"><span class="hljs-string">"DEL"</span></span>, KEYS[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> end LUA; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;redis-&gt;eval($script, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRedisKey(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lockKey), <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;token), <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;locked = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;token = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre> <br>  You cannot use the <i>DEL</i> command, because with it you can delete a key set by another script.  Such a script guarantees deletion only if the lock key corresponds to a unique value set by the current script. <br><br><div class="spoiler">  <b class="spoiler_title">Full class code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RedisSessionHandler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SessionHandlerInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $redis; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $ttl; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $prefix; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $locked; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $lockKey; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $token; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $spinLockWait; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $lockMaxWait; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\Redis $redis, $prefix = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'PHPREDIS_SESSION:'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $spinLockWait = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">200000</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;redis = $redis; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ttl = ini_get(<span class="hljs-string"><span class="hljs-string">'gc_maxlifetime'</span></span>); $iniMaxExecutionTime = ini_get(<span class="hljs-string"><span class="hljs-string">'max_execution_time'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lockMaxWait = $iniMaxExecutionTime ? $iniMaxExecutionTime * <span class="hljs-number"><span class="hljs-number">0.7</span></span> : <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;prefix = $prefix; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;locked = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lockKey = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;spinLockWait = $spinLockWait; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">open</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($savePath, $sessionName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lockSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sessionId)</span></span></span><span class="hljs-function"> </span></span>{ $attempts = (<span class="hljs-number"><span class="hljs-number">1000000</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lockMaxWait) / <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;spinLockWait; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;token = uniqid(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lockKey = $sessionId . <span class="hljs-string"><span class="hljs-string">'.lock'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $attempts; ++$i) { $success = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;redis-&gt;set( <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRedisKey(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lockKey), <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;token, [ <span class="hljs-string"><span class="hljs-string">'NX'</span></span>, ] ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($success) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;locked = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } usleep(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;spinLockWait); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unlockSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $script = &lt;&lt;&lt;LUA <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> redis.call(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, KEYS[<span class="hljs-number"><span class="hljs-number">1</span></span>]) == ARGV[<span class="hljs-number"><span class="hljs-number">1</span></span>] then <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redis.call(<span class="hljs-string"><span class="hljs-string">"DEL"</span></span>, KEYS[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> end LUA; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;redis-&gt;eval($script, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRedisKey(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lockKey), <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;token), <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;locked = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;token = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;locked) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;unlockSession(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sessionId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;locked) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lockSession($sessionId)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;redis-&gt;get(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRedisKey($sessionId)) ?: <span class="hljs-string"><span class="hljs-string">''</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sessionId, $data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ttl &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;redis-&gt;setex(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRedisKey($sessionId), <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ttl, $data); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;redis-&gt;set(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRedisKey($sessionId), $data); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">destroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($sessionId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;redis-&gt;del(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRedisKey($sessionId)); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;close(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($lifetime)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setTtl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($ttl)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ttl = $ttl; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLockMaxWait</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lockMaxWait; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setLockMaxWait</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($lockMaxWait)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lockMaxWait = $lockMaxWait; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRedisKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($key)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;prefix)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $key; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;prefix . $key; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__destruct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;close(); } }</code> </pre> <br></div></div><br><h3>  Connection </h3><br><pre> <code class="php hljs">$redis = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Redis(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($redis-&gt;connect(<span class="hljs-string"><span class="hljs-string">'11.111.111.11'</span></span>, <span class="hljs-number"><span class="hljs-number">6379</span></span>) &amp;&amp; $redis-&gt;select(<span class="hljs-number"><span class="hljs-number">0</span></span>)) { $handler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \suffi\RedisSessionHandler\RedisSessionHandler($redis); session_set_save_handler($handler); } session_start();</code> </pre> <br><h4>  Result </h4><br>  After connecting our <i>SessionHandler,</i> our test script confidently displays 100 parameters per session.  At the same time, despite the blocking, the total processing time for 100 requests grew slightly.  In actual practice, such a number of simultaneous requests will not be.  However, the running time of the script is usually more significant, and with simultaneous requests there can be a noticeable wait.  Therefore, you need to think about reducing the time to work with the script session (call <i>session_start ()</i> only if you need to work with the session and <i>session_write_close ()</i> when you finish working with it) <br><br><h4>  Links </h4><br>  ¬ª <a href="https://github.com/dmitry-suffi/redis-session-handler">Link to the githaba repository</a> <br>  ¬ª <a href="https://redis.io/topics/distlock">Redis Blocking Page</a> </div><p>Source: <a href="https://habr.com/ru/post/318836/">https://habr.com/ru/post/318836/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318822/index.html">Twitter use non-standard</a></li>
<li><a href="../318824/index.html">"Breaking Bad" or the harsh realities of the indie development of Dark Forester</a></li>
<li><a href="../318826/index.html">Technical support in the era of DevOps</a></li>
<li><a href="../318832/index.html">Recognition of radio signals using neural networks</a></li>
<li><a href="../318834/index.html">Introduction to Modbus</a></li>
<li><a href="../318840/index.html">Continuous cross compilation for Raspberry PI</a></li>
<li><a href="../318842/index.html">‚ÄúI get torn when I can't write code‚Äù - an interview with Maxim Shafirov, CEO of JetBrains</a></li>
<li><a href="../318846/index.html">Installing OpenCV in Windows for Dummies and connecting the library to Code Blocks</a></li>
<li><a href="../318848/index.html">Coding with the withdrawal of information. Part 1, philosophical</a></li>
<li><a href="../318850/index.html">33C3 CTF We exploit LaTeX vulnerability in the pdfmaker task</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>