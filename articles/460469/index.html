<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The basics of transparent proxying using 3proxy and iptables / netfilter or how to ‚Äúlet everything through a proxy‚Äù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I would like to disclose the possibilities of transparent proxying, which allows you to completely redirect all or part of traffic th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The basics of transparent proxying using 3proxy and iptables / netfilter or how to ‚Äúlet everything through a proxy‚Äù</h1><div class="post__text post__text-html js-mediator-article">  In this article, I would like to disclose the possibilities of transparent proxying, which allows you to completely redirect all or part of traffic through external proxy servers unnoticed by clients. <br><br>  When I started to solve this problem, I ran into the fact that its implementation has one significant problem - the HTTPS protocol.  In the good old days, there were no special problems with HTTP transparent proxying, but when HTTPS is proxied, browsers report interfering with the protocol, and that‚Äôs the end of it. <br><br>  In common instructions to the Squid proxy server, they even offer to generate a self-signed certificate and install it to clients, which is <s>completely unreasonable nonsense</s> and looks like a MITM attack.  I know that Squid already knows how to do something like this, but this article is about a proven and working method using 3proxy from the respected 3APA3A. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, we will look at the process of building 3proxy from source, its configuration, full and selective proxying using NAT, distributing a channel to several external proxy servers, as well as using a router and static routes.  We use Debian 9 x64 as the OS.  Getting started! <br><a name="habracut"></a><br><h3>  Installing 3proxy and running a regular proxy server </h3><br>  1. Install ifconfig (from the net-tools package) <br> <code>apt-get install net-tools</code> <br>  2. Install Midnigth Commander <br> <code>apt-get install mc</code> <br>  3. We now have 2 interfaces: <br>  enp0s3 - external, looks in the Internet <br>  enp0s8 - internal, must look into the local network <br>  In other Debian-based distributions, interfaces are commonly referred to as eth0 and eth1. <br> <code>ifconfig -a</code> <br> <br><div class="spoiler">  <b class="spoiler_title">Interfaces</b> <div class="spoiler_text">  enp0s3: flags = 4163 &lt;UP, BROADCAST, RUNNING, MULTICAST&gt; mtu 1500 <br>  inet 192.168.23.11 netmask 255.255.255.0 broadcast 192.168.23.255 <br>  inet6 fe80 :: a00: 27ff: fec2: bae4 prefixlen 64 scopeid 0x20 ether 08: 00: 27: c2: ba: e4 txqueuelen 1000 (Ethernet) <br>  RX packets 6412 bytes 8676619 (8.2 MiB) <br>  RX errors 0 dropped 0 overruns 0 frame 0 <br>  TX packets 1726 bytes 289128 (282.3 KiB) <br>  TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 <br><br>  enp0s8: flags = 4098 &lt;BROADCAST, MULTICAST&gt; mtu 1500 <br>  ether 08: 00: 27: 79: a7: e3 txqueuelen 1000 (ethernet) <br>  RX packets 0 bytes 0 (0.0 B) <br>  RX errors 0 dropped 0 overruns 0 frame 0 <br>  TX packets 0 bytes 0 (0.0 B) <br>  TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 <br><br>  lo: flags = 73 &lt;UP, LOOPBACK, RUNNING&gt; mtu 65536 <br>  inet 127.0.0.1 netmask 255.0.0.0 <br>  inet6 :: 1 prefixlen 128 scopeid 0x10 loop txqueuelen 1 (Local Loopback) <br>  RX packets 0 bytes 0 (0.0 B) <br>  RX errors 0 dropped 0 overruns 0 frame 0 <br>  TX packets 0 bytes 0 (0.0 B) <br>  TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 <br><br>  The enp0s8 interface is not currently used, we will enable it when we want to use the Proxy NAT or NAT configuration.  It is then logical to assign him a static ip. <br><br>  4. Proceed to install 3proxy <br><br>  4.1 Installing the base packages for compiling 3proxy from source <br><br> <code>root@debian9:~# apt-get install build-essential libevent-dev libssl-dev -y</code> <br> <br>  4.2.  Create a folder for downloading the archive with source codes. <br><br> <code>root@debian9:~# mkdir -p /opt/proxy</code> <br> <br>  4.3.  Go to this folder <br><br> <code>root@debian9:~# cd /opt/proxy <br></code> <br><br>  4.4.  Now download the latest 3proxy package.  At the time of this writing, the latest stable version was 0.8.12 (04/18/2018). We download it from the official 3proxy website. <br><br> <code>root@debian9:/opt/proxy# wget https://github.com/z3APA3A/3proxy/archive/0.8.12.tar.gz <br></code> <br><br>  4.5.  Unpack the downloaded archive <br><br> <code>root@debian9:/opt/proxy# tar zxvf 0.8.12.tar.gz</code> <br> <br>  4.6.  Go to the unpacked directory to build the program. <br><br> <code>root@debian9:/opt/proxy# cd 3proxy-0.8.12</code> <br> <br>  4.7.  Next, you need to add a line to the header file so that our server is completely anonymous (it really works, everything is checked, ip clients are hidden) <br><br> <code>root@debian9:/opt/proxy/3proxy-0.8.12# nano +29 src/proxy.h</code> <br> <br>  Add a string <br><br> <code>#define ANONYMOUS 1 <br></code> <br>  Press Ctrl + x and Enter to save the changes. <br><br>  4.8.  Let's start building the program <br><br> <code>root@debian9:/opt/proxy/3proxy-0.8.12# make -f Makefile.Linux</code> <br> <br><div class="spoiler">  <b class="spoiler_title">Makelog</b> <div class="spoiler_text">  make [2]: Leaving directory '/opt/proxy/3proxy-0.8.12/src/plugins/TransparentPlugin' <br>  make [1]: Leaving directory '/opt/proxy/3proxy-0.8.12/src' <br></div></div><br>  No errors, we continue. <br><br>  4.9.  Install the program in the system <br><br> <code>root@debian9:/opt/proxy/3proxy-0.8.12# make -f Makefile.Linux install</code> <br> <br>  4.10.  Go to the root directory and check where the program is installed. <br><br> <code>root@debian9:/opt/proxy/3proxy-0.8.12# cd ~/ <br> root@debian9:~# whereis 3proxy</code> <br>  3proxy: / usr / local / bin / 3proxy / usr / local / etc / 3proxy <br><br>  4.11.  Create a folder for configuration files and logs in the user's home directory. <br><br> <code>root@debian9:~# mkdir -p /home/joke/proxy/logs</code> <br> <br>  4.12.  Go to the directory where the config should be <br><br> <code>root@debian9:~# cd /home/joke/proxy/</code> <br> <br>  4.13.  Create an empty file and copy the config there. <br><br> <code>root@debian9:/home/joke/proxy# cat &gt; 3proxy.conf</code> <br> <br><div class="spoiler">  <b class="spoiler_title">3proxy.conf</b> <div class="spoiler_text">  daemon <br>  pidfile /home/joke/proxy/3proxy.pid <br>  nserver 8.8.8.8 <br>  nscache 65536 <br>  users tester: CL: 1234 <br>  timeouts 1 5 30 60 180 1800 16 60 <br>  log /home/joke/proxy/logs/3proxy.log D <br>  logformat "- + _L% t.%.% N.% p% E% U% C:% c% R:% r% O% I% h% T" <br>  rotate 3 <br>  auth strong <br>  flush <br>  allow tester <br>  socks -p3128 <br>  proxy -p8080 <br></div></div><br>  To save, press Ctrl + Z <br><br>  4.14.  Create a pid - file so that there are no errors at startup. <br><br> <code>root@debian9:/home/joke/proxy# cat &gt; 3proxy.pid</code> <br> <br>  To save, press Ctrl + Z <br><br>  4.15.  We start a proxy server! <br><br> <code>root@debian9:/home/joke/proxy# 3proxy /home/joke/proxy/3proxy.conf</code> <br> <br>  4.16.  Let's see if the server is listening to ports. <br><br> <code>root@debian9:~/home/joke/proxy# netstat -nlp</code> <br> <br><div class="spoiler">  <b class="spoiler_title">netstat log</b> <div class="spoiler_text">  Active Internet connections (only servers) <br>  Proto Recd-Q Send-Q Local Program PID / Program Name <br>  tcp 0 0 0.0.0.0:8080 0.0.0.0:* LISTEN 504 / 3proxy <br>  tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 338 / sshd <br>  tcp 0 0 0.0.0.0ŸÑ128 0.0.0.0:* LISTEN 504 / 3proxy <br>  tcp6 0 0 ::: 22 ::: * LISTEN 338 / sshd <br>  udp 0 0 0.0.0.0:68 0.0.0.0:* 352 / dhclient <br></div></div><br>  As it was written in the config, the web proxy listens to our port 8080, Socks5 proxy - 3128. <br><br>  4.17.  To automate the proxy service after reboot, you need to add it to cron. <br><br> <code>root@debian9:/home/joke/proxy# crontab -e</code> <br> <br>  Add a string <br><br> <code>@reboot /usr/local/bin/3proxy /home/joke/proxy/3proxy.conf</code> <br> <br>  Press Enter, because cron should see the end of line symbol and save the file. <br><br>  There should be a message about installing a new crontab. <br><br>  crontab: installing new crontab <br><br>  4.18.  Reboot the system and try to connect to the proxy via a browser.  For verification, we use the Firefox browser (for web proxies) and the FoxyProxy add-on for socks5 with authentication. <br><br> <code>root@debian9:/home/joke/proxy# reboot</code> <br> <br>  4.19.  Checking the work of the proxy after the reboot, you can see the logs.  This completes the proxy server configuration. <br><br><div class="spoiler">  <b class="spoiler_title">3 proxy log</b> <div class="spoiler_text">  1542573996.018 PROXY.8080 00000 tester 192.168.23.10:50915 217.12.15.54:443 1193 6939 0 CONNECT_ads.yahoo.com:443_HTTP/1.1 <br>  1542574289.634 SOCK5.3128 00000 tester 192.168.23.10 1193 54.192.13.69:443 0 0 0 CONNECT_normandy.cdn.mozilla.net:443 <br></div></div><br><h3>  Configure and run the Transparent Proxy NAT configuration </h3><br>  In this configuration, all devices on the internal network will work transparently on the Internet through a remote proxy server.  Absolutely all tcp connections will be redirected to one or several (really expands the channel width, configuration example number 2!) Proxy servers.  DNS will use 3proxy features (dnspr).  UDP will not "go" outside, since we do not use the forward mechanism yet (it is disabled by default in the Linux kernel). <br><br>  1. It‚Äôs time to enable the interface enp0s8 <br><br> <code>root@debian9:~# nano /etc/network/interfaces</code> <br> <br><div class="spoiler">  <b class="spoiler_title">/ etc / network / interfaces file</b> <div class="spoiler_text">  # This file is the network interfaces available on your system <br>  # and how to activate them.  For more information, see interfaces (5). <br><br>  source /etc/network/interfaces.d/* <br><br>  # The loopback network interface <br>  auto lo <br>  iface lo inet loopback <br><br>  # The primary network interface <br>  allow-hotplug enp0s3 <br>  iface enp0s3 inet dhcp <br><br>  # The secondary network interface <br>  allow-hotplug enp0s8 <br>  iface enp0s8 inet static <br>  address 192.168.201.254 <br>  netmask 255.255.255.0 <br></div></div><br>  Here we assigned the interface enp0s8 a static address 192.168.201.254 and a mask 255.255.255.0 <br>  Save the config Ctrl + X and reboot <br><br> <code>root@debian9:~# reboot</code> <br> <br>  2. Check the interfaces <br><br> <code>root@debian9:~# ifconfig</code> <br> <br><div class="spoiler">  <b class="spoiler_title">ifconfig log</b> <div class="spoiler_text">  enp0s3: flags = 4163 &lt;UP, BROADCAST, RUNNING, MULTICAST&gt; mtu 1500 <br>  inet 192.168.23.11 netmask 255.255.255.0 broadcast 192.168.23.255 <br>  inet6 fe80 :: a00: 27ff: fec2: bae4 prefixlen 64 scopeid 0x20 ether 08: 00: 27: c2: ba: e4 txqueuelen 1000 (Ethernet) <br>  RX packets 61 bytes 7873 (7.6 KiB) <br>  RX errors 0 dropped 0 overruns 0 frame 0 <br>  TX packets 65 bytes 10917 (10.6 KiB) <br>  TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 <br><br>  enp0s8: flags = 4163 &lt;UP, BROADCAST, RUNNING, MULTICAST&gt; mtu 1500 <br>  inet 192.168.201.254 netmask 255.255.255.0 broadcast 192.168.201.255 <br>  inet6 fe80 :: a00: 27ff: fe79: a7e3 prefixlen 64 scopeid 0x20 ether 08: 00: 27: 79: a7: e3 txqueuelen 1000 (Ethernet) <br>  RX packets 0 bytes 0 (0.0 B) <br>  RX errors 0 dropped 0 overruns 0 frame 0 <br>  TX packets 8 bytes 648 (648.0 B) <br>  TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 <br><br>  lo: flags = 73 &lt;UP, LOOPBACK, RUNNING&gt; mtu 65536 <br>  inet 127.0.0.1 netmask 255.0.0.0 <br>  inet6 :: 1 prefixlen 128 scopeid 0x10 loop txqueuelen 1 (Local Loopback) <br>  RX packets 0 bytes 0 (0.0 B) <br>  RX errors 0 dropped 0 overruns 0 frame 0 <br>  TX packets 0 bytes 0 (0.0 B) <br>  TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 <br><br>  3. Everything turned out, now you need to configure 3proxy for transparent proxying. <br><br> <code>root@debian9:~# cd /home/joke/proxy/ <br> root@debian9:/home/joke/proxy# cat &gt; 3proxytransp.conf</code> <br> <br><div class="spoiler">  <b class="spoiler_title">Configuration example of transparent proxy server ‚Ññ1</b> <div class="spoiler_text">  daemon <br>  pidfile /home/joke/proxy/3proxy.pid <br>  nserver 8.8.8.8 <br>  nscache 65536 <br>  timeouts 1 5 30 60 180 1800 16 60 <br>  log /home/joke/proxy/logs/3proxy.log D <br>  logformat "- + _L% t.%.% N.% p% E% U% C:% c% R:% r% O% I% h% T" <br>  rotate 3 <br>  flush <br>  auth iponly <br>  dnspr <br>  allow * <br>  parent 1000 socks5 IP_ADDRESS_HEAD_PROXY 3128 tester 1234 <br>  plugin /opt/proxy/3proxy-0.8.12/src/TransparentPlugin.ld.so transparent_plugin <br>  tcppm -i0.0.0.0 888 127.0.0.1 11111 <br></div></div><br>  4. Now we start 3proxy with a new config <br> <code>root@debian9:/home/joke/proxy# /usr/local/bin/3proxy /home/joke/proxy/3proxytransp.conf</code> <br> <br>  5. Add crontab again <br> <code>root@debian9:/home/joke/proxy# crontab -e <br> @reboot /usr/local/bin/3proxy /home/joke/proxy/3proxytransp.conf</code> <br> <br>  6. Let's see what our proxy is listening to now. <br> <code>root@debian9:~# netstat -nlp <br></code> <br><br><div class="spoiler">  <b class="spoiler_title">netstat log</b> <div class="spoiler_text">  Active Internet connections (only servers) <br>  Proto Recd-Q Send-Q Local Program PID / Program Name <br>  tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 349 / sshd <br>  tcp 0 0 0.0.0.0:888 0.0.0.0:* LISTEN 354 / 3proxy <br>  tcp6 0 0 ::: 22 ::: * LISTEN 349 / sshd <br>  udp 0 0 0.0.0.0:53 0.0.0.0:* 354 / 3proxy <br>  udp 0 0 0.0.0.0:68 0.0.0.0:* 367 / dhclient <br></div></div><br>  7. Now the proxy is ready to accept any TCP connections on port 888, DNS on port 53, in order to redirect them to remote socks5 - proxy and DNS Google 8.8.8.8.  It remains for us to configure the rules of netfilter (iptables) and DHCP to issue addresses. <br><br>  8. Install the iptables-persistent and dhcpd package <br><br> <code>root@debian9:~# apt-get install iptables-persistent isc-dhcp-server</code> <br> <br>  9. Rule the startup file dhcpd <br> <code>root@debian9:~# nano /etc/dhcp/dhcpd.conf</code> <br> <br><div class="spoiler">  <b class="spoiler_title">dhcpd.conf</b> <div class="spoiler_text">  # dhcpd.conf <br>  # <br>  # Sample configuration file for ISC dhcpd <br>  # <br><br>  # option definitions common to all supported networks ... <br>  option domain-name "example.org"; <br>  option domain-name-servers ns1.example.org, ns2.example.org; <br><br>  default-lease-time 600; <br>  max-lease-time 7200; <br><br>  ddns-update-style none; <br><br>  # If this is the DHCP server for the local server <br>  # network, the authoritative directive should be uncommented. <br><br>  authoritative; <br><br>  # A slightly different configuration for an internal subnet. <br>  subnet 192.168.201.0 netmask 255.255.255.0 { <br>  range 192.168.201.10 192.168.201.250; <br>  option domain-name-servers 192.168.201.254; <br>  option routers 192.168.201.254; <br>  option broadcast-address 192.168.201.255; <br>  default-lease-time 600; <br>  max-lease-time 7200; <br>  } <br></div></div><br>  11. Reboot and check the service on port 67 <br> <code>root@debian9:~# reboot <br> root@debian9:~# netstat -nlp</code> <br> <br><div class="spoiler">  <b class="spoiler_title">netstat log</b> <div class="spoiler_text">  Active Internet connections (only servers) <br>  Proto Recd-Q Send-Q Local Program PID / Program Name <br>  tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 389 / sshd <br>  tcp 0 0 0.0.0.0:888 0.0.0.0:* LISTEN 310 / 3proxy <br>  tcp6 0 0 ::: 22 ::: * LISTEN 389 / sshd <br>  udp 0 0 0.0.0.0:20364 0.0.0.0:* 393 / dhcpd <br>  udp 0 0 0.0.0.0:53 0.0.0.0:* 310 / 3proxy <br>  udp 0 0 0.0.0.0:67 0.0.0.0:* 393 / dhcpd <br>  udp 0 0 0.0.0.0:68 0.0.0.0:* 405 / dhclient <br>  udp6 0 0 ::: 31728 ::: * 393 / dhcpd <br>  raw 0 0 0.0.0.0:1 0.0.0.0:* 393 / dhcpd <br><br></div></div><br>  12. It remains to redirect all tcp requests to port 888 and save the rule in iptables <br><br> <code>root@debian9:~# iptables -t nat -A PREROUTING -s 192.168.201.0/24 -p tcp -j REDIRECT --to-ports 888</code> <br> <br> <code>root@debian9:~# iptables-save &gt; /etc/iptables/rules.v4</code> <br> <br>  13. To extend the bandwidth of the channel, you can use several proxy servers at once.  The total amount should be 1000. New connections are established with a probability of 0.2, 0.2, 0.2, 0.2, 0.1, 0.1 to the specified proxy servers. <br><br>  Note: if we have a web proxy, then instead of socks5 you need to write connect, if socks4, then socks4 (socks4 DOES NOT SUPPORT AUTHORIZATION LOGIN / PASSWORD!) <br><br><div class="spoiler">  <b class="spoiler_title">Configuration example of transparent proxy server ‚Ññ2</b> <div class="spoiler_text">  daemon <br>  pidfile /home/joke/proxy/3proxy.pid <br>  nserver 8.8.8.8 <br>  nscache 65536 <br>  maxconn 500 <br>  timeouts 1 5 30 60 180 1800 16 60 <br>  log /home/joke/proxy/logs/3proxy.log D <br>  logformat "- + _L% t.%.% N.% p% E% U% C:% c% R:% r% O% I% h% T" <br>  rotate 3 <br>  flush <br>  auth iponly <br>  dnspr <br>  allow * <br><br>  parent 200 socks5 IP_ADDRESS_NEW_PROXY‚Ññ1 3128 tester 1234 <br>  parent 200 socks5 IP_ADDRESS_NEW_PROXY‚Ññ2 3128 tester 1234 <br>  parent 200 socks5 IP_ADDRESS_NEW_PROXY‚Ññ3 3128 tester 1234 <br>  parent 200 socks5 IP_ADDRESS_NEW_PROXY‚Ññ4 3128 tester 1234 <br>  parent 100 socks5 IP_ADDRESS_NEW_PROXI‚Ññ5 3128 tester 1234 <br>  parent 100 socks5 IP_ADDRESS_NEW_PROXY‚Ññ6 3128 tester 1234 <br><br>  plugin /opt/proxy/3proxy-0.8.12/src/TransparentPlugin.ld.so transparent_plugin <br>  tcppm -i0.0.0.0 888 127.0.0.1 11111 <br></div></div><br><h3>  Configuring and running the NAT + Transparent Proxy configuration </h3><br>  In this configuration, we will use the usual NAT mechanism with selective or full transparent proxying of individual addresses or subnets.  Users of the internal network will work with certain services / subnets without even knowing that they work through a proxy.  All https connections work fine, no certificates need to be generated / replaced. <br><br>  To begin with, let's decide which subnets / services we want to proxy.  Suppose that external proxy servers are where a service such as pandora.com is running.  It now remains to determine its subnets / addresses. <br><br>  1. We ping <br><br> <code>root@debian9:~# ping pandora.com</code> <br>  PING pandora.com (208.85.40.20) 56 (84) bytes of data. <br><br>  2. We type in Google BGP 208.85.40.20 <br><br>  Go to the website <a href="">bgp.he.net/net/208.85.40.0/24#_netinfo</a> <br>  It can be seen that I am asking for a subnet as AS40428 Pandora Media, Inc. <br><br>  <a href="">bgp.he.net/net/208.85.40.0/24#_netinfo</a> <br><br>  We open v4 prefixes <br><br>  <a href="https://bgp.he.net/AS40428">bgp.he.net/AS40428#_prefixes</a> <br><br>  Here are the required subnets! <br><br>  199.116.161.0/24 <br>  199.116.162.0/24 <br>  199.116.164.0/23 <br>  199.116.164.0/24 <br>  199.116.165.0/24 <br>  208.85.40.0/24 <br>  208.85.41.0/24 <br>  208.85.42.0/23 <br>  208.85.42.0/24 <br>  208.85.43.0/24 <br>  208.85.44.0/24 <br>  208.85.46.0/23 <br>  208.85.46.0/24 <br>  208.85.47.0/24 <br><br>  3. To reduce the number of subnets, you need to perform an aggregation.  Go to the site <a href="https://ip-calculator.ru/aggregate/">ip-calculator.ru/aggregate</a> and copy our list there.  As a result - 6 subnets instead of 14. <br><br>  199.116.161.0/24 <br>  199.116.162.0/24 <br>  199.116.164.0/23 <br>  208.85.40.0/22 <br>  208.85.44.0/24 <br>  208.85.46.0/23 <br><br>  4. Clear iptables rules <br><br> <code>root@debian9:~# iptables -F <br> root@debian9:~# iptables -X <br> root@debian9:~# iptables -t nat -F <br> root@debian9:~# iptables -t nat -X</code> <br> <br>  Enable forward and NAT mechanism <br><br> <code>root@debian9:~# echo 1 &gt; /proc/sys/net/ipv4/ip_forward <br> root@debian9:~# iptables -A FORWARD -i enp0s3 -o enp0s8 -j ACCEPT <br> root@debian9:~# iptables -A FORWARD -i enp0s8 -o enp0s3 -j ACCEPT <br> root@debian9:~# iptables -t nat -A POSTROUTING -o enp0s3 -s 192.168.201.0/24 -j MASQUERADE</code> <br> <br>  To enable forward permanently after reboot, edit the file <br><br> <code>root@debian9:~# nano /etc/sysctl.conf</code> <br> <br>  And uncomment the line <br><br>  net.ipv4.ip_forward = 1 <br><br>  Ctrl + X to save the file <br><br>  5. Wrap pandora.com subnets in proxy <br><br> <code>root@debian9:~# iptables -t nat -A PREROUTING -s 192.168.201.0/24 -d 199.116.161.0/24,199.116.162.0/24,199.116.164.0/23,208.85.40.0/22,208.85.44.0/24,208.85.46.0/23 -p tcp -j REDIRECT --to-ports 888</code> <br> <br>  6. Let's keep the rules <br><br> <code>root@debian9:~# iptables-save &gt; /etc/iptables/rules.v4</code> <br> <br><h3>  Setting up and running the configuration Transparent Proxy via router </h3><br>  In this configuration, the transparent proxy server can be a separate PC or a virtual machine behind a home / corporate router.  It is enough to register static routes on the router or devices and the entire subnet will use a proxy without the need for any additional settings. <br><br>  IMPORTANT!  It is necessary for our gateway to receive a static IP from the router, or to be configured to static itself. <br><br>  1. Set up a static gateway address (adapter enp0s3) <br><br> <code>root@debian9:~# nano /etc/network/interfaces</code> <br> <br><div class="spoiler">  <b class="spoiler_title">/ etc / network / interfaces file</b> <div class="spoiler_text">  # This file is the network interfaces available on your system <br>  # and how to activate them.  For more information, see interfaces (5). <br><br>  source /etc/network/interfaces.d/* <br><br>  # The loopback network interface <br>  auto lo <br>  iface lo inet loopback <br><br>  # The primary network interface <br>  allow-hotplug enp0s3 <br>  iface enp0s3 inet static <br>  address 192.168.23.2 <br>  netmask 255.255.255.0 <br>  gateway 192.168.23.254 <br><br>  # The secondary network interface <br>  allow-hotplug enp0s8 <br>  iface enp0s8 inet static <br>  address 192.168.201.254 <br>  netmask 255.255.255.0 <br></div></div><br>  2. We allow devices from subnet 192.168.23.0/24 to use proxying. <br><br> <code>root@debian9:~# iptables -t nat -A PREROUTING -s 192.168.23.0/24 -d 199.116.161.0/24,199.116.162.0/24,199.116.164.0/23,208.85.40.0/22,208.85.44.0/24,208.85.46.0/23 -p tcp -j REDIRECT --to-ports 888</code> <br> <br>  3. Keep the rules <br> <code>root@debian9:~# iptables-save &gt; /etc/iptables/rules.v4</code> <br> <br>  4. Write the subnets on the router <br><br><div class="spoiler">  <b class="spoiler_title">Router network list</b> <div class="spoiler_text">  199.116.161.0 255.255.255.0 192.168.23.2 <br>  199.116.162.0 255.255.255.0 192.168.23.2 <br>  199.116.164.0 255.255.254.0 192.168.23.2 <br>  208.85.40.0 255.255.252.0 192.168.23.2 <br>  208.85.44.0 255.255.255.0 192.168.23.2 <br>  208.85.46.0 255.255.254.0 192.168.23.2 <br></div></div><br><h3>  Used materials / resources </h3><br>  1. The official website of the program 3proxy <a href="https://3proxy.ru/">3proxy.ru</a> <br><br>  2. Installation instructions for 3proxy from source <a href="http://www.ekzorchik.ru/2015/02/how-to-take-your-socks-proxy/">www.ekzorchik.ru/2015/02/how-to-take-your-socks-proxy</a> <br><br>  3. Developer 3proxy branch on GitHub <a href="https://github.com/z3APA3A/3proxy/issues/274">github.com/z3APA3A/3proxy/issues/274</a> <br><br></div></div></div></div></div><p>Source: <a href="https://habr.com/ru/post/460469/">https://habr.com/ru/post/460469/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460453/index.html">Smart printer. Improving Octoprint</a></li>
<li><a href="../460457/index.html">Solar power plant on the house 200 m2 do it yourself</a></li>
<li><a href="../46046/index.html">Are you interested in authoring articles on game dev under Windows, XBOX360 and Zune using XNA?</a></li>
<li><a href="../460463/index.html">What happened to GALILEO - GNSS programmer version</a></li>
<li><a href="../460465/index.html">Digital Shadows - competently helps reduce digital risks</a></li>
<li><a href="../460473/index.html">White noise draws a black square</a></li>
<li><a href="../460475/index.html">Mobile lifeline on the remote control</a></li>
<li><a href="../460479/index.html">And the bear, it seems, is highly loaded</a></li>
<li><a href="../460481/index.html">Fanless productive computers MIC-7000</a></li>
<li><a href="../460485/index.html">How an online tournament can discourage ‚Äúfinish next week‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>