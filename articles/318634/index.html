<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Integration of FATFS library for organizing reading of a disk device on iOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 The article is devoted to the introduction of an open source library on iOS for reading / writing data from a MFI disk device based on ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Integration of FATFS library for organizing reading of a disk device on iOS</h1><div class="post__text post__text-html js-mediator-article"><h2>  Introduction </h2><br>  The article is devoted to the introduction of an open source library on iOS for reading / writing data from a <a href="https://developer.apple.com/programs/mfi/">MFI</a> disk device based on FAT12 / FAT16 / FAT32 / Exfat.  A method for building an application architecture based on the <a href="http://elm-chan.org/fsw/ff/00index_e.html">FATFS</a> library, as well as methods for debugging and testing wired <a href="https://developer.apple.com/programs/mfi/">MFI</a> devices, is presented.  The article contains almost no code due to compliance with the <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BE%25D0%25B3%25D0%25BB%25D0%25B0%25D1%2588%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25BE_%25D0%25BD%25D0%25B5%25D1%2580%25D0%25B0%25D0%25B7%25D0%25B3%25D0%25BB%25D0%25B0%25D1%2588%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B8">NDA</a> . <br><a name="habracut"></a><br><h2>  Formulation of the problem </h2><br>  The main goal was to create some kind of universal SDK (.framework), capable of working with manufacturers of various disk access devices using the MFI protocol, using a single API standard. <br><br><img src="https://habrastorage.org/files/dad/03f/8a0/dad03f8a0da249c79c1215b4dcedda50.png"><br><br>  The figure shows a generalized block diagram of such a framework.  Depending on the protocol of the device, this or that library of interaction with the device is selected.  Depending on the file system (FS) used on the disk, the appropriate disk operation algorithm is selected: FAT / exFat / Other FS.  At the same time, several applications (using this SDK) that are in the device‚Äôs memory can have access to the device; however, only one can perform writing / reading at a time.  This SDK implies using it in a multi-threaded application with competitive read and write tasks. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Finding a solution </h2><br>  Initially, the implementation of FAT32, created by Apple, was chosen as the base library for the implementation of FS FAT32.  However, the complexity of integrating the standard API for the access device due to being tied to a specific platform made it necessary to go in the direction of finding a ready solution with a separate abstract API for the physical access layer with the MFI device through the manufacturer's library.  <a href="http://microsin.ru/content/view/1031/44/">EFSL</a> and <a href="http://elm-chan.org/fsw/ff/00index_e.html">FATFS</a> open source implementations of FAT32 were also considered.  FATFS was chosen for several reasons: <br><br>  ‚Ä¢ current library support <br>  ‚Ä¢ platform independence and ease of porting <br>  ‚Ä¢ wide range of configuration options <br>  ‚Ä¢ exFAT support <br>  ‚Ä¢ abstract media driver access level <br><br>  Due to the problems of obtaining logs of the application, given that the connector was physically busy and there was no possibility to connect to <a href="https://github.com/fpillet/NSLogger/wiki">Xcode</a> , the <a href="https://github.com/fpillet/NSLogger/wiki">NSLogger</a> library was connected, which allows you to transfer logs via Wi-Fi almost in real time mode.  However, the problem of debugging such a library was the place to be.  It was decided to develop a simulator MFI device, which accessed a certain area on an iOS / MAC device disk and emulated read / write using the same API as the real device. <br><br><h2>  Integration issues </h2><br><h3>  Porting to Obj-C </h3><br>  FATFS is written in pure C, and it was necessary to integrate it into the library written in ObjC.  Although ObjC directly supports the integration of C functions, there were problems with function signatures and using some types of variables. <br><br><h3>  Unicode support </h3><br>  The <a href="http://elm-chan.org/fsw/ff/en/appnote.html">Unicode</a> option worked only with the Obj-C <a href="https://developer.apple.com/reference/foundation/1497293-anonymous/nsutf16littleendianstringencoding%3Flanguage%3Dobjc">NSUTF16LittleEndianStringEncoding</a> encoding parameter, despite the fact that, according to the stated requirements, UTF-16BE and UTF-8 were additionally supported.  All methods working with file names needed to be thread-safe for FAT32 to work correctly. <br><br><h3>  Thread safe </h3><br>  The thread safety option activated by the <a href="http://elm-chan.org/fsw/ff/en/config.html">FS_REENTRANT</a> parameter and implemented through the <a href="http://elm-chan.org/fsw/ff/en/appnote.html">ff_req_grant, ff_rel_grant, ff_del_syncobj functions</a> required additional implementation via POSIX.  Without the thread safety option enabled, there was a damage to the file system table and, as a result, data loss.  The <a href="https://ru.wikipedia.org/wiki/POSIX_Threads">pthread_t</a> file descriptor was not immediately successfully implemented due to the fact that <a href="http://elm-chan.org/fsw/ff/en/appnote.html">the ff_ functions for synchronizing threads</a> passed data by value, not by reference.  After replacing with reference values, there were no problems with the thread safety of operations. <br><br><h4>  Caching </h4><br>  In order to avoid data loss during copying and damage to the file table, the data cache of the recorded file was synchronized using the <a href="http://elm-chan.org/fsw/ff/en/sync.html">f_sync</a> function.  Given that the disk space could be more than 16 GB, some basic variable types had to be changed to ‚Äúlong log‚Äù.  FATFS was originally designed with the expectation of embedded devices characterized by limited memory size and low performance.  As a result, the read / write functions were performed one cluster discretely per unit of time, which is significantly lower than continuous read / write.  A similar problem arose when reading the directory structure when there are more than 100 files in the directory.  Reading / writing a single file grew linearly with an increase in the number of files, as shown in the figure.  The ‚Äúx‚Äù axis shows the number of files in the directory, and the ‚Äúy‚Äù axis shows the reading time in seconds.  Types of curves on the graph for: V2 Sim Fat ‚Äì disk drive simulator, V1 Fat FAT32 file system for which this problem is missing (not FATFS), V2 Fat64 / 128 FATFS with a disk size of 64 and 128 GB, respectively. <br><br><img src="https://habrastorage.org/files/1c9/e64/5bd/1c9e645bd8094414b1ebc1afe17ecf50.png"><br><br>  The structure of the cache in this SDK is shown in the figure below.  Thus, not only the file structure was cached, but also the sectors for low-level read / write functions of the media device, due to the absence of a hardware cache. <br><br><img src="https://habrastorage.org/files/1ce/1e1/f59/1ce1e1f592b54b2e80e07f7884b6d84a.png"><br><br><h3>  Unique application access to the device </h3><br>  Applications with an integrated SDK should not have access to an external disk device at the same time.  The rules to which the application must obey with the SDK used should look like the one shown below in the state diagram. <br><br><img src="https://habrastorage.org/files/487/a4e/9d6/487a4e9d6a764a31a99638bec8d1f1b8.png"><br><br>  To establish device access rules, a mechanism based on the <a href="https://developer.apple.com/library/content/documentation/Darwin/Conceptual/MacOSXNotifcationOv/DarwinNotificationConcepts/DarwinNotificationConcepts.html">Darwin Notification Center</a> was implemented that allows using notifications to allow or block work with the application's device when another application with this SDK is working with the device.  When you first start the application, a request is sent to all applications that are subscribed to receive certain notifications.  Each application publishes its state for the remaining applications so that the new application can go into an adequate state.  In case the device is free, the application changes to the USING state.  The PENDING state is intermediate for BUSY and WAIT in case the device is not available or busy.  In the event of a communication failure, the state INVALID is used.  When the device is finished using the application, it enters the INACTIVE state <br><br><h2>  Testing the Framework </h2><br>  Writing Unit Tests for all library functions was critical due to the hard deterministic API behavior requirements for end users.  Initially, all tests were performed on a disk device simulator.  However, the simulator and the library for low-level disk access were written by different people who did not have the possibility of interaction, and therefore the behavior of the simulator did not always coincide with the behavior of the device driver.  To this end, a testing scheme on a real device, presented below, was developed.  The framework under test was integrated into an application written using the Private API, and installation was performed via <a href="https://developer.apple.com/library/content/documentation/IDEs/Conceptual/AppDistributionGuide/DistributingEnterpriseProgramApps/DistributingEnterpriseProgramApps.html">Xcode Server Over-the-Air installation</a> .  Private API allowed to display the application from the Background of the application using Push Notification and run the necessary tests.  The test results were sent via the REST protocol to the statistics server, where they were subsequently presented in the form of graphs and tables.  The library also includes the <a href="https://www.objc.io/issues/19-debugging/activity-tracing/">Activity Tracing</a> functions for a more detailed crash log. <br><br><img src="https://habrastorage.org/files/da4/7e2/bd8/da47e2bd8657448aa469b3ac62ec1f0a.png"><br><br><h2>  Conclusion </h2><br>  Despite the serious flaws in the FATFS, the opensourse library that needs to be improved, another alternative with the ability to use Fat32 and ExFat, as well as an abstract level of support for media drivers, could not be found.  If the library is correctly modified with additional caching and buffer read / write functions connected, the functions of copying and reading FAT32 API files are lower than the copy speed of LBA blocks of the hardware driver of the hardware manufacturer by only 10-15%.  For newbies in the development and integration of file systems - FATFS can be quite a worthy choice. <br><br><h2>  useful links </h2><br>  ‚Üí <a href="http://www.elm-chan.org/fsw/ff/00index_e.html">FatFs - Generic FAT File System Module</a> <br>  ‚Üí <a href="https://msdn.microsoft.com/en-us/windows/hardware/gg463080.aspx">Microsoft EFI FAT32 File System Specification</a> <br>  ‚Üí <a href="https://developer.apple.com/library/content/documentation/Darwin/Conceptual/MacOSXNotifcationOv/DarwinNotificationConcepts/DarwinNotificationConcepts.html">Darwin Notification Concepts</a> <br>  ‚Üí <a href="https://developer.apple.com/library/content/documentation/IDEs/Conceptual/xcode_guide-continuous_integration/">About Continuous Integration in Xcode</a> </div><p>Source: <a href="https://habr.com/ru/post/318634/">https://habr.com/ru/post/318634/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318622/index.html">Titan Quest redesign for smartphones and tablets</a></li>
<li><a href="../318626/index.html">How IT professionals work. Andrei Aksenov, founder of the Sphinx project</a></li>
<li><a href="../318628/index.html">Intel Software Guard Extensions tutorial. Part 4, the enclave</a></li>
<li><a href="../318630/index.html">New Year's Eve Mobile Applications Promotion Test</a></li>
<li><a href="../318632/index.html">Extended regularization of neural networks in online stores - with the help of ... napalm</a></li>
<li><a href="../318636/index.html">Post about the most important thing</a></li>
<li><a href="../318638/index.html">TechnoLive: Player and game, interface as a link, Olga Schubert</a></li>
<li><a href="../318640/index.html">TechnoLive: VR and Future Platforms (Maxim Pestun, Dmitry Trubitsyn)</a></li>
<li><a href="../318642/index.html">Something is wrong with testing in .NET (Java, etc.)</a></li>
<li><a href="../318644/index.html">Classifiers: analysis of site visitors activity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>