<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rootkit Avatar and HiddenFsReader</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In early May, we published an analysis of the Win32 / Rootkit.Avatar rootkit. However, it lacked information about the payload it installs on infected...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rootkit Avatar and HiddenFsReader</h1><div class="post__text post__text-html js-mediator-article">  In early May, we <a href="http://habrahabr.ru/company/eset/blog/178639/">published an</a> analysis of the <b>Win32 / Rootkit.Avatar</b> rootkit.  However, it lacked information about the payload it installs on infected systems and plugins.  Our anti-virus laboratory monitors the activity of this malware.  In mid-July, we discovered another Win32 / Rootkit.Avatar dropper, which contained information about active C &amp; C servers for interaction.  <a href="https://twitter.com/matrosov">Alexander Matrosov</a> , <a href="https://twitter.com/vxradius">Evgeny Rodionov</a> and <a href="https://twitter.com/cherepanov74">Anton Cherepanov</a> performed a detailed analysis of this rootkit, from which it can be seen that it continues its activity.  We also reveal new information about rootkit self-defense methods in kernel mode. <br><br><img src="https://habrastorage.org/storage2/ff7/861/1a7/ff78611a7ac49ba0c44d4332f4bbae69.jpg"><br><br><a name="habracut"></a>  <b>Payload</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The configuration information for the analyzed samples has the same format that we described last post.  In decrypted form, the configuration we are looking at is as follows. <br><br><img src="https://habrastorage.org/storage2/a05/5c3/c23/a055c3c23c02f5cbf590757e330d2115.png"><br><br>  The C &amp; C managing server specified above in the configuration file (highlighted in yellow) did not work at the time of our analysis, so we used the Yahoo Groups service, in which the malicious code duplicates the necessary information to communicate with C &amp; C. <br><br>  Win32 / Rootkit.Avatar has another way to communicate with C &amp; C, if other methods for some reason can not work.  As we mentioned in the past analysis, the malicious code searches for messages in Yahoo Groups using special parameters.  The avatar uses the following line as a parameter to search for messages " <i>hxxp: //finance.groups.yahoo.com/group/I62TUUWM/</i> ".  We found the next group corresponding to this parameter. <br><br><img src="https://habrastorage.org/storage2/b5d/19f/4ac/b5d19f4ac70af846cff83d5ad75acfe0.png"><br><br>  The group description is encrypted using the RSA algorithm and a private 1024-bit key, which is located in the bot's configuration file.  After decryption we get: <br><br><img src="https://habrastorage.org/storage2/373/9f5/184/3739f5184bb548a0ac3216e2c8730c3c.png"><br><br>  In our case, the main C &amp; C server from the configuration file was no longer active, so the bot tried to use another C &amp; C receiving channel using Yahoo Groups.  After successful interaction with the additional server, the bot received the following command to load additional modules. <br><br><img src="https://habrastorage.org/storage2/d68/975/02c/d6897502c8a0b61e62bf53e383776b31.png"><br><br>  Using these instructions, two additional modules are loaded onto the infected system: <br><ul><li>  cr.mod ( <a href="http://virusradar.com/en/Win32_Agent.UZD/description">Win32 / Agent.UZD</a> ) - SOCKS5 proxy client </li><li>  loader29.mod ( <a href="http://virusradar.com/en/Win32_TrojanDownloader.Zurgop.AZ/description">Win32 / TrojanDownloader.Zurgop.AZ</a> ) - <a href="https://www.botnets.fr/index.php%3Ftitle%3DSmoke_Bot%26setlang%3Den">Smoke bot</a> downloader. </li></ul><br><br>  <b>Mechanisms of self-defense of the rootkit</b> <br><br>  During system infection, Avatar modifies one of the system drivers installed on the system, and also places its modules and payload in hidden storage at the end of the disk.  Thus, to counteract detection, it protects a certain area of ‚Äã‚Äãthe hard disk from reading / writing using interceptions at the level of the miniport driver.  Of course, this approach is not new and has already been used by such complex threats as TDL3 / 4, Olmasco and others.  Nevertheless, the details of the implementation of this approach in Avatar deserve their publication. <br><br>  The rootkit tries to mask its interceptions so as not to attract attention and look like a standard OS driver.  In particular, it duplicates the image of the loaded miniport driver in the kernel-mode address space and modifies it so that it can intercept read / write requests to the disk.  The following screenshot shows which modifications are made in the system after a rootkit infection. <br><br><img src="https://habrastorage.org/storage2/f1f/680/ea8/f1f680ea82e8d65a55aee7eadc5e8532.png"><br><br>  In other words, the malicious code loads the driver image and uses one of its sections to inject its code.  The avatar searches for the INIT section with the IMAGE_SCN_MEM_DISCARDABLE section attribute set.  This means that the contents of this section can be unloaded from memory after the driver has been initialized.  Thus, Avatar uses the advantage of this approach when placing its own code in this section (the auxiliary driver was loaded by the rootkit from the disk).  The rootkit renames the found section to NONPAGED and clears the IMAGE_SCN_MEM_DISCARDABLE flag from the attributes, and then copies the malicious code there. <br><br>  When copying the original DRIVER_OBJECT used by the miniport, the rootkit modifies the following fields: <br><ul><li>  DriverInit - entry point to the driver image </li><li>  DriverStart - image download address </li><li>  MajorFunctions - an array of pointers to handlers for IRP commands, including IRP_MJ_INTERNAL_CONTROL </li><li>  DriverUnload is a function called when a driver is unloaded. </li><li>  DriverExtension-&gt; AddDevice is a function for PnP device drivers. </li></ul><br>  After performing the above modifications, i.e.  duplication of the original driver in memory and its modifications; adding a new DRIVER_OBJECT rootkit can monitor all read / write operations addressed to the disk.  This, in turn, allows you to protect the hard disk area in which the rootkit files are stored. <br><br>  If you try to read the image of the driver modified by the rootkit from the disk, to compare it with the one that was loaded into memory, the rootkit intercepts such an operation and returns the original driver.  Thus, it is unlikely that the difference between a file read from the disk and located in memory will be noticed.  However, the digital signature of the modified driver is no longer valid. <br><br>  <b>HiddenFsReader</b> <br><br>  <a href="http://www.eset.com/int/download/utilities/detail/family/173/">HiddenFsReader</a> forensic <a href="http://www.eset.com/int/download/utilities/detail/family/173/">tool has</a> been updated to work with the Avatar rootkit hidden file system.  Below is the FS dump of this rootkit. <br><br><img src="https://habrastorage.org/storage2/5e3/627/5bc/5e36275bcf9cb99171a036eb1b4611c1.png"><br><br>  It should be noted that HiddenFsReader is able to extract the necessary files only when the rootkit itself is active in the system.  Such a restriction is a consequence of the fact that in order to decrypt a hidden file system, it is necessary to extract 10 bytes of the encryption key from the body of the rootkit driver, which are unique for each infection case.  Once the system is cured, it is impossible to recover files from a hidden partition.  The names of files in the hidden section are generated arbitrarily by malicious code for a specific infection. <br><br>  Win32 / Rootkit.Avatar is an interesting example of malware that uses several methods to circumvent forensic tools, which complicates its analysis on compromised computers. </div><p>Source: <a href="https://habr.com/ru/post/191044/">https://habr.com/ru/post/191044/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191018/index.html">Five pitfalls when using shared_ptr</a></li>
<li><a href="../191022/index.html">The concept of the Ministry of Communications and Mass Media: I want a substantive conversation</a></li>
<li><a href="../191024/index.html">Inforza - a new channel to attract customers for studios and agencies</a></li>
<li><a href="../191030/index.html">Analysis of all tasks and results of Yandex. Algorithm</a></li>
<li><a href="../191032/index.html">Python inside. Process structures</a></li>
<li><a href="../191048/index.html">IBM Unveils New Wind and Solar Prediction System</a></li>
<li><a href="../191052/index.html">Nginx has a paid version - Nginx Plus</a></li>
<li><a href="../191054/index.html">STM32 vs Arduino</a></li>
<li><a href="../191060/index.html">Minimalistic RSS reader for the Yandex.Following service</a></li>
<li><a href="../191066/index.html">Cowon AE1: another unusual recorder from the manufacturer of players</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>