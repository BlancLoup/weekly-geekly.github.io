<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android development using qt and android studio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Irrelevant, except for setting the problem . The correct solution is in the next article . 
 Good afternoon, dear habrovchane! In this article I want ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android development using qt and android studio</h1><div class="post__text post__text-html js-mediator-article">  <b><i>Irrelevant, except for setting the problem</i></b> .  The correct solution is <a href="https://habrahabr.ru/post/305528/">in the next article</a> . <br>  Good afternoon, dear habrovchane!  In this article I want to talk about my experience using qt and android studio.  Namely, how I had to draw text in qt and transfer it to the android studio.  Despite the simplicity of the problem, it took me quite a long time to solve it and maybe someone will save a lot of time somewhere.  The article in some sense claims the invention of the bicycle, but I have not found a solution on the Internet.  Who cares - welcome under the cat! <br><a name="habracut"></a><br><h3>  A little about the task itself </h3><br>  Recently, I faced the task of porting an application from ios to android.  The main pain when porting was working with the SDK application.  It was written in Qt and was used to draw text / arrows / areas and so on.  That is, the application was written in <i><b>objective c</b></i> , and used the qt library, and was not a qt project.  Therefore, the first step was the issue of the development environment.  Since I am completely new to this business, my choice fell on the android studio.  Still, the whole graphical interface, as it seemed to me, is better to do in the android studio, and let our qtshny SDK do the computational tasks.  On the Internet, not much is written about using qt for android, but here was the task of making friends with qt and android studio.  To work with the pluses, the Android NDK is used and is implemented through the use of JNI.  Working with JNI is a pretty interesting thing in itself.  In nete you can find a lot of articles on this topic (for example, <a href="http://habrahabr.ru/post/49660">this wonderful cycle</a> ).  However, I am interested in JNI in terms of using it with Qt.  Again, what's the problem, you ask?  We take sorshnye sorsy, we make a shared lib, we connect to the project in the android studio and we get profit!  Here, <a href="https://habrahabr.ru/post/255597/">as for example here.</a>  And here the most interesting begins ... <br><br><h3>  Using qt in android studio </h3><br>  As you remember, I indicated above that <br><blockquote>  it was written in Qt and was used to draw text / arrows / areas and everything else <br></blockquote>  . <br>  To draw a graphic primitive in QT, we do not need to create an instance of QApplication or QGuiApplication.  Even QCoreApplication is not needed!  But to draw text without QApplication or QGuiApplication can not do.  So what's the problem, you ask?  The problem comes just at the time of the constructor call: <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">QApplication </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(argc, argv)</span></span></span></span>;</code> </pre> <br>  If you create a library, in it any function that calls the QApplication constructor, and then call it via JNI from the android studio application, then immediately catch: <br><blockquote>  This was not the case for the Qt platform plugin "android". <br></blockquote><br><h3>  <s>Who is guilty</s> What to do? </h3><br><h4>  The classic option.  Learn materiel! </h4><br>  The first thing I decided to do was google a solution to the problem on the Internet.  I did not find an exact match, but in a fairly large number of posts people complained about similar problems for the plugin for Windows.  So I tried everything that was indicated <a href="https://habrahabr.ru/post/188816/">here</a> , but, alas, no solution (working for me!) Was found. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In search of an answer to my questions, I came across such a rather curious <a href="http://www.kdab.com/qt-on-android-episode-1/">blog</a> , as I understood the author of qt under android.  The blog is very interesting, but the author focuses on it (again, my IMHO) on the development from the ++ and the launch of all the good from the qt creator.  To be honest, this approach did not suit me very well for one reason: debugging Java parts from Qt is almost impossible (you can only compile the code, then wait for attachments from the android studio and watch the events from there), and I also have quite a lot of different layouts. custom, asynchronous tasks, and how it is good to thrust the project into qt and normally to debug?  Honestly, I do not know. <br><br><h4>  Experiments </h4><br>  I also tried to create a Qt application and run it on an android.  I launched it through qt-creator and strangely enough it started up safely.  I began to look in more detail how the manifest, graddl, application code.  I discovered such an interesting thing in the manifest: <br><pre> <code class="hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- Deploy Qt libs as part of package --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.app.bundle_local_qt_libs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.app.bundled_in_lib_resource_id"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:resource</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@array/bundled_in_lib"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.app.bundled_in_assets_resource_id"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:resource</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@array/bundled_in_assets"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Run with local libs --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.app.use_local_qt_libs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.app.libs_prefix"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/data/local/tmp/qt/"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.app.load_local_libs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"plugins/platforms/android/libqtforandroid.so"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.app.load_local_jars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"jar/QtAndroid.jar:jar/QtAndroidAccessibility.jar:jar/QtAndroid-bundled.jar:jar/QtAndroidAccessibility-bundled.jar"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.app.static_init_classes"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  In short, its meaning is clear.  When I compiled apk applications, I indicated that the qt libraries must be inside apk and it is from there that you need to ship them to your application.  Connecting the corresponding jar-s to the project on android, prescribing what was in qt in the android manifesto, placing qtshny .so plug-ins in the jniLibs folder did not have any effect. <br><br><h4>  Learning plugins </h4><br>  I tried to finally load this unfortunate plugin libqtforandroid.so (before creating QApplication) by java by myself <blockquote>  System.loadLibrary ("plugins_platforms_android_libqtforandroid"); </blockquote>  , but it still fell!  True, the exception here was another and more interesting: <br><blockquote>  I / Qt: qt start <br>  05-17 11: 12: 33.975 11084-11084 / project name A / libc: Fatal signal 11 (SIGSEGV) at 0x00000000 (code = 1), thread 11084 (ndroid.gribview) <br>  05-17 11: 12: 33.978 11084-11084 / project name A / libc: Send stop signal to pid: 11084 in void debuggerd_signal_handler (int, siginfo_t, void) </blockquote><br>  At least we have a clue where you can watch.  Quickly on qt start we find the method we are interested in: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Q_DECL_EXPORT jint JNICALL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">JNI_OnLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JavaVM *vm, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/*reserved*/</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ QT_USE_NAMESPACE <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> { JNIEnv *nativeEnvironment; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *venv; } UnionJNIEnvToVoid; __android_log_print(ANDROID_LOG_INFO, <span class="hljs-string"><span class="hljs-string">"Qt"</span></span>, <span class="hljs-string"><span class="hljs-string">"qt start"</span></span>); UnionJNIEnvToVoid uenv; uenv.venv = Q_NULLPTR; m_javaVM = Q_NULLPTR; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (vm-&gt;GetEnv(&amp;uenv.venv, JNI_VERSION_1_4) != JNI_OK) { __android_log_print(ANDROID_LOG_FATAL, <span class="hljs-string"><span class="hljs-string">"Qt"</span></span>, <span class="hljs-string"><span class="hljs-string">"GetEnv failed"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } JNIEnv *env = uenv.nativeEnvironment; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!registerNatives(env) || !QtAndroidInput::registerNatives(env) || !QtAndroidMenu::registerNatives(env) || !QtAndroidAccessibility::registerNatives(env) || !QtAndroidDialogHelpers::registerNatives(env)) { __android_log_print(ANDROID_LOG_FATAL, <span class="hljs-string"><span class="hljs-string">"Qt"</span></span>, <span class="hljs-string"><span class="hljs-string">"registerNatives failed"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } m_javaVM = vm; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JNI_VERSION_1_4; }</code> </pre><br>  Judging by the log, it fell somewhere in some of the registerNatives. So it was (I registered the logs in each of the registerNatives).  He fell into <br><br><pre> <code class="cpp hljs">registerNatives(env)</code> </pre><br>  Namely: <br><br><pre> <code class="cpp hljs">jmethodID methodID; GET_AND_CHECK_STATIC_METHOD(methodID, m_applicationClass, <span class="hljs-string"><span class="hljs-string">"activity"</span></span>, <span class="hljs-string"><span class="hljs-string">"()Landroid/app/Activity;"</span></span>); __android_log_print(ANDROID_LOG_INFO, <span class="hljs-string"><span class="hljs-string">"Check Class 8"</span></span>, <span class="hljs-string"><span class="hljs-string">"activity "</span></span>); jobject activityObject = env-&gt;CallStaticObjectMethod(m_applicationClass, methodID); __android_log_print(ANDROID_LOG_INFO, <span class="hljs-string"><span class="hljs-string">"Check Class 9 "</span></span>, <span class="hljs-string"><span class="hljs-string">" methodID "</span></span>); GET_AND_CHECK_STATIC_METHOD(methodID, m_applicationClass, <span class="hljs-string"><span class="hljs-string">"classLoader"</span></span>, <span class="hljs-string"><span class="hljs-string">"()Ljava/lang/ClassLoader;"</span></span>); __android_log_print(ANDROID_LOG_INFO, <span class="hljs-string"><span class="hljs-string">"Check Class 10"</span></span>, <span class="hljs-string"><span class="hljs-string">" classLoader "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(activityObject!=<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { __android_log_print(ANDROID_LOG_INFO, <span class="hljs-string"><span class="hljs-string">"No tull activityObject"</span></span>, <span class="hljs-string"><span class="hljs-string">" Not Null "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(methodID!=<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { __android_log_print(ANDROID_LOG_INFO, <span class="hljs-string"><span class="hljs-string">"No tull methodID"</span></span>, <span class="hljs-string"><span class="hljs-string">" Not Null "</span></span>); } m_classLoaderObject = env-&gt;NewGlobalRef(env-&gt;CallStaticObjectMethod(m_applicationClass, methodID)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(m_classLoaderObject!=<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { __android_log_print(ANDROID_LOG_INFO, <span class="hljs-string"><span class="hljs-string">"No tull m_classLoaderObject"</span></span>, <span class="hljs-string"><span class="hljs-string">" Not Null "</span></span>); } clazz = env-&gt;GetObjectClass(m_classLoaderObject);</code> </pre><br>  The fall occurred on the last line.  classLoaderObject turned out to be null.  And it happened that activityObject is also null.  Okay.  Before loading this ill-fated plugin, we will try to create an activation for JNI.  To do this, write in Java code the following lines: <br><br><pre> <code class="java hljs"> QtNative.setActivity(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); QtNative.setClassLoader(getClassLoader());</code> </pre><br>  A small digression.  The QtNative class is in jar files that we connect to the project.  Moreover, it is a very curious class.  It has methods: <br><br><pre> <code class="java hljs"> QtNative.loadBundledLibraries(); QtNative.loadQtLibraries();</code> </pre><br>  which should load the required plugins.  For now, remember this, and return to connecting our plug-in manually.  Calling the QtNative setActivity and setClassLoader methods helped skip: <br><br><pre> <code class="cpp hljs">registerNatives(env)</code> </pre><br>  but the ambush was already in QtAndroidInput :: registerNatives (env).  The function signatures for the keyDown event did not match.  In principle, I do not need anything except fonts and I commented out the following piece of code: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!registerNatives(env) <span class="hljs-comment"><span class="hljs-comment">/* || !QtAndroidInput::registerNatives(env) || !QtAndroidMenu::registerNatives(env) || !QtAndroidAccessibility::registerNatives(env) || !QtAndroidDialogHelpers::registerNatives(env)*/</span></span>) { __android_log_print(ANDROID_LOG_FATAL, <span class="hljs-string"><span class="hljs-string">"Qt"</span></span>, <span class="hljs-string"><span class="hljs-string">"registerNatives failed"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; }</code> </pre><br>  and it seems to have loaded this plugin safely.  We start the application, load the plugin, call QApplication and ... catch our <s>osto</s> familiar exception: <br><blockquote>  This was not the case for the Qt platform plugin "android". <br></blockquote><br>  Moreover, the challenge <br><br><pre> <code class="java hljs"> QtNative.loadBundledLibraries(); QtNative.loadQtLibraries();</code> </pre><br>  also did not solve the problem.  Good.  Okay.  Use the sorts of constructor creation.  By exception, we quickly find the method: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init_platform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;pluginArgument, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;platformPluginPath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;platformThemeName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **argv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Split into platform name and arguments QStringList arguments = pluginArgument.split(QLatin1Char(':')); const QString name = arguments.takeFirst().toLower(); QString argumentsKey = name; argumentsKey[0] = argumentsKey.at(0).toUpper(); arguments.append(QLibraryInfo::platformPluginArguments(argumentsKey)); // Create the platform integration. QGuiApplicationPrivate::platform_integration = QPlatformIntegrationFactory::create(name, arguments, argc, argv, platformPluginPath); if (QGuiApplicationPrivate::platform_integration) { QGuiApplicationPrivate::platform_name = new QString(name); } else { QStringList keys = QPlatformIntegrationFactory::keys(platformPluginPath); QString fatalMessage = QStringLiteral("This application failed to start because it could not find or load the Qt platform plugin \"%1\".\n\n").arg(name); ....</span></span></code> </pre><br>  Good.  We are looking for, from where we call this method: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> QGuiApplicationPrivate::createPlatformIntegration() { <span class="hljs-comment"><span class="hljs-comment">// Use the Qt menus by default. Platform plugins that // want to enable a native menu implementation can clear // this flag. QCoreApplication::setAttribute(Qt::AA_DontUseNativeMenuBar, true); // Load the platform integration QString platformPluginPath = QLatin1String(qgetenv("QT_QPA_PLATFORM_PLUGIN_PATH")); QByteArray platformName; #ifdef QT_QPA_DEFAULT_PLATFORM_NAME platformName = QT_QPA_DEFAULT_PLATFORM_NAME; #endif QByteArray platformNameEnv = qgetenv("QT_QPA_PLATFORM"); if (!platformNameEnv.isEmpty()) { platformName = platformNameEnv; } QString platformThemeName = QString::fromLocal8Bit(qgetenv("QT_QPA_PLATFORMTHEME")); // Get command line params QString icon; int j = argc ? 1 : 0; for (int i=1; i&lt;argc; i++) { if (argv[i] &amp;&amp; *argv[i] != '-') { argv[j++] = argv[i]; continue; } const bool isXcb = platformName == "xcb"; QByteArray arg = argv[i]; if (arg.startsWith("--")) arg.remove(0, 1); if (arg == "-platformpluginpath") { if (++i &lt; argc) platformPluginPath = QLatin1String(argv[i]); } else if (arg == "-platform") { if (++i &lt; argc) platformName = argv[i]; } else if (arg == "-platformtheme") { if (++i &lt; argc) platformThemeName = QString::fromLocal8Bit(argv[i]); } else if (arg == "-qwindowgeometry" || (isXcb &amp;&amp; arg == "-geometry")) { if (++i &lt; argc) windowGeometrySpecification = QWindowGeometrySpecification::fromArgument(argv[i]); } else if (arg == "-qwindowtitle" || (isXcb &amp;&amp; arg == "-title")) { if (++i &lt; argc) firstWindowTitle = QString::fromLocal8Bit(argv[i]); } else if (arg == "-qwindowicon" || (isXcb &amp;&amp; arg == "-icon")) { if (++i &lt; argc) { icon = QString::fromLocal8Bit(argv[i]); } } else { argv[j++] = argv[i]; } } if (j &lt; argc) { argv[j] = 0; argc = j; } init_platform(QLatin1String(platformName), platformPluginPath, platformThemeName, argc, argv); if (!icon.isEmpty()) forcedWindowIcon = QDir::isAbsolutePath(icon) ? QIcon(icon) : QIcon::fromTheme(icon); }</span></span></code> </pre><br>  I mean, we can pass arguments through argc and argv, where to look for this plugin.  Immediately make a reservation, I tried to launch the application under the android in the qt debagger, and there argc and argv are respectively equal: 1 and the name of our_lib_library_, which is collected by qt, but not a plugin.  Let's try to assign argc and argv to the corresponding values: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *SDKEnvironment::argv[] = {<span class="hljs-string"><span class="hljs-string">"-platform libplugins_platforms_android_libqtforandroid.so:plugins/platforms/android/libqtforandroid.so -platformpluginpath /data/app-lib/__jniLibs"</span></span>};</code> </pre><br>  Nope, it did not work. <br><br><h3>  Decision </h3><br>  To be honest, the deadlines are tight, and then I‚Äôm not sure what and where it didn‚Äôt work - I don‚Äôt have <s>the</s> time.  The solution that helped me is the following: <br><br><ol><li>  Let's create in qt not apk, not so, but aar.  To do this, go to the qt creator and find the gradle file, and in it we change the line <code>apply plugin: 'com.android.applicatioin'</code> to <code>apply plugin: 'com.android.library'</code> .  So we create aar file, not apk </li><li>  Now add it to our application in the android studio.  Go to New-&gt; Module, select import aar, then right-click on our module, select Open Module Settings, go to the dependency tab and add the dependency to the qt module </li></ol><br>  Then I transferred all the jni that I had in the android studio to qt.  I tried to create QApplication again - and it all worked. <br><br><h3>  Summary </h3><br>  I am pretty sure that there is another way to solve this problem.  If someone indicates where I was wrong, it would be just great.  I did not find a solution to the problem on the Internet, so I offer my own. </div><p>Source: <a href="https://habr.com/ru/post/301852/">https://habr.com/ru/post/301852/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301838/index.html">Reversing the Android client of the music service Zaycev.net and implementing api on go</a></li>
<li><a href="../301840/index.html">Autofill: what web developers don't know, although they should know</a></li>
<li><a href="../301842/index.html">Urban design: 4 lectures on the creation of navigation schemes in the subway and not only</a></li>
<li><a href="../301846/index.html">Game publishers in 2016: how to lose your life's work in a few seconds</a></li>
<li><a href="../301848/index.html">Project structuring in WordPress, Laravel Blade and more.</a></li>
<li><a href="../301854/index.html">The design and operation of the Arcserve UDP software for data backup and recovery</a></li>
<li><a href="../301858/index.html">Great interview with Hannes Dorfman, creator of Mosby framework for Android</a></li>
<li><a href="../301860/index.html">Electronic "emitter of information" at the lowest cost</a></li>
<li><a href="../301862/index.html">New derivatives of Bessel functions are derived using the Wolfram Language.</a></li>
<li><a href="../301864/index.html">Intel Internet Gateway: I sign and install RPM packages</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>