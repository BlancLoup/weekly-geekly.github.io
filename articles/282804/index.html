<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SDK for the introduction of support for e-books in FB2 format</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="You know that the Chinese science author Liu Cixin (Liu Cixin, ) with the work of The Three-Body Problem () orth) got the "nobel" in science fiction ....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SDK for the introduction of support for e-books in FB2 format</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/28c/717/ca7/28c717ca7fed4ad792b89c5cb0dac763.jpg"><br><br>  You know that <a href="https://en.wikipedia.org/wiki/Hugo_Award_for_Best_Novel">the Chinese science</a> author Liu Cixin (Liu Cixin, ) with the work of <a href="https://en.wikipedia.org/wiki/The_Three-Body_Problem">The Three-Body Problem</a> () orth) got the <a href="https://en.wikipedia.org/wiki/Hugo_Award_for_Best_Novel">"nobel" in science fiction</a> .  Barack Obama ( <a href="http://thehill.com/blogs/blog-briefing-room/news/264531-obamas-busy-hawaii-reading-list">proof</a> ) and Mark Zuckerberg ( <a href="https://www.facebook.com/zuck/posts/10102434874214351">proof</a> ) paid attention to this book. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b32/430/79c/b3243079cd220cc3d988d074a7c4781d.gif" alt="image" align="left"><br>  <a href="https://vk.com/id66719931">Olga Braatkhen,</a> on her own initiative, translated the book into Russian ( <a href="https://vk.com/doc-83926979_437424650">here you can swing fb2</a> ), for which she thanks a lot. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Another candidate for the ‚ÄúNobel Prize‚Äù in 2016 is <a href="https://en.wikipedia.org/wiki/Neil_Stephenson">Neil Stevenson</a> (who wrote ‚ÄúAvalanche‚Äù and ‚ÄúKryptonomicon‚Äù) with the work of <a href="https://en.wikipedia.org/wiki/Seveneves">Seveneves</a> ( <a href="https://kat.cr/usearch/Seveneves/">you can swing in English here</a> , it‚Äôs a pity that no one took it to Russian). <br><br>  The developers of <a href="https://www.edsd.ru/ru/proekty/razrabotka_po">EDISON</a> created an <a href="https://habrahabr.ru/company/edison/blog/232033/">Electronic Documents Access Control</a> program, which I wrote about a couple of years ago, and today the SDK will be discussed to introduce support for electronic books in FB2 format. <br><br clear="left"><a name="habracut"></a><br><h4>  Introduction </h4><br>  The use of information technology in the library field has led to the emergence of Internet services that provide readers with remote access to a rich set of fiction, scientific and technical literature.  These services take the library to a new level.  Libraries can unite in a single network, forming a huge geographically distributed base of digitized content, and the provision of library services on the Internet expands the target audience and provides additional income.  Key users also receive benefits: no need to spend time traveling to the library, borrow books for personal use and take care of timely delivery;  Access to rare literature that is absent in a particular locality is possible.  Rights holders can receive royalties by providing content on mutually beneficial terms. <br><br>  Special attention in library services is given to respecting copyright and copy protection.  At the transport level, proprietary formats are used, and client-side software should not save received content on disk. <br><br>  The main part of the content is formed by manual digitization of physical media using scanners and subsequent text recognition to enable search, but this is not the only source.  There are many digital formats designed to store electronic books, and already digitized books in these formats is also not enough.  Accordingly, support of various electronic formats in library services is needed.  I'll tell you about the development of the SDK (developer's toolkit) for introducing support for electronic books in the <a href="https://ru.wikipedia.org/wiki/FictionBook">Fiction Book</a> format to one of the services. <br><br><h4>  Task </h4><br>  The content delivery service provides users with paged access to literature in a remote repository.  Access to each page is fixed and charged.  The service is implemented full-text search, the results of which are highlighted by translucent rectangles.  The traffic between the server and the client is protected and is a proprietary binary format. <br><br>  EDISON programmers were faced with the task of creating an SDK that provides the end developer with a set of ready-to-use functions that help simplify the process of implementing support for e-books in FB2 format, as well as using a common code base when building the server and client side of the solution. <br><br>  <b>Based on the functionality of the service, the requirements for the SDK feature set were defined in advance:</b> <br><ol><li>  obtaining bibliographic information; </li><li>  getting the number of pages of the e-book; </li><li>  Retrieving full-text search results with links to relevant pages; </li><li>  getting the coordinates of the rectangles to highlight the full-text search results; </li><li>  getting the content of an arbitrary page in binary format and rendering the page. </li></ol><br>  Implementation and technology: C ++ / Qt <br><br><h4>  Decision </h4><br>  The e-book in FB2 is a one-page document.  The format does not provide information on how the document should look.  First of all, it was necessary to solve the problem of splitting an FB2 document into pages, without duplicating the contents of the document.  As a result, an index file format was designed that stores the metadata about the original FB2 document, obtained by parsing the original document, rendering and splitting the document into pages. <br>  The index file contains the location of the XML document fragments as an offset from the beginning of the document and the fragment length in the number of characters, as well as the XML prefix. <br><br>  The structure of the index file includes three sections: <br><ul><li>  description - a fragment with the description of the document; </li><li>  binary - fragments with pictures in the original document; </li><li>  page - fragments of the document, where the pages obtained as a result of rendering with the specified page size, indentation and font parameters begin and end. </li></ul><br><br>  Information about the location of a fragment of an XML document allows you to subtract the necessary piece of information from the original document without having to parse it; the XML prefix allows you to build a miniature XML document containing markup of only the necessary page, parse it and immediately render the necessary page upon user request. <br><br>  <b>An example of an index file with a pagination of the document.</b> <br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">document</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fragment</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offset</span></span></span><span class="hljs-tag">&gt;</span></span>418<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span>5230<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">prefix</span></span></span><span class="hljs-tag">&gt;</span></span>&lt;![CDATA[&lt;FictionBook xmlns="http://www.gribuser.ru/xml/fictionbook/2.0" xmlns:xlink="http://www.w3.org/1999/xlink"&gt;]]&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">prefix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fragment</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">binary</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cover.jpg"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fragment</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offset</span></span></span><span class="hljs-tag">&gt;</span></span>43034<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span>48151<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fragment</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">binary</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">page</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">number</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fragment</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offset</span></span></span><span class="hljs-tag">&gt;</span></span>5657<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span>1779<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">prefix</span></span></span><span class="hljs-tag">&gt;</span></span>&lt;![CDATA[&lt;FictionBook xmlns="http://www.gribuser.ru/xml/fictionbook/2.0" xmlns:xlink="http://www.w3.org/1999/xlink"&gt;&lt;body&gt;]]&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">prefix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fragment</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">page</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">page</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">number</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fragment</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offset</span></span></span><span class="hljs-tag">&gt;</span></span>7436<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">offset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span>2366<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">prefix</span></span></span><span class="hljs-tag">&gt;</span></span>&lt;![CDATA[&lt;FictionBook xmlns="http://www.gribuser.ru/xml/fictionbook/2.0" xmlns:xlink="http://www.w3.org/1999/xlink"&gt;&lt;body&gt;&lt;section&gt;&lt;section&gt;&lt;p&gt;]]&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">prefix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fragment</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">page</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">document</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  When the idea of ‚Äã‚Äãa pagination algorithm appeared, we started to implement it.  For the formation of the index, the method of streaming parsing of the original document using the standard Qt library classes was chosen, thanks to the possibility of sequentially reading the XML file and storing the offset information in the file in the number of characters using the QXmlStreamReader :: characterOffset method. <br><br>  In the process of parsing an FB2 document as you move from tag to tag, the paragraphs of the document are broken down into sets of words, which are then reassembled into lines.  In accordance with the settings file, each line is set to the maximum width, taking into account the specified width of the page margins and the indent for paragraphs.  For lines, the line spacing specified in the settings file is also set.  Depending on the tags of the XML document, the font parameters, size, style and alignment are set.  For headings and subtitles, center alignment is set, for epigraphs, right alignment, by default, left alignment.  As words are added to the string, the length of the string is recalculated by adding the length of all the words added.  If the length of the line exceeds the specified width of the page, then the line is added to the page object;  a word that does not fit into the line is added to the next line.  As you add lines to the page, the height of all lines is recalculated, taking into account the line spacing.  When introducing images for the height of the line I had to consider the maximum height of the object added to the line.  If the height of all added lines exceeds the specified page height with regard to indents, the next fragment is added to the index file.  The described algorithm is used both when splitting an FB2 document into pages, as well as with random access to a page by means of using an index file. <br><br>  Since the QXmlStreamReader :: characterOffset method returns the offset in the number of characters, not in bytes, when randomly accessing the pages of the document, you had to read the beginning of the original file, and only then read the interesting part of the document, since the document can contain Cyrillic and Latin characters, and only one file offset in bytes using the seek method would inevitably lead to errors. <br><pre> <code class="hljs pgsql">QString Document::documentFragment(uint <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>, uint length) { QString fragment; QFile file(m_fileName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!file.<span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(QIODevice::ReadOnly)) { m_error = IOError; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fragment; } QTextStream fileStream(&amp;file); fileStream.setCodec("UTF-8"); fileStream.setAutoDetectUnicode(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); fileStream.seek(<span class="hljs-number"><span class="hljs-number">0</span></span>); fileStream.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">offset</span></span>); fragment = fileStream.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(length); file.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((uint) fragment.size() &lt; length) { m_error = IOError; fragment = QString(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fragment; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fragment; }</code> </pre> <br><br>  Despite this, there is no loss in performance, access to the last page of the document is as fast as the first page, and takes less than a second.  The fact is that the average volume of a book without pictures in the FB2 format rarely exceeds 10 MB. <br><br>  Splitting a 7 MB file into 998 pages and preparing the index takes about 10 seconds.  Splitting a 9 MB file into 1576 pages takes about 15 seconds.  On average, about 100 pages are rendered per second.  If there is an index, the document opens in 50 milliseconds. <br><br>  Next was to solve the problem of full-text search with reference to the pages of the document.  And here, to ensure speed, I still had to duplicate the contents of the document, but without the XML markup, but as a plain text file.  Markers of the beginning and end of the page are inserted into the text index as a zero byte.  To bind the search results to the pages and store the coordinates of the rectangles, it was necessary to organize two auxiliary indices in binary format.  A sub-index for binding search results to pages stores the page number, the sequence number of the start and end bytes of the page marker in the text index. <br><br>  Full-text search was carried out using the library provided by the customer, which returns all word forms for a given word.  The search query is divided into a set of words, then for each word there are all word forms, then by the generated array of the found word forms a search is performed in the text index.  Using an auxiliary index and page start / end markers, the text index determines the page numbers to which the search results belong.  The auxiliary index with the coordinates of the rectangles is formed only when the page is requested.  A separate index file is formed for each page.  In the process of obtaining the coordinates of the rectangles, the same algorithm of splitting the original document into pages is used due to the division of lines into words and the calculation of the boundaries of each word, and the index is used in order not to call this algorithm again when going to the same page. <br><br>  Creating indexes for full-text search takes about a minute on documents of about 10 MB.  The search, if there are indexes, works for about one second on a document with 1576 pages. <br><br>  Another surprise was the display of translucent rectangles over the found text fragments.  Since the original mathematics for calculating the boundaries of words was in pixels, this caused inaccuracies of a few pixels when scaling pages of the document.  The solution was found: it was necessary only to translate all calculations into inches taking into account the DPI output device, using floating point values ‚Äã‚Äãinstead of integer values, correcting a significant part of the code. <br><pre> <code class="hljs coffeescript"><span class="hljs-function"><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">m_dpiX</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(qreal)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">QApplication</span></span></span><span class="hljs-function">::</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">desktop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">-&gt;</span></span>physicalDpiX(); m_dpiY = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(qreal)</span></span></span><span class="hljs-function"> QApplication::desktop</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">-&gt;</span></span>physicalDpiY(); QFontMetricsF fm(m_font); m_rect = fm.boundingRect(m_text); m_textDescent = fm.descent() / m_dpiY; qreal width = m_rect.width() / m_dpiX; qreal height = m_rect.height() / m_dpiY; m_rect.setSize(QSizeF(width, height));</code> </pre> <br>  At the finish line, it remained to solve the problem of serializing the page view, including a set of rectangles, into a binary format and reading back from it to transfer the page content to the client and then render it using the same SDK.  Everything turned out to be quite simple here: the standard class of the QT, QDataStream library came to the rescue. <br><br>  <b>In the process of decomposition in solving the problem, the following classes were identified.</b> <br><ul><li>  <i>Fb2Document</i> - FB2 document, the main class, encapsulates the logic of document parsing, pagination, index creation, providing access to an arbitrary page using the generated index, as well as full-text search. </li><li>  <i>Fb2Page</i> - an FB2-document page, encapsulates the logic of filling a page with a set of document lines and rendering a page, defining the sign of the end of a page.  Provides an interface for setting the page size in inches in width and height, as well as indents from the edges of the page. </li><li>  <i>Fb2Word</i> is a word, encapsulates the logic of calculating the word boundaries in inches on the document outline, in accordance with the specified font parameters, serializing the words of the document page to the binary format, reading words from the binary format. </li><li>  <i>Fb2String</i> - a string from a set of words (Fb2Word), encapsulates the logic of filling strings with a list of words, determining the end of a string, aligning the string to the left, right and center, taking into account the line spacing of the document specified in the binary format, reading from strings from binary format. </li><li>  <i>Fb2Image</i> - image, encapsulates the logic of rendering document images, serializing images into a binary format, reading pictures from a binary format. </li><li>  <i>Fb2Index</i> - index, encapsulates the logic of forming the index file and reading from it. </li><li>  <i>Fb2Fragment</i> - a fragment of the FB2-document, represents the main structure of the index file. </li><li>  <i>Fb2Settings</i> - settings file, encapsulates the logic of working with the read / write settings file. </li><li>  <i>Fb2Func</i> - class wrapper, provides a set of SDK functions in accordance with the interface specified when setting the task. </li><li>  <i>Dictionary</i> - class wrapper over a morphological dictionary. </li></ul><br><br><img src="https://habrastorage.org/files/0d3/081/4c3/0d30814c381441e39392352344eb4205.png"><br><br>  The methods of all SDK classes were covered with unit tests to ensure that the FB2 document is paginated correctly, and that the user in the client program sees exactly the same picture when the page is requested, which will be initially rendered on the server side when preparing the index file. <br><br>  As a result, the ultimate goal was achieved.  The advantage of developing an SDK over a boxed solution is flexibility.  The most difficult part is hidden behind the call of simple functions, and the developer using the SDK can make decisions on how to use it: for example, whether to build indexes in advance to ensure the speed of system functions and more comfortable user experience or to build indexes on the first access to the document and the first search engine. request and delete them with rare use to save disk space. <br><br>  To demonstrate the performance of the SDK to the customer, on its basis two Desktop applications were implemented.  FictionBookReader provides the functionality of a primitive FB2 document reader with the ability to paginate and full-text search with highlighted search results. <br><br><img src="https://habrastorage.org/files/308/c8d/51c/308c8d51c81d40da9cdde591a396c084.PNG"><br><br>  FB2SDK Demo clearly shows the functionality of the server and client side of the SDK.  The server side functionality is highlighted in the Server tab, which demonstrates document parsing and the formation of a multi-page index, as well as the formation of files with rectangles and a full-text index.  The client-side functionality is highlighted in the Client tab, which demonstrates the rendering of the document page using the generated binary file. <br><br><img src="https://habrastorage.org/files/0ce/524/eea/0ce524eea33f4cc38a63c3ab29bf187c.PNG"><br><br><img src="https://habrastorage.org/files/918/e10/88c/918e1088ca0849809dafb83ab80acd8c.PNG"><br><br> <a href="http://www.edsd.com/"><img src="https://habrastorage.org/files/398/998/a96/398998a96bd342d18422b1dbb66a271e.jpg" width="400"></a> <br><br>  More projects: <br>  <a href="https://habrahabr.ru/company/edison/blog/273295/">How to create software for a microtomograph for 5233 man-hours</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/282804/">SDK for the introduction of support for e-books in FB2 format</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/232033/">Control access to electronic documents.</a>  <a href="https://habrahabr.ru/company/edison/blog/232033/">From DefView to Vivaldi</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/317290/">We integrate two video surveillance systems: Axxon Next and SureView</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/282848/">More about the development of x-ray tomograph software</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/281765/">Sphere: how to monitor billions of kilowatt-hours</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/256789/">Developing a simple plugin for JIRA to work with a database</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/280550/">To help DevOps: a firmware builder for network devices on Debian for 1008 hours</a> <br>  <a href="https://habrahabr.ru/company/edison/blog/270777/">Windows Service Auto Update for Poor AWS</a> </div><p>Source: <a href="https://habr.com/ru/post/282804/">https://habr.com/ru/post/282804/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282792/index.html">Disconnection of analog satellite TV: 4 years later (part 2)</a></li>
<li><a href="../282794/index.html">Two-headed monster in the world of viruses: GozNym</a></li>
<li><a href="../282798/index.html">Working with MySQL: how to scale the data warehouse 20 times in three weeks</a></li>
<li><a href="../2828/index.html">Internet interviews Grishina</a></li>
<li><a href="../282800/index.html">Russian translation of the speech by Alex Ionescu "Crazy attempt to rewrite Windows from scratch"</a></li>
<li><a href="../282806/index.html">01100100 years since the birth of Claude Shannon</a></li>
<li><a href="../282808/index.html">UDP / TCP File System, Trivial Remote File System</a></li>
<li><a href="../282810/index.html">JPoint 2016 Java Conference Overview</a></li>
<li><a href="../28282/index.html">Open Source Netgear Router</a></li>
<li><a href="../282820/index.html">Google, along with Rackspace, is developing a new type of server on the IBM Power architecture for data centers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>