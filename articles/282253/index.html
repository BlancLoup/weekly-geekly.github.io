<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Solving the problems of organizing business logic in PHP or how to go your own way</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! This is not the first time I've been trying to write this article, but for a long time there has been a desire to share experiences and peop...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Solving the problems of organizing business logic in PHP or how to go your own way</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d16/498/458/d1649845852143279cc7dcb2e48eb7ef.jpg" height="551" width="478" alt="image" align="right">  Hi, Habr!  This is not the first time I've been trying to write this article, but for a long time there has been a desire to share experiences and people have been asking. <br><br>  On Habr√©, there are many articles about various technologies, languages, api, etc., but often programmers in the heat of development forget why all this, below I will try to describe how not to forget about the most important thing when developing. <br><br>  The article will be about how we organized work with business logic in PHP, combining different approaches. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here it will be described how to get away from the problems of PHP frameworks associated with smearing the subject logic on the controller layer. <br><br>  I will not guarantee that the solutions presented are some kind of silver bullet, all of the following is just one of the options for approaching the solution of common problems.  There are both pros and cons and this approach copes with its main task. <br><a name="habracut"></a><br><h2>  <font color="#0071c5">A little bit about how to work with business logic in popular PHP frameworks</font> </h2><br><br><h3>  Ordinary situation </h3><br>  If we look at the most popular frameworks, the MVC architectural pattern is taken as the basis for them.  There are no tools for organizing business logic as such, but for creating simple crud everything is there. <br><br>  The standard situation that we see in most cases is an anemic model, for example, when the class UserModel is just a set of attributes and does not contain any logic.  Business logic is contained in the controller layer. <br><br>  Controllers are transformed into something between a Transaction Script and Service Layer in the Domain Model.  They validate the input data, obtain model entities from the database, and implement the business logic of these entities. <br><br>  I am not saying that this is wrong, in some cases this is a self-justifying approach.  When it is worth developing without any complex architecture for business logic: <br><br><ol><li>  With simple business logic </li><li>  To create mvp </li><li>  When prototyping </li></ol><br>  If you do not have such a situation, then you should think about the architecture and the place of business logic in this architecture. <br><br><h3>  Complex business logic </h3><br>  If the business logic is complex enough, then there are two standard solutions: <br><br><h4>  Transaction script </h4><br>  To separate business logic from the framework, it is worth making it into separate entities.  Using Transaction Script we can create a large set of scripts that handle specific user requests. <br><br>  For example, if you need to upload a photo, you can create a photo upload script.  It can be programmatically separated into a separate class: <br><br><div class="spoiler">  <b class="spoiler_title">PhotoUploadScript</b> <div class="spoiler_text">  class PhotoUploadScript <br>  { <br>  public function run () <br>  { <br>  / * implementation of photo upload script * / <br>  } <br>  } </div></div><br>  I advise you to read more about this approach in the book "Architecture of corporate software applications", it describes all its pros and cons. <br><br><h4>  Domain Model </h4><br>  When implementing the Domain Model, things get significantly more complicated.  It is necessary to think over business logic and select entities with clearly shared responsibility.  There are many pitfalls here, this is how to organize the facade for the domain and how to avoid creating an application with a ball of connections between business entities, etc. <br><br>  In the book ‚ÄúArchitecture of corporate software applications‚Äù it is proposed to introduce a Service Layer layer which will serve as the business logic interface and will consist of several services grouped by common functionality (for example, UserService, OrderService, etc.). <br><br>  This approach is described in more detail in the books ‚ÄúArchitecture of corporate software applications‚Äù and also the whole book ‚ÄúObject-Oriented Design (DDD)‚Äù is devoted to it, which I personally highly recommend reading. <br><br><h2>  <font color="#0071c5">our story</font> </h2><br><h3>  How it all began </h3><br>  In 2014, it was decided to start a project and the question arose of the choice of language, technology, libraries, etc. <br><br>  The choice fell on PHP, but it was decided to abandon the use of existing frameworks.  The basis was taken old work and decided to give her a new life in a new guise. <br><br>  In our organization, we understand the importance of such things as testing, business logic, design patterns, etc., which is why it was decided to write a tool controlled by us and allowing PHP to work with business logic. <br><br><h2>  <font color="#0071c5">Architecture, dictionary</font> </h2><br>  The basis was a multi-layered architecture.  If we consider a very general and enlarged scheme, then it is possible to select 3 layers: <br><br><img src="https://habrastorage.org/web/33f/149/63a/33f14963a9994a67b93c5604fa73e9ae.png"><br><br>  Something was taken from the ‚ÄúBig Blue Book‚Äù on DDD, something from the book ‚ÄúThe Architecture of Corporate Software Applications,‚Äù and all of this was reworked, if necessary, to fit our needs. <br><br><h4>  Interface </h4><br>  Interface is in our case the layer responsible for access to the subject area from the outside world. <br>  We currently have 2 types of interface: <br><br>  <b>The API</b> is a RESTful api consisting of a View and a Controller. <br><br>  <b>CLI</b> is an interface for invoking business logic from the command line (for example, cron tasks, workers for queues, etc.). <br><br><h5>  View </h5><br>  This part of the Interface layer is very simple, since our PHP projects are an API only and do not have a user interface. <br><br>  Accordingly, there was no need to include work with template engines, we just give the view as json. <br><br>  If necessary, this functionality can be expanded, add support for template engines, enter different response response formats (for example, xml), but we do not yet have such needs.  This simplification allowed us to devote more time to more important parts of the architecture. <br><br><h5>  Controller </h5><br>  Controllers should not contain any domain logic.  The controller simply receives the request from the router and calls the appropriate model interface with the request parameters.  He can do some small transformation to communicate with the model, but there is no business logic in it. <br><br><h4>  Model </h4><br>  In the model layer, a basic set of entities was selected on which practically any subject area can be deployed without breaking its isolation from other parts of the architecture. <br><br>  It was allocated 3 main generalized elements of the model: <br><br>  <b>Entity</b> is an entity with a set of characteristics in the form of a list of parameters and with behavior in the form of functions. <br>  <b>Context</b> is a script within which entities interact. <br>  <b>Repository</b> is an abstraction for storing an Entity. <br><br><h4>  Storage </h4><br>  In the Storage layer, we simply have a set of mappers that know how to save which entity from the model to the base, or load from the base. <br><br><h2>  <font color="#0071c5">Detailed theory</font> </h2><br><br><h3>  View controller </h3><br>  This part of the platform organizes an API interface for business logic from the outside.  It consists of many elements, but for understanding it is possible to describe several: <br><br>  <b>Router</b> - http router requests to the corresponding controller method (everything is standard). <br><br>  <b>View</b> is essentially a converter of responses from the model transmitted as ValueObjet (here we, too, do not give the view a lot of knowledge about the business logic) in json.  Although in the classic MVC view it receives updates from model directly, we do this through the Controller. <br><br>  <b>Controller</b> is a layer hiding the interfaces of the model.  The controller converts the http request to the input parameters for the model, calls the model script, gets the result of the execution and returns its View for display. <br><br>  This part does not contain any business logic and does not change during the project unless you need to create new API interfaces.  We do not inflate the layer of controllers, leaving them compact and simple. <br><br><h3>  Model </h3><br>  And now let's talk about the most important and valuable element, encompassing business logic. <br>  Let us consider in more detail the main elements of the model: Entity, Context and Repository. <br><br>  <b>Entity</b> <br><div class="spoiler">  <b class="spoiler_title">Abstract class entity</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $_privateGetList = []; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $_privateSetList = [ <span class="hljs-string"><span class="hljs-string">'ctime'</span></span>, <span class="hljs-string"><span class="hljs-string">'utime'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $ctime; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $utime; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id == <span class="hljs-number"><span class="hljs-number">0</span></span>? $id: <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;id; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCtime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ctime; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUtime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;utime; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $name, $arguments)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( strpos( $name, <span class="hljs-string"><span class="hljs-string">"get"</span></span> ) === <span class="hljs-number"><span class="hljs-number">0</span></span>) { $attrName = substr( $name, <span class="hljs-number"><span class="hljs-number">3</span></span>); $attrName = preg_replace_callback( <span class="hljs-string"><span class="hljs-string">"/(^[AZ])/"</span></span>, create_function( <span class="hljs-string"><span class="hljs-string">'$matches'</span></span>, <span class="hljs-string"><span class="hljs-string">'return strtolower($matches[0]);'</span></span>), $attrName); $attrName = preg_replace_callback( <span class="hljs-string"><span class="hljs-string">"/([AZ])/"</span></span>, create_function( <span class="hljs-string"><span class="hljs-string">'$matches'</span></span>, <span class="hljs-string"><span class="hljs-string">'return \'_\'.strtolower($matches[0]);'</span></span>), $attrName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !in_array( $attrName, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_privateGetList)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;$attrName; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( strpos( $name, <span class="hljs-string"><span class="hljs-string">"set"</span></span> ) === <span class="hljs-number"><span class="hljs-number">0</span></span>) { $attrName = substr( $name, <span class="hljs-number"><span class="hljs-number">3</span></span>); $attrName = preg_replace_callback( <span class="hljs-string"><span class="hljs-string">"/(^[AZ])/"</span></span>, create_function( <span class="hljs-string"><span class="hljs-string">'$matches'</span></span>, <span class="hljs-string"><span class="hljs-string">'return strtolower($matches[0]);'</span></span>), $attrName); $attrName = preg_replace_callback( <span class="hljs-string"><span class="hljs-string">"/([AZ])/"</span></span>, create_function( <span class="hljs-string"><span class="hljs-string">'$matches'</span></span>, <span class="hljs-string"><span class="hljs-string">'return \'_\'.strtolower($matches[0]);'</span></span>), $attrName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !in_array( $attrName, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_privateSetList)) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;$attrName = $arguments[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !in_array( $name, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_privateGetList)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;$name; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $name, $value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !in_array( $name, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_privateSetList)) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;$name = $value; } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> get_called_class(); } }</code> </pre> <br></div></div><br>  Entity is entities of the domain, for example, a user, an order, a car, etc.  All such entities may have parameters: ID, registration time, price, speed.  We provide the work with parameters in the base class Entity, and the behavior is already defined by the developer in the heirs classes. <br><br>  The parameter list is also needed to save Entity to the database, but the model does not know anything about this saving.  At the infrastructural level, there are mappers who know how to save entities of the model to the base. <br><br>  The identifier of the Entity in our platform is a basic parameter, it allows you to uniquely identify different entities within the same class of objects. <br><br>  More you can say that our Entity is very similar to Entity, which is described in the book by Eric Evans. <br><br>  As stated in Evans, the identification of the object in software systems is one of the most important tasks.  Also Evans specifies that identification is achieved not only due to the same attributes of objects. <br><br>  What can be considered characteristics that can identify an object in the software system: attributes, object class, behavior.  In the development of our Entity, we just repelled from these characteristics. <br><br>  Attributes can be different depending on the entity, but we identified the identifier in the base as inherent to almost everyone.  We set the object class due to OOP and the inheritance of the development language provided to us.  Behavior is defined by methods for each class. <br><br>  <b>Context</b> <br><br><div class="spoiler">  <b class="spoiler_title">Abstract class context</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $_property_list = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( \foci\utils\PropertyList $property_list)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_property_list = $property_list; } <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> get_called_class(); } }</code> </pre><br></div></div><br>  Context is the script within which Entity interacts.  For example, ‚ÄúUser Registration‚Äù has a separate context, and the work of this context looks like this: <br><br><ol><li>  We start a context and we transfer it parameters for registration.  At the input context gets a list of simple parameters (int, string, text, etc.). </li><li>  Validation of parameters validity.  Validation here for the domain, we do not check http requests here. </li><li>  Create user. </li><li>  Saving user.  This is also part of the domain, the main thing is that it is abstracted from where and how we save this user.  Here, for the abstraction of conservation, we use Repositories. </li><li>  Sending by mail notifications. </li><li>  Return the results of the execution context.  To return the result, there is a special class ContextResult which contains a sign of the success of the execution of the context and either data with the results or a list of errors.  (at the level of view-controller, model errors are translated into http errors) </li></ol><br>  Context is almost pure Transaction Script, but with some exceptions.  Fowler gives an example of implementing business logic through Transaction Script or Domain Model.  When using the Domain Model, he recommends using the Service Layer in which services are created on the basis of common functionality (for example, UserService, MoneyService, etc.).  In our case, Transaction Script can act in the same Service Layer if you do not make model entities anemic. <br><br>  For example, a set of user-related contexts (UserRegContext, UserGetContext, UserChangePasswordContext, etc.) with a non-anemic user is almost equivalent to a UserService (Service Layer).  We have contexts that take on a lot of business logic and they can be considered Transaction Script, but there are contexts that just call some kind of Entity functionality and then the whole business logic is hidden from the context and then they are closer to the Service Layer. <br><br>  From here, in cases with complex business logic, you can either make the DDD system pure or the system, or you can organize the logic through Transaction Script if the business logic is not so complicated and consists of standard scripts to create, query, update, etc. <br><br>  <b>Repository</b> <br><br><div class="spoiler">  <b class="spoiler_title">Generic repository class</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Repository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( \foci\model\Entity &amp;$entity)</span></span></span><span class="hljs-function"> </span></span>{ $result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_mapper-&gt;insert( $entity); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( \foci\model\Entity &amp;$entity)</span></span></span><span class="hljs-function"> </span></span>{ $result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_mapper-&gt;update( $entity); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( \foci\model\Entity &amp;$entity)</span></span></span><span class="hljs-function"> </span></span>{ $result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_mapper-&gt;deleteById( $entity-&gt;getId()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; } }</code> </pre> <br></div></div><br>  Repositories are an abstraction of business logic for organizing save / delete / update / search for entities in the database.  Specific repositories work with specific entities, for example, the UserRepository works with User. <br><br><h3>  Data storage </h3><br>  Data storage is done using mappers.  There is a generalized Mapper class that contains the basic functionality for working with Entity. <br><br><div class="spoiler">  <b class="spoiler_title">Generic Mapper Class</b> <div class="spoiler_text">  abstract class mapper <br>  { <br>  protected $ _connection; <br>  protected $ _table; <br><br>  function __construct (Connection $ connection) <br>  { <br>  $ this -&gt; _ connection = $ connection; <br>  } <br><br>  abstract protected function _createEntityFromRow ($ row); <br><br>  abstract public function insert (\ foci \ model \ Entity &amp; $ entity); <br>  abstract public function update (\ foci \ model \ Entity &amp; $ entity); <br>  abstract public function delete (\ foci \ model \ Entity &amp; $ entity); <br><br>  public function getTableName () <br>  { <br>  return $ this -&gt; _ table; <br>  } <br>  } </div></div><br>  For specific entities, they create their own specific mappers that know how to save this entity into the database, how to load it from the database, how to delete it (although actually deleting something from the database is bad practice, so in most cases we just mark it as deleted) and change. <br><br>  Thus, if we have a class User in the model, then the UserMapper class is created in accordance with it.  The logic of working with the database is rendered in a separate layer and can be easily replaced if necessary. <br><br>  Model entities don't know anything about mappers, but mappers, on the contrary, everyone knows about their model entities. <br><br><h3>  Generalized schema </h3><br><div class="spoiler">  <b class="spoiler_title">Big picture</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/177/684/622/177684622a70453b99e3f3a13789c6ad.png" alt="image"><br></div></div><br>  A very general structure of classes of our platform is painted here, many small less important classes are omitted. <br><br>  As you can see, only this basic structure contains quite a few elements.  In a specific project, to all this, a multitude of classes of contexts, entities, repositories, and mappers that implement specific business tasks will be added. <br><br>  Config and PropertyList on the diagram are utilitarian entities that are used by all. <br><br><h2>  <font color="#0071c5">A little practice (just a little bit)</font> </h2><br>  The theory is good, but let's consider how to put all this into practice.  Suppose we have a task to make an application for personal financial accounting.  Approximate glossary of terms (I will not paint definitions, everything is simple here): Money, Budget, User, Product, Service, Calendar <br><br>  Next, make a couple of user scenarios, take something non-standard, for greater clarity.  Purchase of goods - we will assume that the purchase for us is just a fact of a one-time debit.  Setting the payment service on the calendar - it will be a regular debit with a description. <br><br>  Select entities: Money, Budget, User, Product, Service, Calendar. <br>  Select 3 contexts according to user scripts: <br><br>  The first context is simply the purchase of goods. <br><br><h4>  BuyOrderContex </h4><br><ol><li>  We receive User from base on input data (for example on a token) </li><li>  Get or create a new Product </li><li>  Say Budget to install a Product purchase for a specified amount of Money </li></ol><br>  Then everything is more complicated, the second user script is divided into 2 contexts, in the first we set when to write off the money, and in the second we make the write-off itself. <br><br><h4>  SetSchedulePayForServiceContext </h4><br><ol><li>  We receive User from base on input data (for example on a token) </li><li>  Get or create a new Service </li><li>  Install in the Calendar a debit for the Service on a given date </li></ol><br><h4>  SchedulePayForServiceContext </h4><br><ol><li>  Whether we look in the Calendar, is there a charge for the current time? </li><li>  We load Service for which it is necessary to write off money </li><li>  We write off money for the service </li></ol><br>  Already in this small example, some advantages and disadvantages of this approach are visible (for example, duplication of logic in different contexts, this is well written in the book ‚ÄúArchitecture of corporate software applications‚Äù). <br><br><h2>  <font color="#0071c5">Conclusion</font> </h2><br><h3>  Our practices </h3><br><h4>  Separation of functionality </h4><br>  Breaking the entire application into contexts makes it easy to distribute it to different servers. <br>  For example, we have contexts associated with the registration of users, it is easy to take this whole group and transfer it to another server without disrupting the work of the rest of the application. <br><br><h4>  Context causes context </h4><br>  A context can invoke a context, and so it is possible to build complex chains.  This technique is used very rarely.  Such an approach also has many pitfalls in it, so there are plans to ban such use. <br><br><h4>  Cron task </h4><br>  Context as a unit of execution allows you to call it from anywhere.  The logic of running contexts as cron tasks is based on this. <br><br><h4>  SPA </h4><br>  One of our projects is a website in which the client part is completely written in JavaScript and through RESTfull api interacts with the server part in PHP.  We didn‚Äôt even plan to do this when we started development, but this opportunity to build SPA applications with our platform as a server turned out to be very convenient. <br><br><h3>  Testing </h3><br>  All code is covered by tests.  We use 2 types of tests: <br><br><ol><li>  Unit tests, for example for classes like Config </li><li>  Acceptnce tests, for requests to our api. </li></ol><br><h3>  Plans </h3><br><ol><li>  We very much miss the wider distribution of our development.  Everything is written exclusively for internal use and it imposes its disadvantages. </li><li>  Not enough running in high-load projects.  We already have several working commercial projects, but they cannot be called high-loaded. </li><li>  The logic of working with the transaction so far we have not much thought out.  At this point, we currently have a slight violation of the encapsulation model.  In the future, it is planned to introduce Unit Of Work for abstraction from database transactions. </li><li>  Testing mainly covers api, in plans to make context testing.  So it will be possible to test the domain in isolation. </li></ol><br><h3>  What we got in the end </h3><br><ol><li>  A flexible platform to create an application with a clear separation of business logic from infrastructure. </li><li>  Fully controlled development and it gives a lot of advantages in solving technical problems of controversial issues. </li><li>  An architecture based on well-known design patterns that allows new developers to quickly get involved in a project. </li><li>  Vast experience in application of proven approaches in design, which are often forgotten in new projects and do not seek to use them in existing ones. </li></ol><br><h3>  findings </h3><br>  In general, we are satisfied with the result of the work done.  The written platform solves our problems.  It allows you to flexibly implement business logic, which greatly simplifies development.  There are many plans for improvement and expansion. <br><br>  PS: If such an approach to solving a problem with a subject area in PHP frameworks will be of interest to the community, then we may well get ready and prepare open source. <br><br>  PSS: I immediately anticipate phrases to the account of why you need a bicycle, if you already have everything.  I see no reason to argue about this, this is our approach and it worked. <br><br>  PSS: I also anticipate questions, why do Transaction Script and Domain Model incest, and why not do it and not get a flexible tool for solving business problems. </div><p>Source: <a href="https://habr.com/ru/post/282253/">https://habr.com/ru/post/282253/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282243/index.html">Joomla Licensing FAQ</a></li>
<li><a href="../282245/index.html">Friday gamedev: good videos on how to make games</a></li>
<li><a href="../282247/index.html">Security Week 16: hacking a mouse from 225 meters, a cryptographic detector on Mac OS X, a million dollars for hacking an iPhone</a></li>
<li><a href="../282249/index.html">Easter eggs for Easter</a></li>
<li><a href="../282251/index.html">Hub 2.0: a link for JetBrains team products</a></li>
<li><a href="../282257/index.html">Generator iterator in promis or CryptoPro integration browser plugin</a></li>
<li><a href="../282259/index.html">Windows migration experience On Linux / Unix. Part 2</a></li>
<li><a href="../282261/index.html">Tinkoff Bank. Hackathon "Era Bots"</a></li>
<li><a href="../282263/index.html">Persistent OS: nothing is blocked</a></li>
<li><a href="../282265/index.html">Creating super-long flat panoramic images from video</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>