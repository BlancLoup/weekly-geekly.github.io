<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we do World of Warships: export automation and content verification</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After the premiere closed World of Warships shows at gamescom and Igromir, the official launch of the game is getting closer and closer. Now closed al...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we do World of Warships: export automation and content verification</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/c04/35c/715/c0435c715731fe372ddca2675dff53e9.jpg" alt="image"><br><br>  After the premiere closed World of Warships shows at gamescom and Igromir, the official launch of the game is getting closer and closer.  Now closed alpha testing is in full swing, and we, the <a href="http://blog.worldofwarships.ru/">developers of Lesta Studio</a> , St. Petersburg division of Wargaming, still have a whole bunch of questions to solve.  At the same time a lot of obstacles still managed to leave behind.  Below is a story about how we adapted the exporter of our engine to the needs of "Ships" and lined up the content verification process. <br><br><a name="habracut"></a><h4>  Standard engine delivery </h4><br>  Any engine includes a toolkit for the exporter of 3D-models from 3D-editors in its own data format.  Our BigWorld, on the basis of which World of Tanks is made, is no exception.  It supports export from 3D Max and Maya.  Virtually any game project requires the adaptation of standard exporters to the specifics of the project.  In our project, the specifics are the models of ships. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first version of an adapted exporter from Maya simply ‚Äúrecruited‚Äù him to recognize the more complex structure of the ship scene.  A little Python control code was added to the existing C ++ code, as well as a plugin for Maya with a UI on wxWidget.  It looked like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/be3/bb5/54e/be3bb554e081a9c29afcd8008749cdc0.png" alt="image"><br>  <i>UI adapted exporter</i> <br><br>  The resulting tool had a lot of flaws. <br><br>  The export could be carried out only with the participation of the user who was supposed to "tell" the exporter what the scene contains.  The use of this tool in the automation of various processes, for example, automatic verification of content at the assembly stage of the distribution, was out of the question. <br><br>  The exporter demanded knowledge of far from obvious parameters from the user, worked slowly, practically did not support scene verification, and also required a huge amount of resources for support. <br><br>  Architecture was a major issue for future functionality.  The export was actually an atomic operation (a set of spaghetti functions) that translated data from one structure (loaded Maya scene) to another structure (BigWorld) directly into physical files.  When serializers and business logic are implemented ‚Äúin monolith‚Äù, and the data model is simply missing, it is impossible to add data processing (pre / post-processing), as well as reuse (code reuse) serializers and data model in other tools that implement their own business. -logics.  It was impossible to build more complex content production processes. <br><br>  Over time, it became almost impossible to build up new functionality in the existing code.  It was decided to rewrite the exporter from scratch, laying in it a new architecture. <br><br><h4>  Harsh weekdays </h4><br>  The level of our project has increased the requirements for quality, complexity and volume of content.  Over the past couple of years, our studio has grown a lot.  We have the opportunity to allocate a sufficient amount of resources for tasks related to the production of content.  Professionals came to us who have a great background in architecture development, C ++ / C # technologies.  At the same time, for exporter‚Äôs developers, this was the first experience of using Python and Maya API.  This introduced additional risks that had to be taken into account. <br><br>  We estimated the exporter refactoring at two to three man-months.  Without optimism in gamedev can not be. <br><br>  To the risks we attributed: <br><br>  ‚Ä¢ lack of formal requirements; <br>  ‚Ä¢ Python proficiency; <br>  ‚Ä¢ Maya API complexity; <br>  ‚Ä¢ refactoring of primitive processing algorithms. <br><br>  A lot of actual time was spent collecting requirements from non-formalized sources, such as developers, who became managers, old-timers, torsion fields, and the code of an existing exporter.  These nuggets of knowledge were formalized and recorded in the form of requirements, specifications, and UML diagrams in Confluence. <br><br>  The first prototypes showed the need to use the concept of namespaces and Python modules (__init__.py).  Also, a mechanism was developed that allows using the functionality from the C ++ libraries (.pyd) transparently. <br><br>  On the complexity and intricacies of the Maya API, you can write a separate book.  Any functionality required prototyping, consultations with 3D-artists and with the developers of the engine (rendering). <br><br>  The standard exporter had its own implementation of a large number of algorithms, for example, polyangulation triangulation, calculation of nested nodes transformation matrices, etc.  We abandoned them in favor of using Maya API, which greatly increased the exporter‚Äôs performance. <br><br>  It‚Äôs time for the laws of Murphy to add a rule that any project you have in mind will necessarily be implemented within no more than "x3" from the planned one, if you don‚Äôt give it up. <br><br>  The result was worth our effort.  In the end, even our main artist responsible for exporting models, after a couple of months of operation, found our exporter "almost perfect." <br><br><h4>  Look under the hood </h4><br>  Our studio actively uses Python scripts.  We tried to implement on it and the whole exporter.  Naturally, Python is not suitable for processing large binary data such as vertex containers (vertex buffer), vertex index containers (index buffer), etc. The data model and serializers of similar containers were implemented in C ++ as a library (.pyd) which naturally fit into the Python data model.  All business logic was implemented in Python. <br><br>  The exporter's framework was planned to be used not only for the task of ‚Äúmanual‚Äù export from Maya, but also for any tasks where its functionality could be reused, for example, to automate content verification.  From any developed toolkit, we require the presence of interfaces (API) for Python, the command line (command line) and the UI tools. <br><br><h4>  Architecture </h4><br>  The architecture of the exporter framework is modular, layered.  There are physical and logical layers, as well as a domain layer.  Each layer contains separate modules: a data model, business logic, serializers, as well as converters that can convert the data model of one layer into the data model of another layer.  Physical and logical layers actually implement an analogue of the ORM-architecture. <br><br>  The architecture of the domain layer is designed for convenient processing of the data model by business logic.  It is completely isolated and does not contain any assumptions about how it will be serialized into physical storage. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b07/3f5/b71/b073f5b71d30754b70a6909b4af543ca.jpg" alt="image"><br>  <i>Exporter Layered Architecture</i> <br><br><h4>  Export process </h4><br>  Layered architecture introduces certain features of the export process.  In fact, we will deserialize two (or more) models from various sources (Maya and BigWorld Engine).  After this, merge of these models into one new one takes place.  Next, the new model is serialized in the BigWorld-Engine-format. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ef1/0d8/13a/ef10d813ab22fea71f8c20de8be6b21d.jpg" alt="image"><br>  <i>Export process</i> <br><br><h4>  Flexibility of content production </h4><br>  The implemented architecture allows you to simply build complex processes of content production.  For example, our ship‚Äôs primary model technologically consists of three separate Maya scenes, each of which is simultaneously being developed by different departments: <br><br>  ‚Ä¢ The first scene contains a visual model and a collision model. <br>  ‚Ä¢ The second scene contains a <a href="http://blog.worldofwarships.ru/ballistics_part_2/">ballistic model</a> (ballistic model). <br>  ‚Ä¢ The third contains effect ports. <br><br>  In addition to this, the engine toolkit (editors) adds (edits) its own data in the derived engine format model (fourth scene). <br><br>  The exporter easily solves the nontrivial task of combining all four scenes into one resulting ship model. <br><br><h4>  Content verification </h4><br>  The content verification system allows us to search for content errors both in each layer (source) separately, and in the resulting content.  The number of verifiers now reaches several dozen.  Automatic content verification is built into the distribution build process (build), which makes it possible to eliminate the human factor as much as possible and ensure the integrity and technical purity of the content. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3f0/2bf/b70/3f02bfb7082ea807e96bdee9468b7a61.jpg" alt="image"><br>  <i>Maya ship model verification example</i> <br><br><h4>  Content budgets and duck in the bathroom </h4><br>  An important component of the content verification process is the verification of budgets, for example, verification of polygon budget.  The figure below shows, in particular, information on the number of triangles for a visual model for each model: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/12c/d23/3ce/12cd233ceab42504732eeeadd9cd7062.jpg" alt="image"><br>  <i>Maya ui plugin</i> <br><br>  A vivid illustration of the need for such verification is a bike, told to me by colleagues about a previous project.  On the map there was an area built up with non-destructible houses.  As soon as the camera turned its attention to this area, the FPS immediately fell wildly.  After studying the problem, it turned out that inside one of the houses there was a bath in which a small ‚Äúplastic‚Äù duck swam.  All this would have looked like an amusing prank of artists, if it were not for the fact that the duck's model contained about a million polygons. <br><br>  In practice, it is very difficult to comply with the budget value.  Many models are objectively exceptions.  Setting the budget value in the form of a range also does not solve the problem, since with time polygonage models simply begin to strive for the upper value of the range.  In our case, we plan to change the personal budgets of those models that do not match the standard budget of this type of model. <br><br><h4>  Content processing </h4><br>  At each export stage, processing (pre / post-processing) is required.  For example, before converting the Maya layer's logical data model into the domain model for air defense guns, a preliminary rotation of the cannon skeleton by 45 degrees along the Y axis and removal of the skeleton is required.  Our architecture allowed us to transparently embed various processing at any stage of export. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6fb/176/76f/6fb17676f81ec0f8a06f4502c7dde308.jpg" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/bb6/cd1/4c8/bb6cd14c8bf9ee7551b11fb8740cd046.jpg" alt="image"><br>  <i>An example of a model before and after pre-processing</i> <br><br><h4>  X64 support </h4><br>  Quite recently, our artists massively switched from 32-bit Maya 2012 to 64-bit Maya 2014. Since the exporter is almost entirely written in Python, we have almost no problems with x64 support.  Only the library (.pyd) implemented in C ++ required a bit of "shamanism". <br><br>  Now the exporter can be easily used in both x32 and x64 processes, since it defines and loads the required C ++ library build (.pyd). <br><br><h4>  Card verification </h4><br>  In developing the exporter's architecture, we could not have guessed in advance in which other tools and automations it would be possible to reuse it.  Automation of card verification is an example of how the ‚Äúright‚Äù exporter architecture found its application in another tool. <br><br>  Card verification builds and verifies the dependency graph of a map from other objects located on it.  In particular, the map uses visual models of the landscape (stones, icebergs), buildings (houses, hangars, jetties), equipment (airplanes, boats), etc. <br><br>  The peculiarity of the card verifier is that it can verify not only the presence of files of these visual models, but also the models themselves using the exporter's framework.  This made it possible to eliminate the human factor when the Map Development Department (LA) has to ‚Äútake a word for it‚Äù from the 3D Model Development Department (3D Art), which uses technically correct models. <br><br><h4>  Build distributive </h4><br>  The exporter framework has found its application in the process of preparing the content pack for the distribution.  The distribution kit should not get models that: <br><br>  ‚Ä¢ are no longer used; <br>  ‚Ä¢ are still under development; <br>  ‚Ä¢ intended for future versions of the product. <br><br>  According to the basic list of game objects (root game objects) it is required to build a dependency graph, which will form a complete list of the required content.  There is nothing easier than deserializing a model with the exporter framework and ‚Äúfinding out‚Äù what other models will need (content references). <br><br><h4>  Results </h4><br>  The history of the development of our exporter showed how from a simple highly specialized tool it evolved into a powerful system that solves its immediate tasks, and also found application in other content production processes.  The basis of its successful development and reuse is a modular architecture that allows you to use its individual "cubes" to build other systems. <br><br>  In the near future, the exporter will have another test related to the change of the BigWorld Engine file format.  We are sure that the embedded architecture will not experience any difficulties and will be able to support the work both with the existing and with the new file format. </div><p>Source: <a href="https://habr.com/ru/post/241083/">https://habr.com/ru/post/241083/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../241065/index.html">Scale your hosting on a new level with ISPmanager 5 Business</a></li>
<li><a href="../241069/index.html">Online course ‚ÄúData Visualization. Basics</a></li>
<li><a href="../241073/index.html">Feedback 2014-2015!</a></li>
<li><a href="../241079/index.html">Examine databases using T-SQL</a></li>
<li><a href="../241081/index.html">Batniki against exploits (version for Windows XP)</a></li>
<li><a href="../241085/index.html">Development of 3D games for Windows 8 using C ++ and Microsoft DirectX</a></li>
<li><a href="../241087/index.html">Veeam announces free utility for backup of physical machines and servers</a></li>
<li><a href="../241089/index.html">Mobile applications for web developers</a></li>
<li><a href="../241095/index.html">Git as subversion</a></li>
<li><a href="../241099/index.html">How to make profitable design development sites (part 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>