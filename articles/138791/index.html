<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostGIS + Mapnik + TileCache on FreeBSD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! There is a need on one of the servers in our network to do ‚Äúsomething like openstreetmap.org‚Äù, but so that it all continues to work without bei...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostGIS + Mapnik + TileCache on FreeBSD</h1><div class="post__text post__text-html js-mediator-article">  Hello!  There is a need on one of the servers in our network to do ‚Äúsomething like openstreetmap.org‚Äù, but so that it all continues to work without being connected to the Internet. <br>  Unfortunately, I did not find a good manual on the ‚ÄúGreat and Mighty‚Äù about how to implement it, so after spending two days on it, I decided to tell about how I did it. <br><a name="habracut"></a><br><h5>  What was given: </h5><br><ul><li>  FreeBSD 8.2 </li><li>  PostgreSQL 8.4.9 </li><li>  Apache 2.2 </li><li>  Python 2.7.2 </li></ul><br>  In general, there are many options for how to implement the required, but I decided to stop at this set of tools: <br><ul><li>  <a href="http://postgis.refractions.net/">Postgis</a> </li><li>  <a href="http://mapnik.org/">Mapnik</a> </li><li>  <a href="http://tilecache.org/">TileCache</a> </li></ul><br><br><h5>  Installation </h5><br>  <b>1. We put PostGIS</b> <br>  There were no problems with this, it is in ports, namely <code>/usr/ports/databases/postgis</code> <br>  After installation, you need to go to the <code>/usr/local/share/postgis/contrib/postgis-1.5</code> folder and execute postgis.sql and spatial_ref_sys.sql there using the psql utility <br>  <b>2. We put Mapnik</b> <br>  He himself is also in the ports: <code>/usr/ports/graphics/mapnik</code> <br>  After installation, you need to download the necessary utilities, here: <br>  <a href="http://svn.openstreetmap.org/applications/rendering/mapnik/">svn.openstreetmap.org/applications/rendering/mapnik</a> (which ones we will need will be described below). <br>  <b>3. We put TileCache</b> <br>  TileCache is still easier - download the archive from here <a href="">tilecache.org/tilecache-2.11.tar.gz</a> . <br><h5>  Customization </h5><br>  Naturally, the setting is much more fascinating than the installation! <br>  To begin with, I will explain in the picture how it should work: <br><img src="https://habrastorage.org/getpro/habr/post_images/0d4/979/8cb/0d49798cb22dc6304328ba2826855f2f.png" alt="image"><br><br>  So.  First you need to get the osm file.  There are many options for this, for example, export directly from <a href="http://openstreetmap.org/">openstreetmap.org</a> (however, there are restrictions on the size of the area) or <br>  download already ready export, for example from here: <a href="http://gis-lab.info/projects/osm_dump/">gis-lab.info/projects/osm_dump</a> <br>  This file must now be loaded into the PostGIS database, with a command like <br> <code>osm2pgsql -U user RU-SPE.osm</code> <br>  where user is the login to the database, and RU-SPE.osm is the map to download.  In my case, this is a map of St. Petersburg. <br>  The console output should be something like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>osm2pgsql SVN version 0.80.0 (32bit id space) <br> <br> Using projection SRS 900913 (Spherical Mercator) <br> Setting up table: planet_osm_point <br> Setting up table: planet_osm_line <br> Setting up table: planet_osm_polygon <br> Setting up table: planet_osm_roads <br> Mid: Ram, scale=100 <br> <br> Reading in file: RU-SPE.osm <br> Processing: Node(1767k 176.7k/s) Way(264k 18.88k/s) Relation(7314 1828.50/s) parse time: 28s <br> <br> Node stats: total(1767355), max(1633105798) in 10s <br> Way stats: total(264350), max(150391691) in 14s <br> Relation stats: total(7314), max(2024096) in 4s <br> <br> Writing way (264k) <br> <br> Writing relation (7314) <br> Committing transaction for planet_osm_point <br> Sorting data and creating indexes for planet_osm_point <br> Committing transaction for planet_osm_roads <br> Sorting data and creating indexes for planet_osm_roads <br> Committing transaction for planet_osm_line <br> Sorting data and creating indexes for planet_osm_line <br> Committing transaction for planet_osm_polygon <br> Sorting data and creating indexes for planet_osm_polygon <br> Indexes on planet_osm_roads created in 0s <br> Completed planet_osm_roads <br> Indexes on planet_osm_point created in 3s <br> Completed planet_osm_point <br> Indexes on planet_osm_line created in 4s <br> Completed planet_osm_line <br> Indexes on planet_osm_polygon created in 6s <br> Completed planet_osm_polygon <br> <br> Osm2pgsql took 48s overall</code> <br> <br>  If there are no errors, then go further. <br><br>  Now we need the borders and coastline of the whole world - this will be the substrate for our map.  If this is not done, the substrate will be just one color. <br>  To keep everything in one place and in order, create a folder / mapnik / in your home directory. <br>  Now we move there and load these boundaries there, for this we use the commands: <br><br> <code><a href=""></a> <a href=""></a> <a href=""></a> <a href="http://www.naturalearthdata.com/"></a> <a href="http://www.naturalearthdata.com/"></a> wget tile.openstreetmap.org/world_boundaries-spherical.tgz <br> tar xvzf world_boundaries-spherical.tgz <br> wget tile.openstreetmap.org/processed_p.tar.bz2 <br> tar xvjf processed_p.tar.bz2 -C world_boundaries <br> wget tile.openstreetmap.org/shoreline_300.tar.bz2 <br> tar xjf shoreline_300.tar.bz2 -C world_boundaries <br> wget www.naturalearthdata.com/http//www.naturalearthdata.com/download/110m/cultural/110m-admin-0-boundary-lines.zip <br> unzip 110m-admin-0-boundary-lines.zip -d world_boundaries <br> wget www.naturalearthdata.com/http//www.naturalearthdata.com/download/10m/cultural/10m-populated-places.zip <br> unzip 10m-populated-places.zip -d world_boundaries</code> <br> <br>  Above, I promised to tell which utilities from <a href="http://svn.openstreetmap.org/applications/rendering/mapnik/">svn.openstreetmap.org/applications/rendering/mapnik</a> we would need. <br>  So, we will need: <br>  generate_xml.py (Most likely you will have to edit the file, and replace the import mapnik with import mapnik2 as mapnik) <br>  osm.xml <br>  and folders <br>  inc / <br>  symbols / <br><br>  You may also need a script to update the osm.xml file, you can take it here: <a href="https://github.com/mapnik/mapnik/tree/master/utils/upgrade_map_xml">github.com/mapnik/mapnik/tree/master/utils/upgrade_map_xml</a> <br>  And you can download osm.xml, which I have already corrected from here: <a href="http://pastebin.com/bMsXytcc">pastebin.com/bMsXytcc</a> <br>  Now we will generate map.xml, for this we will run: <br><br> <code>./generate_xml.py osm.xml --host localhost --user user --dbname gis --symbols symbols/ --world_boundaries world_boundaries/ --port 5432 --epsg='900913' --accept-none &gt; map.xml</code> <br>  where --accept-none means to accept untranslated parameters as empty. <br><br>  We should have a fairly large map.xml file. <br><br>  Already almost everything, it remains to configure only TileCache. <br><br>  Download the downloaded archive to <code>/usr/local/www/data/tilecache</code> .  Here you need to configure only two files: tilecache.cfg and index.html. <br>  In the first, you need to explain TileCache where to get the data from (and you need to take it from map.xml, which we just did). <br>  To do this, add the same lines: <br> <code>[osm-map] <br> type=MapnikLayer <br> mapfile=/usr/home/user/mapnik/map.xml <br> spherical_mercator=true <br> bbox=-20037508.34,-20037508.34,20037508.34,20037508.34 <br> resolutions=2445.984375,1222.9921875,611.49609375,305.748046875,152.8740234375,76.43701171875,38.218505859375,19.1092529296875,9.55462646484375,4.777314,2.388657,1.1943285,0.59716427,0.298582 <br> metaTile=true <br> metaSize=8,8 <br> metaBuffer=40 <br> levels=12 <br> extent_type=loose</code> <br> <br>  Important parameters here: <br>  <code>mapfile=/usr/home/user/mapnik/map.xml</code> path to the data file <br>  <code>bbox=-20037508.34,-20037508.34,20037508.34,20037508.34</code> borders of the region.  These are borders for the whole world, you can read more here: <a href="http://docs.openlayers.org/library/spherical_mercator.html">docs.openlayers.org/library/spherical_mercator.html</a> <br>  resolutions = ... this is the most interesting.  These numbers are resolutions of different zoom levels, which should be such that when dividing them, the number 20037508.34 * 2/256 will give a power of two.  This number is the side of the ‚Äúsquare‚Äù of the world divided by the side of one tile (small square), which is by default equal to 256 pixels. <br><br>  All other layers are best commented out to check that ours works. <br><br>  Now go to index.html. <br>  It is necessary to configure the function init (), for example: <br><br> <code>function init(){ <br> <br> map = new OpenLayers.Map("map", { <br> maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34), <br> numZoomLevels:14, <br> maxResolution:156543.03125/64, <br> units:'m', <br> projection: "EPSG:900913", <br> displayProjection: new OpenLayers.Projection("EPSG:4326") <br> }); <br> <br> layer = new OpenLayers.Layer.WMS( "OSM", <br> "tilecache.cgi?", {layers: 'osm-map', format: 'image/png'} ); <br> map.addLayer(layer); <br> map.addControl(new OpenLayers.Control.Permalink()); <br> map.addControl(new OpenLayers.Control.PanZoomBar()); <br> map.addControl(new OpenLayers.Control.LayerSwitcher({'ascending':false})); <br> map.addControl(new OpenLayers.Control.Permalink()); <br> map.addControl(new OpenLayers.Control.Permalink('permalink')); <br> map.addControl(new OpenLayers.Control.MousePosition()); <br> map.addControl(new OpenLayers.Control.OverviewMap()); <br> map.addControl(new OpenLayers.Control.KeyboardDefaults()); <br> <br> if (!map.getCenter()) { <br> var proj = new OpenLayers.Projection("EPSG:4326"); <br> var point = new OpenLayers.LonLat(30, 60); <br> map.setCenter(point.transform(proj, map.getProjectionObject()),4); <br> } <br> }</code> <br> <br>  It is necessary to pay attention to the following parameters: <br>  <code>maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34)</code> borders should be exactly the same as in tilecache.cfg. <br>  <code>maxResolution:156543.03125/64</code> is 2445.984375, i.e.  maximum resolution. <br> <code>map.setCenter(point.transform(proj, map.getProjectionObject()),4);</code>  setting the center of the map and the initial zoom so that you can see the general plan of St. Petersburg. <br>  Minor hint: allow apache to execute tilecache.cgi: <br> <code>&lt;Directory "/usr/local/www/data/tilecache"&gt; <br> AllowOverride None <br> Options None <br> Order allow,deny <br> Allow from all <br></code> <br>  And <code>chmod 755 tilecache.cgi</code> <br><br><br><h5>  Check </h5><br>  To check, you just need to open the tilecache folder with your browser and if everything went well, see just such a map (though Leningrad Region is still loaded here): <br><img src="https://habrastorage.org/getpro/habr/post_images/94d/7aa/2bf/94d7aa2bfd8c6988db141645aa9f3e02.jpg" alt="image"><br><br><h5>  Total </h5><br>  The result should be a server that can read data from the PostGIS database and turn it into tiles without an Internet connection. <br>  I will try to answer questions if something goes wrong. <br></div><p>Source: <a href="https://habr.com/ru/post/138791/">https://habr.com/ru/post/138791/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../138783/index.html">Optimizing work with templates in Backbone</a></li>
<li><a href="../138784/index.html">HowTo: continuous integration of Django to Jenkins using Selenium</a></li>
<li><a href="../138785/index.html">Deploying Java applications to Windows Azure using ant</a></li>
<li><a href="../138786/index.html">Taming Windows Server Core</a></li>
<li><a href="../138788/index.html">Digium launches its own IP phones</a></li>
<li><a href="../138793/index.html">Canobuvosti, 132nd edition</a></li>
<li><a href="../138794/index.html">High five. Or meet JIRA 5.0</a></li>
<li><a href="../138795/index.html">Intel Wireless Display: for developer</a></li>
<li><a href="../138796/index.html">First GAC Driver Iteration</a></li>
<li><a href="../138797/index.html">Apple bought the search company Chomp and plans to completely redo the search on the App Store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>