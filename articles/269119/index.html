<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Balancing 70 thousand requests per second on HighLoad ++</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Library of reports 
 This is not just an article - it is a whole library of reports about the internal structure of various large and high-loaded proj...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Balancing 70 thousand requests per second on HighLoad ++</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/137/c21/144/137c2114466647b09ee3df04f561c3b8.jpg"></div><br><h3>  <font color="#d81d24">Library of reports</font> </h3><br>  This is not just an article - it is a whole library of reports about the internal structure of various large and high-loaded projects.  All these reports were heard at the conferences <a href="http://www.highload.ru/">HighLoad ++</a> and <a href="http://ritfest.ru/">RIT ++</a> over the past few years. <br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/117154627&amp;xid=25657,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhiyrws5jJV30kuOe7FueMp7KXiwLA" width="560" height="315" frameborder="0" title="Failsafe microcluster do-it-yourself, Vitaly Gavrilov (Lenve" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe><br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/101783121&amp;xid=25657,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhiPl5zFLZIxGaYbKBWRQptWeSUPAA" width="560" height="315" frameborder="0" title="How to write a scalable banner banner by Denis Biryukov (Kavanga)" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe><br><a name="habracut"></a><br>  And further: <br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/117154462&amp;xid=25657,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhNm_EfHE-EhhV2jWKmTWFXTQkjiw" width="560" height="315" frameborder="0" title="Using memcached and Redis in high-load projects, Vyacheslav Mosk " webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe><br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/101782992&amp;xid=25657,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhhiRNUcKx1Voccc7crXiQkBdmmd0w" width="560" height="315" frameborder="0" title="Rambler Cashier as an example of a high-performance project on .Net, Dm " webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe><br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/101782994&amp;xid=25657,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhggNMRaIV0ePKB42oJ-0L90MLXsNA" width="560" height="315" frameborder="0" title="Anatomy of the banner system, Artem Volftrub (Gramant)" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe><br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/101783104&amp;xid=25657,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgqNu_W2Ohd2zAUaUYe8W3ceKJh5A" width="394" height="315" frameborder="0" title="Architecture AdRiver, Vsevolod Potapov, Vitaly Ivanov (Adriver)" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe><br><br><h3>  <font color="#d81d24">Section "Architecture"</font> </h3><br>  The key section of the <a href="http://special.habrahabr.ru/highload/2015/">HighLoad ++</a> developer of highly loaded systems developers conference, which will be held in two weeks in Moscow, is, of course, Architecture.  The reports in this section are changing - if three or four years ago we listened to general words about how many servers are on Facebook and where files are stored on VK, now such reports no longer pass to the Program.  Now is the time for details, microservices, detailed analyzes of one or another architectural pattern. <br><br>  So, architectural patterns.  At this conference we will analyze in detail a couple of them, and the first one is, of course, microservices. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A single application is built as a set of small microservices, each of which works in its own process, is as independent as possible from other microservices, implements, as a rule, one business function and communicates with the others using lightweight mechanisms, the same http. <br><br>  Anton Reznikov and Vladimir Perepelitsa <a href="http://www.highload.ru/2015/abstracts/1929.html">will tell not only</a> about the microservice architecture of the Cloud@Mail.ru, but also the specific implementation of the pattern on the Tarantool NoSQL database.  Yes, Tarantool is another NoSQL database, but still it is a full-fledged application server.  Applications located next to the data! <br><br><img src="https://habrastorage.org/files/571/997/bc4/571997bc447246fbba9e5398efd7981b.jpg"><br><br>  Denis Ivanov (2Gis) will continue the topic in the report <a href="http://www.highload.ru/2015/abstracts/1867.html">‚ÄúThe path from the monolith in PHP to microservices on Scala‚Äù</a> .  I just want to exclaim: ‚ÄúDenis, stop what you are doing, why ?!‚Äù.  And Denis answers this question simply - 6 nodes with appendices instead of 18. The answer is worthy, we hope to hear the details at the conference. <br><br>  Another pattern often used in high-load projects is queues.  The topic is covered by Pavel Filonov (Positive Technologies) in the report <a href="http://www.highload.ru/2015/abstracts/1879.html">‚Äú101 ways of preparing RabbitMQ and a little about pipeline-architecture‚Äù</a> . <blockquote>  The report discusses options for using the RabbitMQ messaging system as middleware for building a pipeline architecture.  The issues of performance and scaling of both stateless and statefull filters are considered. </blockquote><br>  The report is similar to the training, but the topic is painfully good! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fc1/c8a/2f1/fc1c8a2f19074654830100d8c6afc987.jpg"></div><br>  The next <a href="http://www.highload.ru/2015/abstracts/1950.html">balancing</a> report from Yuri Nasretdinov from Badoo is a serious bid to win.  Taking this opportunity, we tried to ask Yuri a few questions in order to shed light on one of the most exciting reports expected at the conference: <br><br><h4>  <font color="#d81d24">- Yura, how did you approach the load level of 70k requests per second?</font> </h4><blockquote>  We approached this level of load very smoothly, for almost 10 years now.  In recent years, we have also started to increase the number of users on mobile devices, which also caused an increase in the number of requests per second - our mobile application sends more small requests to the server than the website.  I would like to note that 70k requests per second fall on PHP-FPM, the total number of HTTP requests to our site is up to 250k per second. </blockquote><br><h4>  <font color="#d81d24">- What, besides eggs, do you need to keep such loads?</font> </h4><blockquote>  In general, there is no problem in servicing 250,000 HTTP requests per second.  You can handle such a load with the help of the banal nginx and DNS round-robin.  We use ‚Äúhardware‚Äù solutions for processing incoming traffic - GTM and LTM from F5.  They allow you to process all requests on a single IP address, that is, without using DNS round-robin.  At the input router, the rules are set according to which requests fall on a particular cluster, the machine weights are set if necessary, and this piece of hardware does the rest for you (or nginx, which we use to proxy requests to the mobile cluster). <br><br>  Roughly speaking, distributing requests across servers is not an extremely complex task, and for PHP, scaling is simply to add servers to the backend with the appropriate weights. <br><br>  It is much more difficult not only to keep such a load, but also to create an architecture for storing user data that could store and deliver hundreds of terabytes and even petabytes of photos and text data.  There were many reports about our architecture, for example, a <a href="http://www.youtube.com/watch%3Fv%3Dpn7IT_cG8ck">master class</a> from Alexey Rybak at DevConf in 2012 or <a href="https://devconf.ru/ru/offers/offer/71">my report</a> about the architecture of photo storage in 2015.  Unfortunately, it is not possible to talk briefly about the architecture in the interview, so I would recommend to look at our presentations for details. </blockquote><br><h4>  <font color="#d81d24">- How is this bandwidth of the architecture achieved, what are some interesting places?</font> </h4><blockquote>  Again, this bandwidth is not something outstanding, and the same LTM handles the load even without additional backups on our part. <br><br>  If we talk about the storage architecture of users, then everything is a little more interesting.  We store the data of each user on one server, that is, we shard the data by users, and not by ID or other synthetic values.  This allows us to make quite complex samples when working with user data, use JOIN and complex sorting.  At the same time, users are not ‚Äúnailed to nails‚Äù to their server, but can move around the cluster if necessary.  This is achieved due to the fact that we store the user's ‚Äúspot_id‚Äù and ‚Äúplace_id‚Äù (identifiers from which you can determine the server name and the table name on the server) in a central service called the ‚Äúauthorizer‚Äù.  Requests are made to this service every time you need to establish a connection to the user's database.  The service accounts for about 40k read requests per second, and they are serviced by the HandlerSocket protocol with one MySQL instance.  This service is probably the most heavily loaded internal service that serves one server, and at the moment we have a margin of performance at least 2 times.  Even if we rest on the scalability of MySQL + handlersocket, you can always try, for example, Tarantool for this task - this daemon can issue 100k requests / s per _ core_ (compare with 100k requests to _server_ in the case of MySQL + handlersocket). </blockquote><br><h4>  <font color="#d81d24">- And a few words about your report on HighLoad ++</font> </h4><blockquote>  In the report, I will talk about a system that puts weights for servers on our balancers (LTM for web load and nginx for mobile cluster).  The system is needed in order to achieve a much more even distribution of the load across the cluster than it turns out to be done with ‚Äúhands‚Äù.  With the growth of load and the number of requests, we began to require an increasing number of servers, and in addition to adding new servers, we decided to spend some effort on ensuring a more even load on existing ones.  Before we started doing something, the spread between CPU usage on the most loaded server and on the most free one was about 20-30%, and after that - only 2.5%.  On our volumes, this allowed us to save up to hundreds of servers, and it was certainly worth it. <br><br>  I will talk about the existing approaches to the automatic distribution of weights for the machines, about what approaches we tried, and on what we established as a result.  The solution we have written will be laid out in open-source so that you can use it in your project if necessary. </blockquote><br><img src="https://habrastorage.org/files/108/d89/003/108d8900336e4933a9db3769731dcbc1.jpg"><br><br>  And finally, a classic report on the architecture of a large project, albeit a very large, largest ad service in RuNet - Avito.ru.  Mikhail Tyurin, Avito Chief System Architect, will tell you about <a href="http://www.highload.ru/2015/abstracts/1881.html">"Where do your ads live?"</a> <blockquote>  There are no equal high-loaded projects, the devil is in the details, in the nuances of the work of a particular function, the storage and use of a particular data block.  That is why I begin my course of lectures on high-loaded systems at MIPT with a story and a demonstration of the importance of the analytical part of working on a high-loaded project.  And that is why I recommend to go to the report of Michael - the largest classifier in Europe, 600 million ads - how does it all work? </blockquote>  See you at the conference! <br><br><h3>  <font color="#d81d24">PS Tutorial</font> </h3><br>  By the way, for several weeks now we have been testing a new textbook on the design of high-load systems.  This is a series of letters built on the lectures of the best specialists in Russia.  Somewhere we decipher lectures, somewhere we provide a video, but the following is important - each of the materials has been checked by us, it is stamped on the quality of the HighLoad ++ conference. <br><br>  If interested - sign up, it's free: <a href="http://highload.guide/">http://highload.guide/</a> <br><blockquote>  <b>And finally</b> : <i>For the users of Habrakhabr, the conference offers a special discount of 15%, all you need to do is use the code " <u>IAmHabr</u> " when booking tickets.</i> </blockquote></div><p>Source: <a href="https://habr.com/ru/post/269119/">https://habr.com/ru/post/269119/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269107/index.html">[CodinGame] Back to the Code: Recar and Olaf69 share their strategies</a></li>
<li><a href="../269111/index.html">How to write RFP for software development</a></li>
<li><a href="../269113/index.html">Illusion of time</a></li>
<li><a href="../269115/index.html">Admin as unit test for HTTP API</a></li>
<li><a href="../269117/index.html">Network technology in higher education. Sad experience in finding young professionals</a></li>
<li><a href="../269121/index.html">Proper migration from MyISAM to InnoDB</a></li>
<li><a href="../269123/index.html">Ansible and reverse-proxy servers</a></li>
<li><a href="../269125/index.html">The acquisition of Zend still does not mean anything</a></li>
<li><a href="../269127/index.html">Quantum communications: from research to technology business</a></li>
<li><a href="../269129/index.html">Parsing Java programs using java programs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>