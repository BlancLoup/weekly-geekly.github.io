<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rectal tonsillectomy: working with AD in Powershell without AD cmdlets</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Windows Server 2008, the first wonderful PowerShell cmdlets to work with ActiveDirectory appeared . These wonderful, logical, intuitive and extreme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rectal tonsillectomy: working with AD in Powershell without AD cmdlets</h1><div class="post__text post__text-html js-mediator-article">  In Windows Server 2008, the first wonderful <a href="http://technet.microsoft.com/en-us/library/ee617195.aspx">PowerShell cmdlets to work with ActiveDirectory appeared</a> .  These wonderful, logical, intuitive and extremely powerful tools made me feel sad, if not to say ‚Äúannoyance‚Äù: they were inaccessible to me, an enikeyschiku non-core office.  All eleven networks that I served were built based on Windows 2003 R2. <br><br>  Eleven unrelated domains in eleven unrelated networks in different cities scattered across the Far East.  And in none of them - not the fact that there is no ‚ÄúSeven‚Äù, even ‚ÄúVista‚Äù, which puts an end to attempts to <a href="http://blogs.technet.com/b/ashleymcglone/archive/2011/03/17/step-by-step-how-to-use-active-directory-powershell-cmdlets-against-2003-domain-controllers.aspx">use AD cmdlets in conjunction with two thousand and three</a> . <br><img src="https://habrastorage.org/storage2/efc/136/4be/efc1364bedf39511e69c4ae30397efcd.png"><br><br>  The task was formulated as follows: ‚Äúcreate code capable of performing basic AD management operations from PowerShell scripts running in Windows XP / 2003‚Äù.  Read about how it was resolved, read under habrakat ( <i>carefully, crutches; a lot of text and code</i> ). <br><a name="habracut"></a><br><h4>  Context </h4><br>  Recently, the work of the enikeyschik has been a little bit dismal because of the abnormal activity of system administrators and other IT managers: they decided to make a lot of changes to the settings of server services, user workstations, and other IT facilities.  Naturally, with the hands of enikeyschikov, because  they did not have normal tools like <a href="http://www.symantec.com/ru/ru/configuration-management">Altiris</a> or <a href="http://www.microsoft.com/en-us/server-cloud/system-center/configuration-manager-2012.aspx">MS SCCM</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At some point, I realized that I physically did not have time to implement their brilliant ideas in the networks entrusted to me, and thought about automation.  The analysis of working time showed that, first of all, it is necessary to accelerate the process of replicating changes in AD.  For this, as it seemed to me then, Active Directory Comandlets were needed (for which they needed to purchase at least one license for Windows 7). <br><br>  Business executives and system administrators were implacable: ‚ÄúWhy do we need a new system if the old one works fine?  Ah, does it work not perfectly?  But you have everything to be wonderful!  Otherwise, why do you pay so much?  By the way, if you need a new system so much, buy it yourself with your money and use it!  And in general, if you are not able to solve business problems within the framework of the proposed toolkit, get out of the Company! ‚Äù <br><br>  ‚ÄúOkay,‚Äù I replied: ‚ÄúI didn‚Äôt want to go out very much.  In the end, the implementation of the ‚Äúhelp‚Äù of the manual is one of the key differences between an enikeyschik and a real system administrator.  It became clear that once again it would be necessary to "use ingenuity" and "get out."  PowerShell was chosen as the platform for building the ‚Äúersatz-management <a href="http://ru.wikipedia.org/wiki/Active_Directory">AD</a> ‚Äù system (mainly for the ease of working with <a href="http://msdn.microsoft.com/en-us/vstudio/aa496123.aspx">.NET</a> and <a href="http://www.microsoft.com/com/default.mspx">COM</a> ). <br><br><h4>  Code </h4><br><h5>  Getting the unique name of the unit </h5><br>  If you have worked with ActiveDirectory or are familiar with a different <a href="http://citforum.ru/operating_systems/linux/ldap_cat/">LDAP implementation</a> , you know how unique (distinguishable) names (DNs ( <a href="http://msdn.microsoft.com/ru-ru/library/windows/desktop/aa366101(v%3Dvs.85).aspx">Distinguished Names</a> )) are widely used in various cases. <br><br>  A unique LDAP name consists of several relative unique names - RDNs ( <a href="http://docs.oracle.com/cd/E19182-01/820-6573/ghusi/index.html">Relative Distinguished Names</a> ), which are ‚ÄúAttribute = Value‚Äù pairs.  Example of a relative unique name for the <a href="http://technet.microsoft.com/en-us/library/cc758565(v%3Dws.10).aspx">Organization Unit</a> : <br><pre><code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ou</span></span>=<span class="hljs-selector-tag"><span class="hljs-selector-tag">Managers</span></span></code> </pre> <br><br>  An example of a unique name for the same unit: <br><pre> <code class="php hljs">ou=Managers,DC=example,dc=com</code> </pre><br><br>  This entry indicates that in the AD domain named ‚Äúexample.com‚Äù, the ‚ÄúManagers‚Äù division is located on the first level. <br><br>  From my own experience, I can say that the unique LDAP names are not intuitive and cause some difficulty for the beginner enikeyschikov.  Therefore, I found it necessary to write a simple function that converts an intuitive view of the form ‚Äúexample.com/Managers/Accounting/‚Äù to the DN notation: <br><pre> <code class="hljs smalltalk">&lt;# .<span class="hljs-type"><span class="hljs-type">SYNOPSIS</span></span>    <span class="hljs-type"><span class="hljs-type">OU</span></span>   <span class="hljs-comment"><span class="hljs-comment">"example.com/123/456"</span></span>,   <span class="hljs-type"><span class="hljs-type">Distinguished</span></span> <span class="hljs-type"><span class="hljs-type">Name</span></span>. .<span class="hljs-type"><span class="hljs-type">Description</span></span>       ,       . :      <span class="hljs-type"><span class="hljs-type">DNS</span></span>-,   <span class="hljs-type"><span class="hljs-type">NEIBIOS</span></span>  (.. example.com,   <span class="hljs-type"><span class="hljs-type">EXAMPLE</span></span>) .<span class="hljs-type"><span class="hljs-type">PARAMETER</span></span> <span class="hljs-type"><span class="hljs-type">Path</span></span> ,     <span class="hljs-type"><span class="hljs-type">DN</span></span> .<span class="hljs-type"><span class="hljs-type">OUTPUTS</span></span> <span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">String</span></span>.  <span class="hljs-type"><span class="hljs-type">Distinguished</span></span> <span class="hljs-type"><span class="hljs-type">Name</span></span>,   . #&gt; <span class="hljs-type"><span class="hljs-type">Function</span></span> <span class="hljs-type"><span class="hljs-type">Convert</span></span>-<span class="hljs-type"><span class="hljs-type">ADPath2DN</span></span>([<span class="hljs-type"><span class="hljs-type">STRING</span></span>]<span class="hljs-string"><span class="hljs-string">$P</span></span>ath) { <span class="hljs-string"><span class="hljs-string">$R</span></span>es = <span class="hljs-comment"><span class="hljs-comment">""</span></span> <span class="hljs-string"><span class="hljs-string">$R</span></span>esOU = <span class="hljs-string"><span class="hljs-string">$n</span></span>ull #   <span class="hljs-type"><span class="hljs-type">OU</span></span>  <span class="hljs-type"><span class="hljs-type">OU</span></span> <span class="hljs-type"><span class="hljs-type">DN</span></span> <span class="hljs-string"><span class="hljs-string">$P</span></span> = <span class="hljs-type"><span class="hljs-type">Join</span></span>-<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-string"><span class="hljs-string">$P</span></span>ath <span class="hljs-comment"><span class="hljs-comment">"/"</span></span> <span class="hljs-string"><span class="hljs-string">$P</span></span> = <span class="hljs-string"><span class="hljs-string">$P</span></span>.<span class="hljs-type"><span class="hljs-type">Replace</span></span>(<span class="hljs-comment"><span class="hljs-comment">"\"</span></span>,<span class="hljs-comment"><span class="hljs-comment">"/"</span></span>) #,     -    if (<span class="hljs-string"><span class="hljs-string">$P</span></span> -match <span class="hljs-comment"><span class="hljs-comment">"^(?&lt;DNS_DOMAIN_NAME&gt;(\w+\.\w+)+)\/.+$"</span></span>) { <span class="hljs-string"><span class="hljs-string">$i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-string"><span class="hljs-string">$D</span></span>NS_DOMAIN_NAME = <span class="hljs-string"><span class="hljs-string">$M</span></span>atches.<span class="hljs-type"><span class="hljs-type">DNS_DOMAIN_NAME</span></span> #   <span class="hljs-type"><span class="hljs-type">OU</span></span> <span class="hljs-type"><span class="hljs-type">While</span></span> (-not (<span class="hljs-string"><span class="hljs-string">$P</span></span> -eq <span class="hljs-string"><span class="hljs-string">$D</span></span>NS_DOMAIN_NAME)) { <span class="hljs-string"><span class="hljs-string">$i</span></span>++ <span class="hljs-string"><span class="hljs-string">$O</span></span>U = <span class="hljs-type"><span class="hljs-type">Split</span></span>-<span class="hljs-type"><span class="hljs-type">Path</span></span> -<span class="hljs-type"><span class="hljs-type">Leaf</span></span> <span class="hljs-string"><span class="hljs-string">$P</span></span> <span class="hljs-string"><span class="hljs-string">$P</span></span> = <span class="hljs-type"><span class="hljs-type">Split</span></span>-<span class="hljs-type"><span class="hljs-type">Path</span></span> -<span class="hljs-type"><span class="hljs-type">Parent</span></span> <span class="hljs-string"><span class="hljs-string">$P</span></span> <span class="hljs-type"><span class="hljs-type">If</span></span> (<span class="hljs-string"><span class="hljs-string">$i</span></span> -ne <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-string"><span class="hljs-string">$R</span></span>esOU = <span class="hljs-string"><span class="hljs-string">$R</span></span>esOU + <span class="hljs-comment"><span class="hljs-comment">","</span></span> } <span class="hljs-string"><span class="hljs-string">$R</span></span>esOU = <span class="hljs-string"><span class="hljs-string">$R</span></span>esOU+ <span class="hljs-comment"><span class="hljs-comment">"OU=$OU"</span></span> } } else { <span class="hljs-string"><span class="hljs-string">$D</span></span>NS_DOMAIN_NAME = [<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">DirectoryServices</span></span>.<span class="hljs-type"><span class="hljs-type">ActiveDirectory</span></span>.<span class="hljs-type"><span class="hljs-type">Domain</span></span>]::<span class="hljs-type"><span class="hljs-type">GetCurrentDomain</span></span>().<span class="hljs-type"><span class="hljs-type">Name</span></span> } #   ,           <span class="hljs-string"><span class="hljs-string">$D</span></span>NS_DOMAIN_NAME = <span class="hljs-string"><span class="hljs-string">$D</span></span>NS_DOMAIN_NAME.<span class="hljs-type"><span class="hljs-type">Replace</span></span>(<span class="hljs-comment"><span class="hljs-comment">"."</span></span>,<span class="hljs-comment"><span class="hljs-comment">"\"</span></span>) <span class="hljs-string"><span class="hljs-string">$D</span></span>C_NAMES = @() <span class="hljs-type"><span class="hljs-type">While</span></span> (<span class="hljs-string"><span class="hljs-string">$D</span></span>NS_DOMAIN_NAME -ne <span class="hljs-comment"><span class="hljs-comment">""</span></span>) { <span class="hljs-string"><span class="hljs-string">$D</span></span>C = <span class="hljs-type"><span class="hljs-type">Split</span></span>-<span class="hljs-type"><span class="hljs-type">Path</span></span> -<span class="hljs-type"><span class="hljs-type">Leaf</span></span> <span class="hljs-string"><span class="hljs-string">$D</span></span>NS_DOMAIN_NAME <span class="hljs-string"><span class="hljs-string">$D</span></span>NS_DOMAIN_NAME = <span class="hljs-type"><span class="hljs-type">Split</span></span>-<span class="hljs-type"><span class="hljs-type">Path</span></span> -parent <span class="hljs-string"><span class="hljs-string">$D</span></span>NS_DOMAIN_NAME <span class="hljs-string"><span class="hljs-string">$D</span></span>C_NAMES = <span class="hljs-string"><span class="hljs-string">$D</span></span>C_NAMES + <span class="hljs-string"><span class="hljs-string">$D</span></span>C } <span class="hljs-string"><span class="hljs-string">$C</span></span>ount = <span class="hljs-string"><span class="hljs-string">$D</span></span>C_NAMES.<span class="hljs-type"><span class="hljs-type">Count</span></span> for (<span class="hljs-string"><span class="hljs-string">$i</span></span>=<span class="hljs-string"><span class="hljs-string">$C</span></span>ount;<span class="hljs-string"><span class="hljs-string">$i</span></span> -gt <span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-string"><span class="hljs-string">$i</span></span>--) { <span class="hljs-string"><span class="hljs-string">$D</span></span>C = <span class="hljs-string"><span class="hljs-string">$D</span></span>C_NAMES[<span class="hljs-string"><span class="hljs-string">$i</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-type"><span class="hljs-type">If</span></span> (<span class="hljs-string"><span class="hljs-string">$i</span></span> -ne <span class="hljs-string"><span class="hljs-string">$C</span></span>ount) { <span class="hljs-string"><span class="hljs-string">$R</span></span>esDC = <span class="hljs-string"><span class="hljs-string">$R</span></span>esDC + <span class="hljs-comment"><span class="hljs-comment">","</span></span> } <span class="hljs-string"><span class="hljs-string">$R</span></span>esDC = <span class="hljs-string"><span class="hljs-string">$R</span></span>esDC+ <span class="hljs-comment"><span class="hljs-comment">"DC=$DC"</span></span> if (<span class="hljs-string"><span class="hljs-string">$R</span></span>esOU -ne <span class="hljs-string"><span class="hljs-string">$n</span></span>ull) { <span class="hljs-string"><span class="hljs-string">$R</span></span>es = <span class="hljs-string"><span class="hljs-string">$R</span></span>esOU + <span class="hljs-comment"><span class="hljs-comment">","</span></span> + <span class="hljs-string"><span class="hljs-string">$R</span></span>esDC } else { <span class="hljs-string"><span class="hljs-string">$R</span></span>es = <span class="hljs-string"><span class="hljs-string">$R</span></span>esDC } } <span class="hljs-type"><span class="hljs-type">Return</span></span> <span class="hljs-string"><span class="hljs-string">$R</span></span>es }</code> </pre><br><br>  Usage example: <br><pre> <code class="hljs perl">$Var = Convert-ADPath2DN -Path <span class="hljs-string"><span class="hljs-string">"example.com/Test/"</span></span> $Var OU=Test,DC=example,DC=com</code> </pre><br><br>  Although this feature is not directly related to ActiveDirectory management, it is very useful and is used in other functions. <br><br><h5>  Creating an organization unit </h5><br>  Each enikeyshchik should know that it is necessary to test scripts for ActiveDirectory on a dedicated test domain, preferably physically disconnected from the main network of the enterprise. <br><br>  Equally important is compliance with the company's IT cost reduction policy (I think that many non-core organizations have similar guidelines), which means that neither a PC capable of ‚Äúpulling‚Äù a Windows 2003 virtual machine, nor, moreover, a separate server, on which you can deploy a test environment, as a rule, there is no enikeeder at its disposal. <br><br>  Therefore, our hero, contrary to the strict instructions of his older comrades, is testing his achievements right in the ‚Äúcombat‚Äù AD.  We will not blame him for it, but try instead to help. <br><br>  The first thing he should do is create a separate <a href="http://blogs.technet.com/b/vladygin/archive/2009/10/20/ad-c-ou.aspx">unit</a> ( <a href="http://technet.microsoft.com/en-us/library/cc978003.aspx">Organization Unit</a> ), within which further development of script writing skills will take place.  Well, since the topic of the topic is related to Powershell programming, we implement the corresponding function on it. <br><br>  To do this, we need to use <a href="http://msdn.microsoft.com/en-us/library/87tye19w.aspx">the</a> Create <a href="http://msdn.microsoft.com/en-us/library/87tye19w.aspx">constructor</a> of the <a href="http://msdn.microsoft.com/en-us//library/system.directoryservices.directoryentry.aspx">System.DirectoryServices.DirectoryEntry</a> class.  The final version might look like this: <br><pre> <code class="hljs mel">&lt;# .SYNOPSIS     AD      . .Description       ,    .   - .       New-ADOrganizationUnit .PARAMETER Path    AD,     OU (.. ). .PARAMETER Name    (Organization Unit). .OUTPUTS $null.    . #&gt; Function New-ADOrganizationUnit_simple([STRING]$Path,[STRING]$Name) { #   , ..     . #  -   OU,   . $ErrorActionPreference = <span class="hljs-string"><span class="hljs-string">"SilentlyContinue"</span></span> #    DN (.   ) $OUDN = Convert-ADPath2DN -Path $Path #    ADsPath $OUDN = <span class="hljs-string"><span class="hljs-string">"LDAP://$OUDN"</span></span> # ,    $objDomain = [ADSI]$OUDN #  $objOU = $objDomain.Create(<span class="hljs-string"><span class="hljs-string">"organizationalUnit"</span></span>, <span class="hljs-string"><span class="hljs-string">"ou=$Name"</span></span>) $objOU.SetInfo() #  Trap { #   ,     ,    . <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_.Exception.ErrorCode -eq $SYSTEM_ERROR_CODE_OU_ALREADY_EXISTS) { Write-Host <span class="hljs-string"><span class="hljs-string">"OU $Name  $Path  "</span></span> } } }</code> </pre><br><br>  A clear disadvantage of this implementation is the inability of this function to create a full branch of departments: if you need to create an OU " <i>example.com/Users/HR/Women</i> " in a domain that does not have a unit " <i>example.com/Users</i> ", you cannot use her to solve this problem. <br><br>  More precisely, you can, but it will be extremely inconvenient, because  you will have to first create an OU "Users", then "HR" and only after that - "Women" <br><br>  Such a scenario clearly contradicts the principle of automation of routine, and therefore is unacceptable.  Instead, it is much better to use a function that creates the entire branch automatically, for example, the following: <br><pre> <code class="hljs smalltalk">&lt;# .<span class="hljs-type"><span class="hljs-type">SYNOPSIS</span></span>     <span class="hljs-type"><span class="hljs-type">AD</span></span>   . .<span class="hljs-type"><span class="hljs-type">Description</span></span>      ,      (  ). .<span class="hljs-type"><span class="hljs-type">PARAMETER</span></span> <span class="hljs-type"><span class="hljs-type">Path</span></span>    . .<span class="hljs-type"><span class="hljs-type">OUTPUTS</span></span> <span class="hljs-string"><span class="hljs-string">$n</span></span>ull.    . #&gt; <span class="hljs-type"><span class="hljs-type">Function</span></span> <span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">ADOrganizationUnit</span></span> ([<span class="hljs-type"><span class="hljs-type">STRING</span></span>]<span class="hljs-string"><span class="hljs-string">$P</span></span>ath) { #,        (example.com/<span class="hljs-type"><span class="hljs-type">Unit1</span></span>/<span class="hljs-type"><span class="hljs-type">Unit2</span></span>...) <span class="hljs-type"><span class="hljs-type">If</span></span> (<span class="hljs-string"><span class="hljs-string">$P</span></span>ath -match <span class="hljs-comment"><span class="hljs-comment">"^(?&lt;DNS_DOMAIN_NAME&gt;(\w+\.\w+)+)\/.+$"</span></span>) { <span class="hljs-string"><span class="hljs-string">$i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> #  ,    <span class="hljs-comment"><span class="hljs-comment">"*-Path"</span></span> <span class="hljs-string"><span class="hljs-string">$P</span></span>th = <span class="hljs-type"><span class="hljs-type">Join</span></span>-<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-string"><span class="hljs-string">$P</span></span>ath <span class="hljs-comment"><span class="hljs-comment">"/"</span></span> <span class="hljs-string"><span class="hljs-string">$P</span></span>th = <span class="hljs-string"><span class="hljs-string">$P</span></span>th.<span class="hljs-type"><span class="hljs-type">Replace</span></span>(<span class="hljs-comment"><span class="hljs-comment">"\"</span></span>,<span class="hljs-comment"><span class="hljs-comment">"/"</span></span>) <span class="hljs-string"><span class="hljs-string">$O</span></span>Us = @() # <span class="hljs-type"><span class="hljs-type">OU</span></span>   <span class="hljs-type"><span class="hljs-type">While</span></span> (<span class="hljs-string"><span class="hljs-string">$P</span></span>th -ne <span class="hljs-comment"><span class="hljs-comment">""</span></span>) { <span class="hljs-string"><span class="hljs-string">$i</span></span>++ <span class="hljs-string"><span class="hljs-string">$P</span></span>os = <span class="hljs-string"><span class="hljs-string">$P</span></span>th.<span class="hljs-type"><span class="hljs-type">IndexOf</span></span>(<span class="hljs-comment"><span class="hljs-comment">"/"</span></span>) <span class="hljs-type"><span class="hljs-type">If</span></span> (<span class="hljs-string"><span class="hljs-string">$i</span></span> -eq <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-string"><span class="hljs-string">$D</span></span>NS_DOMAIN_NAME = <span class="hljs-string"><span class="hljs-string">$P</span></span>th.<span class="hljs-type"><span class="hljs-type">Substring</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">$P</span></span>os) } else { <span class="hljs-string"><span class="hljs-string">$O</span></span>U = <span class="hljs-string"><span class="hljs-string">$P</span></span>th.<span class="hljs-type"><span class="hljs-type">Substring</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">$P</span></span>os) <span class="hljs-string"><span class="hljs-string">$O</span></span>Us = <span class="hljs-string"><span class="hljs-string">$O</span></span>Us + <span class="hljs-string"><span class="hljs-string">$O</span></span>U } <span class="hljs-string"><span class="hljs-string">$P</span></span>th = <span class="hljs-string"><span class="hljs-string">$P</span></span>th.<span class="hljs-type"><span class="hljs-type">Substring</span></span>(<span class="hljs-string"><span class="hljs-string">$P</span></span>os+<span class="hljs-number"><span class="hljs-number">1</span></span>,(<span class="hljs-string"><span class="hljs-string">$P</span></span>th.<span class="hljs-type"><span class="hljs-type">Length</span></span> - <span class="hljs-string"><span class="hljs-string">$P</span></span>os <span class="hljs-number"><span class="hljs-number">-1</span></span>)) } #   <span class="hljs-type"><span class="hljs-type">OU</span></span> <span class="hljs-string"><span class="hljs-string">$P</span></span>th = <span class="hljs-string"><span class="hljs-string">$D</span></span>NS_DOMAIN_NAME <span class="hljs-type"><span class="hljs-type">For</span></span> (<span class="hljs-string"><span class="hljs-string">$i</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-string"><span class="hljs-string">$i</span></span> -lt <span class="hljs-string"><span class="hljs-string">$O</span></span>Us.<span class="hljs-type"><span class="hljs-type">Count</span></span>;<span class="hljs-string"><span class="hljs-string">$i</span></span>++) { <span class="hljs-string"><span class="hljs-string">$O</span></span>U = <span class="hljs-string"><span class="hljs-string">$O</span></span>Us[<span class="hljs-string"><span class="hljs-string">$i</span></span>] #      <span class="hljs-type"><span class="hljs-type">OU</span></span>. #  <span class="hljs-comment"><span class="hljs-comment">" "</span></span>,    #     - . <span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">ADOrganizationUnit_simple</span></span> -<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-string"><span class="hljs-string">$O</span></span>U -<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-string"><span class="hljs-string">$P</span></span>th <span class="hljs-string"><span class="hljs-string">$P</span></span>th = <span class="hljs-string"><span class="hljs-string">$P</span></span>th + <span class="hljs-comment"><span class="hljs-comment">"/"</span></span> + <span class="hljs-string"><span class="hljs-string">$O</span></span>U } } }</code> </pre><br><br>  Using a function is trivial: <br><pre> <code class="hljs pgsql">#  "Test"  "MyFirstOU"   example.com <span class="hljs-built_in"><span class="hljs-built_in">New</span></span>-ADOrganizationUnit -<span class="hljs-type"><span class="hljs-type">Path</span></span> "example.com/Test/MyFirstOU/" | <span class="hljs-keyword"><span class="hljs-keyword">Out</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Null</span></span></code> </pre><br><br><h5>  Adding Security Groups </h5><br>  Mature sysadmins, having read serious books, recommend their Padawans to prefer <a href="http://technet.microsoft.com/en-us/library/cc781446(v%3Dws.10).aspx">security groups to</a> single user accounts in any AD administration scenarios and, especially, when planning its structure (if, of course, Padawan is allowed to participate in this task). <br><br>  The argument is usually given the replicability of the resulting structures: if, for example, you allow some group policy to read, allowing the director to launch arbitrary software personally (more precisely, his account), then if there is a need to provide such an opportunity to someone else, then setting permissions to repeat again for another Important Uncle. <br><br>  If you create a group, for example, " <i>gAllowRunAnything</i> " and give permission to launch arbitrary executable files to the members of this group, the process will be much simpler: it will be enough to include the account of the second employee in this group.  Obviously, this option is much easier for the enikeyschik (who will have to perform these manipulations) and is more transparent for the system administrator (who then will need to figure out what he has done with the enikeyschik). <br><br>  We will not argue with senior colleagues about the importance of groups, but simply implement the possibility of creating them as a PowerShell function: <br><pre> <code class="hljs mel">&lt;# .SYNOPSIS   AD   OU. .Description         (Organization Unit). .PARAMETER Path    ,     . .PARAMETER Name    .PARAMETER Force   .   ,    OU   . .OUTPUTS $null.     . #&gt; Function New-ADGroup([STRING]$Path, [STRING]$Name, [System.Management.Automation.SwitchParameter]$Force) { # ,     $ErrorActionPreference = <span class="hljs-string"><span class="hljs-string">"SilentlyContinue"</span></span> If ($Force -eq $true) { New-ADOrganizationUnit -Path $Path } #      DN $OUDN = Convert-ADPath2DN -Path $Path #  -   $OUDN = <span class="hljs-string"><span class="hljs-string">"LDAP://$OUDN"</span></span> $OU = [ADSI]<span class="hljs-string"><span class="hljs-string">"$OUDN"</span></span> #       $Group = $OU.Create(<span class="hljs-string"><span class="hljs-string">"group"</span></span>, <span class="hljs-string"><span class="hljs-string">"cn=$Name"</span></span>) $Group.Put(<span class="hljs-string"><span class="hljs-string">"sAMAccountName"</span></span>, <span class="hljs-string"><span class="hljs-string">"$Name"</span></span>) $Group.SetInfo() #  Trap { #   ,   : # <span class="hljs-string"><span class="hljs-string">"   "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_.Exception.ErrorCode -eq $SYSTEM_ERROR_CODE_OU_ALREADY_EXISTS) { Write-Host <span class="hljs-string"><span class="hljs-string">" $Name  $Path  "</span></span> } } }</code> </pre><br><br>  As you can see, here is also used one of the versions <a href="http://msdn.microsoft.com/en-us/library/system.directoryservices.directoryentry.directoryentry.aspx">of the Create constructor</a> of the <a href="http://msdn.microsoft.com/en-us/library/system.directoryservices.directoryentry.aspx">System.DirectoryServices.DirectoryEntry</a> class. <br><br>  And again, the use of the function is elementary (I specifically tried to simplify the syntax so that my colleagues, such enikeyshchiki, who do not have special knowledge in the field of organization and administration of AD / LDAP, could quickly figure out): <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#  "gSales"   "Unit1".   -       . New-ADGroup -Path "example.com/Test/MySuperScriptingResults/Fatal/Unit1" -Name "gSales" -Force</span></span></code> </pre><br><br><h5>  Creating and linking GPOs </h5><br>  <a href="http://www.globalit.ru/articles/windows/why-company-needs-active-directory.html">What is ActiveDirectory</a> ?  Wikipedia <a href="http://ru.wikipedia.org/wiki/Active_Directory">says</a> this is an LDAP compatible directory service implementation from MS.  The system administrator will probably remember about <a href="http://technet.microsoft.com/en-us/library/cc773178(v%3Dws.10).aspx">forests, domains and trust</a> , the Bezopasnik - about the <a href="http://technet.microsoft.com/en-us/library/bb727067.aspx">authentication</a> mechanism, and the enikeyschik - about <a href="http://technet.microsoft.com/en-us/windowsserver/bb310732.aspx">group policies</a> . <br><br>  Why about them?  They include the entire professional life of an enikeyschik: <a href="http://support.microsoft.com/kb/816102/en">installing software</a> on workstations, blocking <a href="http://msdn.microsoft.com/en-us/library/ms878786.aspx">IE settings</a> , preventing users from installing various "* Bars", <a href="http://support.microsoft.com/kb/324036">SRPs</a> that solve problems with games during working hours and even <a href="http://technet.microsoft.com/en-us/library/ee617162(v%3Dws.10).aspx">blocking the taskbar</a> that Mariwanna likes to move to the left , demanding from enikeyschiku immediately "return, as it was, but it is impossible to work."  However, I was too deep in memories.  I think no one will argue with the thesis about the importance of <a href="http://blogs.technet.com/b/grouppolicy/archive/2010/01/25/gp-editorial-group-policy-best-practices.aspx">GPO in Windows-based networks</a> . <br><br>  And since GPOs are necessary and important, it means that you need to include some mechanisms for working with them in the library being created.  What should I do with the GPO in the first place?  Of course, create it (obviously, no operation can precede creation): <br><pre> <code class="cs hljs">&lt;<span class="hljs-meta"><span class="hljs-meta"># .SYNOPSIS        . .Description        .    COM- GPMC (, GPMC   ). .PARAMETER DomainDNSName FQDN- ,       . .PARAMETER GPOName     . .OUTPUTS GPMGPO.     . #&gt; Function New-GPO([STRING]$DomainDNSName,[STRING]$GPOName) { $GPM = New-Object -ComObject GPMgmt.GPM #   $GPMConstants = $GPM.GetConstants() #  $GPMDomain = $GPM.GetDomain($DNS_DOMAIN_NAME, $DNS_DOMAIN_NAME, $Constants.UseAnyDC) # GPO $GPMGPO = $GPMDomain.CreateGPO() $GPMGPO.DisplayName = $GPOName Return $GPMGPO }</span></span></code> </pre><br><br>  This function creates a GPO object in the object repository, and nothing more.  It is useful, but for practical use it is not enough: the created object needs to be tied ( <a href="http://technet.microsoft.com/en-us/library/cc732979.aspx">Link</a> ) to the division.  Without this, it will remain as if ‚Äúinactive‚Äù (strictly speaking, it is active, the area of ‚Äã‚Äãimpact is simply not defined for it).  And in order to attach a policy to an OU, you need to get its object representation.  It is logical to try to get it, knowing the name of the GPO, for example, like this: <br><pre> <code class="hljs mel">&lt;# .SYNOPSIS  COM-  GPO   . .Description       GPO,   . .PARAMETER DomainDNSName FQDN- ,     GPO. .PARAMETER GPOName  GPO,   . .OUTPUTS GPMGPO.    COM-  GPO (  $null,  GPO   ). #&gt; Function Get-GPO([STRING]$DomainDNSName,[STRING]$GPOName) { $GPMGPO = $null #     $ErrorActionPreference = <span class="hljs-string"><span class="hljs-string">"SilentlyContinue"</span></span> # ,  GPMC $GPM = New-Object -ComObject GPMgmt.GPM #   $GPMConstants = $GPM.GetConstants() #  GPMDomain,    $GPMDomain = $GPM.GetDomain($DomainDNSNAme, $DomainDNSNAme, $GPMConstants.UseAnyDC) #        $GPMGPO = $GPMDomain.SearchGPOs($GPM.CreateSearchCriteria()) | Where-Object{$_.DisplayName -eq $GPOName} #  GPO.     -  $null. Return $GPMGPO }</code> </pre><br><br>  Having in the arsenal a search engine GPO object by name, you can try to bind: <br><pre> <code class="cs hljs">&lt;<span class="hljs-meta"><span class="hljs-meta"># .SYNOPSIS   (Link)        (OU). .Description    GPO        . -   . .PARAMETER DomainDNSName FQDN- ,     . .PARAMETER GPOName    GPO.           . .PARAMETER OUPath    ,       GPO. .OUTPUTS $Null.     . #&gt; Function Mount-GPOToOU ([STRING]$GPOName,[STRING]$OUPath,[STRING]$DomainDNSName) { #   GPO    $GPMGPO = Get-GPO -DomainDNSName $DomainDNSName -GPOName $GPOName #  ,    If ($GPMGPO -ne $Null) { #    DN $OUDN = Convert-ADPath2DN -Path $OUPath #     COM- GPMC $GPM = New-Object -ComObject GPMgmt.GPM $GPMConstants = $GPM.GetConstants() $GPMDomain = $GPM.GetDomain($DomainDNSName, $DomainDNSName, $Constants.UseAnyDC) #    $GPMSOM = $GPMDomain.GetSOM($OUDN) #  (Link)  GPO   $GPMSOM.CreateGPOLink(-1, $GPMGPO) | Out-Null trap { #   COM-.       . # ,    ,     .   continue } } #  GPO     ,      </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { Write-Host "Cannot find a GPO object named $GPOName" Throw "Cannot_find_GPO" } }</span></span></code> </pre><br><br>  The latter function allows you to bind not only the newly created, but also any GPO object in the repository.  One of the applications of this function was the practice of quickly ‚Äúentering into production‚Äù of previously created GPOs: they were first tested in a special separate unit (OU), and then <s>suddenly at night</s> after testing and receiving approval from the system administrator were contacted by ‚Äúcombat‚Äù units.  It was convenient. <br><br>  A meticulous reader may ask for what purpose the <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D21895">GPMC</a> COM object is used here.  Everything is very simple: .NET provides a very high level of abstraction and does not allow performing some operations.  For example, I did not find a way to bind a GPO to a department, I was unable to import and export a GPO (see below) using <a href="http://msdn.microsoft.com/en-us/library/system.directoryservices.directoryentry.aspx">System.DirectoryServices.DirectoryEntry</a> .  Using GPMC to perform these actions is not only <i>possible</i> , but relatively <i>simple</i> . <br><br><h5>  Import and export of GPO settings </h5><br>  So, we have the opportunity to create group policy objects and link them to departments.  Remember the goals - why do we even develop all these functions?  To help enikeyschiku in his hard work.  What kind of help does enikeyschik need?  In the automation of routine operations that he should perform.  Which of them are related to GPO?  As a rule, we are talking about making changes, developed by a system administrator, into the parameters of a GPO in a variety of networks (or in different OUs of the same domain). <br><br>  Usually this happens as follows: the security man decides that, for example, in order to prohibit the "removal" of information on removable media, it should be prohibited to use it.  The sysadmin prepares a <a href="http://www.petri.co.il/disable_usb_disks_with_gpo.htm">description of the appropriate settings of the GPO</a> (instruction) and instructs the enikeyschikam to propagate these changes in their networks. <br><br>  There may be a lot of changes, and, even worse, networks too.  As a result, it may happen that the enikeer is busy replicating all day, and cannot get the jammed sheet out of the printer, provide the necessary repertoire for an audio system in the restroom, find an abstract on the Web for the daughter-student accountant and, worst of all, show the user where there is that "any key". <br><br>  And here, the almighty MS comes to the aid of our keyboard and screwdriver fighter with its own <a href="http://technet.microsoft.com/en-us/library/cc779123(WS.10).aspx">GPO settings import / export</a> mechanism implemented within the framework of GPMC.  This mechanism allows you to import settings that are specified in one GPO to another, even if the two GPOs (donor and recipient) are in different domains.  Well, Powershell allows you to bring the process to full automatism. <br><br>  We will leave the procedure for exporting the reference policy to the system administrator, while we ourselves will deal with the <a href="http://technet.microsoft.com/en-us/library/cc779123(v%3Dws.10).aspx">import</a> .  To begin with, let's look at what a GPO backup is (MS itself insists that it is <a href="http://technet.microsoft.com/en-us/library/cc782589(v%3Dws.10).aspx">Backup</a> , and not Export): <br><img src="https://habrastorage.org/storage2/aa5/ddb/02a/aa5ddb02a95bb13fa379101c1d2ea58c.png"><br><br>  The folder name in this example is the unique identifier of the exported GPO.  We will need it when importing, so now it would be nice to learn how to get this <a href="http://ru.wikipedia.org/wiki/GUID">GUID</a> .  I risk to pass for the famous character of network folklore, but the easiest way to get this ID is just by looking at the folder name, for example, like this: <br><pre> <code class="hljs dos">&lt;# .SYNOPSIS   GUID   GPO   () . .Description         GPO,    ,   - GUID,       GUID'  .    ,     GPO        GUID'.     -   GUID'  . .PARAMETER <span class="hljs-built_in"><span class="hljs-built_in">Path</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Path</span></span> -   ,      GPO. .OUTPUTS System.String. GUID   GPO,    . #&gt; Function Get-ExportedBackupGUID([STRING]$<span class="hljs-built_in"><span class="hljs-built_in">Path</span></span>) { #,    ,   -   <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (-<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> (Test-<span class="hljs-built_in"><span class="hljs-built_in">Path</span></span> $<span class="hljs-built_in"><span class="hljs-built_in">Path</span></span>)) { Write-Host " $<span class="hljs-built_in"><span class="hljs-built_in">Path</span></span>  " Throw "Backup <span class="hljs-built_in"><span class="hljs-built_in">dir</span></span> <span class="hljs-built_in"><span class="hljs-built_in">path</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> found" } #   $Children = Get-ChildItem -Force -LiteralPath $<span class="hljs-built_in"><span class="hljs-built_in">Path</span></span> #    ,   GUID' Foreach ($Child <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $Children) { <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> ($Child.FullName -match "^*\{\w{<span class="hljs-number"><span class="hljs-number">8</span></span>}\-(\w{<span class="hljs-number"><span class="hljs-number">4</span></span>}\-){<span class="hljs-number"><span class="hljs-number">3</span></span>}\w{<span class="hljs-number"><span class="hljs-number">12</span></span>}\}$") { Return $Matches[<span class="hljs-number"><span class="hljs-number">0</span></span>] } } # ,    GPO   . Write-Host "  $<span class="hljs-built_in"><span class="hljs-built_in">Path</span></span>     " Throw "GPO Backup(s) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> found" }</code> </pre><br><br>  ,  GUID   GPO  ,            AD: <br><pre> <code class="cs hljs">&lt;<span class="hljs-meta"><span class="hljs-meta"># .SYNOPSIS   GPO   . .Description        ,       GPO.     ,      ,       GPO.    GPO  ,   . .PARAMETER BackupPath       GPO .PARAMETER DNS_DOMAIN_NAME FQDN- ,      (). .PARAMETER MigrationTablePath  .    . .PARAMETER NewGPOName    ,        .     ,       (..     GPO    ,     GPO-). .OUTPUTS $null.    . #&gt; Function Import-GPO ([STRING]$BackupPath, [STRING]$DNS_DOMAIN_NAME, [STRING]$MigrationTablePath, [STRING]$NewGPOName = "") { #      GPO.   ,   If (-not (Test-Path $BackupPath)) { Write-Host "     GPO: $BackupPath" Throw "GPO Backup path not found" } # COM- GPMC -   $GPM = New-Object -ComObject GPMgmt.GPM $GPMConstants = $GPM.GetConstants() $GPMDomain = $GPM.GetDomain($DNS_DOMAIN_NAME, $DNS_DOMAIN_NAME, $Constants.UseAnyDC) #  GPMBackupDir,      $GPMBackupDir = $GPM.GetBackupDir($BackupPath) # GUID  GPO $BackupGUID = Get-ExportedBackupGUID -Path $BackupPath #  -   GPO $GPMBackup = $GPMBackupDir.GetBackup($BackupGUID) # GPO,     :   ,     #  ,     If ($NewGPOName -eq "") { $TargetGPOName = $GPMBackup.GPODisplayName } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { $TargetGPOName = $NewGPOName } #    GPO,      $GPMGPO = Get-GPO -DomainDNSNAme $DNS_DOMAIN_NAME -GPOName $TargetGPOName # GPO     ,   If ($GPMGPO -eq $Null) { $GPMGPO = New-GPO -DomainDNSNAme $DNS_DOMAIN_NAME -GPOName $TargetGPOName } #  GPO $GPMGPO.Import(0, $GPMBackup) | Out-Null }</span></span></code> </pre><br><br>         GPO    : <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">##:   "c:\good_gpo\"      ,    ,   . #:      (  ),    "example.com/TestUnits/OU1" ##: #     GPO   "Imported_good_GPO" (    ). Import-GPO -BackupPath "c:\good_gpo\" -Dns_Domain_Name "example.com" -NewGPOName "Imported_good_GPO" #     OU Mount-GPOToOU -GPOName "Imported_good_GPO" -OUPath "example.com/TestUnits/OU1" -DomainDNSName "example.com"</span></span></code> </pre><br><br><h5>   GPO </h5><br> ,      Windows AD, ,         ,     GPO,        . <br><br> ,  OU ¬´Users¬ª,       .. ()  - .. ()       : " <i>pAllow_Run_Any_Executable</i> ", ,    ,  ,  ,  " <i>pDisallow_Run_Anything_Except_HelpDesk</i> ",   ,   . <br><br> ,   GPO      . ,    -,   ‚Äî .   ,   GPO      . <br><br>  Those.   ,      GPO. , ,        (OU)       GPO,          <a href="http://www.ozon.ru/context/detail/id/2511964/"> </a>  .    ,          AD  ,      . <br><br>    (   ‚Äî )  <a href="http://www.grouppolicy.biz/2010/07/best-practice-group-policy-design-guidelines-part-2/">,      GPO</a> .        ,          ,         . <br><br>         " <i>gAllow_Run_Any_Executable</i> ",      GPO " <i>pAllow_Run_Any_Executable</i> "           .     ‚Äî   . <br><br>  ,   , <s>  </s>    ,           GPO.  ,    . <br><br> MSDN  ,      GPO (,  ,    AD)       <a href="http://msdn.microsoft.com/en-us/library/system.directoryservices.extendedrightaccessrule.aspx">System.DirectoryServices.ExtendedRightAccessRule</a> .           : ,      : <br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta"># PowerShell  ,    ACE,     $NewRule = New-Object -TypeName System.DirectoryServices.ActiveDirectoryAccessRule -ArgumentList $objTrustee, $objRihgt, $objACT</span></span></code> </pre><br><br>    ,   ArgumentList.   : <b>$objTrustee</b> ‚Äî   ,     . ,    .  ,  ¬´,     ¬ª.   ¬´   <s>   </s>     sales.example.com¬ª <i> </i>  . <br><br>      (   ,   ,        ),        .    ,   :      ,        Windows. , ¬´¬ª    Windows   ¬´Administrator¬ª. <br><br>      MS    ,      .  ,   ,     .      <a href="http://msdn.microsoft.com/en-us/library/system.security.principal.wellknownsidtype.aspx">System.Security.Principal.WellKnownSidType</a> : <br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta"># SID    $SID = [System.Security.Principal.WellKnownSidType]::AccountDomainAdminsSid</span></span></code> </pre><br><br>       Well-Known (..       ),       <a href="http://msdn.microsoft.com/en-us/library/system.security.principal.ntaccount.aspx">System.Security.Principal.NTAccount</a>    : <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">STRING</span></span>]$FQDN = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain().Name $objTrustee = New-Object -TypeName System.Security.Principal.NTAccount -ArgumentList <span class="hljs-string"><span class="hljs-string">"$FQDN"</span></span>, <span class="hljs-string"><span class="hljs-string">"$Trustee"</span></span></code> </pre><br><br>  ,  <i> </i> (   / )   .    <b>  </b> , <b>$objRihgt</b> (     ).         " <i> </i> " [  sales.example.com]. <br><br>  ,    (¬´¬ª, ¬´¬ª, ¬´¬ª  ..) ‚Äî ,          <a href="http://msdn.microsoft.com/ru-ru/library/system.directoryservices.activedirectoryrights.aspx">System.DirectoryServices.ActiveDirectoryRights</a> ,          ,      : <br><pre> <code class="cs hljs">&lt;<span class="hljs-meta"><span class="hljs-meta"># .SYNOPSIS    System.DirectoryServices.ActiveDirectoryRights   . .Description     System.DirectoryServices.ActiveDirectoryRights.     . .PARAMETER StrRight     System.DirectoryServices.ActiveDirectoryRights. .OUTPUTS System.DirectoryServices.ActiveDirectoryRights  $null.    System.DirectoryServices.ActiveDirectoryRights,   ,  $null (      ) #&gt; Function Convert-ToAccessRight([STRING]$StrRight) { $Res = $null $ErrorActionPreference = "SilentlyContinue" $Res = [System.DirectoryServices.ActiveDirectoryRights]::$StrRight $ErrorActionPreference = "Stop" Return $Res }</span></span></code> </pre><br><br>      <b> </b> (          " <i></i> "), <b>$objACT</b> ‚Äî    (,      ¬´¬ª (Allow),   ¬´¬ª (Deny)).  ,      MSDN    , <a href="http://msdn.microsoft.com/en-us//library/w4ds5h86.aspx">System.Security.AccessControl.AccessControlType</a> ,      (   )   : <br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#  $objACT = [System.Security.AccessControl.AccessControlType]::Allow #  $objACT = [System.Security.AccessControl.AccessControlType]::Deny</span></span></code> </pre><br><br>            : <br><pre> <code class="cs hljs">&lt;<span class="hljs-meta"><span class="hljs-meta"># :     "gForbidden_Users"   GPO "pForbidden_GPO"   "Example.com" #&gt; #: #   ,    [STRING]$FQDN = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain().Name #   "gForbidden_Users",      $objTrustee = New-Object -TypeName System.Security.Principal.NTAccount -ArgumentList "$FQDN", "gForbidden_Users" #    $objActDeny = [System.Security.AccessControl.AccessControlType]::Deny #    $objRihgt = [System.DirectoryServices.ActiveDirectoryRights]::GenericRead #   "  'gForbidden_Users' ".       GPO 'gForbidden_Users' $NewRule = New-Object -TypeName System.DirectoryServices.ActiveDirectoryAccessRule -ArgumentList $objTrustee, $objRihgt, $objACT #   GPO   . $GPMGPO = Get-GPO -DomainDNSName "Example.com" -GPOName "pForbidden_GPO" #  COM-    .NET-  System.DirectoryServices.DirectoryEntry [STRING]$GPOPath = $GPMGPO.Path $objGPO = New-Object System.DirectoryServices.DirectoryEntry -ArgumentList "LDAP://$GPOPath" #         GPO #      ,      $objGPO.ObjectSecurity.AddAccessRule($NewRule) | Out-Null # . $objGPO.CommitChanges() | Out-Null</span></span></code> </pre><br><br>  ,        GPO AD .     :   ,         DFS ( <i>\\domanname.example.com\SYSVOL\</i> ).         ,      GPO.  ,     , GPMC   : <br><img src="https://habrastorage.org/storage2/c7b/d54/59c/c7bd5459c037b965f0163cdf6d707f6a.png"><br><br>  ,  , :           GPO,    . , ,    ,       SYSVOL,    .    ,  GPMC          GPO.          GPMC,   ()    : <br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#FQDN-  $DomainDNSName = "Example.com" #  GPO,       $GPOName = "pForbidden_GPO" #   GPO    $GPMGPO = Get-GPO -DomainDNSName $DomainDNSName -GPOName $GPOName #  $GPOSecurityInfo = $GPMGPO.GetSecurityInfo() #   ,    . # GPMC         SYSVOL. $GPMGPO.SetSecurityInfo($GPOSecurityInfo) | Out-Null</span></span></code> </pre><br><br><h4>  Conclusion </h4><br>    ¬´¬ª  ,   (   )        AD ‚Äî  ,      . ,          ,   . <br><br>   ‚Äî  ,            AD  .      ,     ¬´  ¬ª,      XML-           (          , ,     ,    ..). <br><br>          .    ,     ,      <a href="http://pastebin.com/mESyYfjW">CM_ActiveDirectory</a> ,    <a href="http://pastebin.com/Fns0DpcZ"></a>  PasteBin.    ,       ,    <a href="http://pastebin.com/XG3c1Jhf">CM_System</a> ,  (   <a href="http://pastebin.com/ufjYMNEg"> </a> )    . <br><br> ,     .  ,   2012  ,      ,    ,       .       , ‚Äî  !  ,    ¬´¬ª     . <br><br>   , ! <br></div><p>Source: <a href="https://habr.com/ru/post/160503/">https://habr.com/ru/post/160503/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160485/index.html">A bit about Deadlock</a></li>
<li><a href="../160489/index.html">Cyclocopter - the original aircraft with vertical takeoff</a></li>
<li><a href="../160491/index.html">3D printer creating color paper models</a></li>
<li><a href="../160493/index.html">Smart home based on Z-Wave</a></li>
<li><a href="../160497/index.html">Xen Cloud Platform 1.6 released</a></li>
<li><a href="../160513/index.html">Intel invites habragers to an event for bloggers</a></li>
<li><a href="../160517/index.html">What is an in-memory data grid</a></li>
<li><a href="../160519/index.html">Mobile office from a tablet or a review of Polaris Office</a></li>
<li><a href="../160521/index.html">Asterisk server backup implementation</a></li>
<li><a href="../160523/index.html">The first service pack for Visual Studio 2012 has been released</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>