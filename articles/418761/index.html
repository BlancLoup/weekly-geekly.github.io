<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The book "Pure Python. Subtleties programming for pros</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habrozhiteli! Learning all the features of Python is a difficult task, and with this book you can focus on the practical skills that are really im...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The book "Pure Python. Subtleties programming for pros</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habr.com/company/piter/blog/418761/"><img src="https://habrastorage.org/webt/oz/1p/h5/oz1ph5r8f1tudkyhxgbg-tdwhtc.jpeg" align="left" alt="image"></a>  Hi, Habrozhiteli!  Learning all the features of Python is a difficult task, and with this book you can focus on the practical skills that are really important.  Dig out the ‚Äúhidden gold‚Äù in the standard Python library and start writing clean code today. <br><br>  If you have experience with older versions of Python, you can speed up your work with modern templates and features introduced in Python 3. <br><br>  If you have worked with other programming languages ‚Äã‚Äãand want to switch to Python, then you will find practical tips needed to become an effective pythonist. <br>  If you want to learn how to write clean code, then you will find here the most interesting examples and little-known tricks. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Fragment "The Craziest Dictionary Expression in the West" </h3><br>  Sometimes you come across a tiny example of code that has a truly unexpected depth ‚Äî a single line of code that can learn a lot if you think about it well.  Such a piece of code is like a koan in Zen Buddhism: a question or statement used in Zen practice to raise doubts and verify a student‚Äôs achievements. <br><a name="habracut"></a><br>  The tiny snippet of code that we discuss in this section is one such example.  At first glance, it may look like a straightforward dictionary expression, but upon closer inspection it sends you on a mind-expanding psychedelic cruise on the Python interpreter. <br><br>  From this one-liner I get such a buzz that once I even typed it on my Python conference participant icon as a reason to talk.  This led to several constructive dialogues with the members of my Python e-mail list. <br>  So without further ado, here is this code snippet.  Take a pause to reflect on the following dictionary expression and what its calculation should lead to: <br><br><pre><code class="hljs css">&gt;&gt;&gt; {<span class="hljs-attribute"><span class="hljs-attribute">True</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>}</code> </pre> <br>  I'll wait here ... <br><br>  OK, ready? <br><br>  The following is the result we will get when evaluating the above dictionary expression in a Python interpreter session: <br><br><pre> <code class="hljs css">&gt;&gt;&gt; {<span class="hljs-attribute"><span class="hljs-attribute">True</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>} {<span class="hljs-attribute"><span class="hljs-attribute">True</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>}</code> </pre> <br>  I admit, when I saw this result for the first time, I was very taken aback.  But everything will fall into place when you conduct a leisurely step-by-step study of what is happening here.  Let's ponder why we get this, I must say, very non-intuitive result. <br><br>  When Python processes our dictionary expression, it first builds a new empty dictionary object, and then assigns keys and values ‚Äã‚Äãto it in the order in which they are passed to the dictionary expression. <br><br>  Then, when we decompose it into parts, our dictionary expression will be equivalent to the sequence of instructions below, which are executed in order: <br><br><pre> <code class="hljs ruby"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;</span></span>&gt; xs = dict() &gt;&gt;&gt; xs[True] = <span class="hljs-string"><span class="hljs-string">''</span></span> &gt;&gt;&gt; xs[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">''</span></span> &gt;&gt;&gt; xs[<span class="hljs-number"><span class="hljs-number">1.0</span></span>] = <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre> <br>  Oddly enough, Python considers all keys used in this dictionary example to be equivalent: <br><br><pre> <code class="hljs python"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">True</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> == <span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span></code> </pre> <br>  All right, but wait a minute.  I'm sure you can intuitively recognize that 1.0 == 1, but why is True also considered equivalent to 1?  The first time I saw this dictionary expression, it really puzzled me. <br><br>  After a little digging in the Python documentation, I learned that Python treats the bool type as a subclass of type int.  This is the case in Python 2 and Python 3: <br><br><blockquote>  A Boolean type is a subtype of an integer type, and Boolean values ‚Äã‚Äãbehave, respectively, as values ‚Äã‚Äã0 and 1 in almost all contexts, with the exception that when converting to string type, respectively, the string values ‚Äã‚Äãare returned 'False' or 'True '. </blockquote><br>  And of course, this means that in Python, boolean values ‚Äã‚Äãcan technically be used as list or tuple indices: <br><br><pre> <code class="hljs markdown">&gt;&gt;&gt; [<span class="hljs-string"><span class="hljs-string">'', ''</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">True</span></span>] ''</code> </pre> <br>  But you probably should not use this kind of logical variables in the name of clarity (and your colleagues' mental health). <br><br>  Anyway, back to our dictionary expression. <br><br>  As for the Python language, all these values ‚Äã‚Äã‚Äî True, 1, and 1.0 ‚Äî represent the same dictionary key.  When the interpreter computes a dictionary expression, it repeatedly rewrites the value of the True key.  This explains why, at the very end, the resulting dictionary contains just one key. <br><br>  Before we go further, let's take another look at the source dictionary expression: <br><br><pre> <code class="hljs css">&gt;&gt;&gt; {<span class="hljs-attribute"><span class="hljs-attribute">True</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>} {<span class="hljs-attribute"><span class="hljs-attribute">True</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>}</code> </pre> <br>  Why do we still get True as the key?  Shouldn't the key be changed to 1.0 at the very end due to repeated assignments at the very end? <br><br>  After some research into the Python interpreter source code, I found out that when a new value is associated with a key object, the Python dictionaries themselves do not update this key object: <br><br><pre> <code class="hljs ruby"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;</span></span>&gt; ys = {<span class="hljs-number"><span class="hljs-number">1.0</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>} &gt;&gt;&gt; ys[True] = <span class="hljs-string"><span class="hljs-string">''</span></span> &gt;&gt;&gt; ys {<span class="hljs-number"><span class="hljs-number">1.0</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>}</code> </pre> <br>  Of course, it makes sense as a performance optimization: if the keys are considered identical, then why waste time updating the original? <br>  In the last example, you saw that the original True object was never replaced as a key.  For this reason, the string representation of the dictionary still prints the key as True (instead of 1 or 1.0). <br><br>  With what we know now, it seems that the values ‚Äã‚Äãin the resulting dictionary are rewritten only because the comparison will always show them as equivalent to each other.  However, it turns out that this effect is not a consequence of the equivalence test using the __eq__ method, either. <br><br>  Python dictionaries are based on a hash table data structure.  When I first saw this amazing dictionary expression, my first thought was that this behavior was somehow related to hash conflicts. <br><br>  The fact is that the hash table in the internal representation stores its keys in different ‚Äúbaskets‚Äù in accordance with the hash value of each key.  The hash value is derived from the key as a fixed-length numeric value that uniquely identifies the key. <br><br>  This fact allows you to perform quick search operations.  It is much faster to find the numeric key hash value in the lookup table than to compare the full key object with all other keys and perform an equivalence check. <br><br>  However, methods for calculating hash values ‚Äã‚Äãare usually not perfect.  And ultimately, two or more keys that are actually different will have the same derived hash value, and they will end up in the same basket of the lookup table. <br>  When two keys have the same hash value, this situation is called a hash conflict and is a special case that the insertion and finding algorithms of the elements in the hash table must deal with. <br><br>  Based on this assessment, it is highly likely that hashing is somehow related to the unexpected result we got from our dictionary expression.  So let's find out if the hash values ‚Äã‚Äãof the keys here also have a specific role. <br>  I define the class below as a small detective tool: <br><br><pre> <code class="hljs python"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AlwaysEquals</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__eq__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, other)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__hash__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id(self)</code> </pre> <br>  This class is characterized by two aspects. <br><br>  First, since the daner __eq__ method always returns True, all instances of this class pretend that they are equivalent to any object: <br><br><pre> <code class="hljs python"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>AlwaysEquals() == AlwaysEquals() <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> &gt;&gt;&gt; AlwaysEquals() == <span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> &gt;&gt;&gt; AlwaysEquals() == <span class="hljs-string"><span class="hljs-string">'?'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span></code> </pre> <br>  And secondly, each instance of AlwaysEquals will also return a unique hash value generated by the built-in id () function: <br><br><pre> <code class="hljs bash">&gt;&gt;&gt; objects = [AlwaysEquals(), AlwaysEquals(), AlwaysEquals()] &gt;&gt;&gt; [<span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>(obj) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> obj <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> objects] [4574298968, 4574287912, 4574287072]</code> </pre> <br>  In Python, the id () function returns the address of an object in RAM, which is guaranteed to be unique. <br><br>  With this class, you can now create objects that pretend that they are equivalent to any other object, but with them will be associated with a unique hash value.  This will make it possible to check whether the dictionary keys are being rewritten, relying only on the result of their comparison for equivalence. <br><br>  And, as you can see, the keys in the following example are not rewritten, although the comparison will always show them as equivalent to each other: <br><br><pre> <code class="hljs cs">&gt;&gt;&gt; {AlwaysEquals(): <span class="hljs-string"><span class="hljs-string">''</span></span>, AlwaysEquals(): <span class="hljs-string"><span class="hljs-string">''</span></span>} { &lt;AlwaysEquals <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> at <span class="hljs-number"><span class="hljs-number">0x110a3c588</span></span>&gt;: <span class="hljs-string"><span class="hljs-string">''</span></span>, &lt;AlwaysEquals <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> at <span class="hljs-number"><span class="hljs-number">0x110a3cf98</span></span>&gt;: <span class="hljs-string"><span class="hljs-string">''</span></span> }</code> </pre> <br>  We can also look at this idea from the other side and check whether returning the same hash value is sufficient reason to force the keys to be rewritten: <br><br><pre> <code class="hljs python"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SameHash</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__hash__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Comparing instances of the SameHash class will show them as not equivalent to each other, but they will all have the same hash value of 1: <br><br><pre> <code class="hljs bash">&gt;&gt;&gt; a = SameHash() &gt;&gt;&gt; b = SameHash() &gt;&gt;&gt; a == b False &gt;&gt;&gt; <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>(a), <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>(b) (1, 1)</code> </pre> <br>  Let's take a look at how Python dictionaries react when we try to use the SameHash class instances as dictionary keys: <br><br><pre> <code class="hljs mel">&gt;&gt;&gt; {a: <span class="hljs-string"><span class="hljs-string">'a'</span></span>, b: <span class="hljs-string"><span class="hljs-string">'b'</span></span>} { &lt;SameHash <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> at <span class="hljs-number"><span class="hljs-number">0x7f7159020cb0</span></span>&gt;: <span class="hljs-string"><span class="hljs-string">'a'</span></span>, &lt;SameHash <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> at <span class="hljs-number"><span class="hljs-number">0x7f7159020cf8</span></span>&gt;: <span class="hljs-string"><span class="hljs-string">'b'</span></span> }</code> </pre> <br>  As this example shows, the ‚Äúkeys are overwritten‚Äù effect is not caused by hash value conflicts alone. <br><br>  Dictionaries perform an equivalence test and compare the hash value to determine if the two keys are the same.  Let's try to summarize the results of our research. <br><br>  The dictionary expression {True: 'yes', 1: 'no', 1.0: 'possibly'} is calculated as {true: 'possible'}, because the comparison of all keys of this example, True, 1, and 1.0, will show them as equivalent to each other, and they all have the same hash value: <br><br><pre> <code class="hljs lisp">&gt;&gt;&gt; True == <span class="hljs-number"><span class="hljs-number">1</span></span> == <span class="hljs-number"><span class="hljs-number">1.0</span></span> True &gt;&gt;&gt; (<span class="hljs-name"><span class="hljs-name">hash</span></span>(<span class="hljs-name"><span class="hljs-name">True</span></span>), hash(<span class="hljs-number"><span class="hljs-number">1</span></span>), hash(<span class="hljs-number"><span class="hljs-number">1.0</span></span>)) (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  Perhaps, now it is not so surprising that we received just such a result as the final state of the dictionary: <br><br><pre> <code class="hljs css">&gt;&gt;&gt; {<span class="hljs-attribute"><span class="hljs-attribute">True</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>} {<span class="hljs-attribute"><span class="hljs-attribute">True</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>}</code> </pre> <br>  Here we touched on a lot of topics, and this particular Python trick at first may not fit in my head - which is why, at the very beginning of this section, I compared it with a koan in Zen. <br><br>  If you have difficulty understanding what is happening in this section, try experimenting in turn with all the code examples in the Python interpreter session.  You will be rewarded by expanding your knowledge of the internal mechanisms of the Python language. <br><br>  ¬ªMore information about the book can be found on <a href="https://www.piter.com/collection/all/product/chistyy-python-tonkosti-programmirovaniya-dlya-profi">the publisher site.</a> <br>  ¬ª <a href="https://storage.piter.com/upload/contents/978544610803/978544610803_X.pdf">Table of Contents</a> <br>  ¬ª <a href="https://storage.piter.com/upload/contents/978544610803/978544610803_p.pdf">Excerpt</a> <br><br>  For Habrozhiteley a discount of 20% for the coupon - <b>Python</b> </div><p>Source: <a href="https://habr.com/ru/post/418761/">https://habr.com/ru/post/418761/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418751/index.html">Dexp brazen chinese spy</a></li>
<li><a href="../418753/index.html">vSAN in VMware based cloud</a></li>
<li><a href="../418755/index.html">How e-commerce survive major promotions. Getting ready for peak loads on the web [Part 1]</a></li>
<li><a href="../418757/index.html">Thinning timeframes (cryptocurrency, forex, stock exchange)</a></li>
<li><a href="../418759/index.html">How much does it cost for a student to release a microcircuit?</a></li>
<li><a href="../418763/index.html">Middle / senior: how to escape from the swamp?</a></li>
<li><a href="../418765/index.html">Tips "Dadata" help fill out any form of input. Now live</a></li>
<li><a href="../418767/index.html">A huge game heritage of Adobe Flash and my attempts to save it</a></li>
<li><a href="../418769/index.html">An example of the calculation of the "availability factor" for the IT-system</a></li>
<li><a href="../418773/index.html">Internet companies have not complied with the "law of spring" due to the lack of secondary legislation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>