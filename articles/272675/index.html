<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostgreSQL Designing a Document-Oriented API: Comprehensive Queries (Part 4)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Keeping documents in Postgres is a bit easier, now we have serious saving procedures , the ability to run full-text search , and some simple search an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostgreSQL Designing a Document-Oriented API: Comprehensive Queries (Part 4)</h1><div class="post__text post__text-html js-mediator-article">  Keeping documents in Postgres is a bit easier, now we have <a href="http://habrahabr.ru/post/272395/">serious saving procedures</a> , the ability to run <a href="http://habrahabr.ru/post/272411/">full-text search</a> , and some simple <a href="http://habrahabr.ru/post/272545/">search and filtering procedures</a> . <br><br>  This is only half the story, of course.  Rudimentary searches can serve the needs of the application, but they will never work in the long run when we need to ask deeper questions. <br><a name="habracut"></a><br><h4>  <b>Source document</b> </h4><br>  Document storage is a very big topic.  How to store a document (and what to store), for me, is divided into three areas: <br><br><ul><li>  Document / Domain Model.  A look at all this from the developer, but if you are a fan of DDD (Domain Driven Design), then this plays a role. </li><li>  Real world.  Invoices, purchases, orders - the business works on these things - let's think about it. </li><li>  Transactions, process results, event sources.  In fact, when something ‚Äúhappens‚Äù with an application, you keep track of everything that happened and keep it. </li></ul><br>  I am very much to the last.  I am an information store and when something happens, I want to know what / why / where to any limits. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      That's what I used to do to save information about people buying something from Tekpub.  This is the format of the document that I was going to put into operation, but never came to this (because of the sale on Plularsight). <br><br><pre><code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"items"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"sku"</span></span>: <span class="hljs-string"><span class="hljs-string">"ALBUM-108"</span></span>, <span class="hljs-string"><span class="hljs-string">"grams"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"price"</span></span>: <span class="hljs-number"><span class="hljs-number">1317</span></span>, <span class="hljs-string"><span class="hljs-string">"taxes"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"vendor"</span></span>: <span class="hljs-string"><span class="hljs-string">"Iron Maiden"</span></span>, <span class="hljs-string"><span class="hljs-string">"taxable"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"quantity"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"discounts"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"gift_card"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"fulfillment"</span></span>: <span class="hljs-string"><span class="hljs-string">"download"</span></span>, <span class="hljs-string"><span class="hljs-string">"requires_shipping"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> } ], <span class="hljs-string"><span class="hljs-string">"notes"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"source"</span></span>: <span class="hljs-string"><span class="hljs-string">"Web"</span></span>, <span class="hljs-string"><span class="hljs-string">"status"</span></span>: <span class="hljs-string"><span class="hljs-string">"complete"</span></span>, <span class="hljs-string"><span class="hljs-string">"payment"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">//... }, "customer": { //... }, "referral": { //... }, "discounts": [], "started_at": "2015-02-18T03:07:33.037Z", "completed_at": "2015-02-18T03:07:33.037Z", "billing_address": { //... }, "shipping_address": { //... }, "processor_response": { //... } }</span></span></code> </pre> <br>  This is a <b>great document</b> .  I <i>love</i> big documents!  This document is the exact result of all information movements during the checkout process: <br><br><ul><li>  Customer addresses (for billing, for delivery) </li><li>  Billing information and what was purchased </li><li>  How they got here and a brief information about what happened on their way (in the form of notes) </li><li>  The exact response from the processor (which itself is a big document) </li></ul><br>  I want this document to be an autonomous, self-contained object that does not need any other documents to be completed.  In other words, I would like to be able to: <br><br><ul><li>  Make an order </li><li>  Run some reports </li><li>  Notify the client about changes, implementation, etc. </li><li>  Take further action if necessary (cancellation, cancellation) </li></ul><br>  This document is complete on its own and that‚Äôs great! <br><br>  OK, enough, let's write some reports. <br><br><h4>  <b>The formation of data.</b>  <b>Actual table</b> </h4><br>  Going analytics it is important to remember two things: <br><br><ul><li>  <b>Never run it on a running system.</b> </li><li>  Denormalization is the norm. </li></ul><br>  Performing huge queries on the combined tables takes forever, and this ultimately leads to nothing.  You should build reports on historical data that do not change (or change very little) over time.  Denormalization helps with speed, and speed is your friend when building reports. <br><br>  Given this, we must use the kindness of PostgreSQL to form our data into <b>a sales fact table</b> .  An ‚Äúactual‚Äù table is simply a denormalized data set that represents an <i>event</i> in your system ‚Äî the smallest amount of digestible information about a <i>fact</i> . <br><br>  For us, this fact is a sale, and we want this event to look like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/71a/112/7eb/71a1127eb7e6adf4969e11857f7604ab.png" alt="image"><br><br>  <i>I use <a href="https://chinookdatabase.codeplex.com/">the Chinook sample database</a> with some random sales data created with <a href="https://github.com/marak/Faker.js/">Faker</a> .</i> <br><br>  Each of these records is a single event that I want to accumulate, and all the information about the dimension with which I want to combine them (time, supplier) is already included.  I can add more (category, etc.), but for now this is enough. <br><br>  This data is in tabular form, which means that we must extract it from the document shown above.  The task is not easy, but much easier because we use PostgreSQL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> items <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> invoice_id, (<span class="hljs-keyword"><span class="hljs-keyword">body</span></span> -&gt;&gt; <span class="hljs-string"><span class="hljs-string">'completed_at'</span></span>)::timestamptz <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, jsonb_array_elements(<span class="hljs-keyword"><span class="hljs-keyword">body</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">'items'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sale_items <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sales ), fact <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> invoice_id, date_part(<span class="hljs-string"><span class="hljs-string">'quarter'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">quarter</span></span>, date_part(<span class="hljs-string"><span class="hljs-string">'year'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">year</span></span>, date_part(<span class="hljs-string"><span class="hljs-string">'month'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>, date_part(<span class="hljs-string"><span class="hljs-string">'day'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span>, x.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> items, jsonb_to_record(sale_items) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> x( sku <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>), vendor <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>), price <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, quantity <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> ) ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> fact;</code> </pre><br>  This is a set of generic table expressions (TSS), combined together in a functional way (see below).  If you have never used OTV - they may look a bit unusual ... until you look closely and understand that you simply combine things together with names. <br><br>  In the first query above, I pull the sales <b>id</b> and call it <b>invoice_id</b> , and then pull the <b>timestamp</b> and convert it to <b>timestampz</b> , simple steps in essence. <br><br>  What becomes more interesting here is <b>jsonb_array_elements</b> , which pulls an array of objects from the document and creates an entry for each of them.  That is, if we had a single document in the database with three objects and would run the following query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> invoice_id, (<span class="hljs-keyword"><span class="hljs-keyword">body</span></span> -&gt;&gt; <span class="hljs-string"><span class="hljs-string">'completed_at'</span></span>)::timestamptz <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, jsonb_array_elements(<span class="hljs-keyword"><span class="hljs-keyword">body</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">'items'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sale_items <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sales</code> </pre><br>  Instead of one record representing the sale, we would get 3: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/248/8d6/39e/2488d639ea6f5489cf11f65f4393e5b2.png" alt="image"><br><br>  Now that we have selected the objects, we need to separate them into separate columns.  Here comes the next trick with <b>jsonb_to_record</b> .  We can immediately use this function, describing type values ‚Äã‚Äãon the fly: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> jsonb_to_record( <span class="hljs-string"><span class="hljs-string">'{"name" : "Rob", "occupation": "Hazard"}'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>), occupation <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) )</code> </pre><br>  In this simple example, I convert <b>jsonb</b> to a table ‚Äî all I <b>need</b> to do is tell PostgreSQL how to do it.  This is exactly what we are doing in the second OTV (‚Äúevent‚Äù) above.  Also, we use <b>date_part</b> to convert dates. <br><br>  This gives us an event table that we can save to the view if we: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> sales_fact <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-comment"><span class="hljs-comment">-- the query above</span></span></code> </pre><br>  You might think this request is terribly slow.  In fact, it is quite fast.  This is not some level mark, or something like that - just a relative result to show you that this query is, in fact, fast.  I have 1000 test documents in the database, the execution of this query on all documents returns in about a tenth of a second: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bf7/ddb/e42/bf7ddbe42f5ecd621be9cbae612ae342.png" alt="image"><br><br>  PostgreSQL.  Cool thing. <br><br>  Now we are ready for some savings! <br><br><h4>  <b>Sales report</b> </h4><br>  Then everything is easier.  You simply combine the data you want, and if you have forgotten about something, you simply add it to your view and you do not have to worry about any table joins.  Just a data conversion that really happens quickly. <br><br>  Let's see the top five sellers: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> sku, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(quantity) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sales_count, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>((price * quantity)/<span class="hljs-number"><span class="hljs-number">100</span></span>)::money <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> sales_total <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sales_fact <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> sku <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> salesCount <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre><br>  This query returns data in 0.12 seconds.  Fast enough for 1000 entries. <br><br><h4>  <b>PTS and functional requests</b> </h4><br>  One of the things I really like about <b>RethinkDB</b> is its own query language, ReQL.  He is inspired by Haskell (according to the command) and the whole is in composition (especially for me): <br><br><blockquote>  To understand ReQL, it helps to understand functional programming.  Functional programming is included in the declarative paradigm in which the programmer seeks to describe the value that he wants to calculate, rather than describe the steps necessary to calculate this value.  Database query languages ‚Äã‚Äãtend to tend to a declarative ideal, which at the same time gives the query processor the most freedom in choosing the optimal execution plan.  But while SQL achieves this using special keywords and a specific declarative syntax, ReQL has the ability to express arbitrarily complex operations through a functional composition. </blockquote><br><br>  As can be seen above, we can approximate this using TSS combined together, each of which transforms the data in a specific way. <br><br><h4>  <b>Conclusion</b> </h4><br>  There is a lot more that I could write, but let's just summarize it all with the fact that you can do <i>everything that other document-oriented systems can do</i> and even more.  <a href="http://habrahabr.ru/post/258153/">The capabilities of queries in Postgres are very large</a> - there is a very small list of things you cannot do and, as you have seen, the ability to convert your document into a table structure helps a lot. <br><br>  And this is the end of this small series of articles. </div><p>Source: <a href="https://habr.com/ru/post/272675/">https://habr.com/ru/post/272675/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272661/index.html">NOT unlimited mailbox, or Tale about the secret limitation of Mail.ru</a></li>
<li><a href="../272667/index.html">Practice: How to set up an HP ProLiant ML10v2 server and prepare it for OS installation</a></li>
<li><a href="../272669/index.html">Tarantool as an application server</a></li>
<li><a href="../272671/index.html">ICQ mobile application design contest</a></li>
<li><a href="../272673/index.html">Shadows of the characters in the video The Blacksmith</a></li>
<li><a href="../272677/index.html">Perl5 plugin for IntelliJ IDEA v1.2: Moose and Signatures</a></li>
<li><a href="../272679/index.html">Neural network in Python, part 2: gradient descent</a></li>
<li><a href="../272681/index.html">Compare Swift and Rust</a></li>
<li><a href="../272689/index.html">Own index types in Cach√© DBMS</a></li>
<li><a href="../272693/index.html">Microsoft fixed a dangerous vulnerability in Windows Server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>