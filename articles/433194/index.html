<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Night light with scheduled shutdown</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With the birth of a child there was a question about a nightlight. Somewhere read that it is necessary for a restful sleep. Quickly accustomed to slee...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Night light with scheduled shutdown</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/nf/ev/13/nfev13d1ijvairxa-ebeg7ng7am.jpeg" alt="image"><br><br>  With the birth of a child there was a question about a nightlight.  Somewhere read that it is necessary for a restful sleep.  Quickly accustomed to sleep with a dim light.  It is very convenient to wake up from screams and howls in the middle of the night and see what the baby is complaining about (if you can understand).  Also in dim light, you can soothe, turn over and continue to sleep. <br><br>  First, a test sample of the lamp was made from a piece of yellow LED strip (12 volts), which was used for 1.5 years. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><img src="https://habrastorage.org/webt/an/hw/kd/anhwkdovnnwhdziqqhhbcxr0hbc.jpeg" alt="image"><br><br>  In addition to the fragility of the design, it became annoying every morning to remove the power supply unit from the outlet.  I get up in the morning, from the street in the room comes enough light.  Thus, the lamp is wasted for several hours every day.  Once again in half a year, the Chinese controller of the RGB tape forgot the current setting and it was necessary to search for the control panel to remind it how to work.  I decided to make a new lamp with automatic shutdown, with color adjustment using potentiometers and radio. <br><br>  Quickly assembled a prototype based on arduino nano.  Debugged basic functionality. <br><br><img src="https://habrastorage.org/webt/fb/jy/xu/fbjyxu7k6vr2uk2wa66e2oc58yy.jpeg" alt="image"><br><br>  Taking this opportunity I tried Fritzing.  I did not like it, but the pictures are vivid and ‚Äúfunny‚Äù.  Apparently nothing new has been invented. <br><br><img src="https://habrastorage.org/webt/el/8v/pr/el8vprz7g0kiuxlvu61ac184t7a.jpeg" alt="image"><br><br>  Replaced ‚Äúnano‚Äù with a little-known, arduino-compatible module with a built-in radio transceiver (8-bit controller, performance and versification is comparable to ‚ÄúNana‚Äù).  At home, I already have one device running at 868 MHz, this will be the second.  Brief characteristics from the manufacturer's website: <br><br><div class="spoiler">  <b class="spoiler_title">Brief characteristics</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/jq/6n/c-/jq6nc-tmx6s5s1xlln6t9bm1m8u.png" alt="image"><br></div></div><br><br><img src="https://habrastorage.org/webt/gu/1d/rl/gu1drlc_2banpoqihqjrlsiawms.jpeg" alt="image"><br><br>  I do not see big problems to do the same on ESP8266 (there is a convenient online firmware builder for scripts on LUA).  A little harder on Bluetooth (for flashing the HM-10 module you need an inexpensive programmer, an environment for developing and understanding the protocol).  Although you can use the Bluetooth module with arduine.  But I used ZUNo, because it‚Äôs been waiting for me for a long time, and the entire infrastructure for connecting and managing similar devices to one network is ready (I‚Äôm talking about the smart home network controller). <br>  For all used legs on the Arduino there were analogues in the module. <br><br><img src="https://habrastorage.org/webt/yl/e1/nw/yle1nwmi36wleu53yyx6lunkr0y.png" alt="image"><br><br>  To work with the module from the Arduino IDE you need to configure it (a description of the settings is on the manufacturer's website).  The miracle did not happen.  When trying to compile, I received the error ‚Äúdoesn't support‚Äú for ‚Äùstatement with empty columns or without body!‚Äù.  I used the Adafruit_NeoPixel library.  I climbed into it and saw how many cycles it had and closed it.  I had to go back to the manufacturer's website and look for examples of working with LEDs (the example was quickly found).  So, I'm not the first who faced a similar problem. <br><br>  In order for this lamp to be controlled by radio in the Arduino code, you need to add a macro and implement several functions: <br><br><pre><code class="cpp hljs">ZUNO_SETUP_CHANNELS( ZUNO_SWITCH_MULTILEVEL(getRed, setRed), ZUNO_SWITCH_MULTILEVEL(getGreen, setGreen), ZUNO_SWITCH_MULTILEVEL(getBlue, setBlue), ZUNO_SWITCH_BINARY(switch_getter, switch_setter) );</code> </pre> <br>  This macro describes a Z-Wave device with three multi-level switches (RGB control) and one simple switch (simple on / off). <br><br>  I have the simplest implementation of functions (as in the examples on the manufacturer‚Äôs website).  You can see in the attached listing. <br><br><h3>  <b>Case selection</b> </h3><br>  I already had a case.  <a href="http://gainta.ru/g203mf.html">Sealed with a transparent cover</a> .  Under the cover fit 25 LEDs.  The tests were successful.  The lamp has a large margin in brightness for my room.  The cover of this case is transparent, so I decided to dissipate the light a little. <br><br><img src="https://habrastorage.org/webt/eb/dn/a2/ebdna25kb2xg3dedtuhpib2k8qe.jpeg" alt="image"><br><br>  Sketched colored beads and acrylic cubes, filled with transparent epoxy.  The paint from the colored beads dissolved under the influence of the resin. <br><br><img src="https://habrastorage.org/webt/kq/gh/dn/kqghdnnc4qp4dcxa058oun_zwb4.jpeg" alt="image"><br><br>  The most interesting thing is that the lid from the hermetic case leaked and almost all the resin leaked.  I do not know where I managed to hit the lid, but after drying the crack is clearly visible. <br><br><img src="https://habrastorage.org/webt/1h/aa/aq/1haaaqrcyeoacbznogmwonzgb8g.jpeg" alt="image"><br><br>  Printed circuit board made photoresistive. <br><br><img src="https://habrastorage.org/webt/me/3w/th/me3wthtnt9ybhvyzc3v_-nhvy0o.jpeg" alt="image"><br><br><img src="https://habrastorage.org/webt/oa/kh/vl/oakhvltkcldrtlncqd8kwkub_ms.jpeg" alt="image"><br><br>  After etching and machining <br><br><img src="https://habrastorage.org/webt/yh/oy/zy/yhoyzyalmtvzihrg_adlie0l0k0.jpeg" alt="image"><br><br>  I replaced the module with a microcontroller with its prototype, lying in the closet (because it‚Äôs not a pity, and ZUNo should be protected).  The first version of ZUNo, but the dimensions are bigger and worse than the antenna, and you can not buy it already.  The tests were more or less successful.  The last segment had to be soldered.  It was originally soldered to the wrong side.  And adjust the number of LEDs in the firmware. <br><br><img src="https://habrastorage.org/webt/_j/wd/ys/_jwdyskx5_cwxqkea6xt7jbkjqk.jpeg" alt="image"><br><br><img src="https://habrastorage.org/webt/gx/qc/qa/gxqcqaaas0qbg7gy54ysyzofbnu.jpeg" alt="image"><br><br>  Here's what happened: <br><br><img src="https://habrastorage.org/webt/i7/fb/0u/i7fb0ul-f1kejvabyxrbhzmkcea.jpeg" alt="image"><br><br><h3>  <b>Radio control</b> </h3><br>  Main window with luminaire control channels <br><br><img src="https://habrastorage.org/webt/zj/r_/_0/zjr__02hc4it_fasqf-qkhi0gle.png" alt="image"><br><br>  Adjust the brightness of one channel of the LED strip <br><br><img src="https://habrastorage.org/webt/1b/80/ho/1b80hohb7oaxhwyyzga6k5osnw0.png" alt="image"><br><br>  Setting the morning off nightlight <br><br><img src="https://habrastorage.org/webt/yx/ar/ua/yxaruahy9rj26onaqu6tbo2uu5a.png" alt="image"><br><br><h3>  <b>Conclusion</b> </h3><br>  The device is working.  It is compact and neat.  Powered by charging a mobile phone. <br>  Of the problems seen: <br><br><ul><li>  during assembly, I cut off some of the tracks on variable resistors, so in manual mode only one channel can be controlled. </li><li>  Of the 25 LEDs, only 20 work normally. I have a lot of this, so I‚Äôll most likely leave it to reveal more serious flaws </li></ul><br><div class="spoiler">  <b class="spoiler_title">Night light sketch</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ZUNO_NeoPixel.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_PIXELS 20 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// NB! Z-Uno can not control more than 25 WS2811 without harming RF communications #define PIXEL_SIZE 3 // Three colors per pixel #define BUFF_SIZE (MAX_PIXELS * PIXEL_SIZE) byte pixel_buff[BUFF_SIZE]; NeoPixel pixels(pixel_buff, BUFF_SIZE); #define B_PRESSED 1 #define BUTTON_PIN 1 // Digital IO pin connected to the button. This will be #define DEF_RED 30 #define DEF_GREEN 20 byte red = DEF_RED; byte green = DEF_GREEN; byte blue = 0; #define POWER_ON 1 #define POWER_OFF 0 byte light_power = POWER_ON; byte last_light_power = POWER_OFF; ZUNO_SETUP_CHANNELS( ZUNO_SWITCH_MULTILEVEL(getRed, setRed), ZUNO_SWITCH_MULTILEVEL(getGreen, setGreen), ZUNO_SWITCH_MULTILEVEL(getBlue, setBlue), ZUNO_SWITCH_BINARY(switch_getter, switch_setter) ); void switch_setter(byte value) { Serial.println("switch"); Serial.print("value= "); Serial.println(value); if(value &gt; 1) light_power = POWER_ON; else light_power = POWER_OFF; } byte switch_getter() { return light_power; } int getRed() { return red/2.56; } int getGreen() { return green/2.56; } int getBlue() { return blue/2.56; } void setRed(byte value) { red = value * 2,56; for(uint8_t i = 0; i &lt; MAX_PIXELS; i++) pixels.setPixelColor(i, pixels.Color(red, green, blue)); pixels.show(); Serial.print("set red = "); Serial.println(value); } void setGreen(byte value) { green = value * 2,56; for(uint8_t i = 0; i &lt; MAX_PIXELS; i++) pixels.setPixelColor(i, pixels.Color(red, green, blue)); pixels.show(); Serial.print("set red = "); Serial.println(value); } void setBlue(byte value) { blue = value * 2,56; for(uint8_t i = 0; i &lt; MAX_PIXELS; i++) pixels.setPixelColor(i, pixels.Color(red, green, blue)); pixels.show(); Serial.print("set red = "); Serial.println(value); } void set_LEDS() { for(uint8_t i = 0; i &lt; MAX_PIXELS; i++) pixels.setPixelColor(i, pixels.Color(red, green, blue)); pixels.show(); } void read_resistors() { red = (analogRead(A0) &gt;&gt; 2) &amp; 0xff; green = (analogRead(A1) &gt;&gt; 2) &amp; 0xff; blue = (analogRead(A3) &gt;&gt; 2) &amp; 0xff; Serial.print(red); Serial.print(" "); Serial.print(green); Serial.print(" "); Serial.print(blue); Serial.print(" "); Serial.println(); set_LEDS(); } #define DEBOUNCE_ACK 10 byte check_button() { static bool oldState = HIGH; byte debounce_cnt = 0; static byte ret = 0; if(digitalRead(BUTTON_PIN) == LOW) { if(ret != B_PRESSED) while(digitalRead(BUTTON_PIN) == LOW) { if(debounce_cnt == DEBOUNCE_ACK) { ret = B_PRESSED; break; } else debounce_cnt++; delay(10); } } else { debounce_cnt = 0; ret = 0; } return ret; } void setup() { Serial.begin(9600); pixels.begin(); pixels.clear(); pinMode(BUTTON_PIN, INPUT_PULLUP); } void loop() { if(check_button() == B_PRESSED) read_resistors(); if(last_light_power != light_power) { Serial.println("set power"); if(light_power == POWER_OFF) { Serial.println("power off"); red = 0; green = 0; blue = 0; } else { Serial.println("power on"); red = DEF_RED; green = DEF_GREEN; blue = 0; } set_LEDS(); last_light_power = light_power; } }</span></span></span></span></code> </pre> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/433194/">https://habr.com/ru/post/433194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../433182/index.html">Is it possible to train with reinforcements agent for trading in the stock market? R language implementation</a></li>
<li><a href="../433184/index.html">ASP.NET Core 2.2 has been released. What's new? (2 of 3)</a></li>
<li><a href="../433186/index.html">It is not enough to count polygons to optimize 3D models.</a></li>
<li><a href="../433188/index.html">The State Duma submitted a bill on the autonomous work of the RuNet</a></li>
<li><a href="../433192/index.html">Kubernetes: an amazingly affordable solution for personal projects</a></li>
<li><a href="../433196/index.html">New Year Gift Guide</a></li>
<li><a href="../433198/index.html">10 dollars on hosting: 20 years ago and today</a></li>
<li><a href="../433202/index.html">The choice of architecture solutions for the marketplace of freight services</a></li>
<li><a href="../433204/index.html">How to learn Java development? The experience of Nikita Chernetsov GeekUniversity student</a></li>
<li><a href="../433206/index.html">We invite you on December 22 to Data Yolku</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>