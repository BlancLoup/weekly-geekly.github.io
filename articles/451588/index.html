<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A note on integration testing using Jenkins on Kubernetes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 


 Almost immediately after installing and configuring CI / CD according to the instructions from the previous post , the team had a questi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A note on integration testing using Jenkins on Kubernetes</h1><div class="post__text post__text-html js-mediator-article"><p>  Good day. </p><br><p>  Almost immediately after installing and configuring CI / CD according to the instructions from the <a href="https://habr.com/ru/post/442614/">previous post</a> , the team had a question about how to correctly perform integration testing.  We already had experience running test dependencies in docker containers, but this became problematic since the build itself was now running in a container.  In this post I would like to describe two possible ways of integration testing inside the container that came up to my team. </p><a name="habracut"></a><br><h2 id="trebovaniya-k-integracionnomu-testirovaniyu">  Integration Testing Requirements </h2><br><p>  By definition, integration testing is called testing, which tests the operation of an application with its dependent components.  Examples include databases, queues, and other services. </p><br><p>  As part of testing, we wanted: </p><br><ul><li>  run tests the same way both locally and on jenkins </li><li>  avoid pre-installation and configuration of dependent applications </li><li>  declare and run dependencies using files in the project repository </li><li>  be able to run multiple builds in parallel </li><li>  it is desirable to be able to add new dependencies in the future </li><li>  it is desirable to be able to test with different versions of the same dependency </li></ul><br><p>  Based on these requirements, we immediately discarded the idea of ‚Äã‚Äãhaving permanent common installations of test databases and queues due to problems with the division of resources between assemblies, the complexity of maintaining and changing this infrastructure. </p><br><h2 id="variant-1-vstroennye-resheniya">  Option 1: Embedded Solutions </h2><br><p>  In the java ecosystem there are quite a few libraries that run dependencies for the test: </p><br><ul><li>  kafka: <a href="https://github.com/chbatey/kafka-unit">https://github.com/chbatey/kafka-unit</a> / <a href="https://github.com/spring-projects/spring-kafka">https://github.com/spring-projects/spring-kafka</a> / <a href="https://github.com/manub/scalatest-embedded-kafka">https://github.com/manub/scalatest-embedded-kafka</a> </li><li>  <a href="https://github.com/jsevellec/cassandra-unit">cassandra</a> </li><li>  <a href="https://github.com/yandex-qatools/postgresql-embedded">postgres</a> </li><li>  <a href="https://github.com/tomakehurst/wiremock">rest api</a> </li></ul><br><p>  This approach is as simple as possible and satisfies most of the requirements described earlier, but is not universal in terms of adding new test dependencies (mysql?) Or using specific or many versions of dependencies. </p><br><p>  Well suited for simple services with 1-2 dependencies. </p><br><h2 id="variant-2-testcontainers">  Option 2: testcontainers </h2><br><p>  Docker is a logical way to resolve the shortcomings of the previous approach: you can find (or create a Docker image) for any dependency with any version.  Probably some of the dependencies are launched in production using the same images. </p><br><p> If locally launching an image (or using docker-compose somewhat) doesn‚Äôt cause problems, then CI will have difficulties as the build itself takes place in a container.  Although it is possible to run docker in docker, but this is <a href="https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/">not recommended by the dind creator himself</a> .  The preferred way to get around this problem is to reuse the already running docker process, which is often called sibling docker.  To do this, the child docker process needs to use <code>/var/run/docker.sock</code> from the parent.  In the previous post, this has already been used to publish docker images with the compiled application. </p><br><p>  It was decided to use the <a href="https://github.com/testcontainers/testcontainers-java">testcontainers</a> library as it: </p><br><ul><li>  provides a good api for managing dependencies </li><li>  has integration with the most popular <a href="https://www.testcontainers.org/modules/databases/">databases</a> and <a href="https://www.testcontainers.org/modules/kafka/">queues</a> </li><li>  uses sibling docker approach when running <a href="https://www.testcontainers.org/supported_docker_environment/continuous_integration/dind_patterns/">in a container</a> </li><li>  works the same locally on ci </li><li>  stops containers after assembly </li></ul><br><p>  Well suited for more complex services or for services with special dependency requirements. </p><br><h2 id="upravlenie-resursami">  Resource management </h2><br><p>  Next, you should pay attention to the resource consumption of the project assembly (which can increase significantly after adding integration tests). </p><br><p>  Currently, the build does not indicate the required amount of memory and cpu shares, which may have two potential problems: </p><br><ul><li>  The first is too many parallel assemblies on one machine, which will result in a high load factor.  Probably, the assembly will be held, but will spend much more time on it. </li><li>  The second is the OOM kill.  Cubernetis may decide that you consume too much memory and just kill the assemblies before they complete. </li></ul><br><p>  To limit the resources of the container in the hearth can be using the structure </p><br><pre> <code class="plaintext hljs"> resources: requests: cpu: 1 memory: 512Mi limits: cpu: 1 memory: 512Mi</code> </pre> <br><p>  Jdk9 and above already have container support (-XX: + UseContainerSupport (enabled by default), works in combination with -XX: InitialRAMPercentage / -XX: MaxRAMPercentage) </p><br><p>  A full example can be found <a href="https://github.com/gmandnepr/habr-demo-app-testcontainers/blob/master/Jenkinsfile">here</a> . </p><br><p>  Jdk8 requires either update 131 and above with the <code>-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap</code> flags enabled <code>-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap</code> to read available memory from cgroup and not from the host machine, or each time to specify the available heap size manually using <code>Xmx</code> . <br>  An example is available <a href="https://github.com/gmandnepr/habr-demo-app-testcontainers/blob/java8/Jenkinsfile">here</a> . </p><br><p>  It is worth noting that kubernetes knows nothing about the resources spent on containers launched using testcontainers or sibling-docker.  To work correctly in this situation, you can reserve resources in the maven container, taking into account all test dependencies. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Integration testing when launching a build in a container is possible and is not a difficult task. </p><br><p>  An example of an application with integration tests using testcontainers can be found <a href="https://github.com/gmandnepr/habr-demo-app-testcontainers">here</a> and the configuration for running Jenkins on kubernetes <a href="https://github.com/gmandnepr/habr-demo-ci-cd/tree/master/jenkins">here</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/451588/">https://habr.com/ru/post/451588/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451574/index.html">We develop the utility on GraalVM</a></li>
<li><a href="../451576/index.html">The book "Our code. Craft, profession, art "</a></li>
<li><a href="../45158/index.html">Whether it is logical to advertise or link to a competitor on the site.</a></li>
<li><a href="../451580/index.html">MODX Digest # 5 (April 22 - May 13, 2019)</a></li>
<li><a href="../451586/index.html">Welcome to BD & DWH Raiffeisen MeetUp</a></li>
<li><a href="../45159/index.html">Conference "Platform 2009"</a></li>
<li><a href="../451596/index.html">Gray .NET Cardinal - John Galloway</a></li>
<li><a href="../451598/index.html">Magic Fairy for unit tests: DSL in C #</a></li>
<li><a href="../4516/index.html">Blogs intercept initiative</a></li>
<li><a href="../451600/index.html">How to write a cover letter when looking for work in the USA: 7 tips</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>