<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we distinguished a trolley from a foreman - video analytics for the hypermarket checkout zone (and a continuation about the cat terminator)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In one construction hypermarket there are 18 cash desks, and we must be able to do so that the cashiers open them in time so that the queue is not mor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we distinguished a trolley from a foreman - video analytics for the hypermarket checkout zone (and a continuation about the cat terminator)</h1><div class="post__text post__text-html js-mediator-article">  In one construction hypermarket there are 18 cash desks, and we must be able to do so that the cashiers open them in time so that the queue is not more than 4 people.  Well, so that the extra cash is not idle open.  This recognition of people (counting buyers) with video, analytics on weather and other factors and prediction of the flow.  Plus a lot of other funny statistics. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3ac/df3/63d/3acdf363df454f9e9c0dfc6019deef9f.png"></div><br>  <i>An example of a queue in front of the cash register is a picture cropped and zamylennaya at the request of security guards, in fact we see a queue longer than in the photo.</i> <br><br>  In retail, the first question was <b>how to distinguish the foreman from the cart.</b>  And it was not at all funny. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Yes, and those who were worried about the terminator cat from the previous post - he was caught.</b>  Details at the end. <a name="habracut"></a><br><br>  Before that, we were doing something similar for commuter train ticket offices and the train itself.  In the case of cash registers, the queue length was perfectly recognized, and cashiers began to work much more optimally.  But on the platforms, it turned out to be cheaper to record hares not with cameras, but just to put the phone in place. <br><br><h4>  Customer clusters </h4><br>  At the entrance we have data from the cameras, looking vertically down at the box office.  The image from them is recognized by Synesis CasRetail software, and we already have not a video stream, but data on what time what object came and what time it left the zone of action. <br><br><img src="https://habrastorage.org/files/dfd/0c6/276/dfd0c62764da4c9b91fccbf3e93fd4d7.png"><br>  <i>Finally, we have a complete complete story analytics that you can tell.</i> <br><br>  <b>Here is an example of the log (did not decipher, and so it should be clear):</b> <br><br><pre><code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"camera"</span></span> : <span class="hljs-string"><span class="hljs-string">"22f961d5-9cfc-4214-8870-65edb79fe373"</span></span>, <span class="hljs-string"><span class="hljs-string">"start"</span></span> : <span class="hljs-string"><span class="hljs-string">"2016-09-11T14:28:03+03:00"</span></span>, <span class="hljs-string"><span class="hljs-string">"end"</span></span> : <span class="hljs-string"><span class="hljs-string">"2016-09-11T14:29:00+03:00"</span></span>, <span class="hljs-string"><span class="hljs-string">"rules"</span></span> : [ <span class="hljs-comment"><span class="hljs-comment">//    { "counter" : 12, "rule" : "36da29cf-7858-4bc6-9b11-55ff129aeaa7", "extendedStatistics" : [ "2015-02-11T14:28:04+03:00", "2015-02-11T14:28:04+03:00", "2015-02-11T14:28:12+03:00"] // (optional) }, //    { "counter" : 0, "histogram":[57.61533203125003,0.0, .., 0.0,0.0], // total 256 items "lifetimeHistogram" : [], "lifetimeHistogramStep" : 60, "lostObjectsCounter" : 2, "bornObjectsCounter" : 0, "objectsAtEndInterval" : 12, "rule" : "ea473652-2f7d-49fc-bce0-e6d93e472c17" } ] }</span></span></code> </pre> <br>  <b>We could not take data from cash registers on checks</b> - they are directly connected to Europe via VPN, and, alas, there are two personal laws that need to be overcome.  In general, if we don‚Äôt want to wait a year (and we don‚Äôt), this data is not in practice. <br><br>  The software processes the 640x480 image and, by the way, for the task of counting customers, more is not needed.  The system copes easily ...  Yes, downsample almost 3 times and this increases the speed of image processing.  It does not need a lot of megapixels, as a person can occupy only 30-40 pixels in a frame. <br><br>  The problem of determining the number of people from the log was not solved at all, and this is why: <br><br><ul><li>  <b>The buyer may come in crowds (for example, family).</b>  In fact there will be 3-4 people, but really - one check.  And the data about the check in a European country, and if you do not want to wait a year ... well, you understand. </li><li>  <b>A foreman may come, collect building materials in 3-4 carts</b> and leave.  The system will fix the group of objects, but again the buyer will be alone. </li><li>  <b>Mother with a stroller and a cart</b> - these are 3 incomprehensible objects. </li></ul><br>  We came to the conclusion that right at the checkout, such a task is not solved quickly, without digging into a low level of recognition, in any way.  Industrialized, of course, you can profile carts and other objects, but we remembered Uncle Dijkstra with his history with railway cars and decided to watch more. <br><br>  <b>After a few days of observing the habits of the carts, it turned out that they cling to people.</b>  And the group of people who made one check almost simultaneously leaves the cashier area.  That is, the task was reduced to counting clusters of objects that go beyond the virtual cashier line (in the picture - tripwire_11) - and this is solved very simply.  By the way, the line is needed in order to correctly understand when a person left the cash register.  because if he left the zone, he could simply leave the queue back into the hall (for example, he was freaked out, did not wait). <br><br>  That is, the system gives real-time statistics ‚Äútwo objects ‚âà one customer‚Äù and from this it shows the queue length.  And with a delay of 1 minute, it validates itself and specifies how many buyers were in fact based on how they behaved at the cash register. <br><br>  It was super cool.  We solved almost all the problems with such a system with an error of 2-5% (depending on the number of carts, cleaners, guards, and other deviations from the statistical average). <br><br><h4>  Recognition Surprises </h4><br>  So we: <br><br><ul><li>  We know the incoming flow of people for every day and we know it in real time. </li><li>  We know the length of the queue at each checkout. </li><li>  We are able to make real-time notifications about the need to open a cashier (somewhere there is a queue longer than 4-5 people). </li><li>  We are able to close cash registers if they are empty. </li><li>  We begin to collect data for analytics to predict the schedule of cash. </li></ul><br>  Now the system is already six months old, and it works with a good level of scheduling, but then we did not have historical data.  Therefore, to begin with, we calculated loading the cash registers in a couple of weeks.  The conclusions were paradoxical: <br><br><ul><li>  Yes, there are times when more cashiers are needed. </li><li>  Yes, there are times when the store is losing due to idle cash registers (hundreds of thousands of rubles per month). </li><li>  The most fun - when the peaks at the box office 10-18 cash desk 1-3 may not be loaded. </li></ul><br>  <b>I‚Äôll say a special thing about the latter: it turns out that people do not know how to correctly distribute at the cash desk.</b>  And it is quite possible that some cash registers are idle and some are loaded.  Skillful distribution allows you to save a lot on the fact, and the store learned it. <br><br><img src="https://habrastorage.org/files/7a6/c95/433/7a6c95433dee4743b9725d25e21712ca.jpg"><br>  <i>The results of the analysis of the dynamics of the maximum and average queue lengths by service areas on one of the dates</i> <br><br><h4>  Project progress </h4><br>  Then we did for the operational manager dashboard, where you can see the data at each checkout every half hour with average and maximum load.  Two penalty features - few people and many people.  It turns out the accumulated statistics: total simple cashiers, overloads, and so on. <br><br>  The minimum change of cashier from the outstaff (external company providing cashiers) is 4 hours.  The sooner the cashier is ordered, the cheaper.  Therefore, further, the task comes down, firstly, to forecasting (you need to know how many cashiers and when necessary, the algorithm, you need to say, is not simple - for those in the subject - it is a blending of 6 models from classic ARIMA to RandomForest (for kaggle lovers - and without xgBoost, you can accurately predict. And secondly, to optimize based on the forecast data, namely, to minimize the total cost of staff, while observing the required level of service and a lot of technical constraints (for example, a cashier's outtaff cannot be pulled less than half a day) . <br><br>  <b>A month later, we solved this problem without taking seasonal peaks into account:</b> <br><br><ul><li>  Historical data by day give accurate downloads by hour. </li><li>  There are profiles for each day of the week. </li><li>  There are special profiles for the situations of ‚Äúprecipitation‚Äù, ‚Äúholiday‚Äù, ‚Äúday before the weekend‚Äù, ‚Äúday before 3 days off‚Äù - these are very important situations for analytics.  Rain, for example, gives minus 18 percent to customers, and the day before 3 days off - plus 14%. </li><li>  There is weather data. </li><li>  There are correlates from other projects (famous schedules of colleagues from around the world) - there are just 3-4 measurements per day, but they are very useful sometimes when there is no data (for example, they will be useful for the New Year). </li><li>  We know the conversion, that is, with what probability coming into the store will become a buyer.  This is just a multiplier to the output stream. </li><li>  For people entering through the ticket office, we also know approximate coefficients - they had to be counted by hand, but they introduce a very small error. </li></ul><br>  All this together is simply arranged as modifiers (each profile is a graph, that is, a matrix), and a superposition of vectors every half hour gives the predicted load.  And then it is imposed a limit on the duration of the shift and the permissible error - and a schedule is drawn up. <br><br>  The system can learn, and verify itself according to the plan-fact scheme.  Plus, you can fasten email-notifications, collect statistics. <br><br><h4>  Farther </h4><br>  In general, the system works.  Marketers are happy.  To her now the last customer from the story with the cat is also looking closely.  There are, among other things, interest among their European colleagues for a number of objects, we count now and for them. <br><br>  And these are the results of our test or ‚Äúcomic‚Äù service called ‚Äútraffic jams in the canteen‚Äù.  It also works fine for a couple of years.  In order to use it, just go to the corporate social network, where in real time you can see the current workload of our office canteen, as well as the forecast of the time needed to defend the queue at the cashier and dine, depending on when to approach.  And what is most interesting is that quite recently such a system wanted to introduce two external customers.  One of them, for example, as it turned out, had been struggling unsuccessfully for 2 years with huge lines in the dining room. <br><br><img src="https://habrastorage.org/files/80a/bc0/cf9/80abc0cf94194144995dbd198efde647.png"><br><br><img src="https://habrastorage.org/files/1c6/f7f/a62/1c6f7fa62e124b6c8828a6933447a997.jpeg"><br><br><h4>  About a cat </h4><br>  I recall in the last post about <a href="https://habrahabr.ru/company/croc/blog/308300/">facial recognition at the entrance to the object</a> was a cat, causing a loss of the store at 50-100 thousand rubles per month.  This tireless hunter was marked on video surveillance with a shadow jumping from above to the fattest bags of food and revealing them in search of warm juicy entrails.  And he was charged a lot of expensive alcohol. <br><br>  The cat left the chase for 4 years.  Even when they gave him (alive) 5 thousand rubles for a reward, they could not catch him for several months.  But after the last post the animal has comprehended habraeffekt: employees were organized and tracked down a wild animal.  The cat caught now lives in the military unit nearest to the store (as a talisman) and gets used to people.  Here is his sly face: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/21e/6b7/ad3/21e6b7ad3e94400da4ca7314f91fdb69.jpeg"></div><br><h4>  More projects </h4><br><ul><li>  <a href="https://habrahabr.ru/company/croc/blog/308300/">Recognition of employees at the turnstile</a> </li><li>  <a href="https://habrahabr.ru/company/croc/blog/158719/">Number Recognition</a> (2012) </li><li>  <a href="https://habrahabr.ru/company/croc/blog/184980/">Voice fingerprints</a> </li><li>  Paranoid <a href="https://habrahabr.ru/company/croc/blog/235565/">Voice Recognition</a> </li><li>  <a href="https://habrahabr.ru/company/croc/blog/151680/">Turnstiles</a> with 3D infrared cameras for quick face recognition </li><li>  My mail is Brahew@croc.ru. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/314318/">https://habr.com/ru/post/314318/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314306/index.html">First steps in optimizing and polishing the game on Unity3d</a></li>
<li><a href="../314308/index.html">What place does the language of Scala in the IT industry</a></li>
<li><a href="../314310/index.html">Design of Russian cities, where is he?</a></li>
<li><a href="../314312/index.html">We draw, code under libGDX and other small joys from the life of an indi-developer</a></li>
<li><a href="../314314/index.html">Console commands with PHPixie Console</a></li>
<li><a href="../314324/index.html">Aidra boosted botnet infected 3,500 devices in less than a week</a></li>
<li><a href="../314326/index.html">Firefox 52 will remove the battery level API to preserve user data privacy</a></li>
<li><a href="../314328/index.html">Comparing objects by value - 1: Beginning</a></li>
<li><a href="../314330/index.html">Analysis of the class of non-stationary processes with stationary increments in stock markets</a></li>
<li><a href="../314332/index.html">Casual Theory of Inventive Problem Solving</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>