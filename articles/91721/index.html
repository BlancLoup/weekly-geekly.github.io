<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The amqpcpp library. Part 2 - Queues</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article "Lib amqpcpp wrapper for librabbitmq" was an overview of publishing messages using the AMQP protocol. This article is a continuation of it...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The amqpcpp library. Part 2 - Queues</h1><div class="post__text post__text-html js-mediator-article">  The article <a href="http://habrahabr.ru/blogs/webdev/91528/">"Lib amqpcpp wrapper for librabbitmq"</a> was an overview of publishing messages using the AMQP protocol.  This article is a continuation of it, which describes how to use the Queues below. <br><a name="habracut"></a><br>  If the Exchange is intended for the publication of messages, then the Queue is intended for receiving messages.  A Link is established between the Exchange and the Queue (Bind or I often translate the Binding) through the Routing key (routing_key). <br>  The queue, similar to the Exchange - must be declared: <blockquote>  AMQP amqp <font color="#008080">;</font> <br>  auto_ptr <font color="#000080">&lt;</font> AMQPQueue <font color="#000080">&gt;</font> qu <font color="#008000">(</font> amqp. <font color="#007788">createQueue</font> <font color="#008000">(</font> <font color="#FF0000">"q2"</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  qu <font color="#000040">-</font> <font color="#000080">&gt;</font> Declare <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#666666">// or</font> <br>  auto_ptr <font color="#000080">&lt;</font> AMQPQueue <font color="#000080">&gt;</font> qu2 <font color="#008000">(</font> amqp. <font color="#007788">createQueue</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  qu2 <font color="#000040">-</font> <font color="#000080">&gt;</font> Declare <font color="#008000">(</font> <font color="#FF0000">"q2"</font> <font color="#008000">)</font> <font color="#008080">;</font> </blockquote><br>  Queues can be: <br><ul><li>  Self-removable (AMQP_AUTODELETE), i.e.  deleted if they are empty and not used (no client connections) </li><li>  Stored (AMQP_DURABLE) i.e.  when the broker restarts, the queues save data </li><li>  Exclusive (AMQP_EXCLUSIVE) i.e.  designed for one connection only </li><li>  Passive (AMQP_PASSIVE) i.e.  client initiation </li></ul><br>  If no parameter is specified, then the default queue is declared as self-deleted (AMQP_AUTODELETE).  In the example below, the Queue is declared as self-deleting and persisting. <br><blockquote>  AMQP amqp <font color="#008080">;</font> <br>  auto_ptr <font color="#000080">&lt;</font> AMQPQueue <font color="#000080">&gt;</font> qu3 <font color="#008000">(</font> amqp. <font color="#007788">createQueue</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  qu3 <font color="#000040">-</font> <font color="#000080">&gt;</font> Declare <font color="#008000">(</font> <font color="#FF0000">"q2"</font> , AMQP_AUTODELETE <font color="#000040">|</font> AMQP_DURABLE <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// durable and autodelete mode</font> </blockquote>  The queue can be: <br><ul><li>  Set AMQPQueue :: Delete (); </li><li>  Clear AMQPQueue :: Purge (); </li><li>  Reset Subscription AMQPQueue :: Cancel (); </li></ul><br>  The queue can be tied to the Exchange (Bind) or untied (unBind).  Binding is done through the routing key.  The key can be simple or composite.  For composite keys, patterns are used.  For example, we subscribe to all the news that is published in the Exchange realty.  Then the key can be "* .news" or we subscribe to all messages that relate to St. Petersburg: "spb. *".  As previously mentioned in part 1, exchanges can be of three types: direct, topic, fanout.  For topic type exchanges pattrens can be used, for direct type exchanges, only simple keys are used, and the fanout type does not use keys at all, so the key value is specified formally, an empty string is specified. <blockquote>  AMQP amqp <font color="#008080">;</font> <br>  auto_ptr <font color="#000080">&lt;</font> AMQPQueue <font color="#000080">&gt;</font> qu3 <font color="#008000">(</font> amqp. <font color="#007788">createQueue</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#666666">// queue and exchange were previously announced</font> <br>  qu3 <font color="#000040">-</font> <font color="#000080">&gt;</font> Bind <font color="#008000">(</font> <font color="#FF0000">"ex"</font> , <font color="#FF0000">"news"</font> <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#666666">// durable and autodelete mode</font> <br></blockquote>  If the Queue is linked to an exchange and messages with a binding key are published in the Exchange, then these messages are redirected to the corresponding queue binding.  There are two ways to read from the Message Queue: <br><ul><li>  asinronno, through the method AMQPQueu :: Get (); </li><li>  synchronously, through the method AMQPQueu :: Consume (); </li></ul>  The AMQPQueu :: Get () method reads one Message from the Queue.  When reading a message, information is transmitted in the header frame - how many more messages are left in the Queue.  Below is an example explained. <br><blockquote>  AMQP amqp <font color="#008080">;</font> <br>  auto_ptr <font color="#000080">&lt;</font> AMQPQueue <font color="#000080">&gt;</font> qu3 <font color="#008000">(</font> amqp. <font color="#007788">createQueue</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#0000ff">while</font> <font color="#008000">(</font> <font color="#0000dd">1</font> <font color="#008000">)</font> <font color="#008000">{</font> <br>  qu2 <font color="#000040">-</font> <font color="#000080">&gt;</font> Get <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  auto_ptr <font color="#000080">&lt;</font> AMQPMessage <font color="#000080">&gt;</font> m <font color="#008000">(</font> qu2 <font color="#000040">-</font> <font color="#000080">&gt;</font> getMessage <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#0000dd">cout</font> <font color="#000080">&lt;&lt;</font> <font color="#FF0000">"count:"</font> <font color="#000080">&lt;&lt;</font> m <font color="#000040">-</font> <font color="#000080">&gt;</font> getMessageCount <font color="#008000">(</font> <font color="#008000">)</font> <font color="#000080">&lt;&lt;</font> endl <font color="#008080">;</font> <br>  <font color="#0000ff">if</font> <font color="#008000">(</font> m <font color="#000040">-</font> <font color="#000080">&gt;</font> getMessageCount <font color="#008000">(</font> <font color="#008000">)</font> <font color="#000080">&gt;</font> <font color="#000040">-</font> <font color="#0000dd">1</font> <font color="#008000">)</font> <font color="#008000">{</font> <br>  <font color="#0000dd">cout</font> <font color="#000080">&lt;&lt;</font> <font color="#FF0000">"message <font color="#000099">\ n</font> "</font> <font color="#000080">&lt;&lt;</font> m <font color="#000040">-</font> <font color="#000080">&gt;</font> getMessage <font color="#008000">(</font> <font color="#008000">)</font> <font color="#000080">&lt;&lt;</font> <font color="#FF0000">" <font color="#000099">\ n</font> message key:"</font> <font color="#000080">&lt;&lt;</font> m <font color="#000040">-</font> <font color="#000080">&gt;</font> getRoutingKey <font color="#008000">(</font> <font color="#008000">)</font> <font color="#000080">&lt;&lt;</font> endl <font color="#008080">;</font> <br>  <font color="#0000dd">cout</font> <font color="#000080">&lt;&lt;</font> <font color="#FF0000">"exchange:"</font> <font color="#000080">&lt;&lt;</font> m <font color="#000040">-</font> <font color="#000080">&gt;</font> getExchange <font color="#008000">(</font> <font color="#008000">)</font> <font color="#000080">&lt;&lt;</font> endl <font color="#008080">;</font> <br>  <font color="#008000">}</font> <font color="#0000ff">else</font> <br>  <font color="#0000ff">break</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br></blockquote>  The AMQPQueu :: Get () method may have an AMQP_NOACK parameter that ‚Äútells‚Äù the broker that this message is not marked as ‚Äúread‚Äù.  Together with the AMQP_NOACK parameter, the AMQPQueu :: Ack () method is used, which confirms that the message has been delivered.  All message information is encapsulated in an AMQPMessage data object.  The Message Object has methods for accessing fields, the names speak for themselves: getMessage (), getExchange (), getRoutingKey (), get MessageCount ().  The focus should be on the getConsumerTag () and getDeliveryTag () methods. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Subscriber's tag (consumer_tag) is an individual unique string, assigned either when publishing, or automatically assigned by a broker, something like a session name.  You can unsubscribe by sending a Cancel command with passing consumer_tag data in the parameter, for example AMQPQueu :: Cancel (m-&gt; getConsumerTag ()). <br><br>  The delivery tag is a numeric value equal to the counter of the delivered messages of this session, for the first message the delivery tag is - 1, for the second - 2, for the third - 3 and so on.  To confirm the receipt of a message, you must call the AMQPQueu :: Ack method (delivery_tag), where the variable delivery_tag is set to the delivery tag. <blockquote>  AMQP amqp <font color="#008080">;</font> <br>  auto_ptr <font color="#000080">&lt;</font> AMQPQueue <font color="#000080">&gt;</font> qu3 <font color="#008000">(</font> amqp. <font color="#007788">createQueue</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#0000ff">while</font> <font color="#008000">(</font> <font color="#0000dd">1</font> <font color="#008000">)</font> <font color="#008000">{</font> <br>  qu2 <font color="#000040">-</font> <font color="#000080">&gt;</font> Get <font color="#008000">(</font> AMQP_NOACK <font color="#008000">)</font> <font color="#008080">;</font> <br>  auto_ptr <font color="#000080">&lt;</font> AMQPMessage <font color="#000080">&gt;</font> m <font color="#008000">(</font> qu2 <font color="#000040">-</font> <font color="#000080">&gt;</font> getMessage <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#0000ff">if</font> <font color="#008000">(</font> m <font color="#000040">-</font> <font color="#000080">&gt;</font> getMessageCount <font color="#008000">(</font> <font color="#008000">)</font> <font color="#000080">&gt;</font> <font color="#000040">-</font> <font color="#0000dd">1</font> <font color="#008000">)</font> <font color="#008000">{</font> <br>  qu2 <font color="#000040">-</font> <font color="#000080">&gt;</font> Ack <font color="#008000">(</font> m <font color="#000040">-</font> <font color="#000080">&gt;</font> getDeliveryTag <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <font color="#0000ff">else</font> <br>  <font color="#0000ff">break</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br></blockquote>  Unlike the AMQPQueue :: Get method, the AMQPQueue :: Consume method has a synchronous reception scheme, so the event model is used here.  Before using the Subscription (Consume) method, you must add the AMQP_MESSAGE event.  An event handler is a function whose input parameter is Message data.  And output, boolean value: stop / no data reception.  More clearly on the example: <blockquote>  AMQP amqp <font color="#008080">;</font> <br>  auto_ptr <font color="#000080">&lt;</font> AMQPQueue <font color="#000080">&gt;</font> qu <font color="#008000">(</font> amqp. <font color="#007788">createQueue</font> <font color="#008000">(</font> <font color="#FF0000">"q2"</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  qu <font color="#000040">-</font> <font color="#000080">&gt;</font> Declare <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#666666">// or</font> <br>  auto_ptr <font color="#000080">&lt;</font> AMQPQueue <font color="#000080">&gt;</font> qu2 <font color="#008000">(</font> amqp. <font color="#007788">createQueue</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  qu2 <font color="#000040">-</font> <font color="#000080">&gt;</font> Declare <font color="#008000">(</font> <font color="#FF0000">"q2"</font> <font color="#008000">)</font> <font color="#008080">;</font> </blockquote><blockquote>  <font color="#0000ff">static</font> <font color="#0000ff">int</font> i <font color="#000080">=</font> <font color="#00dd00">0</font> <font color="#008080">;</font> <br><br>  <font color="#0000ff">int</font> onMessage <font color="#008000">(</font> AMQPMessage <font color="#000040">*</font> message <font color="#008000">)</font> <font color="#008000">{</font> <br>  <font color="#0000ff">char</font> <font color="#000040">*</font> data <font color="#000080">=</font> message <font color="#000040">-</font> <font color="#000080">&gt;</font> getMessage <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">if</font> <font color="#008000">(</font> data <font color="#008000">)</font> <br>  <font color="#0000dd">cout</font> <font color="#000080">&lt;&lt;</font> data <font color="#000080">&lt;&lt;</font> endl <font color="#008080">;</font> <br>  i <font color="#000040">++</font> <font color="#008080">;</font> <br><br>  <font color="#0000dd">cout</font> <font color="#000080">&lt;&lt;</font> <font color="#FF0000">"#"</font> <font color="#000080">&lt;&lt;</font> i <font color="#000080">&lt;&lt;</font> <font color="#FF0000">"tag ="</font> <font color="#000080">&lt;&lt;</font> message <font color="#000040">-</font> <font color="#000080">&gt;</font> getDeliveryTag <font color="#008000">(</font> <font color="#008000">)</font> <font color="#000080">&lt;&lt;</font> endl <font color="#008080">;</font> <br>  <font color="#0000ff">if</font> <font color="#008000">(</font> i <font color="#000080">&gt;</font> <font color="#0000dd">5</font> <font color="#008000">)</font> <br>  <font color="#0000ff">return</font> <font color="#0000dd">1</font> <font color="#008080">;</font> <br>  <font color="#0000ff">return</font> <font color="#0000dd">0</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <font color="#008080">;</font> <br>  something toe was not printed;) <br></blockquote><br><h6>  What to do </h6>  This library does not pretend to completeness, of course I want to develop event logic, add more events, for example, onCancel, onSignal, onTimer. <br>  I think to make multitread for subscription.  It may be necessary to rewrite the network part of librabbitmq, do everything on non-blocking scripts. <h6>  Related Links </h6><br>  <a href="http://habrahabr.ru/blogs/webdev/62502/">AMQP in Russian</a> <br>  <a href="http://habrahabr.ru/blogs/erlang/64192/">RabbitMQ: Introduction to AMQP</a> <br>  <a href="http://akalend.habrahabr.ru/blog/74609/">AMQP.</a>  <a href="http://akalend.habrahabr.ru/blog/74609/">Debugging Applications</a> <br>  <a href="http://habrahabr.ru/blogs/webdev/73904/">PHP-AMQP What's New in Friends?</a> <br>  <a href="http://habrahabr.ru/blogs/webdev/70997/">AMQP-php chat</a> <h6>  Instead of conclusion </h6>  While the status is beta, it works relatively stably.  MPL license.  Those who wish to help the project are always welcome. <br>  Bugs please unsubscribe in <a href="http://code.google.com/p/rabbitcpp/issues/list">tracker</a> <br>  Ideas for further development can be discussed here or in the <a href="http://groups.google.com/group/rabbitmq_rus">mailing list.</a> <br><br>  Ps.  I ask for Russian not to kick hard, I was always at odds with him. <br>  correct errors, write to the PM. </div><p>Source: <a href="https://habr.com/ru/post/91721/">https://habr.com/ru/post/91721/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../91714/index.html">Apple is considering buying ARM Holdings</a></li>
<li><a href="../91716/index.html">The Tale of Testing</a></li>
<li><a href="../91717/index.html">Emulator Opera Mobile is already available</a></li>
<li><a href="../91719/index.html">Last drop or Goodbye, Opera!</a></li>
<li><a href="../91720/index.html">Record Free Freelance School webinar - Effective Portfolio</a></li>
<li><a href="../91724/index.html">What is closer to the truth in the chosen question: "the wisdom of the crowd" or expert opinion?</a></li>
<li><a href="../91725/index.html">How to reduce the size of tables in the SAP system</a></li>
<li><a href="../91726/index.html">Authorization for standalone applications</a></li>
<li><a href="../91727/index.html">That's my file sharing "pressed to the nail"</a></li>
<li><a href="../91729/index.html">Free wifi from skype if you are stuck at the airport</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>