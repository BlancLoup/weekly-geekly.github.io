<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Caphaw Banking Trojan attacks European banks using web injects plugin</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Banking malware Win32 / Caphaw (also known as Shylock ) was used by attackers in carrying out attacks on large European banks, which lasted more than ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Caphaw Banking Trojan attacks European banks using web injects plugin</h1><div class="post__text post__text-html js-mediator-article">  Banking malware <b>Win32 / Caphaw</b> (also known as <b>Shylock</b> ) was used by attackers in carrying out attacks on large European banks, which lasted more than a year.  This threat began to spread in the fall of 2011. Our colleague, <a href="https://twitter.com/matrosov">Alexander Matrosov,</a> carried out a detailed analysis of this banking trojan, and we want to present the most interesting findings made during this analysis.  Win32 / Caphaw differs from other similar threats by the fact that it is one of the few Trojans that can automatically steal money from a bank account when a user is actively working with this account. <br><br><a name="habracut"></a><img src="https://habrastorage.org/storage2/dd8/c84/b80/dd8c84b80fba6497ed1aa2e4d44cedb3.png"><br><br>  The geography of distribution shows that Win32 / Caphaw prevails in England, Italy, Denmark and Turkey.  According to our statistics ESET Virus Radar, the period of time that accounts for the greatest activity of this Trojan is December 2012. The following screenshot shows the geography of Win32 / Caphaw distribution for the last week (at the time of the study). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/f67/6c5/af9/f676c5af9c6e9732aea2bc8524c6a870.png"><br>  Fig.  The geography of the prevalence of Caphaw. <br><br>  <b>Bot</b> <br><br>  <a href="http://www.virusradar.com/en/Win32_Caphaw.K/description">Win32 / Caphaw</a> has the capabilities of a typical banking malware, and also has the ability to check the environment in which it is trying to run.  Such checks are obviously aimed at preventing the launch of the dropper in a system designed for automatic analysis of samples.  We found that Caphaw injects its code into all running processes, and has a multi-threaded architecture for executing tasks sent from C &amp; C.  This code can use interprocess communication (IPC) using named pipes. <br><br><img src="https://habrastorage.org/storage2/60d/a4a/b75/60da4ab7535218842dc97c7654e6b134.png"><br>  Fig.  Creating a stream in which IPC interaction will take place. <br><br>  Caphaw sets up multiple hooks for system functions.  Especially interesting is the intercept function for <i>advapi32! InitiateSystemShutdownEx</i> .  It can control the process of restarting and shutting down the system, as well as allowing the malicious code to perform its reinstallation in the system. <br><br><img src="https://habrastorage.org/storage2/b6a/4ed/a53/b6a4eda53cab1039a3c7af326b87dd5b.png"><br>  Fig.  Intercept the <i>advapi32! InitiateSystemShutdownEx</i> function.  The Trojan is reinstalled into the system. <br><br>  All strings in Caphaw's body are encrypted using a simple algorithm. <br><br><img src="https://habrastorage.org/storage2/e15/ac6/a70/e15ac6a708140bcc1c1b3f472c3c7113.png"><br>  Fig.  String decode code. <br><br>  Caphaw checks the OS environment to see if they are trying to run it in a virtual machine environment (VMware, VirtualBox and VirtualPC).  Malicious code checks the names of running processes and drivers in the system.  Name checking is done using a pre-calculated hash. <br><br><img src="https://habrastorage.org/storage2/33c/f99/4e2/33cf994e25f07f5e0441c414fc021184.png"><br>  Fig.  A function that calculates the hash of a string when checking names. <br><br>  For example, checking for a VMware environment is as follows. <br><br><img src="https://habrastorage.org/storage2/7a5/15f/aa9/7a515faa97bd2af183005185f56b0223.png"><br>  Fig.  Validation code for a VMware environment;  according to a pre-calculated hash, the names of running processes and drivers are checked <br><br>  Every few hours dropper files are repacked using a special service that provides opportunities for using polymorphic cryptor for these purposes.  This approach avoids the static signature detection by antivirus scanners of these droppers.  URL links, from which these droppers are distributed, are as follows: <br><br><img src="https://habrastorage.org/storage2/cd8/ec4/c04/cd8ec4c0428d7de3026fe4001340a381.png"><br>  Fig.  Links leading to the installation of Caphaw droppers. <br><br>  The format of such URLs is: <br><br>  <b>hxxps: // [random subdomain]. [domain] / [DIR] / [DIR-random string] / [dropper file]? r = [random number]</b> <br><br>  To generate random numbers, Caphaw uses the following algorithm: <br><br><img src="https://habrastorage.org/storage2/cd5/b96/927/cd5b969277ee68be514bf12daf61f17e.png"><br>  Fig.  Algorithm for generating random numbers in Caphaw. <br><br>  Caphaw uses C &amp; C to load additional modules, web injects, configuration files, and instructions.  At the same time URL links for working with C &amp; C are: <br><br><img src="https://habrastorage.org/storage2/bb1/e75/665/bb1e756658a8b7585924fae89a89b1c6.png"><br>  Fig.  The URL links that Caphaw uses to interact with C &amp; C. <br><br>  Such URLs, which are used to refer to C &amp; C, are formed according to a special pattern. <br><br>  <b>hxxp: // [URL format] / [key] &amp; id = [bot id] &amp; inst = [master or slave] &amp; net [botnet id] &amp; cmd = cfg</b> <br><br>  The response from the C &amp; C server is: <br><br><img src="https://habrastorage.org/storage2/3a1/37d/ea3/3a137dea3485affa84c1cd8e300cd536.png"><br><br>  In this case, a special template is also used: <br><br>  <b>hxxp: // [random subdomain]. [domain] / [DIR] / [file_name.jpg]? r = [random number]</b> <br><br>  The bot's configuration file is encrypted using RC4 and Base64.  The encryption scheme is: Base64 (RC4 (cfg_data)).  After decryption, the configuration file has the form: <br><br><img src="https://habrastorage.org/storage2/ada/95e/0f4/ada95e0f44bea840c4c22cc1b35e8752.png"><br>  Fig.  Configuration file after decryption. <br><br>  <b>Plugins</b> <br><br>  Win32 / Caphaw has the ability to download and execute additional plug-ins.  The plugins that we watched while tracking the botnet are shown in the table. <br><br><img src="https://habrastorage.org/storage2/699/298/c95/699298c952936fdd17d0080beb81e4e8.png"><br><br>  The plugin used to distribute Caphaw via Skype <a href="http://www.csis.dk/en/csis/blog/3811/">was described by</a> our colleagues from <a href="http://www.csis.dk/">CSIS</a> .  Another interesting plugin is the MBR bootkit module (defined by ESET as <b>Win32 / Wolcape.A</b> ), which is downloaded to infected machines upon special request from C &amp; C.  The bootkit is based on the modification of the MBR and provides for downloading the unsigned driver.  The intercept function to interrupt the int13 (interrupt is used to read sectors from the hard disk) for this bootkit looks like this: <br><br><img src="https://habrastorage.org/storage2/ae3/5dd/b04/ae35ddb04da8522b2c9151b67db19d45.png"><br>  Fig.  Interception on int13. <br><br>  Location of the malicious driver: <br><br><img src="https://habrastorage.org/storage2/e94/e48/e98/e94e48e985d7cc2dd283f057659b5ed5.png"><br><br>  The driver is encrypted using RC4 with a key length of 256 bytes.  The call graph of the function that loads the driver is: <br><br><img src="https://habrastorage.org/storage2/4f2/14e/8ae/4f214e8aee9be2955402af8f0571e47e.png"><br>  Fig.  The graph of the function that loads the driver into the system. <br><br>  The driver intercepts typical system functions in the kernel to hide files and processes.  The most interesting of them intercept the functions of the <b>\ Driver \ nsiproxy</b> and <b>\ Device \ Tcp</b> objects to gain control over the passing network traffic.  The bootkit configuration file is encrypted according to a similar scheme, as is the case with the above.  It also uses a similar XML structure: <br><br><img src="https://habrastorage.org/storage2/6f9/8d3/5d8/6f98d35d856173825f34e25052a9b232.png"><br>  Fig.  Bootkit configuration file <br><br>  <b>Web injections and theft of funds</b> <br><br>  Web injections use a similar form for configuration data, but the encryption algorithm for them is different.  In decrypted form, web injections are as follows: <br><br><img src="https://habrastorage.org/storage2/30c/cfa/db7/30ccfadb7a71eb7b976243ebf9486021.png"><br><br>  Below is a list of banks from the latest web injects configuration files: <br><br><img src="https://habrastorage.org/storage2/4c2/e5f/eb9/4c2e5feb9ec9658c82a904dfaa1fb740.png"><br><br>  One of the most interesting details in the code that is inserted into a web page when you visit an online bank is the substitution of all phone numbers for fake numbers belonging to the attackers ( <a href="http://www.symantec.com/connect/blogs/merchant-malice-trojanshylock-injects-phone-numbers-online-banking-websites">Merchant of Malice: Trojan.Shylock Injects Phone Numbers into Online Banking Websites</a> ).  This substitution is based on a special configuration of web injects and has a unique structure for each individual bank. <br><br><img src="https://habrastorage.org/storage2/41c/aba/18c/41caba18c2fb0b0668829d7f72005da3.png"><br><br>  <b>Conclusion</b> <br><br>  Win32 / Caphaw is an interesting family of banking Trojans.  This malicious code is one of the few who have the functionality to automatically steal money when the user is working with his bank account.  In fact, it is very difficult for an infected user to recognize the fact of theft of funds, as he sees fake forms on the online banking page.  Similar functionality was tracked by us earlier in such families of banking Trojans as Carberp ( <a href="http://www.welivesecurity.com/2012/05/24/carberp-gang-evolution-at-caro-2012/">Carberp Gang Evolution</a> ), Gataka ( <a href="http://www.welivesecurity.com/2012/08/13/win32gataka-banking-trojan-detailed-analysis/">Win32 / Gataka banking Trojan - Detailed analysis</a> ), Win32 / Spy.Ranbyus ( <a href="http://habrahabr.ru/company/eset/blog/169769/">Win32 / Spy.Ranbyus aimed at modifying the Java code of remote systems Ukrainian banking</a> ) and Tinba. </div><p>Source: <a href="https://habr.com/ru/post/171929/">https://habr.com/ru/post/171929/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171911/index.html">ContactManager, part 3. Testing controllers using MockMvc</a></li>
<li><a href="../171913/index.html">Pwn2Own 2013: First Results</a></li>
<li><a href="../171915/index.html">Phalcon 1.0.0 First Beta</a></li>
<li><a href="../171919/index.html">Highlights $ in'y: MongoDB performance in ranges</a></li>
<li><a href="../171925/index.html">What is the difference between using MVC and MVP</a></li>
<li><a href="../171935/index.html">The European program with a grant of 25 thousand euros: How to turn talent into the founder of a startup?</a></li>
<li><a href="../171937/index.html">Simple classifier on PyBrain and PyQt4 (Python3)</a></li>
<li><a href="../171941/index.html">10 devices that you can upgrade, a little digging with electronics</a></li>
<li><a href="../171945/index.html">Began beta testing of Unity 4 Game Engine with Windows 8 support</a></li>
<li><a href="../171947/index.html">Few woman-related English idioms</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>