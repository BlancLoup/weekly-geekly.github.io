<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Checked with the help of PVS-Studio Android source codes, or no one is perfect</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Go 
 Development of large complex projects is impossible without the use of programming methodologies and tools that help control the quality of the c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Checked with the help of PVS-Studio Android source codes, or no one is perfect</h1><div class="post__text post__text-html js-mediator-article">  Go <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d66/7b5/688/d667b56886adb4c140b623e5c14d4fd5.png" alt="Android and Unicorn PVS-Studio"></div><br>  Development of large complex projects is impossible without the use of programming methodologies and tools that help control the quality of the code.  First of all, it is a competent coding standard, code reviews, unit tests, static and dynamic code analyzers.  All this helps to identify defects in the code at the earliest stages of development.  This article demonstrates the capabilities of the PVS-Studio static analyzer to detect errors and potential vulnerabilities in the code of the Android operating system.  We hope that the article will attract the attention of readers to the methodology of static code analysis and they will want to implement it in the process of developing their own projects. <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  A year has passed since the writing of a large <a href="https://www.viva64.com/ru/b/0519/">article</a> about errors in the Tizen operating system, and I wanted to again conduct an equally interesting study of some operating system.  The choice fell on Android. <br><br>  The code of the Android operating system is of high quality, well tested.  During development, at least a static code analyzer is used for the Coverity code, as evidenced by comments like this: <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Coverity: [FALSE-POSITIVE error] intended fall through */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* Missing break statement between cases in switch statement */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* fall through */</span></span></code> </pre> <br>  In general, this is an interesting, high-quality project, and to find errors in it is a challenge for our static analyzer PVS-Studio. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I think, only by the volume of the article, the reader understands that the PVS-Studio analyzer coped with the task perfectly and found a lot of defects in the code of this operating system. <br><br><h2>  Common Weakness Enumeration </h2><br>  In the article you will find references to the <a href="https://cwe.mitre.org/">Common Weakness Enumeration</a> (CWE).  We explain the reason for sending this list and why it is important from a security point of view. <br><br>  Often the cause of vulnerabilities in programs is not a tricky set of circumstances, but a banal program error.  Here it is appropriate to give this quote from <a href="http://www.prqa.com/resources/security-resources-center/">prqa.com</a> : <br><br>  The National Institute of Standards and Technology (NIST) reports that 64% of software vulnerabilities stem from programming errors. <br><br>  You can find the article " <a href="https://www.viva64.com/ru/b/0514/">How can PVS-Studio help in finding vulnerabilities?</a> " With some examples of simple errors that led to vulnerabilities in projects such as MySQL, iOS, NAS, illumos-gate. <br><br>  Accordingly, many vulnerabilities can be eliminated by detecting common errors in time and correcting them.  And here comes the Common Weakness Enumeration. <br><br>  Errors are different, and not all errors are dangerous from a security point of view.  Those errors that could potentially cause a vulnerability are collected in Common Weakness Enumeration.  This list is replenished, and for sure there are errors that can lead to vulnerabilities, but they have not yet been included in this list. <br><br>  However, if the error is classified according to CWE, then it is theoretically possible that it can be exploited as a vulnerability ( <a href="https://ru.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures">CVE</a> ).  Yes, the probability of this is small.  Very rarely, CWE turns into CVE.  However, if you want to protect your code from vulnerabilities, you should, if possible, find as many of the errors described in CWE as possible and fix them. <br><br>  The relationship between PVS-Studio, errors, CWE and CVE is shown schematically in the figure: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/06f/5b9/142/06f5b9142918167cf4e0951f3affbaa6.png" alt="CWE, CVE, PVS-Studio"></div><br><br>  Part of the error is classified as CWE.  PVS-Studio can detect many of these errors, thereby preventing some of these defects from becoming vulnerabilities (CVE). <br><br>  We can say that PVS-Studio reveals many potential vulnerabilities before they caused harm.  Thus, PVS-Studio is a tool for static application security testing ( <a href="https://www.viva64.com/ru/sast/">SAST</a> ). <br><br>  Now, I think, it is clear why, in describing errors, I found it important to note how they are classified according to CWE.  This makes it easier to demonstrate the importance of using a static code analyzer in responsible projects, which are uniquely related to operating systems. <br><br><h2>  Android check </h2><br>  To analyze the project, I used the PVS-Studio analyzer version 6.24.  The analyzer currently supports the following languages ‚Äã‚Äãand compilers: <br><br><ul><li>  Windows  Visual Studio 2010-2017 C, C ++, C ++ / CLI, C ++ / CX (WinRT), C # </li><li>  Windows  IAR Embedded Workbench, C / C ++ Compiler for ARM C, C ++ </li><li>  Windows / Linux.  Keil ¬µVision, DS-MDK, ARM Compiler 5/6 C, C ++ </li><li>  Windows / Linux.  Texas Instruments Code Composer Studio, ARM Code Generation Tools C, C ++ </li><li>  Windows / Linux / macOS.  Clang C, C ++ </li><li>  Linux / macOS.  GCC C, C ++ </li><li>  Windows  MinGW C, C ++ </li></ul><br>  Note.  Perhaps some of our readers missed the news that we supported the work in the macOS environment, and they will be interested in this publication: " <a href="https://www.viva64.com/ru/b/0566/">The release of PVS-Studio for macOS: 64 weaknesses in the Apple XNU Kernel</a> ". <br><br>  The process of verifying Android source codes was not a problem, so I will not dwell on it.  The problem, rather, was my busyness with other tasks, which is why I did not find the time and strength to look at the report as closely as I would like.  However, even a cursory review turned out to be more than enough to collect a large collection of interesting errors for a solid article. <br><br>  The most important thing: I ask the Android developers not only to correct the errors described in the article, but also to conduct a more careful independent analysis.  I looked at the analyzer report superficially and could miss a lot of serious errors. <br><br>  When you first check the analyzer will give a lot of false positives, but <a href="https://www.viva64.com/ru/b/0523/">this is not a problem</a> .  Our team is ready to help with recommendations on how to configure the analyzer to reduce the number of false positives.  We are also ready to provide a license key for a month or more, if required.  In general, <a href="https://www.viva64.com/ru/about-feedback/">write to us</a> , we will help and advise. <br><br>  Now let's see what errors and potential vulnerabilities I managed to find.  I hope you will like what the PVS-Studio static code analyzer can find.  Enjoy reading. <br><br><h2>  Meaningless comparisons </h2><br>  The analyzer considers expressions abnormal if they are always true or false.  Such warnings, according to the Common Weakness Enumeration, are classified as: <br><br><ul><li>  <a href="https://cwe.mitre.org/data/definitions/570.html">CWE-570</a> : Expression is Always False </li><li>  <a href="https://cwe.mitre.org/data/definitions/571.html">CWE-571</a> : Expression is Always True </li></ul><br>  The analyzer generates many such warnings, and, unfortunately, most of them are false for Android code.  In this case, the analyzer is not to blame.  Just the code is written like this. <br>  I will show it on a simple example. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> GENERIC_TARGET const char alternative_config_path[] = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/data/nfc/"</span></span></span><span class="hljs-meta">; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> const char alternative_config_path[] = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> CNxpNfcConfig&amp; CNxpNfcConfig::GetInstance() { .... </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (alternative_config_path[0] != </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'\0'</span></span></span><span class="hljs-meta">) { .... }</span></span></code> </pre> <br>  Here, the analyzer generates a warning: V547 CWE-570 Expression 'alternative_config_path [0]! =' \ 0 '' is always false.  phNxpConfig.cpp 401 <br><br>  The point is that the <i>GENERIC_TARGET</i> macro is not defined, and from the point of view of the analyzer, the code looks like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> alternative_config_path[] = <span class="hljs-string"><span class="hljs-string">""</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (alternative_config_path[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'\0'</span></span>) {</code> </pre> <br>  The analyzer is simply obliged to issue a warning, since the string is empty, and at zero offset there is always a terminal zero.  Thus, the analyzer is formally right, issuing a warning.  However, from a practical point of view, there is no benefit from this warning. <br><br>  With such situations, unfortunately, nothing can be done.  You will have to methodically review all such warnings and mark many places as false positives, so that the analyzer will no longer issue a message code for these lines.  This really needs to be done, because, in addition to meaningless messages, a lot of these defects will be found. <br><br>  I admit honestly that I was not interested in carefully reviewing warnings of this type, and I ran through them superficially.  However, even this will be enough to show that such diagnostics are very useful and find interesting errors. <br><br>  I want to start with the classic situation, when the function of comparing two objects is incorrectly implemented.  Why classic?  This is a typical error pattern, which is constantly found in various projects.  Most likely, there are three reasons for its occurrence: <br><br><ol><li>  Comparison functions are simple and are written ‚Äúon the machine‚Äù and using the Copy-Paste technology.  A person when writing such a code is inconsiderate and often makes typos. </li><li>  Usually, code-review is not performed for such functions, as it is too lazy to watch simple and boring functions. </li><li>  For such functions, unit tests are usually not done.  Because laziness.  In addition, the functions are simple and programmers do not think that errors are possible in them. </li></ol><br>  These thoughts and examples are described in more detail in the article ‚Äú <a href="https://www.viva64.com/ru/b/0509/">Evil lives in comparison functions</a> ‚Äù. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAudioPlaybackRateEqual</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> AudioPlaybackRate &amp;pr1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> AudioPlaybackRate &amp;pr2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">fabs</span></span>(pr1.mSpeed - pr2.mSpeed) &lt; AUDIO_TIMESTRETCH_SPEED_MIN_DELTA &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">fabs</span></span>(pr1.mPitch - pr2.mPitch) &lt; AUDIO_TIMESTRETCH_PITCH_MIN_DELTA &amp;&amp; pr2.mStretchMode == pr2.mStretchMode &amp;&amp; pr2.mFallbackMode == pr2.mFallbackMode; }</code> </pre> <br>  So, we have a classic function of comparing two objects of type <i>AudioPlaybackRate</i> .  And, as I think, the reader realizes that it is wrong.  The PVS-Studio analyzer notices two typos here: <br><br><ul><li>  V501 CWE-571 operator == 'operator: pr2.mStretchMode == pr2.mStretchMode AudioResamplerPublic.h 107 </li><li>  V501 CWE-571 operator: pr2.mFallbackMode == pr2.mFallbackMode AudioResamplerPublic.h 108 </li></ul><br>  The <i>pr2.mStretchMode</i> field and the <i>pr2.mFallbackMode</i> field <i>are</i> compared to themselves.  It turns out that the function compares objects with insufficient accuracy. <br><br>  The following meaningless comparison lives in a function that stores fingerprint information in a file. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveFingerprint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">worker_thread_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* listener, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> idx)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ns = fwrite(&amp;listener-&gt;secureid[idx], <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>, fp); .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nf = fwrite(&amp;listener-&gt;fingerid[idx], <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>, fp); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ns != <span class="hljs-number"><span class="hljs-number">1</span></span> || ns !=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= ALOGW("Corrupt emulator fingerprints storage; " "could not save fingerprints"); fclose(fp); return; }</span></span></code> </pre> <br>  Anomaly is detected in this code at once by two diagnostics: <br><br><ul><li>  V501 CWE-570 |||  operator: ns! = 1 ||  ns! = 1 fingerprint.c 126 </li><li>  V560 CWE-570 A part of conditional expression is always false: ns! = 1. fingerprint.c 126 </li></ul><br>  There is no handling of the situation when the second call to the <i>fwrite</i> function cannot write data to the file.  In other words, the value of the variable <i>nf is</i> not checked.  The correct check should look like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ns != <span class="hljs-number"><span class="hljs-number">1</span></span> || nf != <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  We proceed to the next error associated with the use of the operator <i>&amp;</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> O_RDONLY 00000000 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> O_WRONLY 00000001 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> O_RDWR 00000002 static ssize_t verity_read(fec_handle *f, ....) { .... </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* if we are in read-only mode and expect to read a zero block, skip reading and just return zeros */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (f-&gt;mode &amp; O_RDONLY &amp;&amp; expect_zeros) { memset(data, 0, FEC_BLOCKSIZE); goto valid; } .... }</span></span></code> </pre> <br>  PVS-Studio warning: V560 CWE-570 A part of conditional expression is always false: f-&gt; mode &amp; 00000000. fec_read.cpp 322 <br><br>  Note that the constant <i>O_RDONLY</i> is zero.  This makes the expression <i>f-&gt; mode &amp; O_RDONLY</i> meaningless, since it is always equal to 0. It turns out that the condition of the <i>if statement is</i> never executed, and statement-true is a dead code. <br><br>  The correct check should be: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (f-&gt;mode == O_RDONLY &amp;&amp; expect_zeros) {</code> </pre> <br>  Now let's look at the classic typo when you forgot to write part of the condition. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { .... CHANGE_DISPLAY_INFO = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>, .... }; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> RotaryEncoderInputMapper::configure(<span class="hljs-keyword"><span class="hljs-keyword">nsecs_t</span></span> when, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> InputReaderConfiguration* config, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> changes) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!changes || (InputReaderConfiguration::CHANGE_DISPLAY_INFO)) { .... }</code> </pre> <br>  PVS-Studio warning: V768 CWE-571 The enumeration constant 'CHANGE_DISPLAY_INFO' is used as a variable of a Boolean-type.  InputReader.cpp 3016 <br><br>  The condition is always true, since the <i>InputReaderConfiguration :: CHANGE_DISPLAY_INFO operand</i> is a constant of 4. <br><br>  If you look at how the code is written in the neighborhood, it becomes clear that in fact the condition should be like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!changes || (changes &amp; InputReaderConfiguration::CHANGE_DISPLAY_INFO)) {</code> </pre> <br>  The following comparison, which does not make sense, I met in the statement of the cycle. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_printerAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">ipp_t</span></span> *collection = ippGetCollection(attrptr, i); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (j = <span class="hljs-number"><span class="hljs-number">0</span></span>, attrptr = ippFirstAttribute(collection); (j &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp;&amp; (attrptr != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); attrptr = ippNextAttribute(collection)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(<span class="hljs-string"><span class="hljs-string">"...."</span></span>, ippGetName(attrptr)) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { ....TopMargin = ippGetInteger(attrptr, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(<span class="hljs-string"><span class="hljs-string">"...."</span></span>, ippGetName(attrptr)) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { ....BottomMargin = ippGetInteger(attrptr, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(<span class="hljs-string"><span class="hljs-string">"...."</span></span>, ippGetName(attrptr)) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { ....LeftMargin = ippGetInteger(attrptr, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(<span class="hljs-string"><span class="hljs-string">"...."</span></span>, ippGetName(attrptr)) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { ....RightMargin = ippGetInteger(attrptr, <span class="hljs-number"><span class="hljs-number">0</span></span>); } } .... }</code> </pre> <br>  PVS-Studio warning: V560 CWE-571 A part of conditional expression is always true: (j &lt;4).  ipphelper.c 926 <br><br>  Note that the value of <i>j is</i> not incremented anywhere.  This means that the subexpression <i>(j &lt;4) is</i> always true. <br><br>  The greatest number of useful operations of the PVS-Studio analyzer, which always refer to true / false conditions, refers to the code where the result of creating objects is checked using the <i>new</i> operator.  In other words, the analyzer detects the following code pattern: <br><br><pre> <code class="cpp hljs">T *p = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> T; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ERROR;</code> </pre> <br>  Such checks are meaningless.  If it was not possible to allocate memory for the object, then an exception of the type <i>std :: bad_alloc is generated,</i> and the matter simply does not get to check the value of the pointer. <br><br>  Note.  The <i>new</i> operator can return <i>nullptr</i> if you write <i>new (std :: nothrow) T.</i>  However, this does not apply to the discussed errors.  The PVS-Studio analyzer takes into account <i>(std :: nothrow)</i> and does not issue a warning if an object is created in this way. <br><br>  It may seem that such errors are harmless.  Well, think, an extra check that never works.  Anyway, after all, an exception is generated that will be processed somewhere.  Unfortunately, some developers place actions that free up resources in the statement-true of the <i>if statement</i> , etc.  Since this code is not executed, it can lead to memory leaks and other errors. <br><br>  Consider one of these cases that I noticed in the Android code. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_apk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *target_package_name)</span></span></span><span class="hljs-function"> </span></span>{ .... FileMap *dataMap = zip-&gt;createEntryFileMap(entry); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dataMap == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { ALOGW(<span class="hljs-string"><span class="hljs-string">"%s: failed to create FileMap\n"</span></span>, __FUNCTION__); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *buf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[uncompLen]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> == buf) { ALOGW(<span class="hljs-string"><span class="hljs-string">"%s: failed to allocate %"</span></span> PRIu32 <span class="hljs-string"><span class="hljs-string">" byte\n"</span></span>, __FUNCTION__, uncompLen); <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> dataMap; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } .... }</code> </pre> <br>  PVS-Studio warning: V668 CWE-570 has been defined as the ‚Äúnew‚Äù operator.  The exception will be generated in the case of memory allocation error.  scan.cpp 213 <br><br>  Note that if it is impossible to allocate a second memory block, the programmer tries to free the first block: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> dataMap;</code> </pre> <br>  This code will never get control.  This is a dead code.  If an exception occurs, a memory leak will occur. <br><br>  Writing such code is fundamentally wrong.  For such cases, <a href="https://ru.wikipedia.org/wiki/%25D0%25A3%25D0%25BC%25D0%25BD%25D1%258B%25D0%25B9_%25D1%2583%25D0%25BA%25D0%25B0%25D0%25B7%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C">smart pointers were</a> invented. <br><br>  In total, the PVS-Studio analyzer found in the Android code <b>176</b> places where the pointer is checked after creating objects with <i>new</i> .  I did not begin to understand how dangerous each of these places was, and, of course, I would not overload the article with all these warnings.  Those <a href="http://cppfiles.com/Android/Android_V668.txt">interested</a> can see other warnings in the file <a href="http://cppfiles.com/Android/Android_V668.txt">Android_V668.txt</a> . <br><br><h2>  Null pointer dereferencing </h2><br>  Dereferencing a null pointer leads to undefined program behavior, so it is useful to find and fix such places.  Depending on the situation, the PVS-Studio analyzer can classify these errors according to the Common Weakness Enumeration as follows: <br><br><ul><li>  <a href="https://cwe.mitre.org/data/definitions/119.html">CWE-119</a> : Improve Restriction of Memory Buffer </li><li>  <a href="https://cwe.mitre.org/data/definitions/476.html">CWE-476</a> : NULL Pointer Dereference </li><li>  <a href="https://cwe.mitre.org/data/definitions/628.html">CWE-628</a> : Function Call with Incorrectly Specified Arguments </li><li>  <a href="https://cwe.mitre.org/data/definitions/690.html">CWE-690</a> : Unchecked Return Value to NULL Pointer Dereference </li></ul><br>  I often find such errors in code that is responsible for handling non-standard or incorrect situations.  Nobody tests such code, and the error can live in it for a very long time.  Now will be considered just such a case. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseEffect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xmlProxyLib == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { ALOGE(<span class="hljs-string"><span class="hljs-string">"effectProxy must contain a &lt;%s&gt;: %s"</span></span>, tag, dump(*xmlProxyLib)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } .... }</code> </pre> <br>  PVS-Studio Warning: V522 CWE-476 Dereferencing of the null pointer xmlProxyLib might take place.  EffectsConfig.cpp 205 <br><br>  If the <i>xmlProxyLib</i> pointer is equal to <i>nullptr</i> , then the programmer displays a debugging message, for which it is necessary to dereference this pointer itself.  Oops ... <br><br>  Now consider a more interesting version of the error. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">soinfo_unload_impl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(soinfo* root)</span></span></span><span class="hljs-function"> </span></span>{ .... soinfo* needed = find_library(si-&gt;get_primary_namespace(), library_name, RTLD_NOLOAD, <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>, <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (needed != <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= PRINT("warning: couldn't find %s needed by %s on unload.", library_name, si-&gt;get_realpath()); return; } else if (local_unload_list.contains(needed)) { return; } else if (needed-&gt;is_linked() &amp;&amp; // &lt;= needed-&gt;get_local_group_root() != root) { external_unload_list.push_back(needed); } else { unload_list.push_front(needed); } .... }</span></span></code> </pre> <br>  PVS-Studio warning: V522 CWE-476 Dereferencing of the null pointer 'needed' might take place.  linker.cpp 1847 <br><br>  If the pointer is <i>needed! = Nullptr</i> , then a warning is output, which is a very suspicious program behavior.  Finally, it becomes clear that the code contains an error if you look below and see that if <i>needed == nullptr,</i> a null pointer will be dereferenced in the expression <i>needed-&gt; is_linked ()</i> . <br><br>  Most likely, operators are simply confused here! = And ==.  If a replacement is made, the function code makes sense and the error disappears. <br><br>  The bulk of warnings about a potential null pointer dereference refers to a situation like: <br><br><pre> <code class="cpp hljs">T *p = (T *) <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span> (N); *p = x;</code> </pre> <br>  Functions like <i>malloc</i> , <i>strdup,</i> and so on can return <i>NULL</i> if memory cannot be allocated.  Therefore, you cannot dereference pointers that return these functions without first checking the pointer. <br><br>  There are many similar errors, so I‚Äôll only give two simple code fragments: the first with <br>  <i>malloc</i> and the second with <i>strdup</i> . <br><br><pre> <code class="cpp hljs">DownmixerBufferProvider::DownmixerBufferProvider(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">effect_param_t</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> param = (<span class="hljs-keyword"><span class="hljs-keyword">effect_param_t</span></span> *) <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(downmixParamSize); param-&gt;psize = <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">downmix_params_t</span></span>); .... }</code> </pre> <br>  PVS-Studio warning: V522 CWE-690 There might be a null pointer 'param'.  Check lines: 245, 244. BufferProviders.cpp 245 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">descriptorClassToDot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* str)</span></span></span><span class="hljs-function"> </span></span>{ .... newStr = strdup(lastSlash); newStr[<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(lastSlash)<span class="hljs-number"><span class="hljs-number">-1</span></span>] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; .... }</code> </pre> <br>  PVS-Studio Warning: V522 CWE-690 There might be a null pointer 'newStr'.  Check lines: 203, 202. DexDump.cpp 203 <br><br>  Someone may say that this is a minor error.  If there is not enough memory, the program will simply crash when dereferencing the null pointer, and this is normal.  Since there is no memory, then there is nothing to try to somehow handle this situation. <br><br>  Such a person is wrong.  Pointers must be checked!  I analyzed this topic in detail in the article ‚Äú <a href="https://www.viva64.com/ru/b/0558/">Why it is important to check that the malloc function returned</a> ‚Äù.  I highly recommend reading it to anyone who has not read it yet. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/923/793/0c5/9237930c52039f4f7e0542bee775ce72.png" alt="malloc"></div><br><br>  In short, the danger is that writing to the memory may not necessarily occur near the zero address.  You can write data somewhere very far into a non-write protected memory page, and thus cause a subtle error or you can start using this error as a vulnerability.  Let's see what I mean by the example of the <i>check_size</i> function. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">radio_metadata_buffer_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **metadata_ptr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size_int)</span></span></span><span class="hljs-function"> </span></span>{ .... metadata = <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(metadata, new_size_int * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>)); memmove( (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> *)metadata + new_size_int - (metadata-&gt;count + <span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> *)metadata + metadata-&gt;size_int - (metadata-&gt;count + <span class="hljs-number"><span class="hljs-number">1</span></span>), (metadata-&gt;count + <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>)); .... }</code> </pre> <br>  PVS-Studio warning: V769 CWE-119 The '(uint32_t *) metadata' pointer in the '(uint32_t *) metadata + new_size_int' expression could be nullptr.  In such a case, it will not be used.  Check lines: 91, 89. radio_metadata.c 91 <br><br>  I did not understand the logic of the function, but this is not necessary.  The main thing is that a new buffer is created and the data is copied there.  If the <i>realloc</i> function returns <i>NULL</i> , then the data will be copied to the address (((uint32_t *) NULL + metadata-&gt; size_int - (metadata-&gt; count + 1)). <br><br>  If the <i>metadata-&gt; size_int value is</i> large, the consequences will be regrettable.  It turns out that the data is written to a random memory location. <br><br>  By the way, there is another kind of null pointer dereference, which the PVS-Studio analyzer classifies not as CWE-690, but as CWE-628 (incorrect argument). <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_tcp_ports</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *portstring, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ports)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *buffer; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *cp; buffer = strdup(portstring); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((cp = <span class="hljs-built_in"><span class="hljs-built_in">strchr</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">':'</span></span>)) == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) .... }</code> </pre> <br>  PVS-Studio warning: V575 CWE-628 The potential of the null pointer has passed to 'strchr' function.  Inspect the first argument.  Check lines: 47, 46. libxt_tcp.c 47 <br><br>  The point is that pointer dereferencing will occur when the <i>strchr</i> function is <i>called</i> .  Therefore, the analyzer interprets this situation as a transfer to the function of an incorrect value. <br><br>  The remaining <b>194</b> warnings of this type I list in the file <a href="http://cppfiles.com/Android/Android_V522_V575.txt">Android_V522_V575.txt</a> . <br><br>  By the way, the warnings about checking the pointer after calling the <i>new</i> operator give a special piquancy to all these errors.  It turns out that there are 195 calls to the <i>malloc</i> / <i>realloc</i> / <i>strdup functions,</i> and so on, when the pointer is not checked.  But there are 176 places where the pointer is checked after calling <i>new</i> .  Agree, weird approach! <br><br>  Finally, it remains for us to consider the warnings V595 and V1004, which are also associated with the use of null pointers. <br><br>  V595 detects situations in which the pointer is dereferenced and then checked.  Synthetic example: <br><br><pre> <code class="cpp hljs">p-&gt;foo(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!p) Error();</code> </pre> <br>  V1004 reveals the opposite situation, when first the pointer was checked, and then forgot to do it.  Synthetic example: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p) p-&gt;foo(); p-&gt;doo();</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's look at a few fragments of Android code, where there are errors of this type. </font><font style="vertical-align: inherit;">Specially explain their features is not required.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">PV_STATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RC_UpdateBuffer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(VideoEncData *video, Int currLayer, Int num_skip)</span></span></span><span class="hljs-function"> </span></span>{ rateControl *rc = video-&gt;rc[currLayer]; MultiPass *pMP = video-&gt;pMP[currLayer]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (video == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || rc == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || pMP == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PV_FAIL; .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V595 CWE-476 </font><font style="vertical-align: inherit;">Check lines: 385, 388. rate_control.cpp 385</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resampler_reset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct resampler_itfe *resampler)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resampler</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rsmp</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resampler</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resampler</span></span></span><span class="hljs-class">;</span></span> rsmp-&gt;frames_in = <span class="hljs-number"><span class="hljs-number">0</span></span>; rsmp-&gt;frames_rq = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rsmp != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> &amp;&amp; rsmp-&gt;speex_resampler != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { speex_resampler_reset_mem(rsmp-&gt;speex_resampler); } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: V595 CWE-476: The 'rsmp' </font><font style="vertical-align: inherit;">Check lines: 54, 57. resampler.c 54</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bta_gattc_disc_cmpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tBTA_GATTC_CLCB* p_clcb, UNUSED_ATTR tBTA_GATTC_DATA* p_data)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p_clcb-&gt;status != GATT_SUCCESS) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p_clcb-&gt;p_srcb) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;tBTA_GATTC_SERVICE&gt;().swap( p_clcb-&gt;p_srcb-&gt;srvc_cache); } bta_gattc_cache_reset(p_clcb-&gt;p_srcb-&gt;server_bda); } .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V1004 CWE-476 The 'p_clcb-&gt; p_srcb' pointer was used unsafely after it was verified against nullptr. </font><font style="vertical-align: inherit;">Check lines: 695, 701. bta_gattc_act.cc 701 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Considering other warnings of this type is not interesting. </font><font style="vertical-align: inherit;">Among them there are both errors and false warnings that occur because of poorly or difficultly written code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I wrote a dozen useful warnings:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1004 CWE-476 The 'ain' pointer was used unsafely after it was verified against nullptr. </font><font style="vertical-align: inherit;">Check lines: 101, 105. rsCpuIntrinsicBLAS.cpp 105</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595 CWE-476 The 'outError' pointer was used against nullptr. </font><font style="vertical-align: inherit;">Check lines: 437, 450. Command.cpp 437</font></font></li><li> V595 CWE-476 The 'out_last_reference' pointer was utilized before it was verified against nullptr. Check lines: 432, 436. AssetManager2.cpp 432 </li><li> V595 CWE-476 The 'set' pointer was utilized before it was verified against nullptr. Check lines: 4524, 4529. ResourceTypes.cpp 4524 </li><li> V595 CWE-476 The 'reply' pointer was utilized before it was verified against nullptr. Check lines: 126, 133. Binder.cpp 126 </li><li> V595 CWE-476 The 'video' pointer was utilized before it was verified against nullptr. Check lines: 532, 540. rate_control.cpp 532 </li><li> V595 CWE-476 The 'video' pointer was utilized before it was verified against nullptr. Check lines: 702, 711. rate_control.cpp 702 </li><li> V595 CWE-476 The 'pInfo' pointer was utilized before it was verified against nullptr. Check lines: 251, 254. ResolveInfo.cpp 251 </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595 CWE-476 The 'address' pointer was used before it was verified against nullptr. </font><font style="vertical-align: inherit;">Check lines: 53, 55. DeviceHalHidl.cpp 53</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595 CWE-476 The 'halAddress' pointer was used before it was verified against nullptr. </font><font style="vertical-align: inherit;">Check lines: 55, 82. DeviceHalHidl.cpp 55</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And then I got bored, and I filtered this type of warning. </font><font style="vertical-align: inherit;">Therefore, I do not even know how many real errors were detected by the analyzer. </font><font style="vertical-align: inherit;">These warnings are waiting for their hero, who will carefully examine them and make changes to the code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I just want to draw the attention of my new readers to errors like this:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">NJ_EXTERN NJ_INT16 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">njx_search_word</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NJ_CLASS *iwnn, ....)</span></span></span><span class="hljs-function"> </span></span>{ .... NJ_PREVIOUS_SELECTION_INFO *prev_info = &amp;(iwnn-&gt;previous_selection); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (iwnn == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NJ_SET_ERR_VAL(NJ_FUNC_NJ_SEARCH_WORD, NJ_ERR_PARAM_ENV_NULL); } .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: V595 CWE-476 The 'iwnn' </font><font style="vertical-align: inherit;">Check lines: 686, 689. ndapi.c 686 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some people think that there is no error here, since "there is no real pointer dereference". </font><font style="vertical-align: inherit;">The address of a non-existent variable is simply calculated. </font><font style="vertical-align: inherit;">Further, if the pointer </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iwnn is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zero, then the function will exit. </font><font style="vertical-align: inherit;">Consequently, nothing bad happened that we previously incorrectly calculated the address of a member of the class. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No, you can not talk like that. </font><font style="vertical-align: inherit;">This code leads to undefined behavior, and therefore it is impossible to write like this. </font><font style="vertical-align: inherit;">Indefinite behavior can manifest itself, for example, as follows:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The compiler sees that the pointer is dereferenced: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iwnn-&gt; previous_selection</font></font></i> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> You cannot dereference a null pointer, because this is an undefined behavior. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The compiler infers that the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iwnn</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pointer </font><i><font style="vertical-align: inherit;">is</font></i><font style="vertical-align: inherit;"> always non-zero.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The compiler removes the extra check: if (iwnn == NULL) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Everything, now when executing the program, the check for a null pointer is not performed, and work begins with an incorrect pointer to a class member </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This topic is described in more detail in my article " </font></font><a href="https://www.viva64.com/ru/b/0306/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dereferencing a null pointer leads to undefined behavior</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ."</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Private data is not overwritten </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consider a serious view of a potential vulnerability that is classified according to Common Weakness Enumeration as </font></font><a href="https://cwe.mitre.org/data/definitions/14.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-14</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Compiler Removal. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In short, the point is this: the compiler has the right to remove the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memset</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function call </font><font style="vertical-align: inherit;">, if after that the buffer is no longer used. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When I write about this type of vulnerability, comments will surely appear that this is just a glitch in the compiler that needs to be fixed. </font><font style="vertical-align: inherit;">No, this is not a glitch. </font><font style="vertical-align: inherit;">And before you object, please read the following materials:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Roman Fomichev. </font></font><a href="https://www.viva64.com/ru/b/0388/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secure cleaning of private data</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Common Weakness Enumeration. </font></font><a href="https://cwe.mitre.org/data/definitions/14.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-14</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Description of the diagnosis </font></font><a href="https://www.viva64.com/ru/w/v597/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V597</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, everything is serious. Are there any errors in Android? Of course have. They are generally many where there is: </font></font><a href="https://www.viva64.com/ru/examples/v597/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proof</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">go</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> back to the Android code and look at the beginning and end of the </font><i><font style="vertical-align: inherit;">FwdLockGlue_InitializeRoundKeys</font></i><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">, since we are not interested in the middle.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FwdLockGlue_InitializeRoundKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> keyEncryptionKey[KEY_SIZE]; .... <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(keyEncryptionKey, <span class="hljs-number"><span class="hljs-number">0</span></span>, KEY_SIZE); <span class="hljs-comment"><span class="hljs-comment">// Zero out key data. }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V597 CWE-14 The compiler could delete the memset function call, which is used to flush 'keyEncryptionKey' buffer. The memset_s () function should be used to erase the private data. FwdLockGlue.c 102 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keyEncryptionKey</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> array </font><font style="vertical-align: inherit;">is created on the stack and stores private information. At the end of the function, they want to fill this array with zeros, so that it does not accidentally go anywhere. How information can get where it does not follow, will tell the article " </font></font><a href="https://www.viva64.com/ru/k/0041/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Overwrite memory - why?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To fill an array with private information with zeros, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memset</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function is used </font><font style="vertical-align: inherit;">. The comment ‚ÄúZero out key data‚Äù confirms that we understand everything correctly.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The trouble is that with very high probability the compiler will remove the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memset</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function call when building the release version </font><font style="vertical-align: inherit;">. Since the buffer after the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memset</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> call is </font><font style="vertical-align: inherit;">not used, the call to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memset</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function itself </font><font style="vertical-align: inherit;">is superfluous from the point of view of the compiler. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> warnings I wrote in the file </font></font><a href="http://cppfiles.com/Android/Android_V597.txt"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android_V597.txt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There was another error where the memory is not overwritten, although in this case the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memset</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function has </font><font style="vertical-align: inherit;">nothing to do with it.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SHA1Transform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> buffer[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">64</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> a, b, c, d, e; .... <span class="hljs-comment"><span class="hljs-comment">/* Wipe variables */</span></span> a = b = c = d = e = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V1001 CWE-563 The "a" variable is assigned. </font><font style="vertical-align: inherit;">sha1.c 213 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio revealed an anomaly related to the fact that after assigning variables to values, they are no longer used. </font><font style="vertical-align: inherit;">The analyzer has classified this defect as </font></font><a href="https://cwe.mitre.org/data/definitions/563.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-563</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Assignment to Variable without Use. </font><font style="vertical-align: inherit;">And, formally, he is right, although, in fact, here we are again dealing with CWE-14. </font><font style="vertical-align: inherit;">The compiler will discard these assignments, since from the point of view of C and C ++ they are redundant. </font><font style="vertical-align: inherit;">As a result, the previous values ‚Äã‚Äãof the variables </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">b</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> storing private data </font><font style="vertical-align: inherit;">will remain in the stack </font><font style="vertical-align: inherit;">.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Unspecified / implementation-defined behavior </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> While you are not tired, let's consider a complex case that will require a thorough description on my part. </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> GGLfixed; <span class="hljs-function"><span class="hljs-function">GGLfixed </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gglFastDivx</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GGLfixed n, GGLfixed d)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((d&gt;&gt;<span class="hljs-number"><span class="hljs-number">24</span></span>) &amp;&amp; ((d&gt;&gt;<span class="hljs-number"><span class="hljs-number">24</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>)) { n &gt;&gt;= <span class="hljs-number"><span class="hljs-number">8</span></span>; d &gt;&gt;= <span class="hljs-number"><span class="hljs-number">8</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> gglMulx(n, gglRecip(d)); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V793 It‚Äôs odd that the result of the (d &gt;&gt; 24) + 1 'statement is a part of the condition. </font><font style="vertical-align: inherit;">Perhaps this statement should have been compared with something else. </font><font style="vertical-align: inherit;">fixed.cpp 75 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The programmer wanted to check that the 8 most significant bits of the variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contain ones, but not all the bits at once. </font><font style="vertical-align: inherit;">In other words, the programmer wanted to verify that any value other than 0x00 and 0xFF is in the high byte.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">He approached the solution of this task too creatively. For a start, he checked that the high-order bits are non-zero by writing the expression (d &gt;&gt; 24). There are claims to this expression, but it is more interesting to parse the right side of the expression: ((d &gt;&gt; 24) +1). The programmer shifts the high eight bits to the low byte. However, he expects that the most significant sign bit is duplicated in all other bits.</font></font> Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if the variable d is 0b11111111'00000000'00000000'00000000, then after the shift the value will be 0b11111111'1111111111111111'11111111. Adding 1 to the value 0xFFFFFFFF of type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the programmer plans to get 0. That is: -1 + 1 = 0. Thus, by the expression ((d &gt;&gt; 24) +1), he checks that not all of the older eight bits are equal to 1. I understand that this is quite difficult, so please take some time and try to figure out how and what works :). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now let's see what is wrong with this code.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When shifting, the leading sign bit is not necessarily ‚Äúsmeared‚Äù. Here is what is written about this in the standard: ‚ÄúThe value of E1 &gt;&gt; E2 is E1 right-shifted E2 bit positions. It is an insignia of the E1 / 2 ^ E2. If E1 has a signed value </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We care about the latest offer. So, we met the behavior defined by the implementation (implementation-defined behavior). How this code will work depends on the microprocessor architecture and the compiler implementation. After a shift in the high-order bits, zeros may well appear, and then the expression ((d &gt;&gt; 24) +1) will always be different from 0, i.e. will always be true value.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hence the conclusion: do not be fooled in vain. </font><font style="vertical-align: inherit;">The code will become more reliable and clearer if you write, for example, like this:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">GGLfixed </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gglFastDivx</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GGLfixed n, GGLfixed d)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> hibits = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>&gt;(d) &gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hibits != <span class="hljs-number"><span class="hljs-number">0x00</span></span> &amp;&amp; hibits != <span class="hljs-number"><span class="hljs-number">0xFF</span></span>) { n &gt;&gt;= <span class="hljs-number"><span class="hljs-number">8</span></span>; d &gt;&gt;= <span class="hljs-number"><span class="hljs-number">8</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> gglMulx(n, gglRecip(d)); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probably, I suggested that this is not an ideal variant, but in this code there is no implementation-defined behavior, and it will be easier for the reader to understand what is being tested. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You deserve a cup of coffee or tea. </font><font style="vertical-align: inherit;">Take a break and continue: an interesting case of unspecified behavior awaits us.</font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f53/1a9/86b/f531a986b1bca57105eddf63d12bd50b.png" alt="Attention"></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the interview, I ask the following as one of the first questions to the applicant: ‚ÄúWhat will the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function print </font><font style="vertical-align: inherit;">and why?‚Äù</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%d,%d"</span></span>, i++, i++)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The correct answer is: unspecified behavior. </font><font style="vertical-align: inherit;">The order of calculating the actual arguments when calling a function is not defined. </font><font style="vertical-align: inherit;">Occasionally, I even demonstrate that this code compiled using Visual C ++ displays ‚Äú6.5‚Äù on the screen, which is a complete dead end for newcomers who are weak in knowledge and spirit :). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It may seem like a contrived problem. </font><font style="vertical-align: inherit;">But no, similar code can be found in serious applications, for example, in Android code.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> ComposerClient::CommandReader::parseSetLayerCursorPosition( <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> length) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (length != CommandWriterBase::kSetLayerCursorPositionLength) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> err = mHal.setLayerCursorPosition(mDisplay, mLayer, readSigned(), readSigned()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err != Error::NONE) { mWriter.setError(getCommandLoc(), err); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V681 </font></font><a href="https://cwe.mitre.org/data/definitions/758.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-758</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> language will be called during evaluation of arguments. </font><font style="vertical-align: inherit;">ComposerClient.cpp 836 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We are interested in this line of code:</font></font><br><br><pre> <code class="cpp hljs">mHal.setLayerCursorPosition(...., readSigned(), readSigned());</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By calling the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">readSigned</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function, </font><font style="vertical-align: inherit;">two values ‚Äã‚Äãare read. </font><font style="vertical-align: inherit;">But in what sequence the values ‚Äã‚Äãwill be read, it is impossible to predict. </font><font style="vertical-align: inherit;">This is a classic case of Unspecified Behavior.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The benefits of using a static code analyzer </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This whole article popularizes static code analysis in general, and our PVS-Studio tool in particular. </font><font style="vertical-align: inherit;">However, some errors are just perfect for demonstrating the power of static analysis. </font><font style="vertical-align: inherit;">They are difficult to identify with code reviews, and only a non-tired program easily notices them. </font><font style="vertical-align: inherit;">Consider a couple of such cases.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span>&gt; kBootReasonMap = { .... {<span class="hljs-string"><span class="hljs-string">"watchdog_sdi_apps_reset"</span></span>, <span class="hljs-number"><span class="hljs-number">106</span></span>}, {<span class="hljs-string"><span class="hljs-string">"smpl"</span></span>, <span class="hljs-number"><span class="hljs-number">107</span></span>}, {<span class="hljs-string"><span class="hljs-string">"oem_modem_failed_to_powerup"</span></span>, <span class="hljs-number"><span class="hljs-number">108</span></span>}, {<span class="hljs-string"><span class="hljs-string">"reboot_normal"</span></span>, <span class="hljs-number"><span class="hljs-number">109</span></span>}, {<span class="hljs-string"><span class="hljs-string">"oem_lpass_cfg"</span></span>, <span class="hljs-number"><span class="hljs-number">110</span></span>}, <span class="hljs-comment"><span class="hljs-comment">// &lt;= {"oem_xpu_ns_error", 111}, // &lt;= {"power_key_press", 112}, {"hardware_reset", 113}, {"reboot_by_powerkey", 114}, {"reboot_verity", 115}, {"oem_rpm_undef_error", 116}, {"oem_crash_on_the_lk", 117}, {"oem_rpm_reset", 118}, {"oem_lpass_cfg", 119}, // &lt;= {"oem_xpu_ns_error", 120}, // &lt;= {"factory_cable", 121}, {"oem_ar6320_failed_to_powerup", 122}, {"watchdog_rpm_bite", 123}, {"power_on_cable", 124}, {"reboot_unknown", 125}, .... };</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PVS-Studio warnings: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V766 CWE-462 An item with the same key "oem_lpass_cfg" 'has already been added. </font><font style="vertical-align: inherit;">bootstat.cpp 264</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V766 CWE-462 An item with the same key '"oem_xpu_ns_error"' has already been added. </font><font style="vertical-align: inherit;">bootstat.cpp 265</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Different values ‚Äã‚Äãwith identical keys are inserted into the </font><font style="vertical-align: inherit;">sorted associative container ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">std :: map</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). In terms of the Common Weakness Enumeration, this is the </font></font><a href="https://cwe.mitre.org/data/definitions/462.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-462</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Duplicate Key in Associative List. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The text of the program is reduced, and the errors are marked with comments, so the error seems obvious, but when you just read this code with your eyes, it is very difficult to find such errors. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consider another piece of code that is very difficult to read, because it is of the same type and uninteresting.</font></font><br><br><pre> <code class="cpp hljs">MtpResponseCode MyMtpDatabase::getDevicePropertyValue(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MTP_TYPE_INT8: packet.putInt8(longValue); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MTP_TYPE_UINT8: packet.putUInt8(longValue); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MTP_TYPE_INT16: packet.putInt16(longValue); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MTP_TYPE_UINT16: packet.putUInt16(longValue); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MTP_TYPE_INT32: packet.putInt32(longValue); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MTP_TYPE_UINT32: packet.putUInt32(longValue); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MTP_TYPE_INT64: packet.putInt64(longValue); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MTP_TYPE_UINT64: packet.putUInt64(longValue); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MTP_TYPE_INT128: packet.putInt128(longValue); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MTP_TYPE_UINT128: packet.putInt128(longValue); <span class="hljs-comment"><span class="hljs-comment">// &lt;= break; .... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: V525 </font></font><a href="https://cwe.mitre.org/data/definitions/682.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-682</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The code contains the collection of similar blocks. </font><font style="vertical-align: inherit;">Check items putInt8, putUInt8, putInt16, putUInt16, putInt32, putUInt32, putInt64, putUInt64, putInt128, putInt128 in lines 620, 623, 626, 629 , 632, 635, 638, 641, 644, 647. android_mtp_MtpDatabase.cpp 620 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTP_TYPE_UINT128</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> had to be caused by function </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">putUInt128</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , not </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">putInt128</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And the last in this section is a smart example of an unsuccessful Copy-Paste.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btif_rc_upstreams_evt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> AVRC_PDU_REQUEST_CONTINUATION_RSP: { BTIF_TRACE_EVENT( <span class="hljs-string"><span class="hljs-string">"%s() REQUEST CONTINUATION: target_pdu: 0x%02d"</span></span>, __func__, pavrc_cmd-&gt;continu.target_pdu); tAVRC_RESPONSE avrc_rsp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p_dev-&gt;rc_connected == TRUE) { <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;(avrc_rsp.continu), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(tAVRC_NEXT_RSP)); avrc_rsp.continu.opcode = opcode_from_pdu(AVRC_PDU_REQUEST_CONTINUATION_RSP); avrc_rsp.continu.pdu = AVRC_PDU_REQUEST_CONTINUATION_RSP; avrc_rsp.continu.status = AVRC_STS_NO_ERROR; avrc_rsp.continu.target_pdu = pavrc_cmd-&gt;continu.target_pdu; send_metamsg_rsp(p_dev, <span class="hljs-number"><span class="hljs-number">-1</span></span>, label, ctype, &amp;avrc_rsp); } } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> AVRC_PDU_ABORT_CONTINUATION_RSP: { BTIF_TRACE_EVENT( <span class="hljs-string"><span class="hljs-string">"%s() ABORT CONTINUATION: target_pdu: 0x%02d"</span></span>, __func__, pavrc_cmd-&gt;<span class="hljs-built_in"><span class="hljs-built_in">abort</span></span>.target_pdu); tAVRC_RESPONSE avrc_rsp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p_dev-&gt;rc_connected == TRUE) { <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;(avrc_rsp.<span class="hljs-built_in"><span class="hljs-built_in">abort</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(tAVRC_NEXT_RSP)); avrc_rsp.<span class="hljs-built_in"><span class="hljs-built_in">abort</span></span>.opcode = opcode_from_pdu(AVRC_PDU_ABORT_CONTINUATION_RSP); avrc_rsp.<span class="hljs-built_in"><span class="hljs-built_in">abort</span></span>.pdu = AVRC_PDU_ABORT_CONTINUATION_RSP; avrc_rsp.<span class="hljs-built_in"><span class="hljs-built_in">abort</span></span>.status = AVRC_STS_NO_ERROR; avrc_rsp.<span class="hljs-built_in"><span class="hljs-built_in">abort</span></span>.target_pdu = pavrc_cmd-&gt;continu.target_pdu; send_metamsg_rsp(p_dev, <span class="hljs-number"><span class="hljs-number">-1</span></span>, label, ctype, &amp;avrc_rsp); } } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Before reading the analyzer warning and the following text, I suggest that you look for the error yourself. </font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/83b/679/4ad/83b6794adb823b1fa52e18c91eff1ed2.png" alt="   , Java"></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So that you do not accidentally read the answer, here is a picture for you to divert attention. </font><font style="vertical-align: inherit;">If you are interested in what the egg with the java inscription means, go </font></font><a href="https://www.viva64.com/ru/b/0572/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, I hope you enjoyed typing errors. </font><font style="vertical-align: inherit;">Now is the time to bring a warning analyzer: V778 CWE-682 Two code fragments were found. </font><font style="vertical-align: inherit;">Perhaps this is a typo and variable abort variable instead of 'continu'. </font><font style="vertical-align: inherit;">btif_rc.cc 1554 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apparently, the code was written by the Copy-Paste method, and the person, as always, could not be attentive in the process of editing the copied code fragment. </font><font style="vertical-align: inherit;">As a result, at the very end, he did not replace " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">continu</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " with " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abort</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font><br><br>  Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the second block should be written: </font></font><br><br><pre> <code class="cpp hljs">avrc_rsp.<span class="hljs-built_in"><span class="hljs-built_in">abort</span></span>.target_pdu = pavrc_cmd-&gt;<span class="hljs-built_in"><span class="hljs-built_in">abort</span></span>.target_pdu;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This situation falls entirely within the definition of the ‚Äú </font></font><a href="https://www.viva64.com/ru/b/0260/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">last line effect</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù, since an error occurred during the substitution of names at the end.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Facepalm </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A very funny bug related to the conversion between little-endian and big-endian data formats (see </font></font><a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D1%2580%25D1%258F%25D0%25B4%25D0%25BE%25D0%25BA_%25D0%25B1%25D0%25B0%25D0%25B9%25D1%2582%25D0%25BE%25D0%25B2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Byte Order</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bswap32</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (((pData &amp; <span class="hljs-number"><span class="hljs-number">0xFF000000</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span>) | ((pData &amp; <span class="hljs-number"><span class="hljs-number">0x00FF0000</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | ((pData &amp; <span class="hljs-number"><span class="hljs-number">0x0000FF00</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | ((pData &amp; <span class="hljs-number"><span class="hljs-number">0x000000FF</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">24</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> ELFAttribute::merge(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> subsection_length = *<span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>*&gt;(subsection_data); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (llvm::sys::IsLittleEndianHost != m_Config.targets().isLittleEndian()) bswap32(subsection_length); .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V530 CWE-252 The return value of the function 'bswap32' is required to be utilized. </font><font style="vertical-align: inherit;">ELFAttribute.cpp 84 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> complaints </font><i><font style="vertical-align: inherit;">about the bswap32</font></i><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">But it is used incorrectly:</font></font><br><br><pre> <code class="cpp hljs">bswap32(subsection_length);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The author suggested that the variable is passed to the function by reference and changed there. </font><font style="vertical-align: inherit;">However, you must use the return value of the function. </font><font style="vertical-align: inherit;">As a result, no data conversion occurs. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The analyzer identified this error as </font></font><a href="https://cwe.mitre.org/data/definitions/252.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-252</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Unchecked Return Value. </font><font style="vertical-align: inherit;">But, in fact, it is more appropriate to call here </font></font><a href="https://cwe.mitre.org/data/definitions/198.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-198</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Use of Incorrect Byte Ordering. </font><font style="vertical-align: inherit;">Unfortunately, the analyzer cannot understand what the error is from a high level point of view. </font><font style="vertical-align: inherit;">However, this does not prevent him from identifying this serious defect in the code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The correct code is:</font></font><br><br><pre> <code class="cpp hljs">subsection_length = bswap32(subsection_length);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There are three more places in the Android code with the same error: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V530 CWE-252 The Return Value of Function 'bswap32' is required to be utilized. </font><font style="vertical-align: inherit;">ELFAttribute.cpp 218</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V530 CWE-252 The Return Value of Function 'bswap32' is required to be utilized. </font><font style="vertical-align: inherit;">ELFAttribute.cpp 346</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V530 CWE-252 The Return Value of Function 'bswap32' is required to be utilized. </font><font style="vertical-align: inherit;">ELFAttribute.cpp 352</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To avoid such errors, it is recommended to use the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[[nodiscard]]</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> attribute </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This attribute is used to indicate that the return value of the function must be used when calling. </font><font style="vertical-align: inherit;">Therefore, if you write this:</font></font><br><br><pre> <code class="cpp hljs">[[nodiscard]] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bswap32</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pData)</span></span></span><span class="hljs-function"> </span></span>{ ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">then the error would have been detected at the stage of compiling the file. </font><font style="vertical-align: inherit;">You can learn more about some useful attributes from the article of my colleague " </font></font><a href="https://www.viva64.com/ru/b/0533/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++ 17</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Unreachable code </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In programming and compiler theory, </font></font><a href="https://ru.wikipedia.org/wiki/%25D0%259D%25D0%25B5%25D0%25B4%25D0%25BE%25D1%2581%25D1%2582%25D0%25B8%25D0%25B6%25D0%25B8%25D0%25BC%25D1%258B%25D0%25B9_%25D0%25BA%25D0%25BE%25D0%25B4"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unreachable code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> refers to a piece of program code that cannot be executed under any circumstances, because it is unreachable in the control flow graph. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In terms of Common Weakness Enumeration, this is the </font></font><a href="https://cwe.mitre.org/data/definitions/561.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-561</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Dead Code.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> sp&lt;IEffect&gt; createEffect(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pDesc == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> effect; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { *status = BAD_VALUE; } } .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V779 CWE-561 Unreachable code detected. </font><font style="vertical-align: inherit;">It is possible that an error is present. </font><font style="vertical-align: inherit;">IAudioFlinger.cpp 733 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">return statement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> must be explicitly lower. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other errors of this type:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V779 CWE-561 Unreachable code detected. </font><font style="vertical-align: inherit;">It is possible that an error is present. </font><font style="vertical-align: inherit;">bta_hf_client_main.cc 612</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V779 CWE-561 Unreachable code detected. </font><font style="vertical-align: inherit;">It is possible that an error is present. </font><font style="vertical-align: inherit;">android_media_ImageReader.cpp 468</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V779 CWE-561 Unreachable code detected. </font><font style="vertical-align: inherit;">It is possible that an error is present. </font><font style="vertical-align: inherit;">AMPEG4AudioAssembler.cpp 187</font></font></li></ul><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> break </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A forgotten </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">break</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inside a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">switch</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a classic mistake of C and C ++ programmers. </font><font style="vertical-align: inherit;">To deal with it, in C ++ 17 there was such a useful abstract as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[[fallthrough]]</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">You can read </font><font style="vertical-align: inherit;">more about this error and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[[fallthrough]]</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in my article " </font></font><a href="https://www.viva64.com/ru/b/0554/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">break and fallthrough</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But while the world is full of old code, where </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[[fallthrough]] is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> not used, PVS-Studio will be useful to you. </font><font style="vertical-align: inherit;">Consider a few bugs found in Android. </font><font style="vertical-align: inherit;">According to the Common Weakness Enumeration, these errors are classified as </font></font><a href="https://cwe.mitre.org/data/definitions/484.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-484</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Omitted Break Statement in Switch.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> A2dpCodecConfigLdac::setCodecConfig(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> BTAV_A2DP_CODEC_SAMPLE_RATE_192000: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sampleRate &amp; A2DP_LDAC_SAMPLING_FREQ_192000) { result_config_cie.sampleRate = A2DP_LDAC_SAMPLING_FREQ_192000; codec_capability_.sample_rate = codec_user_config_.sample_rate; codec_config_.sample_rate = codec_user_config_.sample_rate; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> BTAV_A2DP_CODEC_SAMPLE_RATE_16000: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> BTAV_A2DP_CODEC_SAMPLE_RATE_24000: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> BTAV_A2DP_CODEC_SAMPLE_RATE_NONE: codec_capability_.sample_rate = BTAV_A2DP_CODEC_SAMPLE_RATE_NONE; codec_config_.sample_rate = BTAV_A2DP_CODEC_SAMPLE_RATE_NONE; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: V796 CWE-484 It is possible that 'break' statement is missing in switch statement. </font><font style="vertical-align: inherit;">a2dp_vendor_ldac.cc 912 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I think an error in explanation does not need. </font><font style="vertical-align: inherit;">I will only note that quite often an anomaly in the code is detected in more than one way. </font><font style="vertical-align: inherit;">For example, this error is also detected by V519 warnings:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V519 CWE-563 The 'codec_capability_.sample_rate' variable is assigned values ‚Äã‚Äãtwice successively. </font><font style="vertical-align: inherit;">Perhaps this is a mistake. </font><font style="vertical-align: inherit;">Check lines: 910, 916. a2dp_vendor_ldac.cc 916</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V519 CWE-563 The 'codec_config_.sample_rate' variable is assigned values ‚Äã‚Äãtwice successively. </font><font style="vertical-align: inherit;">Perhaps this is a mistake. </font><font style="vertical-align: inherit;">Check lines: 911, 917. a2dp_vendor_ldac.cc 917</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And a couple more mistakes: </font></font><br><br><pre> <code class="cpp hljs">Return&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; EffectsFactory::getAllDescriptors(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> -ENOSYS: { <span class="hljs-comment"><span class="hljs-comment">// Effect list has changed. goto restart; } case -ENOENT: { // No more effects available. result.resize(i); } default: { result.resize(0); retval = Result::NOT_INITIALIZED; } } .... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: V796 CWE-484 It is possible that 'break' statement is missing in switch statement. </font><font style="vertical-align: inherit;">EffectsFactory.cpp 118</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reverb_getParameter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> REVERB_PARAM_REFLECTIONS_LEVEL: *(<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> *)pValue = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> REVERB_PARAM_REFLECTIONS_DELAY: *(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> *)pValue = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> REVERB_PARAM_REVERB_DELAY: *(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> *)pValue = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: V796 CWE-484 It is possible that 'break' statement is missing in switch statement. </font><font style="vertical-align: inherit;">EffectReverb.cpp 1847</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SLresult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IAndroidConfiguration_GetConfiguration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (IObjectToObjectID((thiz)-&gt;mThis)) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> SL_OBJECTID_AUDIORECORDER: result = android_audioRecorder_getConfig( (CAudioRecorder *) thiz-&gt;mThis, configKey, pValueSize, pConfigValue); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> SL_OBJECTID_AUDIOPLAYER: result = android_audioPlayer_getConfig( (CAudioPlayer *) thiz-&gt;mThis, configKey, pValueSize, pConfigValue); <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: result = SL_RESULT_FEATURE_UNSUPPORTED; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: V796 CWE-484 It is possible that 'break' statement is missing in switch statement. </font><font style="vertical-align: inherit;">IAndroidConfiguration.cpp 90</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Incorrect memory management </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here I have compiled errors related to incorrect memory management. </font><font style="vertical-align: inherit;">Such warnings, according to the Common Weakness Enumeration, are classified as:</font></font><br><br><ul><li> <a href="https://cwe.mitre.org/data/definitions/401.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-401</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Improve Release Memory Memory Reference ('Memory Leak')</font></font></li><li> <a href="https://cwe.mitre.org/data/definitions/562.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-562</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Return of Stack Variable Address</font></font></li><li> <a href="https://cwe.mitre.org/data/definitions/762.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-762</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Mismatched Memory Management Routines</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's start with functions that return a reference to an already destroyed variable. </font></font><br><br><pre> <code class="cpp hljs">TransformIterator&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>++(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) { <span class="hljs-function"><span class="hljs-function">TransformIterator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; ++*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tmp; } TransformIterator&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>--(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) { <span class="hljs-function"><span class="hljs-function">TransformIterator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; --*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tmp; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PVS-Studio warnings: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V558 CWE-562 Function returns temporary reference to temporary local object: tmp. </font><font style="vertical-align: inherit;">transform_iterator.h 77</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V558 CWE-562 Function returns temporary reference to temporary local object: tmp. </font><font style="vertical-align: inherit;">transform_iterator.h 92</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When functions complete their execution, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tmp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable is </font><font style="vertical-align: inherit;">destroyed as it is created on the stack. </font><font style="vertical-align: inherit;">Therefore, the functions return a reference to an already destroyed (non-existent) object. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The correct solution would be to return by value:</font></font><br><br><pre> <code class="cpp hljs">TransformIterator <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>++(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) { <span class="hljs-function"><span class="hljs-function">TransformIterator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; ++*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tmp; } TransformIterator <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>--(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) { <span class="hljs-function"><span class="hljs-function">TransformIterator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; --*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tmp; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Consider even more sad code that deserves close attention. </font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/619/b25/299/619b2529917e9570454e60bf9c27c3f8.png" alt=" "></div><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">register_socket_transport</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> s, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* serial, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> local)</span></span></span><span class="hljs-function"> </span></span>{ atransport* t = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> atransport(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!serial) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">32</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">snprintf</span></span>(buf, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(buf), <span class="hljs-string"><span class="hljs-string">"T-%p"</span></span>, t); serial = buf; } .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V507 CWE-562 Pointer to local array. Such a pointer will become invalid. transport.cpp 1030 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a dangerous code. If the actual value of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serial</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> argument </font><font style="vertical-align: inherit;">is NULL, then a temporary buffer on the stack should be used. When the body of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if statement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ends, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> array </font><font style="vertical-align: inherit;">will cease to exist. The place where the buffer was created can be used to store other variables created on the stack. A hellish mess in the data will begin, and the consequences of such an error are poorly predictable. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The following errors are related to incompatible ways to create and destroy objects.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SensorService::SensorEventConnection::reAllocateCacheLocked(....) { <span class="hljs-keyword"><span class="hljs-keyword">sensors_event_t</span></span> *eventCache_new; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> new_cache_size = computeMaxCacheSizeLocked(); eventCache_new = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sensors_event_t</span></span>[new_cache_size]; .... <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> mEventCache; mEventCache = eventCache_new; mCacheSize += count; mMaxCacheSize = new_cache_size; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V611 CWE-762 The memory was allocated using the 'delete' operator. </font><font style="vertical-align: inherit;">Consider inspecting this code. </font><font style="vertical-align: inherit;">It's probably better to use 'delete [] mEventCache;'. </font><font style="vertical-align: inherit;">Check lines: 391, 384. SensorEventConnection.cpp 391</font></font><br><br>  Everything is simple here.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A buffer, a pointer to which is stored in a member of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mEventCache</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class </font><font style="vertical-align: inherit;">, is allocated using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new []</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">And free this memory, using the operator </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">delete</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This is wrong and leads to undefined program behavior. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Similar error:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">aaudio_result_t</span></span> AAudioServiceEndpointCapture::open(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> mDistributionBuffer; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> distributionBufferSizeBytes = getStreamInternal()-&gt;getFramesPerBurst() * getStreamInternal()-&gt;getBytesPerFrame(); mDistributionBuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>[distributionBufferSizeBytes]; .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V611 CWE-762 The memory was allocated using the 'delete' operator. </font><font style="vertical-align: inherit;">Consider inspecting this code. </font><font style="vertical-align: inherit;">It's probably better to use 'delete [] mDistributionBuffer;'. </font><font style="vertical-align: inherit;">AAudioServiceEndpointCapture.cpp 50 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I think that the error does not require explanation. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The following case is a bit more interesting, but the essence of the error is exactly the same.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HeifFrameInfo</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... mIccData.reset(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>[iccSize]); .... } .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>&gt; mIccData; };</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V554 CWE-762 Incorrect use of unique_ptr. </font></font> The memory is allocated with 'new []' will be cleaned using 'delete'.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HeifDecoderAPI.h 62 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By default, the smart pointer </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class std :: unique_ptr</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> invokes the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">delete</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator to destroy an object </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">However, in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function, </font><font style="vertical-align: inherit;">memory is allocated using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new []</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator </font><font style="vertical-align: inherit;">.</font></font><br><br>  The correct option is: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>[]&gt; mIccData;</code> </pre> <br>  Other errors: <br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V554 CWE-762 Incorrect use of unique_ptr. </font></font> The memory is allocated with 'new []' will be cleaned using 'delete'.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> atrace.cpp 949 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V554 CWE-762 Incorrect use of unique_ptr. </font></font> The memory is allocated with 'new []' will be cleaned using 'delete'.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> atrace.cpp 950 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V554 CWE-762 Incorrect use of unique_ptr. </font></font> The memory is allocated with 'new []' will be cleaned using 'delete'.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> HeifDecoderImpl.cpp 102 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V554 CWE-762 Incorrect use of unique_ptr. </font></font> The memory is allocated with 'new []' will be cleaned using 'delete'.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> HeifDecoderImpl.cpp 166 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V554 CWE-762 Incorrect use of unique_ptr. </font></font> The memory is allocated with 'new []' will be cleaned using 'delete'.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ColorSpace.cpp 360 </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This section will complete the memory leak errors. </font><font style="vertical-align: inherit;">An unpleasant surprise is that more than 20 such errors appeared. It seems to me that these can be very painful defects, leading to a gradual decrease in free memory during long-term continuous operation of the operating system.</font></font><br><br><pre> <code class="cpp hljs">Asset* Asset::createFromUncompressedMap(FileMap* dataMap, AccessMode mode) { _FileAsset* pAsset; <span class="hljs-keyword"><span class="hljs-keyword">status_t</span></span> result; pAsset = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> _FileAsset; result = pAsset-&gt;openChunk(dataMap); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result != NO_ERROR) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; pAsset-&gt;mAccessMode = mode; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pAsset; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V773 CWE-401 The pAsset pointer. </font><font style="vertical-align: inherit;">A memory leak is possible. </font><font style="vertical-align: inherit;">Asset.cpp 296 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If it fails to open a certain chunk, the function ends its work without destroying the object, the pointer to which is stored in the variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pAsset</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">As a result, a memory leak will occur. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other errors are similar, so I see no reason to consider them in the article. </font><font style="vertical-align: inherit;">Those </font></font><a href="http://cppfiles.com/Android/Android_V773.txt"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interested</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can see other warnings in the file: </font><a href="http://cppfiles.com/Android/Android_V773.txt"><font style="vertical-align: inherit;">Android_V773.txt</font></a><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Overrun array </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are a large number of erroneous patterns that lead to the output of the array. </font><font style="vertical-align: inherit;">In the case of Android, I found only one error pattern of the following type:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || i &gt; MAX) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; A[i] = x;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In C and C ++, the cells of an array are numbered from 0, therefore the maximum index of an element in an array must be one less than the size of the array itself. </font><font style="vertical-align: inherit;">The correct check should be:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || i &gt;= MAX) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; A[i] = x;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Overrun of an </font><font style="vertical-align: inherit;">array, according to the Common Weakness Enumeration, is classified as a </font></font><a href="https://cwe.mitre.org/data/definitions/119.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-119</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Improper Restriction of Memory Buffer. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's see how these errors look in the Android code.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">btif_hf_cb_t</span></span> btif_hf_cb[BTA_AG_MAX_NUM_CLIENTS]; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSlcConnected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RawAddress* bd_addr)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!bd_addr) { LOG(WARNING) &lt;&lt; __func__ &lt;&lt; <span class="hljs-string"><span class="hljs-string">": bd_addr is null"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx = btif_hf_idx_by_bdaddr(bd_addr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idx &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || idx &gt; BTA_AG_MAX_NUM_CLIENTS) { LOG(WARNING) &lt;&lt; __func__ &lt;&lt; <span class="hljs-string"><span class="hljs-string">": invalid index "</span></span> &lt;&lt; idx &lt;&lt; <span class="hljs-string"><span class="hljs-string">" for "</span></span> &lt;&lt; *bd_addr; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> btif_hf_cb[idx].state == BTHF_CONNECTION_STATE_SLC_CONNECTED; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V557 CWE-119 Array overrun is possible. </font><font style="vertical-align: inherit;">The value of 'idx' index could reach 6. btif_hf.cc 277 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The validation option is:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idx &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || idx &gt;= BTA_AG_MAX_NUM_CLIENTS) {</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Exactly the same mistakes found two more pieces: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V557 CWE-119 Array overrun is possible. </font><font style="vertical-align: inherit;">The value of 'idx' index could reach 6. btif_hf.cc 869</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V557 CWE-119 Array overrun is possible. </font><font style="vertical-align: inherit;">The value of 'index' index could reach 6. btif_rc.cc 374</font></font></li></ul><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Broken loops </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are lots of ways to write a cycle that doesn't work correctly. </font><font style="vertical-align: inherit;">In the Android code, I encountered errors that, according to Common Weakness Enumeration, can be classified as:</font></font><br><br><ul><li> <a href="https://cwe.mitre.org/data/definitions/20.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-20</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Improper Input Validation</font></font></li><li> <a href="https://cwe.mitre.org/data/definitions/670.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-670</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Always-Incorrect Control Flow Implementation</font></font></li><li> <a href="https://cwe.mitre.org/data/definitions/691.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-691</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Insufficient Control Flow Management</font></font></li><li> <a href="https://cwe.mitre.org/data/definitions/834.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-834</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Excessive Iteration</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In this case, of course, there are other ways to "shoot yourself a leg" when writing cycles, but this time they did not meet me. </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **argv)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s is already in *.base_fs format, just ..... "</span></span>, ....); rewind(blk_alloc_file); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((c = fgetc(blk_alloc_file)) != EOF) { fputc(c, base_fs_file); } .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V739 CWE-20 EOF should not be compared with a value of the 'char' type. The '(c = fgetc (blk_alloc_file))' should be of the 'int' type. blk_alloc_to_base_fs.c 61 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The analyzer has detected that the constant </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EOF is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compared with a variable of type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">char</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Let's see why this code is incorrect. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><a href="http://www.cplusplus.com/reference/cstdio/fgetc/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgetc</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">returns a value of type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , namely: it can return a number from 0 to 255 or EOF (-1). The read value is placed in a variable of type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">char</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Because of this, the character with the value 0xFF (255) turns into -1 and is interpreted in the same way as the end of the file (EOF).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Because of such errors, users who use Extended ASCII Codes sometimes face a situation where one of the characters in their alphabet is incorrectly processed by programs. For example, the last letter of the Russian alphabet in the Windows-1251 encoding just has the code 0xFF and is perceived by some programs as the end of the file. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Summarizing, we can say that the condition for stopping the cycle is written incorrectly. To remedy the situation, it is necessary that the variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> be of type int. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We continue and consider more familiar errors when using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator </font><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">status_t</span></span> AudioPolicyManager::registerPolicyMixes(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; mixes.size(); i++) { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; mHwModules.size(); j++) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= if (strcmp(AUDIO_HARDWARE_MODULE_ID_REMOTE_SUBMIX, mHwModules[j]-&gt;mName) == 0 &amp;&amp; mHwModules[j]-&gt;mHandle != 0) { rSubmixModule = mHwModules[j]; break; } .... } .... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: V534 CWE-691 It is likely that the variable is being compared inside the 'for' operator. Consider reviewing 'i'. AudioPolicyManager.cpp 2489 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Because of a typo in a nested loop, the condition uses the variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , although you must use the variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">j</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . As a result, the variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">j is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uncontrolledly incremented, which will eventually lead to the output of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mHwModules</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> array </font><font style="vertical-align: inherit;">. What happens next is impossible to predict, since an indefinite program behavior will arise. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the way, this fragment with an error was completely copied to another function. Therefore, the analyzer found the exact same error here: AudioPolicyManager.cpp 2586.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are 3 more code fragments that are very suspicious to me. </font><font style="vertical-align: inherit;">However, I do not presume to say that this code is exactly erroneous, since there is a complex logic there. </font><font style="vertical-align: inherit;">In any case, I have to pay attention to this code for the author to check it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first fragment:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ce_t3t_handle_check_cmd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; p_cb-&gt;cur_cmd.num_blocks; i++) { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; T3T_MSG_NDEF_ATTR_INFO_SIZE; i++) { checksum += p_temp[i]; } .... } .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V535 CWE-691 The variable 'i' is being used. </font><font style="vertical-align: inherit;">Check lines: 398, 452. ce_t3t.cc 452 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note that the variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> used for both the outer and inner loop. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Two more similar analyzer triggers:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V535 CWE-691 The variable "xx" is being used for the loop. </font><font style="vertical-align: inherit;">Check lines: 801, 807. sdp_db.cc 807</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V535 CWE-691 The variable "xx" is being used for the loop. </font><font style="vertical-align: inherit;">Check lines: 424, 438. nfa_hci_act.cc 438</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You are not tired yet? </font><font style="vertical-align: inherit;">I suggest to pause and </font></font><a href="https://www.viva64.com/ru/pvs-studio-download/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">download PVS-Studio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in order to try to check your project.</font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/30b/8e3/d36/30b8e3d36a2b05111cee2b76d981d89f.png" alt=" PVS-Studio"></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now let's continue. </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NFA_HCI_LAST_PROP_GATE 0xFF tNFA_HCI_DYN_GATE* nfa_hciu_alloc_gate(uint8_t gate_id, tNFA_HANDLE app_handle) { .... for (gate_id = NFA_HCI_FIRST_HOST_SPECIFIC_GENERIC_GATE; gate_id </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;= NFA_HCI_LAST_PROP_GATE; gate_id++) { if (gate_id == NFA_HCI_CONNECTIVITY_GATE) gate_id++; if (nfa_hciu_find_gate_by_gid(gate_id) == NULL) break; } if (gate_id &gt; NFA_HCI_LAST_PROP_GATE) { LOG(ERROR) &lt;&lt; StringPrintf( "nfa_hci_alloc_gate - no free Gate ID: %u " "App Handle: 0x%04x", gate_id, app_handle); return (NULL); } .... }</span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V654 CWE-834 The condition 'gate_id &lt;= 0xFF' of loop is always true. </font><font style="vertical-align: inherit;">nfa_hci_utils.cc 248 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note the following:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The constant </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NFA_HCI_LAST_PROP_GATE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is equal to 0xFF.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The variable of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uint8_t</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> type is used as the </font><i><font style="vertical-align: inherit;">loop counter</font></i><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Therefore, the range of values ‚Äã‚Äãof this variable is [0..0xFF].</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It turns out that the condition </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gate_id &lt;= NFA_HCI_LAST_PROP_GATE is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> always true and cannot stop the execution of the loop. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The analyzer has classified this error as CWE-834, but it can also be interpreted as CWE-571: Expression is Always True. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next error in the cycle is associated with undefined behavior.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">status_t</span></span> SimpleDecodingSource::doRead(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> retries = <span class="hljs-number"><span class="hljs-number">0</span></span>; ++retries; ) { .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V654 CWE-834 The condition '++ retries' of loop is always true. </font><font style="vertical-align: inherit;">SimpleDecodingSource.cpp 226 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apparently, the programmer wanted the variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retries to</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> accept all possible values ‚Äã‚Äãfor the variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and only then the cycle ended. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The loop should stop when the expression </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">++ retries</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will be equal to 0. And this is possible only if an overflow of the variable occurs. </font><font style="vertical-align: inherit;">Since the variable is of sign type, its overflow leads to undefined behavior. </font><font style="vertical-align: inherit;">Therefore, this code is incorrect and can lead to unpredictable consequences. </font><font style="vertical-align: inherit;">For example, the compiler has the full right to remove the check and leave only the instruction for the counter increment.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And the last mistake in this section. </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">status_t</span></span> Check(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&amp; source) { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pass = <span class="hljs-number"><span class="hljs-number">1</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(rc) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: SLOGI(<span class="hljs-string"><span class="hljs-string">"Filesystem check completed OK"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: SLOGE(<span class="hljs-string"><span class="hljs-string">"Filesystem check failed (not a FAT filesystem)"</span></span>); errno = ENODATA; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pass++ &lt;= <span class="hljs-number"><span class="hljs-number">3</span></span>) { SLOGW(<span class="hljs-string"><span class="hljs-string">"Filesystem modified - rechecking (pass %d)"</span></span>, pass); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= } SLOGE("Failing check after too many rechecks"); errno = EIO; return -1; case 8: SLOGE("Filesystem check failed (no filesystem)"); errno = ENODATA; return -1; default: SLOGE("Filesystem check failed (unknown exit code %d)", rc); errno = EIO; return -1; } } while (0); // &lt;= return 0; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V696 CWE-670 The 'continue' operator will terminate 'do {...} while (FALSE)' loop because the condition is always false. </font><font style="vertical-align: inherit;">Check lines: 105, 121. Vfat.cpp 105 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before us is a loop of the form:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; .... } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To perform repeated iterations, the programmer uses the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">continue</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> statement </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is not right. </font><font style="vertical-align: inherit;">The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">continue</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator </font><font style="vertical-align: inherit;">does not resume the loop immediately, but proceeds to check the condition. </font><font style="vertical-align: inherit;">Since the condition is always false, the cycle in any case will be executed only once. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To correct the error, the code can be rewritten, for example, like this:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; }</code> </pre> <br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Reassigning a variable </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A very </font></font><a href="https://www.viva64.com/ru/examples/v519/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">common mistake</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is to re-write to a variable even before the previous value was used. </font><font style="vertical-align: inherit;">Most often, such errors occur due to typographical errors or unsuccessful Copy-Paste. </font><font style="vertical-align: inherit;">According to the Common Weakness Enumeration, such errors are classified as </font></font><a href="https://cwe.mitre.org/data/definitions/563.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-563</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Assignment to Variable without Use. </font><font style="vertical-align: inherit;">Not without such errors in Android.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">status_t</span></span> XMLNode::flatten_node(....) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;namespaceExt, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(namespaceExt)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mNamespacePrefix.size() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { namespaceExt.prefix.index = htodl(strings.offsetForString(mNamespacePrefix)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { namespaceExt.prefix.index = htodl((<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>)<span class="hljs-number"><span class="hljs-number">-1</span></span>); } namespaceExt.prefix.index = htodl(strings.offsetForString(mNamespacePrefix)); namespaceExt.uri.index = htodl(strings.offsetForString(mNamespaceUri)); .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V519 CWE-563 The 'namespaceExt.prefix.index' variable is assigned values ‚Äã‚Äãtwice successively. </font><font style="vertical-align: inherit;">Perhaps this is a mistake. </font><font style="vertical-align: inherit;">Check lines: 1535, 1539. XMLNode.cpp 1539 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To isolate the essence of the error, I will write pseudocode:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) X = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> X = <span class="hljs-number"><span class="hljs-number">2</span></span>; X = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Regardless of the condition, the variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (in the present code, this is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namespaceExt.prefix.index</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) will always be assigned one value.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> AudioFlinger::RecordThread::threadLoop() { .... <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> framesToRead = mBufferSize / mFrameSize; framesToRead = min(mRsmpInFramesOA - rear, mRsmpInFramesP2 / <span class="hljs-number"><span class="hljs-number">2</span></span>); .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V519 CWE-563 The 'framesToRead' variable is assigned values ‚Äã‚Äãtwice successively. </font><font style="vertical-align: inherit;">Perhaps this is a mistake. </font><font style="vertical-align: inherit;">Check lines: 6341, 6342. Threads.cpp 6342 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is not clear why it was necessary to initialize a variable when declaring, if then another value is immediately written to it. </font><font style="vertical-align: inherit;">Something is wrong here.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SchedulingLatencyVisitorARM::VisitArrayGet(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (index-&gt;IsConstant()) { last_visited_latency_ = kArmMemoryLoadLatency; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (has_intermediate_address) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { last_visited_internal_latency_ += kArmIntegerOpLatency; } last_visited_internal_latency_ = kArmMemoryLoadLatency; } .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V519 CWE-563 The 'last_visited_internal_latency_' variable is assigned values ‚Äã‚Äãtwice successively. </font><font style="vertical-align: inherit;">Perhaps this is a mistake. </font><font style="vertical-align: inherit;">Check lines: 680, 682. scheduler_arm.cc 682 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Very strange, meaningless code. </font><font style="vertical-align: inherit;">I would venture to suggest what should have been written:</font></font><br><br><pre> <code class="cpp hljs">last_visited_internal_latency_ += kArmMemoryLoadLatency;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And the last error demonstrating how the analyzer tirelessly finds errors that are likely to be missed even with a careful code review. </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">multiprecision_fast_mod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> U; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> V; .... c[<span class="hljs-number"><span class="hljs-number">0</span></span>] += U; V = c[<span class="hljs-number"><span class="hljs-number">0</span></span>] &lt; U; c[<span class="hljs-number"><span class="hljs-number">1</span></span>] += V; V = c[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt; V; c[<span class="hljs-number"><span class="hljs-number">2</span></span>] += V; <span class="hljs-comment"><span class="hljs-comment">// V = c[2] &lt; V; // &lt;= c[2] += U; // V = c[2] &lt; U; // &lt;= c[3] += V; V = c[3] &lt; V; c[4] += V; V = c[4] &lt; V; c[5] += V; V = c[5] &lt; V; .... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V519 CWE-563 The 'V' variable is assigned values ‚Äã‚Äãtwice successively. </font><font style="vertical-align: inherit;">Perhaps this is a mistake. </font><font style="vertical-align: inherit;">Check lines: 307, 309. p_256_multprecision.cc 309 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code is so ‚Äú </font><font style="vertical-align: inherit;">tear </font><font style="vertical-align: inherit;">out the eyes‚Äù that I do not want to understand it. </font><font style="vertical-align: inherit;">At the same time, it is clearly visible: here there is a typo in the code, which I highlighted with comments.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Other errors </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There were isolated errors, for which there is no point in making separate chapters. </font><font style="vertical-align: inherit;">However, they are as interesting and insidious as previously discussed. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Priority of operations</font></font></b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TagMonitor::parseTagsToMonitor(String8 tagNames) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::lock_guard&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::mutex&gt; lock(mMonitorMutex); <span class="hljs-comment"><span class="hljs-comment">// Expand shorthands if (ssize_t idx = tagNames.find("3a") != -1) { ssize_t end = tagNames.find(",", idx); char* start = tagNames.lockBuffer(tagNames.size()); start[idx] = '\0'; .... } .... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V593 CWE-783 Consider reviewing the expression of the A = B! = C 'kind. The expression is calculated as the following: 'A = (B! = C)'. TagMonitor.cpp 50 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">According to the Common Weakness Enumeration classification: </font></font><a href="https://cwe.mitre.org/data/definitions/783.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-783</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Operator Precedence Logic Error. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The programmer thought of the following. The search for the substring "3a" occurs and the </font><font style="vertical-align: inherit;">position of this substring is recorded </font><font style="vertical-align: inherit;">in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">. If the substring is found (idx! = -1), then the code in which the value of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable is used is executed </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unfortunately, the programmer is confused about the priorities of operations. In fact, the test works like this:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span> idx = (tagNames.find(<span class="hljs-string"><span class="hljs-string">"3a"</span></span>) != <span class="hljs-number"><span class="hljs-number">-1</span></span>))</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, it is checked whether there is a substring ‚Äú3a‚Äù in the string, and the result false / true is placed in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">As a result, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">has the value 0 or 1. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the condition is true (the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">is 1), then the logic that uses the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable begins to be executed </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A variable always equal to 1 will lead to incorrect program behavior. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can correct the error if you take out the initialization of the variable from the condition:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span> idx = tagNames.find(<span class="hljs-string"><span class="hljs-string">"3a"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idx != <span class="hljs-number"><span class="hljs-number">-1</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The new version of C ++ 17 also allows you to write: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span> idx = tagNames.find(<span class="hljs-string"><span class="hljs-string">"3a"</span></span>); idx != <span class="hljs-number"><span class="hljs-number">-1</span></span>)</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wrong constructor</font></font></b> <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HearingDevice</span></span></span><span class="hljs-class"> {</span></span> .... HearingDevice() { HearingDevice(RawAddress::kEmpty, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } .... };</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: V603 CWE-665 If you wish to call the constructor, 'this-&gt; HearingDevice :: HearingDevice (....)' should be used. hearing_aid.cc 176 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">According to the Common Weakness Enumeration classification: </font></font><a href="https://cwe.mitre.org/data/definitions/665.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-665</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Improper Initialization. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programmers are often mistaken in trying to explicitly call a constructor to initialize an object. There are two constructors in the class. To reduce the size of the source code, the programmer decided to call one constructor from another. But this code does not exactly what the developer expects. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The following happens. A new unnamed object of type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HearingDevice is created</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and immediately destroyed. As a result, the class fields remain uninitialized.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To correct the error, you can use the delegating constructor (this feature appeared in C ++ 11). </font><font style="vertical-align: inherit;">The correct code is:</font></font><br><br><pre> <code class="cpp hljs">HearingDevice() : HearingDevice(RawAddress::kEmpty, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The function does not return a value.</font></font></b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NET_RecvFrom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> s, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, struct sockaddr *from, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *fromlen)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">socklen_t</span></span> socklen = *fromlen; BLOCKING_IO_RETURN_INT( s, recvfrom(s, buf, len, flags, from, &amp;socklen) ); *fromlen = socklen; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: V591 CWE-393 Non-void function should return a value. </font><font style="vertical-align: inherit;">linux_close.cpp 139 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">According to the Common Weakness Enumeration classification: </font></font><a href="https://cwe.mitre.org/data/definitions/393.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-393</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Return of Wrong Status Code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The function will return a random value. </font><font style="vertical-align: inherit;">Another such error: V591 CWE-393 Non-void function should return a value. </font><font style="vertical-align: inherit;">linux_close.cpp 158 </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incorrect structure size calculation</font></font></b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MtpFfsHandle::handleControlRequest(....) { .... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mtp_device_status</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">st</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reinterpret_cast</span></span></span><span class="hljs-class">&lt;struct mtp_device_status*&gt;(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buf</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">());</span></span> st-&gt;wLength = htole16(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(st)); .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: V568 It‚Äôs an odd that it would be a sizeof () operator. </font><font style="vertical-align: inherit;">MtpFfsHandle.cpp 251 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I am sure that the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wLength</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> member </font><i><font style="vertical-align: inherit;">variable</font></i><font style="vertical-align: inherit;"> wanted to put the size of the structure, not the size of the pointer. </font><font style="vertical-align: inherit;">Then the correct code should be:</font></font><br><br><pre> <code class="cpp hljs">st-&gt;wLength = htole16(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*st));</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Similar analyzer triggers: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you‚Äôre a sizeof () ‚Äô‚Äô </font><font style="vertical-align: inherit;">NetlinkEvent.cpp 220</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you‚Äôre a sizeof () ‚Äô </font><font style="vertical-align: inherit;">linker_block_allocator.cpp 146</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V568 It's odd that the operator of the sizeof () operator is the '&amp; session_id' expression. </font><font style="vertical-align: inherit;">reference-ril.c 1775</font></font></li></ul><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meaningless bit operations</font></font></b> <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EGL_CONTEXT_OPENGL_DEBUG_BIT_KHR 0x00000001 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EGL_CONTEXT_OPENGL_FORWARD_COMPATIBLE_BIT_KHR 0x00000002 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EGL_CONTEXT_OPENGL_ROBUST_ACCESS_BIT_KHR 0x00000004 EGLContext eglCreateContext(....) { .... case EGL_CONTEXT_FLAGS_KHR: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((attrib_val | EGL_CONTEXT_OPENGL_DEBUG_BIT_KHR) || (attrib_val | EGL_CONTEXT_OPENGL_FORWARD_C....) || (attrib_val | EGL_CONTEXT_OPENGL_ROBUST_ACCESS_BIT_KHR)) { context_flags = attrib_val; } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { RETURN_ERROR(EGL_NO_CONTEXT,EGL_BAD_ATTRIBUTE); } .... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V617 CWE-480 Consider inspecting the condition. </font><font style="vertical-align: inherit;">The '0x00000001' argument of the '|' </font><font style="vertical-align: inherit;">bitwise operation contains a non-zero value. </font><font style="vertical-align: inherit;">egl.cpp 1329 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">According to the Common Weakness Enumeration classification: </font></font><a href="https://cwe.mitre.org/data/definitions/480.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-480</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Use of Incorrect Operator. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expression of the form (A | 1) || </font><font style="vertical-align: inherit;">(A | 2) || </font><font style="vertical-align: inherit;">(A | 4) does not make sense, since the result will always be true. </font><font style="vertical-align: inherit;">In fact, you must use the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&amp;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator </font><font style="vertical-align: inherit;">, and then the code takes on the meaning:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((attrib_val &amp; EGL_CONTEXT_OPENGL_DEBUG_BIT_KHR) || (attrib_val &amp; EGL_CONTEXT_OPENGL_FORWARD_COMPATIBLE_BIT_KHR) || (attrib_val &amp; EGL_CONTEXT_OPENGL_ROBUST_ACCESS_BIT_KHR))</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Similar error: V617 CWE-480 Consider inspecting the condition. The '0x00000001' argument of the '|' bitwise operation contains a non-zero value. egl.cpp 1338 </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wrong bit shift</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> AddressType&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegsInfo</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> saved_reg_map = <span class="hljs-number"><span class="hljs-number">0</span></span>; AddressType saved_regs[<span class="hljs-number"><span class="hljs-number">64</span></span>]; .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> AddressType* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reg)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reg &gt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(saved_regs) / <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(AddressType)) { <span class="hljs-built_in"><span class="hljs-built_in">abort</span></span>(); } saved_reg_map |= <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; reg; saved_regs[reg] = (*regs)[reg]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &amp;(*regs)[reg]; } .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V629 CWE-190 Consider inspecting the '1 &lt;&lt; reg' expression. </font><font style="vertical-align: inherit;">Bit shifting of the 32-bit type. </font><font style="vertical-align: inherit;">RegsInfo.h 47 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">According to the Common Weakness Enumeration classification: </font></font><a href="https://cwe.mitre.org/data/definitions/190.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-190</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Integer Overflow or Wraparound. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With a shift of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 &lt;&lt; reg, the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> value of the variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lies in the range [0..63]. </font><font style="vertical-align: inherit;">The expression serves to obtain different powers of two, starting with 2 ^ 0 and ending with 2 ^ 63. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code does not work. </font><font style="vertical-align: inherit;">The point is that the numeric literal 1 has a 32-bit type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Therefore, it will not be possible to get a value greater than 1 ^ 31. </font><font style="vertical-align: inherit;">A shift to a larger value causes a variable to overflow and an undefined behavior.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The correct code is: </font></font><br><br><pre> <code class="cpp hljs">saved_reg_map |= <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span>&gt;(<span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;&lt; reg;</code> </pre> <br>  or: <br><br><pre> <code class="cpp hljs">saved_reg_map |= <span class="hljs-number"><span class="hljs-number">1U</span></span>LL &lt;&lt; reg;</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The lines are copied to themselves.</font></font></b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> PCLmGenerator::writeJobTicket() { <span class="hljs-comment"><span class="hljs-comment">// Write JobTicket char inputBin[256]; char outputBin[256]; if (!m_pPCLmSSettings) { return; } getInputBinString(m_pPCLmSSettings-&gt;userInputBin, &amp;inputBin[0]); getOutputBin(m_pPCLmSSettings-&gt;userOutputBin, &amp;outputBin[0]); strcpy(inputBin, inputBin); strcpy(outputBin, outputBin); .... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PVS-Studio warnings: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V549 CWE-688 The first argument of the 'strcpy' function is equal to the second argument. </font><font style="vertical-align: inherit;">genPCLm.cpp 1181</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V549 CWE-688 The first argument of the 'strcpy' function is equal to the second argument. </font><font style="vertical-align: inherit;">genPCLm.cpp 1182</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">According to the Common Weakness Enumeration classification: </font></font><a href="https://cwe.mitre.org/data/definitions/688.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-688</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Function Call With Incorrect Variable or Reference as Argument. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lines are for some reason copied into themselves. </font><font style="vertical-align: inherit;">Most likely, there are some typos. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using an uninitialized variable</font></font></b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mca_set_cfg_by_tbl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ tMCA_DCB* p_dcb; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tL2CAP_FCR_OPTS* p_opt; tMCA_FCS_OPT fcs = MCA_FCS_NONE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p_tbl-&gt;tcid == MCA_CTRL_TCID) { p_opt = &amp;mca_l2c_fcr_opts_def; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { p_dcb = mca_dcb_by_hdl(p_tbl-&gt;cb_idx); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p_dcb) { p_opt = &amp;p_dcb-&gt;p_chnl_cfg-&gt;fcr_opt; fcs = p_dcb-&gt;p_chnl_cfg-&gt;fcs; } } <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(p_cfg, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(tL2CAP_CFG_INFO)); p_cfg-&gt;mtu_present = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; p_cfg-&gt;mtu = p_tbl-&gt;my_mtu; p_cfg-&gt;fcr_present = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(&amp;p_cfg-&gt;fcr, p_opt, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(tL2CAP_FCR_OPTS)); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: V614 CWE-824 Potentially uninitialized pointer 'p_opt' used. Consider the memcpy function. mca_main.cc 252 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">According to the Common Weakness Enumeration classification: </font></font><a href="https://cwe.mitre.org/data/definitions/824.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-824</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Access of Uninitialized Pointer. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p_tbl-&gt; tcid! = MCA_CTRL_TCID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p_dcb == nullptr</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p_opt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pointer </font><font style="vertical-align: inherit;">will remain uninitialized. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stranger use of uninitialized variable</font></font></b> <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timespec</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">__time_t</span></span> tv_sec; <span class="hljs-comment"><span class="hljs-comment">/* Seconds. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tv_nsec; <span class="hljs-comment"><span class="hljs-comment">/* Nanoseconds. */</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> timespec </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NsToTimespec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ns)</span></span></span><span class="hljs-function"> </span></span>{ timespec t; <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> remainder; t.tv_sec = ns / kNanosPerSecond; remainder = ns % kNanosPerSecond; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (remainder &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { t.tv_nsec--; remainder += kNanosPerSecond; } t.tv_nsec = remainder; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V614 CWE-457 Uninitialized variable 't.tv_nsec' used. </font><font style="vertical-align: inherit;">clock_ns.h 55 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">According to the Common Weakness Enumeration classification: </font></font><a href="https://cwe.mitre.org/data/definitions/457.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-457</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Use of Uninitialized Variable. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the moment of decrement of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.tv_nsec</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><i><font style="vertical-align: inherit;">,</font></i><font style="vertical-align: inherit;"> it is uninitialized. </font><font style="vertical-align: inherit;">The variable is initialized later: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.tv_nsec = remainder;</font></font></i>  .<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Something is clearly messed up here. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redundant expression</font></font></b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bta_dm_co_ble_io_req</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... *p_auth_req = bte_appl_cfg.ble_auth_req | (bte_appl_cfg.ble_auth_req &amp; <span class="hljs-number"><span class="hljs-number">0x04</span></span>) | ((*p_auth_req) &amp; <span class="hljs-number"><span class="hljs-number">0x04</span></span>); .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warning: V578 An odd bitwise operation detected. </font><font style="vertical-align: inherit;">Consider verifying it. </font><font style="vertical-align: inherit;">bta_dm_co.cc 259 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This expression is redundant. </font><font style="vertical-align: inherit;">If you delete the subexpression </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(bte_appl_cfg.ble_auth_req &amp; 0x04)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then the result of the expression will not change. </font><font style="vertical-align: inherit;">Perhaps there is some typo here. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handle leak</font></font></b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> RSReflectionCpp::genEncodedBitCode() { FILE *pfin = fopen(mBitCodeFilePath.c_str(), <span class="hljs-string"><span class="hljs-string">"rb"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pfin == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>, <span class="hljs-string"><span class="hljs-string">"Error: could not read file %s\n"</span></span>, mBitCodeFilePath.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> read_length; mOut.indent() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"static const unsigned char __txt[] ="</span></span>; mOut.startBlock(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((read_length = fread(buf, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(buf), pfin)) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { mOut.indent(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; read_length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf2[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">snprintf</span></span>(buf2, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(buf2), <span class="hljs-string"><span class="hljs-string">"0x%02x,"</span></span>, buf[i]); mOut &lt;&lt; buf2; } mOut &lt;&lt; <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } mOut.endBlock(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); mOut &lt;&lt; <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PVS-Studio warning: V773 CWE-401 The function was exited without releasing the 'pfin' handle. </font></font> A resource leak is possible.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">slang_rs_reflection_cpp.cpp 448 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The analyzer has classified this error, according to the Common Weakness Enumeration, as: </font></font><a href="https://cwe.mitre.org/data/definitions/401.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-401</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Improved Release Memory Memory Card Reminder Last Reference ('Memory Leak'). </font><font style="vertical-align: inherit;">However, it would be more appropriate to issue here a </font></font><a href="https://cwe.mitre.org/data/definitions/775.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-775</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Missing Release of the Descriptor or Handle after Effective Lifetime. </font><font style="vertical-align: inherit;">I will instruct my colleagues to correct this flaw in PVS-Studio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pfin handle is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> not released anywhere. </font><font style="vertical-align: inherit;">Just forgot to call </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fclose</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at the end </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">An unpleasant error that can quickly exhaust the entire stock of available descriptors, after which it will be impossible to open new files.</font></font><br><br><h2>  Conclusion </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, even in a well-known and well-tested project like Android, PVS-Studio analyzer easily finds many errors and potential vulnerabilities. </font><font style="vertical-align: inherit;">To summarize, what weaknesses (potential vulnerabilities) were found:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CWE-14: Compiler Clear Buffers Code </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CWE-20: Improper Input Validation </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CWE-119: Improve Restriction of Memory Buffer </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CWE-190: Integer Overflow or Wraparound </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CWE-198: Use of Incorrect Byte Ordering </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CWE-393: Return of Wrong Status Code </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CWE-401: Improve Release Memory Memory Reference ('Memory Leak') </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CWE-457: Use of Uninitialized Variable </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CWE-462: Duplicate Key in Associative List </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CWE-480: Use of Incorrect Operator </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CWE-484: Omitted Break Statement in Switch </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CWE-561: Dead Code </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CWE-562: Return of Stack Variable Address </font></font></li><li> CWE-563: Assignment to Variable without Use </li><li> CWE-570: Expression is Always False </li><li> CWE-571: Expression is Always True </li><li> CWE-476: NULL Pointer Dereference </li><li> CWE-628: Function Call with Incorrectly Specified Arguments </li><li> CWE-665: Improper Initialization </li><li> CWE-670: Always-Incorrect Control Flow Implementation </li><li> CWE-682: Incorrect Calculation </li><li> CWE-688: Function Call With Incorrect Variable or Reference as Argument </li><li> CWE-690: Unchecked Return Value to NULL Pointer Dereference </li><li> CWE-691: Insufficient Control Flow Management </li><li> CWE-758: Reliance on Undefined, Unspecified, or Implementation-Defined Behavior </li><li> CWE-762: Mismatched Memory Management Routines </li><li> CWE-775: Missing Release of File Descriptor or Handle after Effective Lifetime </li><li> CWE-783: Operator Precedence Logic Error </li><li> CWE-824: Access of Uninitialized Pointer </li><li> CWE-834: Excessive Iteration </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In total, I gave a description of 490 potential vulnerabilities in the article. </font><font style="vertical-align: inherit;">In fact, the analyzer is able to identify them more, but, as I wrote earlier, I could not find the strength to study the report more carefully. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The size of the proven code base is about 2168000 lines of code in C and C ++. </font><font style="vertical-align: inherit;">Of these, 14.4% are comments. </font><font style="vertical-align: inherit;">Total, we receive about 1855000 lines of the pure code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, we have 490 CWE for 1,855,000 lines of code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It turns out that the PVS-Studio analyzer is able to detect more than 1 weakness (potential vulnerability) for every 4000 lines of code in the Android project. </font><font style="vertical-align: inherit;">Good result for the code analyzer, I'm happy.</font></font><br><br>  Thanks for attention!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I wish you all a hopeless code, and I propose to do the following: </font></font><br><br><ol><li> <a href="https://www.viva64.com/ru/pvs-studio-download/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Download</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PVS-Studio and check the working draft.</font></font></li><li>  :      : <a href="https://www.viva64.com/ru/b/0471/">     </a> . </li><li> ,        : <a href="https://twitter.com/Code_Analysis">twitter</a> , <a href="http://feeds.feedburner.com/viva64-blog-ru">RSS</a> , <a href="https://vk.com/siprover">vk.com</a> . </li></ol><br><p> <a href="https://www.viva64.com/en/b/0579/"><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov. <a href="https://www.viva64.com/en/b/0579/">We Checked the Android Source Codes by PVS-Studio or Nothing is Perfect</a> </div><p>Source: <a href="https://habr.com/ru/post/418891/">https://habr.com/ru/post/418891/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418879/index.html">Testing Methods for Crypto Exchanges and Crypto Wallets</a></li>
<li><a href="../418883/index.html">GitLab to NAS</a></li>
<li><a href="../418885/index.html">Crispr can accelerate natural processes and change the way food is grown.</a></li>
<li><a href="../418887/index.html">How fast is the universe expanding?</a></li>
<li><a href="../418889/index.html">Manual Application Testing Guide: Benefits, Milestones, and Methodologies</a></li>
<li><a href="../418895/index.html">Learning Artificial Intelligence to play the game</a></li>
<li><a href="../418897/index.html">CRDT: Conflict-free Replicated Data Types</a></li>
<li><a href="../418899/index.html">First impressions and actions after upgrading MySQL from version 5.7 to 8.0.11</a></li>
<li><a href="../418901/index.html">The Russians won the most gold medals of the European Olympiad in Informatics eJOI 2018</a></li>
<li><a href="../418903/index.html">Scientists: there is not enough CO‚ÇÇ on Mars to warm the atmosphere. The explosion of the poles will not help</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>