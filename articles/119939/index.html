<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MovableType - excerpts from plugin development</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="MovableType is not very popular in our country, however, the blogging system is very good. Out of the box it supports a lot of blogs, from the 5th ver...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MovableType - excerpts from plugin development</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://www.movabletype.org/">MovableType</a> is not very popular in our country, however, the blogging system is very good.  Out of the box it supports a lot of blogs, from the 5th version - also managing the full site.  Powered by perl, by generating a variety of static html files, due to which it can withstand even heavy loads. <br><br>  It is distributed in two versions: OpenSource and Pro.  Plugins for it are distributed in a semi-free mode: watch, see, use pay. <br><br>  In general, the system is written in the spirit of OOP, there are hooks for almost every sneeze, there is an ORM, everything is almost fine ... <br><a name="habracut"></a><br><h4>  Installing plugins </h4><br>  So, the first moment: installing plugins.  Installing plugins consists of: <br><ul><li>  Fill the plug-in daddy in the $ mt / plugins / &lt;plug-in&gt; plugin code </li><li>  Fill in the daddy of static plug-in files in $ mtpub / mt-static / plugins / &lt;plugin&gt; </li><li>  Check if you need to fill any libraries in $ mt / extlib / </li><li>  Carefully review the documentation on the topic "is it not necessary to put any libraries to perl" </li><li>  We carefully study the documentation on the topic "how do I now rewrite templates" </li></ul><br>  Depending on the functionality and complexity of the plug-in, the last two points sometimes pour out into a non-trivial task.  Some plug-in manufacturers even developed special plug-ins to simplify these tasks, such as <a href="http://mt-hacks.com/templateinstaller.htm">TemplateInstaller from mt-hacks.com</a> . <br>  Therefore, if you decide to write a plug-in under MT, think carefully about the fact that the user needs to do as little gestures as possible. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  MT plugin description </h4><br>  So, we decided to give birth to the plugin.  Create a folder structure for it: <br> <code>plugins/coolplugin/ <br> plugins/coolplugin/lib/ <br> plugins/coolplugin/tmpl/ <br> mt-static/plugins/coolplugin/</code> <br>  And thinking: what to write about? <br><br>  To get started, write config.yaml.  Starting with some (4.xxx like) version, the description of the plug-in can be made in a simple and accessible form via the config.yaml file, and not to add a heap of code in the main plug-in file.  So, what can and should contain config.yaml? <br>  And <a href="http://www.movabletype.org/documentation/developer/the-movable-type-registry-what-it-is-and-how-it-works.html">no one knows</a> .  If you have a desire to find out what can be there - welcome, study <code>$mt/lib/MT/Plugin.pm</code> and other plugins. <br><br>  The most useful things are: <br><pre> name: The name of your plugin.  It is recommended that such a short string fit.
 id: PluginNameWordName
 author_link: Link to plugin author
 author_name: plugin author name
 description: &lt;__ trans phrase = "Description of the plugin, appears if you click on the plugin's name in the plugin menu"&gt;
 version: Version of Plugin
 schema_version: Version of the Schema of the Data Plugin
 plugin_link: Link to the page where you can merge the plugin
 doc_link: Link to the page where the description of the plugin
 blog_config_template: name_configuration_configuration.tpl
 l10n_class: Plugin :: ClassInternationalization
 icon: Picture Plugin. {gif / png / jpg / itd}
 settings:
     How to configure:
         default: "default value"
         scope: blog
     global setup:
         default: "value more"<font></font>
<font></font>
 init: $ Plugin :: Module :: Initialization_Function<font></font>
<font></font>
 callbacks:
     SomeHack: $ Plugin :: Module :: Hak_function<font></font>
<font></font>
 tags:
     function:
         Tagname: $ Plugin :: Module :: tag_function
     block:
         Block Tag Name: $ Plugin :: Module :: block_ tag_function<font></font>
<font></font>
 object_types:
     an object:
         field: type # this field will be added to the object in the database
         field: meta type # this field will be stored in the metadata table and will not require updating the database structure<font></font>
<font></font>
 applications:
     # about this later, while you forgot
</pre><br><br>  It is unlikely that you will need all the sections at once, but the lack of a meaningful description about what might be there will create many more problems for you. <br>  Above, I described everything that I came across myself.  Even such a trifle as the <code>icon:</code> was found in the MT code itself, and not in the documentation. <br><br><h4>  Plugin setup </h4><br>  Much has been written about customization.  MT offers you a choice: create a settings page yourself, or use an autogenerator.  If your plugin is configured by 2-3-4 simple lines / checkboxes / so forth, of course, it is much easier and faster to get an auto-oscillator.  In general, the article " <a href="http://forums.movabletype.org/2008/11/howto-define-custom-plugin-settings.html">HOWTO: Plugin's own settings page</a> " from Adept MT <a href="http://www.movabletype.org/members/byrnereese">Byrne Reese</a> will help you in the basics (Byrne really knows a lot about MT, I advise you to read his posts). <br><br>  I want to describe a few points related to the configuration, a description of which I could not find anywhere: <br><br><h5>  Validation of data when configuring the plugin </h5><br>  MT itself nowhere practically produces data validation.  Maximum saves after reduction to the necessary type, therefore, it was not so easy to find how to carry out the validation. <br><br>  So, here you have a plugin class that was configured in the init hook (see above config.yaml).  The method itself (for example, lies in plugins / OurPlugin / lib / Plugin.pm) in the simplest case looks like this: <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> OurPlugin::Plugin <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> base <span class="hljs-string"><span class="hljs-string">'MT::Plugin'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cb_init</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $p = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bless</span></span> $p, <span class="hljs-string"><span class="hljs-string">'OurPlugin::Plugin'</span></span>; }</code> </pre> <br>  and is described in config.yaml like this: <br> <code>init: $OurPlugin::Plugin::cb_init</code> <br> <br>  This means that at the moment of saving, OurPlugin :: Plugin: save_config will be called, to which three arguments will be passed: our object, the form data in the hash, and the scope. <br><br>  Since we already have base MT :: Plugin, if we don‚Äôt do anything, then everything that the user introduced will be saved as-is.  If we want to do any validation, we need to: <br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save_config</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($plugin, $args, $scope) = @_; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> @errors; <span class="hljs-comment"><span class="hljs-comment">#           if (@errors) { return $plugin-&gt;error("&lt;br /&gt;\n".join("&lt;br /&gt;\n", @errors)); } return $plugin-&gt;SUPER::save_config($args, $scope); } ## end sub save_config</span></span></code> </pre> <br><br>  This will give you a creepy saving error page that will have a back button.  Therefore?  you can go another way: add another function load_config: <br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load_config</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($plugin, $args, $scope) = @_; $plugin-&gt;SUPER::load_config($args, $scope); <span class="hljs-comment"><span class="hljs-comment">#   -   ,   $plugin-&gt;error()   if($plugin-&gt;errstr) { # Set $args-&gt;{error} to display error banner right before plugin settings $args-&gt;{error} = $plugin-&gt;errstr; } } ## end sub load_config</span></span></code> </pre> <br>  And in the configuration template insert a piece <br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mt:if</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"error"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mtapp:statusmsg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"generic-error"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"error"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mt:var</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"error"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mtapp:statusmsg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mt:if</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  Thus, arbitrary data will be saved, but when you open the settings window, the user will see what is wrong there.  Which way to go is up to you, you can use both methods for different occasions, it is important to remember that <b>many standard tags do not work</b> inside the plug-in configuration template.  That is, they are available, but they give out crap, because the template is compiled in a separate independent context, so there is not even a blog ID for which settings are generated - and here <code>load_config</code> comes to the rescue <code>load_config</code> to set to <code>$args-&gt;{...}</code> necessary variables, without which it would not be possible to normally issue any prompts to the user. <br><br><h5>  Connecting jQuery to customize the plugin </h5><br>  Very merry moment.  MT5 uses jQ vovuyu, but it is not in MT4.  At the same time, some plugins for MT4 already load jQ, so if we just load jQ all the time, there will be a conflict in our heads. <br>  For myself, I decided this in a piece in blog_config.tmpl: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mt:If</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tag</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Version"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lt</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">// prevent double-load of jQuery, save if jQ already loaded its state if(window.jQuery) { window.__PLUG_jQ = window.jQuery; window.__PLUGB = window.$; } </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;$mt:StaticWebPath$&gt;jquery/jquery.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">// Restore there jQ state, if it was loaded before if(window.__PLUG_jQ) { window.jQuery = window.__PLUG_jQ; window.$ = window.__PLUGB; window.__PLUG_jQ = undefined; window.__PLUGB = undefined; } </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mt:If</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  The method is not very beautiful, but it allows you to be sure that jQ will be exactly loaded, and $ / jQuery will not be spoiled. <br><br><h4>  Tag Magic </h4><br>  Now consider the tags: functions and blocks. <br><br>  A tag function is a certain function that receives the current context, arguments, conditions and returns a string, which will be used.  In templates, tags are referenced via <code>&lt;$mt:$&gt;</code> . <br><br>  Classic questions: <br><ul><li>  How to get your settings in the tag? <br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tag_somemytag</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($ctx, $args, $cond) = @_; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $blog_id = $ctx-&gt;stash(<span class="hljs-string"><span class="hljs-string">'blog_id'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $some_param = MT-&gt;component(<span class="hljs-string"><span class="hljs-string">'OurPlugin'</span></span>)-&gt;get_config_value(<span class="hljs-string"><span class="hljs-string">'some_param'</span></span>, <span class="hljs-string"><span class="hljs-string">'blog:'</span></span> . $blog_id); <span class="hljs-comment"><span class="hljs-comment">#   my $config = MT-&gt;component('OurPlugin')-&gt;get_config_hash('blog:' . $blog_id); #    .... } ## end sub tag_somemytag</span></span></code> </pre> <br></li><li>  How to create a tag that uses trugi tags? <br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tag_somemytag</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($ctx, $args, $cond) = @_; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $text = <span class="hljs-string"><span class="hljs-string">"&lt;$mt:SomeOtherTag$&gt;"</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $t = MT::Template-&gt;new; $t-&gt;text($t); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $t-&gt;build($ctx) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> $ctx-&gt;error($t-&gt;errstr); } <span class="hljs-comment"><span class="hljs-comment">## end sub tag_somemytag</span></span></code> </pre> </li><li>  How to report bugs? <br>  Well, in general, just through <code>$ctx-&gt;error("error message");</code>  , but in addition there are also ‚Äúsharpened‚Äù error methods, for example <code>$ctx-&gt;_no_entry_error();</code>  . <br>  For details, see $ mt / lib / MT / Template / Context.pm. </li></ul><br><br>  A tag block is either a loop, or a condition, or something else, in which the ‚Äúinsides‚Äù are defined in the template, but how they are compiled is determined by the block itself.  They are described in tags / block in config.yaml (see above).  A classic tag loop for an array looks like this: <br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tag_myloop</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span>($ctx, $args, $cond) = @_; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $builder = $ctx-&gt;stash(<span class="hljs-string"><span class="hljs-string">'builder'</span></span>); <span class="hljs-comment"><span class="hljs-comment">#       . #   ,     -  my $tokens = $ctx-&gt;stash('tokens'); #   ,     my $res = ''; my $vars = $ctx-&gt;{__stash}{vars} ||= {}; for my $i (0..$#looparray) { my $item = $looparray[$i]; #    ,        local $vars-&gt;{__item__} = $item; #     local $vars-&gt;{__first__} = $i == 0; local $vars-&gt;{__last__} = ($i==($#looparray-1)); local $vars-&gt;{__odd__} = ($i % 2) == 0; local $vars-&gt;{__even__} = ($i % 2) == 1; local $vars-&gt;{__counter__} = $i+1; defined(my $out = $builder-&gt;build($ctx, $tokens, $cond)) or return $ctx-&gt;error($builder-&gt;errstr); $res .= $out; } return $res; }</span></span></code> </pre> <br>  Thus, the body will be compiled the necessary number of times, concatenated and issued to the outside.  If you wish, of course, you can turn on another logic, another thing is that this will not be obvious enough, so it‚Äôs better to follow the general rule: the tag-block provides access to the necessary data, everything else if necessary in other tags and in the template itself. <br><br><h4>  Callbacks: hacks to the core </h4><br>  In general, MT contains the ability to stick its handlers for almost all occasions.  More information about which places are available can be found <a href="http://www.movabletype.org/documentation/developer/callbacks/">in the documentation</a> , only there, again, not all are listed, but only the main ones.  If you need, for example, to set up any template for any page in the admin panel, then you need to define a hook on <code>MT::App::CMS::template_param.</code> .  And if you need to change the output of the page, then template_output is used.  These hooks are extremely useful if you want to create your own page in the admin panel (about which, if there is demand, in the next post).  When and if you need to find out what kind of hooks are there, feel free to grep the MT code for <code>run_callbacks</code> , and analyze the POD of the corresponding module. <br><br>  Since the topic of callbacks can be chewed for a long time for all occasions, I will give only the simplest example, such as, for example, automatically deploying syslki on Twitter inside the post. <br>  Defined in config.yaml <br><pre>  callbacks:
     MT :: Entry :: pre_save: $ OurPlugin :: Plugin :: cb_entry_pre_save
     # cms_pre_save.entry: $ OurPlugin :: Plugin :: cb_cms_pre_save_entry
     # api_pre_save.entry: $ OurPlugin :: Plugin :: cb_api_pre_save_entry </pre><br>  We have three points where we can stick in to process the text of a record before saving it. <br><ul><li>  <code>MT::Entry::pre_save</code> - is called from the ORM handler immediately before being saved to the database. </li><li>  <code>cms_pre_save.entry</code> - called before saving a record when editing through the admin area </li><li>  <code>api_pre_save.entry</code> - called before saving a record when editing via RPC or ATOM </li></ul><br><br>  For our task, the entry_pre_save is perfect, since we just need to handle the text according to the regexp.  So, we write: <br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cb_entry_pre_save</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($cb, $entry, $original) = @_; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $txt = $entry-&gt;text; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($txt <span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> $original-&gt;text) { <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $newtxt = $txt; <span class="hljs-comment"><span class="hljs-comment"># regexp from twitter-blackbird-pie plugin $newtxt =~ s/([^a-zA-Z0-9_]|^)([@\xef\xbc\xa0]+)([a-zA-Z0-9_]{1,20})(\/[a-zA-Z][a-zA-Z0-9\x80-\xff-]{0,79})?/$1@&lt;a href="http://twitter.com/intent/user?screen_name=$3" class="twitter-action"&gt;$3&lt;/a&gt;/ug; $entry-&gt;text($newtxt) if ($newtxt ne $txt); } return 1; } ## end sub cb_entry_pre_save</span></span></code> </pre> <br><br><h4>  Applications: admin setup </h4><br>  The MT itself is divided into several ‚Äúseparate‚Äù parts, each of which starts from its own startpoint.  It: <br><ul><li>  CMS (mt.cgi, admin) </li><li>  Comments (mt-comments.cgi, receiving new comments from the public) </li><li>  Wizard (mt-wizard.cgi, installation </li><li>  Upgrader (mt-upgrade.cgi, called when upgrading the database) </li><li>  Search, Search :: FreeText (mt-search.cgi, mt-ftsearch.cgi, search on the public part of the site) </li><li>  ActivityFeeds (mt-feed.cgi, RSS / Atom generator) </li><li>  Trackback, NotifyList </li></ul><br><br>  For each part in the config.yaml applications section, you can set your own parameters and settings that will be expanded / replaced by the plugin.  The entire section is extremely poorly documented (only in PODs and watch the use itself). <br>  The main use of the section is to announce the ajax calls you need.  For example, the ajax method available on a public site: <br><pre>  applitcations:
     comments:
         methods:
             record_some_info: $ OurPlugin :: Plugin :: ajax_record_some_info </pre><br>  And the function to it in the plugin: <br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ajax_record_some_info</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($app) = @_; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $blog = $app-&gt;blog; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $result = <span class="hljs-string"><span class="hljs-string">"{'error': 'No information supplied'}"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $user_name = $app-&gt;param(<span class="hljs-string"><span class="hljs-string">'user_name'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $info = $app-&gt;param(<span class="hljs-string"><span class="hljs-string">'info'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($user_name &amp;&amp; $info) { $result = do_store_info($user_name, $info); <span class="hljs-comment"><span class="hljs-comment">#     } $app-&gt;send_http_header(""); $app-&gt;print($result); return $app-&gt;{no_print_body} = 1; } ## end sub ajax_record_some_info</span></span></code> </pre> <br>  Add something like this to the interface (the code must be generated, or only the path is generated): <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> u = mtGetUser(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(u &amp;&amp; !u.is_anonymous) { jQuery.post({ <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">'&lt;mt:CGIPath encode_js='</span></span><span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'&gt;&lt;mt:CommentScript encode_js='</span></span><span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'&gt;'</span></span>, <span class="hljs-string"><span class="hljs-string">'__mode'</span></span>: <span class="hljs-string"><span class="hljs-string">'record_some_info'</span></span>, <span class="hljs-string"><span class="hljs-string">'user_name'</span></span>: u.name, <span class="hljs-string"><span class="hljs-string">'info'</span></span>: <span class="hljs-string"><span class="hljs-string">'he he'</span></span> });</code> </pre> <br>  Here it is important that the URL for the post should be obtained from the set &lt;mt: CGIPath encode_js = '1'&gt; &lt;mt: CommentScript encode_js = '1'&gt;, as it may differ in each place.  The classic solution is to generate a .js file, MT does so, or type something into the Header template. <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="xml"><span class="xml">COMMENTS_URL = '</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">mt:CGIPath</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">encode_js</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'1'</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">mt:CommentScript</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">encode_js</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'1'</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">';</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  and use COMMENTS_URL where appropriate. <br><br><h4>  Missed moments </h4><br>  I did not describe working with the database, how to expand existing ones and how to create new objects, as well as how to create my own pages in the admin panel and i18n questions.  Read about it in the next issue. <br><br><h4>  useful links </h4><br><ul><li>  <a href="http://www.movabletype.org/">MovableType</a> - the official site of the platform </li><li>  <a href="http://www.movabletype.org/documentation/developer/">MovableType Developer Center</a> - official developer documentation </li><li>  <a href="http://www.google.com/search%3Fq%3DHOWTO%2B%2Bsite%253Aforums.movabletype.org">HOWTO on forums.movabletype.org</a> - Google to help you find very useful things on the forum. </li><li>  <a href="http://groups.yahoo.com/groups/mt-dev/">mt-dev maillist</a> is another fish place for catching useful information.  A little bit rotten. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/119939/">https://habr.com/ru/post/119939/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../119931/index.html">Detailed installation guide for Android x86</a></li>
<li><a href="../119933/index.html">The use of Wi-Fi and mobile phones in Europe may limit</a></li>
<li><a href="../119934/index.html">"How to patch KDE under FreeBSD?" We are putting the experience!</a></li>
<li><a href="../119935/index.html">Selection of useful foreign hosting resources</a></li>
<li><a href="../119936/index.html">Australian robots make up their own language</a></li>
<li><a href="../119942/index.html">Debugging is easier: Opera Mobile Emulator</a></li>
<li><a href="../119945/index.html">Laboratory at Moscow State University solves the main problem of Russia</a></li>
<li><a href="../119947/index.html">Mikhalkov payments: money from nothing</a></li>
<li><a href="../119948/index.html">MUX.Dialog plugin for beautiful dialogs in your project</a></li>
<li><a href="../119949/index.html">How I experimented with microcredit on WebMoney</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>