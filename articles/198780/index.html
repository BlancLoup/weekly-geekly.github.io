<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Qt Meta System over Network. Part 2 - Signals and Slots</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Part 1 - Properties 
 We continue to deal with the Qt metasystem. This time we will consider the creation of virtual signals and slots. 

 1. Signals ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Qt Meta System over Network. Part 2 - Signals and Slots</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/231/e13/1b3/231e131b3b76d10af2cc0bfa5c96b413.jpg" align="left"><br>  <a href="http://habrahabr.ru/post/198270/">Part 1 - Properties</a> <br>  We continue to deal with the Qt metasystem.  This time we will consider the creation of virtual signals and slots. <br><a name="habracut"></a><br><h4>  1. Signals </h4><br>  Or rather connect to any signals.  Everything is very similar to working with properties, only arguments can be from 0 to 10. The goal is to get the DynamicQObject class, which can connect to any signal and when activated, call some method with the name of the signal and the passed arguments as QVariantList.  I will also break the code into pieces with comments, let's proceed: <br><div class="spoiler">  <b class="spoiler_title">dynamicqobject.h</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DynamicQObject</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QObject { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: DynamicQObject(QObject *mapToObject, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *signalCatchMethod, QObject *parent = <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addSlot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QObject *object, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *signal, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;slotName)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeSlot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;name)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addSignal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;name, QObject *object, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *slot)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeSignal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;name)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">activate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QString &amp;signalName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QVariantList &amp;args)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">qt_metacall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(QMetaObject::Call call, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **arguments)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-comment"><span class="hljs-comment">// virtual slots bool containsSlot(const QString &amp;name); QObject *m_mapTo; const char *m_catchMethod; typedef struct { bool isEmpty; // true after removeSlot() QObject *object; int signalIdx; QString name; // virtual slot name QVector&lt;int&gt; parameterTypes; } slot_t; QVector&lt;slot_t&gt; m_slotList; // virtual signals typedef struct { bool isEmpty; // // true after removeSignal() QObject *reciever; int slotIdx; QString name; QVector&lt;int&gt; parameterTypes; } signal_t; QVector&lt;signal_t&gt; m_signalList; QHash&lt;QString, int&gt; m_signalHash; void *m_parameters[11]; // max 10 parameters + ret value };</span></span></code> </pre> <br></div></div><br>  <b>addSlot</b> - creates a new virtual slot named slotName and connects it to the signal object of the object.  Let's see how it all works: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> DynamicQObject::addSlot(QObject *object, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *signal, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString &amp;slotName) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (containsSlot(slotName)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (signal[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'2'</span></span>) { qWarning() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Use SIGNAL() macro"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br>  Check whether there is already a slot with the same name, as well as the presence of the character '2' at the beginning of its name, this symbol adds the macro SIGNAL (). <br><pre> <code class="cpp hljs"> QByteArray theSignal = QMetaObject::normalizedSignature(&amp;signal[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> signalId = object-&gt;metaObject()-&gt;indexOfSignal(theSignal); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (signalId &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { qWarning() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"signal"</span></span> &lt;&lt; signal &lt;&lt; <span class="hljs-string"><span class="hljs-string">"doesn't exist"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } QVector&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; parameterTypes; QMetaMethod signalMethod = object-&gt;metaObject()-&gt;method(signalId); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; signalMethod.parameterCount(); ++i) parameterTypes.push_back(signalMethod.parameterType(i));</code> </pre><br>  Just like last time, we get the signal index, and then we get the QMetaMethod by this index.  From which we get the signal arguments one by one, create a vector from them.  Further we will bring the received arguments to these types. <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> slotIdx = <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; m_slotList.count(); ++i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_slotList[i].isEmpty == <span class="hljs-literal"><span class="hljs-literal">true</span></span>) { slotIdx = i; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> addEntry = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (slotIdx == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { addEntry = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; slotIdx = m_slotList.count(); }</code> </pre><br>  Everything is quite simple here, we find an empty entry (or create a new one) in m_slotList, where we will save information about the created slot.  Empty records are formed after removing slots (removeSlot ()), since  Our indexes are tied to slots, their shift would lead to the call of invalid slots.  One could apply QHash or QMap here, but I thought that slots are removed much less frequently than they are created, and called very often, so the vector is clearly more efficient, because  its index access is performed for O (1), while for QMap and QHash, in the worst case, it is O (logn) and O (n), respectively. <br>  Actually it remains only to connect to the signal: <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!QMetaObject::connect(object, signalId, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, slotIdx + metaObject()-&gt;methodCount())) { qWarning() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"can't connect"</span></span> &lt;&lt; signal &lt;&lt; <span class="hljs-string"><span class="hljs-string">"signal to virtual slot"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (addEntry) { m_slotList.push_back({<span class="hljs-literal"><span class="hljs-literal">false</span></span>, object, signalId, slotName, parameterTypes}); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">slot_t</span></span> &amp;slot = m_slotList[slotIdx]; slot.isEmpty = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; slot.object = object; slot.signalIdx = signalId; slot.name = slotName; slot.parameterTypes = parameterTypes; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br>  And keep all the necessary information about him. <br><br><h5>  Slot call </h5><br>  Here everything looks like a focus with properties, we create our own implementation of qt_metacall, only now we can have more arguments: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DynamicQObject::qt_metacall(QMetaObject::Call call, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> **arguments) { id = QObject::qt_metacall(call, id, arguments); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || call != QMetaObject::InvokeMetaMethod) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; Q_ASSERT(id &lt; m_slotList.size());</code> </pre><br>  We check that the slot (metamethod) is called, and that the index is correct. <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">slot_t</span></span> &amp;slotInfo = m_slotList[id]; QVariantList parameters; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; slotInfo.parameterTypes.count(); ++i) { <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *parameter = arguments[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]; parameters.append(QVariant(slotInfo.parameterTypes[i], parameter)); }</code> </pre><br>  We get previously saved information about the slot.  And further we create a list of QVariants from the resulting arguments and the stored types. <br><pre> <code class="cpp hljs"> QMetaObject::invokeMethod(m_mapTo, m_catchMethod, Q_ARG(QString, slotInfo.name), Q_ARG(QVariantList, parameters)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; }</code> </pre><br>  It remains only to call the method specified in the constructor with the name of the slot, and arguments. <br><br>  There is nothing interesting in removeSlot (), so let's take a look at the usage example: <br><pre> <code class="cpp hljs">Reciever reciever; <span class="hljs-function"><span class="hljs-function">DynamicQObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dynamic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;reciever, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"signalCatched"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; Tester tester; dynamic.addSlot(&amp;tester, SIGNAL(signal1(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>,QString)), <span class="hljs-string"><span class="hljs-string">"myslot1"</span></span>); dynamic.addSlot(&amp;tester, SIGNAL(signal2(QPoint)), <span class="hljs-string"><span class="hljs-string">"myslot2"</span></span>); tester.emitSignal1(); tester.emitSingal2();</code> </pre><br>  In the DynamicQObject constructor, we pass a pointer to any successor to the QObject and the name of the method (Q_INVOKABLE) that will be called upon receipt of any signal. <br>  In the Reciever class we have for there is the following method: <i>Q_INVOKABLE void signalCatched (const QString &amp; signalName, const QVariantList &amp; args)</i> , which simply output its arguments to the console. <br>  And in Tester there are two signals with the specified arguments, and two functions generating them, I think everything should be clear.  Run: <br><blockquote>  "Myslot1" (QVariant (int, 123), QVariant (int, 456), QVariant (QString, "str")) <br>  Myslot2 (QVariant (QPoint, QPoint (3,4))) </blockquote><br>  We see that everything works :) You can use absolutely any type of known Qt metasystem. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  2. Slots </h4><br>  Those.  creating virtual signals and connecting them to regular slots, it's easy to confuse one with another ... Three functions are responsible for this: addSignal (), removeSignal () and activate (). <br>  Consider the most interesting.  Signal creation: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> DynamicQObject::addSignal(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString &amp;name, QObject *object, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *slot) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (slot[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'1'</span></span>) { qWarning() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Use SLOT() macro"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> slotIdx = object-&gt;metaObject()-&gt; indexOfSlot(&amp;slot[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-comment"><span class="hljs-comment">// without 1 added by SLOT() macro if (slotIdx &lt; 0) { qWarning() &lt;&lt; slot &lt;&lt; "slot didn't exist"; return false; }</span></span></code> </pre><br>  As usual, we check that everything is going as it should. <br><pre> <code class="cpp hljs"> QVector&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; parameterTypes; QMetaMethod slotMethod = object-&gt;metaObject()-&gt;method(slotIdx); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; slotMethod.parameterCount(); ++i) parameterTypes.push_back(slotMethod.parameterType(i)); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> signalIdx = <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; m_slotList.count(); ++i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_slotList[i].isEmpty == <span class="hljs-literal"><span class="hljs-literal">true</span></span>) { signalIdx = i; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> addEntry = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (signalIdx == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { addEntry = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; signalIdx = m_signalList.count(); }</code> </pre><br>  Similarly, we create a vector of argument types. <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!QMetaObject::connect(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, signalIdx + metaObject()-&gt;methodCount(), object, slotIdx)) { qWarning() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"can't connect virtual signal"</span></span> &lt;&lt; name &lt;&lt; <span class="hljs-string"><span class="hljs-string">"to slot"</span></span> &lt;&lt; slot; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (addEntry) { m_signalList.append({<span class="hljs-literal"><span class="hljs-literal">false</span></span>, object, slotIdx, name, parameterTypes}); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">signal_t</span></span> &amp;signal = m_signalList[signalIdx]; signal.isEmpty = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; signal.reciever = object; signal.slotIdx = slotIdx; signal.name = name; signal.parameterTypes = parameterTypes; } m_signalHash.insert(name, signalIdx); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br>  And again everything is almost the same - we connect our virtual signal to the slot, and also save in m_signalHash a <i>name</i> pair <i>- the signal index</i> .  Thus, when the signal is activated, we get its index from the name. <br>  Deletion will not be considered, and even so a lot of code ... <br><br><h5>  Signal activation </h5><br>  There are already new moments, namely the casting. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> DynamicQObject::activate(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString &amp;signalName, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QVariantList &amp;args) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> signalIdx = m_signalHash.value(signalName, <span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (signalIdx == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { qWarning() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"signal"</span></span> &lt;&lt; signalName &lt;&lt; <span class="hljs-string"><span class="hljs-string">"doesn't exist"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">signal_t</span></span> &amp;signal = m_signalList[signalIdx];</code> </pre><br>  We check that the signal exists and retrieve the previously saved information. <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (args.count() &lt; signal.parameterTypes.count()) { qWarning() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"parameters count mismatch:"</span></span> &lt;&lt; signalName &lt;&lt; <span class="hljs-string"><span class="hljs-string">"provided:"</span></span> &lt;&lt; args.count() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"need &gt;=:"</span></span> &lt;&lt; signal.parameterTypes.count(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br>  We check that there are enough arguments, just drop the extra ones ... <br><pre> <code class="cpp hljs"> QVariantList argsCopy = args; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; signal.parameterTypes.count(); ++i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!argsCopy[i].convert(signal.parameterTypes[i])) { qWarning() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"can't cast parameter"</span></span> &lt;&lt; i &lt;&lt; signalName; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } m_parameters[i + <span class="hljs-number"><span class="hljs-number">1</span></span>] = argsCopy[i].data(); }</code> </pre><br>  Create a copy of the argument list, since  it is constant, and we need to type, i.e.  change it.  And then try to bring each argument to the desired type.  For example, you can call a slot with an argument of type int, passing the argument to type QString, the main thing is that the string contains a number. <br>  Example: <br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-function">DynamicQObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dynamic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;reciever, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"signalCatched"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; Reciever reciever; dynamic.addSignal(<span class="hljs-string"><span class="hljs-string">"virtual_signal"</span></span>, &amp;reciever, SLOT(slot1(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>,QString))); dynamic.activate(<span class="hljs-string"><span class="hljs-string">"virtual_signal"</span></span>, QVariantList() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"123"</span></span> &lt;&lt; QString(<span class="hljs-string"><span class="hljs-string">"qwerty"</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>);</code> </pre><br>  Accordingly, Reciever contains a regular slot.  We create a virtual signal and call it with an argument list. <br>  This is what happens: <br><blockquote>  slot1_call 123 "qwerty" </blockquote><br>  Two extra arguments were discarded, and for the first one, a type conversion was performed, I'm not sure that this is a very necessary thing, but then it turns out by itself, although it is possible to prohibit such behavior ... <br><br>  For now.  Next, we will deal with the methods, and fasten a simple network interface ... <br><br>  PS In writing this class, it was very helpful article: <a href="http://doc.qt.digia.com/qq/qq16-dynamicqobject.html">Dynamic Signals and Slots</a> , from which you can learn a lot of interesting things. </div><p>Source: <a href="https://habr.com/ru/post/198780/">https://habr.com/ru/post/198780/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198770/index.html">World View: stratospheric tourism in an air (helium) balloon</a></li>
<li><a href="../198772/index.html">Active authors in social media: a study by age group</a></li>
<li><a href="../198774/index.html">Work with tables in MultiCAD.NET. Part 2. Creating and editing</a></li>
<li><a href="../198776/index.html">JavaFX WebView (HTML / JS) - we use web practices for developing desktop applications</a></li>
<li><a href="../198778/index.html">The story of one Google Chrome extension</a></li>
<li><a href="../198782/index.html">Modding of the pulse power supply unit ARPV-SC1E-12005T</a></li>
<li><a href="../198784/index.html">Materials of the summer school on bioinformatics</a></li>
<li><a href="../198788/index.html">Work with tables in MultiCAD.NET. Part 3. External table files and data exchange with Microsoft Excel</a></li>
<li><a href="../198792/index.html">Blur in iOS7</a></li>
<li><a href="../198794/index.html">Singularity really close</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>