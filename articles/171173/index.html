<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Smart" queue size in android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In one of the projects, a seemingly trivial task arose at work: upload pictures and descriptions to them from the server so that the user could switch...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Smart" queue size in android</h1><div class="post__text post__text-html js-mediator-article">  In one of the projects, a seemingly trivial task arose at work: upload pictures and descriptions to them from the server so that the user could switch them without delay.  For this, the method was used, which, with each switch, checked how many items remained in the queue, and, if there was less than a certain number left, loaded the next item.  The case was solved by a constant equal to 3. But, as you know, android devices vary greatly in performance, and on other phones that number was not enough, but to set a very large number is inefficient, since the user could generally look at one or two elements and leave from the screen.  Then I thought, why not determine this number in an intelligent way? <br><a name="habracut"></a><br><h4>  Description </h4>  Determine the size of the queue will be a small decision-making system, which for convenience I will call a single-layer trained neural network. <br>  I found that the following data would be useful at the entrance: <br><ul><li>  Internet connection type (We are only interested in wifi or edge, because the operation of determining the connection speed is too laborious) </li><li>  Switch interval (How often the user switches pictures) </li><li>  Delay in switching (When everything is good, it should be 1ms in my case) </li><li>  Free RAM (Immediately I note that the current balance allocated to the process is measured, and not the total size of the remaining RAM, so this parameter is not very important) </li><li>  Queue size (Feedback is important to inhibit queues that are too large) </li></ul><br>  I immediately refused to perform calculations in the GUI thread, for example, during the switch itself, because the queue size does not always need to be measured as often as the user can click on the button, and sometimes, on the contrary, you need to prepare in advance.  So the whole procedure is carried out in a separate stream with a lower priority, with an interval of sleep, which will also change. <br><br><h4>  Let's get started </h4>  Since the data varies greatly in size (for example, the remaining memory is measured in bytes, so there will be numbers with more than six digits, and the type of connection is a single-valued constant), for convenience, several constants are entered to normalize the values ‚Äã‚Äãthat help to bring all numbers to the range ~ [-20; 20].  In addition to constants, sometimes the difference between a manually determined normal value and the current one is used, see below. <br><br><h5>  Read more </h5> <b>Internet connection type</b> (Variable <code>private double connectionType=0;</code> ) <br>  An instance of the NetworkInfo class is required: <br> <code>NetworkInfo activeNetwork = ((ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE)).getActiveNetworkInfo();</code> <br>  At each iteration of calculations, we first check <br> <code>if (!activeNetwork.isConnectedOrConnecting()) return;</code> <br>  Further <br> <code>connectionType = (activeNetwork.getType()); // EDGE = 0; WiFi = 1</code> <br> <br>  <b>Switching Interval</b> (Variables <code>private long tapInterval = 5000; private byte tapTrigger = 0; private double tapAssemblyAverage = 5000;private long nextTap = 0; private long lastTap = 0;</code> ) <br>  To get the interval, use the method <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setNextTap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nextTap)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastTap=<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nextTap; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nextTap = nextTap; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nextTap &gt; lastTap) { tapInterval = nextTap - lastTap; lastTap = nextTap; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tapInterval &gt; TAP_INTERVAL_UPPER_THRESHOLD) tapInterval = TAP_INTERVAL_UPPER_THRESHOLD; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tapInterval &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>) tapInterval = <span class="hljs-number"><span class="hljs-number">100</span></span>; tapAssemblyAverage = (tapAssemblyAverage * tapTrigger + tapInterval) / (++tapTrigger); }</code> </pre>  which is called from the place where the user switches items.  <code>TAP_INTERVAL_UPPER_THRESHOLD</code> is a constant, in my case equal to 10,000 ms. <br>  As you noticed, the average switching value is used.  <code>tapTrigger</code> reset when updating. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Switching delay</b> (Variables <code>private long delayInterval = 500; private long finishDelay = 0; private long startDelay = 0;</code> ) <br>  For getting used methods <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setStartDelay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> start)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.startDelay = start; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setFinishDelay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> finish)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.finishDelay = finish; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (finishDelay &gt; startDelay) { delayInterval = finishDelay - startDelay; } }</code> </pre>  Here the last delay is important, not the average value of the delays. <br><br>  <b>Free RAM</b> (Variable <code>private long freeRam = 5000000;</code> ) <br>  I repeat that the current balance allocated to the process is measured, and not the total size of the remaining RAM. <br><pre> <code class="java hljs">freeRam = Runtime.getRuntime().freeMemory();</code> </pre><br><br><h5>  Normalization </h5>  For storing normalized values ‚Äã‚Äãand their weights, the array is Relations / <code>double[][] RW = new double[2][5];</code>  For normalization, a series of constants and formulas are used. <br><div class="spoiler">  <b class="spoiler_title">Constants</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TAP_EQUALIZER = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DELAY_EQUALIZER = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> RAM_EQUALIZER = <span class="hljs-number"><span class="hljs-number">1000000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TAP_INTERVAL_UPPER_THRESHOLD = <span class="hljs-number"><span class="hljs-number">10000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DELAY_INTERVAL_UPPER_THRESHOLD = <span class="hljs-number"><span class="hljs-number">5000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> NORMAL_TAP_INTERVAL = <span class="hljs-number"><span class="hljs-number">9</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TAP_I = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DELAY_I = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CONNECTION = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> RAM = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> QUEUE = <span class="hljs-number"><span class="hljs-number">4</span></span>;</code> </pre> </div></div><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">normalization</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (delayInterval &gt; DELAY_INTERVAL_UPPER_THRESHOLD) delayInterval = DELAY_INTERVAL_UPPER_THRESHOLD; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (delayInterval &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) delayInterval = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (connectionType &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> || connectionType &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) connectionType = <span class="hljs-number"><span class="hljs-number">0.5</span></span>; connectionType = (connectionType - <span class="hljs-number"><span class="hljs-number">2</span></span>) * <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (freeRam &lt; <span class="hljs-number"><span class="hljs-number">100000</span></span> || freeRam &gt; <span class="hljs-number"><span class="hljs-number">10000000</span></span>) freeRam = <span class="hljs-number"><span class="hljs-number">5000000</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cast</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RW[<span class="hljs-number"><span class="hljs-number">0</span></span>][TAP_I] = (NORMAL_TAP_INTERVAL - (tapAssemblyAverage / TAP_EQUALIZER)); RW[<span class="hljs-number"><span class="hljs-number">0</span></span>][DELAY_I] = (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) (delayInterval / DELAY_EQUALIZER); RW[<span class="hljs-number"><span class="hljs-number">0</span></span>][CONNECTION] = connectionType; RW[<span class="hljs-number"><span class="hljs-number">0</span></span>][RAM] = (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) (freeRam / RAM_EQUALIZER); RW[<span class="hljs-number"><span class="hljs-number">0</span></span>][QUEUE] = (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) (count); }</code> </pre><br><br><h5>  Weights </h5>  It remains to say about the scales.  They can be selected in two ways: analytically or by simplex method, for example, in Excel.  I selected weights analytically, so I‚Äôll just give the results: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setInitialWeights</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RW[<span class="hljs-number"><span class="hljs-number">1</span></span>][TAP_I] = <span class="hljs-number"><span class="hljs-number">0.5</span></span>; RW[<span class="hljs-number"><span class="hljs-number">1</span></span>][DELAY_I] = <span class="hljs-number"><span class="hljs-number">1</span></span>; RW[<span class="hljs-number"><span class="hljs-number">1</span></span>][CONNECTION] = -<span class="hljs-number"><span class="hljs-number">1</span></span>; RW[<span class="hljs-number"><span class="hljs-number">1</span></span>][RAM] = <span class="hljs-number"><span class="hljs-number">0.1</span></span>; RW[<span class="hljs-number"><span class="hljs-number">1</span></span>][QUEUE] = -<span class="hljs-number"><span class="hljs-number">0.1</span></span>; }</code> </pre><br>  As a result, the queue size is always an inhibitory bond, and the switching interval can be either inhibitory or simple. <br><br><h5>  Calculation </h5>  In the following method, the standard queue formula calculates the queue size and rounds to a larger integer.  In addition, the refresh interval is calculated here.  It depends on the queue change.  If it has changed by more than the value of the constant <code>int SLEEP_COMPARISON_THRESHOLD = 2</code> , then the interval decreases, otherwise it increases. <br><div class="spoiler">  <b class="spoiler_title">Constants and variables</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SLEEP_COMPARISON_THRESHOLD = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SLEEP_ADDITION_INC_STEP = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SLEEP_ADDITION_DEC_STEP = -<span class="hljs-number"><span class="hljs-number">500</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> sleepInterval = <span class="hljs-number"><span class="hljs-number">500</span></span>;</code> </pre> </div></div><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">activation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> value = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>; i++) value += RW[<span class="hljs-number"><span class="hljs-number">0</span></span>][i] * RW[<span class="hljs-number"><span class="hljs-number">1</span></span>][i]; sleepInterval += ((Math.abs(count - value) &gt; SLEEP_COMPARISON_THRESHOLD || sleepInterval &gt; <span class="hljs-number"><span class="hljs-number">10000</span></span>)) ? SLEEP_ADDITION_DEC_STEP : SLEEP_ADDITION_INC_STEP; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sleepInterval &lt; <span class="hljs-number"><span class="hljs-number">500</span></span>) sleepInterval = <span class="hljs-number"><span class="hljs-number">500</span></span>; Log.d(<span class="hljs-string"><span class="hljs-string">"QUEUE"</span></span>, <span class="hljs-string"><span class="hljs-string">"sleep: "</span></span> + String.valueOf(sleepInterval)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) value = <span class="hljs-number"><span class="hljs-number">1</span></span>; Log.d(<span class="hljs-string"><span class="hljs-string">"QUEUE"</span></span>, <span class="hljs-string"><span class="hljs-string">"queue: "</span></span> + String.valueOf(value)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) Math.ceil(value); }</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Full code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntellijQueue</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Thread</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TAP_I = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DELAY_I = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CONNECTION = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> RAM = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> QUEUE = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TAP_EQUALIZER = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DELAY_EQUALIZER = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> RAM_EQUALIZER = <span class="hljs-number"><span class="hljs-number">1000000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SLEEP_COMPARISON_THRESHOLD = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SLEEP_ADDITION_INC_STEP = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SLEEP_ADDITION_DEC_STEP = -<span class="hljs-number"><span class="hljs-number">500</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TAP_INTERVAL_UPPER_THRESHOLD = <span class="hljs-number"><span class="hljs-number">10000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DELAY_INTERVAL_UPPER_THRESHOLD = <span class="hljs-number"><span class="hljs-number">5000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> NORMAL_TAP_INTERVAL = <span class="hljs-number"><span class="hljs-number">9</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> finishDelay = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> startDelay = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> nextTap = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lastTap = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> sleepInterval = <span class="hljs-number"><span class="hljs-number">500</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> connectionType = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> tapInterval = <span class="hljs-number"><span class="hljs-number">5000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> delayInterval = <span class="hljs-number"><span class="hljs-number">500</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> freeRam = <span class="hljs-number"><span class="hljs-number">5000000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> RW[][]; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> tapTrigger = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> tapAssemblyAverage = <span class="hljs-number"><span class="hljs-number">5000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> NetworkInfo activeNetwork; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IntellijQueue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setPriority(MIN_PRIORITY); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setDaemon(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); activeNetwork = ((ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE)).getActiveNetworkInfo(); RW = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>][<span class="hljs-number"><span class="hljs-number">5</span></span>]; setInitialWeights(); lastTap = System.currentTimeMillis(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setInitialWeights</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RW[<span class="hljs-number"><span class="hljs-number">1</span></span>][TAP_I] = <span class="hljs-number"><span class="hljs-number">0.5</span></span>; RW[<span class="hljs-number"><span class="hljs-number">1</span></span>][DELAY_I] = <span class="hljs-number"><span class="hljs-number">1</span></span>; RW[<span class="hljs-number"><span class="hljs-number">1</span></span>][CONNECTION] = -<span class="hljs-number"><span class="hljs-number">1</span></span>; RW[<span class="hljs-number"><span class="hljs-number">1</span></span>][RAM] = <span class="hljs-number"><span class="hljs-number">0.1</span></span>; RW[<span class="hljs-number"><span class="hljs-number">1</span></span>][QUEUE] = -<span class="hljs-number"><span class="hljs-number">0.1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cast</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RW[<span class="hljs-number"><span class="hljs-number">0</span></span>][TAP_I] = (NORMAL_TAP_INTERVAL - (tapAssemblyAverage / TAP_EQUALIZER)); RW[<span class="hljs-number"><span class="hljs-number">0</span></span>][DELAY_I] = (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) (delayInterval / DELAY_EQUALIZER); RW[<span class="hljs-number"><span class="hljs-number">0</span></span>][CONNECTION] = connectionType; RW[<span class="hljs-number"><span class="hljs-number">0</span></span>][RAM] = (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) (freeRam / RAM_EQUALIZER); RW[<span class="hljs-number"><span class="hljs-number">0</span></span>][QUEUE] = (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) (count); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">activation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> value = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>; i++) value += RW[<span class="hljs-number"><span class="hljs-number">0</span></span>][i] * RW[<span class="hljs-number"><span class="hljs-number">1</span></span>][i]; sleepInterval += ((Math.abs(count - value) &gt; SLEEP_COMPARISON_THRESHOLD || sleepInterval &gt; <span class="hljs-number"><span class="hljs-number">10000</span></span>)) ? SLEEP_ADDITION_DEC_STEP : SLEEP_ADDITION_INC_STEP; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sleepInterval &lt; <span class="hljs-number"><span class="hljs-number">500</span></span>) sleepInterval = <span class="hljs-number"><span class="hljs-number">500</span></span>; Log.d(<span class="hljs-string"><span class="hljs-string">"QUEUE"</span></span>, <span class="hljs-string"><span class="hljs-string">"sleep: "</span></span> + String.valueOf(sleepInterval)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) value = <span class="hljs-number"><span class="hljs-number">1</span></span>; Log.d(<span class="hljs-string"><span class="hljs-string">"QUEUE"</span></span>, <span class="hljs-string"><span class="hljs-string">"queue: "</span></span> + String.valueOf(value)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) Math.ceil(value); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateValues</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeNetwork.isConnectedOrConnecting()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; connectionType = (activeNetwork.getType()); <span class="hljs-comment"><span class="hljs-comment">// EDGE = 0; WiFi = 1 tapTrigger=0; freeRam = Runtime.getRuntime().freeMemory(); Log.d("QUEUE", "tap interval: " + String.valueOf(tapInterval)); Log.d("QUEUE", "delay interval: " + String.valueOf(delayInterval)); Log.d("QUEUE", "free RAM: " + String.valueOf(freeRam)); normalization(); cast(); } private synchronized void normalization() { if (delayInterval &gt; DELAY_INTERVAL_UPPER_THRESHOLD) delayInterval = DELAY_INTERVAL_UPPER_THRESHOLD; if (delayInterval &lt; 0) delayInterval = 0; if (connectionType &gt; 1 || connectionType &lt; 0) connectionType = 0.5; connectionType = (connectionType - 2) * 2; if (freeRam &lt; 100000 || freeRam &gt; 10000000) freeRam = 5000000; } @Override public void run() { try { while (true) { updateValues(); count = activation(); sleep(sleepInterval); } } catch (InterruptedException e) { } } public synchronized void setStartDelay(long start) { this.startDelay = start; Log.d("QUEUE", "S Ok."); } public synchronized void setFinishDelay(long finish) { this.finishDelay = finish; Log.d("QUEUE", "F Ok."); if (finishDelay &gt; startDelay) { delayInterval = finishDelay - startDelay; } } public synchronized void setNextTap(long nextTap) { this.lastTap=this.nextTap; this.nextTap = nextTap; if (nextTap &gt; lastTap) { tapInterval = nextTap - lastTap; lastTap = nextTap; } if (tapInterval &gt; TAP_INTERVAL_UPPER_THRESHOLD) tapInterval = TAP_INTERVAL_UPPER_THRESHOLD; if (tapInterval &lt; 100) tapInterval = 100; tapAssemblyAverage = (tapAssemblyAverage * tapTrigger + tapInterval) / (++tapTrigger); } }</span></span></code> </pre></div></div><br><h4>  Total </h4>  After connecting the class to the project, switching delays disappeared.  When testing on different devices, the queue changed in the range from 2 to 11. The tests were conducted on: Samsung Galaxy S2, Galaxy S3, Samsung Gio, Motorolla Atrix 2, Nexus, Explay tablet. <br>  Thanks to everyone who read to the end.  It was nice to share an interesting challenge. </div><p>Source: <a href="https://habr.com/ru/post/171173/">https://habr.com/ru/post/171173/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171163/index.html">Easy installation of Asterisk + FreePBX for beginners</a></li>
<li><a href="../171165/index.html">Canonical seriously thinking about abandoning semi-annual releases.</a></li>
<li><a href="../171167/index.html">Intellectual ideas that everyone should know</a></li>
<li><a href="../171169/index.html">White-box cryptography in pictures</a></li>
<li><a href="../171171/index.html">"You must be crazy if you don't use the potential of Open Source." Gerhard Lausser on open source monitoring systems and enterprise solutions</a></li>
<li><a href="../171175/index.html">Integration design. Every pixel matters. Part 2</a></li>
<li><a href="../171177/index.html">DNSSEC in practice at the domain registrar</a></li>
<li><a href="../171181/index.html">New Zopfli algorithm improves zlib compression by 3-8%</a></li>
<li><a href="../171183/index.html">RemoteAll - Mobile Screen Management Technology</a></li>
<li><a href="../171185/index.html">BigDog equipped with "hand"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>