<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to write an excellent VKontakte news feed in 20 hours</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Recently I passed a contest from VKontakte Mobile Challenge, and my work won a prize. According to the instructions of the second stage, it was...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to write an excellent VKontakte news feed in 20 hours</h1><div class="post__text post__text-html js-mediator-article">  Hello!  Recently I passed a contest from VKontakte Mobile Challenge, and my work won a prize.  According to the instructions of the second stage, it was necessary to develop a news line for mobile devices, and the main evaluation criteria were smooth scrolling and loading of posts.  When I participated, I decided that regardless of the final result, I would try to write an article about the approach to the implementation of the tape and about my emotions and experiences during the competition.  What I did.  Under the cat tips and tricks for the development of news feed in storytelling mode. <br><br><img src="https://habrastorage.org/webt/qs/vl/bd/qsvlbdyf6xjc1qme1fbsdkrt4fq.jpeg"><br><a name="habracut"></a><br><h2>  About competition </h2><br>  First of all it is worth telling a little about competition.  As I know, the VKontakte company annually organizes such events for mobile developers.  I myself participated in 2012 and 2013.  Tasks were respectively the development of chat and filters for images.  In 2013 I managed to reach the final round and win 100,000 rubles, which seemed to me a very good amount for 4 days of interesting work. <br><br>  And, having seen an advertisement in a social network, I decided that I should try, because the coolest thing is to prove to myself that you are still able to write high-quality code in a very short time). <br>  There were 2 stages in the competition: in the first it was proposed to pass a test of 30 questions, to solve 2 olympiad puzzles and one quality one (that is, the solution is a set of your thoughts, drawn up as text).  In the second round, out of 1000+ people, only 112 went through (we are talking only about iOS, with slightly lower values ‚Äã‚Äãon Android) and the main stage began - application development. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      According to the assignment, it was necessary to make a news feed, integration with the VC API to write independently, the tape had to be very smooth on all devices, there were certain requirements for displaying content (posts with images and carousel, likes, counters, number of views, and the ability to minimize and expand the post under certain conditions). <br><br>  Layouts were laid out in Figma.  This is a good choice for the competition, because competition is immediately felt by the number of active users (and even knocked out on Saturday, since the simultaneous limit of 50 connections was exceeded). <br><br>  In general, the organization of the competition was smooth with the exception of a few moments: immediately after the publication of the assignment, the link to the layouts turned out to be broken, then as I said above - on Saturday the entrance to Figma was blocked (this problem was very quickly fixed), well, after the end of the event it took a long time expect results.  But the whole negative smoothes a similar post: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ss/9k/br/ss9kbrm8ezjvfipwqfyh8ymkabw.png"></div><br><h2>  Winning plan and strategy </h2><br>  Very important and interesting block, if you participate in competitions, or would like to try.  Before participating, I recommend everyone to think about what goal you are pursuing and what result you want to get at the exit.  For myself, I decided before proceeding to the contest that I want to win it (i.e. take a prize).  And in order to do this a strategy is needed: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lv/ez/ax/lvezaxkggibj2tjl8n-d5mjeqak.jpeg"></div><br>  Below is the winning strategy formula (it seems to me, universal and simple, but I am sure that it should not be followed by the majority of participants): <br><br><ul><li>  <b>Read the assignment very carefully</b> .  After a few hours, read it again (several times I got into a situation where I did not perceive the tasks from the first time).  And a couple of hours before putting it just one more time just in case. </li><li>  <b>Make questions and ask them to the organizers</b> (usually the requirements for the task do not take into account many situations, or they are set up very superficially).  I did so, getting answers in the style of "at your discretion." </li><li>  <b>Make a project plan.</b>  Yes, participation in a contest or a hackathon is the execution of a project.  The project has a goal, timeline, resources and budget.  Time is strictly limited, and it is impossible to move the end of the change.  Additional people can not be invited - the competition is not a team.  All you have is your own people.  / clock.  Immediately decide how much you are willing to spend (think well how much it will take to sleep, food, procustination, breaks, and yes, your performance will fall due to fatigue and nerves from feeling helpless before inexorably approaching deadlines). </li><li>  <b>The plan should have tasks, their priorities and weights</b> (I used estimates of the form 1, 2, 4, 8).  Evaluation includes duration, unwillingness to perform it, and potential risks (complexity, incomprehensible conditions, no experience of similar development, etc.).  Next, you make a detailed plan (or roadmap of tasks) - first, the most important and complex (leave light and clear at the end). </li><li>  <b>Choose a few large intervals or milestones</b> (perfect days - we had 3 days).  And when passing through each of them, look at your work plan, decompose the tasks, sort them, and most importantly, with pleasure, cross out those that have already been done. <br>  Now the advice (I did just that): carefully look at how the task was formulated, whether the words ‚Äúrequired‚Äù and ‚Äúoptional‚Äù are in it.  And what evaluation criteria will items from ‚Äúextra‚Äù, i.e.  whether they will overlap with their advantage the lack of implemented requirements from the section "necessarily".  I doubt.  Therefore, concentrate on the ‚Äúrequired‚Äù section.  For myself, I consciously crossed out the ‚Äúextra‚Äù section at all and did not even intend to start it. </li><li>  When implementing, be <b>attentive to details</b> .  For example, if there are many interface forms in the task, then make them the way they are displayed on the layouts.  Pay attention to indents, fonts, shadows, line spacing, etc.  This will undoubtedly add you points for accuracy and consistency.  By the way, in Figma, in contrast to Zeplin, there is a very wide export of settings, for example, you can get a good NSAttributedString. </li></ul><br>  The assignment was open on the night from Thursday to Friday.  Friday is a working day and there was no opportunity and desire to compete at work.  Therefore, after returning from work on Friday night, I first and foremost took up planning, estimating, and calculating how much real time I could spend. <br><br>  The original plan was as follows: <br><table><tbody><tr><td width="100">  Day </td><td width="100">  Time </td><td>  Tasks </td></tr><tr><td>  Friday </td><td>  4 hours </td><td>  Authorization, data acquisition for a profile and a tape. </td></tr><tr><td>  Saturday </td><td>  9 hours </td><td>  The prototype of the tape with the display of red squares of different heights, loading them from above by pull-to-refresh and endless loading into the depth of history, preparation of all models and services (working with API, query caching, image caching). <br></td></tr><tr><td>  Sunday </td><td>  9 hours </td><td>  The output of real data (text, single images and merry-go-rounds), counters likes, views and final tuning according to layouts. </td></tr></tbody></table><br><h2>  Tape implementation technique </h2><br>  Hooray!  Gentlemen, you have found the block you need.  Here we will talk about the implementation of the main part of the task - the news feed. <br><br>  In general, if we abstract, then the news feed is only an application implementation, in general we will talk about creating a list of disparate entities (i.e., each can have its own display, requiring additional calculations and its own height, which can change dynamically even after displaying the post) , plus the list is able to be updated via pull-to-refresh and endlessly load data from below. <br><br>  I decided to solve the common problem in the first place.  The first step is to analyze existing solutions.  I need to focus on the strongest, so I chose 3 applications for comparison: Vkontakte, Facebook, Instagram. <br><br>  So I wanted to conduct a study of the 6 most acute and critical problems: <br><br><ol><li>  Pull-to-refresh (add to the top of the list) </li><li>  Smooth loading history (adding to the end of the list) </li><li>  Fast scrolling (alternately using your fingers, accelerate the tape as much as the friction force allows) </li><li>  Scroll to top (we accumulate a big story and click on the status bar) </li><li>  Is there a dynamic disclosure (increase) of the post and what is the animation </li><li>  How the tape works in the mode of almost complete packet loss (Developer -&gt; Network Link Conditioner -&gt; Very Bad Network) </li></ol><br><img align="left" src="https://habrastorage.org/webt/cd/zq/hf/cdzqhfx6xjxylpjscwskjqopwvc.gif"><br>  In general, all applications behave well, but I still noticed a few problems. <br>  Look, for example, how pull-to-refresh on VKontakte behaves, if you do not release your finger when updating and gently pull the ribbon up (see the gif on the left). <br><br>  Do you see this jump too? <br><br>  Instagram and Facebook haven't detected this behavior. <br><br>  And there is a noticeable difference when opening a post.  On Facebook and Instagram, this happens with smooth animation, and VKontakte simply updates the size by pressing. <br><br><img width="200" src="https://habrastorage.org/webt/fz/vr/e0/fzvre0irj7pyenw20stzliviu-m.gif"><img width="200" src="https://habrastorage.org/webt/jy/me/a3/jymea31x_cquywrn_5s1q5bkyxk.gif"><img width="200" src="https://habrastorage.org/webt/gz/8f/yv/gz8fyvzq-wgoy_hspb1v6gdhgxq.gif"><br><br>  So our task is to make a smooth scrolling, loading posts, as well as opening with animation. <br><br>  The first step is to choose a concept and create a prototype on the red squares (I wonder why I always intuitively choose the red color for the prototypes. Is that the case for everyone?). <br>  My main idea in improving performance was to abandon all the bells and whistles that Apple introduced for many years and a literal rollback to development for iOS 3. And this means: <br><br><ul><li>  Refusal of AutoLayout (yes, it is slow, if you don‚Äôt believe it - I can prove it in the comments) </li><li>  Refusal to automatically calculate the height of table cells </li></ul><br>  As a result, the following concept was chosen: <br><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/co/k1/17/cok117aerlspo8jhpvgedow5er8.png"></div><br><br>  Let's get a little more detail. <br><br>  In the main thread, we update the interface, process user actions (scroll down and pull-to-refresh, click on the post to increase it), and trigger the service model for receiving and preparing data. <br><br>  <b>Appeal to API</b> .  Everything is simple here - NSURLSession with configured NSURLCache.  At the same time it is important that when downloading the history down, we use the cache, and when pull-to-refresh we disable it.  Exactly this behavior I spied on VK and Facebook. <br><br>  <b>Parsing and creating models</b> .  Here is the logic for processing a particular request, throwing errors and returning transport models with data. <br><br>  <b>Calculation of models of representation</b> .  The most important step to optimize performance.  Here, the transport models are converted to an entity with a postfix ViewModel.  ViewModel stores in itself fully prepared data for display - AttributedString, calculated cell height (for 2 states: minimized and expanded), full name as a string, string with date (already converted from DateFormatter). <br><br>  Only after that the data is returned to the main stream.  Implementing similar logic on Swift is very convenient and simple.  Make the ViewModel a structure.  Structures are copied when sent to a new stream. <br><br>  Excellent concept is ready, now let's talk about the output mechanism itself. <br><br>  First, it was necessary to choose on what to implement the tape - UITableView or UICollectionView (for its implementation, it would definitely not be enough for the allotted time).  Obviously, UITableView is suitable for displaying a list, but I was very worried if there would be problems with increasing the list above, below, and also increasing the content cell.  Therefore, I decided to go from simple to complex - i.e.  if the problems with UITableView are not found, we leave it. <br><br>  First of all, I decided to decide on a pull-to-refresh.  To implement this pattern, there is a UIRefreshControl.  Sometime 5-6 years ago I wrote my implementation using UIActivityIndicator and changing the contentInset of the table.  So, please do not do it now!  UIRefreshControl has a convenient compact interface and takes away a cloud of crutches, which will certainly have to do.  Using it is very simple: <br><br><img src="https://habrastorage.org/webt/av/me/8q/avme8qosdlakgnqxqevuv1qgqks.png"><br><br>  However, when using it, it becomes clear where the problems shown above for the VK client are growing from.  It seems that they exist in the component itself.  I quickly tried to look for what could be the reason and what are the solutions. <br><br>  Internet tips say ( <a href="https://stackoverflow.com/questions/28560068/uirefreshcontrol-endrefreshing-is-not-smooth">such</a> or <a href="https://stackoverflow.com/questions/32595939/uitableviewcontroller-refreshcontrol-is-glitchy-when-uitableviewcontroller-frame">such</a> ): <br><br><ul><li>  check if endRefreshing is called is updated now control (isRefreshing) </li><li>  use exactly UITableViewController (because in this case the magic private method is called) </li></ul><br>  I tried this and that - no positive effect appeared to me.  I was upset, but decided not to waste time and move on.  By the way, if someone knows how to overcome this problem, please write in the comments. <br><br>  The next step is the implementation of data loading from below. <br><br>  At first I didn‚Äôt get very cool - when loading from the bottom, there was a terrible lag (the contentSize table jumped apparently): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hz/ug/4c/hzug4cff4v6g0bjdz_54p9pgv9c.gif"></div><br>  And this is hell :-) With this result you won‚Äôt win.  But the quick search gave me a terrific hint, which I forgot: <br><br><img width="500" src="https://habrastorage.org/webt/ft/yl/cf/ftylcf1dluksjxsuiyct-dmec64.png"><br><br>  And voila: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/az/yc/08/azyc08p8gabi-vhoirpda7zpu_m.gif"></div><br>  It remains to decide how to animate the height of the cell. <br><br>  The first idea that came to mind is to run along visibleCells and increase the height in the animation block.  But even at the stage of analysis, this idea should be discarded - the problem is that it will be necessary to synchronize the height specified in the UITableViewDataSource and something to do with contentSize (which is not recommended by Apple). <br><br>  The second thought that came to mind turned out to be correct - UITableView has insert / reload / delete methods that can be executed in the animation block: <br><br><img width="500" src="https://habrastorage.org/webt/gu/y3/ed/guy3edhkr384b12dq0cxpthwtas.png"><br><br>  Do not forget that in heightForRowAt we also need to add a new height: <br><br><img width="750" src="https://habrastorage.org/webt/no/io/sb/noiosbe6z7fdsxvf_eciai1c1fe.png"><br><br>  It seems that everything, but not quite!  In the animation of the unfolding of the post, there remains one subtle point.  Look behind the text in Intagram or Facebook - it appears smoothly as you increase the height.  What to do?  Render it line by line?  If you reach the level of NSTextContainer, then it is possible and there will be a similar opportunity.  But it seemed to me that it was not such a bad idea (for such and such a time) to print the entire text at once.  Just set the clipToBounds of the superView, which will contain a UILabel that displays our text.  And the approach worked!  Oh, this animation greatly inspired me and opened a second wind.  After all, this animation is not in the native client VK.  So the chance of winning it should add :-) <br><br>  The remaining parts in the implementation of the tape are not so interesting.  But you can ask them in the comments.  And there's nothing wrong with posting code.  Here it is - <a href="https://github.com/katleta3000/vkmobilechallenge">github.com/katleta3000/vkmobilechallenge</a> .  Forgive that, but not combed and there are places Magic Numbers (but this is a competition for speed, something had to be sacrificed).  By the way, there you can jump on commits (the names are quite understandable). <br><br>  The result can be seen here - <a href="https://www.youtube.com/watch%3Fv%3DMd8YiJxSW1M%26feature%3Dyoutu.be">www.youtube.com/watch?v=Md8YiJxSW1M&amp;feature=youtu.be</a> (the quality is of course greatly lost, but better than in the gif for the demonstration of smooth scroll) <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Md8YiJxSW1M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2>  Statistics, results, conclusions </h2><br>  All the time the competition worked on a timer.  It turned out 20 and a half hours of net coding time.  Time tracking helped in 2 things: as you remember, there were estimates in abstract units, so by the middle of the last day there was already quite good tracking statistics and it was possible to plan the remaining final tasks much more accurately.  And, secondly, it was possible to identify and prove the pattern of ‚Äúconcentration in one sitting‚Äù.  Each dimension is a new iteration, so it turned out that I had 68 iterations of writing code.  If averaged, it would be 18.5 minutes.  But in fact, on the first day, the iterations were on average 25 minutes each, but by the end of the second day, by 7 :-) You start to go crazy, get very nervous, you get tired and the performance drops.  Similar data will help well the next time. <br><br>  Personally, I used the <a href="http://hourly-app.com/%3Futm_source%3Dvk%26utm_medium%3Dcontest-article">Hourly</a> program (you can download and try) - it is simple and solves the necessary problem (and I also develop it myself): <br><br>  From pleasant bonuses - for each closed puzzle you are shown some kind of very pleasant exhilarating screen like these: <br><br><div style="text-align:center;"><img width="660" src="https://habrastorage.org/webt/zh/bq/uu/zhbquu6edvigh1u2-izdq8rsqci.png"></div><br>  It's funny that it was exactly at the completion of the ‚ÄúVK Mobile Challenge‚Äù problem that the following screen seemed to me: <br><br><div style="text-align:center;"><img width="440" src="https://habrastorage.org/webt/qg/_q/mi/qg_qmisekhb47zchj8oyyjxuq6w.png"></div><br>  And yes!  So it happened :-) We turn to the results. <br><br>  Let's not pull peach for plush.  Peach, who did not know, is the name of the cat - the main character of VK.  Very cool gift merch: <br><br><div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/6h/ax/gm/6haxgma94hpifqzcp-6mxvs3eze.jpeg"></div><br>  I took 4th place and received 175k rubles.  (Yes, and you, for sure, already burned the picture on the Habra-Kat).  And yes, I am of course pleased.  I reached my goal :-) And this is undoubtedly incredibly pleasant. <br><br>  Finally, I would like to say thanks to <a href="https://habr.com/company/vkontakte/">vkontakte</a> - after all, the competition was cool and well organized.  And I recommend all readers to take part in challenges and hackathons - this is a great way to challenge yourself and compete with top developers around the world (or at least the Russian-speaking community). </div><p>Source: <a href="https://habr.com/ru/post/432356/">https://habr.com/ru/post/432356/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../432346/index.html">News from the world of OpenStreetMap ‚Ññ436 (20.11.2018-26.11.2018)</a></li>
<li><a href="../432348/index.html">Master class: vacuum casting of plastics in silicone</a></li>
<li><a href="../432350/index.html">Why do React elements have $$ typeof property?</a></li>
<li><a href="../432352/index.html">SIEM depths: out-of-box correlations. Part 3.1. Event categorization</a></li>
<li><a href="../432354/index.html">The most significant data breaches in 2018. Part One (January-June)</a></li>
<li><a href="../432360/index.html">"Descendant" AlphaGo independently learned to play chess, shogi and go</a></li>
<li><a href="../432362/index.html">Chang'e-4 - the mission to the far side of the moon starts today</a></li>
<li><a href="../432364/index.html">Phonetic alphabet: how the decision for aviation will help to transfer login by phone</a></li>
<li><a href="../432366/index.html">SSD caching implementation in QSAN XCubeSAN storage</a></li>
<li><a href="../432368/index.html">Before you - React Modern Web App</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>