<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automated faxing service using Asterisk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We have a web service that needs to send a lot of faxes. 
 You can use third-party services that specialize in this. 
 But if there are a lot of faxes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automated faxing service using Asterisk</h1><div class="post__text post__text-html js-mediator-article">  We have a web service that needs to send a lot of faxes. <br>  You can use third-party services that specialize in this. <br>  But if there are a lot of faxes, then this translates into such a pretty penny.  Therefore, we will create our service. <br>  Using our service, we will pay on time for voice traffic. <br>  The service will receive a request to send a fax and report to us about the results. <br><br>  We will use Asterisk, maybe it is not the most productive, but well known. <br>  In our configuration, we will use the ready-made Elastix assembly, since  it works more stable if you believe <a href="https://habrahabr.ru/users/klistrod/" class="user_link">Klistrod</a> ( <a href="http://habrahabr.ru/post/145620/">Battle Titans FreeSwitch vs. Asterisk - Performance Test</a> ). <br>  The advantage is the presence of Apache and php.  It is not necessary to deliver packages. <br><br><a name="habracut"></a>  Asterisk has several ways to send faxes: voice over G.711 and using T.38. <br>  The second option is preferable, because  the probability of delivery is higher. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are also 2 implementations of sending faxes: <br>  1. <a href="http://www.soft-switch.org/">Spandsp</a> OpenSource project <br>  2. <a href="http://www.digium.com/en/products/software/fax-for-asterisk">Digium Fax for Asterisk</a> <br>  Commercial implementation from the authors of the asterisk, 1 competitive license is free. <br>  Installation details ( <a href="http://docs.digium.com/FAX/fax_for_asterisk_admin_manual.pdf">docs.digium.com/FAX/fax_for_asterisk_admin_manual.pdf</a> ) <br>  Spandsp is already included in the Elastix distribution. <br><br>  Logically, the system can be divided into 3 parts. <br>  1. Receive requests <br>  2. Rotation of faxes <br>  3. Sending a fax and a report on the results. <br><br><h5>  Receive shipment requests. </h5><br>  Fax sending will be initiated by moving the .call file to the asterisk execution folder. <br>  In the call file are all the necessary parameters for Asterisk to send. <br><br>  faxsend.call <br><pre><code class="bash hljs">Callerid:<span class="hljs-string"><span class="hljs-string">"FaxSender"</span></span>&lt;1111&gt; Maxretries:maxRetries Waittime:300 Context:faxsend-t38 Extension:faxout RetryTime:50 Priority:1 SetVar: T38CALL=1 Set:RETURNURL={returnUrl} Set:TAGLINE=Fax from CompanyName Set:RECEIVER=Number Of Receiver Set:FAX_ID={faxId} Set:TIFF_2_SEND={faxId}.tif<span class="hljs-string"><span class="hljs-string">';</span></span></code> </pre> <br><br>  Create a script that will take the parameters and file to send.  The file for sending will be received in PDF. <br>  Parameters to which I think you should pay attention <br>  maxRetries - the number of dialing attempts. <br>  faxid - fax ID for which the status will be returned. <br>  returnUrl - the address to which the result of the send will be returned. <br><br>  index.php <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> define( <span class="hljs-string"><span class="hljs-string">"STATUS_SUCCESS"</span></span>, <span class="hljs-string"><span class="hljs-string">"success"</span></span> ); define( <span class="hljs-string"><span class="hljs-string">"STATUS_ERROR"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span> ); $pdfLocation = <span class="hljs-string"><span class="hljs-string">"//var//tmp//faxes//"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendStatus</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $statusKind )</span></span></span><span class="hljs-function"> </span></span>{ header(<span class="hljs-string"><span class="hljs-string">'Content-type: application/json'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>( <span class="hljs-string"><span class="hljs-string">"{\"status\": \""</span></span> . $statusKind . <span class="hljs-string"><span class="hljs-string">"\"}"</span></span> ); } $fax = $_REQUEST[<span class="hljs-string"><span class="hljs-string">'fax'</span></span>]; $faxId = $_REQUEST[<span class="hljs-string"><span class="hljs-string">'faxId'</span></span>]; $maxRetries = <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>( $_REQUEST[<span class="hljs-string"><span class="hljs-string">'maxRetries'</span></span>] ) ? $_REQUEST[<span class="hljs-string"><span class="hljs-string">'maxRetries'</span></span>] : <span class="hljs-number"><span class="hljs-number">0</span></span>; $returnUrl = $_REQUEST[<span class="hljs-string"><span class="hljs-string">'returnUrl'</span></span>]; $pdf = $faxId . <span class="hljs-string"><span class="hljs-string">'.pdf'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($fax == <span class="hljs-string"><span class="hljs-string">''</span></span> || $returnUrl == <span class="hljs-string"><span class="hljs-string">''</span></span> || $faxId == <span class="hljs-string"><span class="hljs-string">''</span></span> ) { sendStatus( STATUS_ERROR ); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!move_uploaded_file($_FILES[<span class="hljs-string"><span class="hljs-string">'file'</span></span>][<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>], $pdfLocation . $pdf)) { sendStatus( STATUS_ERROR ); } $callFileBody = <span class="hljs-string"><span class="hljs-string">'Channel:SIP/trunkname/{fax} Callerid:"FaxSender"&lt;1111&gt; Maxretries:{maxRetries} Waittime:300 Context:faxsend-t38 Extension:faxout RetryTime:50 Priority:1 SetVar: T38CALL=1 Set:RETURNURL={returnUrl} Set:TAGLINE=Fax from Company Set:RECEIVER={fax} Set:FAX_ID={faxId} Set:TIFF_2_SEND={faxId}.tif'</span></span>; $callFileBody = str_replace(<span class="hljs-string"><span class="hljs-string">"{fax}"</span></span>, $fax, $callFileBody); $callFileBody = str_replace(<span class="hljs-string"><span class="hljs-string">"{faxId}"</span></span>, $faxId, $callFileBody); $callFileBody = str_replace(<span class="hljs-string"><span class="hljs-string">"{maxRetries}"</span></span>, $maxRetries, $callFileBody); $callFileBody = str_replace(<span class="hljs-string"><span class="hljs-string">"{returnUrl}"</span></span>, $returnUrl, $callFileBody); $callFilename = $faxId . <span class="hljs-string"><span class="hljs-string">".call"</span></span>; file_put_contents($pdfLocation . $callFilename, $callFileBody); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!file_exists($pdfLocation . $callFilename)) { sendStatus( STATUS_ERROR ); } sendStatus( STATUS_SUCCESS ); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br>  Thus, 2 files appear in the specified pdfLocation folder: .call and .pdf. <br>  This script can be placed in any of the subfolders in / var / www / html <br>  I created the faxservice folder. <br>  Thus, our service is available at <a href="http://serveradress/faxservice">http: // serveradress / faxservice</a> <br>  By default, Elastix redirects all http requests to https.  In order not to bother with the certificates, I disabled this redirect: <br><br>  /etc/httpd/conf.d/elastix.conf <br><pre> <code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment"># Apache-level configuration for Elastix administration interface Timeout 300 # Default apache configuration specifies greater limits than these #MaxClients 150 #MaxRequestsPerChild 1000 # Default apache User and Group diretives MUST be commented out # in order for these to take effect. User asterisk Group asterisk &lt;Directory "/var/www/html"&gt; # Redirect administration interface to https #RewriteEngine off #RewriteCond %{HTTPS} off #RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} &lt;/Directory&gt;</span></span></code> </pre><br><br>  Just commented rewright. <br><br><h5>  Fax rotation </h5><br>  We need to monitor this folder for the appearance of new tasks, and after the appearance of tasks, transfer to the queue to be sent to Asterisk.  It is also necessary to convert our pdf to tif <br>  We implement this functionality using the bash script: <br><br>  faxrotate <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash SOURCEDIR="/var/tmp/faxes/" for file in `ls $SOURCEDIR*.pdf `; do callfile="${file/pdf/call}" if [ ! -e "$callfile" ] then continue fi `gs -q -dNOPAUSE -dBATCH -sDEVICE=tiffg4 -sPAPERSIZE=letter -sOutputFile=${file/pdf/tif} $file` mv ${file/pdf/call} /var/spool/asterisk/outgoing rm $file done</span></span></code> </pre><br>  We suspend the execution of this script every minute on behalf of Asterisk. <br><br>  We will delete the ‚Äúspent‚Äù tif files every night, we will store them for 2 days (in case the number of attempts is large, and the intervals between them are even larger.): <br><br><pre> <code class="bash hljs">/usr/bin/find /var/tmp/faxes -name <span class="hljs-string"><span class="hljs-string">"*tif"</span></span> -mtime +2 ‚Äìdelete</code> </pre><br><br><h5>  Asterisk faxing </h5><br><br>  It only remains to teach Asterisk to send faxes via T.38 and report the results to us. <br>  First you need to "teach" Elastix to work with T.38 <br><br>  To do this, add to sip_general_custom.conf: <br><pre> <code class="bash hljs">t38pt_udptl=yes</code> </pre><br><br>  Approximate view of trunk settings: <br><br><pre> <code class="bash hljs">[trunkname] username=username <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=friend transport=udp secret=password qualify=yes nat=yes insecure=port,invite host=voip.host.com disalow=all directmedia=yes context=from-pstn canreinvite=yes allow=ulaw&amp;alaw</code> </pre><br><br>  Next, you need to create a context that will be called from the call file. <br>  We add it to <br><br>  extensions_custom.conf <br><pre> <code class="bash hljs">[faxsend-t38] exten =&gt; faxout,1,Set(STARTTIME=<span class="hljs-variable"><span class="hljs-variable">${SHELL(date +%s)}</span></span> ) exten =&gt; faxout,n,Wait(1) exten =&gt; faxout,n,Playback(fax24,skip) exten =&gt; faxout,n,Wait(1) exten =&gt; faxout,n,NoOp(**** SENDING FAX ****) ; Set FAXOPTs exten =&gt; faxout,n,NoOp(**** SETTING FAXOPT ****) exten =&gt; faxout,n,Set(FAXFILE=<span class="hljs-variable"><span class="hljs-variable">${TIFF_2_SEND}</span></span>) exten =&gt; faxout,n,Set(FAXOPT(ecm)=yes) exten =&gt; faxout,n,Set(FAXOPT(headerinfo)=<span class="hljs-variable"><span class="hljs-variable">${TAGLINE}</span></span>) exten =&gt; faxout,n,Set(FAXOPT(maxrate)=14400) exten =&gt; faxout,n,Set(FAXOPT(minrate)=4800) ; Send the fax exten =&gt; faxout,n,NoOp(**** SENDING FAX : <span class="hljs-variable"><span class="hljs-variable">${FAXFILE}</span></span> ****) exten =&gt; faxout,n,SendFAX(/var/tmp/faxes/<span class="hljs-variable"><span class="hljs-variable">${FAXFILE}</span></span>,dfzs) ;Calculating Time of Sending exten =&gt; faxout,n,Set(ENDTIME=<span class="hljs-variable"><span class="hljs-variable">${SHELL(date +%s)}</span></span> ) exten =&gt; faxout,n,Set(TRANSFERTIME=<span class="hljs-variable"><span class="hljs-variable">${MATH(${ENDTIME}</span></span>-<span class="hljs-variable"><span class="hljs-variable">${STARTTIME}</span></span>,int)}) ;Actions after sending fax exten =&gt; faxout,n,Set(NORMURL=<span class="hljs-variable"><span class="hljs-variable">${FAXOPT(error)}</span></span>) exten =&gt; faxout,n,Set(STATUSMESSAGE=<span class="hljs-variable"><span class="hljs-variable">${REPLACE(NORMURL, ,+)}</span></span>) exten =&gt; faxout,n,Set(FAXOPTRATE=<span class="hljs-variable"><span class="hljs-variable">${FAXOPT(rate)}</span></span>) exten =&gt; faxout,n,Hangup ;Actions <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> no answer or busy exten =&gt; failed,1,Set(FAXSTATUS=FAILED) exten =&gt; failed,2,Set(STATUSMESSAGE=number+no+answer+or+busy) exten =&gt; failed,3,Set(FAXOPTRATE=none) exten =&gt; h,1,NoOP(------------------- FAX to <span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span> with <span class="hljs-variable"><span class="hljs-variable">${FAXSTATUS}</span></span> -----------------) exten =&gt; h,2,Set(CURLRESULT=<span class="hljs-variable"><span class="hljs-variable">${CURL(${RETURNURL}</span></span>?fax=<span class="hljs-variable"><span class="hljs-variable">${RECEIVER}</span></span>&amp;faxId=<span class="hljs-variable"><span class="hljs-variable">${FAX_ID}</span></span>&amp;status=<span class="hljs-variable"><span class="hljs-variable">${FAXSTATUS}</span></span>&amp;message=<span class="hljs-variable"><span class="hljs-variable">${STATUSMESSAGE}</span></span>)}) exten =&gt; h,4,Set(LOGFAXOUT=<span class="hljs-variable"><span class="hljs-variable">${SHELL(echo "${STRFTIME(${EPOCH}</span></span>,,%d%m%Y-%H:%M:%S)} : <span class="hljs-variable"><span class="hljs-variable">${FAX_ID}</span></span> : <span class="hljs-variable"><span class="hljs-variable">${RECEIVER}</span></span> : <span class="hljs-variable"><span class="hljs-variable">${FAXSTATUS}</span></span> : <span class="hljs-variable"><span class="hljs-variable">${STATUSMESSAGE}</span></span> : <span class="hljs-variable"><span class="hljs-variable">${TRANSFERTIME}</span></span>s : <span class="hljs-variable"><span class="hljs-variable">${FAXOPTRATE}</span></span><span class="hljs-string"><span class="hljs-string">" &gt;&gt; /var/log/asterisk/faxout.log)}) exten =&gt; h,3,NoOp(</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${RECEIVER}</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${FAX_ID}</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${FAXSTATUS}</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${STATUSMESSAGE}</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${FAXOPTRATE}</span></span></span><span class="hljs-string">)</span></span></code> </pre><br><br>  This context tries to call and send a fax, when it is not dialing, it returns number + no + answer + or + busy. <br>  Upon successful dialing and attempting to send, it returns the status and decryption of the status message. <br>  He returns this information to the address RETURNURL from the php script. <br>  He also writes a log file for further debriefing on some controversial issues. <br>  For voice greeting to work, you need to record a file in PCM Encoded format, 16 Bits, at 8000Hz and place it in / var / lib / asterisk / sounds. </div><p>Source: <a href="https://habr.com/ru/post/183584/">https://habr.com/ru/post/183584/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../183568/index.html">Rebranding ebaytoday> shopotam</a></li>
<li><a href="../183574/index.html">Contest "The Best Reverser" on PHDays III: Developer‚Äôs View</a></li>
<li><a href="../183576/index.html">Linux and baremetal OS launch</a></li>
<li><a href="../183580/index.html">Lessons on electrical circuits - transmission lines, part 2</a></li>
<li><a href="../183582/index.html">CISCO do it yourself, or an overview of the Lanner FW-7540 network platform</a></li>
<li><a href="../183586/index.html">Cloud Technologies - Everyman: Singapore Social Tree</a></li>
<li><a href="../183588/index.html">b54 a week later</a></li>
<li><a href="../183590/index.html">[ANNOUNCEMENT] HLI-I9500XL battery at 5500mAh increases the operating time of the Samsung Galaxy S4 2 times</a></li>
<li><a href="../183598/index.html">Chinese supercomputer Tianhe-2 tops the world ranking Top500</a></li>
<li><a href="../183600/index.html">Martin Grasslin: Fanboys and Trolls in the ACT community</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>