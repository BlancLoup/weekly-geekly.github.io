<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Video coding for web projects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 
 Many web programmers need to work with video sooner or later. This problem arose in me. 
 There are many articles on the Internet on forum...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Video coding for web projects</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/e7b/b94/dc8/e7bb94dc8762e0a0a5c0e6d8b6695b00.png" alt="image"><br>  Good day. <br>  Many web programmers need to work with video sooner or later.  This problem arose in me. <br>  There are many articles on the Internet on forums and blogs, both on Russian and foreign sites.  But, having done the same as it was proposed in the instructions, the result did not give the expected result.  That was the reason for this article.  I think she will help <s>the same as I do</s> many beginners. <br><a name="habracut"></a><br><h4>  Let's get started </h4><br>  Everything was done under the root on a machine with Ubuntu 11.04 (Natty Narwhal). <br><pre><code class="bash hljs">root@r2d2:~<span class="hljs-comment"><span class="hljs-comment"># uname -a Linux r2d2 2.6.35-30-generic #57-Ubuntu SMP Tue Aug 9 18:00:33 UTC 2011 i686 GNU/Linux</span></span></code> </pre> <br><h4>  First, remove the old one installed if it is present. </h4><pre> <code class="bash hljs">root@r2d2:~<span class="hljs-comment"><span class="hljs-comment"># apt-get remove ffmpeg x264 libx264-dev</span></span></code> </pre> <br><h4>  Update the list of packages </h4><pre> <code class="bash hljs">root@r2d2:~<span class="hljs-comment"><span class="hljs-comment"># apt-get update &amp;&amp; apt-get upgrade</span></span></code> </pre> <br><h4>  Install the right </h4><pre> <code class="bash hljs">root@r2d2:~<span class="hljs-comment"><span class="hljs-comment"># apt-get install build-essential checkinstall git git-core libfaac-dev libfaad-dev libjack-jackd2-dev libmp3lame-dev libopencore-amrnb-dev libopencore-amrwb-dev libsdl1.2-dev libtheora-dev libva-dev libvdpau-dev libvorbis-dev libx11-dev libxfixes-dev libxvidcore-dev subversion texi2html yasm zlib1g-dev libavcodec52 mencoder</span></span></code> </pre> <br><h4>  Install the library to encode H.264 video streams </h4>  You can read more <a href="http://ru.wikipedia.org/wiki/X264">here</a> and <a href="http://www.videolan.org/developers/x264.html">here</a> . <br><pre> <code class="bash hljs">root@r2d2:~<span class="hljs-comment"><span class="hljs-comment"># git clone git://git.videolan.org/x264.git root@r2d2:~# cd x264 root@r2d2:~/x264# ./configure --enable-shared</span></span></code> </pre> <br>  Here you need to make a retreat.  When configuring x264 WITHOUT the <code>--enable-shared</code> parameter, the library will be installed in the default directory (I have it / usr / local / bin) and when I run ffmpeg, it will give an error about the unknown location of the libx264 library: <br>  ERROR: libx264 not found <br><br>  With the <code>--enable-shared</code> parameter, the result after the checkinstall command is as follows: <br><pre> <code class="bash hljs">install -d /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin install x264 /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin install -d /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/include install -d /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib install -d /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib/pkgconfig install -m 644 x264.h /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/include install -m 644 x264_config.h /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/include install -m 644 x264.pc /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib/pkgconfig ln -f -s libx264.so.116 /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib/libx264.so install -m 755 libx264.so.116 /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib</code> </pre> <br>  When installing on Debian there were also problems with the libx264 library. <br>  The parameter <code>--prefix=/shared</code> helped when configuring x264. <br><pre> <code class="bash hljs">root@r2d2:~/x264<span class="hljs-comment"><span class="hljs-comment"># make root@r2d2:~/x264# checkinstall -fstrans=no -install=yes -pkgname=x264 -pkgversion ¬´1:0.svn`date +%Y%m%d`¬´ -default</span></span></code> </pre> <br><h4>  Install ffmpeg </h4>  You can read more <a href="http://ru.wikipedia.org/wiki/FFmpeg">here</a> and <a href="http://ffmpeg.org/">here</a> . <br><pre> <code class="bash hljs">root@r2d2:~<span class="hljs-comment"><span class="hljs-comment"># svn checkout svn://svn.ffmpeg.org/ffmpeg/trunk ffmpeg root@r2d2:~# cd ffmpeg root@r2d2:~# ./configure --enable-gpl --enable-version3 --enable-nonfree --enable-postproc --enable-libfaac --enable-libmp3lame --enable-libopencore-amrnb --enable-libopencore-amrwb --enable-libtheora --enable-libvorbis --enable-libx264 --enable-libxvid --enable-x11grab root@r2d2:~# make root@r2d2:~# checkinstall -fstrans=no -install=yes -pkgname=ffmpeg -pkgversion ¬´4:0.5+svn`date +%Y%m%d`¬´ -default</span></span></code> </pre> <br>  As a result, we have: <br><pre> <code class="bash hljs">root@r2d2:~<span class="hljs-comment"><span class="hljs-comment"># x264 --version x264 0.116.2074 2641b9e built on Sep 6 2011, gcc: 4.4.5 configuration: --bit-depth=8 x264 license: GPL version 2 or later</span></span></code> </pre> <br><pre> <code class="bash hljs">root@r2d2:~<span class="hljs-comment"><span class="hljs-comment"># ffmpeg -version FFmpeg version SVN-r26402, Copyright (c) 2000-2011 the FFmpeg developers built on Sep 6 2011 09:26:49 with gcc 4.4.5 configuration: --enable-gpl --enable-version3 --enable-nonfree --enable-postproc --enable-libfaac --enable-libmp3lame --enable-libopencore-amrnb --enable-libopencore-amrwb --enable-libtheora --enable-libvorbis --enable-libx264 --enable-libxvid --enable-x11grab libavutil 50.36. 0 / 50.36. 0 libavcore 0.16. 1 / 0.16. 1 libavcodec 52.108. 0 / 52.108. 0 libavformat 52.93. 0 / 52.93. 0 libavdevice 52. 2. 3 / 52. 2. 3 libavfilter 1.74. 0 / 1.74. 0 libswscale 0.12. 0 / 0.12. 0 libpostproc 51. 2. 0 / 51. 2. 0 FFmpeg SVN-r26402 libavutil 50.36. 0 / 50.36. 0 libavcore 0.16. 1 / 0.16. 1 libavcodec 52.108. 0 / 52.108. 0 libavformat 52.93. 0 / 52.93. 0 libavdevice 52. 2. 3 / 52. 2. 3 libavfilter 1.74. 0 / 1.74. 0 libswscale 0.12. 0 / 0.12. 0 libpostproc 51. 2. 0 / 51. 2. 0</span></span></code> </pre> <br>  Now if you type in console <br><pre> <code class="bash hljs">ffmpeg -threads 4 -y -i <span class="hljs-string"><span class="hljs-string">"video.avi"</span></span> -vcodec libx264 -vpre <span class="hljs-string"><span class="hljs-string">"hq"</span></span> -b 2000k -acodec libfaac -ar 44100 -ab 128k -ac 2 <span class="hljs-string"><span class="hljs-string">"video.flv"</span></span></code> </pre>  the output is a converted file that can be used for your own purposes. <br><br><h4>  A little bit about the conversion options </h4>  -i - the name of the source file; <br>  -ar - audio sampling frequency (must be a multiple of 11kHz); <br>  -ab - audio bit rate; <br>  -ac - the number of sound channels (1 - mono, 2 - stereo); <br>  -f - outgoing video file format; <br>  -b - video bitrate (30k, 200k, 512k, 1024k); <br>  -maxrate - maximum video encoding bit rate (9000k); <br>  -r - frames per second (FPS); <br>  -s - video size in pixels; <br>  -fs - set the maximum size of the output file; <br>  -vpre - file with preset conversion parameters (preset); <br>  -ss 00:02:00 - offset from the beginning of the file (position).  Here: skip the first 2 minutes (shift in seconds).  Set in seconds  or time in the format: hh: mm: ss [.xxx]; <br>  -vframes - limit on the number of video frames; <br>  -y - overwrite the file if it already exists; <br>  -aspect - aspect ratio (4: 3, 16: 9, 1.3333); <br>  -acodec - audio codec (libfaac, aac, libmp3lame); <br>  -vcodec - video codec (libx264); <br>  -threads 0 is the number of cores in the computer.  Values: 0 - 4. 0 - automatically determine the number of processor cores and use them in the process. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ffmpeg has files with predefined settings for encoding.  They are in the ffmpeg / ffpresets folder <br><pre> <code class="bash hljs">root@r2d2:~/ffmpeg/ffpresets<span class="hljs-comment"><span class="hljs-comment"># ls -al libx264-baseline.ffpreset libx264-faster.ffpreset libx264-faster_firstpass.ffpreset libx264-fast.ffpreset libx264-fast_firstpass.ffpreset libx264-ipod320.ffpreset libx264-ipod640.ffpreset libx264-lossless_fast.ffpreset libx264-lossless_max.ffpreset libx264-lossless_medium.ffpreset libx264-lossless_slower.ffpreset libx264-lossless_slow.ffpreset libx264-lossless_ultrafast.ffpreset libx264-main.ffpreset libx264-medium.ffpreset libx264-medium_firstpass.ffpreset libx264-placebo.ffpreset libx264-placebo_firstpass.ffpreset libx264-slower.ffpreset libx264-slower_firstpass.ffpreset libx264-slow.ffpreset libx264-slow_firstpass.ffpreset libx264-superfast.ffpreset libx264-superfast_firstpass.ffpreset libx264-ultrafast.ffpreset libx264-ultrafast_firstpass.ffpreset libx264-veryfast.ffpreset libx264-veryfast_firstpass.ffpreset libx264-veryslow.ffpreset libx264-veryslow_firstpass.ffpreset</span></span></code> </pre> <br>  And after installation should be in / usr / local / share / ffmpeg /.  By the name of the file, you can guess what the specific file is responsible for.  More information about these files can be found at the above links. <br><br>  The settings file that is used in the examples. <br><pre> <code class="bash hljs">root@r2d2:/usr/share/ffmpeg<span class="hljs-comment"><span class="hljs-comment"># cat libx264-hq.ffpreset coder=1 flags=+loop cmp=+chroma partitions=+parti8x8+parti4x4+partp8x8+partb8x8 me_method=umh subq=8 me_range=16 g=250 keyint_min=25 sc_threshold=40 i_qfactor=0.71 b_strategy=2 qcomp=0.6 qmin=10 qmax=51 qdiff=4 bf=3 refs=4 directpred=3 trellis=1 flags2=+wpred+mixed_refs+dct8x8+fastpskip</span></span></code> </pre> <br><h4>  Rollback of all installed </h4><pre> <code class="bash hljs">root@r2d2:~<span class="hljs-comment"><span class="hljs-comment"># apt-get remove build-essential checkinstall git git-core libfaac-dev libfaad-dev libjack-jackd2-dev libmp3lame-dev libopencore-amrnb-dev libopencore-amrwb-dev libsdl1.2-dev libtheora-dev libva-dev libvdpau-dev libvorbis-dev libx11-dev libxfixes-dev libxvidcore-dev subversion texi2html yasm zlib1g-dev libavcodec52 mencoder x264 ffmpeg</span></span></code> </pre> <br><h4>  Retrieving video information with PHP </h4>  For information about the video, I use a slightly reworked function that I found in <a href="http://habrahabr.ru/blogs/personal/50225/">this</a> post. <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_video_size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($videofile)</span></span></span><span class="hljs-function"> </span></span>{ define(<span class="hljs-string"><span class="hljs-string">'MAX_VIDEO_WIDTH'</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>); $vwidth = <span class="hljs-number"><span class="hljs-number">0</span></span>; $vheight = <span class="hljs-number"><span class="hljs-number">0</span></span>; $owidth = <span class="hljs-number"><span class="hljs-number">0</span></span>; $oheight = <span class="hljs-number"><span class="hljs-number">0</span></span>; $duration = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $bitrate = <span class="hljs-number"><span class="hljs-number">0</span></span>; $audio_bitrate = <span class="hljs-number"><span class="hljs-number">0</span></span>; $sfrequency = <span class="hljs-number"><span class="hljs-number">0</span></span>; ob_start(); passthru(<span class="hljs-string"><span class="hljs-string">'ffmpeg -i "'</span></span> . $videofile . <span class="hljs-string"><span class="hljs-string">'" 2&gt;&amp;1 | egrep -e "(Duration|Stream)"'</span></span>); $ffmpeg_output = ob_get_contents(); ob_end_clean(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sizeof($ffmpeg_output) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (explode(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, $ffmpeg_output) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $line) { $ma = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">// get duration and video bitrate if (strpos($line, 'Duration:') !== false) { preg_match('/(?&lt;hours&gt;\d+):(?&lt;minutes&gt;\d+):(?&lt;seconds&gt;\d+)\.(?&lt;fractions&gt;\d+)/', $line, $ma); $duration = array( 'raw' =&gt; $ma['hours'] . ':' . $ma['minutes'] . ':' . $ma['seconds'], 'hours' =&gt; intval($ma['hours']), 'minutes' =&gt; intval($ma['minutes']), 'seconds' =&gt; intval($ma['seconds']), 'fractions' =&gt; intval($ma['fractions']), 'rawSeconds' =&gt; intval($ma['hours']) * 60 * 60 + intval($ma['minutes']) * 60 + intval($ma['seconds']) + (intval($ma['fractions']) != 0 ? 1 : 0) ); preg_match('/bitrate:\s(?&lt;bitrate&gt;\d+)\skb\/s/', $line, $ma); $bitrate = $ma['bitrate']; } // get video info if (strpos($line, 'Video:') !== false) { preg_match('/Stream #(?:[0-9\.]+)(?:.*)\: Video: (?P&lt;videocodec&gt;.*) (?P&lt;width&gt;[0-9]*)x(?P&lt;height&gt;[0-9]*)/', $line, $ma); $vheight = $oheight = $ma['width']; $vwidth = $owidth = $ma['height']; } // get audio info if (strpos($line, 'Audio:') !== false) { preg_match('/,\s(?&lt;sfrequency&gt;\d+)\sHz,/', $line, $ma); $sfrequency = $ma['sfrequency']; preg_match('/,\s(?&lt;bitrate&gt;\d+)\skb\/s/', $line, $ma); $audio_bitrate = $ma['bitrate']; } } // calculate new size of the video if ($vwidth &gt; MAX_VIDEO_WIDTH) { $coef = $vheight / $vwidth; $vwidth = MAX_VIDEO_WIDTH; $vheight = round($vwidth * $coef); } // frame size must be a multiple of 2 $vwidth = $vwidth % 2 != 0 ? $vwidth - 1 : $vwidth; $vheight = $vheight % 2 != 0 ? $vheight - 1 : $vheight; return array( 'width' =&gt; $vwidth, 'height' =&gt; $vheight, 'srcWidth' =&gt; $owidth, 'srcHeight' =&gt; $oheight, 'duration' =&gt; $duration, 'bitrate' =&gt; $bitrate, 'audioBitrate' =&gt; $audio_bitrate, 'audioSampleFrequency' =&gt; $sfrequency ); }</span></span></code> </pre> <br><h4>  As a result, we have a finished example. </h4><pre> <code class="php hljs">$ffmpeg_path = <span class="hljs-string"><span class="hljs-string">'ffmpeg'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   ffmpeg $in = 'ATB - Let You Go.avi'; //   $out = 'ATB - Let You Go.flv'; //   $video = get_video_size($in); $hq = 'hq'; //      $command = $ffmpeg_path . ' -threads 0 -y -i "' . $in . '" -vcodec libx264 -vpre "' . $hq . '" -b ' . $video['bitrate'] . 'k -s ' . $video['width'] . 'x' . $video['height'] . ' -acodec libfaac -ar ' . $video['audioSampleFrequency'] . ' -ab ' . $video['audioBitrate'] . 'k -ac 2 "' . $out . '"'; $conv = exec($command);</span></span></code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/127910/">https://habr.com/ru/post/127910/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../127904/index.html">Modder combined the PS3 and Xbox 360 in a single package</a></li>
<li><a href="../127906/index.html">How I switched from Smarty to Twig</a></li>
<li><a href="../127907/index.html">The discovery of the "Ideal System" by the esoteric method of knowledge</a></li>
<li><a href="../127908/index.html">Principles of writing applications on ExtJS 2.x / 3.x</a></li>
<li><a href="../127909/index.html">Using OpenFeint in Unity3d</a></li>
<li><a href="../127911/index.html">Diablo 3 Beta is available!</a></li>
<li><a href="../127912/index.html">Evernote for Android has been integrated with Skitch, offline search and more.</a></li>
<li><a href="../127913/index.html">Applications for receiving digital broadcasting by means of DirectShow</a></li>
<li><a href="../127916/index.html">We write the payment method for Magento on the example of Robokassa</a></li>
<li><a href="../127917/index.html">Call for applications for the competition continues</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>