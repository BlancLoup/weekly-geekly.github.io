<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Boot CD and retro play in one tweet</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few years ago, I created a boot floppy and a retro game that fit into one tweet. Since then, Twitter has doubled the length of tweets, so I decided ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Boot CD and retro play in one tweet</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/656/ee4/2fe/656ee42fe767daa9c4720b24cfc43021.png"><br>  A few years ago, I created a <a href="https://www.quaxio.com/bootloader_retro_game_tweet/">boot floppy and a retro game</a> that fit into one tweet.  Since then, Twitter has doubled the length of tweets, so I decided to create a bootable CD.  It runs on a slightly improved version of tron. <br><br><pre><code class="hljs scala">perl -<span class="hljs-type"><span class="hljs-type">E</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'say</span></span><span class="hljs-string"><span class="hljs-string">"A"</span></span>x46422,<span class="hljs-string"><span class="hljs-string">"BDRDAwMQFFTCBUT1JJVE8gU1BFQ0lGSUNBVElPTg"</span></span>,<span class="hljs-string"><span class="hljs-string">"A"</span></span>x54,<span class="hljs-string"><span class="hljs-string">"Ew"</span></span>,<span class="hljs-string"><span class="hljs-string">"A"</span></span>x2634,<span class="hljs-string"><span class="hljs-string">"/0NEMDAxAQ"</span></span>,<span class="hljs-string"><span class="hljs-string">"A"</span></span>x2721,<span class="hljs-string"><span class="hljs-string">"BAAAAYQ"</span></span>,<span class="hljs-string"><span class="hljs-string">"A"</span></span>x30,<span class="hljs-string"><span class="hljs-string">"SVVVqogAAAAAAAEAF"</span></span>,<span class="hljs-string"><span class="hljs-string">"A"</span></span>x2676,<span class="hljs-string"><span class="hljs-string">"LMBaACgB76gfbgTAM0Qv8D4uYAI86qqgcc+AXP45GA8SHIRPFB3DTeYSEhyBSwCa8CwicMB3rSG/sHNFbRFJjAke9rrwQ"</span></span>,<span class="hljs-string"><span class="hljs-string">"A"</span></span>x2638'|base64 -<span class="hljs-type"><span class="hljs-type">D</span></span>&gt;cd.iso</code> </pre> <br>  The code in the tweet creates a bootable CD-ROM image: <code>cd.iso</code> .  You can load the code into qemu or your favorite virtual machine - and play with the arrow keys.  You can even burn an iso to a CD-R and boot onto a real computer. <br><a name="habracut"></a><br>  To manually create a CD image, you first need to get a basic understanding of <a href="https://en.wikipedia.org/wiki/ISO_9660">ISO 9660</a> .  Unfortunately, ISO documents are usually expensive.  However, ISO 9660 is the same as <a href="https://www.quaxio.com/files/2018/bootable_cd_retro_game_tweet/ecma-119.pdf">ECMA 119</a> , so the specifications can be read for free. <br><br>  ISO 9660 has many extensions such as UDF, El Torito, RockRidge, Joliet, etc. For boot images, only <a href="https://www.quaxio.com/files/2018/bootable_cd_retro_game_tweet/el_torito.pdf">El Torito</a> is important to us.  The El Torito specification, in my opinion, is poorly written.  There are errors (for example, the last line in table 7), it is easy to forget that the values ‚Äã‚Äãare hexadecimal ( <code>0x</code> prefixes are not specified), the numbers are not sorted intuitively, etc.  Fortunately, the document is quite small. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To create a boot disk, we start by writing down 17 empty sectors, followed by a Volume Descriptor Set.  Each sector is 2048 bytes. <br><br>  Note.  The ISO-9660 specification says that the Volume Descriptor Set begins with sector 16. El Torito specification requires the start of the boot record in sector 17. Technically, you should put a dummy volume descriptor in sector 16, but everything works fine without it. <br><br>  We write the first volume descriptor: <br><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">0x00</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span> = boot <span class="hljs-type"><span class="hljs-type">record</span></span>) <span class="hljs-string"><span class="hljs-string">'CD001'</span></span> // Identifier <span class="hljs-number"><span class="hljs-number">0x01</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">Version</span></span> <span class="hljs-string"><span class="hljs-string">'EL TORITO SPECIFICATION'</span></span> // Boot <span class="hljs-keyword"><span class="hljs-keyword">System</span></span> Identifier <span class="hljs-number"><span class="hljs-number">9</span></span> x <span class="hljs-number"><span class="hljs-number">0x00</span></span> // Padding <span class="hljs-number"><span class="hljs-number">32</span></span> x <span class="hljs-number"><span class="hljs-number">0x00</span></span> // Unused <span class="hljs-number"><span class="hljs-number">0x13</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span> // Boot Catalog address (<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> absolute sectors) <span class="hljs-number"><span class="hljs-number">1973</span></span> x <span class="hljs-number"><span class="hljs-number">0x00</span></span> // Unused</code> </pre> <br>  The following sector hosts the Volume Descriptor Set Terminator: <br><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">0xff</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> (<span class="hljs-number"><span class="hljs-number">255</span></span> = terminator) <span class="hljs-string"><span class="hljs-string">'CD001'</span></span> // Identifier <span class="hljs-number"><span class="hljs-number">0x01</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">Version</span></span> <span class="hljs-number"><span class="hljs-number">2041</span></span> x <span class="hljs-number"><span class="hljs-number">0x00</span></span> // Unused</code> </pre> <br>  The volume descriptors are followed by the Boot Catalog.  El Torito supports different emulation modes.  A CD-ROM can emulate a boot diskette, boot HDD, etc.  I did not install the emulation, that is, the BIOS will load a certain number of sectors - and our bootloader will take it. <br><br>  The checksum is calculated so that all 16-bit values ‚Äã‚Äãin the record are summed to 0 (mod 65536). <br><br>  The first entry in the boot directory (check entry): <br><br><pre> <code class="hljs ruby"><span class="hljs-number"><span class="hljs-number">0x01</span></span> /<span class="hljs-regexp"><span class="hljs-regexp">/ Header ID 0x00 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Platform ID (0 = Intel x86) 0x00 0x00 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Reserved 'a' /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ID string 23 x 0x00 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Padding cksum cksum /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Checksum (2 bytes) 0x55 0xaa /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Key bytes</span></span></code> </pre> <br>  The second entry (default): <br><br><pre> <code class="hljs sql">0x88 // Boot Indicator (0x88 = bootable) 0x00 // Boot Media Type (0 = no emulation) 0x00 0x00 // <span class="hljs-keyword"><span class="hljs-keyword">Load</span></span> <span class="hljs-keyword"><span class="hljs-keyword">segment</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">System</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">Unused</span></span> <span class="hljs-number"><span class="hljs-number">0x01</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span> // <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> sectors <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> <span class="hljs-number"><span class="hljs-number">0x14</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">Virtual</span></span> disk address (<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">absolute</span></span> sectors) <span class="hljs-number"><span class="hljs-number">20</span></span> x <span class="hljs-number"><span class="hljs-number">0x00</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">Unused</span></span></code> </pre> <br>  Then zeros to the end of the sector: <br><br><pre> <code class="hljs objectivec"><span class="hljs-number"><span class="hljs-number">1984</span></span> x <span class="hljs-number"><span class="hljs-number">0x00</span></span> <span class="hljs-comment"><span class="hljs-comment">// Unused</span></span></code> </pre> <br>  The next sector is our bootloader and retro game: <br><br><pre> <code class="hljs vhdl">; <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> compile: ; nasm bootloader.asm -o bootloader.img [bits <span class="hljs-number"><span class="hljs-number">16</span></span>] ; Pragma, tells the assembler that we ; are <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bit</span></span> mode (which <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> the state ; <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> x86 <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> booting from a floppy). [org <span class="hljs-number"><span class="hljs-number">0</span></span>x7C00] ; Pragma, tell the assembler where the ; code will be loaded. mov bl, <span class="hljs-number"><span class="hljs-number">1</span></span> ; Starting direction <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the worm. push <span class="hljs-number"><span class="hljs-number">0</span></span>xa000 ; Load address <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> VRAM into es. pop es restart_game: mov si, <span class="hljs-number"><span class="hljs-number">320</span></span>*<span class="hljs-number"><span class="hljs-number">100</span></span>+<span class="hljs-number"><span class="hljs-number">160</span></span> ; worm<span class="hljs-symbol"><span class="hljs-symbol">'s</span></span> starting position, center <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> ; screen ; Set video mode. Mode <span class="hljs-number"><span class="hljs-number">13</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> VGA (<span class="hljs-number"><span class="hljs-number">1</span></span> byte per pixel <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the actual ; color stored <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> a palette), <span class="hljs-number"><span class="hljs-number">320</span></span>x200 total size. mov ax, <span class="hljs-number"><span class="hljs-number">0</span></span>x0013 int <span class="hljs-number"><span class="hljs-number">0</span></span>x10 ; Draw borders. We <span class="hljs-keyword"><span class="hljs-keyword">assume</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> palette will work <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> us. ; We also <span class="hljs-keyword"><span class="hljs-keyword">assume</span></span> that starting at the bottom <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> drawing <span class="hljs-number"><span class="hljs-number">2176</span></span> pixels ; wraps around <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ends up drawing the top + bottom borders. mov di, <span class="hljs-number"><span class="hljs-number">320</span></span>*<span class="hljs-number"><span class="hljs-number">199</span></span> mov cx, <span class="hljs-number"><span class="hljs-number">2176</span></span> rep draw_loop: stosb ; draw right border stosb ; draw left border add di, <span class="hljs-number"><span class="hljs-number">318</span></span> jnc draw_loop ; notice the jump <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the middle <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the ; rep stosb instruction. game_loop: ; We read the keyboard input from <span class="hljs-keyword"><span class="hljs-keyword">port</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x60. This also reads bytes from ; the mouse, so we need <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> only handle [up (<span class="hljs-number"><span class="hljs-number">0</span></span>x48), left (<span class="hljs-number"><span class="hljs-number">0</span></span>x4b), ; right (<span class="hljs-number"><span class="hljs-number">0</span></span>x4d), down (<span class="hljs-number"><span class="hljs-number">0</span></span>x50)] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">0</span></span>x60 cmp al, <span class="hljs-number"><span class="hljs-number">0</span></span>x48 jb kb_handle_end cmp al, <span class="hljs-number"><span class="hljs-number">0</span></span>x50 ja kb_handle_end ; At the <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> bx contains offset displacement (+<span class="hljs-number"><span class="hljs-number">1</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>, +<span class="hljs-number"><span class="hljs-number">320</span></span>, -<span class="hljs-number"><span class="hljs-number">320</span></span>) ; based <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> pressed/released keypad key. I bet there are a few bytes ; <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> shave around here given the bounds check above. aaa cbw dec ax dec ax jc kb_handle sub al, <span class="hljs-number"><span class="hljs-number">2</span></span> imul ax, ax, byte -<span class="hljs-number"><span class="hljs-number">0</span></span>x50 kb_handle: mov bx, ax kb_handle_end: add si, bx ; The original code used set pallete command (<span class="hljs-number"><span class="hljs-number">10</span></span>h/<span class="hljs-number"><span class="hljs-number">0</span></span>bh) <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wait</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ; the vertical retrace. Today<span class="hljs-symbol"><span class="hljs-symbol">'s</span></span> computers are however too fast, so ; we <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> int <span class="hljs-number"><span class="hljs-number">15</span></span>h <span class="hljs-number"><span class="hljs-number">86</span></span>h instead. This also shaves a few bytes. ; <span class="hljs-literal"><span class="hljs-literal">Note</span></span>: you<span class="hljs-symbol"><span class="hljs-symbol">'ll</span></span> have <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> tweak cx+dx <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you are running this <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> a virtual ; machine vs real hardware. Casual testing seems <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> show that virtual machines ; <span class="hljs-keyword"><span class="hljs-keyword">wait</span></span> ~<span class="hljs-number"><span class="hljs-number">3</span></span>-<span class="hljs-number"><span class="hljs-number">4</span></span>x longer than physical hardware. mov ah, <span class="hljs-number"><span class="hljs-number">0</span></span>x86 inc cl int <span class="hljs-number"><span class="hljs-number">0</span></span>x15 ; Draw worm <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> check <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> collision <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> parity ; (even parity=collision). <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> [es:si], ah ; Go back <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the main game <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>. jpo game_loop ; We hit a wall <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> the worm. Restart the game. jmp restart_game TIMES <span class="hljs-number"><span class="hljs-number">2048</span></span> - ($ - $$) db <span class="hljs-number"><span class="hljs-number">0</span></span> ; Fill the rest <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the sector <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Then I wrote a script to compile the bootloader, build the image and generate a tweet.  Finally, I burned the CD and checked that <a href="">everything works on real hardware</a> . </div><p>Source: <a href="https://habr.com/ru/post/419115/">https://habr.com/ru/post/419115/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../419103/index.html">Writing a simple Lisp translator - I</a></li>
<li><a href="../419105/index.html">Link to the broadcast Slurm (intense by Kubernetes)</a></li>
<li><a href="../419107/index.html">Overview of the Dell EMC Unity File Part and Configuration Examples</a></li>
<li><a href="../419109/index.html">"Clarify for bangs" in Android P. What to do with Android Cutout?</a></li>
<li><a href="../419111/index.html">Digest of grocery design, July 2018</a></li>
<li><a href="../419117/index.html">‚ÄúI find it difficult to understand the motivation of a data scientist who does not see beauty in mathematics‚Äù - Kirill Danilyuk, Data Scientist</a></li>
<li><a href="../419119/index.html">Montblanc Premium Premium Pen - The Most Expensive Smart Pen Today</a></li>
<li><a href="../419121/index.html">LEMP stack with PHP 7 on CentOS 7 + Let's Encrypt on Google Cloud for deploying the Symfony 4 application</a></li>
<li><a href="../419125/index.html">Return of the Soviet station. Analysis and documents</a></li>
<li><a href="../419127/index.html">Three reincarnations online store. How to drain money, time and why templates are good</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>