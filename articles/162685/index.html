<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How are arrays in PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article I talked about variables, now we will talk about arrays. 

 What are PHP-level arrays? 
 At the PHP level, an array is an ordered ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How are arrays in PHP</h1><div class="post__text post__text-html js-mediator-article">  In the last article I talked about variables, now we will talk about arrays. <br><br><h2>  What are PHP-level arrays? </h2><br>  At the PHP level, an array is an ordered list crossed with a map.  Roughly speaking, PHP mixes these two concepts, as a result, it turns out, on the one hand, a very flexible data structure, on the other hand, perhaps not the most optimal, more precisely, as Anthony Ferrara put it: <blockquote>  PHP arrays are a great one-size-fits-all data structure.  But like all one-size-fits-all &lt;anything&gt;, <a href="http://en.wikipedia.org/wiki/Jack_of_all_trades,_master_of_none">jack-of-all-trades usually means master of none.</a> <br><br>  <a href="http://www.mail-archive.com/internals%40lists.php.net/msg62370.html">Link to the letter</a> <br></blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/e19/e20/3ae/e19e203ae059c4ba1972443fc859ff8a.jpg"><br>  (the picture shows HashTable with Buckets, V. Vasnetsov) <br><a name="habracut"></a><br>  Let's start with the following: try to measure the memory and time eaten for each inserted value.  We do this using such scripts: <br><br><pre><code class="hljs bash">// time.php <span class="hljs-variable"><span class="hljs-variable">$ar</span></span> = array(); <span class="hljs-variable"><span class="hljs-variable">$t</span></span> = 0; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-variable"><span class="hljs-variable">$i</span></span> = 0; <span class="hljs-variable"><span class="hljs-variable">$i</span></span> &lt; 9000; ++<span class="hljs-variable"><span class="hljs-variable">$i</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$t</span></span> = microtime(1); <span class="hljs-variable"><span class="hljs-variable">$ar</span></span>[] = 1; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$i</span></span> . <span class="hljs-string"><span class="hljs-string">":"</span></span> . (int)((microtime(1) - <span class="hljs-variable"><span class="hljs-variable">$t</span></span>) * 100000000) . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } // memory.php <span class="hljs-variable"><span class="hljs-variable">$ar</span></span> = array(); <span class="hljs-variable"><span class="hljs-variable">$m</span></span> = 0; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-variable"><span class="hljs-variable">$i</span></span> = 0; <span class="hljs-variable"><span class="hljs-variable">$i</span></span> &lt; 9000; ++<span class="hljs-variable"><span class="hljs-variable">$i</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$m</span></span> = memory_get_usage(); <span class="hljs-variable"><span class="hljs-variable">$ar</span></span>[] = 1; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$i</span></span> . <span class="hljs-string"><span class="hljs-string">":"</span></span> . (memory_get_usage() - <span class="hljs-variable"><span class="hljs-variable">$m</span></span>) . <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; }</code> </pre> <br><br>  We run these <code>php time.php &gt; time</code> and <code>php memory.php &gt; memory</code> scripts, and draw graphs on them, because there is a lot of data and look at the numbers for a long time (data on time has been collected many times and aligned to avoid extra jumps on the graph). <br><br><img src="https://habrastorage.org/storage2/6c2/94e/bef/6c294ebef70f39bbd8f21a996e6916fd.png"><br>  (X-axis - the number of e-tov in the array) <br><br>  As you can see, both charts have jumps both in terms of consumed memory and used time, and these jumps occur at the same moments. <br>  The fact is that at the C level (and indeed at the system level), there are no arrays with non-fixed size.  Every time you create an array in C, you must specify its size so that the system knows how much memory it needs to allocate. <br>  Then how is this implemented in PHP and how to pull up those jumps on the chart? <br>  When you create an empty array, PHP creates it with a specific size.  If you fill an array and at some point reach and exceed this size, then a new array is created with twice the size, all elements are copied into it and the old array is destroyed.  In general, this is a standard approach. <br><br><h2>  And how is this implemented? </h2><br>  In fact, to implement arrays in PHP, we use quite a standard <a href="http://ru.wikipedia.org/wiki/Hash_table">Hash Table</a> data structure, the details of which we will discuss. <br><br>  Hash Table stores a pointer to the very first and last value (needed for ordering arrays), a pointer to the current value (used for iterating over an array, this is what <code>current()</code> returns), the number of elements represented in the array, an array pointers to Buckets (about them further), and one more thing. <br><br><h2>  What for <br>  us <br>  need buckets <br>  and where <br>  us <br>  put them down </h2><br>  In the Hash Table there are two main entities, the first is the Hash Table itself, and the second is the Bucket (hereinafter the bucket, so as not to get bored). <br><br>  The values ‚Äã‚Äãthemselves are stored in the buckets, that is, each value has its own bucket.  But in addition to this, the original key is stored in the bucket, pointers to the next and previous buckets (they are needed to organize the array, because in PHP the keys can be in any order you want), and, again, something else. <br><br>  Thus, when you add a new element to the array, if such a key is not there yet, then a new bucket is created under it and added to the Hash Table. <br><br>  But what is most interesting is how these buckets are stored in the Hash Table. <br><br>  As mentioned above, HT has a certain array of pointers to buckets, while the buckets are available in this array at a certain index, and this index can be calculated knowing the key of the bucket.  It sounds a little difficult, but in fact, everything is much simpler than it seems.  Let's try to make out how the item is received by key from HT: <br><br><ul><li>  If the key is string, then the string is hashed to integer-a (the DJBX33A hashing algorithm is used): <br><ul><li>  The initial value of the hash is taken as magical 5381 </li><li>  For each key symbol, multiply the hash by 33 and add the symbol number in ASCII </li></ul></li><li>  A mask (bitwise and) is applied to the resulting numeric key, which is always equal to the size of the array (which is with buckets) minus 1 </li><li>  As a result, this key can be used as an index to pull the necessary pointer to Bucket from the array </li></ul><br>  About the mask: let's say an array of pointers contains 4 elements, so the mask is three, that is, 11 in binary. <br>  Now if we get a number like 123 (1111011) as a key, then after applying the mask we get 3 (3 &amp; 123), this number can already be used as an index. <br><br>  After that, we will try to add in the Hash Table, with mask 3, items with the keys 54 and 90. And after applying the mask, both of these keys will be equal to two. <br><br><h2>  What to do with collisions? </h2><br>  The buckets are still a couple of cards in the sleeve.  Each bucket also has a pointer to the previous and next bucket, in which the indices (hashes from the keys) are equal. <br>  Thus, in addition to the main doubly linked list, which passes between all the buckets, there are also small doubly linked lists between those buckets whose indices are equal.  That is, it turns out about the following picture: <br><br><img src="https://habrastorage.org/storage2/84c/cc5/021/84ccc5021c6ffdfb5661a3977972f4e6.png"><br><br>  Back to our case with keys 54 and 90, and mask 3. After you add 54, the HT structure will look something like this: <br><br><pre> <code class="hljs css">{ <span class="hljs-attribute"><span class="hljs-attribute">nTableSize</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, //      nTableMask: <span class="hljs-number"><span class="hljs-number">3</span></span>, //  nNumOfElements: <span class="hljs-number"><span class="hljs-number">1</span></span>, //    HT nNextFreeElement: <span class="hljs-number"><span class="hljs-number">55</span></span>, //    ,         ( ) ..., arBuckets: [ NULL, NULL, <span class="hljs-number"><span class="hljs-number">0</span></span>xff0, // ,     Bucket,      NULL ] } 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xff0</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">h</span></span>: <span class="hljs-number"><span class="hljs-number">54</span></span>, //   nKeyLength: <span class="hljs-number"><span class="hljs-number">0</span></span>, //   ,      pData: <span class="hljs-number"><span class="hljs-number">0</span></span>xff1, //   ,      zval ... }</code> </pre><br><br>  Now add an element with the key 90, now everything will look like this: <br><br><pre> <code class="hljs css">{ <span class="hljs-attribute"><span class="hljs-attribute">nTableSize</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, nTableMask: <span class="hljs-number"><span class="hljs-number">3</span></span>, nNumOfElements: <span class="hljs-number"><span class="hljs-number">2</span></span>, nNextFreeElement: <span class="hljs-number"><span class="hljs-number">91</span></span>, ..., arBuckets: [ NULL, NULL, <span class="hljs-number"><span class="hljs-number">0</span></span>xff0, //       Bucket NULL ] } 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xff0</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">h</span></span>: <span class="hljs-number"><span class="hljs-number">54</span></span>, pListNext: <span class="hljs-number"><span class="hljs-number">0</span></span>xff2, //      Bucket   ( ) pNext: <span class="hljs-number"><span class="hljs-number">0</span></span>xff2, //     Bucket     ... } 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xff2</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">h</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span>, pListLast: <span class="hljs-number"><span class="hljs-number">0</span></span>xff0, //    pLast: <span class="hljs-number"><span class="hljs-number">0</span></span>xff0, //       ... }</code> </pre><br><br>  Now let's add some elements before the overflow of nTableSize (I remind you that there will be overflow only when nNumOfElements&gt; nTableSize). <br>  Add items with the keys 0, 1, 3 (those that have not yet existed, and after applying the masks, they will remain the same), this is what will happen: <br><br><pre> <code class="hljs css">{ <span class="hljs-attribute"><span class="hljs-attribute">nTableSize</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span>, //     (    ) nTableMask: <span class="hljs-number"><span class="hljs-number">7</span></span>, nNumOfElements: <span class="hljs-number"><span class="hljs-number">5</span></span>, nNextFreeElement: <span class="hljs-number"><span class="hljs-number">91</span></span>, //     ..., arBuckets: [ //       ,         <span class="hljs-number"><span class="hljs-number">0</span></span>xff3, // key = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xff4, // key = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xff2, // key = <span class="hljs-number"><span class="hljs-number">90</span></span> -     <span class="hljs-number"><span class="hljs-number">90</span></span> (  <span class="hljs-number"><span class="hljs-number">90</span></span> &amp; <span class="hljs-number"><span class="hljs-number">7</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>),       <span class="hljs-number"><span class="hljs-number">6</span></span>-  <span class="hljs-number"><span class="hljs-number">0</span></span>xff5, // key = <span class="hljs-number"><span class="hljs-number">3</span></span> NULL, NULL, <span class="hljs-number"><span class="hljs-number">0</span></span>xff0, // key = <span class="hljs-number"><span class="hljs-number">54</span></span> NULL ] } 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xff0</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">h</span></span>: <span class="hljs-number"><span class="hljs-number">54</span></span>, pListNext: <span class="hljs-number"><span class="hljs-number">0</span></span>xff2, //    ,     pNext: NULL, //     ... } 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xff2</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">h</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span>, pListNext: <span class="hljs-number"><span class="hljs-number">0</span></span>xff3, pListLast: <span class="hljs-number"><span class="hljs-number">0</span></span>xff0, pLast: NULL, ... } 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xff3</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">h</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, pListNext: <span class="hljs-number"><span class="hljs-number">0</span></span>xff4, pListLast: <span class="hljs-number"><span class="hljs-number">0</span></span>xff2, ... } 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xff4</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">h</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, pListNext: <span class="hljs-number"><span class="hljs-number">0</span></span>xff5, pListLast: <span class="hljs-number"><span class="hljs-number">0</span></span>xff3, ... } 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xff5</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">h</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, pListNext: NULL, //     pListLast: <span class="hljs-number"><span class="hljs-number">0</span></span>xff4, ... }</code> </pre><br><br>  What happens after an array overflow is called rehash.  In essence, this is an iteration over all existing buckets (via pListNext), the assignment of their neighbors (collisions) and the addition of references to them in arBuckets. <br><br>  But what really gets the item on the key?  To the previous algorithm one more thing will be added: <br><ul><li>  If the key is string, then the string is hashed to integer-a (the DJBX33A hashing algorithm is used): <br><ul><li>  The initial value of the hash is taken as magical 5381 </li><li>  For each key symbol, multiply the hash by 33 and add the symbol number in ASCII </li></ul></li><li>  A mask (bitwise and) is applied to the resulting numeric key, which is always equal to the size of the array (which is with buckets) minus 1 </li><li>  Take out the bucket on the index </li><li>  If the key of this bucket is equal to the required one, the search is completed, otherwise: </li><li>  In the cycle, we take a bucket from pNext (if it exists) and see if the key is equal </li></ul><br>  So until either the buckets run out in pNext (then Notice is thrown out), or until a match is found. <br><br>  It is worth noting that in PHP almost everything is built on this HashTable structure alone: ‚Äã‚Äãall variables in any scope are actually in HT, all methods of classes, all fields of classes, even the class definitions themselves are in HT, It is actually a very flexible structure.  Among other things, HT provides almost the same sampling / insertion / deletion speed and the complexity of all three is O (1), <em>but</em> with a reservation to a small overhead in case of collisions. <br><br>  By the way, <a href="https://github.com/nikita2206/php-hash-table">here</a> I implemented the Hash Table in PHP itself.  Well, that is, implemented PHP-shnye arrays in PHP =) </div><p>Source: <a href="https://habr.com/ru/post/162685/">https://habr.com/ru/post/162685/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../162675/index.html">Create an adaptive portfolio page with filters</a></li>
<li><a href="../162677/index.html">Again, the United States calls for the closure of sites on VKontakte, ex.ua, rutracker and others.</a></li>
<li><a href="../162679/index.html">Evolution of Zeus. Now in smartphones</a></li>
<li><a href="../162681/index.html">Output Habrakamp # 6</a></li>
<li><a href="../162683/index.html">FreeBSD 9.1 Release Released</a></li>
<li><a href="../162687/index.html">Do not copy-paste someone else's code, dial it yourself</a></li>
<li><a href="../162689/index.html">Totals Just For Fun Weekend Programming</a></li>
<li><a href="../162691/index.html">Board game about startups</a></li>
<li><a href="../162697/index.html">Fedora 18</a></li>
<li><a href="../162699/index.html">Google adds 18 new social features on Google+, and does NOT plan to create Gmail, Google Drive for Windows 8 and WP8 clients</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>