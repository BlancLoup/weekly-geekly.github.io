<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we arranged brunches for each task</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Today I would like to talk about how there are ways to arrange brunches for each task and how we did it in Alawar. Here is a simple technique w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we arranged brunches for each task</h1><div class="post__text post__text-html js-mediator-article">  Hello!  Today I would like to talk about how there are ways to arrange brunches for each task and how we did it in Alawar.  Here is a simple technique with apache2, which allows you to get excellent results and can be useful both for web developers and system administrators.  It is worth noting that similar solutions have already been covered in Habr√© (for example, <a href="http://habrahabr.ru/post/158855/">here</a> ), but often they are written for too narrow an audience and do not give answers to all the questions and, most importantly, often complicate the task.  The purpose of this particular article is to show how simple everything really is. <br><br><a name="habracut"></a>  So, let's begin. <br><br>  A few years ago, we had a problem, which was that it was sufficiently time-consuming to prepare a separate test platform on the server for each task.  At that time, one branch (trunk) was used in the repository for all developers and one test server.  For large tasks, of course, separate instances were manually prepared, but this was a forced measure rather than a normal solution.  All this periodically led to conflicts in the code in the course of development, and the saddest thing - to unexpected failures of one task, because of the work done in the framework of another task. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  A little about the features of the project </h5>  This is one of our major projects (alawar.ru, alawar.com, etc.), the essence of which is to provide different content from different domains in different languages.  Within the framework of one project, about hundreds of domains and subdomains are involved. <br><br>  Any change in the code is accompanied by a corresponding ticket in the bugtracker.  Tickets of various sizes are performed several dozen per week.  Test each ticket separately. <br><br>  The repository, when solving this problem is not critical, you can use any where it is possible to conduct development in a separate branch, so I will not specifically focus on this issue. <br><br><h5>  What were our options </h5>  1. Create a server configuration manually <br><br>  In fact, we did this for a long time, but not for all tasks, since  it took really a lot of time.  Therefore, they created only what is needed and, if possible, only the necessary minimum. <br><br>  2. Set up 1-2 test stands per developer <br><br>  This approach allows the developer to show one task and do the second, but the rest of the tasks with this configuration will not look.  And there is confusion when the developer switches the test bench to another task. <br><br>  3. On the test server, change the rules for forming and processing URLs <br><br>  For example, to make all the links in a project according to this principle: <b>http: // test.local / (task-number) / (host) / (uri)</b> . <br><br>  There was such an option, but it required a very large refactoring, so common sense did not allow us to go this way.  But this does not mean that this method is not suitable for others. <br><br>  4. Virtuals for each task <br><br>  The idea is that the hosts and the paths are always the same, the code from the desired task, the database and other services are their own.  In terms of testing, this is probably the ideal option. <br><br>  In our case, one full instance code, along with the database, along with the statics, etc.  - This is tens of gigabytes of data.  Just raising such an instance from scratch would take us quite a long time.  In addition, more than one terabyte of data would be required for all current tasks.  But most importantly, in this case it would not be enough for us to simply give a link to the realized task in order to show the result to the customer.  It would be necessary to launch it in advance, and this option did not seem convenient to us. <br><br>  5. Use virtual hosts <br><br>  In apache2 there are parameters UseCanonicalName and VirtualDocumentRoot ( <a href="httpd.apache.org/docs/2.2/mod/mod_vhost_alias.html">Link to documentation</a> ).  They allow you to use host subdomains as part of the path to the doc.  project root and all this without restarting apache2.  Thanks to these parameters, we can actually specify the path to the + uri instance on the host in order to get the answer we need. <br><br><h5>  Our choice </h5> As a result, we chose the option with virtual hosts and defined the following address format: <b>http: // (task-number).</b>  <b>(site-identifier).</b>  <b>test.local / (uri)</b> . <br><br>  Where (site-identifier) ‚Äã‚Äãcan take values ‚Äã‚Äãof the form: <br><br>  ‚Ä¢ ru - in this case, we understand that you need to show the main site in the .ru zone <br><br>  ‚Ä¢ com - the main site in the zone. Com <br><br>  ‚Ä¢ test.ru - test subdomain of the main site in the .ru zone <br><br>  ‚Ä¢ data.export.com - the data.export subdomain of the main site in the .com zone <br><br>  For projects where there is no concept of the main site, the following rules apply: <br><br>  ‚Ä¢ example.com - in this case, we understand that we need to show the site example.com <br><br>  ‚Ä¢ test.  example.com is a subdomain test.  example.com <br><br>  ‚Ä¢ data.export.  example.com is a subdomain of data.export.  example.com <br><br>  ‚Ä¢ etc. <br><br>  As a result, typing the address in the browser: <u>http: //task-1234.example.com.test.local/some/page/? SomeParams = value</u> we definitely know that the server will give the answer from the task-task branch of task-1234, the site handler example.com/some/page/?someParams=value. <br><br>  In order for everything to work as we planned it, it was necessary to fix the ways to the doc.rut as follows: <br><br> <code>/data/projects/projectName/branches/(task-number)/application/public</code> <br> <br>  And train the project to determine the host name, according to our rules. <br><br>  Of the features, I can note that for systems where file paths are important, (task-number) and (site-identifier) ‚Äã‚Äãmust be in lower case. <br><br>  Apache2 test platform configuration example: <br><br><pre> <code class="apache hljs"><span class="hljs-section"><span class="hljs-section">&lt;VirtualHost *:80&gt;</span></span> <span class="hljs-attribute"><span class="hljs-attribute">UseCanonicalName</span></span> <span class="hljs-literal"><span class="hljs-literal">Off</span></span> VirtualDocumentRoot /data/projects/projectName/branches/<span class="hljs-number"><span class="hljs-number">%1</span></span>/application/public ServerName test.local ServerAlias *.test.local Options -Indexes CustomLog /dev/null combined &lt;/VirtualHost&gt;</code> </pre><h5>  Automatic Deploy </h5>  Ultimately, scripts were written for automated deployments that create the necessary code branch in the repository, unpack and set up a local instance on a test server in a couple of minutes, but this is already a separate topic, here I will tell about it in general terms. <br><br>  Deploy automation can be done by various means (script on bash, phing, ant, etc.). <br><br>  This method consists in prescribing a sequence of commands that must be executed to raise the instance of your project.  For most web projects, it will look something like this: <br><br>  1. Ask for a task-number (or get the name of a branch as a parameter); <br><br>  2. Create a brunch in the repository, if it is not; <br><br>  3. Create a folder for the brunch (if not); <br><br>  4. Make a checkout (s) of the code; <br><br>  5. Set the rights to write to the necessary folders / files; <br><br>  6. Configure the project configuration; <br><br>  7. Put down the necessary symlinks; <br><br>  8. (perform other specific project actions); <br><br>  9. Run the initialization scripts of the project; <br><br>  10. If you want to run tests to make sure everything is ok. <br><br><h5>  So, </h5>  on projects that can use apache2 as a server, you can easily use the method described in this article to identify the correct version of the site through virtual hosts. <br><br>  If you know other ways of preparing test sites for each branch that are not described in this article, write about them in the comments, I think it will be very useful to all readers. <br><br></div><p>Source: <a href="https://habr.com/ru/post/181636/">https://habr.com/ru/post/181636/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../181624/index.html">Three new Evernote security features</a></li>
<li><a href="../181626/index.html">How to run a program without an operating system: part 4. Parallel computing</a></li>
<li><a href="../181630/index.html">Learn Pebble Watch to understand Russian.</a></li>
<li><a href="../181632/index.html">We create Apple-media storage on a PC-based</a></li>
<li><a href="../181634/index.html">A quick look at DesignSpark PCB</a></li>
<li><a href="../181638/index.html">Public VPS templates for Linux / Windows - invite authors and admins to create a service like AWS AMI</a></li>
<li><a href="../181640/index.html">How books are written</a></li>
<li><a href="../181642/index.html">Validation of dynamically added fields in Yii</a></li>
<li><a href="../181646/index.html">Yandex ‚ÄúIslands‚Äù: technical side and API</a></li>
<li><a href="../181648/index.html">‚ÄúTongue twisters‚Äù. Part 2: Promotion in the Russian App Store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>