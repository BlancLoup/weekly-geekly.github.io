<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Breathing life in Avatar</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Although Habr√© has already published some notes on the technical side of creating the Avatar movie, for example, HP‚Äôs blog had a note on creating a re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Breathing life in Avatar</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/06/d4/06d433f0db5a078145cbcc3c3efaea92.jpg" alt="image"><br>  <i>Although Habr√© has already published some notes on the technical side of creating the Avatar movie, for example, HP‚Äôs blog had a <a href="http://habrahabr.ru/company/hp/blog/80581">note</a> on creating a render farm built on HP blade systems, it seemed to me that this topic is still very interesting for ‚Äútechies‚Äù, how is everything done ‚Äúbehind the scenes‚Äù in projects of this magnitude, especially since NetApp systems were directly involved in making the film.</i>  <i>Therefore, I decided to translate an article for Habr exclusively from the recent fresh e-monthly newspaper <a href="http://www.netapp.com/us/communities/tech-ontap/archive/tot-archive.html">Tech Ontap</a> .</i>  <i>By the way, you can <a href="http://communicate.netapp.com/forms/ru-tot-regform%3FREF_SOURCE%3DEMM">subscribe</a> to its Russian version.</i> <br><br>  The <i>Avatar</i> film, which was released on screens this year, broke all records of fees, reaching a value of 2.7 billion dollars, and continuing to collect cash.  <a href="http://www.wetafx.co.nz/">Weta Digital</a> , a visual effects company that created special effects and computer animation for this film, also broke several of its own records in creating the impressive 3D world of <i>Avatar</i> .  Weta Digital gained wide popularity in the professional environment after the release of the Lord of the Rings trilogy and several <a href="http://www.wetafx.co.nz/features">subsequent films</a> , such as <i>King Kong</i> and <i>District # 9</i> , but the creation of <i>Avatar</i> required very special technical efforts. <br><a name="habracut"></a><br>  Weta Digital has pushed the boundaries of its computing infrastructures and storage systems far beyond what we had to work with earlier.  When work on <i>Avatar began</i> in 2006, Weta Digital just completed work on <i>King Kong</i> .  At this point, it had approximately 4,400 CPU cores in its rendering farm and about 100TB of storage space.  Completing the Avatar production, the company had about 35,000 CPU cores and over 3000TB of storage.  Only the rendering farm's RAM capacity today exceeds the total Weta Digital disk capacity at the time of the completion of the <i>King Kong</i> film. <br><br>  I began working at Weta Digital in 2003 as a system administrator when work on the last part of the <i>Lord of the Rings was completed</i> .  Soon, my main task was to lead the Weta Digital infrastructure solutions department.  This department was responsible for all servers, networks and storage systems.  Our task was to create such an infrastructure in order to make it possible to create a film of the Avatar level, and also to solve all the problems of the technical plan arising during the work on it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Battle for growth </h4><br>  Despite the huge growth that occurred in Weta Digital during the work on Avatar, managing the grown infrastructure did not become such a problem as we feared.  To a large extent, it was the merit of a team that knows how to work together.  The team kept together, and when something went wrong, we jumped up and rushed to fix it all together.  We worked hard, and, in most cases, we managed to anticipate the situation, instead of correcting something that had already happened. <br><br>  We quickly realized that in order to cope with <i>Avatar</i> we would need to take two important steps. <br><ul><li>  <b>Build a new data center.</b>  Weta Digital has so far used several small server rooms scattered across several buildings.  The new data center provides centralized deployment and consolidation of all new infrastructure, which will need to be increased during the implementation of the Avatar project. <br></li><li>  <b>Build a high-speed fiber optic channel.</b>  Weta Digital does not have a localized campus.  Instead, our "campus" consists of several independent buildings scattered in the suburbs of Wellington.  We developed and built a high-speed "ring" using fiber, which connected all these buildings with a new data center.  Each building was connected by a redundant connection, with a bandwidth of 10Gbit / s each, totaling EtherChannel forming 40Gbit / s, to connect the storage system and servers of the render farm. <br></li></ul><br>  These two elements gave us the physical ability to scale our infrastructure, increasing it and bandwidth to move data freely between locations.  The new server infrastructure of the updated rendering farm was created using HP blade servers.  With 8 cores and 24GB RAM on the blade, we were able to fit up to 1024 cores and up to 3TB RAM per rack.  The new data center was organized as a series of 10 racks, totally 10240 cores.  We installed the first 10,000, worked a little on them, added another 10,000, still worked, added another 10,000, and finally, we have set the last 5,000 cores so far. <br><br>  Datacenter has a number of unique design elements: <br><ul><li>  <b>Water cooling.</b>  Since the usual weather in Wellington, New Zealand, the city where Weta Digital is located, is rarely very hot, most of the time, water is pumped directly from the racks cooled by it to the radiators on the building‚Äôs roof for natural heat exchange.  Servers operate in relatively ‚Äúwarm‚Äù mode, at a temperature of 23¬∫ C. <br></li><li>  <b>High power density.</b>  Datacenter provides power supply up to 30 kilowatts per rack. <br></li><li>  <b>High strength racks.</b>  Each Rittal rack with integrated water cooling can withstand the weight of the equipment and the cooling system placed in it to one ton. <br></li></ul><br>  In our storage infrastructure, we used products from several manufacturers, but its core consists of storage systems manufactured by NetApp, which contains about 1000TB of data.  By the end of work on Avatar, we replaced all our old FAS980 and FAS3050 with cluster FAS6080.  In the last eight months of the project, we also added four SA600 storage accelerator systems in order to solve one particularly painful performance problem. <br><br><h4>  Accelerating access to texture files using adaptive caching <br></h4><br>  In the visual effects industry, ‚Äútextures‚Äù are special image files that are ‚Äúapplied‚Äù to a 3D model, making it realistic.  The model is ‚Äúwrapped‚Äù in textures that create the necessary details, color, shadows, character of the model's surface, without which the 3D model looks only monotonously gray.  A ‚Äútexture set‚Äù is all the various pictures that need to be applied to a specific model so that it looks like a tree, character, or creature.  Most renders that include objects also include textures applied to these objects;  thus, the contents of the texture files are constantly required by the farm servers when creating the scene. <br><br>  A certain group of texture sets can be requested simultaneously by several thousand cores of render processors.  Overlapping in content from the first, another group may be requested by another thousand cores, and so on.  All that we can do to improve the situation with the speed of access to textures will dramatically increase the performance of the entire rendering farm as a whole. <br><br>  No separate file server can provide enough bandwidth to load all of our texture sets, so we developed a special ‚Äúpublish‚Äù process that is designed to create replicas of each created texture set.  This is shown in Figure 1. <br><br><img src="https://habrastorage.org/storage/habraeffect/11/13/111334b36c3c1cf19e7ce6f49f9ddc8d.png" alt="weta infrastructure before"><br><br>  Figure 1) The old method of increasing bandwidth when transferring texture sets. <br><br>  When the render task is run on the farm, they need access to the set of textures used in the project, it selects a random file server and reads the contents of the texture from one of its replicas.  Allowing us to distribute the contents of textures across several file servers this process significantly increased system performance.  Although this solution was better than the single file server option, the publishing and replication process was rather complicated and took time consuming integrity control to be sure that all replicas on all servers are absolutely identical. <br><br>  We started using NetApp FlexCache and the SA600 storage accelerator as an easy way to solve the problem of lack of performance associated with working with texture sets.  FlexCache software creates a caching layer in the storage infrastructure that automatically handles changing access patterns and eliminates performance bottlenecks.  It automatically replicates and maintains access to active datasets, regardless of where the data resides in the storage infrastructure, using local caching volumes. <br><br>  Instead of manually copying our textures to several file servers, FlexCache allows us to dynamically cache the textures currently used in the project and deliver them to the render farm from the SA600 devices.  We tested this solution and saw that it works very well in our system, so 8 months before the end of the film, we decided to take a chance and installed four SA600 systems, each with two Performance Accelerator Modules (PAM) modules with a capacity of 16GB each.  (PAM works like a cache, reducing response time when accessing data. More: <a href="http://www.netapp.com/us/communities/tech-ontap/pam.html">eng</a> and <a href="http://blog.aboutnetapp.ru/archives/599">rus</a> ) <br><br><img src="https://habrastorage.org/storage/habraeffect/97/39/97391c1cd4b8d5438762b092a7851da2.png" alt="weta infrastructure after"><br><br>  Figure 2) Improved bandwidth increase method for texture sets using NetApp FlexCache, SA600, and PAM. <br><br>  The total size of the texture set is about 5TB, but when we turned on FlexCache, we found out that only 500GB of them are actively used at any given time.  Each SA600 has enough space on its local disks to place this active dataset, and when the textures in the active dataset change, the cache automatically reloads its contents without requiring us to manually intervene in this process.  Aggregated bandwidth was 4GB / s, much more than we have achieved so far. <br><br>  Texture caching with FlexCache was an excellent solution.  Everything works faster, easier to manage textures and their sets.  It was the final year of the project, which took four years of labor to create the film.  If we decided to put the SA600 and problems would start with them, we would have to urgently change everything back so as not to disrupt the deadlines.  But after a week passed, we almost forgot about their existence (except, of course, the fact of increased speed).  This is the easiest way to make IT happy. <br><br>  The performance of the storage subsystem has a significant impact on the speed of processing render jobs.  Bottlenecks and lack of performance prevent the rendering farm from running at full power.  In the last year of Avatar creation, we went deep into the details of the processes and added many opportunities to monitor and remove statistics in each task. <br><br>  We constantly lagged behind the schedule, we constantly had delayed tasks waiting for the launch queue;  every day, more and more jobs were accumulating that were waiting for them to turn.  The team of so-called ‚Äúshepherds‚Äù (wranglers) at Weta Digital is committed to ensuring that all tasks and work on the renderer go correctly and in the right order.  The next morning, after we installed and launched FlexCache at night, the ‚Äúsenior shepherd‚Äù came to us with a report that all the tasks were completed.  Everything worked so unexpectedly quickly that he decided that something had broken. <br><br><h4>  Why NetApp? </h4><br>  I'm a longtime fan of NetApp products.  I first happened to use NetApp systems when I was working at an Internet provider in Alaska, during the ‚Äúdot-boom‚Äù era in the late 90s ‚Äî I was quite impressed with their capabilities to consistently promote them further in the companies where I worked.  I was pleased to see that NetApp storage systems were already in use at Weta Digital when I arrived. <br><br>  For companies like Weta Digital, it‚Äôs quite common to break something, as usually no one else does this to the infrastructure that we have to do.  The key point in the situation is that you may need the help of the vendor to correct the situation (for example, analyzing the causes of the problem, or even urgently releasing a patch for the software if a bug is detected).  Even if you work in a small company, there will always be someone in NetApp who will work on your problem with you until it is finally solved.  Do you think that this is how it should always happen?  My experience shows that other vendors do this quite rarely. <br><br>  Data warehouses can be complicated.  NetApp technologies make storage systems as simple as possible.  There are things that I would like NetApp to do better than it is doing now, but compared to all others, I see that NetApp makes a reliable and versatile product that is simple to use and that is provided with reliable support.  That's why we still use NetApp. <br><br><img src="http://www.divshare.com/direct/11926795-596.jpg"><br>  Adam shand <br>  Earlier, the head of infrastructure department <br>  Weta digital <br><br>  <i>Adam began his career in New Zealand where he founded one of the country's first Internet companies, together with his father.</i>  <i>His next job, in 1997, led him to Alaska, then he worked in Portland, Oregon in the EDA industry.</i>  <i>The similarity between EDA and the production of visual effects, plus the ability to work closer to home, led Adam in 2003 to Weta Digital.</i>  <i>After several years at Weta Digital, Adam decided to leave the company, and set off on a one-year journey through Southeast Asia.</i> </div><p>Source: <a href="https://habr.com/ru/post/98537/">https://habr.com/ru/post/98537/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../98526/index.html">31 startups from Y Combinator</a></li>
<li><a href="../98527/index.html">The battle for the national operating system has begun</a></li>
<li><a href="../98528/index.html">On the intelligence of search engines</a></li>
<li><a href="../98530/index.html">What, where, where: an overview of travel blogging services</a></li>
<li><a href="../98533/index.html">Optional enhancement of entry criteria</a></li>
<li><a href="../98539/index.html">Improving admin panel</a></li>
<li><a href="../98541/index.html">HTML5 Mobile Version</a></li>
<li><a href="../98543/index.html">Timeweb and the hacker Tiny</a></li>
<li><a href="../98546/index.html">Disclose the biggest secret of Skype</a></li>
<li><a href="../98549/index.html">HTC Desire released firmware with SenseUI and 720p video</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>