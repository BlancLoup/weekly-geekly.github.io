<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Long-suffering notepad: an error that has not been fixed for 13 years</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the standard notebook for all versions of Windows, starting around 2001, there is an error about which almost everyone knows, but no one is going t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Long-suffering notepad: an error that has not been fixed for 13 years</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/53b/42d/32e/53b42d32e16e4cf5ac5d6a64f1855438.png"><br><br>  In the standard notebook for all versions of Windows, starting around 2001, there is an error about which almost everyone knows, but no one is going to fix it.  And this is understandable, because this is not a critical vulnerability, it does not threaten anyone‚Äôs security.  Does anyone use a notebook at all? <br><br>  Nevertheless, the fact itself is rather strange, so we will try to find this error in the 64-bit and 32-bit notepad.exe code from windows 7, fix it, and find out finally, why it originated.  The error is as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If the word wrap option is turned on in Notepad, then <b>after saving the file</b> , various glitches begin: the lines start to break up, the cursor flies away, the text is entered not where you expect it, and so on. <br><a name="habracut"></a><br>  To begin, let's try to find out more precisely what is happening.  Open or enter some text with long lines so that they are transferred.  Save the file.  If you now try to edit it, for example, by adding the word "blue", the lines will be transferred incorrectly, breaking the formatting: <br><br><img src="https://habrastorage.org/files/08e/0ac/205/08e0ac205e5848faad2b1688b1f54d28.png"><br><br>  If you reduce the notepad window, the lines are cut (this is visible on the title picture), and when stretched, they remain in place, not filling the increasing window.  As if in each line appeared a hard "line feed" in the place where it ended at the moment of saving.  Apparently the text somehow spoils in memory: <br><br><img src="https://habrastorage.org/files/8f1/739/713/8f17397135674934bcd31d7ed6e86f77.png"><br><br>  If you now save the file again, it becomes even worse.  All lines are reformatted, but the window is not updated.  Therefore, the cursor can move to another place, and if you start to enter text, it turns out that you are not entering it in the place where the cursor is, but in a completely different one.  Programmers who wrote notepad reasoned logically: when saving a file, nothing in the window should change, so there is no point in updating it.  But in our case, taking into account this error, the entire text changes.  Every windows user can reproduce the situation, because the latest version where this error was not was Windows'98, and it is unlikely that anyone else has it. <br><br>  So, apparently, when you save the file, something goes wrong and the text is spoiled.  How to find this place in the code?  Open notepad.exe in some debugger.  As you know, there are two notebooks for compatibility in a 64-bit system: 32-bit and 64-bit, you should not confuse them. <br><br>  We introduce the text, which will be easy to see how it spoils when you wrap lines.  Type ‚Äúfirst text line second text line‚Äù in one line and then reduce the window so that it is cut in the middle. <br><br><img src="https://habrastorage.org/files/065/3ea/8f6/0653ea8f69f5482fb2418028fb859ba0.png"><br><br>  It is reasonable to assume that writing is done using the WriteFile function.  It turns out that it is called in the code as much as 6 times.  Without thinking twice, we set breakpoints on all 6 calls.  Start the notebook and click "save".  Execution stops here: <br><br><img src="https://habrastorage.org/files/192/d97/50f/192d9750f4184d5dbd99540dd5792f56.png"><br><br>  Let's look at all registers where call parameters are contained.  In rcx we have 104, it is not clear what.  A rdx = 002D45E0, it looks like an address in memory.  Let's see what is there. <br><br><img src="https://habrastorage.org/files/d6f/981/94a/d6f98194a18e45b1985433a7baeea42f.png"><br><br>  Fine.  From here we are recording.  Let's try to execute the code further to see where it is spoiled.  However, almost immediately the data is overwritten, which means that this is just a temporary buffer, and the text itself is stored somewhere else.  Let's look above the program. <br><br><img src="https://habrastorage.org/files/54c/b0c/052/54cb0c0525314f76a55bc33091122084.png"><br><br>  Yeah, before saving, the text is apparently converted from multibyte to single-byte encoding.  In the same way as last time, let's look at the parameters.  rax = 002D45E0, here we still have zeros.  This is the place where the result will fall.  esi = 20 is the length of the text.  ecx = 4eZ, no comments.  edx = 400, the same.  But r8 = 002D6780: <br><br><img src="https://habrastorage.org/files/95f/806/b57/95f806b578c342d097a1ab2f166e80d3.png"><br><br>  Again we will continue execution, observing the contents of this section of memory.  After a few dozen commands, we exit the subroutine, some transitions, calls are performed, but without paying attention to it, we continue to put pressure on ‚Äústep over‚Äù, executing the code step by step, and watching only the window with the text.  And at some point it changes.  As you can see, between 1 and 2 lines there appeared codes 0d, 0d, 0a: <br><br><img src="https://habrastorage.org/files/af1/4d3/6bf/af14d36bf95344b7956eb63c9491a05d.png"><br><br>  As is usually the case, we slipped the necessary command, constantly pressing the button, so we have to repeat everything again, remembering where approximately it happened.  Now, as we approach the right place in the code, we slow down, and we determine exactly that the text has become corrupted on this call: <br><br><img src="https://habrastorage.org/files/440/ca7/92b/440ca792b34046a0a07b69a98b8c5cc1.png"><br><br>  You can try what will happen if you do not make this call.  We reach this place again, and right here, in debugging, we change the RIP (the register where the address of the currently running code is stored) to 00000000FFA38EE1, as if we had missed this call, which spoiled everything to us.  Surprisingly, everything works, the text does not break! <br><br>  Here it must be said that in such cases they usually do not understand what this subroutine is, what it does and why, but simply throw it out of the EXE file.  This can be done in different ways, for example, to hammer it all <a href="https://ru.wikipedia.org/wiki/NOP">NOP</a> 's, or to change the conditional transition on the equality ‚Äúje‚Äù, which by the way is immediately before it, to the unconditional ‚Äújmp‚Äù. <br><br>  But we now need not so much to correct this error, how interesting it is to find out where it came from.  Therefore, we go inside and look: <br><br><img src="https://habrastorage.org/files/6e9/bfa/2fc/6e9bfa2fc69240e5891fba10d06de913.png"><br><br>  Here is such a wonderful little routine.  We pass it in steps.  At first, some two variables are compared with zero, as a result, the first call does not know what is being done, but is made in succession to call SendMessage.  That is, everything that happens, it is sent two some kind of Windows messages, and the text deteriorates immediately after the first one (highlighted in green).  The naked eye can see that their codes are transmitted to EDX (highlighted in red).  Look for the code 0C8h. <br><br>  This turns out to be the EM_FMTLINES message.  It seems to be quite similar, we send messages to format the strings, so they have been preformatted.  It's time to read the documentation.  MSDN tells us the following: <br><br><blockquote>  This message defines the inclusion of "soft" line feeds in a multiline edit control.  A ‚Äúsoft‚Äù line break is two characters [CR] and one [LF] and is inserted into the line where it is cut during word wrap. <br><br>  Parameter wParam: true - insert characters, false - delete them. <br><br>  The message only affects the buffer returned by the EM_GETHANDLE and WM_GETTEXT messages, and does not affect the text displayed in the edit control.  It also does not affect "hard" line breaks, which consist of one [CR] and one [LF]. </blockquote><br>  In addition, we learn that this message was entered no later than in Windows 95. Well, that's all, it became clear.  In 95, it was assumed that it does not affect, but now we see what is affected, and how else.  Having a little studied a code, we find some similar calls, and the following picture is presented to our mind‚Äôs eye: <br><br>  Long ago, in the first half of the 1990s, Microsoft programmers wrote a notebook for Windows 95. To implement the remarkable line wrapping function, they came up with sending a message to the window (or its element) so that it reformatted itself by inserting special characters.  To distinguish these characters from the normal line feed, they invented the sequence 0d, 0d, 0a.  To prevent it from getting into the file, before saving, all such codes were deleted, and after saving, they were added back. <br><br>  Later, when windows XP was made, the element began to transfer everything as it should, and it no longer needed this message.  However, no one remembered why it was needed, and therefore they decided to leave it as it was just in case.  Moreover, everything seemed to work, and no one noticed the problems after saving.  Since then, this code has remained, having reached the latest versions of Windows 7 and 8. I did not install the top ten, but most likely there is one too. <br><br>  We now turn to the correction of errors.  After the message 08h, another OB1h is sent, and this EM_SETSEL is the allocation setting.  It seems that it‚Äôs still completely wrong to throw out this subroutine, and there is some strange challenge at the beginning.  Therefore, it is better to delete only the first call to SendMessage, or change its parameter from 1 to 0, or change the transition to another address, so that, after checking the variable [0FFA40054h], immediately move to the second call.  There are many options, but the result will be the same. <br><br><img src="https://habrastorage.org/files/9b0/189/fc7/9b0189fc7e114997b4b3442c5d845021.png"><br><br>  Where is the parameter equal to 1?  Everything is very simple - it is in the register r8.  To shorten code, the compiler never uses direct zero forwarding to registers.  Such a command takes b bytes: 2 bytes operation code, 4 bytes - 32-bit zero.  Instead, the XOR register itself is with itself, resulting in a zero, and it only takes 3 bytes.  After that, r9, which is zero, is sent to r8 with the addition of one (highlighted in green).  This operation also takes only 4 bytes.  This green 1 we need to change to 0, and then the text will not deteriorate. <br><br>  And now we will find the same procedure in the 32-bit version of the notebook.  If you do not want to repeat all the same manipulations with debugging, you can find it by simply searching for the number 0C8h. <br><br><img src="https://habrastorage.org/files/0de/6d5/a11/0de6d5a1117043a9a959d9082d7021ed.png"><br><br>  As you can see, a completely similar code, only 32-bit.  Now, to correct the error, it remains only to find this place in the ehe-shnik and change the desired byte.  Before this, do not forget to take ownership of the file and give yourself the right to change it. <br><br>  <b>64-bit notepad.exe (193536 bytes) change byte at [80FC] from 1 to 0</b> <b><br></b>  <b>32-bit notepad.exe (179712 bytes) change byte at address [6FC8] from 1 to 0</b> <b><br></b> <br>  I have no doubt that somewhere in the depths of the Microsoft code there are still many places where ancient bugs are sleeping, which, most likely, no one will ever fix.  We can only hope that they are all as harmless as this one, and nothing terrible will happen when they are transferred to the next operating system, which users around the world will be happy to install. </div><p>Source: <a href="https://habr.com/ru/post/264081/">https://habr.com/ru/post/264081/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264069/index.html">Quick and dirty: excel to html</a></li>
<li><a href="../264071/index.html">Check your site for getting into the Unified Register of prohibited sites in Russia</a></li>
<li><a href="../264073/index.html">Virus protection - what does NIST tell us?</a></li>
<li><a href="../264075/index.html">We use CircleCI for testing and deploying iOS applications</a></li>
<li><a href="../264079/index.html">Introducing the new cloud region InfoboxCloud: St. Petersburg</a></li>
<li><a href="../264085/index.html">Russian students again won first place in the international final of the Imagine Cup with the game OVIVO</a></li>
<li><a href="../264089/index.html">5 clicks on the terminal screen - and any folder opens</a></li>
<li><a href="../264093/index.html">Social login: strengths</a></li>
<li><a href="../264097/index.html">Digest of grocery design, July 2015</a></li>
<li><a href="../264099/index.html">The magic of tensor algebra: Part 17 - Sketch of nut Janibekova</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>