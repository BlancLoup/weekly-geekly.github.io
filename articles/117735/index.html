<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Capturing video from network cameras, part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In my first article ‚Äúmeasuring the distance to an object and its speed,‚Äù I looked at capturing images from webcams via Video4Linux2 and via DirectX. I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Capturing video from network cameras, part 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/6843c8c0/7eb10f55/1ecadc34/33942d3a.jpg" align="left"><br>  In my first article <a href="http://habrahabr.ru/blogs/image_processing/115661/">‚Äúmeasuring the distance to an object and its speed,‚Äù</a> I looked at capturing images from webcams via Video4Linux2 and via DirectX.  In the next article, <a href="http://habrahabr.ru/blogs/image_processing/115808/">‚ÄúCapturing Video from Network Cameras, Part 1,‚Äù</a> I looked at how to work with Motion-JPEG network cameras.  Now I will tell you about capturing images from network RTSP cameras, in particular the Motion-JPEG stream via RTSP. <br><br>  This task is more complicated than Motion-JPEG via HTTP, since more actions are needed, more connections are needed, but in return we get more flexibility, speed, functionality and even some kind of versatility.  Honestly, RTSP for simple tasks is redundant, but I have no doubt that there will be situations where it will be necessary. <br><br><a name="habracut"></a><h4>  What is RTSP </h4><br>  <a href="http://ru.wikipedia.org/wiki/RTSP">RTSP</a> stands for Real Time Streaming Protocol - a real-time streaming protocol - in essence it is a broadcast control protocol, it allows you to perform several commands, such as ‚Äústart‚Äù, ‚Äústop‚Äù, ‚Äútransition to a specific time‚Äù.  This protocol is similar to HTTP in the implementation, there are also headers, everything is also transmitted in text form.  Here are the main commands from the <a href="http://tools.ietf.org/html/rfc2326">specification</a> : <br><ul><li>  OPTIONS - returns a list of supported methods (OPTIONS, DESCRIBE, etc.); </li><li>  DESCRIBE - content description request, describes each track in <a href="http://ru.wikipedia.org/wiki/Session_Description_Protocol">SDP</a> format; </li><li>  SETUP - request to establish connections and transport for threads; </li><li>  PLAY - start broadcasting; </li><li>  TEARDOWN - stop broadcasting. </li></ul>  And the feature of RTSP is that it does not in itself transmit the video data we need!  The whole protocol is just to establish a connection.  Here is an analogy with MVC, there is a separation between the data and their description. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The workhorse is another protocol: <a href="http://ru.wikipedia.org/wiki/RTP">RTP</a> - Real-time Transport Protocol - real-time transport protocol.  With the help of it, the data we need is transmitted.  It should be noted that it is very pleasant to work with this protocol, the fact is that it facilitates the client software to recover data after their fragmentation at the data link level.  It also carries several useful fields: the format of the transmitted data, the time stamp and the synchronization field (if, for example, audio and video are transmitted simultaneously).  Although this protocol can work over TCP, it is usually used with UDP because of its speed orientation.  That is, RTP data is a UDP datagram with a header and payload of media content (payload). <br><br>  It would seem that we do not need anything else.  Connect via RTSP, pick up via RTP.  But this was not the case, smart uncles came up with a third protocol: <a href="http://en.wikipedia.org/wiki/RTP_Control_Protocol">RTCP</a> - Real-time Transport Control Protocol - a real-time transport control protocol.  This protocol serves to determine the quality of service; with its help, the client and server know how good or bad the content is being transferred.  In accordance with this data, the server, for example, can lower the bitrate or even switch to another codec. <br><br>  It is assumed that RTP uses an even port number, and RTCP is the next odd one. <br><br><h5>  RTSP communication example </h5><br>  I have only one source of the RTSP stream - the <a href="http://e-vidence.ru/index.php%3Foption%3Dcom_content%26view%3Darticle%26id%3D40%26Itemid%3D37">eVidence APIX Box M1</a> camera, so all examples relate to it. <br><br>  Below is a log of communication between the VLC player (it really helps me in my research) and this camera.  The first request from VLC is on port 554 of the camera.  The answer is a blank line and begins with "RTSP / 1.0". <br><br><pre><code class="lua hljs"><span class="hljs-number"><span class="hljs-number">01</span></span>: OPTIONS rtsp://<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/jpeg RTSP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>: CSeq: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span>: User-Agent: VLC media player (LIVE555 Streaming Media v2008<span class="hljs-number"><span class="hljs-number">.07</span></span><span class="hljs-number"><span class="hljs-number">.24</span></span>) <span class="hljs-number"><span class="hljs-number">04</span></span>: <span class="hljs-number"><span class="hljs-number">05</span></span>: RTSP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-number"><span class="hljs-number">06</span></span>: CSeq: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span>: Date: Fri, Apr <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-number"><span class="hljs-number">2010</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> GMT <span class="hljs-number"><span class="hljs-number">08</span></span>: Public: OPTIONS, DESCRIBE, SETUP, TEARDOWN, PLAY, PAUSE <span class="hljs-number"><span class="hljs-number">09</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>: DESCRIBE rtsp://<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/jpeg RTSP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>: CSeq: <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>: Accept: application/sdp <span class="hljs-number"><span class="hljs-number">13</span></span>: User-Agent: VLC media player (LIVE555 Streaming Media v2008<span class="hljs-number"><span class="hljs-number">.07</span></span><span class="hljs-number"><span class="hljs-number">.24</span></span>) <span class="hljs-number"><span class="hljs-number">14</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>: RTSP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-number"><span class="hljs-number">16</span></span>: CSeq: <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>: Date: Fri, Apr <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-number"><span class="hljs-number">2010</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> GMT <span class="hljs-number"><span class="hljs-number">18</span></span>: Content-Base: rtsp://<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/jpeg/ <span class="hljs-number"><span class="hljs-number">19</span></span>: Content-Type: application/sdp <span class="hljs-number"><span class="hljs-number">20</span></span>: Content-Length: <span class="hljs-number"><span class="hljs-number">442</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>: x-Accept-Dynamic-Rate: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span>: <span class="hljs-number"><span class="hljs-number">23</span></span>: v=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span>: o=- <span class="hljs-number"><span class="hljs-number">1272052389382023</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> IN IP4 <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span>: s=Session streamed by <span class="hljs-string"><span class="hljs-string">"nessyMediaServer"</span></span> <span class="hljs-number"><span class="hljs-number">26</span></span>: i=jpeg <span class="hljs-number"><span class="hljs-number">27</span></span>: t=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span>: a=tool:LIVE555 Streaming Media v2008<span class="hljs-number"><span class="hljs-number">.04</span></span><span class="hljs-number"><span class="hljs-number">.09</span></span> <span class="hljs-number"><span class="hljs-number">29</span></span>: a=<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>:broadcast <span class="hljs-number"><span class="hljs-number">30</span></span>: a=control:* <span class="hljs-number"><span class="hljs-number">31</span></span>: a=range:npt=<span class="hljs-number"><span class="hljs-number">0</span></span>- <span class="hljs-number"><span class="hljs-number">32</span></span>: a=x-qt-text-nam:Session streamed by <span class="hljs-string"><span class="hljs-string">"nessyMediaServer"</span></span> <span class="hljs-number"><span class="hljs-number">33</span></span>: a=x-qt-text-inf:jpeg <span class="hljs-number"><span class="hljs-number">34</span></span>: m=video <span class="hljs-number"><span class="hljs-number">0</span></span> RTP/AVP <span class="hljs-number"><span class="hljs-number">26</span></span> <span class="hljs-number"><span class="hljs-number">35</span></span>: c=IN IP4 <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">36</span></span>: a=control:track1 <span class="hljs-number"><span class="hljs-number">37</span></span>: a=cliprect:<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">720</span></span>,<span class="hljs-number"><span class="hljs-number">1280</span></span> <span class="hljs-number"><span class="hljs-number">38</span></span>: a=framerate:<span class="hljs-number"><span class="hljs-number">25.000000</span></span> <span class="hljs-number"><span class="hljs-number">39</span></span>: m=audio <span class="hljs-number"><span class="hljs-number">7878</span></span> RTP/AVP <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span>: a=rtpmap:<span class="hljs-number"><span class="hljs-number">0</span></span> PCMU/<span class="hljs-number"><span class="hljs-number">8000</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">41</span></span>: a=control:track2 <span class="hljs-number"><span class="hljs-number">42</span></span>: <span class="hljs-number"><span class="hljs-number">43</span></span>: <span class="hljs-number"><span class="hljs-number">44</span></span>: SETUP rtsp://<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/jpeg/track1 RTSP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">45</span></span>: CSeq: <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">46</span></span>: Transport: RTP/AVP;unicast;client_port=<span class="hljs-number"><span class="hljs-number">41760</span></span><span class="hljs-number"><span class="hljs-number">-41761</span></span> <span class="hljs-number"><span class="hljs-number">47</span></span>: User-Agent: VLC media player (LIVE555 Streaming Media v2008<span class="hljs-number"><span class="hljs-number">.07</span></span><span class="hljs-number"><span class="hljs-number">.24</span></span>) <span class="hljs-number"><span class="hljs-number">48</span></span>: <span class="hljs-number"><span class="hljs-number">49</span></span>: RTSP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-number"><span class="hljs-number">50</span></span>: CSeq: <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">51</span></span>: Cache-Control: must-revalidate <span class="hljs-number"><span class="hljs-number">52</span></span>: Date: Fri, Apr <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-number"><span class="hljs-number">2010</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> GMT <span class="hljs-number"><span class="hljs-number">53</span></span>: Transport: RTP/AVP;unicast;destination=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>;source=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>;client_port=<span class="hljs-number"><span class="hljs-number">41760</span></span><span class="hljs-number"><span class="hljs-number">-41761</span></span>; server_port=<span class="hljs-number"><span class="hljs-number">6970</span></span><span class="hljs-number"><span class="hljs-number">-6971</span></span> <span class="hljs-number"><span class="hljs-number">54</span></span>: Session: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">55</span></span>: x-Transport-Options: late-tolerance=<span class="hljs-number"><span class="hljs-number">1.400000</span></span> <span class="hljs-number"><span class="hljs-number">56</span></span>: x-Dynamic-Rate: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">57</span></span>: <span class="hljs-number"><span class="hljs-number">58</span></span>: SETUP rtsp://<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/jpeg/track2 RTSP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">59</span></span>: CSeq: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span>: Transport: RTP/AVP;unicast;client_port=<span class="hljs-number"><span class="hljs-number">7878</span></span><span class="hljs-number"><span class="hljs-number">-7879</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>: Session: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">62</span></span>: User-Agent: VLC media player (LIVE555 Streaming Media v2008<span class="hljs-number"><span class="hljs-number">.07</span></span><span class="hljs-number"><span class="hljs-number">.24</span></span>) <span class="hljs-number"><span class="hljs-number">63</span></span>: <span class="hljs-number"><span class="hljs-number">64</span></span>: RTSP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-number"><span class="hljs-number">65</span></span>: CSeq: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">66</span></span>: Cache-Control: must-revalidate <span class="hljs-number"><span class="hljs-number">67</span></span>: Date: Fri, Apr <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-number"><span class="hljs-number">2010</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> GMT <span class="hljs-number"><span class="hljs-number">68</span></span>: Transport: RTP/AVP;unicast;destination=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>;source=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>;client_port=<span class="hljs-number"><span class="hljs-number">7878</span></span><span class="hljs-number"><span class="hljs-number">-7879</span></span>; server_port=<span class="hljs-number"><span class="hljs-number">6972</span></span><span class="hljs-number"><span class="hljs-number">-6973</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span>: Session: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">70</span></span>: x-Transport-Options: late-tolerance=<span class="hljs-number"><span class="hljs-number">1.400000</span></span> <span class="hljs-number"><span class="hljs-number">71</span></span>: x-Dynamic-Rate: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span>: <span class="hljs-number"><span class="hljs-number">73</span></span>: PLAY rtsp://<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/jpeg/ RTSP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span>: CSeq: <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">75</span></span>: Session: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">76</span></span>: Range: npt=<span class="hljs-number"><span class="hljs-number">0.000</span></span>- <span class="hljs-number"><span class="hljs-number">77</span></span>: User-Agent: VLC media player (LIVE555 Streaming Media v2008<span class="hljs-number"><span class="hljs-number">.07</span></span><span class="hljs-number"><span class="hljs-number">.24</span></span>) <span class="hljs-number"><span class="hljs-number">78</span></span>: <span class="hljs-number"><span class="hljs-number">79</span></span>: RTSP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-number"><span class="hljs-number">80</span></span>: CSeq: <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">81</span></span>: Date: Fri, Apr <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-number"><span class="hljs-number">2010</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> GMT <span class="hljs-number"><span class="hljs-number">82</span></span>: Range: npt=<span class="hljs-number"><span class="hljs-number">0.000</span></span>- <span class="hljs-number"><span class="hljs-number">83</span></span>: Session: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span>: RTP-Info: url=rtsp://<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/jpeg/track1;seq=<span class="hljs-number"><span class="hljs-number">20730</span></span>; rtptime=<span class="hljs-number"><span class="hljs-number">3869319494</span></span>,url=rtsp://<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/jpeg/track2;seq=<span class="hljs-number"><span class="hljs-number">33509</span></span>;rtptime=<span class="hljs-number"><span class="hljs-number">3066362516</span></span> <span class="hljs-number"><span class="hljs-number">85</span></span>: <span class="hljs-number"><span class="hljs-number">86</span></span>: #              <span class="hljs-number"><span class="hljs-number">87</span></span>: <span class="hljs-number"><span class="hljs-number">88</span></span>: TEARDOWN rtsp://<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>/jpeg/ RTSP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span>: CSeq: <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span>: Session: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">91</span></span>: User-Agent: VLC media player (LIVE555 Streaming Media v2008<span class="hljs-number"><span class="hljs-number">.07</span></span><span class="hljs-number"><span class="hljs-number">.24</span></span>) <span class="hljs-number"><span class="hljs-number">92</span></span>: <span class="hljs-number"><span class="hljs-number">93</span></span>: RTSP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-number"><span class="hljs-number">94</span></span>: CSeq: <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">95</span></span>: Date: Fri, Apr <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-number"><span class="hljs-number">2010</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">25</span></span> GMT</code> </pre> <br>  First of all, VLC asks the camera: <br>  - What can I do with you?  (OPTIONS) <br>  - And hello to you.  And can you ask me to do any of OPTIONS, DESCRIBE, SETUP, TEARDOWN, PLAY and PAUSE. <br>  - Okay, then tell me what you have on request "/ jpeg"?  (DESCRIBE) <br>  - Here I have a video of the first track, M-JPEG, and the second track is simple audio. <br>  - It is interesting to look at the video, the first track, pour it to me, please in the pocket number 41760, and you can throw off any husks in the pocket number 41761.  (SETUP track1) <br>  - OK, at your command ... <br>  - And I also want to listen to the sound, a rash in 7878, 7879 pockets.  (SETUP track2) <br>  - No problem. <br>  - Well, sprinkled.  (PLAY) <br>  Over time: <br>  - Okay, enough, I saw enough.  (TEARDOWN) <br>  - As you say. <br><br>  This little lyrical digression ends.  In the first query, " <code>OPTIONS rtsp://192.168.0.254/jpeg RTSP/1.0</code> " reminds " <code>GET /jpeg HTTP/1.1</code> " in the sense that the conversation begins with this, and the HTTP protocol also has an <a href="http://ru.wikipedia.org/wiki/HTTP">OPTIONS</a> method.  Here 192.168.0.254 is the IP address of my camera.  <code>CSeq</code> reflects the sequence number of the request, the response from the server must contain the same <code>CSeq</code> . <br><br>  And the response from the server starts with " <code>RTSP/1.0 200 OK</code> ", this is just like " <code>HTTP/1.1 200 OK</code> " - a sign that everything is fine: the request is accepted, the request is clear and there were no problems with its implementation.  And direct text should list all available methods. <br><br>  Next, we collect information about what awaits us on request / jpeg, because we just followed him and came to the link " <code>rtsp://192.168.0.254/jpeg</code> ".  We also indicate that we want to receive a response in the form of SDP (line 12). <br><br>  In response, we receive an RTSP header indicating the <code>Content-Type</code> and <code>Content-Length</code> , and after the header, the content itself is in the SDP format via the empty string: <br><br><pre> <code class="lua hljs">v=<span class="hljs-number"><span class="hljs-number">0</span></span> o=- <span class="hljs-number"><span class="hljs-number">1272052389382023</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> IN IP4 <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> s=Session streamed by <span class="hljs-string"><span class="hljs-string">"nessyMediaServer"</span></span> i=jpeg t=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> a=tool:LIVE555 Streaming Media v2008<span class="hljs-number"><span class="hljs-number">.04</span></span><span class="hljs-number"><span class="hljs-number">.09</span></span> a=<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>:broadcast a=control:* a=range:npt=<span class="hljs-number"><span class="hljs-number">0</span></span>- a=x-qt-text-nam:Session streamed by <span class="hljs-string"><span class="hljs-string">"nessyMediaServer"</span></span> a=x-qt-text-inf:jpeg m=video <span class="hljs-number"><span class="hljs-number">0</span></span> RTP/AVP <span class="hljs-number"><span class="hljs-number">26</span></span> c=IN IP4 <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> a=control:track1 a=cliprect:<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">720</span></span>,<span class="hljs-number"><span class="hljs-number">1280</span></span> a=framerate:<span class="hljs-number"><span class="hljs-number">25.000000</span></span> m=audio <span class="hljs-number"><span class="hljs-number">7878</span></span> RTP/AVP <span class="hljs-number"><span class="hljs-number">0</span></span> a=rtpmap:<span class="hljs-number"><span class="hljs-number">0</span></span> PCMU/<span class="hljs-number"><span class="hljs-number">8000</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> a=control:track2</code> </pre><br>  Everything is pretty obvious here.  We need the following lines: <br><br><pre> <code class="lua hljs">#   m=video <span class="hljs-number"><span class="hljs-number">0</span></span> RTP/AVP <span class="hljs-number"><span class="hljs-number">26</span></span> #   RTP/AVP,  ,   <span class="hljs-number"><span class="hljs-number">26</span></span>,   Motion-JPEG a=control:track1 #   a=cliprect:<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">720</span></span>,<span class="hljs-number"><span class="hljs-number">1280</span></span> #    a=framerate:<span class="hljs-number"><span class="hljs-number">25.000000</span></span> #       #   m=audio <span class="hljs-number"><span class="hljs-number">7878</span></span> RTP/AVP <span class="hljs-number"><span class="hljs-number">0</span></span> #  <span class="hljs-number"><span class="hljs-number">7878</span></span>,    , <span class="hljs-number"><span class="hljs-number">0</span></span> - PCM a=control:track2 #  </code> </pre><br>  If we want to receive only video, then from the audio data we ignore everything except the name of the track.  We need it to configure the stream, but no one forces us to accept this stream, but the camera refuses to work if the audio is completely ignored (if <code>SETUP</code> done only for the video track). <br><br>  Honestly, I don‚Äôt know how different cameras will react if we neglect the port number for the audio stream (7878), because we specify it with the <code>SETUP</code> command. <br><br>  Next come two <code>SETUP</code> requests, with an indication of the ports to which we would like to receive video and audio streams.  The first number is the port for RTP, the second is for RTCP.  The response of the camera contains information about the ports, you can check them to make sure that everything is configured correctly.  We also need to remember the <code>Session</code> ID.  We will need to specify it in all subsequent calls. <br><br>  After the <code>PLAY</code> command, the transmission of video to port 41760 and audio to port 7878 will begin. And the <code>TEARDOWN</code> command <code>TEARDOWN</code> broadcasting, the connection is broken. <br><br><h5>  MJPEG over RTP </h5><br>  RTP packets come to us, we need to decrypt them.  For this, I will provide here a table of such a package with a description of all the fields. <br><table><tbody><tr><th>  + Bit offset </th><th colspan="2">  0-1 </th><th colspan="1">  2 </th><th colspan="1">  3 </th><th colspan="4">  4-7 </th><th colspan="1">  eight </th><th colspan="7">  9-15 </th><th colspan="16">  16-31 </th></tr><tr><th>  0 </th><td colspan="2">  V </td><td colspan="1">  P </td><td colspan="1">  X </td><td colspan="4">  CC </td><td colspan="1">  M </td><td colspan="7">  PT </td><td colspan="16">  Sequence number </td></tr><tr><th colspan="1">  32 </th><td colspan="32">  Timestamp </td></tr><tr><th>  64 </th><td colspan="32">  SSRC Identifier </td></tr><tr><th>  96 </th><td colspan="32">  ... CSRC Identifiers ... </td></tr><tr><th>  96+ (CC √ó 32) </th><td colspan="16">  Extension Header ID </td><td colspan="16">  Extension Header Length (EHL) </td></tr><tr><th>  96+ (CC √ó 32) + (X √ó 32) </th><td colspan="32">  ... Extension Header ... </td></tr><tr><th>  96+ (CC √ó 32) + (X √ó 32) + (X √ó EHL) </th><td colspan="32">  Payload </td></tr></tbody></table><br><ol><li>  <b>V</b> (Version): (2) protocol version.  Now version number 2. </li><li>  <b>P</b> (Padding, Addition): (1) is used in cases when the RTP packet is supplemented with empty bytes at the end, for example, for encryption algorithms. </li><li>  <b>X</b> (Extension): (1) indicates the presence of an extended header, determined by the application.  In our case, this is not used. </li><li>  <b>CC</b> (CSRC Count): (4) contains the number of CSRC identifiers.  We are also not used. </li><li>  <b>M</b> (Marker): (1) is used at the application level, in our case this bit is set to one if the RTP packet contains the end of a JPEG frame. </li><li>  <b>PT</b> (Payload Type): (7) indicates the format of the payload - the transmitted data.  For MJPEG it is 26. </li><li>  <b>Sequence Number</b> : (16) RTP packet number, used to detect lost packets. </li><li>  <b>Timestamp</b> (32): timestamp, in our case, 90000 hertz (90000 = 1 second). </li><li>  <b>SSRC</b> (Synchronization Source): (32) synchronizer identifier, no matter how funny it would sound.  Specifies the source of the stream. </li><li>  <b>CSRC</b> (Contributing Source): (32) identifiers of additional sources, used when our stream comes from several places. </li><li>  <b>Extension Header ID</b> : (16) an extension identifier, if we have one, we need to know what it is.  In our case, not used. </li><li>  <b>Extension Header Length</b> : (16) is the length of this header in bytes. </li><li>  <b>Extension Header</b> : The header itself.  Content can be very different, depending on context. </li><li>  <b>Payload</b> : The <b>payload</b> is our very JPEG frames.  Fragmented, of course. </li></ol>  Fields starting with CSRC are optional.  To transfer MJPEG from cameras, they are not used, as far as I know. <br><br>  Fast forward to one level of encapsulation.  Now the task is to convert the received video data into a full JPEG image.  In the case of MJPEG over HTTP, everything is simple - we cut a piece of the stream and work with it right away as with a JPEG image.  In the case of RTP, the image is not completely transmitted, the JPEG header is omitted to save traffic.  It must be restored independently from the attached data. <br><br>  The RTP Payload for MJPEG specification is described in <a href="http://tools.ietf.org/html/rfc2435">RFC2435</a> .  I will also give you a table with a description of all the format fields: <br><table><tbody><tr><th>  + Bit offset </th><th colspan="8">  0-7 </th><th colspan="8">  8-15 </th><th colspan="8">  16-23 </th><th colspan="8">  24-31 </th></tr><tr><th>  0 </th><td colspan="8">  Type-specific </td><td colspan="24">  Fragment offset </td></tr><tr><th>  32 </th><td colspan="8">  Type </td><td colspan="8">  Q </td><td colspan="8">  Width </td><td colspan="8">  Height </td></tr><tr><th>  if Type in 64..127 </th><td colspan="32">  Restart marker header </td></tr><tr><th rowspan="2">  if Q in 128..255 </th><td colspan="8">  MBZ </td><td colspan="8">  Precision </td><td colspan="16">  Length </td></tr><tr><td colspan="32">  Quantization Table Data </td></tr></tbody></table><br><ol><li>  <b>Type-specific</b> (depends on type): (8) the meaning of the field depends on the implementation, in our case it does not apply. </li><li>  <b>Fragment Offset</b> : (24) indicates the position of the current frame fragment in the entire frame. </li><li>  <b>Type</b> (Type): (8) depends on the type of how the image is restored. </li><li>  <b>Q</b> (Quality): (8) image quality. </li><li>  <b>Width</b> : (8) frame width. </li><li>  <b>Height</b> : (8) and height. </li><li>  <b>Restart Marker header</b> (RST markers header): (32) is used when decoding JPEG, if RST markers are used.  I do not know if their cameras are using them or not, but I ignore this headline.  This field appears only when Type is from 64 to 127. </li><li>  <b>Quantization Table Data</b> (quantization tables): if they are present, then you do not need to calculate them separately.  And they need to properly recreate images from JPEG data.  If these tables are not correct, then the image will be with wrong colors and contrasts.  There should be two tables: Luma and Chroma for brightness and chromaticity, respectively. </li><li>  <b>MBZ, Precision, Length</b> : (32) parameters of quantization tables, I ignore them, Length set equal to 128 - two tables of 64 bytes each.  Otherwise, I do not know how to work with them. </li></ol>  The header of the RST and quantization tables may not be present.  If there is no first, then very well, since I don‚Äôt count on anything else.  If there is no second, the required tables are calculated based on the parameter Q. <br><br>  The RTCP package contains a certain subset, it is of four types: 201 - source report, 202 - receiver's report, 203 - source description, and 204 - the destination is determined by the application.  We must first take the 201 type, then send the 202 type.  203 and 204 are optional, but I also consider them.  There can be several RTCP packets in a single UDP packet. <br><br>  All types have a similar structure.  Any RTCP packet starts with the following data: <br><table><tbody><tr><th>  + Bit offset </th><th colspan="2">  0-1 </th><th colspan="1">  2 </th><th colspan="5">  3-7 </th><th colspan="8">  8-15 </th><th colspan="16">  16-31 </th></tr><tr><th>  0 </th><td colspan="2">  Version </td><td colspan="1">  Padding </td><td colspan="5">  SC or RC or Subtype </td><td colspan="8">  Packet type </td><td colspan="16">  Length </td></tr></tbody></table><br><ol><li>  <b>Version</b> : (2) RTP version. </li><li>  <b>Padding</b> : (1) the same as for RTP. </li><li>  <b>SC or RC or Subtype</b> : (5) depending on the type may be the number of sources (Sources Count) or the number of recipients (Receivers Count) included in the report of the recipient and the source, respectively.  If this is an APP packet, this field defines the subtype of such packet. </li><li>  <b>Packet Type</b> : (8) packet type, 201 ‚Äî Sender's Report SS, 202 ‚Äî Receiver's Report RR, 203 ‚Äî Source Description SDES, and 204 ‚Äî the destination is determined by the application (APP). </li><li>  <b>Length</b> : (16) The size of the data following the header is measured in 32 bit units. </li></ol>  Further I will not give fields for each subtype, it is possible to look at <a href="http://www.apps.ietf.org/rfc/rfc3550.html">them</a> in <a href="http://www.apps.ietf.org/rfc/rfc3550.html">RFC3550</a> .  Let me just say that the SS and RR types carry information about sent / received packets and time delays.  SDES carries various text fields that define the source, such as its name, email, telephone, location, etc. <br><br>  This introduction ends. <br><br><h4>  Python MJPEG over RTSP client </h4><br>  So we got to the python.  The client consists of several files, <code>main.py</code> contains a callback function that processes the received images, it also launches the mechanisms of the Twisted network framework and stores the connection parameters to the camera.  All the listings I quote are shortened, the full version can be downloaded from the link at the end of the article. <br>  <font color="gray">main.py</font> <br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">20</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(img)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>: <span class="hljs-string"><span class="hljs-string">'This function is invoked by the MJPEG Client protocol'</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span>: <span class="hljs-comment"><span class="hljs-comment"># Process image 23: # Just save it as a file in this example 24: f = open('frame.jpg', 'wb') 25: f.write(img) 26: f.close() 27: 28: def main(): 29: print 'Python M-JPEG Over RSTP Client 0.1' 30: config = {'request': '/jpeg', 31: 'login': '', 32: 'password': 'admin', 33: 'ip': '192.168.0.252', 34: 'port': 554, 35: 'udp_port': 41760, 36: 'callback': processImage} 37: # Prepare RTP MJPEG client (technically it's a server) 38: reactor.listenUDP(config['udp_port'], rtp_mjpeg_client.RTP_MJPEG_Client(config)) 39: reactor.listenUDP(config['udp_port'] + 1, rtcp_client.RTCP_Client()) # RTCP 40: # And RSTP client 41: reactor.connectTCP(config['ip'], config['port'], rtsp_client.RTSPFactory(config)) 42: # Run both of them 43: reactor.run() 44: # On exit: 45: print 'Python M-JPEG Client stopped.'</span></span></code> </pre><br>  In principle, you can work without implementing the RTCP protocol and receiving audio data.  In this case, the camera breaks the connection in about a minute.  You have to reconnect all the time, this is done automatically, so it does not cause problems.  However, for the article I added a part of the RTCP and made a preparation for receiving audio data. <br><br>  The next important file is <code>rtsp_client.py</code> .  He is the most confused, but his goal is obvious - to establish the connection correctly described above. <br>  <font color="gray">rtsp_client.py</font> <br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">012</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RTSPClient</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Protocol)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-number"><span class="hljs-number">013</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">014</span></span>: self.config = {} <span class="hljs-number"><span class="hljs-number">015</span></span>: self.wait_description = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-number"><span class="hljs-number">016</span></span>: <span class="hljs-number"><span class="hljs-number">017</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connectionMade</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">018</span></span>: self.session = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">019</span></span>: <span class="hljs-comment"><span class="hljs-comment"># Authorization part 020: if self.config['login']: 021: authstring = 'Authorization: Basic ' + b64encode(self.config['login']+':'+self.config['password']) + '\r\n' 022: else: 023: authstring = '' 024: # send OPTIONS request 025: to_send = """\ 026: OPTIONS rtsp://""" + self.config['ip'] + self.config['request'] + """ RTSP/1.0\r 027: """ + authstring + """CSeq: 1\r 028: User-Agent: Python MJPEG Client\r 029: \r 030: """ 031: self.transport.write(to_send) 032: if debug: 033: print 'We say:\n', to_send 034: 035: def dataReceived(self, data): 036: if debug: 037: print 'Server said:\n', data 038: # Unify input data 039: data_ln = data.lower().strip().split('\r\n', 5) 040: # Next behaviour is relevant to CSeq 041: # which defines current conversation state 042: if data_ln[0] == 'rtsp/1.0 200 ok' or self.wait_description: 043: # There might be an audio stream 044: if 'audio_track' in self.config: 045: cseq_audio = 1 046: else: 047: cseq_audio = 0 048: to_send = '' 049: if 'cseq: 1' in data_ln: 050: # CSeq 1 -&gt; DESCRIBE 051: to_send = """\ 052: DESCRIBE rtsp://""" + self.config['ip'] + self.config['request'] + """ RTSP/1.0\r 053: CSeq: 2\r 054: Accept: application/sdp\r 055: User-Agent: Python MJPEG Client\r 056: \r 057: """ 058: elif 'cseq: 2' in data_ln or self.wait_description: 059: # CSeq 2 -&gt; Parse SDP and then SETUP 060: data_sp = data.lower().strip().split('\r\n\r\n', 1) 061: # wait_description is used when SDP is sent in another UDP 062: # packet 063: if len(data_sp) == 2 or self.wait_description: 064: # SDP parsing 065: video = audio = False 066: is_MJPEG = False 067: video_track = '' 068: audio_track = '' 069: if len(data_sp) == 2: 070: s = data_sp[1].lower() 071: elif self.wait_description: 072: s = data.lower() 073: for line in s.strip().split('\r\n'): 074: if line.startswith('m=video'): 075: video = True 076: audio = False 077: if line.endswith('26'): 078: is_MJPEG = True 079: if line.startswith('m=audio'): 080: video = False 081: audio = True 082: self.config['udp_port_audio'] = int(line.split(' ')[1]) 083: if video: 084: params = line.split(':', 1) 085: if params[0] == 'a=control': 086: video_track = params[1] 087: if audio: 088: params = line.split(':', 1) 089: if params[0] == 'a=control': 090: audio_track = params[1] 091: if not is_MJPEG: 092: print "Stream", self.config['ip'] + self.config['request'], 'is not an MJPEG stream!' 093: if video_track: self.config['video_track'] = 'rtsp://' + self.config['ip'] + self.config['request'] + '/' + basename(video_track) 094: if audio_track: self.config['audio_track'] = 'rtsp://' + self.config['ip'] + self.config['request'] + '/' + basename(audio_track) 095: to_send = """\ 096: SETUP """ + self.config['video_track'] + """ RTSP/1.0\r 097: CSeq: 3\r 098: Transport: RTP/AVP;unicast;client_port=""" + str(self.config['udp_port']) + """-"""+ str(self.config['udp_port'] + 1) + """\r 099: User-Agent: Python MJPEG Client\r 100: \r 101: """ 102: self.wait_description = False 103: else: 104: # Do not have SDP in the first UDP packet, wait for it 105: self.wait_description = True 106: elif "cseq: 3" in data_ln and 'audio_track' in self.config: 107: # CSeq 3 -&gt; SETUP audio if present 108: self.session = data_ln[5].strip().split(' ')[1] 109: to_send = """\ 110: SETUP """ + self.config['audio_track'] + """ RTSP/1.0\r 111: CSeq: 4\r 112: Transport: RTP/AVP;unicast;client_port=""" + str(self.config['udp_port_audio']) + """-"""+ str(self.config['udp_port_audio'] + 1) + """\r 113: Session: """ + self.session + """\r 114: User-Agent: Python MJPEG Client\r 115: \r 116: """ 117: reactor.listenUDP(self.config['udp_port_audio'], rtp_audio_client.RTP_AUDIO_Client(self.config)) 118: reactor.listenUDP(self.config['udp_port_audio'] + 1, rtcp_client.RTCP_Client()) # RTCP 119: elif "cseq: "+str(3+cseq_audio) in data_ln: 120: # PLAY 121: to_send = """\ 122: PLAY rtsp://""" + self.config['ip'] + self.config['request'] + """/ RTSP/1.0\r 123: CSeq: """ + str(4+cseq_audio) + """\r 124: Session: """ + self.session + """\r 125: Range: npt=0.000-\r 126: User-Agent: Python MJPEG Client\r 127: \r 128: """ 129: elif "cseq: "+str(4+cseq_audio) in data_ln: 130: if debug: 131: print 'PLAY' 132: pass 133: 134: elif "cseq: "+str(5+cseq_audio) in data_ln: 135: if debug: 136: print 'TEARDOWN' 137: pass 138: 139: if to_send: 140: self.transport.write(to_send) 141: if debug: 142: print 'We say:\n', to_send</span></span></code> </pre><br>  In the case of an audio track, this module also runs <code>rtp_audio_client.py</code> and the corresponding RTCP client. <br><br>  After a successful connection, <code>rtp_mjpeg_client.py</code> accepted for <code>rtp_mjpeg_client.py</code> , processing the incoming data stream. <br>  <font color="gray">rtp_mjpeg_client.py</font> <br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">08</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RTP_MJPEG_Client</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(DatagramProtocol)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, config)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>: self.config = config <span class="hljs-number"><span class="hljs-number">11</span></span>: <span class="hljs-comment"><span class="hljs-comment"># Previous fragment sequence number 12: self.prevSeq = -1 13: self.lost_packet = 0 14: # Object that deals with JPEGs 15: self.jpeg = rfc2435jpeg.RFC2435JPEG() 16: 17: def datagramReceived(self, datagram, address): 18: # When we get a datagram, parse it 19: rtp_dg = rtp_datagram.RTPDatagram() 20: rtp_dg.Datagram = datagram 21: rtp_dg.parse() 22: # Check for lost packets 23: if self.prevSeq != -1: 24: if (rtp_dg.SequenceNumber != self.prevSeq + 1) and rtp_dg.SequenceNumber != 0: 25: self.lost_packet = 1 26: self.prevSeq = rtp_dg.SequenceNumber 27: # Handle Payload 28: if rtp_dg.PayloadType == 26: # JPEG compressed video 29: self.jpeg.Datagram = rtp_dg.Payload 30: self.jpeg.parse() 31: # Marker = 1 if we just received the last fragment 32: if rtp_dg.Marker: 33: if not self.lost_packet: 34: # Obtain complete JPEG image and give it to the 35: # callback function 36: self.jpeg.makeJpeg() 37: self.config['callback'](self.jpeg.JpegImage) 38: else: 39: #print "RTP packet lost" 40: self.lost_packet = 0 41: self.jpeg.JpegPayload = ""</span></span></code> </pre><br>  He is easy to understand.  Every time we take another datagram, we parse it using the <code>rtp_datagram.py</code> module, and feed the result to the <code>rfc2435jpeg.py</code> module, which creates a full-fledged JPEG image.  Next, we wait for the appearance of the marker <code>rtp_dg.Marker</code> and how it appears, we call the callback function with the restored image. <br><br>  The RTP datagram parser looks like this: <br>  <font color="gray">rtp_datagram.py</font> <br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">26</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">27</span></span>: Ver_P_X_CC, M_PT, self.SequenceNumber, self.Timestamp, self.SyncSourceIdentifier = unpack(<span class="hljs-string"><span class="hljs-string">'!BBHII'</span></span>, self.Datagram[:<span class="hljs-number"><span class="hljs-number">12</span></span>]) <span class="hljs-number"><span class="hljs-number">28</span></span>: self.Version = (Ver_P_X_CC &amp; <span class="hljs-number"><span class="hljs-number">0b11000000</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">29</span></span>: self.Padding = (Ver_P_X_CC &amp; <span class="hljs-number"><span class="hljs-number">0b00100000</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span>: self.Extension = (Ver_P_X_CC &amp; <span class="hljs-number"><span class="hljs-number">0b00010000</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span>: self.CSRCCount = Ver_P_X_CC &amp; <span class="hljs-number"><span class="hljs-number">0b00001111</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span>: self.Marker = (M_PT &amp; <span class="hljs-number"><span class="hljs-number">0b10000000</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">33</span></span>: self.PayloadType = M_PT &amp; <span class="hljs-number"><span class="hljs-number">0b01111111</span></span> <span class="hljs-number"><span class="hljs-number">34</span></span>: i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">35</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, self.CSRCCount, <span class="hljs-number"><span class="hljs-number">4</span></span>): <span class="hljs-number"><span class="hljs-number">36</span></span>: self.CSRS.append(unpack(<span class="hljs-string"><span class="hljs-string">'!I'</span></span>, self.Datagram[<span class="hljs-number"><span class="hljs-number">12</span></span>+i:<span class="hljs-number"><span class="hljs-number">16</span></span>+i])) <span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.Extension: <span class="hljs-number"><span class="hljs-number">38</span></span>: i = self.CSRCCount * <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">39</span></span>: (self.ExtensionHeaderID, self.ExtensionHeaderLength) = unpack(<span class="hljs-string"><span class="hljs-string">'!HH'</span></span>, self.Datagram[<span class="hljs-number"><span class="hljs-number">12</span></span>+i:<span class="hljs-number"><span class="hljs-number">16</span></span>+i]) <span class="hljs-number"><span class="hljs-number">40</span></span>: self.ExtensionHeader = self.Datagram[<span class="hljs-number"><span class="hljs-number">16</span></span>+i:<span class="hljs-number"><span class="hljs-number">16</span></span>+i+self.ExtensionHeaderLength] <span class="hljs-number"><span class="hljs-number">41</span></span>: i += <span class="hljs-number"><span class="hljs-number">4</span></span> + self.ExtensionHeaderLength <span class="hljs-number"><span class="hljs-number">42</span></span>: self.Payload = self.Datagram[<span class="hljs-number"><span class="hljs-number">12</span></span>+i:]</code> </pre><br>  The JPEG recovery module is quite large, as it contains several tables and a rather long function for generating a header.  Therefore, I will omit them here, providing only the functions of parsing the RTP payload and creating the final JPEG image. <br>  <font color="gray">rfc2435jpeg.py</font> <br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">287</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">288</span></span>: HOffset = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">289</span></span>: LOffset = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">290</span></span>: <span class="hljs-comment"><span class="hljs-comment"># Straightforward parsing 291: (self.TypeSpecific, 292: HOffset, #3 byte offset 293: LOffset, 294: self.Type, 295: self.Q, 296: self.Width, 297: self.Height) = unpack('!BBHBBBB', self.Datagram[:8]) 298: self.Offest = (HOffset &lt;&lt; 16) + LOffset 299: self.Width = self.Width &lt;&lt; 3 300: self.Height = self.Height &lt;&lt; 3 301: 302: # Check if we have Restart Marker header 303: if 64 &lt;= self.Type &lt;= 127: 304: # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> make use of that header 305: self.RM_Header = self.Datagram[8:12] 306: rm_i = 4 # Make offset for JPEG Header 307: else: 308: rm_i = 0 309: 310: # Check if we have Quantinization Tables embedded into JPEG Header 311: # Only the first fragment will have it 312: if self.Q &gt; 127 and not self.JpegPayload: 313: self.JpegPayload = self.Datagram[rm_i+8+132:] 314: QT_Header = self.Datagram[rm_i+8:rm_i+140] 315: (self.QT_MBZ, 316: self.QT_Precision, 317: self.QT_Length) = unpack('!BBH', QT_Header[:4]) 318: self.QT_luma = string2list(QT_Header[4:68]) 319: self.QT_chroma = string2list(QT_Header[68:132]) 320: else: 321: self.JpegPayload += self.Datagram[rm_i+8:] 322: # Clear tables. Q might be dynamic. 323: if self.Q &lt;= 127: 324: self.QT_luma = [] 325: self.QT_chroma = [] 326: 327: def makeJpeg(self): 328: lqt = [] 329: cqt = [] 330: dri = 0 331: # Use exsisting tables or generate ours 332: if self.QT_luma: 333: lqt=self.QT_luma 334: cqt=self.QT_chroma 335: else: 336: MakeTables(self.Q,lqt,cqt) 337: JPEGHdr = [] 338: # Make a complete JPEG header 339: MakeHeaders(JPEGHdr, self.Type, int(self.Width), int(self.Height), lqt, cqt, dri) 340: self.JpegHeader = list2string(JPEGHdr) 341: # And a complete JPEG image 342: self.JpegImage = self.JpegHeader + self.JpegPayload 343: self.JpegPayload = '' 344: self.JpegHeader = '' 345: self.Datagram = ''</span></span></code> </pre><br>  I also implemented the <code>rtp_audio_client.py</code> audio data receiving module, but did not convert them into playable data.  If it will be necessary for someone, I made a sketch in this file how everything should be.  It is only necessary to organize parsing on the similarity of <code>rfc2435jpeg.py</code> .  Audio data is easier as it is not fragmented.  Each package carries enough data to play.  I will not give this module here, since the article is already very long (Habrafold would quickly realize it). <br><br>  To work correctly, we need to accept and send RTCP packets, accept Sender's Reports, send Receiver's Reports.  To simplify the task, we will send our RR immediately after receiving SR from the camera and we will lay in them idealized data that everything is fine. <br>  <font color="gray">rtcp_client.py</font> <br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">09</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RTCP_Client</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(DatagramProtocol)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>: <span class="hljs-comment"><span class="hljs-comment"># Object that deals with RTCP datagrams 12: self.rtcp = rtcp_datagram.RTCPDatagram() 13: def datagramReceived(self, datagram, address): 14: # SSRC Report received 15: self.rtcp.Datagram = datagram 16: self.rtcp.parse() 17: # Send back our Receiver Report 18: # saying that everything is fine 19: RR = self.rtcp.generateRR() 20: self.transport.write(RR, address)</span></span></code> </pre><br>  But the module works directly with RTCP datagrams.  It was also quite large. <br>  <font color="gray">rtcp_datagram.py</font> <br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">049</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-number"><span class="hljs-number">050</span></span>: <span class="hljs-comment"><span class="hljs-comment"># RTCP parsing is complete 051: # including SDES, BYE and APP 052: # RTCP Header 053: (Ver_P_RC, 054: PacketType, 055: Length) = unpack('!BBH', self.Datagram[:4]) 056: Version = (Ver_P_RC &amp; 0b11000000) &gt;&gt; 6 057: Padding = (Ver_P_RC &amp; 0b00100000) &gt;&gt; 5 058: # Byte offset 059: off = 4 060: # Sender's Report 061: if PacketType == 200: 062: # Sender's information 063: (self.SSRC_sender, 064: self.NTP_TimestampH, 065: self.NTP_TimestampL, 066: self.RTP_Timestamp, 067: self.SenderPacketCount, 068: self.SenderOctetCount) = unpack('!IIIIII', self.Datagram[off: off + 24]) 069: off += 24 070: ReceptionCount = Ver_P_RC &amp; 0b00011111 071: if debug: 072: print 'SDES: SR from', str(self.SSRC_sender) 073: # Included Receiver Reports 074: self.Reports = [] 075: i = 0 076: for i in range(ReceptionCount): 077: self.Reports.append(Report()) 078: self.Reports[i].SSRC, 079: self.Reports[i].FractionLost, 080: self.Reports[i].CumulativeNumberOfPacketsLostH, 081: self.Reports[i].CumulativeNumberOfPacketsLostL, 082: self.Reports[i].ExtendedHighestSequenceNumberReceived, 083: self.Reports[i].InterarrivalJitter, 084: self.Reports[i].LastSR, 085: self.Reports[i].DelaySinceLastSR = unpack('!IBBHIIII', self.Datagram[off: off + 24]) 086: off += 24 087: # Source Description (SDES) 088: elif PacketType == 202: 089: # RC now is SC 090: SSRCCount = Ver_P_RC &amp; 0b00011111 091: self.SourceDescriptions = [] 092: i = 0 093: for i in range(SSRCCount): 094: self.SourceDescriptions.append(SDES()) 095: SSRC, = unpack('!I', self.Datagram[off: off + 4]) 096: off += 4 097: self.SourceDescriptions[i].SSRC = SSRC 098: SDES_Item = -1 099: # Go on the list of descriptions 100: while SDES_Item != 0: 101: SDES_Item, = unpack('!B', self.Datagram[off]) 102: off += 1 103: if SDES_Item != 0: 104: SDES_Length, = unpack('!B', self.Datagram[off]) 105: off += 1 106: Value = self.Datagram[off: off + SDES_Length] 107: off += SDES_Length 108: if debug: 109: print 'SDES:', SDES_Item, Value 110: if SDES_Item == 1: 111: self.SourceDescriptions[i].CNAME = Value 112: elif SDES_Item == 2: 113: self.SourceDescriptions[i].NAME = Value 114: elif SDES_Item == 3: 115: self.SourceDescriptions[i].EMAIL = Value 116: elif SDES_Item == 4: 117: self.SourceDescriptions[i].PHONE = Value 118: elif SDES_Item == 5: 119: self.SourceDescriptions[i].LOC = Value 120: elif SDES_Item == 6: 121: self.SourceDescriptions[i].TOOL = Value 122: elif SDES_Item == 7: 123: self.SourceDescriptions[i].NOTE = Value 124: elif SDES_Item == 8: 125: self.SourceDescriptions[i].PRIV = Value 126: # Extra parsing for PRIV is needed 127: elif SDES_Item == 0: 128: # End of list. Padding to 32 bits 129: while (off % 4): 130: off += 1 131: # BYE Packet 132: elif PacketType == 203: 133: SSRCCount = Ver_P_RC &amp; 0b00011111 134: i = 0 135: for i in range(SSRCCount): 136: SSRC, = unpack('!I', self.Datagram[off: off + 4]) 137: off += 4 138: print 'SDES: SSRC ' + str(SSRC) + ' is saying goodbye.' 139: # Application specific packet 140: elif PacketType == 204: 141: Subtype = Ver_P_RC &amp; 0b00011111 142: SSRC, = unpack('!I', self.Datagram[off: off + 4]) 143: Name = self.Datagram[off + 4: off + 8] 144: AppData = self.Datagram[off + 8: off + Length] 145: print 'SDES: APP Packet "' + Name + '" from SSRC ' + str(SSRC) + '.' 146: off += Length 147: # Check if there is something else in the datagram 148: if self.Datagram[off:]: 149: self.Datagram = self.Datagram[off:] 150: self.parse() 151: 152: def generateRR(self): 153: # Ver 2, Pad 0, RC 1 154: Ver_P_RC = 0b10000001 155: # PT 201, Length 7, SSRC 0xF00F - let it be our ID 156: Header = pack('!BBHI', Ver_P_RC, 201, 7, 0x0000F00F) 157: NTP_32 = (self.NTP_TimestampH &amp; 0x0000FFFF) + ((self.NTP_TimestampL &amp; 0xFFFF0000) &gt;&gt; 16) 158: # No lost packets, no delay in receiving data, RR sent right after receiving SR 159: # Instead of self.SenderPacketCount should be proper value 160: ReceiverReport = pack('!IBBHIIII', self.SSRC_sender, 0, 0, 0, self.SenderPacketCount, 1, NTP_32, 1) 161: return Header + ReceiverReport</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parsing strictly according to RFC. </font><font style="vertical-align: inherit;">I use the function </font></font><code>unpack</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to convert data into numerical variables, I move through the data array using a variable </font></font><code>off</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that contains the current offset. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is the link: </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python MJPEG over RTSP client</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There was no power to make a version of listings with Russian comments, so forgive me if it is not so convenient for anyone.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It is useful to read </font></font></h4><ol><li> <a href="https://prof.hti.bfh.ch/myf1/www/projects/polyphem/www/documents/projectwork-techreport-mediainternet.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multimedia over the Internet</font></font></a> </li><li> <a href="http://en.wikipedia.org/wiki/RTP_audio_video_profile"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">List of RTP profiles for audio and video</font></font></a> </li></ol><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> On this article the end, and who mastered - well done! </font></font></div><p>Source: <a href="https://habr.com/ru/post/117735/">https://habr.com/ru/post/117735/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../117727/index.html">Installing your own root certificate on Android and running Citrix XenApp Web Interface</a></li>
<li><a href="../117729/index.html">Bryansk Web Day 2011</a></li>
<li><a href="../117732/index.html">How to assemble a copter (flying platform) in 2 hours</a></li>
<li><a href="../117733/index.html">Video blogger Oleg Kozyrev joins other popular bloggers in using Creative Commons licenses</a></li>
<li><a href="../117734/index.html">Chinese typewriter</a></li>
<li><a href="../117736/index.html">Mobile Shopping List</a></li>
<li><a href="../117737/index.html">What hosting do you use for your open source development? (you can specify several options)</a></li>
<li><a href="../117738/index.html">The Pirate Bay promotes new file sharing service</a></li>
<li><a href="../117739/index.html">A library for working with the Yandex.Money API and a demo Android application</a></li>
<li><a href="../117740/index.html">Yahoo is rolling back its policy on storing user information</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>