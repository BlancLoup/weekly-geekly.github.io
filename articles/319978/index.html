<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Akso HTTP WebSocket in practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For quite a long time there was only one worthy implementation of working with HTTP over Akka - spray . To this library, a couple of craftsmen have wr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Akso HTTP WebSocket in practice</h1><div class="post__text post__text-html js-mediator-article">  For quite a long time there was only one worthy implementation of working with HTTP over Akka - <a href="http://spray.io/">spray</a> .  To this library, a couple of craftsmen have written extensions for WebSocket, <br>  which was quite understandable in use and there were no problems.  But years went by and spray, in one form or another, migrated to Akka HTTP with implemented WebSocket support out of the box. <br>  To work with WebSocket, the guys from Akka suggest that we use the Akka Stream, thereby simplifying our life with streaming data and, at the same time, complicating it.  Akka Stream is not so easy to understand.  Next, I will try to show basic practical examples of use. <br><a name="habracut"></a><br><h3>  Akka Stream in brief </h3><br>  This is a kind of data processing pipeline, each iteration of which does something with the data falling into it.  Flow is divided into 3 components: Source, GraphStage, Sink. <br>  This is best shown in the diagram from the documentation. <br><img src="https://habrastorage.org/getpro/habr/post_images/09e/d35/3d6/09ed353d6d5f844a0ef8d4c7cc49a5ef.png" alt="image"><br><br>  To implement WebSocket, we need to implement GraphStag.  Source gives us akka, this is exactly our client with messages flying from him.  And Sink is the sending of our messages to the client. <br><br><h3>  Actor style </h3><br>  Perhaps one of the most inefficient methods of processing, but the easiest to understand. <br>  His idea is that all incoming messages get into the actor, and he had <i>ActorRef</i> , which sent the data directly to the client. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> akka.actor.{<span class="hljs-type"><span class="hljs-type">Actor</span></span>, <span class="hljs-type"><span class="hljs-type">ActorLogging</span></span>, <span class="hljs-type"><span class="hljs-type">ActorRef</span></span>, <span class="hljs-type"><span class="hljs-type">ActorSystem</span></span>, <span class="hljs-type"><span class="hljs-type">Props</span></span>, <span class="hljs-type"><span class="hljs-type">Terminated</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> akka.http.scaladsl.<span class="hljs-type"><span class="hljs-type">Http</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> akka.http.scaladsl.model.ws._ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> akka.stream.{<span class="hljs-type"><span class="hljs-type">ActorMaterializer</span></span>, <span class="hljs-type"><span class="hljs-type">OverflowStrategy</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> akka.stream.scaladsl._ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> akka.http.scaladsl.server.<span class="hljs-type"><span class="hljs-type">Directives</span></span>._ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> scala.io.<span class="hljs-type"><span class="hljs-type">StdIn</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Boot</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> system = <span class="hljs-type"><span class="hljs-type">ActorSystem</span></span>(<span class="hljs-string"><span class="hljs-string">"example"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> materializer = <span class="hljs-type"><span class="hljs-type">ActorMaterializer</span></span>() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flow</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Flow</span></span>[<span class="hljs-type"><span class="hljs-type">Message</span></span>, <span class="hljs-type"><span class="hljs-type">Message</span></span>, <span class="hljs-type"><span class="hljs-type">Any</span></span>] = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> client = system.actorOf(<span class="hljs-type"><span class="hljs-type">Props</span></span>(classOf[<span class="hljs-type"><span class="hljs-type">ClientConnectionActor</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> in = <span class="hljs-type"><span class="hljs-type">Sink</span></span>.actorRef(client, <span class="hljs-symbol"><span class="hljs-symbol">'sinkclose</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> out = <span class="hljs-type"><span class="hljs-type">Source</span></span>.actorRef(<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-type"><span class="hljs-type">OverflowStrategy</span></span>.fail).mapMaterializedValue { a ‚áí client ! (<span class="hljs-symbol"><span class="hljs-symbol">'income</span></span> ‚Üí a) a } <span class="hljs-type"><span class="hljs-type">Flow</span></span>.fromSinkAndSource(in, out) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> route = path(<span class="hljs-string"><span class="hljs-string">"ws"</span></span>)(handleWebSocketMessages(flow)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> bindingFuture = <span class="hljs-type"><span class="hljs-type">Http</span></span>().bindAndHandle(route, <span class="hljs-string"><span class="hljs-string">"localhost"</span></span>, <span class="hljs-number"><span class="hljs-number">8080</span></span>) println(<span class="hljs-string"><span class="hljs-string">s"Server online at http://localhost:8080/\nPress RETURN to stop..."</span></span>) <span class="hljs-type"><span class="hljs-type">StdIn</span></span>.readLine() <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> system.dispatcher bindingFuture .flatMap(_.unbind()) .onComplete(_ ‚áí system.terminate()) } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClientConnectionActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Actor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connection: <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">ActorRef</span></span>] = <span class="hljs-type"><span class="hljs-type">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> receive: <span class="hljs-type"><span class="hljs-type">Receive</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (<span class="hljs-symbol"><span class="hljs-symbol">'income</span></span>, a: <span class="hljs-type"><span class="hljs-type">ActorRef</span></span>) ‚áí connection = <span class="hljs-type"><span class="hljs-type">Some</span></span>(a); context.watch(a) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Terminated</span></span>(a) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> connection.contains(a) ‚áí connection = <span class="hljs-type"><span class="hljs-type">None</span></span>; context.stop(self) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'sinkclose</span></span> ‚áí context.stop(self) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">TextMessage</span></span>.<span class="hljs-type"><span class="hljs-type">Strict</span></span>(t) ‚áí connection.foreach(_ ! <span class="hljs-type"><span class="hljs-type">TextMessage</span></span>.<span class="hljs-type"><span class="hljs-type">Strict</span></span>(<span class="hljs-string"><span class="hljs-string">s"echo </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$t</span></span></span><span class="hljs-string">"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> _ ‚áí <span class="hljs-comment"><span class="hljs-comment">// ingone } override def postStop(): Unit = connection.foreach(context.stop) }</span></span></code> </pre> <br>  For each client connection, we create the <i>ClientConnectionActor</i> actor.  And also <i>Source</i> , which will be another actor that sends the received messages to flow.  After its creation through the <i>mapMaterializedValue</i> method <i>,</i> we will get a link to it.  In addition, we create a <i>Sink</i> , which will send all messages to <i>ClientConnectionActor</i> . <br><br>  Thus, <i>ClientConnectionActor</i> will receive all messages from the socket.  We will send them through the <i>ActorRef</i> that has arrived to him, which will deliver them to the client. <br><br>  Cons: it is necessary to monitor the side actors;  be careful with <i>OverflowStrategy</i> ;  we have only one actor for processing all messages, it is, respectively, single-threaded, which can cause performance problems. <br><br>  We will not consider the derivative using <i>ActorPublisher</i> and <i>ActorSubscriber</i> , since, judging by the official documentation, it is <s>deprecated</s> . <br><br><h3>  Flow style </h3><br>  The idea of ‚Äã‚Äãthis approach is to fully use the Akka Stream to achieve the goals.  The general view of it comes down to building a pipeline processing incoming client messages. <br><br><div class="spoiler">  <b class="spoiler_title">Skeleton</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> akka.actor.<span class="hljs-type"><span class="hljs-type">ActorSystem</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> akka.http.scaladsl.<span class="hljs-type"><span class="hljs-type">Http</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> akka.http.scaladsl.model.ws._ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> akka.stream.<span class="hljs-type"><span class="hljs-type">ActorMaterializer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> akka.stream.scaladsl._ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> akka.http.scaladsl.server.<span class="hljs-type"><span class="hljs-type">Directives</span></span>._ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> scala.io.<span class="hljs-type"><span class="hljs-type">StdIn</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Boot</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> system = <span class="hljs-type"><span class="hljs-type">ActorSystem</span></span>(<span class="hljs-string"><span class="hljs-string">"example"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> materializer = <span class="hljs-type"><span class="hljs-type">ActorMaterializer</span></span>() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flow</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Flow</span></span>[<span class="hljs-type"><span class="hljs-type">Message</span></span>, <span class="hljs-type"><span class="hljs-type">Message</span></span>, <span class="hljs-type"><span class="hljs-type">Any</span></span>] = { <span class="hljs-type"><span class="hljs-type">Flow</span></span>[<span class="hljs-type"><span class="hljs-type">Message</span></span>].collect { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">TextMessage</span></span>.<span class="hljs-type"><span class="hljs-type">Strict</span></span>(t) ‚áí t }.map { text ‚áí <span class="hljs-type"><span class="hljs-type">TextMessage</span></span>.<span class="hljs-type"><span class="hljs-type">Strict</span></span>(<span class="hljs-string"><span class="hljs-string">s"echo: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$text</span></span></span><span class="hljs-string">"</span></span>) } } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> route = path(<span class="hljs-string"><span class="hljs-string">"ws"</span></span>)(handleWebSocketMessages(flow)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> bindingFuture = <span class="hljs-type"><span class="hljs-type">Http</span></span>().bindAndHandle(route, <span class="hljs-string"><span class="hljs-string">"localhost"</span></span>, <span class="hljs-number"><span class="hljs-number">8080</span></span>) println(<span class="hljs-string"><span class="hljs-string">s"Server online at http://localhost:8080/\nPress RETURN to stop..."</span></span>) <span class="hljs-type"><span class="hljs-type">StdIn</span></span>.readLine() <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> system.dispatcher bindingFuture .flatMap(_.unbind()) .onComplete(_ ‚áí system.terminate()) }</code> </pre><br>  In this case, we process only text messages and modify them.  Next <i>TextMessage is</i> sent to the client. <br><br></div></div><br>  Now let's make the skeleton a bit more complicated and add parsing and JSON serialization. <br><br><div class="spoiler">  <b class="spoiler_title">Classes for serialization</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsIncome</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsOutgoing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">@JsonCodec</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Say</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsIncome</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsOutgoing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implicit</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsIncomeDecoder</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Decoder</span></span>[<span class="hljs-type"><span class="hljs-type">WsIncome</span></span>] = <span class="hljs-type"><span class="hljs-type">Decoder</span></span>[<span class="hljs-type"><span class="hljs-type">Say</span></span>].map[<span class="hljs-type"><span class="hljs-type">WsIncome</span></span>](identity) <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-type"><span class="hljs-type">WsOutgoingEncoder</span></span>: <span class="hljs-type"><span class="hljs-type">Encoder</span></span>[<span class="hljs-type"><span class="hljs-type">WsOutgoing</span></span>] = { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s: <span class="hljs-type"><span class="hljs-type">Say</span></span> ‚áí s.asJson }</code> </pre><br></div></div><br>  Modify flow <br><br><pre> <code class="scala hljs"><span class="hljs-type"><span class="hljs-type">Flow</span></span>[<span class="hljs-type"><span class="hljs-type">Message</span></span>] .collect { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> tm: <span class="hljs-type"><span class="hljs-type">TextMessage</span></span> ‚áí tm.textStream } .mapAsync(<span class="hljs-type"><span class="hljs-type">CORE_COUNT</span></span> * <span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>)(in ‚áí in.runFold(<span class="hljs-string"><span class="hljs-string">""</span></span>)(_ + _).flatMap(in ‚áí <span class="hljs-type"><span class="hljs-type">Future</span></span>.fromTry(parse(in).toTry.flatMap(_.as[<span class="hljs-type"><span class="hljs-type">WsIncome</span></span>].toTry)))) .collect { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Say</span></span>(name) ‚áí <span class="hljs-type"><span class="hljs-type">Say</span></span>(<span class="hljs-string"><span class="hljs-string">s"hello: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$name</span></span></span><span class="hljs-string">"</span></span>) } .mapAsync(<span class="hljs-type"><span class="hljs-type">CORE_COUNT</span></span> * <span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>)(out ‚áí <span class="hljs-type"><span class="hljs-type">Future</span></span>(<span class="hljs-type"><span class="hljs-type">TextMessage</span></span>(out.asJson.noSpaces)))</code> </pre><br>  First, we cut off all binary messages, then parse the incoming stream into JSON, process it and serialize it into text for sending to the client. <br><br>  Complicate the design by adding context to each client.  This will help us <i>statefulMapConcat</i> . <br><br><div class="spoiler">  <b class="spoiler_title">Clientcontext</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClientContext</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userName: <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] = <span class="hljs-type"><span class="hljs-type">None</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClientContext</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unapply</span></span></span></span>(arg: <span class="hljs-type"><span class="hljs-type">ClientContext</span></span>): <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>] = arg.userName } <span class="hljs-meta"><span class="hljs-meta">@JsonCodec</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SetName</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsIncome</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">@JsonCodec</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Say</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">text: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsIncome</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsOutgoing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implicit</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsIncomeDecoder</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Decoder</span></span>[<span class="hljs-type"><span class="hljs-type">WsIncome</span></span>] = <span class="hljs-type"><span class="hljs-type">Decoder</span></span>[<span class="hljs-type"><span class="hljs-type">Say</span></span>].map[<span class="hljs-type"><span class="hljs-type">WsIncome</span></span>](identity) .or(<span class="hljs-type"><span class="hljs-type">Decoder</span></span>[<span class="hljs-type"><span class="hljs-type">SetName</span></span>].map[<span class="hljs-type"><span class="hljs-type">WsIncome</span></span>](identity))</code> </pre><br></div></div><br><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flow</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Flow</span></span>[<span class="hljs-type"><span class="hljs-type">Message</span></span>, <span class="hljs-type"><span class="hljs-type">Message</span></span>, <span class="hljs-type"><span class="hljs-type">Any</span></span>] = { <span class="hljs-type"><span class="hljs-type">Flow</span></span>[<span class="hljs-type"><span class="hljs-type">Message</span></span>] .collect { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> tm: <span class="hljs-type"><span class="hljs-type">TextMessage</span></span> ‚áí tm.textStream } .mapAsync(<span class="hljs-type"><span class="hljs-type">CORE_COUNT</span></span> * <span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>)(in ‚áí in.runFold(<span class="hljs-string"><span class="hljs-string">""</span></span>)(_ + _).flatMap(in ‚áí <span class="hljs-type"><span class="hljs-type">Future</span></span>.fromTry(parse(in).toTry.flatMap(_.as[<span class="hljs-type"><span class="hljs-type">WsIncome</span></span>].toTry)))) .statefulMapConcat(() ‚áí { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">ClientContext</span></span> m ‚áí (context ‚Üí m) :: <span class="hljs-type"><span class="hljs-type">Nil</span></span> }) .mapConcat { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (c: <span class="hljs-type"><span class="hljs-type">ClientContext</span></span>, <span class="hljs-type"><span class="hljs-type">SetName</span></span>(name)) ‚áí c.userName = <span class="hljs-type"><span class="hljs-type">Some</span></span>(name) <span class="hljs-type"><span class="hljs-type">Nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> a ‚áí a :: <span class="hljs-type"><span class="hljs-type">Nil</span></span> } .collect { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (<span class="hljs-type"><span class="hljs-type">ClientContext</span></span>(userName), <span class="hljs-type"><span class="hljs-type">Say</span></span>(text)) ‚áí <span class="hljs-type"><span class="hljs-type">Say</span></span>(<span class="hljs-string"><span class="hljs-string">s"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$userName</span></span></span><span class="hljs-string">: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$text</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (_, <span class="hljs-type"><span class="hljs-type">Say</span></span>(text)) ‚áí <span class="hljs-type"><span class="hljs-type">Say</span></span>(<span class="hljs-string"><span class="hljs-string">s"unknown: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$text</span></span></span><span class="hljs-string">"</span></span>) } .mapAsync(<span class="hljs-type"><span class="hljs-type">CORE_COUNT</span></span> * <span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>)(out ‚áí <span class="hljs-type"><span class="hljs-type">Future</span></span>(<span class="hljs-type"><span class="hljs-type">TextMessage</span></span>(out.asJson.noSpaces))) }</code> </pre><br>  There is another way: you can implement your filter / map by inheriting <i>GraphStage [FlowShape [A, A]]</i> . <br><br><div class="spoiler">  <b class="spoiler_title">Example (not adapted for the previous code)</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthFilter</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">auth: ws.</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">AuthMessage</span></span></span></span><span class="hljs-class"><span class="hljs-params"> ‚áí </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Future</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Option</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">UserProfile</span></span></span></span><span class="hljs-class"><span class="hljs-params">]]</span></span></span><span class="hljs-class">)(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit ec: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ExecutionContext</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GraphStage</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FlowShape</span></span></span><span class="hljs-class">[ws.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WsIncomeMessage</span></span></span><span class="hljs-class">, ws.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WsContextIncomeMessage</span></span></span><span class="hljs-class">]] </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> in = <span class="hljs-type"><span class="hljs-type">Inlet</span></span>[ws.<span class="hljs-type"><span class="hljs-type">WsIncomeMessage</span></span>](<span class="hljs-string"><span class="hljs-string">"AuthFilter.in"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> out = <span class="hljs-type"><span class="hljs-type">Outlet</span></span>[ws.<span class="hljs-type"><span class="hljs-type">WsContextIncomeMessage</span></span>](<span class="hljs-string"><span class="hljs-string">"AuthFilter.out"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> shape = <span class="hljs-type"><span class="hljs-type">FlowShape</span></span>.of(in, out) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createLogic</span></span></span></span>(inheritedAttributes: <span class="hljs-type"><span class="hljs-type">Attributes</span></span>): <span class="hljs-type"><span class="hljs-type">GraphStageLogic</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">GraphStageLogic</span></span>(shape) { <span class="hljs-meta"><span class="hljs-meta">@volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> profile: <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">UserProfile</span></span>] = <span class="hljs-type"><span class="hljs-type">None</span></span> setHandler(in, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">InHandler</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPush</span></span></span></span>(): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = profile <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Some</span></span>(p) ‚áí push(out, ws.<span class="hljs-type"><span class="hljs-type">WsContextIncomeMessage</span></span>(p, grab(in))) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> _ ‚áí grab(in) <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> a: ws.<span class="hljs-type"><span class="hljs-type">AuthMessage</span></span> ‚áí auth(a) onComplete { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Success</span></span>(p) ‚áí profile = p pull(in) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span>(e) ‚áí fail(out, e) } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> _ ‚áí pull(in) } } }) setHandler(out, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">OutHandler</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPull</span></span></span></span>(): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = pull(in) }) } } }</code> </pre><br>  In this embodiment, all messages are filtered until an authorization message is received.  If the authorization is successful, the messages are passed on along with the user profile. <br></div></div><br>  And finally, we will do so that to all connected users the current time is sent every second: <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Tick</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsOutgoing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implicit</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WsOutgoingEncoder</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Encoder</span></span>[<span class="hljs-type"><span class="hljs-type">WsOutgoing</span></span>] = { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s: <span class="hljs-type"><span class="hljs-type">Say</span></span> ‚áí s.asJson <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Tick</span></span> ‚áí <span class="hljs-type"><span class="hljs-type">Json</span></span>.obj(<span class="hljs-string"><span class="hljs-string">"time"</span></span> ‚Üí <span class="hljs-type"><span class="hljs-type">DateTime</span></span>.now.toIsoDateTimeString().asJson) } ... <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> broadcast = <span class="hljs-type"><span class="hljs-type">Source</span></span>.tick[<span class="hljs-type"><span class="hljs-type">WsOutgoing</span></span>](<span class="hljs-number"><span class="hljs-number">1.</span></span>second, <span class="hljs-number"><span class="hljs-number">1.</span></span>second, <span class="hljs-type"><span class="hljs-type">Tick</span></span>) ... .collect { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (<span class="hljs-type"><span class="hljs-type">ClientContext</span></span>(userName), <span class="hljs-type"><span class="hljs-type">Say</span></span>(text)) ‚áí <span class="hljs-type"><span class="hljs-type">Say</span></span>(<span class="hljs-string"><span class="hljs-string">s"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$userName</span></span></span><span class="hljs-string">: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$text</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (_, <span class="hljs-type"><span class="hljs-type">Say</span></span>(text)) ‚áí <span class="hljs-type"><span class="hljs-type">Say</span></span>(<span class="hljs-string"><span class="hljs-string">s"unknown: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$text</span></span></span><span class="hljs-string">"</span></span>) } .merge(broadcast) .mapAsync(<span class="hljs-type"><span class="hljs-type">CORE_COUNT</span></span> * <span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>)(out ‚áí <span class="hljs-type"><span class="hljs-type">Future</span></span>(<span class="hljs-type"><span class="hljs-type">TextMessage</span></span>(out.asJson.noSpaces)))</code> </pre><br>  These are basic examples of how you can implement WebSocket support in your project.  The Akka Stream package is large and diverse, it will help to solve a rather large layer of tasks, without worrying about scaling and parallelization. <br><br>  <b>PS:</b> Using a new technology for you in a more or less loaded project, do not forget to carry out load testing, monitor memory and hot parts of the code ( <a href="http://gatling.io/">gatling</a> can help you with this).  All good. </div><p>Source: <a href="https://habr.com/ru/post/319978/">https://habr.com/ru/post/319978/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319966/index.html">As I parsed the entire database of Metacritic games</a></li>
<li><a href="../319968/index.html">Master Tarantool 1.6</a></li>
<li><a href="../319970/index.html">Welcome aboard: application guidance tips</a></li>
<li><a href="../319974/index.html">Soccer ball and fullerenes</a></li>
<li><a href="../319976/index.html">Sooo long whole</a></li>
<li><a href="../319980/index.html">How SEO-agency spent 600 thousand rubles. on advertising and what came of it</a></li>
<li><a href="../319982/index.html">Creating a native watchface for Gear S3 / S2</a></li>
<li><a href="../319984/index.html">Is your service RESTful? All you need / need to know about web services and REST</a></li>
<li><a href="../319986/index.html">Windows 10 Creators Update: Increased Security and Advanced IT Tools</a></li>
<li><a href="../319988/index.html">Lessons of the year to combat information security breaches</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>