<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk: DND mode on the BLF key</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As part of Asterisk's adaptation to the needs of superiors and their secretaries, I was puzzled by the indication of the DND mode (‚ÄúDo Not Disturb‚Äù - ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk: DND mode on the BLF key</h1><div class="post__text post__text-html js-mediator-article"> As part of Asterisk's adaptation to the needs of superiors and their secretaries, I was puzzled by the indication of the DND mode (‚ÄúDo Not Disturb‚Äù - ‚ÄúDo Not Disturb‚Äù) on the BLF (Busy Lamp Field) keys.  On Habr√© there was a corresponding <a href="http://habrahabr.ru/post/155899/">post</a> (and in the commentary there is also a useful link to the alternate method). <br><br>  ‚ÄúDnD is a rather demanded function, but usually the mode is turned on on the phone itself, without notifying Asterisk about it, which will call the user‚Äôs phone, thinking that it‚Äôs in place and ready to answer the call.  How do we turn on the DnD mode on Asterisk itself and so that the power button will blink in red when DnD is activated? ¬ª¬© <a href="https://habrahabr.ru/users/xtelekom/" class="user_link">xtelekom</a> <br><br>  However, it was not possible just to take and start using DND on the BLF. <br><a name="habracut"></a><br>  1. The first method at first glance looks difficult.  Without a detailed explanation, it is difficult to use the code in school, but in production it is scary.  As shown by further research, you can get by with less code. <br>  2. The red light should not blink (the subscriber is called, he does not pick up the phone, maybe you need to intercept the call?), But constantly on (the subscriber is busy). <br>  3. In the second method, checking the current state of the DND always returned <code>true</code> .  Naturally, the method did not work. <br>  4. The problem of DND indication at the subscriber.  Well, if the phone has the ability to dial when removing / installing DND.  In my Chinese phone there is no such possibility, and the DND button itself is surprisingly inconvenient - it is a toggle switch on the back of the phone.  Of course, there is no problem to hang DND (dialing, say, * 76) on the multifunction key, and hint on your number on the next MF-key.  But it is logical if all the DND functionality (both switching and indication) will be on the same key.  I came to the conclusion that in order to enable DND the subscriber will dial his number, then the observed and the dialed numbers will be the same, which is necessary. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the process of doping, the technique evolved quite significantly, so I decided to share the results of the work.  The results tried to make the most understandable and, if possible, equip with comments. <br><br>  So, we have Asterisk 1.8.18.0, subscribers already exist and use the BLF function. <br><br>  First of all, we will use the work of our colleagues and in a slightly modified form we implement the DND by dialing * 76.  We add the following context to our dialplan: <br><pre> <code class="hljs cmake">[dnd-<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">off</span></span>] exten =&gt; *<span class="hljs-number"><span class="hljs-number">76</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,Answer ;     DND? exten =&gt; *<span class="hljs-number"><span class="hljs-number">76</span></span>,n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${DB(DND/${CALLERID(number)})}"</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span>]?activate:deactivate) ;  DND  ‚Äî  exten =&gt; *<span class="hljs-number"><span class="hljs-number">76</span></span>,n(activate),<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(STATE=BUSY) ;   <span class="hljs-string"><span class="hljs-string">""</span></span> (  hint) exten =&gt; *<span class="hljs-number"><span class="hljs-number">76</span></span>,n,<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(DEVICE_STATE(Custom:DND<span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span>)=<span class="hljs-variable"><span class="hljs-variable">${STATE}</span></span>) ;       DND exten =&gt; *<span class="hljs-number"><span class="hljs-number">76</span></span>,n,<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(DB(DND/<span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span>)=<span class="hljs-number"><span class="hljs-number">1</span></span>) exten =&gt; *<span class="hljs-number"><span class="hljs-number">76</span></span>,n,Hangup ;;;   DND  ‚Äî  exten =&gt; *<span class="hljs-number"><span class="hljs-number">76</span></span>,n(deactivate),<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(STATE=NOT_INUSE) ;   <span class="hljs-string"><span class="hljs-string">""</span></span> (  hint) exten =&gt; *<span class="hljs-number"><span class="hljs-number">76</span></span>,n,<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(DEVICE_STATE(Custom:DND<span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span>)=<span class="hljs-variable"><span class="hljs-variable">${STATE}</span></span>) ;       DND exten =&gt; *<span class="hljs-number"><span class="hljs-number">76</span></span>,n,<span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>(DB(DND/<span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span>)=) exten =&gt; *<span class="hljs-number"><span class="hljs-number">76</span></span>,n,Hangup</code> </pre><br>  Now add a context that will include the DND for dialing your number. <br><pre> <code class="hljs php">[dnd-on-off<span class="hljs-number"><span class="hljs-number">-2</span></span>] ;     - ? exten =&gt; _7XXX,<span class="hljs-number"><span class="hljs-number">1</span></span>,GotoIf($[<span class="hljs-string"><span class="hljs-string">"${CALLERID(number)}"</span></span> = <span class="hljs-string"><span class="hljs-string">"${EXTEN}"</span></span>]?godnd:gonext) ;   -   DND exten =&gt; _7XXX,n(godnd),<span class="hljs-keyword"><span class="hljs-keyword">Goto</span></span>(dnd-on-off,*<span class="hljs-number"><span class="hljs-number">76</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) ;   -      (       <span class="hljs-number"><span class="hljs-number">10</span></span>) exten =&gt; _7XXX,n(gonext),<span class="hljs-keyword"><span class="hljs-keyword">Goto</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>)</code> </pre><br>  Now we will teach Asterisk to check the status of the called subscriber, and hang up on the detection of DND mode.  To do this, add the line just before calling the subscriber. <br><pre> <code class="hljs perl">;  ,        DND <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> _7XXX,n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${DB(DND/${EXTEN})}</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"1"</span></span>]?gooff) <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> _7XXX,n,Dial(SIP/${EXTEN},<span class="hljs-number"><span class="hljs-number">20</span></span>,Tt) <span class="hljs-string"><span class="hljs-string">exten =&gt;</span></span> _7XXX,n(gooff),Hangup()</code> </pre><br>  It remains to use new contexts where needed: <br><pre> <code class="hljs pgsql">;  ,       SIP- [outcoming-sip] ;;; : / DND     <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> =&gt; dnd-<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">off</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> ;;;     "exten =&gt; _X.,1,Goto(10)" <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> =&gt; goto10 ;;; : / DND   *<span class="hljs-number"><span class="hljs-number">76</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> =&gt; dnd-<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">off</span></span> ;;;   SIP- (     <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> =&gt; sip-phones</code> </pre><br>  Save and do <code>asterisk -rx "dialplan reload"</code> . <br><br>  After that, on the phone, we transfer the favorite multifunction key to BLF mode and assign the subscriber‚Äôs hint to it.  Pickup code is not specified, it is not needed.  Although, of course, it all depends on the phone (I have a Flying Voice IP-622). <br><br>  Now, after pressing the "Do Not Disturb" key, calls to the subscriber are stopped, the key itself lights up red, and the secretary turns on the red key "Chief", the mission is completed. <br><br>  PS I would like to express special thanks to the Flying Voice IP622 phone, which, although it behaved slightly inadequately on the old firmware and slightly wry during the update, now shows itself well done.  The functionality is rich, the support is hard-working, and the firmware interface v1.4 and v3 is almost identical.  For its price just gorgeous. </div><p>Source: <a href="https://habr.com/ru/post/207820/">https://habr.com/ru/post/207820/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../207806/index.html">New Year's Eve Creative</a></li>
<li><a href="../207812/index.html">The best of the world of PHP for 2013 + competition from the company JetBrains! The digest of interesting materials ‚Ññ32</a></li>
<li><a href="../207814/index.html">PHP framework 2013</a></li>
<li><a href="../207816/index.html">Financing increases your risk</a></li>
<li><a href="../207818/index.html">Automator service that uploads images to Yandex. Photos</a></li>
<li><a href="../207822/index.html">We calculate what year is now from the Big Bang on Python</a></li>
<li><a href="../207824/index.html">What color is the moon?</a></li>
<li><a href="../207830/index.html">Cellular Automatics on Dart</a></li>
<li><a href="../207832/index.html">Intel Inside: disassemble the latest Digma devices on the Intel platform and wonder about the progress of Chinese engineering</a></li>
<li><a href="../207834/index.html">Our experience in optimizing nginx to distribute video content</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>