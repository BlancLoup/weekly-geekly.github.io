<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Budget version of TrueRMS measurement</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 

 Measuring trueRMS AC voltage is not an easy task, not what it seems at first glance. First of all, because most often you have to meas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Budget version of TrueRMS measurement</h1><div class="post__text post__text-html js-mediator-article">  <b>Introduction</b> <br><br>  Measuring trueRMS AC voltage is not an easy task, not what it seems at first glance.  First of all, because most often you have to measure not purely sinusoidal voltage, but something more complex, complicated by the presence of harmonics of noise. <br><br>  Therefore, a seductively simple solution with a mean value detector recounted in cf.  Values ‚Äã‚Äãdo not work where the waveform is very different from sinusoidal or simply unknown. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Professional voltmeters cf.  sq.  Values ‚Äã‚Äãare quite complex devices both in circuit design and algorithms [1, 2].  In the majority of meters that are of an auxiliary nature and serve to control the operation, such complexity and accuracy are not required. <br><br>  It also requires that the meter be built on the simplest 8-bit microcontroller. <br><a name="habracut"></a><br>  <b>General measurement principle</b> <br><br>  Let there be some kind of alternating voltage of the type shown in fig.  one. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/168/6d2/ddc/1686d2ddc0784893bd7361ba79a4e1e9.PNG" alt="image"></div><br>  Quasi-sinusoidal stress has a certain quasi-period T. <br><br>  The advantage of measuring the rms voltage is that, in general, the measurement time does not play a big role, it only affects the frequency band of the measurement.  More time gives more averaging, less gives an opportunity to see short-term changes. <br><br>  The basic definition is cf.  sq.  values ‚Äã‚Äãlooks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/973/ef0/c87/973ef0c8728d49898d32ba2a8973c091.PNG"></div><br>  where u (t) is the instantaneous voltage value <br>  T - measurement period <br><br>  Thus, the measurement time can be, generally speaking, any. <br><br>  For a real measurement with a real instrument for calculating the integrand expression, it is necessary to quantize a signal with a certain frequency, obviously exceeding at least 10 times the frequency of the quasi-sinusoid.  When measuring signals with frequencies within 20 kHz, this is not a problem even for 8-bit microcontrollers. <br><br>  Another thing is that all standard controllers have unipolar power.  Therefore, to measure the instantaneous alternating voltage at the time of the negative half-wave is not possible. <br><br>  In [3], a rather ingenious solution was proposed for how to introduce a constant component into a signal.  At the same time, in that decision, determining the moment when it is necessary to begin or end the process of calculating the mean.  sq.  The values ‚Äã‚Äãseem rather cumbersome. <br><br>  In this paper, we propose a method for overcoming this drawback, as well as calculating the integral with greater accuracy, which makes it possible to reduce the number of sample points to a minimum. <br><br>  <b>Features of the analog part of the meter</b> <br><br>  In fig.  2 shows the core of the pre-analog signal processing circuit. <br><br><img src="https://habrastorage.org/files/502/571/18e/50257118e565426cb82ff4bc5ce7712c.PNG"><br><br>  The signal enters through the capacitor C1 to the amplifier-shaper, assembled on the operational amplifier DA1.  The ac voltage signal is mixed at the non-inverting input of the amplifier with half the reference voltage, which is used in the ADC.  The voltage is chosen to be 2.048 V, since in compact devices the supply voltage is often +3.6 V or less.  In other cases, it is convenient to use 4.048 V, as in [3]. <br><br>  From the output of the amplifier-shaper through the integrating chain R3-C2 signal is fed to the input of the ADC, which serves to measure the constant component of the signal (U0).  From the amplifier-driver, the signal U 'is a measured signal shifted by half of the reference voltage.  Thus, to obtain the variable component, it suffices to calculate the difference U'-U0. <br>  The signal U0 is also used as a reference for the comparator DA2.  When U 'goes over U0, the comparator produces a differential, which is used to form an interruption procedure for collecting measurement samples. <br><br>  It is important that in many modern microcontrollers both operational amplifiers and comparators are built in, without mentioning the ADC. <br><br>  <b>Basic algorithm</b> <br><br>  In fig.  3 given the basic algorithm for the case of measuring the magnitude of the AC voltage with a fundamental frequency of 50 Hz. <br><img src="https://habrastorage.org/files/bb5/895/544/bb5895544921462b82757e57bd8cc7f0.png"><br>  The measurement can be triggered by any external event up to the button that is pressed manually. <br><br>  After start-up, the constant component in the input signal of the ADC is measured first, and then the controller switches to waiting for a positive differential at the comparator output.  As soon as a differential interrupt occurs, the controller makes a sample of 20 points with a time step corresponding to 1/20 of the quasi-period. <br><br>  The algorithm is written X ms, because the low-cost controller has its own delay time.  For the measurement to occur at the right times, this delay must be taken into account.  Therefore, the real delay will be less than 1 ms. <br><br>  In this example, the delay corresponds to measurements of a quasi-sinusoid in the range of 50 Hz, but it can be any, depending on the quasi-period of the measured signal within the speed response of a particular controller. <br><br>  When measuring sr.kv.  the voltage values ‚Äã‚Äãof an arbitrary quasi-periodic signal, if it is not known a priori what the signal is, it is advisable to measure its period using the timer built into the controller and the same comparator output.  And already on the basis of this measurement to establish a delay in the implementation of the sample. <br><br>  <b>RMS Calculation</b> <br><br>  After the ADC has created a sample, we have an array of values ‚Äã‚ÄãU '[i], a total of 21 values, including the value U0.  Now, if we apply the Simpson formula (more precisely, Cotes) for numerical integration, as the most accurate for this application, we obtain the following expression: <br><img src="https://habrastorage.org/files/e59/654/5cd/e596545cda8f418dbf51871a87fc6aab.PNG"><br>  where h is the measurement step, and the zero component of the formula is absent, since it is equal to 0 by definition. <br><br>  As a result of the calculation, we obtain the value of the integral in its pure form in the ADC sample format.  To translate into real values, the obtained value must be scaled according to the magnitude of the reference voltage and divided by the integration time interval. <br><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.056ex" height="2.66ex" viewBox="0 -832 6482.6 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/321008/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh2ysGcua6WkwIMdnYrPUPMEpOcXg#MJMATHI-4B" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/321008/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh2ysGcua6WkwIMdnYrPUPMEpOcXg#MJMAIN-3D" x="1167" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/321008/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh2ysGcua6WkwIMdnYrPUPMEpOcXg#MJMATHI-55" x="2223" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/321008/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh2ysGcua6WkwIMdnYrPUPMEpOcXg#MJMATHI-6F" x="2991" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/321008/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh2ysGcua6WkwIMdnYrPUPMEpOcXg#MJMATHI-70" x="3476" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/321008/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh2ysGcua6WkwIMdnYrPUPMEpOcXg#MJMAIN-2F" x="3980" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/321008/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh2ysGcua6WkwIMdnYrPUPMEpOcXg#MJMAIN-24" x="4480" y="0"></use><g transform="translate(4981,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/321008/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh2ysGcua6WkwIMdnYrPUPMEpOcXg#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/321008/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh2ysGcua6WkwIMdnYrPUPMEpOcXg#MJMAIN-30" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/321008/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh2ysGcua6WkwIMdnYrPUPMEpOcXg#MJMAIN-32" x="1001" y="0"></use></g></g></svg></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> K = Uop / $ 102</script></p> <br>  where Uop is the reference voltage of the ADC. <br><br>  If everything is recalculated in mV, K is approximately equal to just 2. The scale factor refers to the differences in square brackets.  After recalculation and calculation, S is divided by the measurement interval.  Taking into account the multiplier h, we actually obtain the division by an integer instead of multiplying by h followed by dividing by the measurement time interval. <br><br>  And in the final we extract the square root. <br><br>  And here the most interesting and difficult comes.  It is possible, of course, to use a floating point for computations, since the C language allows for even 8-bit controllers, and to perform computations directly using the formulas given.  However, the speed of calculation will drop significantly.  You can also go beyond the very small RAM of the microcontroller. <br><br>  To avoid this, it is necessary, as correctly stated in [3], to use a fixed point and operate with a maximum of 16-bit words. <br><br>  The author managed to solve this problem and measure the voltage with an error Uop / 1024, i.e.  for the given example with an accuracy of 2 mV with a total measurement range of ¬± 500 mV at a supply voltage of +3.3 V, which is enough for many process monitoring tasks. <br><br>  A software trick is to do all of the division processes, if possible, before the multiplication or exponentiation processes, so that the intermediate result of the operations does not exceed 65535 (or 32768 for actions with a sign). <br><br>  A specific software solution is beyond the scope of this article. <br><br>  <b>Conclusion</b> <br><br>  This article discusses the features of measuring the rms voltage using 8-bit microcontrollers, shows a variant of the circuit implementation and the basic algorithm for obtaining quantization samples of a real quasi-sinusoidal signal. <br><br>  <b>Links</b> <br><br><ol><li>  <a href="http://bd.patent.su/2210000-2210999/pat/servl/servlete692.html">RMS Voltage Converter</a> </li><li>  <a href="http://ru-patent.info/20/10-14/2011995.html">Digital voltmeter</a> </li><li>  <a href="https://geektimes.ru/post/254088/">Method of measuring the effective value of voltage using MK</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/321008/">https://habr.com/ru/post/321008/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320992/index.html">Where to go to the programmer for knowledge this year</a></li>
<li><a href="../320994/index.html">Own algorithm 2. Search for similar images</a></li>
<li><a href="../320996/index.html">Reward: Gratitude from the heart</a></li>
<li><a href="../321002/index.html">The share of HTTPS traffic on the Internet exceeded 50%</a></li>
<li><a href="../321004/index.html">Why are CPA networks no longer a cake? Some good reasons</a></li>
<li><a href="../321010/index.html">Content, metadata and context of open data</a></li>
<li><a href="../321012/index.html">Simple math for solving difficult problems</a></li>
<li><a href="../321014/index.html">The book ‚ÄúDecentralized Applications. Blockchain technology in action ¬ª</a></li>
<li><a href="../321016/index.html">ML Boot Camp III opening soon</a></li>
<li><a href="../321018/index.html">What is crowd marketing?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>