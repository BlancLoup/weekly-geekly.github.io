<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>InnoDB full text search</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habrachitatel! 
 InnoDB full-text data retrieval is the well-known headache of many MySQL / InnoDB developers. For those who are not up to date, I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>InnoDB full text search</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habrachitatel! <br>  InnoDB full-text data retrieval is the well-known headache of many MySQL / InnoDB developers.  For those who are not up to date, I will explain.  In the MyISAM table type, there is a full-featured full-text data search, but the table itself historically has limitations that are fundamental in individual projects.  In the more advanced InnoDB table type, there is no full-text search.  So poor developers have to put up with either MyISAM limitations or the lack of InnoDB search.  I want to talk about how there are ways to organize a full-fledged search in InnoDB without magic and exclusively by regular means.  It will also be interesting to compare the speed characteristics of each method. <br><a name="habracut"></a><br>  For example, take a small table with 10,000 entries. <br><br><blockquote>  <font color="#993333">CREATE</font> <font color="#993333">TABLE</font> users <font color="#66cc66">(</font> <br>  id INT <font color="#66cc66">(</font> <font color="#cc66cc">11</font> <font color="#66cc66">)</font> <font color="#993333">NOT</font> <font color="#993333">NULL</font> <font color="#993333">AUTO_INCREMENT</font> <font color="#66cc66">,</font> <br>  login VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  <font color="#ff0000">`password`</font> VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  name VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  surname VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  email VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">NOT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  country VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  city ‚Äã‚ÄãVARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  <font color="#993333">PRIMARY</font> <font color="#993333">KEY</font> <font color="#66cc66">(</font> id <font color="#66cc66">)</font> <br>  <font color="#66cc66">)</font> <br>  ENGINE <font color="#66cc66">=</font> INNODB </blockquote><br><br>  In this table we store the data of users of the site.  On the site itself there is a user search form in which you can enter an arbitrary query like "Tolstoy Yasnaya Polyana".  To process such a request, the search must be carried out on several fields at once.  We need a search for the fields <em>login</em> , <em>name</em> , <em>surname</em> , <em>city</em> , <em>country</em> .  A query can be either a single word (name or city) or in the form of a set of words, separated by a space.  The problem is that we need to search for this set of words in several fields at once, which is difficult to do in InnoDB without using additional functions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There are several relatively simple ways to search full-text data in InnoDB: <br><ol><li>  <a href="https://habr.com/ru/post/114572/">Using the mirror table in MyISAM</a> </li><li>  <a href="https://habr.com/ru/post/114572/">Using a mirrored table in MyISAM with cached data</a> </li><li>  <a href="https://habr.com/ru/post/114572/">Using the keyword table in MyISAM</a> </li><li>  <a href="https://habr.com/ru/post/114572/">Parsing the request and direct search in InnoDB</a> </li><li>  <a href="https://habr.com/ru/post/114572/">Using third-party solutions</a> </li></ol><br>  Consider each of them in more detail. <br><br><h2>  Using the mirror table in MyISAM </h2><br>  The first proposed method is to create an additional table in MyISAM.  As you know MyISAM quite well supports full-text search and it can be used.  All data from the main table ( <em>users</em> ) will be copied to this additional table.  Synchronization will be provided by triggers.  In the new table, add the fields <em>login</em> , <em>name</em> , <em>surname</em> , <em>city</em> , <em>country</em> .  Thus, we will create a ‚Äúmirror‚Äù of the main table, and we will work with it.  To enable full-text search, add the FULLTEXT index to all 5 fields together: <br><br><blockquote>  <font color="#993333">CREATE</font> <font color="#993333">TABLE</font> search <font color="#66cc66">(</font> <br>  id INT <font color="#66cc66">(</font> <font color="#cc66cc">11</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  login VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  name VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  surname VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  country VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  city ‚Äã‚ÄãVARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  FULLTEXT <font color="#993333">INDEX</font> IX_search <font color="#66cc66">(</font> city <font color="#66cc66">,</font> country <font color="#66cc66">,</font> login <font color="#66cc66">,</font> name <font color="#66cc66">,</font> surname <font color="#66cc66">)</font> <br>  <font color="#66cc66">)</font> <br>  ENGINE <font color="#66cc66">=</font> MYISAM </blockquote><br><br>  To synchronize data between the main table and the ‚Äúmirror‚Äù table on <em>users, we</em> set the triggers for writing, changing and reading: <br><br>  Write trigger: <br><br><blockquote>  <font color="#993333">CREATE</font> <br>  <font color="#993333">TRIGGER</font> <font color="#ff0000">`insert`</font> <br>  AFTER <font color="#993333">INSERT</font> <br>  <font color="#993333">ON</font> users <br>  <font color="#993333">FOR</font> EACH ROW <br>  BEGIN <br>  <font color="#993333">INSERT</font> <font color="#993333">INTO</font> search <font color="#66cc66">(</font> <font color="#ff0000">`id`</font> <font color="#66cc66">,</font> <font color="#ff0000">` login`</font> <font color="#66cc66">,</font> <font color="#ff0000">`name`</font> <font color="#66cc66">,</font> <font color="#ff0000">` surname`</font> <font color="#66cc66">,</font> <font color="#ff0000">`country`</font> <font color="#66cc66">,</font> <font color="#ff0000">` city`</font> <font color="#66cc66">)</font> <font color="#993333">VALUES</font> <font color="#66cc66">(</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`login`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`name`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`surname`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`country`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`city`</font> <br>  <font color="#66cc66">)</font> ; <br>  END </blockquote><br><br>  Trigger on change: <br><br><blockquote>  <font color="#993333">CREATE</font> <br>  <font color="#993333">TRIGGER</font> <font color="#ff0000">`update`</font> <br>  AFTER <font color="#993333">UPDATE</font> <br>  <font color="#993333">ON</font> users <br>  <font color="#993333">FOR</font> EACH ROW <br>  BEGIN <br>  <font color="#993333">DELETE</font> <font color="#993333">FROM</font> <font color="#ff0000">`search`</font> <font color="#ff0000">WHERE` id`</font> <font color="#66cc66">=</font> NEW <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> ; <br>  <font color="#993333">INSERT</font> <font color="#993333">INTO</font> <font color="#ff0000">`search`</font> <font color="#66cc66">(</font> <font color="#ff0000">` id`</font> <font color="#66cc66">,</font> <font color="#ff0000">`login`</font> <font color="#66cc66">,</font> <font color="#ff0000">` name`</font> <font color="#66cc66">,</font> <font color="#ff0000">`surname`</font> <font color="#66cc66">,</font> <font color="#ff0000">` country`</font> <font color="#66cc66">,</font> <font color="#ff0000">`city`</font> <font color="#66cc66">)</font> <font color="#993333">VALUES</font> <font color="#66cc66">(</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`login`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`name`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`surname`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`country`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`city`</font> <br>  <font color="#66cc66">)</font> ; <br>  END </blockquote><br><br>  And a simple delete trigger: <br><br><blockquote>  <font color="#993333">CREATE</font> <br>  <font color="#993333">TRIGGER</font> <font color="#ff0000">`delete`</font> <br>  AFTER <font color="#993333">DELETE</font> <br>  <font color="#993333">ON</font> users <br>  <font color="#993333">FOR</font> EACH ROW <br>  BEGIN <br>  <font color="#993333">DELETE</font> <font color="#993333">FROM</font> <font color="#ff0000">`search`</font> <font color="#ff0000">WHERE` id`</font> <font color="#66cc66">=</font> OLD <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> ; <br>  END </blockquote><br><br>  Search by using the following query: <br><br><blockquote>  <font color="#993333">SELECT</font> <font color="#ff0000">`users`</font> <font color="#66cc66">. *</font> <font color="#ff0000">FROM` users`</font> <br>  <font color="#993333">INNER</font> <font color="#993333">JOIN</font> <font color="#ff0000">`search`</font> <br>  <font color="#993333">ON</font> <font color="#ff0000">`search`</font> <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> <font color="#66cc66">=</font> <font color="#ff0000">` users`</font> <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> <br>  <font color="#993333">WHERE</font> <br>  MATCH <font color="#66cc66">(</font> <font color="#ff0000">`search`</font> <font color="#66cc66">.</font> City <font color="#66cc66">,</font> <font color="#ff0000">` search`</font> <font color="#66cc66">.</font> Country <font color="#66cc66">,</font> <font color="#ff0000">`search`</font> <font color="#66cc66">.</font> Login <font color="#66cc66">,</font> <font color="#ff0000">` search`</font> <font color="#66cc66">.</font> Name <font color="#66cc66">,</font> <font color="#ff0000">`search`</font> <font color="#66cc66">.</font> <font color="#ff0000">Surname</font> <font color="#66cc66">)</font> AGAINST <font color="#66cc66">(</font> <font color="#ff0000">'Vladimir Tupin St. Petersburg'</font> <font color="#993333">IN</font> <font color="#993333">BOOLEAN</font> MODE <font color="#66cc66">)</font> <font color="#66cc66">&gt;</font> <font color="#cc66cc">0</font> <br>  <font color="#993333">ORDER</font> <font color="#993333">BY</font> MATCH <font color="#66cc66">(</font> <font color="#ff0000">`search`</font> <font color="#66cc66">.</font> City <font color="#66cc66">,</font> <font color="#ff0000">` search`</font> <font color="#66cc66">.</font> Country <font color="#66cc66">,</font> <font color="#ff0000">`search`</font> <font color="#66cc66">.</font> Login <font color="#66cc66">,</font> <font color="#ff0000">` search`</font> <font color="#66cc66">.</font> Name <font color="#66cc66">,</font> <font color="#ff0000">`search`</font> <font color="#66cc66">.</font> <font color="#ff0000">Surname</font> <font color="#66cc66">)</font> AGAINST <font color="#66cc66">(</font> <font color="#ff0000">'Vladimir Tupin St. Petersburg'</font> <font color="#993333">IN</font> <font color="#993333">BOOLEAN</font> MODE <font color="#66cc66">)</font> <font color="#993333">DESC</font> </blockquote><br>  Here, data is searched in the <em>search</em> table, the result is sorted by relevance, and at the output we get the corresponding records from the <em>users</em> table. <br><br>  The main advantage of this approach is the flexibility of the search by adding additional indexes and compiling new search combinations (country + city or login + first name + last name).  Thus, we are free to form new search sets and relevance rules. <br>  The disadvantages of this method (as well as all methods with the creation of a ‚Äúmirror‚Äù) are redundant data storage.  Therefore, it is advisable to use it with small amounts of data as in our example. <br><br><h2>  Using a mirrored table in MyISAM with cached data </h2><br>  The second way is also to create a data mirror, but here we will store data in only one field.  In the task, the search is carried out immediately by a group of fields and we will try to combine them into one text field, separated by spaces.  Thus, the entire data set in the <em>users</em> table will correspond to a single field.  Create a <em>search</em> table with two fields <em>id</em> and <em>text</em> .  <em>Id</em> will correspond to the <em>id of the</em> main table ( <em>users</em> ), <em>text</em> is our ‚Äúcached‚Äù data. <br><br><blockquote>  <font color="#993333">CREATE</font> <font color="#993333">TABLE</font> search <font color="#66cc66">(</font> <br>  id INT <font color="#66cc66">(</font> <font color="#cc66cc">11</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  <font color="#ff0000">`text`</font> TEXT <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  FULLTEXT <font color="#993333">INDEX</font> IX_search_text <font color="#66cc66">(</font> <font color="#ff0000">`text`</font> <font color="#66cc66">)</font> <br>  <font color="#66cc66">)</font> <br>  ENGINE <font color="#66cc66">=</font> MYISAM </blockquote><br><br>  Synchronization is also performed using triggers: <br><br>  Addition: <br><br><blockquote>  <font color="#993333">CREATE</font> <br>  <font color="#993333">TRIGGER</font> <font color="#ff0000">`insert`</font> <br>  AFTER <font color="#993333">INSERT</font> <br>  <font color="#993333">ON</font> users <br>  <font color="#993333">FOR</font> EACH ROW <br>  BEGIN <br>  <font color="#993333">INSERT</font> <font color="#993333">INTO</font> search <font color="#66cc66">(</font> <font color="#ff0000">`id`</font> <font color="#66cc66">,</font> <font color="#ff0000">` text`</font> <font color="#66cc66">)</font> <font color="#993333">VALUES</font> <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> <font color="#ff0000">`Id`</font> <font color="#66cc66">,</font> <br>  LOWER <font color="#66cc66">(</font> <br>  CONCAT_WS <font color="#66cc66">(</font> <font color="#ff0000">'</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`name`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`surname`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`login`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`country`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`city`</font> <br>  <font color="#66cc66">)</font> <br>  <font color="#66cc66">)</font> <br>  <font color="#66cc66">)</font> ; <br>  END </blockquote><br><br>  Change: <br><br><blockquote>  <font color="#993333">CREATE</font> <br>  <font color="#993333">TRIGGER</font> <font color="#ff0000">`update`</font> <br>  AFTER <font color="#993333">UPDATE</font> <br>  <font color="#993333">ON</font> users <br>  <font color="#993333">FOR</font> EACH ROW <br>  BEGIN <br>  <font color="#993333">DELETE</font> <font color="#993333">FROM</font> search <font color="#993333">WHERE</font> <font color="#ff0000">`id`</font> <font color="#66cc66">=</font> NEW <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> ; <br>  <font color="#993333">INSERT</font> <font color="#993333">INTO</font> search <font color="#66cc66">(</font> <font color="#ff0000">`id`</font> <font color="#66cc66">,</font> <font color="#ff0000">` text`</font> <font color="#66cc66">)</font> <font color="#993333">VALUES</font> <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> <font color="#ff0000">`Id`</font> <font color="#66cc66">,</font> <br>  LOWER <font color="#66cc66">(</font> <br>  CONCAT_WS <font color="#66cc66">(</font> <font color="#ff0000">'</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`name`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`surname`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`login`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`country`</font> <font color="#66cc66">,</font> <br>  NEW <font color="#66cc66">.</font>  <font color="#ff0000">`city`</font> <br>  <font color="#66cc66">)</font> <br>  <font color="#66cc66">)</font> <br>  <font color="#66cc66">)</font> ; <br>  END <font color="#993333">CREATE</font> </blockquote><br><br>  Uninstall: <br><br><blockquote>  <font color="#993333">TRIGGER</font> <font color="#ff0000">`delete`</font> <br>  AFTER <font color="#993333">DELETE</font> <br>  <font color="#993333">ON</font> users <br>  <font color="#993333">FOR</font> EACH ROW <br>  BEGIN <br>  <font color="#993333">DELETE</font> <font color="#993333">FROM</font> search <font color="#993333">WHERE</font> <font color="#ff0000">`id`</font> <font color="#66cc66">=</font> OLD <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> ; <br>  END </blockquote><br><br>  The search query looks like this: <br><br><blockquote>  <font color="#993333">SELECT</font> <font color="#ff0000">`users`</font> <font color="#66cc66">. *</font> <font color="#ff0000">FROM` users`</font> <br>  <font color="#993333">INNER</font> <font color="#993333">JOIN</font> <font color="#ff0000">`search`</font> <br>  <font color="#993333">ON</font> <font color="#ff0000">`search`</font> <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> <font color="#66cc66">=</font> <font color="#ff0000">` users`</font> <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> <br>  <font color="#993333">WHERE</font> <br>  MATCH <font color="#66cc66">(</font> <font color="#ff0000">`search`.`</font> <font color="#ff0000">Text`</font> <font color="#66cc66">)</font> AGAINST <font color="#66cc66">(</font> <font color="#ff0000">'Vladimir Tupin St. Petersburg'</font> <font color="#993333">IN</font> <font color="#993333">BOOLEAN</font> MODE <font color="#66cc66">)</font> <font color="#66cc66">&gt;</font> <font color="#cc66cc">0</font> <br>  <font color="#993333">ORDER</font> <font color="#993333">BY</font> MATCH <font color="#66cc66">(</font> <font color="#ff0000">`search`.`</font> <font color="#ff0000">Text`</font> <font color="#66cc66">)</font> AGAINST <font color="#66cc66">(</font> <font color="#ff0000">'Vladimir Tupin St. Petersburg'</font> <font color="#993333">IN</font> <font color="#993333">BOOLEAN</font> MODE <font color="#66cc66">)</font> <font color="#993333">DESC</font> <br></blockquote><br><br>  This method is not as flexible as the previous one, however, as we will see later, it wins in speed with a large number of different requests. <br><br><h2>  Using the keyword table in MyISAM </h2><br><br>  The third method is based on the creation of a list of "keywords" - search tags.  Keywords are fields in the <em>users</em> table.  For example, for a user with fields <code>(id=2144; login= leo; name=;surname=;city=' ';country=;email=leo@tolstoy.ru;password=;)</code> keywords will be <code>(¬´leo¬ª; ¬´¬ª; ¬´¬ª; ¬´ ¬ª; ¬´¬ª)</code> .  All these words we will write in a separate table MyISAM, in which there will be two fields <em>id</em> and <em>text</em> .  Id corresponds to the id of the main table ( <em>users</em> ).  And <em>text</em> is the field in which keywords tags will be written.  Each user from the <em>users</em> table will correspond to 5 entries in the new <em>search</em> table.  Thus, we received the table of tags of each user. <br><br><blockquote>  <font color="#993333">CREATE</font> <font color="#993333">TABLE</font> search <font color="#66cc66">(</font> <br>  id INT <font color="#66cc66">(</font> <font color="#cc66cc">11</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  <font color="#ff0000">`text`</font> VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  FULLTEXT <font color="#993333">INDEX</font> IX_search_text <font color="#66cc66">(</font> <font color="#ff0000">`text`</font> <font color="#66cc66">)</font> <br>  <font color="#66cc66">)</font> <br>  ENGINE <font color="#66cc66">=</font> MYISAM </blockquote><br><br>  Synchronization of data is also carried out by triggers: <br><br>  Creature: <br><br><blockquote>  <font color="#993333">CREATE</font> <br>  <font color="#993333">TRIGGER</font> <font color="#ff0000">`insert`</font> <br>  AFTER <font color="#993333">INSERT</font> <br>  <font color="#993333">ON</font> users <br>  <font color="#993333">FOR</font> EACH ROW <br>  BEGIN <br>  <font color="#993333">INSERT</font> <font color="#993333">INTO</font> search <font color="#66cc66">(</font> <font color="#ff0000">`id`</font> <font color="#66cc66">,</font> <font color="#ff0000">` text`</font> <font color="#66cc66">)</font> <font color="#993333">VALUES</font> <br>  <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> <font color="#ff0000">`Id`</font> <font color="#66cc66">,</font> <font color="#ff0000">NEW.` Login`</font> <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> <font color="#ff0000">`Id`</font> <font color="#66cc66">,</font> <font color="#ff0000">NEW.` Name`</font> <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> <font color="#ff0000">`Id`</font> <font color="#66cc66">,</font> <font color="#ff0000">NEW.` Surname`</font> <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> <font color="#ff0000">`Id`</font> <font color="#66cc66">,</font> <font color="#ff0000">NEW.` Country`</font> <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> <font color="#ff0000">`Id`</font> <font color="#66cc66">,</font> <font color="#ff0000">NEW.` City`</font> <font color="#66cc66">)</font> ; <br>  END </blockquote><br><br>  Change: <br><br><blockquote>  <font color="#993333">CREATE</font> <br>  <font color="#993333">TRIGGER</font> <font color="#ff0000">`update`</font> <br>  AFTER <font color="#993333">UPDATE</font> <br>  <font color="#993333">ON</font> users <br>  <font color="#993333">FOR</font> EACH ROW <br>  BEGIN <br>  <font color="#993333">DELETE</font> <font color="#993333">FROM</font> search <font color="#993333">WHERE</font> <font color="#ff0000">`id`</font> <font color="#66cc66">=</font> NEW <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> ; <br>  <font color="#993333">INSERT</font> <font color="#993333">INTO</font> search <font color="#66cc66">(</font> <font color="#ff0000">`id`</font> <font color="#66cc66">,</font> <font color="#ff0000">` text`</font> <font color="#66cc66">)</font> <font color="#993333">VALUES</font> <br>  <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> <font color="#ff0000">`Id`</font> <font color="#66cc66">,</font> <font color="#ff0000">NEW.` Login`</font> <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> <font color="#ff0000">`Id`</font> <font color="#66cc66">,</font> <font color="#ff0000">NEW.` Name`</font> <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> <font color="#ff0000">`Id`</font> <font color="#66cc66">,</font> <font color="#ff0000">NEW.` Surname`</font> <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> <font color="#ff0000">`Id`</font> <font color="#66cc66">,</font> <font color="#ff0000">NEW.` Country`</font> <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  <font color="#66cc66">(</font> NEW <font color="#66cc66">.</font> <font color="#ff0000">`Id`</font> <font color="#66cc66">,</font> <font color="#ff0000">NEW.` City`</font> <font color="#66cc66">)</font> ; <br>  END </blockquote><br><br>  Uninstall: <br><br><blockquote>  <font color="#993333">CREATE</font> <br>  <font color="#993333">TRIGGER</font> <font color="#ff0000">`delete`</font> <br>  AFTER <font color="#993333">DELETE</font> <br>  <font color="#993333">ON</font> users <br>  <font color="#993333">FOR</font> EACH ROW <br>  BEGIN <br>  <font color="#993333">DELETE</font> <font color="#993333">FROM</font> search <font color="#993333">WHERE</font> <font color="#ff0000">`id`</font> <font color="#66cc66">=</font> OLD <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> ; <br>  END </blockquote><br><br>  Search query: <br><br><blockquote>  <font color="#993333">SELECT</font> <font color="#ff0000">`users`</font> <font color="#66cc66">. *</font> <font color="#ff0000">FROM` users`</font> <br>  <font color="#993333">INNER</font> <font color="#993333">JOIN</font> <font color="#ff0000">`search`</font> <br>  <font color="#993333">ON</font> <font color="#ff0000">`search`</font> <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> <font color="#66cc66">=</font> <font color="#ff0000">` users`</font> <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> <br>  <font color="#993333">WHERE</font> <br>  MATCH <font color="#66cc66">(</font> <font color="#ff0000">`search`.`</font> <font color="#ff0000">Text`</font> <font color="#66cc66">)</font> AGAINST <font color="#66cc66">(</font> <font color="#ff0000">'Vladimir Tupin St. Petersburg'</font> <font color="#993333">IN</font> <font color="#993333">BOOLEAN</font> MODE <font color="#66cc66">)</font> <font color="#66cc66">&gt;</font> <font color="#cc66cc">0</font> <br>  <font color="#993333">GROUP</font> <font color="#993333">BY</font> <font color="#ff0000">`search`</font> <font color="#66cc66">.</font>  <font color="#ff0000">`id`</font> <br>  <font color="#993333">ORDER</font> <font color="#993333">BY</font> COUNT <font color="#66cc66">(</font> <font color="#66cc66">*</font> <font color="#66cc66">)</font> <font color="#993333">DESC</font> </blockquote><br><br>  Please note that if earlier relevance was determined by the built-in search engine MyISAM, then in this case we define it ourselves.  As a result of the search, we received only those tags that match the query.  And the more tags one user, the higher it is in the sample. <br>  The given example has a drawback: with an equal number of tags, several records have a natural sorting, which is not always true in terms of relevance. <br>  However, this method has a high potential for further development.  First, we can add to the <code>ORDER BY</code> sorting the sum of relevance scores from the <code>MATCH AGAINST</code> query.  Thus, the above disadvantage will be eliminated.  Secondly, we can add to this table an additional weight field of the weight tag, and each field of the main table should be assigned a value of this weight.  Thus, we can add sorting based on the importance (weight) of individual fields.  This gives us the opportunity to focus on some fields without compromising the quality of the search. <br><br><h2>  Parsing the request and direct search in InnoDB </h2><br>  The fourth method is harsh and does not use MyISAM as previous ones.  It also does not have additional tables and triggers.  We will simply search for the existing table.  First we need to index all the fields in which the search will be performed. <br><br><blockquote>  <font color="#993333">CREATE</font> <font color="#993333">TABLE</font> users <font color="#66cc66">(</font> <br>  id int <font color="#66cc66">(</font> <font color="#cc66cc">11</font> <font color="#66cc66">)</font> <font color="#993333">NOT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  login VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  <font color="#ff0000">`password`</font> VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  name VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  surname VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  email VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">NOT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  country VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  city ‚Äã‚ÄãVARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#993333">NULL</font> <font color="#66cc66">,</font> <br>  <font color="#993333">PRIMARY</font> <font color="#993333">KEY</font> <font color="#66cc66">(</font> id <font color="#66cc66">)</font> <br>  <font color="#993333">INDEX</font> city <font color="#66cc66">(</font> city <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  <font color="#993333">INDEX</font> country <font color="#66cc66">(</font> country <font color="#66cc66">)</font> <br>  <font color="#993333">INDEX</font> email <font color="#66cc66">(</font> email <font color="#66cc66">)</font> <br>  <font color="#993333">INDEX</font> login <font color="#66cc66">(</font> login <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  <font color="#993333">INDEX</font> name <font color="#66cc66">(</font> name <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  <font color="#993333">INDEX</font> password <font color="#66cc66">(</font> password <font color="#66cc66">)</font> <font color="#66cc66">,</font> <br>  <font color="#993333">INDEX</font> surname <font color="#66cc66">(</font> surname <font color="#66cc66">)</font> <br>  <font color="#66cc66">)</font> <br>  ENGINE <font color="#66cc66">=</font> INNODB </blockquote><br><br>  In InnoDB, we can perform a search only with the help of the LIKE operator, but for its effective work it is necessary to split the word query, otherwise queries consisting of several words will remain without result.  To break up words and compose a query, we will write a function: <br><blockquote>  <font color="#993333">CREATE</font> <br>  <font color="#993333">FUNCTION</font> search <font color="#66cc66">(</font> str VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#66cc66">)</font> <br>  RETURNS varchar <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> CHARSET cp1251 <br>  BEGIN <br>  DECLARE output VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#ff0000">''</font> ; <br>  DECLARE temp_str varchar <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> ; <br>  DECLARE first_part VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#ff0000">"CONCAT_WS (", `name`,` surname`, `login`,` country`, `city`) LIKE '%"</font> ; <br>  DECLARE last_part VARCHAR <font color="#66cc66">(</font> <font color="#cc66cc">255</font> <font color="#66cc66">)</font> <font color="#993333">DEFAULT</font> <font color="#ff0000">"% '"</font> ; <br><br>  WHILE LENGTH <font color="#66cc66">(</font> str <font color="#66cc66">)</font> !  <font color="#66cc66">=</font> <font color="#cc66cc">0</font> DO <br>  <font color="#993333">SET</font> temp_str <font color="#66cc66">=</font> SUBSTRING_INDEX <font color="#66cc66">(</font> str <font color="#66cc66">,</font> <font color="#ff0000">''</font> <font color="#66cc66">,</font> <font color="#cc66cc">1</font> <font color="#66cc66">)</font> ; <br>  <font color="#993333">IF</font> temp_str <font color="#66cc66">=</font> str <br>  THEN <br>  <font color="#993333">SET</font> str <font color="#66cc66">=</font> <font color="#ff0000">''</font> ; <br>  ELSE <br>  <font color="#993333">SET</font> str <font color="#66cc66">=</font> SUBSTRING <font color="#66cc66">(</font> str <font color="#66cc66">,</font> LENGTH <font color="#66cc66">(</font> temp_str <font color="#66cc66">)</font> <font color="#66cc66">+</font> <font color="#cc66cc">2</font> <font color="#66cc66">)</font> ; <br>  END <font color="#993333">IF</font> ; <br><br>  <font color="#993333">IF</font> output!  <font color="#66cc66">=</font> <font color="#ff0000">""</font> <br>  THEN <br>  <font color="#993333">SET</font> output <font color="#66cc66">=</font> CONCAT <font color="#66cc66">(</font> output <font color="#66cc66">,</font> <font color="#ff0000">'OR'</font> <font color="#66cc66">)</font> ; <br>  END <font color="#993333">IF</font> ; <br><br>  <font color="#993333">SET</font> output <font color="#66cc66">=</font> CONCAT <font color="#66cc66">(</font> output <font color="#66cc66">,</font> first_part <font color="#66cc66">,</font> temp_str <font color="#66cc66">,</font> last_part <font color="#66cc66">)</font> ; <br><br>  END WHILE; <br>  <font color="#993333">RETURN</font> output; <br>  END </blockquote><br><br>  The function returns us a fragment of the generated search query, which just needs to be substituted and executed: <br><br><blockquote>  <font color="#993333">SET</font> @ <font color="#993333">WHERE</font> <font color="#66cc66">=</font> CONCAT <font color="#66cc66">(</font> <font color="#ff0000">'SELECT * FROM `users` WHERE'</font> <font color="#66cc66">,</font> search <font color="#66cc66">(</font> <font color="#ff0000">'Habra Habrovich'</font> <font color="#66cc66">)</font> <font color="#66cc66">)</font> ; <br>  PREPARE prepared <font color="#993333">FROM</font> @ <font color="#993333">WHERE</font> ; <br>  EXECUTE prepared; </blockquote><br><br>  You can also use temporary tables, they will give a tangible convenience when processing the results of the query. <br><br><h2>  Using third-party solutions </h2><br>  There are a number of third-party full-text search solutions.  The most popular platforms are <a href="http://sphinxsearch.com/">Sphinx</a> and <a href="http://lucene.apache.org/java/docs/index.html">Apache Lucene-</a> based projects.  Their use is meaningless for small amounts of data (such as in our example), and sometimes it is simply impossible due to restrictions (hoster, evil admin, curved hands, etc.). <br><br><h1>  Comparison </h1><br>  Let's compare the shown methods of full-text search (except third-party solutions) for the speed of execution of typical queries.  We will compare on the example of the execution of 50 queries of varying complexity.  To do this, we write a PHP script that will objectively calculate the average search speed for each of the above methods.  In order to bring measurements closer to real conditions, we will conduct a second control measurement in which the same search queries will be used.  Here it will be possible to assess how well MySQL caching mechanisms are used in each method. <br><br>  Comparison of the speed of execution of search queries in the MySQL database in the InnoDB table using various methods: <br><br> <a title="Habraffe.ru" href=""><img src="https://habrastorage.org/storage/habraeffect/40/17/4017851a22774a0b28a0f34c5a76048f.png"></a> <br><br>  More details: <br><br><table><tbody><tr><td>  <b>Method</b> </td><td>  <b>The average speed of a single request (sec.)</b> </td><td>  <b>Average speed of execution of one repeated request (sec.)</b> </td></tr><tr><td>  Using the mirror table in MyISAM </td><td>  0.029738 </td><td>  0.011974 </td></tr><tr><td>  Using a mirrored table in MyISAM with cached data </td><td>  0.025652 </td><td>  0.012027 </td></tr><tr><td>  Using the keyword table in MyISAM </td><td>  0.027876 </td><td>  0.008866 </td></tr><tr><td>  Parsing the request and direct search in InnoDB </td><td>  0.136091 </td><td>  0.09541 </td></tr></tbody></table><br><br>  As expected, the direct LIKE search in InnoDB turned out to be the slowest and significantly loses everything else.  Of course, this method can still be optimized, but this is unlikely to give a significant gain in speed. <br>  The three remaining search methods showed themselves at about the same level.  As practice has shown, with a large number of identical queries, the use of keywords (tags) in MyISAM gives a tangible advantage.  With a large number of various search queries, the win gives the second method - creating a cached mirror.  If some fields are very different in size from others (the content of the article, the text of the news), then the first method shows itself more effectively - creating a mirror table. <br><br>  Creating MyISAM mirrors should be used for small tables (10-50 thousand records in a table), if there are more records in the table, and technical capabilities allow using third-party mechanisms (Sphinx, Apache Lucene). </div><p>Source: <a href="https://habr.com/ru/post/114572/">https://habr.com/ru/post/114572/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../114567/index.html">With the creator of one of the oldest public torrent trackers dropped all charges</a></li>
<li><a href="../114568/index.html">Comile User Interface</a></li>
<li><a href="../114569/index.html">Get inspired with Cisco</a></li>
<li><a href="../114570/index.html">Simple use of AsyncTask and ProgressDialog in Android</a></li>
<li><a href="../114571/index.html">Management of requirements for IT projects</a></li>
<li><a href="../114573/index.html">My view of trees in PHP</a></li>
<li><a href="../114574/index.html">Yandex.Money: direct payment from the card</a></li>
<li><a href="../114576/index.html">Notes on the Python object system part 1</a></li>
<li><a href="../114577/index.html">Facebook announced an "interactive" security policy</a></li>
<li><a href="../114578/index.html">American 2.5 years to pay bills defunct Internet girlfriend</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>