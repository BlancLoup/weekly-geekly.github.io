<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hibernate cache</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quite often in java applications to reduce the load on the database using the cache. Not many people really understand how the cache works under the h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hibernate cache</h1><div class="post__text post__text-html js-mediator-article">  Quite often in java applications to reduce the load on the database using the cache.  Not many people really understand how the cache works under the hood, just adding annotation is not always enough, you need to understand how the system works.  Therefore, in this article I will try to reveal the topic of how the cache of the popular ORM framework works.  So, first, a little theory. <br><br>  First of all, Hibernate cache is 3 levels of caching: <br><ul><li>  First-level cache (First-level cache); </li><li>  Second level cache (Second-level cache); </li><li>  Query cache (Query cache); </li></ul><br><h5>  First level cache </h5><br>  The first level cache is always attached to the session object.  Hibernate always uses this cache by default and cannot be disabled.  Let's take a look at the following code right away: <br><pre><code class="java hljs">SharedDoc persistedDoc = (SharedDoc) session.load(SharedDoc.class, docId); System.out.println(persistedDoc.getName()); user1.setDoc(persistedDoc); persistedDoc = (SharedDoc) session.load(SharedDoc.class, docId); System.out.println(persistedDoc.getName()); user2.setDoc(persistedDoc);</code> </pre> <br>  Perhaps, you expect that 2 queries in the database will be executed?  This is not true.  In this example, 1 request to the database will be executed, despite the fact that 2 calls to load () are being made, since these calls occur in the context of one session.  During the second attempt to load a plan with the same identifier, the session cache will be used. <br>  One important point is that when using the load () method, Hibernate does not unload data from the database until it is needed.  In other words, at the moment when the first call to load is made, we receive the proxy object or the data itself if the data were already in the session cache.  Therefore, there is getName () in the code in order to extract 100% of the data from the database.  It also offers a great opportunity for potential optimization.  In the case of a proxy object, we can link two objects without making a request to the database, in contrast to the get () method.  When using the save (), update (), saveOrUpdate (), load (), get (), list (), iterate (), scroll () methods, the first level cache will always be used.  Actually, there is nothing more to add. <br><a name="habracut"></a><br><h5>  Second level cache </h5><br>  If the first-level cache is tied to a session object, then the second-level cache is tied to a session factory object.  What kind of implies that the visibility of this cache is much wider than the cache of the first level.  Example: <br><pre> <code class="java hljs">Session session = factory.openSession(); SharedDoc doc = (SharedDoc) session.load(SharedDoc.class, <span class="hljs-number"><span class="hljs-number">1L</span></span>); System.out.println(doc.getName()); session.close(); session = factory.openSession(); doc = (SharedDoc) session.load(SharedDoc.class, <span class="hljs-number"><span class="hljs-number">1L</span></span>); System.out.println(doc.getName()); session.close();</code> </pre><br>  In this example, 2 requests to the database will be executed, this is due to the fact that the second-level cache is disabled by default.  To enable, you need to add the following lines in your JPA configuration file (persistence.xml): <br><pre> <code class="java hljs">&lt;property name=<span class="hljs-string"><span class="hljs-string">"hibernate.cache.provider_class"</span></span> value=<span class="hljs-string"><span class="hljs-string">"net.sf.ehcache.hibernate.SingletonEhCacheProvider"</span></span>/&gt; <span class="hljs-comment"><span class="hljs-comment">//     //&lt;property name="hibernate.cache.provider_class" value="org.hibernate.cache.EhCacheProvider"/&gt; &lt;property name="hibernate.cache.use_second_level_cache" value="true"/&gt;</span></span></code> </pre><br>  Notice the first line.  Actually, he does not implement caching as such.  And only provides the structure for its implementation, so you can connect any implementation that meets the specifications of our ORM framework.  From popular implementations, you can select the <a href="http://docs.jboss.org/hibernate/core/3.3/reference/en/html/performance.html">following</a> : <br><ul><li>  Ehcache </li><li>  OSCache </li><li>  Swarmcache </li><li>  JBoss TreeCache </li></ul><br>  In addition to all this, most likely, you will also need to separately configure the implementation of the cache itself.  In the case of EHCache, this must be done in the <a href="">ehcache.xml</a> file.  Well and in completion still it is necessary to specify to the most what exactly to cache.  Fortunately, this can be done very easily using annotations, like this: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"shared_doc"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Cache</span></span>(usage = CacheConcurrencyStrategy.READ_WRITE) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SharedDoc</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Set&lt;User&gt; users; }</code> </pre><br>  Only after all these manipulations will the second level cache be included and in the example above only 1 request will be executed into the database. <br>  Another important detail about the second-level cache about which it would be worth mentioning is that the hibernate does not store the objects of your classes themselves.  It stores information in the form of arrays of strings, numbers, etc. And the object identifier acts as a pointer to this information.  Conceptually, this is something like a Map, in which the object id is the key, and the data arrays are the value.  Approximately you can imagine it like this: <br><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> -&gt; { <span class="hljs-string"><span class="hljs-string">"Pupkin"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> , {<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>} }</code> </pre><br>  What is very reasonable, considering <a href="http://habrahabr.ru/blogs/java/134102/">how much extra memory</a> each object takes. <br>  In addition to the above, it should be remembered - the dependencies of your class by default are also not cached.  For example, if we consider the class above - SharedDoc, then when sampling the collection of users will come from the database, and not from the second-level cache.  If you also want to cache dependencies, the class should look like this: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"shared_doc"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Cache</span></span>(usage = CacheConcurrencyStrategy.READ_WRITE) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SharedDoc</span></span></span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Cache</span></span>(usage = CacheConcurrencyStrategy.READ_WRITE) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Set&lt;User&gt; users; }</code> </pre><br><br>  And the last detail - reading from the second level cache occurs only if the desired object was not found in the first level cache. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Query cache </h5><br>  Rewrite the first example like this: <br><pre> <code class="java hljs">Query query = session.createQuery(<span class="hljs-string"><span class="hljs-string">"from SharedDoc doc where doc.name = :name"</span></span>); SharedDoc persistedDoc = (SharedDoc) query.setParameter(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, <span class="hljs-string"><span class="hljs-string">"first"</span></span>).uniqueResult(); System.out.println(persistedDoc.getName()); user1.setDoc(persistedDoc); persistedDoc = (SharedDoc) query.setParameter(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, <span class="hljs-string"><span class="hljs-string">"first"</span></span>).uniqueResult(); System.out.println(persistedDoc.getName()); user2.setDoc(persistedDoc);</code> </pre><br>  The results of such queries are not saved by either the first or second level cache.  This is the place where you can use the query cache.  It is also disabled by default.  To enable it, add the following line to the configuration file: <br><pre> <code class="java hljs">&lt;property name=<span class="hljs-string"><span class="hljs-string">"hibernate.cache.use_query_cache"</span></span> value=<span class="hljs-string"><span class="hljs-string">"true"</span></span>/&gt;</code> </pre><br>  and also rewrite the example above by adding after creating the Query object (the same is true for Criteria): <br><pre> <code class="java hljs">Query query = session.createQuery(<span class="hljs-string"><span class="hljs-string">"from SharedDoc doc where doc.name = :name"</span></span>); query.setCacheable(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>);</code> </pre><br>  Query cache is similar to the second level cache.  But unlike it, the key to the cache data is not an object identifier, but a set of query parameters.  And the data itself is the identifiers of objects that match the query criteria.  Thus, this cache is rationally used with a second-level cache. <br><br><h6>  Caching strategies </h6><br>  Caching strategies determine cache behavior in certain situations.  There are four groups: <br><ul><li>  Read-only </li><li>  Read-write </li><li>  Nonstrict-read-write </li><li>  Transactional </li></ul><br>  Read more <a href="http://docs.jboss.org/hibernate/core/3.3/reference/en/html/performance.html">here</a> . <br><br><h6>  Cache region </h6><br>  The region or region is the logical separator of your cache memory.  For each region, you can configure your own caching policy (for EhCache in the same ehcache.xml).  If the region is not specified, the default region is used, which has the full name of your class for which caching is applied.  The code looks like this: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Cache</span></span>(usage = CacheConcurrencyStrategy.READ_WRITE, region = <span class="hljs-string"><span class="hljs-string">"STATIC_DATA"</span></span>)</code> </pre><br>  And for the query cache like this: <br><pre> <code class="java hljs">query.setCacheRegion(<span class="hljs-string"><span class="hljs-string">"STATIC_DATA"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    criteria.setCacheRegion("STATIC_DATA");</span></span></code> </pre><br><br><h6>  What else do you need to know? </h6><br>  During the development of the application, especially at first, it is very convenient to see whether certain requests are really cached, for this you need to specify the following properties to the session factory: <br><pre> <code class="java hljs">&lt;property name=<span class="hljs-string"><span class="hljs-string">"hibernate.show_sql"</span></span> value=<span class="hljs-string"><span class="hljs-string">"true"</span></span>/&gt; &lt;property name=<span class="hljs-string"><span class="hljs-string">"hibernate.format_sql"</span></span> value=<span class="hljs-string"><span class="hljs-string">"true"</span></span>/&gt;</code> </pre><br>  In addition, the session factory can also generate and save statistics on the use of all objects, regions, dependencies in the cache: <br><pre> <code class="java hljs">&lt;property name=<span class="hljs-string"><span class="hljs-string">"hibernate.generate_statistics"</span></span> value=<span class="hljs-string"><span class="hljs-string">"true"</span></span>/&gt; &lt;property name=<span class="hljs-string"><span class="hljs-string">"hibernate.cache.use_structured_entries"</span></span> value=<span class="hljs-string"><span class="hljs-string">"true"</span></span>/&gt;</code> </pre><br>  For this, there are Statistics objects for the factory and SessionStatistics for the session. <br><br>  Session methods: <br>  flush () - synchronizes session objects from the database and at the same time updates the session cache itself. <br>  evict () - needed to remove an object from the session cache. <br>  contains () - determines whether the object is in the session cache or not. <br>  clear () - clears the entire cache. <br><br><h6>  Conclusion </h6><br>  That's all.  Naturally, there are still quite a few different nuances out of the article that arise when working with a cache, as well as many problems.  But this is a topic for another article. </div><p>Source: <a href="https://habr.com/ru/post/135176/">https://habr.com/ru/post/135176/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135169/index.html">Mozilla and Google signed a three-year cooperation agreement.</a></li>
<li><a href="../135170/index.html">Creation and processing of print form templates</a></li>
<li><a href="../135171/index.html">Well, a very inexpensive telepresence robot based on a laptop and motorcycle carts</a></li>
<li><a href="../135172/index.html">Forismatic 3.0 - quotes on iPad and iPhone</a></li>
<li><a href="../135173/index.html">Your move, comrade .NET, or Reversi again under nanoCAD</a></li>
<li><a href="../135178/index.html">Radeon HD 7970 Graphics Card Announced</a></li>
<li><a href="../135179/index.html">About personal programming experience in transport, McDonald's and other crowded and noisy places.</a></li>
<li><a href="../135180/index.html">About the sad test</a></li>
<li><a href="../135182/index.html">Canobuvosti, 123rd edition</a></li>
<li><a href="../135183/index.html">Abnormal Agile in Finance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>