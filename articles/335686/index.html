<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Add two-factor OTP authentication to SSH in 10 minutes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Situation: you have a park of Linux-servers where you regularly log in via SSH. Two-factor authentication for SSH with an iron key or Google Authentic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Add two-factor OTP authentication to SSH in 10 minutes</h1><div class="post__text post__text-html js-mediator-article">  Situation: you have a park of Linux-servers where you regularly log in via SSH.  Two-factor authentication for SSH with an iron key or Google Authenticator is configured, maybe simple, but it‚Äôs not always convenient to make this setting on each server, there may be too many of them, or it‚Äôs just scary to restart sshd :) <br><br>  A way out of this situation may be an intermediate authentication server.  We have already written <a href="https://habrahabr.ru/company/itsumma/blog/334148/">about the layout of our solution (Isolate) in open source</a> , in the same article - instructions for setting up an authentication server with two-factor authentication using one-time keys via Google Authenticator. <br><br><img src="https://habrastorage.org/web/4ad/fc4/956/4adfc49563a143a4a8e40e4c959e1a00.jpg" alt="image"><br><a name="habracut"></a><br>  Let's start with the Isolate deployment, for this you need CentOS 7, Ubuntu 16.04 or a Debian 8 machine: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1. Prepare the system for installing Isolate: <br><br>  <i>Centos:</i> <pre><code class="bash hljs">yum install ansible git</code> </pre> <br>  <i>Ubuntu:</i> <pre> <code class="bash hljs">apt update; apt install git python-pip pip install ansible</code> </pre> <br><br>  2. Download Isolate itself: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/itsumma/isolate.git</code> </pre> <br>  3. To run ansible on the same machine, we bring it to the form (you can run either from a remote machine, server or desktop Linux / MacOS, or directly on the machine on which you deploy Isolate): <br><br><pre> <code class="bash hljs">[main] localhost ansible_connection=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span></code> </pre> <br>  four. <br><br><pre> <code class="bash hljs">ansible-playbook -i isolate/ansible/hosts.ini isolate/ansible/main.yml</code> </pre> <br>  We are waiting for execution.  In case Ubuntu swears at the Upgrading installed packages (APT) step, we do: <br><br><pre> <code class="bash hljs">apt dist-upgrade</code> </pre> <br>  5. Add to the end / etc / bashrc (Centos) or /etc/bash.bashrc (Ubuntu) <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f /opt/auth/shared/bash.sh ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> /opt/auth/shared/bash.sh; <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br>  6. Reboot the machine.  Done! <br><br><h3>  Getting Started with oauth </h3><br>  1. Add to the end of /etc/pam.d/sshd (Centos) a line, or in /etc/pam.d/common-auth (Ubuntu) <br><br><pre> <code class="bash hljs">auth required pam_oath.so usersfile=/etc/oath/users.oath window=20 digits=6</code> </pre> <br>  2 <br><br><pre> <code class="bash hljs">sed -i -e <span class="hljs-string"><span class="hljs-string">'s/ChallengeResponseAuthentication no/ChallengeResponseAuthentication yes/g'</span></span> /etc/ssh/sshd_config</code> </pre> <br>  3. At the end of / etc / ssh / sshd_config <br><br><pre> <code class="bash hljs">Match Group auth AuthenticationMethods keyboard-interactive</code> </pre> <br>  four. <br><br><pre> <code class="bash hljs">systemctl restart sshd</code> </pre> <br>  5. Add a user to enable oauth <br><br><pre> <code class="bash hljs">auth-add-user _</code> </pre> <br>  6. Generate TOTP or HOTP tokens: <br><br><pre> <code class="bash hljs">gen-oath-safe _ totp gen-oath-safe _ hotp</code> </pre> <br><img src="https://habrastorage.org/web/58c/25f/791/58c25f791870438bb7244394e1dabbf4.jpg" alt="image"><br><br>  Add a token through a QR code in Google Authenticator: <br><br><img src="https://habrastorage.org/web/30e/34e/011/30e34e01179e476695f3c9b510c47d75.jpg" alt="image"><br><br>  7 <br><br><pre> <code class="bash hljs">touch /etc/oath/users.oath chmod 0600 /etc/oath/users.oath</code> </pre> <br>  8. Add the line obtained in paragraph 6 to /etc/oath/users.oath <br><br>  9. We look at the password from redis <br><br><pre> <code class="bash hljs">grep requirepass /etc/redis.conf</code> </pre> <br>  Add an entry to / etc / bashrc (Centos) or /etc/bash.bashrc (Ubuntu) <br><br><pre> <code class="bash hljs">ISOLATE_BACKEND=redis ISOLATE_REDIS_HOST=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>; ISOLATE_REDIS_PORT=<span class="hljs-string"><span class="hljs-string">"6379"</span></span>; ISOLATE_REDIS_DB=0; ISOLATE_REDIS_PASS=redis_pass; <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ISOLATE_REDIS_HOST; <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ISOLATE_REDIS_PORT; <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ISOLATE_REDIS_PASS; <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ISOLATE_REDIS_DB;</code> </pre> <br><h4>  Add servers </h4><br>  Now that we have a ready server for two-factor authentication, we can add our own servers.  To do this, you must first add the server information to Isolate, then create users and put the keys on the target server. <br><br>  Add a server to which we will go: <br><br><pre> <code class="bash hljs">auth-add-host --project server-admin --server-name ubuntu --ip 10.0.0.1</code> </pre> <br>  You can view the list of servers using the s command: <br><br><img src="https://habrastorage.org/web/49d/f27/0f9/49df270f973e410b9c423312ea57df25.jpg" alt="image"><br><h4>  Add user to server </h4><br>  On the server 10.0.0.1 we create the user support and assign it the key from /home/auth/.ssh/id_rsa.pub from the Isolate server: <br><br><pre> <code class="bash hljs">SUPPORT_USER=<span class="hljs-string"><span class="hljs-string">"support"</span></span> KEY=<span class="hljs-string"><span class="hljs-string">"&lt;YOU KEY HERE&gt;"</span></span> useradd -m <span class="hljs-variable"><span class="hljs-variable">${SUPPORT_USER}</span></span> mkdir /home/<span class="hljs-variable"><span class="hljs-variable">${SUPPORT_USER}</span></span>/.ssh <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">${KEY}</span></span> &gt;&gt; /home/<span class="hljs-variable"><span class="hljs-variable">${SUPPORT_USER}</span></span>/.ssh/authorized_keys chmod 600 /home/<span class="hljs-variable"><span class="hljs-variable">${SUPPORT_USER}</span></span>/.ssh/authorized_keys chmod 700 /home/<span class="hljs-variable"><span class="hljs-variable">${SUPPORT_USER}</span></span>/.ssh/ chown -R <span class="hljs-variable"><span class="hljs-variable">${SUPPORT_USER}</span></span>:<span class="hljs-variable"><span class="hljs-variable">${SUPPORT_USER}</span></span> /home/<span class="hljs-variable"><span class="hljs-variable">${SUPPORT_USER}</span></span>/.ssh/ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${SUPPORT_USER}</span></span></span><span class="hljs-string"> ALL=(ALL) NOPASSWD: ALL"</span></span> &gt;&gt; /etc/sudoers</code> </pre> <br>  Now on the Isolate server, we can use the s commands to find the server we need and g to go to a specific server: <br><br><pre> <code class="bash hljs">g ip_ - g 10.0.0.1 g  _ - g server-admin ubuntu</code> </pre> <br>  Now you need to go to all the added servers from the authentication one: by one-time code and password, go to Isolate, and then to the required server.  Direct on the server in this case, you should not go, because then the meaning of two-factor authorization is lost.  Well, in general, remove the keys, users, etc.  :) <br><br>  As usual, comments, additions and, of course, pool requests are welcome!  <a href="https://github.com/itsumma/isolate">Github project</a> . </div><p>Source: <a href="https://habr.com/ru/post/335686/">https://habr.com/ru/post/335686/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335674/index.html">Construction of wireless networks of all sizes based on TP-Link equipment</a></li>
<li><a href="../335676/index.html">Bug Bounty: Earn from the mistakes of others</a></li>
<li><a href="../335678/index.html">Three strategies for testing Terraform</a></li>
<li><a href="../335680/index.html">Debugging Xamarin projects from VirtualBox on the Android emulator</a></li>
<li><a href="../335684/index.html">PYCON RUSSIA 2017: video of all reports and presentations</a></li>
<li><a href="../335688/index.html">Part 2. At first they steal, and when you win, they kill you</a></li>
<li><a href="../335690/index.html">Service out of the box: set up ServiceNow "in 60 seconds"</a></li>
<li><a href="../335692/index.html">Colorful code: how color helps in working with code</a></li>
<li><a href="../335694/index.html">Digital agency / production performance indicators (examples from the West)</a></li>
<li><a href="../335696/index.html">The idea of ‚Äã‚Äãblack and white cinema, correct bees and unarmed ninjas in site optimization</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>