<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New Home Mail.Ru portal</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think many of you have ever seen the old Mail.Ru main page, which has not changed for a long time. Therefore, for general understanding, a small pre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New Home Mail.Ru portal</h1><div class="post__text post__text-html js-mediator-article">  I think many of you have ever seen the old Mail.Ru main page, which has not changed for a long time.  Therefore, for general understanding, a small preamble: the technical update, which will be discussed in this post, became possible after internal changes in the company. <br><br><img src="https://habrastorage.org/storage2/180/9b8/4da/1809b84da646e55306e2a0fc727aee94.png"><br><br>  A rather large team was engaged in the development of the <a href="http://mail.ru/">main one</a> : it included designers, usability specialists and, of course, developers, including me and <a href="http://habrahabr.ru/users/note/" class="user_link">note</a> . <br><a name="habracut"></a><br><img src="https://habrastorage.org/storage2/df7/27f/8fe/df727f8fe8cf76008234ab08cfd7c269.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First, the old page was overlaid on the tables and did not load as fast as we would like.  So, the first step was to speed up the download. <br><br>  Secondly, it was necessary to modernize the page both visually and technologically.  The page should meet current expectations and trends. <br>  For example, I can say that one of the requirements for the redesign was the absence of a scroll. <br><br>  First things first. <br><br><h4>  Fast download </h4><br><br>  Mail.ru download users with both good and very slow Internet channel.  We wanted the portal navigation, logo, mail and social blocks to be displayed as quickly as possible so that users with a slow channel could start working with the page as soon as possible. <br><br><img src="https://habrastorage.org/storage2/65c/e0a/4c5/65ce0a4c5dabb3f1d3207dc9c7b8cd5e.png"><br><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-comment"><span class="css"><span class="hljs-comment">/* mailbox styles */</span></span></span><span class="css"> </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mailbox"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- mailbox HTML --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">// mailbox JS </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  To do this, we placed in front of the HTML code of each of the blocks the CSS rules describing it in the style tag.  The browser, having on hand everything necessary for rendering the block, does it right away. <br><br>  To prevent the block from being drawn already, but it still does not fulfill its function, for example, the authorization form in the mail block with ‚Äúcustom‚Äù interface elements, right after HTML, the basic JS functionality is placed in inline scripts. <br><br>  Thus, the accelerated blocks are displayed sequentially as the page loads, and after drawing are fully functional. <br><br><img src="https://habrastorage.org/storage2/f07/fb5/96e/f07fb596ed3a41f839788397aede3ea3.png"><br><br>  Then you can do the rest of the blocks. <br>  After the left column, we load the external style sheet containing the remaining rules, the center HTML, the extended functionality script, and the right HTML column. <br><br>  We have experimentally found the optimal place to load the JS-file with extended functionality. <br>  According to our measurements, the transitions to the Search are highly dependent on the presence of search sadzhestov.  Therefore, the script containing the logic of sadzhestov, I want to download as close as possible to the search block.  But below in the central column there are not less important blocks with content followed by users on the page.  So, move the script for the central column. <br><br>  If you rearrange the script a little further along the code, you will have to wait for the banner to load, which on average is loaded 180ms, and the central column is two times less. <br>  Accordingly, the optimal place is between the central and left columns. <br><br><img src="https://habrastorage.org/storage2/86f/c58/a4d/86fc58a4d12a61b4db3be1f30ae72376.png"><br><br>  The next step is loading the blocks, which are not possible or necessary to load immediately. <br>  This is a block with photos in the left column and hidden news tabs. <br><br><img src="https://habrastorage.org/storage2/423/54e/3c6/42354e3c6cef2f0d05485430a64f02f0.png"><br><br>  The block with the photo contains external non-static content.  These are images that the user in any case will see later on the left column display, since  you will have to wait for them to download, which means you can postpone the download. <br><br>  Initially, instead of a block, there is a placeholder that simply occupies the necessary space.  At the end of the page, in post-loading, the placeholder is replaced with the real block code and the loading of images begins. <br><br><img src="https://habrastorage.org/storage2/e16/d04/340/e16d04340cb56bdc7a2cd8569060a440.png"><br><br>  When loading the page, the user will see only one tab of the news, and the rest - only after clicking on the taboo.  We put the hidden tabs in the post-load and substitute it in the right place only at the user's request, which significantly reduces the block loading time. <br><br><img src="https://habrastorage.org/storage2/bee/f29/48b/beef2948b502757f4523549babd7aeea.png"><br><br>  There are a number of rarely used blocks (such as various promotional popups), the elements of which are called before the blocks themselves are declared. <br>  For example, the ‚ÄúLearn more‚Äù link in the promo dash about a new design, opening a popup with additional information. <br><br>  Because  the block is rarely used, there is no point in loading it next to the link at the top of the page, slowing down the loading of more important content.  Therefore, the hidden popup is at the end of the page.  But the link is displayed almost immediately, and the user can click on it even before the popup is loaded. <br><br>  To handle such situations, we use a simple deferred function call system. <br>  A handler hangs on the link, storing the function passed to it in the queue: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"callbackQuery.run(function(){openPopup()});"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  At the end of the page, the queue handler is given the command that the page is loaded, the handler starts all the functions stored in the queue, after which all new functions transferred to it will be started immediately. <br><br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"popup"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="actionscript"><span class="hljs-function"><span class="hljs-title">openPopup</span></span></span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span></span><span class="actionscript">{ ‚Ä¶ } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> callbackQuery.loaded(); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><img src="http://habrastorage.org/storage2/e51/001/152/e5100115254fdc6714a1f820fcf78a12.png"><br><br>  Looking ahead, it is worth discussing the loading of the logo. <br>  There are actually two of them.  Large - for large resolutions, and small - for the rest. <br>  When the page loads, one of them will appear, and the user will still not see the second logo at the moment.  To postpone loading a hidden logo, use the following solution: <br>  Initially, in the code, instead of images, there are two span'ki with similar image classes <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> @</span><span class="hljs-keyword"><span class="css"><span class="hljs-keyword">media</span></span></span><span class="css"> all and (min-height: </span><span class="hljs-number"><span class="css"><span class="hljs-number">765px</span></span></span><span class="css">) { </span><span class="hljs-selector-class"><span class="css"><span class="hljs-selector-class">.logo__link__img_medium</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">display</span></span></span><span class="css">:none; } } @</span><span class="hljs-keyword"><span class="css"><span class="hljs-keyword">media</span></span></span><span class="css"> all and (min-height: </span><span class="hljs-number"><span class="css"><span class="hljs-number">765px</span></span></span><span class="css">) { </span><span class="hljs-selector-class"><span class="css"><span class="hljs-selector-class">.logo__link__img_wide</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">display</span></span></span><span class="css">:block; } } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"logo__link__img logo__link__img_medium"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"logo__link__img logo__link__img_wide"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  After that, the script determines which of them is hidden through the Media Queries to allow the given user and the corresponding image is added to the post download.  The second is displayed immediately. <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> logos.forEach(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">logo</span></span></span></span><span class="javascript"><span class="hljs-function">)</span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">if</span></span></span><span class="javascript"> (logo.currentStyle.display === </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"block"</span></span></span><span class="javascript">){ </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.write(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"&lt;img ‚Ä¶ /&gt;"</span></span></span><span class="javascript">); } </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">else</span></span></span><span class="javascript"> { </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> image = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.createElement(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"img"</span></span></span><span class="javascript">); ... } }); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Of course, both images are displayed in noscript for users with JS disabled. <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">noscript</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"logo__link__img logo__link__img_medium"</span></span></span><span class="hljs-tag"> ‚Ä¶ /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"logo__link__img logo__link__img_wide"</span></span></span><span class="hljs-tag"> ‚Ä¶ /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">noscript</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><h5>  CSS </h5><br><br>  The styles of each block are separated from each other and are each in their own file. <br><br><img src="http://habrastorage.org/storage2/6f3/5ae/ead/6f35aeead7480a066daa12f5de23a275.png"><br><br>  For blocks that need to be loaded quickly, styles are collected block by block into the appropriate subdirectories of the forced-blocks folder, and then automatically inserted into the style tag at the required place on the page. <br><br><pre> <code class="css hljs"><span class="hljs-comment"><span class="hljs-comment">/* css/forced-blocks/mailbox.scss */</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"../../blocks/mailbox/mailbox"</span></span>;</code> </pre><br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">fest:insert</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"css/forced-blocks/mailbox.scss"</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  The rest of the styles are collected in one file (/css/styles.scss) and uploaded to the page via the link after the left column. <br><br><pre> <code class="css hljs">@<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"blocks/news/_news.scss"</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"blocks/text-banner/_text-banner.scss"</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"blocks/banner/_banner.scss"</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"blocks/informers/_informers.scss"</span></span>;</code> </pre><br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"styles.css"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br><br>  This approach makes it easy to manipulate the loading block.  If we need to speed up a block, we just need to connect its styles differently. <br><br><h5>  Js </h5><br><br>  There are some nuances in the JS boot process too. <br>  The HEAD page inline loads the base part of the ‚Äúcore‚Äù, for example, the event handling functions necessary for the basic functionality of accelerated blocks. <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> mr = { bind: </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span></span><span class="actionscript">{} }; </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mailbox"</span></span></span><span class="hljs-tag">&gt;</span></span>...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> mr.bind </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Then the external script of the extended functionality is loaded, in which <br>  basic feature set is expanding. <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> extend(mr, { position: </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span></span><span class="actionscript">{} }); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Thus, loading scripts is also easy to manage. <br><br><h5>  What did it give </h5><br><br>  As a result of the work done, the following averaged figures were obtained: <br><ul><li>  The page is fully loaded 550ms after the start of the request, of which 16ms is the time the page is generated by the server. </li><li>  Portal navigation is displayed through 195ms <br></li><li>  Left column - 180ms </li><li>  Search - 40ms </li><li>  News - 12ms </li><li>  Informers - 30ms </li><li>  Banner - 180ms </li><li>  Styles - 190ms </li><li>  Post-loading - 117ms </li><li>  Scripts - 500ms </li></ul><br><br>  That well illustrates the video of the page loading process with a slow connection emulation. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/8mjdLkhR5Sw%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253,15700255,15700259&amp;usg=ALkJrhh7fjFZMsgOxsq0hoa2vw-uXIKSuw" frameborder="0" allowfullscreen=""></iframe><br><br><img src="http://habrastorage.org/storage2/9b2/a91/a18/9b2a91a18f5eaa6f63ffec2ac48e8419.png"><br><br>  As shown in the graph, the user sees most of the page, namely the portal navigation and the left and center columns after 600 milliseconds in a few milliseconds, and most of the functionality works after another 500ms.  And after 1.5 seconds the page is fully operational. <br><br><h4>  Scroll </h4><br><br><img src="http://habrastorage.org/storage2/d62/7c6/a53/d627c6a53a098143a6be6c8ea7bb7c11.png"><br><br>  The second big challenge was the lack of a scroll. <br>  Everyone immediately remembered the technology Media Queries, with which you can fit the page to the desired size. <br>  The main thing - to understand, under what customized. <br><br>  The simplest, at first glance, solution would be to look at the already available statistics on screen resolutions. <br><br><img src="http://habrastorage.org/storage2/e8e/916/c10/e8e916c10c75bac0e58030e31a144684.png"><br><br>  Although these data give an idea of ‚Äã‚Äãspecific figures, they do not give a real picture: they do not take into account the settings of the OS interface elements and the browser.  It is not clear how much space is available page. <br>  Therefore, it was decided to make their own measurements of real viewports. <br><br><img src="http://habrastorage.org/storage2/4a4/cfe/926/4a4cfe92608da42edf531e83222ad307.png"><br>  The x axis is the height of the viewport, and the y axis is the number of users whose viewport is less than this height. <br><br>  At first we measured the viewport on the loading page.  But it seemed to us that we should not rely on this data, since  we all often saw users open the page, then maximize the browser window and continue working with the page. <br>  We counted the number of resize windows.  There are quite a few users who do this, about 12%. <br>  To confirm our guesses, we decided to measure the maximum viewport per session.  As well as the maximum viewport per session in browsers that do not support Media Queries, which our users have quite a lot - about 15%. <br><br><img src="http://habrastorage.org/storage2/c0f/a69/cef/c0fa69cefed94c968a21bb1b759d6ac8.png"><br><br>  The data obtained confirmed our guesswork. <br>  The graph shows that the same users have one window size when opening a page, and later a different one. <br><br>  The graphs clearly show jumps, meaning that at this height there are a lot of users.  We decided to focus on these races. <br><br><img src="http://habrastorage.org/storage2/244/bd2/5a6/244bd25a68bf5a4890320ed0e2df38c0.png"><br><br>  We chose the following values: <br><ul><li>  633px, slightly lower than the big jump </li><li>  765px, which is slightly lower than the second group of jumps </li><li>  830px - the maximum height above which we change nothing </li></ul><br><br><img src="http://habrastorage.org/storage2/647/ef2/ec3/647ef2ec3890cab28a9373edfa7eb103.png"><br><br>  What does 633px mean? <br>  That 21% of users who have a smaller viewport will see a scroll.  It did not suit us, and we broke this area with another value of 576px - where there are practically no changes on the graph. <br><br><img src="http://habrastorage.org/storage2/baa/532/f42/baa532f42a9aac14c281fe97f33194ac.png"><br><br>  We also decided to split the region from 633 to 765 pixels with another value of 670 pixels.  Exclusively for aesthetic reasons, we decided to fill the free space of a large group of users. <br><br>  So, starting from 576px, the user does not have a scroll. <br><br>  At 633px we change the indents, display the captions in the left column, additional information on the main news and a couple of games in the right column. <br><br>  At 670px we simply change the padding to fill the free space. <br><br>  At 765px, we increase the logo and photo block in the left column, display the ‚ÄúNow Looking for‚Äù block under the search, additional information blocks and a big game in the right column. <br><br>  At 830px, indents are changed and additional news is displayed. <br><br>  The width also has changes. <br>  On wide pages, indents between the columns are increased, and on narrow ones, the news tabs that do not fit are transferred to the ‚ÄúMore‚Äù dropout. <br><br>  For browsers without Media Queries, we chose the 633px height option. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/xjprkUr-U54%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253,15700255,15700259&amp;usg=ALkJrhgpUTP-4GPOrkzl6qV2TBTnT88IGw" frameborder="0" allowfullscreen=""></iframe><br><br><h5>  Implementation </h5><br><br>  The Media Queries code and threshold numbers can change at any time. <br>  Therefore, in order not to have to shovel the half-project, you need a centralized place for generating media expressions. <br>  We decided to use the SASS mixin. <br><br>  For a block, the default styles are first specified, and below, in minxin, dynamic styles are transferred with an indication of the heights and axis to which they should be applied. <br><br><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.someblock</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin-top</span></span>:<span class="hljs-number"><span class="hljs-number">10px</span></span>; @include respond-to-media(xsmall, vertical, margin-top, 5px); @include respond-to-media(small, vertical, margin-top, 10px); } @<span class="hljs-keyword"><span class="hljs-keyword">mixin</span></span> respond-to-media($screen, $direction, $property, $value: <span class="hljs-string"><span class="hljs-string">""</span></span>) { @<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $direction == vertical { @<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $screen == xsmall { @<span class="hljs-keyword"><span class="hljs-keyword">media</span></span> only screen and (max-height: <span class="hljs-number"><span class="hljs-number">632px</span></span>) { ... } } @<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> if $screen == small { @<span class="hljs-keyword"><span class="hljs-keyword">media</span></span> only screen and (min-height: <span class="hljs-number"><span class="hljs-number">633px</span></span>) and (max-height: <span class="hljs-number"><span class="hljs-number">668px</span></span>) {...} } ... } @<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> if $direction == horizontal { ... } }</code> </pre><br><br>  Mixin understands the media expression to be output by the transmitted constants, and the result is the following code: <br><br>  Default state <br><br><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.someblock</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin-top</span></span>:<span class="hljs-number"><span class="hljs-number">5px</span></span>; }</code> </pre><br><br>  And state changes for browsers that support Media Queries <br><br><pre> <code class="css hljs">@<span class="hljs-keyword"><span class="hljs-keyword">media</span></span> only screen and (max-height: <span class="hljs-number"><span class="hljs-number">632px</span></span>) { <span class="hljs-selector-class"><span class="hljs-selector-class">.someblock</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin-top</span></span>:<span class="hljs-number"><span class="hljs-number">5px</span></span>; } } @<span class="hljs-keyword"><span class="hljs-keyword">media</span></span> only screen and (min-height: <span class="hljs-number"><span class="hljs-number">633px</span></span>) and (max-height: <span class="hljs-number"><span class="hljs-number">668px</span></span>) { <span class="hljs-selector-class"><span class="hljs-selector-class">.someblock</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin-top</span></span>:<span class="hljs-number"><span class="hljs-number">10px</span></span>; } }</code> </pre><br><br><h4>  Synchronization with portal navigation </h4><br><br><img src="http://habrastorage.org/storage2/098/c24/ea4/098c24ea45c3229264a11fb5d02dda4c.png"><br><br>  The entire Mail.Ru portal at the top of the page contains a single block of active portal navigation. <br>  It updates user data by timeout: the number of unread emails in the Mail, the number of new events in My World and Odnoklassniki. <br><br>  The new main page in the left column, in addition to the mail block, contains extensive information on social networks, which also needs to be dynamically updated. <br><br>  The first problem is that we receive data from different sources: in the portal navigation data from My World and Mail from one server, Odnoklassniki from another, and extended data on My World we receive from the main page itself. <br><br>  The second problem is that the portal navigation, being cross-portal, is highlighted in a separate project, and we cannot influence it on the page, and the data needs to be updated synchronously: when receiving data from the Odnoklassniki in the portal navigation, the data on the page is also updated, when receiving data on My World and Mail, make a request for the expanded data of My World, update your part of the page, and only then update the portal navigation. <br><br>  To do this, JSONP callbacks in portal navigation introduced the ability to give control to scripts on the page and update the numbers on the reverse command. <br><br>  Rendering is started only if no callback is declared on the page that returns false. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   function JSONPCallback(data){ var _cb = JSONPCallback._pageCallback; if (typeof _cb == 'function' &amp;&amp; _cb(data, draw) !== false){ draw(); }; function draw(){ //    } }</span></span></code> </pre><br><br>  If you declare such a callback, you can make an asynchronous request, update the necessary blocks on the page, and only then return control of the portal navigation by running the transferred portal navigation drawing function. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  JSONPCallback._pageCallback = function(data, draw){ new AJAX('/', ‚Ä¶, function(data){ //    ‚Ä¶ //     draw(); }); //  false,      return false; }</span></span></code> </pre><br><br>  So  The page can control the display of updates depending on the availability of the necessary information. <br><br><h4>  Results </h4><br><br><ul><li>  Accelerated loading of the page as a whole and controllability of loading stages on slow channels </li><li>  Get rid of the scroll - all content is available on one screen </li><li>  Job stability </li></ul><br><br>  Although the topic of stability is beyond the scope of this article, I can‚Äôt leave it alone. <br>  The main page, in fact, is an aggregator of data from different projects.  Previously, we received HTML blocks directly from projects.  It is a lot of projects, to control issue it is unreal.  Chances are high that the page will fall apart due to an unclosed attribute or some other error. <br>  In the process of developing a new main page, we switched to data acquisition and transformation already on our side, which significantly reduced the likelihood of an explosion. <br><br>  Yegor Dydykin, <br>  leader of the development team for the main Mail.Ru page and cross-portal projects </div><p>Source: <a href="https://habr.com/ru/post/142193/">https://habr.com/ru/post/142193/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142187/index.html">Testing video codecs. Episode I: the hidden problem</a></li>
<li><a href="../142188/index.html">PyCharm 2.5 came out with support for remote interpreters, improved virtualenv, SVN 1.7, etc.</a></li>
<li><a href="../142190/index.html">Reliable alarm clock for those who can not wake up at the right time</a></li>
<li><a href="../142191/index.html">Clojure 1.4 release</a></li>
<li><a href="../142192/index.html">"Hacker" caught for tits</a></li>
<li><a href="../142194/index.html">Microsoft is recruiting a team of developers browser version of Skype</a></li>
<li><a href="../142195/index.html">PHP sucks! But I love him!</a></li>
<li><a href="../142197/index.html">Standard open source documentation</a></li>
<li><a href="../142198/index.html">Backup - virtual clones against non-consistent centaurs</a></li>
<li><a href="../142200/index.html">Homemade PIR (PIC) detector from Arduino</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>