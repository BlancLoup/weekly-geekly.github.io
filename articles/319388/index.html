<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>BLE under the microscope 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="BLE under the microscope. Part 2  part 3 
 In the first part, we analyzed why the Bluetooth LE standard was invented, and also considered the format o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>BLE under the microscope 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/408/ea7/79a/408ea779ab2a443c93e61c1166a27615.png" alt="image"><br><br><h2>  BLE under the microscope.  Part 2 </h2>  <a href="https://habrahabr.ru/post/321052/">part 3</a> <br>  In the first <a href="https://habrahabr.ru/post/319244/">part,</a> we analyzed why the Bluetooth LE standard was invented, and also considered the format of advertising packages ‚Äúadvertising‚Äù.  In this part, we will continue to study the features of the format and consider the mechanism for attaching a BLE device to a smartphone. <br><a name="habracut"></a><br><h3>  BLE Modes </h3><br>  First we will talk about the different modes of operation of BLE devices.  Let's start with the simplest.  For unidirectional data transfer, for example, from a street thermometer to a telephone, there is a beacon format.  The device transmits static or slowly changing dynamic data on the air.  Here, users are cautioned by the pitfall.  If you scan the broadcast using the menu item android (Settings =&gt; BlueTooth), we will not see the beacons.  It's all about the type of scan.  There is an active and passive scan.  Passive scanning simply listens to the broadcast, and with active scanning, an additional request is made to the BLE device.  There is a fundamental difference in the mode of operation of the advertisers. <br><br>  Lighthouses have the header ADV_NONCONN_IND.  This means that they are not attached and do not carry additional information, except for the one that is already contained in the package.  Due to the fact that they have no additional functions and reception mode, all the energy goes only to the transmission of advertising packages.  This is the most economical type of operation for BLE devices.  However, in order to see them, you need to use a special program on your smartphone with passive scanning mode.  In principle, the information in the beacon package may vary.  For example, you need to transfer more information than it holds for one packet.  Then a cyclic change of information that the lighthouse transmits is possible. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Features passive scanning is that all the data that the android receives from the beacon package, it immediately transmits to the user application.  With active scanning, the application will not see the BLE device until the gadget responds to the scan request from the smartphone.  This is the most common mode of operation of devices.  Consider its features.  When scanning, when a smartphone receives a message from a device (such as ADV_IND or ADV_SCAN_IND) on one of the ad channels, it sends a request on the same channel.  This is an empty SCAN_REQ command. <br><br><img src="https://habrastorage.org/files/112/e6c/551/112e6c551f1449a693bb72ac0c7ec4fb.png" alt="image"><br><br>  It must be transmitted no later than the time T_IFS (Time Inter Frame Space), which is 150 Œºs.  In order for the ad unit to hear this request, after each advertising message it is delayed on the channel for the time T_IFS.  At the same time, naturally, additional energy is consumed.  If the request is received, the device responds with a send SCAN_RSP.  The figure shows that the maximum response delay time is also T_IFS. <br><br>  And here users are waiting for another pitfall.  The fact is that the operating system of the smartphone, after receiving the response command SCAN_RSP, remembers the parameters of the device.  She continues from time to time to repeat her SCAN_REQ requests to the gadget, but they are not regular.  And at the request of the user application, the system will issue the latest data, regardless of the application needs.  Therefore, in order to update the data, for example, from the position sensor, it will be necessary to restart the scanning process on the phone.  Therefore, devices with the ADV_IND and ADV_SCAN_IND header are poorly suited for transmitting rapidly changing data in a beacon mode.  It is better to go through the joining procedure and switch to the working channels.  This will be discussed below, but we will immediately indicate that only ADV_IND devices can do this. <br><br>  At the end of the chapter I want to make out an interesting feature of the SCAN_REQ and SCAN_RSP commands.  The fact is that the response command SCAN_RSP can be either empty or contain any useful information.  This is used in two cases.  First, when all the necessary information does not fit into one package.  Secondly, when they want to save battery energy.  This is done like this.  The advertising package itself is as short as possible.  It includes only the header, flags and MAC address of the device.  And when SCAN_REQ is requested, the device sends all additional information about itself (for example, name, battery level, etc.) already in frame SCAN_RSP.  The operating system on the phone stitches all the information in one unit. <br><br><h3>  Joining mode </h3><br>  In order to fully utilize all the resources of the BLE protocol, it is necessary to work at working frequencies.  This is a synchronous mode of operation.  Consider how to create it.  After the smartphone, in response to the request with the active scan, receives the frame SCAN_RSP, it becomes possible to attach the gadget to the phone.  The connection process is usually started by the user, but can also be started by the application if the connection is broken.  It was for the sake of synchronous mode that BLE was created.  After the connection, both the gadget and the phone go into an economical mode.  Devices cease to transmit on advertising frequencies, and begin to work on the other 37 channels.  Consider how this happens.  Take a look at the picture. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a6a/540/e04/a6a540e0481efe3de372f69036748949.png" alt="image"><br><br>  In response to the user's request to attach the gadget, the android sends the CONNECT_REQ packet.  It must be sent no later than T_IFS wait time.  This package contains complete information on which frequencies, with which interval and with which Access Address the smartphone offers to exchange data.  Here is the data format of this package. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5ac/a95/e48/5aca95e48936d279def41adb9f8dc1a8.png" alt="image"><br><br>  How it looks in Wireshark is shown in the following figure.  In the Link Layer Data section, we see that the new Access Address is 0x21431df6.  Next come three bytes of the checksum 0x277d0f.  To get the following four time parameters, they must be multiplied by the corresponding coefficient. <br><br><blockquote>  transmitWindowSize = Win-Size * 1.25 ms <br>  transmitWindowOffset = WinOffset * 1.25 ms <br>  connInterval = Interval * 1.25 ms <br>  connSupervisionTimeout = Timeout * 10 ms </blockquote><br>  The ChM part describes those working channels on which further work is expected.  And in the part of Hop - at what interval the allowed channels will be moved.  According to the specification, Hop is in the range from 5 to 16. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b3/fe2/3da/8b3fe23da6a3adfc78853a1493349888.png" alt="image"><br><br>  The following figure schematically shows the mechanism for switching to operating frequencies. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a76/a0d/16b/a76a0d16b78a892d3d15af895c5e6571.png" alt="image"><br><br>  Further, the smartphone and the device begin to work in synchronous mode at operating frequencies.  However, the smartphone (Master) can change the operating parameters of the gadget (Slave) at operating frequencies.  This most often happens when another device joins the phone.  To save energy, the smartphone is easier to build work with the attached devices in order to serve them consistently in one waking session.  In this case, the Feature Exchange Procedure is used.  It is in many ways similar to the accession procedure and occurs automatically, so we will not consider it. <br><br>  In the conclusion of the chapter, we will slightly touch on the topic of profiles.  In order to systematize the transmission and reception of data, services were entered into the BLE format.  These are the various tasks that the device can perform.  The service, for example, is the ability to report the battery voltage level, or reprogram the device over the air.  Profile, as a rule, combines several services.  A complete list of BLE device profiles can be found <a href="https://www.bluetooth.com/specifications/adopted-specifications">here</a> . <br><br>  To develop your own devices, the easiest way is to use the NUS (Nordic UART Service) profile.  To work with him, nordic-a has two applications.  One is the nRF UART 2.0.  Another, and in my opinion more convenient, part of the nRF Toolbox. <br><br><img src="https://habrastorage.org/files/6cf/b4a/fc5/6cfb4afc5c8d42e6982d2df7c483991b.png" alt="image"><br><br>  In this application there is a field of 9 cells, each of which can be assigned to any command, and on the cell itself to hang the icon.  Thus, you can get a ready-made remote control for controlling BLE devices.  For example, to control electronic toys. <br><br><h3>  Work with nRFgoStudio </h3><br>  Nordic has a universal tool for working with various whales - this is the nRFgoStudio program.  She, like others, can be downloaded on the manufacturer's website <a href="http://www.nordicsemi.com/eng/Products/Bluetooth-low-energy/">here</a> .  Connect your device or kit using the programmer to the computer.  Open nRFgoStudio and click on the nRF5x Programming line.  If the programmer sees the processor, a window will open as shown. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/29e/37e/8ac/29e37e8acec2b094b4984acd0cd070cd.png" alt="image"><br><br>  On the right side we see a window with three tabs: Program SoftDevise, Program Application, Program Bootloader.  The first window (Program SoftDevise) allows you to load the stack from Nordic-a into the processor, the second - the user application, and the third - the loader over the air (DFU).  The site has <a href="https://habrahabr.ru/post/246241/">an article</a> where it was already briefly covered. <br><br><h3>  Conclusion </h3><br>  I would like to note that we did not analyze in detail the advertising package advertising itself and the method of its formation.  Those who are interested in how to do it with pens, I refer to the <a href="https://habrahabr.ru/post/245671/">article</a> .  It indicates how you can try to work on a simpler Nordic chip nRF24L01, without using the stack.  This will allow a deeper understanding of the structure of the premise. <br><br>  In addition, you can learn to form these same packages, bypassing the stack, and on the nRF51822 b nRF52832 microcircuits.  This is much easier than working with a stack.  However, without the stack, we will not be able to work on working channels.  Self-implement synchronous mode will be very difficult.  The BLE theme is very extensive and constantly evolving.  Therefore, we certainly could not describe all the features of this protocol.  But for the initial start of this information is more than enough.  Additional information can be found <a href="http://www.compel.ru/lib/ne/2015/11/3-mayachki-bluetooth-low-energy">here</a> , <a href="https://habrahabr.ru/company/intellectro/blog/246005/">here</a> and <a href="https://habrahabr.ru/post/248499/">here</a> . <br><br>  Pecherskikh Vladimir </div><p>Source: <a href="https://habr.com/ru/post/319388/">https://habr.com/ru/post/319388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319378/index.html">Powershell Practice: Monitoring Windows Backup Backup</a></li>
<li><a href="../319380/index.html">Exploit Exercises or another site for VulnHub lovers</a></li>
<li><a href="../319382/index.html">How PVS-Studio looks for errors: methods and technologies</a></li>
<li><a href="../319384/index.html">Direct disk access from python (simhdd)</a></li>
<li><a href="../319386/index.html">Modal windows and notifications in Angular</a></li>
<li><a href="../319392/index.html">Realistic UI: a realistic look at the Optimistic UI</a></li>
<li><a href="../319394/index.html">Own image slider on jQuery</a></li>
<li><a href="../319396/index.html">Evernote overview and integration (based on GTD using the Wunderlist example)</a></li>
<li><a href="../319398/index.html">‚ÄúMy cloud is my fortress‚Äù: Trends of cloud security</a></li>
<li><a href="../319400/index.html">Texture Remastering for BioShock: The Collection</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>