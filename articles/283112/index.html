<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We use undocumented site API captionbot.ai</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article we will discuss how to get and use the site's API, if there is no documentation on it or it is not yet officially open. The guide is w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We use undocumented site API captionbot.ai</h1><div class="post__text post__text-html js-mediator-article"><p>  In this article we will discuss how to get and use the site's API, if there is no documentation on it or it is not yet officially open.  The guide is written for beginners who have not tried to fix a simple API yet.  For those who are engaged in such things, there is nothing new here. </p><br><p>  The analysis will be conducted on the example of the service API <a href="https://www.captionbot.ai/">https://www.captionbot.ai/,</a> which Microsoft recently opened (thanks to them for this).  Many could read about it in <a href="https://geektimes.ru/post/274462/">article on Geektimes</a> .  The site uses ajax requests in JSON format, so copying them will be easy and pleasant.  Go! </p><br><p><img src="https://habrastorage.org/files/153/773/a30/153773a30f4941c6af156aebba590fbd.PNG" alt="KDPV"></p><a name="habracut"></a><br><h2>  We analyze requests </h2><br><p>  First of all, open the developer tools and analyze the requests that the site sends to the server. </p><br><p><img src="https://habrastorage.org/files/e8d/3dd/a6f/e8d3dda6f5f54ae39c8e7a529b2c5ca3.PNG" alt="image"></p><br><p>  In our case, all requests that interest us have the base URL <a href="https://www.captionbot.ai/api">https://www.captionbot.ai/api</a> </p><br><h3>  Initialization </h3><br><p> When you first open the site, there is a GET request for <code>/api/init</code> with no parameters. <br>  The answer has <code>Content-Type: application/json</code> , while in the body of the answer we just get a line of the form: </p><br><pre> <code class="hljs objectivec"><span class="hljs-string"><span class="hljs-string">"54cER5HILuE"</span></span></code> </pre> <br><p>  Remember this and move on. </p><br><h3>  Submit URL </h3><br><p>  We have two ways to upload an image: via the URL and via file upload.  For the test, we take the URL of Lena's image from the wiki and send it.  In the network activity, a POST request for <code>/api/message</code> appears with the following parameters: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"conversationId"</span></span>: <span class="hljs-string"><span class="hljs-string">"54cER5HILuE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"waterMark"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"userMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://upload.wikimedia.org/wikipedia/ru/2/24/Lenna.png"</span></span> }</code> </pre> <br><p>  Yeah, we tell ourselves, the <code>init</code> method returned us a string for <code>conversationId</code> , and our link got into <code>userMessage</code> .  What is <code>waterMark</code> is not yet clear.  We look at the response data: </p><br><pre> <code class="hljs tex">"{<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>ConversationId<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>:null,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>WaterMark<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>131071012038902294<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>UserMessage<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>I am not really confident, but I think it's a woman wearing a hat<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>nand she seems . <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>Status<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>:null}"</code> </pre> <br><p>  For some reason JSON was encoded twice, but oh well.  In human form, it looks like this: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"ConversationId"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"WaterMark"</span></span>: <span class="hljs-string"><span class="hljs-string">"131071012038902294"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"UserMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"I am not really confident, but I think it's a woman wearing a hat\\nand she seems ."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Status"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }</code> </pre> <br><p>  All the parameters along the way changed the style of writing, but this is the little things in life.  So, we were given back some <code>WaterMark</code> value, for some reason, an empty <code>ConversationId</code> , the actual caption to the photo in the <code>UserMessage</code> field <code>UserMessage</code> and some empty status. </p><br><h3>  Loading image </h3><br><p>  Next, without closing the tab, we try the same operation with loading photos from a local file.  We see a POST request for <code>/api/upload</code> in <code>multipart/form-data</code> format with the name of the <code>file</code> field: </p><br><pre> <code class="hljs kotlin">-----------------------------<span class="hljs-number"><span class="hljs-number">50022246920687</span></span> Content-Disposition: form-<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>; name=<span class="hljs-string"><span class="hljs-string">"file"</span></span>; filename=<span class="hljs-string"><span class="hljs-string">"Lenna.png"</span></span> Content-Type: image/png</code> </pre> <br><p>  In response, we get the line URL of our uploaded file, we can go over it and see this: </p><br><pre> <code class="hljs objectivec"><span class="hljs-string"><span class="hljs-string">"https://captionbot.blob.core.windows.net/images-container/2ogw3q4m.png"</span></span></code> </pre> <br><p>  Then the already familiar request to <code>/api/message</code> sent: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"conversationId"</span></span>: <span class="hljs-string"><span class="hljs-string">"54cER5HILuE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"waterMark"</span></span>: <span class="hljs-string"><span class="hljs-string">"131071012038902294"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"userMessage"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://captionbot.blob.core.windows.net/images-container/2ogw3q4m.png"</span></span> }</code> </pre> <br><p>  <code>waterMark</code> from the previous answer came in handy, and the URL is the one that the <code>upload</code> method returned to us.  Response data are similar to the previous ones. </p><br><h2>  We write a wrapper </h2><br><p>  To use this knowledge with convenience, we make a simple wrapper in your favorite programming language.  I'll do it in Python.  For requests to the site I use requests, as it is convenient and it has sessions that store cookies for me.  The site uses SSL, but by default requests will swear on the certificate: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">hostname</span></span> <span class="hljs-string"><span class="hljs-string">'www.captionbot.ai'</span></span> doesn<span class="hljs-string"><span class="hljs-string">'t match either of '</span></span><span class="hljs-regexp"><span class="hljs-regexp">*.azurewebsites.net</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-regexp"><span class="hljs-regexp">*.scm.azurewebsites.net</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-regexp"><span class="hljs-regexp">*.azure-mobile.net</span></span><span class="hljs-string"><span class="hljs-string">', '</span></span><span class="hljs-regexp"><span class="hljs-regexp">*.scm.azure-mobile.net</span></span><span class="hljs-string"><span class="hljs-string">'</span></span></code> </pre> <br><p>  This is solved by setting the verify = False flag on each request. </p><br><div class="spoiler">  <b class="spoiler_title">Full source</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mimetypes <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging logger = logging.getLogger(<span class="hljs-string"><span class="hljs-string">"captionbot"</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CaptionBot</span></span></span><span class="hljs-class">:</span></span> BASE_URL = <span class="hljs-string"><span class="hljs-string">"https://www.captionbot.ai/api/"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.session = requests.Session() url = self.BASE_URL + <span class="hljs-string"><span class="hljs-string">"init"</span></span> resp = self.session.get(url, verify=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) logger.debug(<span class="hljs-string"><span class="hljs-string">"init: {}"</span></span>.format(resp)) self.conversation_id = json.loads(resp.text) self.watermark = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_upload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, filename)</span></span></span><span class="hljs-function">:</span></span> url = self.BASE_URL + <span class="hljs-string"><span class="hljs-string">"upload"</span></span> mime = mimetypes.guess_type(filename)[<span class="hljs-number"><span class="hljs-number">0</span></span>] name = os.path.basename(filename) files = {<span class="hljs-string"><span class="hljs-string">'file'</span></span>: (name, open(filename, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>), mime)} resp = self.session.post(url, files=files, verify=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) logger.debug(<span class="hljs-string"><span class="hljs-string">"upload: {}"</span></span>.format(resp)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json.loads(resp.text) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">url_caption</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, image_url)</span></span></span><span class="hljs-function">:</span></span> data = json.dumps({ <span class="hljs-string"><span class="hljs-string">"userMessage"</span></span>: image_url, <span class="hljs-string"><span class="hljs-string">"conversationId"</span></span>: self.conversation_id, <span class="hljs-string"><span class="hljs-string">"waterMark"</span></span>: self.watermark }) headers = { <span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json"</span></span> } url = self.BASE_URL + <span class="hljs-string"><span class="hljs-string">"message"</span></span> resp = self.session.post(url, data=data, headers=headers, verify=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) logger.debug(<span class="hljs-string"><span class="hljs-string">"url_caption: {}"</span></span>.format(resp)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> resp.ok: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> res = json.loads(json.loads(resp.text)) self.watermark = res.get(<span class="hljs-string"><span class="hljs-string">"WaterMark"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.get(<span class="hljs-string"><span class="hljs-string">"UserMessage"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file_caption</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, filename)</span></span></span><span class="hljs-function">:</span></span> upload_filename = self._upload(filename) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.url_caption(upload_filename)</code> </pre> </div></div><br><p>  The source code is on <a href="https://github.com/lucky-user/captionbot">Github</a> , plus the finished package in <a href="https://pypi.python.org/pypi/captionbot">pip</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/283112/">https://habr.com/ru/post/283112/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283100/index.html">The future is here: Will robots push out financial analysts from Wall Street</a></li>
<li><a href="../283102/index.html">Creating a continuous deployment system: the Instagram experience</a></li>
<li><a href="../283104/index.html">Various experiments with the reception and transmission of radio signals in the FPGA</a></li>
<li><a href="../283106/index.html">Swift and compile time</a></li>
<li><a href="../283108/index.html">Playing with keywords in javascript</a></li>
<li><a href="../283116/index.html">DNS disorder Vkontakte and other companies</a></li>
<li><a href="../283118/index.html">Victor Gamov on In-Memory Data Grids and Hazelcast on jug.msk.ru</a></li>
<li><a href="../283122/index.html">Slit survey: implementation on bash (ffmpeg + imagemagick)</a></li>
<li><a href="../283128/index.html">RxSwift: working with GUI</a></li>
<li><a href="../283130/index.html">Goals against restrictions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>