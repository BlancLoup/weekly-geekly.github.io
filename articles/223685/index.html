<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Building SOAP message-based web services using WCF</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="WCF I really like as a framework that simplifies the creation of a communication layer. But WCF's design style does not suit me. I think that creating...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Building SOAP message-based web services using WCF</h1><div class="post__text post__text-html js-mediator-article">  WCF I really like as a framework that simplifies the creation of a communication layer.  But WCF's design style does not suit me.  I think that creating a new method for each DTO is not a good solution, so I tried to solve this problem. <br><br>  WCF has some limitations: <br><ul><li>  Does not support method overloading. </li><li>  Does not have a universal API. </li><li>  Service Contract depends on business requirements. </li><li>  Versioning should be performed at the level of DataContract and methods, the name of the operation should be universal. </li><li>  Other non-.NET clients must create as many clients as there are services. </li></ul><br>  I think the RPC (Remote Procedure Call) approach is not the most appropriate.  The service should be reusable, and the impact of business requirements on it should be minimal.  I think the remote API should meet the following requirements: <br><ul><li>  Have a stable and universal interface. </li><li>  Transmit data according to the <a href="http://martinfowler.com/eaaCatalog/dataTransferObject.html">DTO</a> pattern. </li></ul><br>  A message-based web service overcomes most of the limitations of WCF by adding a message abstraction. <br>  After reading this article, you will learn how to build reusable SOAP web services based on messages (and stop constantly generating new ones). <br><a name="habracut"></a><br><h2>  Web service design </h2><br>  Let's take a look at the RPC style approach, as well as the Message based approach. <br><br><h4>  RPC Design </h4><br>  The main idea of ‚Äã‚Äãthe RPC style is to give clients the opportunity to work with remote services as local objects.  In WCF, ServiceContract defines the operations available on the client.  For example: <br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ServiceContract</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IRpcService</span></span> { [OperationContract] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterClient</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Client client</span></span></span><span class="hljs-function">)</span></span>; [OperationContract] <span class="hljs-function"><span class="hljs-function">Client </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetClientByName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> clientName</span></span></span><span class="hljs-function">)</span></span>; [OperationContract] <span class="hljs-function"><span class="hljs-function">List&lt;Client&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAllClients</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre> <br>  The service contract is very simple and contains three operations.  We must change the client after any change in the service contract (for example, adding or deleting an operation, changing the signature of an operation).  A real application can have more than 10 operations, so the maintenance of the service and customers is very time consuming. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Message Based Design </h4><br>  The message-based approach is based on the <a href="http://martinfowler.com/eaaCatalog/dataTransferObject.html">Data Transfer Object</a> and <a href="http://martinfowler.com/eaaCatalog/gateway.html">Gateway</a> patterns.  DTO contains all the data you need to communicate, and Gateway isolates the application from the communication process.  So a message-based service receives a request message and returns a reply message.  Consider an example from the Amazon API. <br><br>  Request example: <br><pre> <code class="xml hljs">https://ec2.amazonaws.com/?Action=AllocateAddress Domain=vpc &amp;AUTHPARAMS</code> </pre><br>  Sample answer: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllocateAddressResponse</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://ec2.amazonaws.com/doc/2013-02-01/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requestId</span></span></span><span class="hljs-tag">&gt;</span></span>59dbff89-35bd-4eac-99ed-be587EXAMPLE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requestId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">publicIp</span></span></span><span class="hljs-tag">&gt;</span></span>198.51.100.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">publicIp</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">domain</span></span></span><span class="hljs-tag">&gt;</span></span>vpc<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">domain</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">allocationId</span></span></span><span class="hljs-tag">&gt;</span></span>eipalloc-5723d13e<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">allocationId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">AllocateAddressResponse</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Thus, the service contract should look something like this: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IMessageBasedService</span></span> { <span class="hljs-function"><span class="hljs-function">Response </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Request request</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre>  where <code>Request</code> and <code>Response</code> can be any DTO, that is, with one method we can replace any RPC service contract, but WCF uses the RPC style. <br><br><h2>  Message Based Style </h2><br>  As you already know, for a message-based web service, we can use <code>Request</code> and <code>Response</code> objects to pass any DTO.  But WCF does not support this design.  All communication internals in WCF are based on the use of the Message class.  That is, WCF converts any DTO into a <code>Message</code> instance and sends <code>Message</code> from the client to the server.  Therefore, we must use the <code>Message</code> class for <code>Request</code> and <code>Response</code> objects. <br>  The following service contract describes communication with and without the <code>Response</code> object. <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ServiceContract</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISoapService</span></span> { [OperationContract(Action = ServiceMetadata.Action.ProcessOneWay)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessOneWay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message message</span></span></span><span class="hljs-function">)</span></span>; [OperationContract(Action = ServiceMetadata.Action.Process, ReplyAction = ServiceMetadata.Action.ProcessResponse)] <span class="hljs-function"><span class="hljs-function">Message </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Process</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message message</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre>  <code>ISoapService</code> allows us to transfer any data, but this is not enough.  We want to create, delete objects and execute methods on it.  As for me, the best choice is CRUD operations at the facility, so we can implement any operation.  First of all, let's create a <code>SoapServiceClient</code> that can send and receive any DTO. <br><br><h4>  Soap service client </h4><br>  <code>SoapServiceClient</code> will show how to create a <code>Message</code> from any DTO.  <code>SoapServiceClient</code> is a wrapper that converts any DTO to a <code>Message</code> and sends it to the service.  The message to be sent contains the following data: <br><ul><li>  DTO </li><li>  DTO type required for server side deserialization </li><li>  The method to be invoked on the server side. </li></ul>  Our goal is to create a reusable client for a SOAP web service that can send / receive any request / response and perform any operations on an object.  As mentioned earlier, CRUD is best suited for this, so the client might look something like this: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SoapServiceClient(<span class="hljs-string"><span class="hljs-string">"NeliburSoapService"</span></span>); ClientResponse response = client.Post&lt;ClientResponse&gt;(createRequest); response = client.Put&lt;ClientResponse&gt;(updateRequest);</code> </pre><br>  Below is the entire code of the <code>Post</code> method of the <code>SoapServiceClient</code> class. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TResponse Post&lt;TResponse&gt;(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> request) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Send&lt;TResponse&gt;(request, OperationTypeHeader.Post); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TResponse Send&lt;TResponse&gt;(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> request, MessageHeader operationType) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> factory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ChannelFactory&lt;ISoapService&gt;(_endpointConfigurationName)) { MessageVersion messageVersion = factory.Endpoint.Binding.MessageVersion; Message message = CreateMessage(request, operationType, messageVersion); ISoapService channel = factory.CreateChannel(); Message result = channel.Process(message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result.GetBody&lt;TResponse&gt;(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Message </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> request, MessageHeader actionHeader, MessageVersion messageVersion</span></span></span><span class="hljs-function">)</span></span> { Message message = Message.CreateMessage( messageVersion, ServiceMetadata.Operations.Process, request); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> contentTypeHeader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContentTypeHeader(request.GetType()); message.Headers.Add(contentTypeHeader); message.Headers.Add(actionHeader); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message; }</code> </pre>  Please pay attention to the <code>CreateMessage</code> method and how the DTO type and the method being called are added via the <code>contentTypeHeader</code> and <code>actionHeader</code> . <br>  <code>SoapContentTypeHeader</code> and <code>SoapOperationTypeHeader</code> almost identical.  The <code>SoapContentTypeHeader</code> used to transmit the type of DTO, and <code>SoapOperationTypeHeader</code> is used to pass the target operation.  Less words, more code: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SoapContentTypeHeader</span></span> : <span class="hljs-title"><span class="hljs-title">MessageHeader</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> NameValue = <span class="hljs-string"><span class="hljs-string">"nelibur-content-type"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> NamespaceValue = <span class="hljs-string"><span class="hljs-string">"http://nelibur.org/"</span></span> + NameValue; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _contentType; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SoapContentTypeHeader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type contentType</span></span></span><span class="hljs-function">)</span></span> { _contentType = contentType.Name; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NameValue; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Namespace { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NamespaceValue; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadHeader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message request</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> headerPosition = request.Headers.FindHeader(NameValue, NamespaceValue); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (headerPosition == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> content = request.Headers.GetHeader&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(headerPosition); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> content; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnWriteHeaderContents</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlDictionaryWriter writer, MessageVersion messageVersion</span></span></span><span class="hljs-function">)</span></span> { writer.WriteString(_contentType); } }</code> </pre><br>  The following are <code>SoapServiceClient</code> methods: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> TResponse Get&lt;TResponse&gt;(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> request) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Task&lt;TResponse&gt; GetAsync&lt;TResponse&gt;(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> request) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> request</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PostAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> request</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> TResponse Post&lt;TResponse&gt;(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> request</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Task&lt;TResponse&gt; PostAsync&lt;TResponse&gt;(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> request</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Put</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> request</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PutAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> request</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> TResponse Put&lt;TResponse&gt;(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> request</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Task&lt;TResponse&gt; PutAsync&lt;TResponse&gt;(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> request</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Delete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> request</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> request</span></span></span><span class="hljs-function">)</span></span></code> </pre><br>  As you have already noticed, all CRUD operations have asynchronous versions. <br><br><h4>  SOAP service </h4><br>  SOAP service should be able to: <br><ul><li>  Create a specific Request from Message </li><li>  Call the target method on Request </li><li>  If necessary, create and return Message from Response </li></ul><br><br>  Our goal is to create something that will call a suitable CRUD method for a specific <code>Request</code> .  The example below shows how to add and get a <code>Client</code> object (client). <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ClientProcessor</span></span> : <span class="hljs-title"><span class="hljs-title">IPut</span></span>&lt;<span class="hljs-title"><span class="hljs-title">CreateClientRequest</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IGet</span></span>&lt;<span class="hljs-title"><span class="hljs-title">GetClientRequest</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> List&lt;Client&gt; _clients = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Client&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GetClientRequest request</span></span></span><span class="hljs-function">)</span></span> { Client client = _clients.Single(x =&gt; x.Id == request.Id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClientResponse {Id = client.Id, Name = client.Name}; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Put</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CreateClientRequest request</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Client { Id = Guid.NewGuid(), Name = request.Name }; _clients.Add(client); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClientResponse {Id = client.Id}; } }</code> </pre><br><br>  The most interesting are the interfaces <code>IGet</code> and <code>IPost</code> .  They represent CRUD operations.  Take a look at the class diagram: <br><img src="https://habrastorage.org/getpro/habr/post_images/cac/d3f/5cd/cacd3f5cd354a8f339748f6795d1703e.jpg" alt="class diagram"><br>  Now you need to associate the <code>Request</code> with the appropriate CRUD operation.  The easiest way is to associate a <code>Request</code> with a request <code>Processor</code> .  For this functionality distinguishes <code>NeliburService</code> .  Let's take a look at it. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NeliburService</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> RequestMetadataMap _requests = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RequestMetadataMap(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Configuration _configuration = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Configuration(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> RequestProcessorMap _requestProcessors = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RequestProcessorMap(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessOneWay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestMetadata requestMetaData</span></span></span><span class="hljs-function">)</span></span> { IRequestProcessor processor = _requestProcessors.Get(requestMetaData.Type); processor.ProcessOneWay(requestMetaData); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Message </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Process</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestMetadata requestMetaData</span></span></span><span class="hljs-function">)</span></span> { IRequestProcessor processor = _requestProcessors.Get(requestMetaData.Type); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> processor.Process(requestMetaData); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Configuration</span></span> : <span class="hljs-title"><span class="hljs-title">IConfiguration</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Bind&lt;TRequest, TProcessor&gt;(Func&lt;TProcessor&gt; creator) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TRequest : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TProcessor</span></span> : <span class="hljs-title"><span class="hljs-title">IRequestOperation</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (creator == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> Error.ArgumentNull(<span class="hljs-string"><span class="hljs-string">"creator"</span></span>); } _requestProcessors.Add&lt;TRequest, TProcessor&gt;(creator); _requests.Add&lt;TRequest&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Bind&lt;TRequest, TProcessor&gt;() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TRequest : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TProcessor</span></span> : <span class="hljs-title"><span class="hljs-title">IRequestOperation</span></span>, <span class="hljs-title"><span class="hljs-title">new</span></span>() { Bind&lt;TRequest, TProcessor&gt;(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TProcessor()); } } }</code> </pre><br>  <code>RequestMetadataMap</code> used to store the type of <code>Request</code> object that is required to create a specific <code>Request</code> from a <code>Message</code> . <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RequestMetadataMap</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Type&gt; _requestTypes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Type&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Add&lt;TRequest&gt;() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TRequest : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { Type requestType = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(TRequest); _requestTypes[requestType.Name] = requestType; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> RequestMetadata </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FromRestMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message message</span></span></span><span class="hljs-function">)</span></span> { UriTemplateMatch templateMatch = WebOperationContext.Current.IncomingRequest.UriTemplateMatch; NameValueCollection queryParams = templateMatch.QueryParameters; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> typeName = UrlSerializer.FromQueryParams(queryParams).GetTypeValue(); Type targetType = GetRequestType(typeName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RequestMetadata.FromRestMessage(message, targetType); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> RequestMetadata </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FromSoapMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message message</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> typeName = SoapContentTypeHeader.ReadHeader(message); Type targetType = GetRequestType(typeName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RequestMetadata.FromSoapMessage(message, targetType); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Type </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRequestType</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> typeName</span></span></span><span class="hljs-function">)</span></span> { Type result; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_requestTypes.TryGetValue(typeName, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> result)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> errorMessage = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format( <span class="hljs-string"><span class="hljs-string">"Binding on {0} is absent. Use the Bind method on an appropriate NeliburService"</span></span>, typeName); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> Error.InvalidOperation(errorMessage); } }</code> </pre><br>  <code>RequestProcessorMap</code> c associates the type of the <code>Request</code> object with the handler. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RequestProcessorMap</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;Type, IRequestProcessor&gt; _repository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Type, IRequestProcessor&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Add&lt;TRequest, TProcessor&gt;(Func&lt;TProcessor&gt; creator) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TRequest : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TProcessor</span></span> : <span class="hljs-title"><span class="hljs-title">IRequestOperation</span></span> { Type requestType = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(TRequest); IRequestProcessor context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RequestProcessor&lt;TRequest, TProcessor&gt;(creator); _repository[requestType] = context; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IRequestProcessor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type requestType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _repository[requestType]; } }</code> </pre><br>  Now we are ready for the last step: calling the target method.  Here is our SOAP service: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ServiceBehavior(InstanceContextMode = InstanceContextMode.PerCall)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SoapService</span></span> : <span class="hljs-title"><span class="hljs-title">ISoapService</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Message </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Process</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message message</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NeliburSoapService.Process(message); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessOneWay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message message</span></span></span><span class="hljs-function">)</span></span> { NeliburSoapService.ProcessOneWay(message); } }</code> </pre><br>  First of all, let's look at the sequence diagram describing the execution process on the service side. <br><img src="https://habrastorage.org/getpro/habr/post_images/cd6/55e/020/cd655e020c48aaa6d8f986f1c3a20d2c.jpg" alt="sequence diagram"><br>  Let's dive into the code step by step.  <code>NeliburSoapService</code> just executes another code, take a look at it. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NeliburSoapService</span></span> : <span class="hljs-title"><span class="hljs-title">NeliburService</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NeliburSoapService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IConfiguration </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action&lt;IConfiguration&gt; action</span></span></span><span class="hljs-function">)</span></span> { action(_configuration); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _configuration; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Message </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Process</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message message</span></span></span><span class="hljs-function">)</span></span> { RequestMetadata metadata = _requests.FromSoapMessage(message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Process(metadata); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessOneWay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message message</span></span></span><span class="hljs-function">)</span></span> { RequestMetadata metadata = _requests.FromSoapMessage(message); ProcessOneWay(metadata); } }</code> </pre><br>  <code>NeliburSoapService</code> simply decorates the <code>RequestMetadataMap</code> , that is, it calls the appropriate method to create the <code>RequestMetadata</code> for the SOAP <code>Message</code> . <br>  The most interesting thing happens here: <br><ul><li><pre> <code class="cs hljs">RequestMetadata requestMetaData = _requests.FromSoapMessage(message)</code> </pre></li><li><pre> <code class="cs hljs">context.Process(requestMetaData).</code> </pre></li></ul><br>  SoapRequestMetadata is the main object that combines the type of CRUD operation, the request data (Request), its type, and can also respond to the request. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SoapRequestMetadata</span></span> : <span class="hljs-title"><span class="hljs-title">RequestMetadata</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> MessageVersion _messageVersion; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> _request; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SoapRequestMetadata</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message message, Type targetType</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">targetType</span></span></span><span class="hljs-function">)</span></span> { _messageVersion = message.Version; _request = CreateRequest(message, targetType); OperationType = SoapOperationTypeHeader.ReadHeader(message); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> OperationType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Message </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateResponse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> response</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Message.CreateMessage(_messageVersion, SoapServiceMetadata.Action.ProcessResponse, response); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> TRequest GetRequest&lt;TRequest&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (TRequest)_request; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Message message, Type targetType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (XmlDictionaryReader reader = message.GetReaderAtBodyContents()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serializer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataContractSerializer(targetType); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> serializer.ReadObject(reader); } } }</code> </pre><br>  And at the end, we simply call the appropriate CRUD operation via <code>RequestProcessor</code> .  <code>RequestProcessor</code> uses <code>RequestMetadata</code> to define an operation and calls it when it returns the result to the <code>SoapServiceClient</code> class. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RequestProcessor</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TRequest</span></span>, <span class="hljs-title"><span class="hljs-title">TProcessor</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IRequestProcessor</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TRequest</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TProcessor</span></span> : <span class="hljs-title"><span class="hljs-title">IRequestOperation</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Func&lt;TProcessor&gt; _creator; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RequestProcessor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Func&lt;TProcessor&gt; creator</span></span></span><span class="hljs-function">)</span></span> { _creator = creator; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Message </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Process</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestMetadata metadata</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (metadata.OperationType) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OperationType.Get: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Get(metadata); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OperationType.Post: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Post(metadata); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OperationType.Put: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Put(metadata); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OperationType.Delete: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Delete(metadata); <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> message = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Invalid operation type: {0}"</span></span>, metadata.OperationType); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> Error.InvalidOperation(message); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessOneWay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestMetadata metadata</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (metadata.OperationType) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OperationType.Get: GetOneWay(metadata); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OperationType.Post: PostOneWay(metadata); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OperationType.Put: PutOneWay(metadata); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> OperationType.Delete: DeleteOneWay(metadata); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> message = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Invalid operation type: {0}"</span></span>, metadata.OperationType); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> Error.InvalidOperation(message); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Message </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Delete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestMetadata metadata</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service = (IDelete&lt;TRequest&gt;)_creator(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = metadata.GetRequest&lt;TRequest&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> result = service.Delete(request); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> metadata.CreateResponse(result); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteOneWay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestMetadata metadata</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service = (IDeleteOneWay&lt;TRequest&gt;)_creator(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = metadata.GetRequest&lt;TRequest&gt;(); service.DeleteOneWay(request); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Message </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestMetadata metadata</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service = (IGet&lt;TRequest&gt;)_creator(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = metadata.GetRequest&lt;TRequest&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> result = service.Get(request); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> metadata.CreateResponse(result); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOneWay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestMetadata metadata</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service = (IGetOneWay&lt;TRequest&gt;)_creator(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = metadata.GetRequest&lt;TRequest&gt;(); service.GetOneWay(request); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Message </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestMetadata metadata</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service = (IPost&lt;TRequest&gt;)_creator(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = metadata.GetRequest&lt;TRequest&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> result = service.Post(request); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> metadata.CreateResponse(result); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PostOneWay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestMetadata metadata</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service = (IPostOneWay&lt;TRequest&gt;)_creator(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = metadata.GetRequest&lt;TRequest&gt;(); service.PostOneWay(request); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Message </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Put</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestMetadata metadata</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service = (IPut&lt;TRequest&gt;)_creator(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = metadata.GetRequest&lt;TRequest&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> result = service.Put(request); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> metadata.CreateResponse(result); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PutOneWay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RequestMetadata metadata</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service = (IPutOneWay&lt;TRequest&gt;)_creator(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = metadata.GetRequest&lt;TRequest&gt;(); service.PutOneWay(request); } }</code> </pre> <br><h2>  Demo </h2><br>  First of all, let's declare data contracts: <br><ul><li>  <code>CreateClientRequest</code> - request to create a new client </li><li>  <code>UpdateClientRequest</code> - update email client request </li><li>  <code>GetClientRequest</code> - request for a client by id </li><li>  <code>ClientResponse</code> - information about the client </li><li>  <code>RemoveClientRequest</code> - client removal request </li></ul><br><br><h4>  Server's side </h4><br>  The configuration file is the most common: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--WCF--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.serviceModel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">services</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Nelibur.ServiceModel.Services.Default.SoapServicePerCall"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">endpoint</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://localhost:5060/service"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">binding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"basicHttpBinding"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bindingConfiguration</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ServiceBinding"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">contract</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Nelibur.ServiceModel.Contracts.ISoapService"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">services</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bindings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">basicHttpBinding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">binding</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ServiceBinding"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"None"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transport</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">clientCredentialType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"None"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">security</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">binding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">basicHttpBinding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bindings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.serviceModel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">startup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">supportedRuntime</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"v4.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sku</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".NETFramework,Version=v4.5"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">startup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  WCF service is extremely simple: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ServiceBehavior(InstanceContextMode = InstanceContextMode.PerCall)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SoapServicePerCall</span></span> : <span class="hljs-title"><span class="hljs-title">ISoapService</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Process message with response. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="message"&gt;</span></span></span><span class="hljs-comment">Request message.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment">Response message.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> public Message Process(Message message) { return NeliburSoapService.Process(message); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Process message without response. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="message"&gt;</span></span></span><span class="hljs-comment">Request message.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> public void ProcessOneWay(Message message) { NeliburSoapService.ProcessOneWay(message); } }</span></span></code> </pre><br>  Bind all requests to handlers.  For simplicity, I created only one request handler.  You can make as many requests as you like.  I advise you to read the <a href="http://martinfowler.com/bliki/CQRS.html">article by Martin Fowler on CQRS</a> .  This will help you make the right choice.  Communication code of requests and handlers: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BindRequestToProcessors</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { NeliburSoapService.Configure(x =&gt; { x.Bind&lt;CreateClientRequest, ClientProcessor&gt;(); x.Bind&lt;UpdateClientRequest, ClientProcessor&gt;(); x.Bind&lt;DeleteClientRequest, ClientProcessor&gt;(); x.Bind&lt;GetClientRequest, ClientProcessor&gt;(); }); }</code> </pre><br>  And finally, <code>ClientProcessor</code> : <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ClientProcessor</span></span> : <span class="hljs-title"><span class="hljs-title">IPost</span></span>&lt;<span class="hljs-title"><span class="hljs-title">CreateClientRequest</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IGet</span></span>&lt;<span class="hljs-title"><span class="hljs-title">GetClientRequest</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IDeleteOneWay</span></span>&lt;<span class="hljs-title"><span class="hljs-title">DeleteClientRequest</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IPut</span></span>&lt;<span class="hljs-title"><span class="hljs-title">UpdateClientRequest</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> List&lt;Client&gt; _clients = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Client&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteOneWay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DeleteClientRequest request</span></span></span><span class="hljs-function">)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Delete Request: {0}\n"</span></span>, request); _clients = _clients.Where(x =&gt; x.Id != request.Id).ToList(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GetClientRequest request</span></span></span><span class="hljs-function">)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Get Request: {0}"</span></span>, request); Client client = _clients.Single(x =&gt; x.Id == request.Id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClientResponse { Id = client.Id, Email = client.Email }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CreateClientRequest request</span></span></span><span class="hljs-function">)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Post Request: {0}"</span></span>, request); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Client { Id = Guid.NewGuid(), Email = request.Email }; _clients.Add(client); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClientResponse { Id = client.Id, Email = client.Email }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Put</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">UpdateClientRequest request</span></span></span><span class="hljs-function">)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Put Request: {0}"</span></span>, request); Client client = _clients.Single(x =&gt; x.Id == request.Id); client.Email = request.Email; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClientResponse { Id = client.Id, Email = client.Email }; } }</code> </pre><br><br><h4>  Client's side </h4><br>  Client code is simple: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SoapServiceClient(<span class="hljs-string"><span class="hljs-string">"NeliburSoapService"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> createRequest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreateClientRequest { Email = <span class="hljs-string"><span class="hljs-string">"email@email.com"</span></span> }; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"POST Request: {0}"</span></span>, createRequest); ClientResponse response = client.Post&lt;ClientResponse&gt;(createRequest); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"POST Response: {0}\n"</span></span>, response); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updateRequest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UpdateClientRequest { Email = <span class="hljs-string"><span class="hljs-string">"new@email.com"</span></span>, Id = response.Id }; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"PUT Request: {0}"</span></span>, updateRequest); response = client.Put&lt;ClientResponse&gt;(updateRequest); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"PUT Response: {0}\n"</span></span>, response); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getClientRequest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GetClientRequest { Id = response.Id }; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"GET Request: {0}"</span></span>, getClientRequest); response = client.Get&lt;ClientResponse&gt;(getClientRequest); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"GET Response: {0}\n"</span></span>, response); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deleteRequest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DeleteClientRequest { Id = response.Id }; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"DELETE Request: {0}"</span></span>, deleteRequest); client.Delete(deleteRequest); Console.ReadKey(); }</code> </pre><br><br>  Results of performance: <br>  customer: <br><img src="https://habrastorage.org/getpro/habr/post_images/df8/366/66e/df836666e51ecd28c6e70f8c700950f6.jpg" alt="customer"><br><br>  service: <br><img src="https://habrastorage.org/getpro/habr/post_images/2c2/47b/26b/2c247b26b3d69de4e5c60965ada79fee.jpg" alt="service"><br><br><h2>  That's all </h2><br>  I hope you enjoyed it.  Here you can learn <a href="http://habrahabr.ru/post/218149/">how to build RESTful web services on WCF and Nelibur</a> .  Thank you for reading the article (translation).  Sources can be downloaded from the <a href="http://www.codeproject.com/Articles/598157/Building-SOAP-Message-Based-Web-Services-with-WCF">original page</a> or from <a href="https://github.com/Nelibur/Nelibur">GitHub</a> . </div><p>Source: <a href="https://habr.com/ru/post/223685/">https://habr.com/ru/post/223685/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../223673/index.html">Self-organizing robots to create pieces of furniture</a></li>
<li><a href="../223675/index.html">We test iOS applications without Apple Developer Program Membership</a></li>
<li><a href="../223677/index.html">Sony Xperia Z2 Review</a></li>
<li><a href="../223681/index.html">Show Sound # 10 - Podcast about audio equipment, components, formats and technologies</a></li>
<li><a href="../223683/index.html">Mobile analytics. Now free!</a></li>
<li><a href="../223687/index.html">Production of 3D printers in Europe. What the blonde birches are silent about ...</a></li>
<li><a href="../223699/index.html">PAC-MAN Birthday</a></li>
<li><a href="../223701/index.html">Soviet cultural and scientific heritage is freed from the shackles of copyright. Expanding the ‚Äúpublic domain‚Äù regime</a></li>
<li><a href="../223705/index.html">Quick interface: why should the service fly?</a></li>
<li><a href="../223707/index.html">Snowden supported Tor's largest output node at 2 Gbps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>