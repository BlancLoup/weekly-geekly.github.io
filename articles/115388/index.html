<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse engineering: tvali.ge service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Background (can be skipped) 
 Situation: there is a large local area network with inaccessible "external" and a free more or less productive machine w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse engineering: tvali.ge service</h1><div class="post__text post__text-html js-mediator-article"><h4>  Background (can be skipped) </h4><br>  Situation: there is a large local area network with inaccessible "external" and a free more or less productive machine with unlimited external Internet. <br>  And there is a common desire among students: to watch football on the Internet, due to the inaccessibility of the TV in the hostels. <br>  After much trial and error with the retransmission of TV from the "external" (communication breaks in the evening, any lag of the video source - breaks and "cubes" from everyone inside the local network) were searching for alternative sources of the channel with sports.  Satellite dish can not be put.  And in the end the site was found - <a href="http://tvali.ge/">tvali.ge</a> , which works according to the scheme: <br>  Captured video from the channel (5 minutes) -&gt; saved -&gt; gave it to the user in a flash player.  All delayed from the original stream in 10 minutes <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d4d/901/970/d4d9019702d691b3c668510fe22d84ec.jpg" alt="Demonstration of the player"></div><br><br>  Under the cat a detailed scheme of the service and the decision how to drag the channel to yourself. <br><a name="habracut"></a><br><h5>  TV viewing scheme </h5><br>  I went to the site (I got a cookie) -&gt; opened the page with the desired channel -&gt; you watch the channel record. <br>  But!  Cookie.  If you do not have a session from the site, then the player will not load your playlist and display on the screen: <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6cf/5ac/fdd/6cf5acfdd69deff64273e4f759b6810d.jpg" alt="We are trying to look without a session. Access Denied"></div><br>  Well, look further. <br>  The service provides an "insert" on any player site with this channel.  Let us examine the "NTV + Sport", namely part of the call player.  I will comment on the interesting lines for us from the insert, which gives the service: <br><br><pre><code class="hljs pgsql">var cc=<span class="hljs-number"><span class="hljs-number">955</span></span>; // ID    var d = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-type"><span class="hljs-type">Date</span></span>(); var cd = d.getDay()*(<span class="hljs-number"><span class="hljs-number">24</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>)+d.getHours()*<span class="hljs-number"><span class="hljs-number">60</span></span>+Math.floor(d.getMinutes()/<span class="hljs-number"><span class="hljs-number">5</span></span>)*<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-number"><span class="hljs-number">-10</span></span>; //  ""  (    ). var fn = "http://tvali.ge/tv/"+cc+"_list.php?d="+cd; //      .</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Parsing a ban on access to a channel without a cookie </h5><br>  Follow the link with the playlist.  This is where the cookie is checked. <br>  If we have a ‚Äúticket‚Äù (expressed in the words of the service developer) from a site visit, then the playlist is correctly generated and gives us links to the files with the channel record.  Example of a link to one of the entries: <br><br>  <i><a href="http://tvali.ge/c.php%3Faction%3D010102%26vid%3D010102-06-12-00-00.mp4">tvali.ge/c.php?action=010102&amp;vid=010102-06-12-12.mp4</a></i> <br><br>  The playlist is generated depending on what we passed to it in the "? D =" parameter.  And there - the time in seconds since the beginning of the week (rounded to the minute (5)) and minus 10 minutes (broadcast delay). <br>  Without a cookie, we will get a link to one record, the screenshot of which provided above. <br>  <i><a href="">www.tvali.ge/noaccess.flv</a></i> <br>  As it turned out, cookies are checked and when accessing the file.  So without them, we can‚Äôt ‚Äúpull‚Äù the file to us. <br><br><h5>  We start to implement a copy of the service </h5><h6>  Download files to yourself </h6><br>  Let's sort the file name - 06-12-35-00 <br>  06 - day of the week <br>  12 - hours <br>  35 minutes <br>  00 - seconds <br>  Fine!  We are going to write a script that will download files to us. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> set_time_limit(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">curl_get_file_contents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($URL)</span></span></span><span class="hljs-function"> </span></span>{ $c = curl_init(); curl_setopt($c, CURLOPT_RETURNTRANSFER, <span class="hljs-number"><span class="hljs-number">1</span></span>); curl_setopt($c, CURLOPT_FOLLOWLOCATION, <span class="hljs-number"><span class="hljs-number">1</span></span> ); curl_setopt($c, CURLOPT_COOKIE, <span class="hljs-string"><span class="hljs-string">'CO=cookie_from_service'</span></span>); curl_setopt($c, CURLOPT_URL, $URL); $contents = curl_exec($c); curl_close($c); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($contents) { $out_handle = fopen (<span class="hljs-string"><span class="hljs-string">'/var/www/domain/videos/'</span></span>.substr($URL, <span class="hljs-number"><span class="hljs-number">-12</span></span>), <span class="hljs-string"><span class="hljs-string">"wb+"</span></span>); fwrite ($out_handle, $contents); } } <span class="hljs-comment"><span class="hljs-comment">// .      2 . 15  -   $mod_time = time() - 2*60*60 - 15*60; $min = floor(date("i", $mod_time)/5)*5; if ($min &lt; 10) $min = '0'.$min; $hours = date("H", $mod_time); $vid = "010102-0".date("w", $mod_time)."-".$hours."-".$min."-00.mp4"; curl_get_file_contents('http://tvali.ge/c.php?action=010102&amp;vid='.$vid); echo 'http://tvali.ge/c.php?action=010102&amp;vid='.$vid; </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br><br>  And so, we have a script, the execution of which we add to cron (every 5 minutes) <br> <code>*/5 * * * * /usr/bin/php /var/www/downloader.php</code> <br> <br><h6>  Player </h6><br>  The scheme of the player that on the service itself: <br>  received a playlist -&gt; divided all the records in half and began to show from it. <br>  Writing a playlist generator: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $mod_time = time() - <span class="hljs-number"><span class="hljs-number">2</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span> - <span class="hljs-number"><span class="hljs-number">17</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span> - <span class="hljs-number"><span class="hljs-number">12</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>; $links = <span class="hljs-string"><span class="hljs-string">"&lt;playlist version = \"1\"&gt;&lt;trackList&gt;"</span></span>; $titles = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i&lt; <span class="hljs-number"><span class="hljs-number">288</span></span>; $i++) { $min = floor(date(<span class="hljs-string"><span class="hljs-string">"i"</span></span>, $mod_time)/<span class="hljs-number"><span class="hljs-number">5</span></span>)*<span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($min &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) $min = <span class="hljs-string"><span class="hljs-string">'0'</span></span>.$min; $hours = date(<span class="hljs-string"><span class="hljs-string">"H"</span></span>, $mod_time); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($hours &lt; <span class="hljs-number"><span class="hljs-number">22</span></span>) $title = $hours+<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $title = $hours<span class="hljs-number"><span class="hljs-number">-22</span></span>; $title .= <span class="hljs-string"><span class="hljs-string">":"</span></span>.$min; $links .= <span class="hljs-string"><span class="hljs-string">"&lt;track&gt;&lt;title&gt;$title&lt;/title&gt;&lt;location&gt;http://domain/videos/$hours-$min-00.mp4&lt;/location&gt;&lt;/track&gt; "</span></span>; $mod_time += <span class="hljs-number"><span class="hljs-number">300</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $links.<span class="hljs-string"><span class="hljs-string">"&lt;/trackList&gt;&lt;/playlist&gt;"</span></span>; <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br>  As you can see, the playlist generator, unlike the original, does not take into account the date parameter, it simply does not exist.  I decided that this is a better option, to determine the real time on the server, rather than the user, in order to avoid possible errors when working with the player. <br>  Actually everything, be sure to download the flash player of this resource to yourself, change the var fn = ... to the address with the playlist script and watch the sport in excellent quality in the local network. <br><br>  Maybe someone will say "it is pointless to watch the sport with a delay of 20 minutes," but this is still the only option. <br>  PS It is possible to ‚Äúpull out‚Äù other channels in the same way, but the same ‚ÄúSTS‚Äù in the evenings they break off, recordings for 1-2 minutes (and should be 5 each). </div><p>Source: <a href="https://habr.com/ru/post/115388/">https://habr.com/ru/post/115388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../115382/index.html">The Japanese still made another revolution in games</a></li>
<li><a href="../115384/index.html">Flash memory: problems for computer forensics</a></li>
<li><a href="../115385/index.html">Action Request System: Introduction</a></li>
<li><a href="../115386/index.html">Inventory management for small online stores</a></li>
<li><a href="../115387/index.html">Zen Coding v0.7</a></li>
<li><a href="../115389/index.html">Single entry point to the web application</a></li>
<li><a href="../115392/index.html">Attention, designers! Evernote starts a 100,000 T-shirt contest. The main prize is 100,000 rubles.</a></li>
<li><a href="../115393/index.html">Beyond HTML5: Database API and IndexedDB Path</a></li>
<li><a href="../115394/index.html">Application of fuzzy search algorithms in PHP</a></li>
<li><a href="../115395/index.html">Perl :: Critic + Subversion = implementation of common coding practices in the team</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>