<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Authentication and authorization in ASP.NET Web API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="You created WebAPI and now you want to control access to it? In this series of articles, we will look at several options for protecting WebAPI from un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Authentication and authorization in ASP.NET Web API</h1><div class="post__text post__text-html js-mediator-article">  You created WebAPI and now you want to control access to it?  In this series of articles, we will look at several options for protecting WebAPI from unauthorized users.  The series will cover both parties, both user authentication and authorization. <br><br><ul><li>  Authentication - allows you to uniquely identify the user.  For example, Alice logs in with her username and password, and the server uses this data to authenticate Alice. </li><li>  Authorization decides whether the user can perform certain actions.  For example, Alice may have the right to read a resource, but cannot create a new resource. </li></ul><br><br>  The first series of articles provides an overview of authentication and authorization in the ASP.NET Web API.  Other articles describe common authentication scenarios for WebAPI. <br><a name="habracut"></a><br><h4>  Authentication </h4><br>  WebAPI assumes that authentication is performed by the host where it is located.  For web hosting, the host is IIS, which uses HTTP modules for authentication.  You can configure your project to use authentication modules built into IIS or ASP.NET, or write your own HTTP module to perform custom authentication. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When a host authenticates a user, it creates an IPrincipal object, which is the security context in which the code is executed.  The created object attaches to the current thread and can be accessed through the Thread.CurrentPrincipal property.  The security context contains the associated Identity object, with information about the user.  If the user is authenticated, the Identity.IsAuthenticated property returns true.  For anonymous requests, the property returns false. <br><br><h4>  Use HTTP message handlers for authentication. </h4><br>  Instead of using a host, the authentication logic can be put into an HTTP message handler.  In this case, the message handler examines the HTTP request and sets the security context itself. <br><br>  A few examples of what might require authentication in message handlers: <br><ul><li>  HTTP module sees all requests passing through the ASP.NET channel, the handler sees only requests destined for the WebAPI </li><li>  You can install separate message handlers for each route using different authentication schemes. </li><li>  HTTP modules are specific to IIS.  Message handlers are independent of the host, and can be used both in the case of web hosting and in self-hosting. </li><li>  HTTP modules participate in IIS logging, auditing, etc. </li><li>  HTTP modules are run earlier in the request progress chain.  If you authenticate with a message handler, the security context will not be set until the handler is started.  In addition, the security context returns to the previous state when the response to the request leaves the message handler. </li></ul><br><br>  In general, if you are not going to use self-hosting, using HTTP authentication modules is the best option.  Otherwise, the logic should be put into message handlers. <br><br><h4>  Setting Security Context </h4><br>  If your application performs any authentication-related logic, you must set the security context in two properties: <br><ul><li>  Thread.CurrentPrincipal - the standard way to set the security context for a thread in .NET </li><li>  HttpContext.Current.User - property specific to ASP.NET </li></ul><br><br>  The following code shows how to set the security context: <br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetPrincipal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IPrincipal principal</span></span></span><span class="hljs-function">)</span></span> { Thread.CurrentPrincipal = principal; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (HttpContext.Current != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { HttpContext.Current.User = principal; } }</code> </pre> <br><br>  For web hosting, you must set the security context in both properties, otherwise the security context may become inconsistent.  To ensure that your code is independent of the hosting method, you should set a null check for the HttpContext.Current property, as shown in the code.  In the case of self-hosting, its value will be null and no security context is required. <br><br><h4>  Authorization </h4><br>  In the request handler chain, authorization is closer to the controller.  This allows for fine-tuning access to resources. <br><ul><li>  Authorization filters execute before controller methods.  If the request is not authorized, the filter will return an error message, and the controller method will not be called. </li><li>  In the controller method, you can get the current security context from the ApiController.User property.  For example, you can filter the list of resources depending on the user name, returning only those available for it. </li></ul><br><img src="https://habrastorage.org/files/c2f/6cc/0e6/c2f6cc0e6b24488286328bdcdcf6328e.png"><br><br><h4>  Using the attribute [Authorize] </h4><br>  WebAPI provides a built-in authorization filter, AuthorizeAttribute, this filter checks whether the user is authorized.  If not, the filter will return the HTTP 401 status code (Unauthorized), without calling the method. <br>  You can apply a filter both globally and at the controller level or at the method level. <br><br>  <b>Filter at the global level</b> : To limit access to each WebAPI controller, add the AuthorizeAttribute filter to the global filter list: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Register</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpConfiguration config</span></span></span><span class="hljs-function">)</span></span> { config.Filters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AuthorizeAttribute()); }</code> </pre><br><br>  <b>Filter at the controller level</b> : to restrict access to a specific controller, add a filter as an attribute of the controller class: <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Require authorization for all actions on the controller. [Authorize] public class ValuesController : ApiController { public HttpResponseMessage Get(int id) { ... } public HttpResponseMessage Post() { ... } }</span></span></code> </pre><br><br>  <b>Filter at the method level</b> : to restrict access to the method, add an attribute to it: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ValuesController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpResponseMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... } <span class="hljs-comment"><span class="hljs-comment">// Require authorization for a specific action. [Authorize] public HttpResponseMessage Post() { ... } }</span></span></code> </pre><br><br>  In addition, you can set a limit on the controller, and allow anonymous access to individual methods using the [AllowAnonymous] attribute.  In the following example, access to the Post method is restricted, and the Get method is available for anonymous calls: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Authorize</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ValuesController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { [AllowAnonymous] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpResponseMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpResponseMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... } }</code> </pre><br><br>  In the previous examples, the filter allowed access to any authenticated user by prohibiting access only to anonymous users.  You can also give access to specific users or roles: <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Restrict by user: [Authorize(Users="Alice,Bob")] public class ValuesController : ApiController { } // Restrict by role: [Authorize(Roles="Administrators")] public class ValuesController : ApiController { }</span></span></code> </pre><br><br><h6>  The AuthorizeAttribute filter for WebAPI controllers is in the System.Web.Http namespace.  There is a similar filter for MVC controllers in the System.Web.Mvc namespace.  This type is not compatible with WebAPI controllers. </h6><br><br><h4>  Custom filter authorization </h4><br>  A custom filter must be inherited from one of the following types: <br><ul><li>  <b>AuthorizeAttribute</b> .  Inherit this class to implement synchronous authorization logic based on the current user or user role. </li><li>  <b>AuthorizationFilterAttribute</b> .  This class is useful for implementing authorization logic that is not necessarily user-based or its role. </li><li>  <b>IAuthorizationFilter</b> .  Implement this interface for asynchronous authorization logic.  For example, your authorization assumes asynchronous or network calls (if the logic is tied to processor computing, it is better to inherit from AuthorizationFilterAttribute, so as not to write asynchronous methods) </li></ul><br><br>  The following diagram shows the hierarchy of filter classes: <br><img src="https://habrastorage.org/files/b96/733/0ed/b967330edbee4c6abd8003f7abcbac28.png"><br><br><h4>  Authorization inside the controller method </h4><br>  In some cases, you can allow the execution of the request, but change the behavior based on the security context.  For example, the result of a query depends on the role of the user.  Inside the controller method, you can get the current security context by accessing the ApiController.User property: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpResponseMessage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (User.IsInRole(<span class="hljs-string"><span class="hljs-string">"Administrators"</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">// ... } }</span></span></code> </pre><br><br>  <i>* The translation is made in a free style, perhaps someone will be jarred on by anglicisms like 'custom', but these words have become part of it jargon, and the Russian translation is not perceived as it should.</i> <br><br>  PS If you want to debug with authorization in the studio, on the local IIS (Local IIS Web server), <a href="http://stackoverflow.com/questions/4762538/iis-express-windows-authentication">here you can read</a> how to enable authorization in it. </div><p>Source: <a href="https://habr.com/ru/post/231807/">https://habr.com/ru/post/231807/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231795/index.html">Registration of Official Bloggers ‚Ñ¢ in Russia is open.</a></li>
<li><a href="../231797/index.html">Investing for Dummies</a></li>
<li><a href="../231799/index.html">PFLink: effective link enhancement with custom transitions</a></li>
<li><a href="../231801/index.html">We bring monads to PHP</a></li>
<li><a href="../231805/index.html">Intel 82599: we limit output speed</a></li>
<li><a href="../231813/index.html">Alternative Application Tracing Methods</a></li>
<li><a href="../231821/index.html">Experiment to integrate video extensions into audio speech recognition system</a></li>
<li><a href="../231825/index.html">Reverse engineering firmware Chinese Android-tablet</a></li>
<li><a href="../231827/index.html">Developing a VPN Client for Android (Part 1)</a></li>
<li><a href="../231829/index.html">Roskomnadzor approved methods of counting visitors to sites</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>