<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SQL Server 2016 CTP3.1 - what's new for the developer?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not long ago, the announcement of SQL Server 2016 , which Satya Nadella personally presented, was postponed in my memory. And suddenly, like snow on t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SQL Server 2016 CTP3.1 - what's new for the developer?</h1><div class="post__text post__text-html js-mediator-article">  Not long ago, the announcement of <i>SQL Server 2016</i> , which Satya Nadella personally presented, was postponed in my memory.  And suddenly, like snow on their heads, they began one by one to get fresh <i>Community Technology Preview</i> (at the moment the most recent version is <i>CTP3.1</i> ).  As I got acquainted with the new version, I increasingly wanted to share my impressions ... <br><br>  Next, an overview of the new <b>syntax for</b> <i>SQL Server 2016</i> : <i>JSON</i> , <i>GZIP</i> , <i>DROP IF EXISTS</i> , <i>TRUNCATE TABLE</i> by section, new features ... <br><br><h4>  <b># 1 - DROP IF EXISTS</b> </h4><br><pre><code class="1c hljs">CREATE TABLE dbo.tbl ( a INT, b INT, CONSTRAINT ck CHECK (a &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>), INDEX ix CLUSTERED (a) )</code> </pre> <br>  If earlier, before deleting an object, you had to do a check: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="1c hljs">IF OBJECT_ID(N'dbo.tbl', 'U') IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> DROP TABLE dbo.tbl</code> </pre><br>  Now a more compact syntax has appeared: <br><br><pre> <code class="1c hljs">DROP TABLE IF EXISTS dbo.tbl</code> </pre><a name="habracut"></a><br>  Added the ability to delete child elements: <br><br><pre> <code class="1c hljs">ALTER TABLE dbo.tbl DROP COLUMN IF EXISTS b ALTER TABLE dbo.tbl DROP CONSTRAINT IF EXISTS ck ALTER TABLE dbo.tbl DROP CONSTRAINT IF EXISTS ix</code> </pre><br>  For a single parent object, structures can be combined: <br><br><pre> <code class="1c hljs">ALTER TABLE dbo.tbl DROP COLUMN IF EXISTS b, CONSTRAINT IF EXISTS ck, CONSTRAINT IF EXISTS ix</code> </pre><br>  DROP IF EXISTS is supported for almost all objects (the full list can be found <a href="http://blogs.msdn.com/b/sqlserverstorageengine/archive/2015/11/03/drop-if-exists-new-thing-in-sql-server-2016.aspx">here</a> ): <br><br><pre> <code class="1c hljs">DROP TABLE IF EXISTS <span class="hljs-meta"><span class="hljs-meta">#temp DROP TABLE IF EXISTS ##temp DROP VIEW IF EXISTS dbo.view1 DROP PROCEDURE IF EXISTS dbo.proc1 DROP DATABASE IF EXISTS db</span></span></code> </pre><br><h4>  <b># 2 - SESSION_CONTEXT</b> </h4><br>  In my practice, there were tasks on sharing parameters within a user session.  Previously, you had to use <a href="https://msdn.microsoft.com/ru-ru/library/ms187768%2528v%3Dsql.120%2529.aspx"><i>CONTEXT_INFO, the</i></a> size of which was limited to 128 bytes: <br><br><pre> <code class="1c hljs">DECLARE @UserID SMALLINT = <span class="hljs-number"><span class="hljs-number">1</span></span> , @LocaleID INT = <span class="hljs-number"><span class="hljs-number">123</span></span> DECLARE @ctn VARBINARY(<span class="hljs-number"><span class="hljs-number">128</span></span>) SET @ctn = CAST(@UserID AS BINARY(<span class="hljs-number"><span class="hljs-number">2</span></span>)) + CAST(@LocaleID AS BINARY(<span class="hljs-number"><span class="hljs-number">4</span></span>)) SET CONTEXT_INFO @ctn</code> </pre><br>  Now everything has become a bit more convenient due to the new function <a href="https://msdn.microsoft.com/en-us/library/mt590806.aspx"><i>SESSION_CONTEXT</i></a> in which it was allowed to store 256Kb per session: <br><br><pre> <code class="1c hljs">EXEC sys.sp_set_session_context @key = N'UserID', @value = <span class="hljs-number"><span class="hljs-number">1</span></span> EXEC sys.sp_set_session_context @key = N'LocaleID', @value = <span class="hljs-number"><span class="hljs-number">123</span></span> SELECT UserID = SESSION_CONTEXT(N'UserID') , LocaleID = SESSION_CONTEXT(N'LocaleID')</code> </pre><br><h4>  <b># 3 - CHECKDB + MAXDOP</b> </h4><br>  By default, when executing <a href="https://msdn.microsoft.com/ru-ru/library/ms176064%2528v%3Dsql.120%2529.aspx"><i>DBCC CHECKDB</i></a> , the number of threads equal to the number of logical cores is used.  Now the number of threads can be limited, so as not to impair the performance of the server as a whole: <br><br><pre> <code class="1c hljs">DBCC CHECKDB(N'AdventureWorks<span class="hljs-number"><span class="hljs-number">2016</span></span>CTP3') WITH MAXDOP = <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre><br>  Similar functionality has been added to <a href="https://msdn.microsoft.com/ru-ru/library/ms174338%2528v%3Dsql.120%2529.aspx"><i>DBCC CHECKTABLE</i></a> and <a href="https://msdn.microsoft.com/en-us/library/ms187332.aspx"><i>DBCC CHECKFILEGROUP</i></a> : <br><br><pre> <code class="1c hljs">USE AdventureWorks2016CTP3 GO DBCC CHECKTABLE('HumanResources.Employee') WITH MAXDOP = <span class="hljs-number"><span class="hljs-number">4</span></span> DBCC CHECKFILEGROUP(<span class="hljs-number"><span class="hljs-number">1</span></span>) WITH MAXDOP = <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre><br>  For <i>DBCC, CHECKDB</i> did some optimizations when checking filtered indexes and <i>COMPUTED</i> columns with the <i>PERSISTED</i> option.  Another reduced time for checking tables that contain a large number of sections. <br><br><h4>  <b># 4 - FORMATMESSAGE</b> </h4><br>  In previous versions, the <a href="https://msdn.microsoft.com/en-us/library/ms186788.aspx"><i>FORMATMESSAGE</i></a> function could only use previously added custom messages: <br><br><pre> <code class="1c hljs">EXEC sys.sp_addmessage @msgnum = <span class="hljs-number"><span class="hljs-number">66667</span></span>, @severity = <span class="hljs-number"><span class="hljs-number">16</span></span>, @msgtext = N'param1: %s, param2: %s' DECLARE @msg NVARCHAR(<span class="hljs-number"><span class="hljs-number">2048</span></span>) = FORMATMESSAGE(<span class="hljs-number"><span class="hljs-number">66667</span></span>, N'one', N'two') SELECT @msg</code> </pre><br>  now it is possible to specify an arbitrary mask: <br><br><pre> <code class="1c hljs">SELECT FORMATMESSAGE('val1: %+i, val2: %+d', <span class="hljs-number"><span class="hljs-number">5</span></span>, -<span class="hljs-number"><span class="hljs-number">6</span></span>)</code> </pre><br>  Many routine quota operations or string concatenation can be made more elegant: <br><br><pre> <code class="1c hljs">SELECT FORMATMESSAGE('SELECT * FROM [%s].[%s]', SCHEMA_NAME([schema_id]), name) FROM sys.objects WHERE [type] = 'U'</code> </pre><br><h4>  <b># 5 - COMPRESS &amp; DECOMPRESS</b> </h4><br>  The new edition has built-in support for <i>GZIP</i> : <a href="https://msdn.microsoft.com/en-us/library/mt622775.aspx"><i>COMPRESS</i></a> and <a href="https://msdn.microsoft.com/en-us/library/mt622776.aspx"><i>DECOMPRESS</i></a> .  When decoding, it is important to monitor the correct data types into which the result is converted: <br><br><pre> <code class="1c hljs">DECLARE @a VARBINARY(MAX) = COMPRESS('test test test') SELECT @a , DECOMPRESS(@a) , CAST(DECOMPRESS(@a) AS NVARCHAR(MAX)) --  , CAST(DECOMPRESS(@a) AS VARCHAR(MAX))</code> </pre><br>  We encode the <i>ANSI</i> string and try to decode the resulting value: <br><br><pre> <code class="1c hljs">------------------------------------ ---------------------- ---------------- ----------------- <span class="hljs-number"><span class="hljs-number">0</span></span>x1F8B08000000000004002B492D2E512 <span class="hljs-number"><span class="hljs-number">0</span></span>x746573742074657374 Êï¥Áë≥Áê†Áç•‚Å¥Êï¥Áë≥ test test test</code> </pre><br><h4>  <b># 6 - DATEDIFF_BIG</b> </h4><br>  In <i>SQL Server 2008</i> , new parameters appeared for the <a href="https://msdn.microsoft.com/en-us/library/ms189794.aspx"><i>DATEDIFF</i></a> function: <i>MICROSECOND</i> and <i>NANOSECOND</i> , but when the date range was too large: <br><br><pre> <code class="1c hljs">SELECT DATEDIFF(NANOSECOND, '<span class="hljs-number"><span class="hljs-number">20000101</span></span>', '<span class="hljs-number"><span class="hljs-number">20160101</span></span>')</code> </pre><br>  This could lead to an error: <br><br><pre> <code class="1c hljs">Msg <span class="hljs-number"><span class="hljs-number">535</span></span>, Level <span class="hljs-number"><span class="hljs-number">16</span></span>, State <span class="hljs-number"><span class="hljs-number">0</span></span>, Line <span class="hljs-number"><span class="hljs-number">1</span></span> The datediff function resulted in an overflow. The number of dateparts separating two date/time instances is too large. Try to use datediff with a less precise datepart.</code> </pre><br>  For such situations, a new <a href="https://msdn.microsoft.com/en-us/library/mt628058.aspx"><i>DATEDIFF_BIG</i></a> function has been <a href="https://msdn.microsoft.com/en-us/library/mt628058.aspx"><i>added</i></a> : <br><br><pre> <code class="1c hljs">SELECT DATEDIFF_BIG(NANOSECOND, '<span class="hljs-number"><span class="hljs-number">20000101</span></span>', '<span class="hljs-number"><span class="hljs-number">20160101</span></span>')</code> </pre><br><h4>  <b># 7 - AT TIME ZONE</b> </h4><br>  <i>CTP3.0 has</i> a new system view: <br><br><pre> <code class="1c hljs">SELECT name, current_utc_offset, is_currently_dst FROM sys.time_zone_info</code> </pre><br>  in which you can get a list of time zones: <br><br><pre> <code class="1c hljs">name current_utc_offset is_currently_dst -------------------------- ------------------ ---------------- Dateline Standard Time -<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> UTC-<span class="hljs-number"><span class="hljs-number">11</span></span> -<span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ... Central Standard Time -<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ... Pacific SA Standard Time -<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> UTC-<span class="hljs-number"><span class="hljs-number">02</span></span> -<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ... UTC +<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> GMT Standard Time +<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Greenwich Standard Time +<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ... Belarus Standard Time +<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Russian Standard Time +<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ...</code> </pre><br>  With <a href="https://msdn.microsoft.com/en-us/library/mt612795.aspx"><i>AT TIME ZONE,</i></a> you can display the time in a given time zone: <br><br><pre> <code class="1c hljs">SELECT CONVERT(DATETIME2, GETDATE()) AT TIME ZONE N'Belarus Standard Time'</code> </pre><br><pre> <code class="1c hljs">---------------------------------- <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">02.1366667</span></span> +<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span></code> </pre><br>  which can be parameterized: <br><br><pre> <code class="1c hljs">DECLARE @tz NVARCHAR(<span class="hljs-number"><span class="hljs-number">256</span></span>) = N'Belarus Standard Time' SELECT GETDATE() AT TIME ZONE @tz , CONVERT(DATETIME2, GETDATE()) AT TIME ZONE @tz</code> </pre><br><pre> <code class="1c hljs">---------------------------------- <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">28.6266667</span></span> +<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span></code> </pre><br>  What is the use of such an innovation?  For example, you can display how much time in other time zones, based on the current time we have: <br><br><pre> <code class="1c hljs">SELECT name, CONVERT(DATETIME, SWITCHOFFSET(SYSUTCDATETIME() AT TIME ZONE name, DATENAME(TzOffset, SYSDATETIMEOFFSET())) ) FROM sys.time_zone_info</code> </pre><br><pre> <code class="1c hljs">---------------------------------- ----------------------- Dateline Standard Time <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">41.940</span></span> UTC-<span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">41.940</span></span> ... Pacific SA Standard Time <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">41.940</span></span> UTC-<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">41.940</span></span> ... UTC <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">41.940</span></span> GMT Standard Time <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">41.940</span></span> Greenwich Standard Time <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">41.940</span></span> Central European Standard Time <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">41.940</span></span> ...</code> </pre><br><h4>  <b># 8 - JSON</b> </h4><br>  <i>JSON</i> support is one of the main features of <i>SQL Server 2016</i> .  Starting from <i>CTP2.0</i> , it became possible to generate <i>JSON</i> by analogy with <i>XML</i> .  Two <a href="https://msdn.microsoft.com/en-us/library/dn921883.aspx"><i>FOR JSON AUTO</i></a> and <a href="https://msdn.microsoft.com/en-us/library/dn921877.aspx"><i>FOR JSON PATH</i></a> constructs are supported: <br><br><pre> <code class="1c hljs">SELECT TOP (<span class="hljs-number"><span class="hljs-number">2</span></span>) name, database_id, source_database_id, create_date FROM sys.databases FOR JSON AUTO, ROOT('root')</code> </pre><br><pre> <code class="1c hljs">{<span class="hljs-string"><span class="hljs-string">"root"</span></span>: [ {<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"master"</span></span>,<span class="hljs-string"><span class="hljs-string">"database_id"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">"create_date"</span></span>:<span class="hljs-string"><span class="hljs-string">"2003-04-08T09:13:36.390"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"tempdb"</span></span>,<span class="hljs-string"><span class="hljs-string">"database_id"</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">"create_date"</span></span>:<span class="hljs-string"><span class="hljs-string">"2015-12-02T11:34:36.080"</span></span>} ] }</code> </pre><br><pre> <code class="1c hljs">SELECT TOP (<span class="hljs-number"><span class="hljs-number">2</span></span>) name , [db.id] = database_id , [db.scr_id] = source_database_id , [db.date] = create_date FROM sys.databases FOR JSON PATH, ROOT</code> </pre><br><pre> <code class="1c hljs">{<span class="hljs-string"><span class="hljs-string">"root"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"master"</span></span>, <span class="hljs-string"><span class="hljs-string">"db"</span></span>:{<span class="hljs-string"><span class="hljs-string">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">"date"</span></span>:<span class="hljs-string"><span class="hljs-string">"2003-04-08T09:13:36.390"</span></span>} }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"tempdb"</span></span>, <span class="hljs-string"><span class="hljs-string">"db"</span></span>:{<span class="hljs-string"><span class="hljs-string">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">"date"</span></span>:<span class="hljs-string"><span class="hljs-string">"2015-12-02T11:34:36.080"</span></span>} } ] }</code> </pre><br>  In order for <i>NULL</i> values ‚Äã‚Äãto be included in <i>JSON</i> when generating, the <a href="https://msdn.microsoft.com/en-us/library/dn921878.aspx"><i>INCLUDE_NULL_VALUES</i></a> option must be used: <br><br><pre> <code class="1c hljs">SELECT TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) name, database_id, source_database_id FROM sys.databases FOR JSON AUTO, INCLUDE_NULL_VALUES</code> </pre><br><pre> <code class="1c hljs">[ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"master"</span></span>, <span class="hljs-string"><span class="hljs-string">"database_id"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"source_database_id"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span> } ]</code> </pre><br>  If you need to remove the square brackets from <i>JSON</i> , then the <a href="https://msdn.microsoft.com/en-us/library/mt631354.aspx"><i>WITHOUT_ARRAY_WRAPPER</i></a> option is provided for this (which is available starting from <i>CTP3.2</i> version): <br><br><pre> <code class="1c hljs">SELECT TOP (<span class="hljs-number"><span class="hljs-number">1</span></span>) name, database_id, source_database_id FROM sys.databases FOR JSON AUTO, WITHOUT_ARRAY_WRAPPER</code> </pre><br><pre> <code class="1c hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"master"</span></span>, <span class="hljs-string"><span class="hljs-string">"database_id"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre><br>  You need to use <i>NVARCHAR</i> to store <i>JSON</i> , since there is no separate data type: <br><br><pre> <code class="1c hljs">DECLARE @json NVARCHAR(MAX) = ( SELECT key1 = <span class="hljs-number"><span class="hljs-number">1</span></span>, key2 = GETDATE() FOR JSON PATH ) SELECT @json</code> </pre><br><pre> <code class="1c hljs">{<span class="hljs-string"><span class="hljs-string">"key1"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">"key2"</span></span>:<span class="hljs-string"><span class="hljs-string">"2015-12-02T15:45:05.530"</span></span>}</code> </pre><br>  To make a selection of <i>JSON,</i> you can use <a href="https://msdn.microsoft.com/en-us/library/dn921893.aspx"><i>OPENJSON</i></a> .  If the record is one, then the result is returned in the form of "key-value": <br><br><pre> <code class="1c hljs">DECLARE @json NVARCHAR(MAX) = N' { "UserID" : 1, "UserName": "JC Denton", "IsActive": true, "RegDate": "<span class="hljs-number"><span class="hljs-number">2015-12-02</span></span>" }'; SELECT * FROM OPENJSON(@json)</code> </pre><br><pre> <code class="1c hljs">key value type ----------- ------------ ---- UserID <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> UserName JC Denton <span class="hljs-number"><span class="hljs-number">1</span></span> IsActive true <span class="hljs-number"><span class="hljs-number">3</span></span> RegDate <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  This behavior can be used as a ‚Äúanother version‚Äù of the split line: <br><br><pre> <code class="1c hljs">DECLARE @a NVARCHAR(<span class="hljs-number"><span class="hljs-number">100</span></span>) = '1,2,3' SELECT CAST(value AS INT) FROM OPENJSON(N'[' + @a + N']')</code> </pre><br><pre> <code class="1c hljs">----------- <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br>  If there are several entries: <br><br><pre> <code class="1c hljs">DECLARE @json NVARCHAR(MAX) = N' [ { "UserID" : 1, "UserName": "JC Denton", "IsActive": true, "RegDate": "<span class="hljs-number"><span class="hljs-number">2015-12-02</span></span>" }, { "UserID" : 2, "UserName": "Paul Denton", "IsActive": false, "RegDate": "<span class="hljs-number"><span class="hljs-number">2015-11-02</span></span>" } ]'; SELECT * FROM OPENJSON(@json)</code> </pre><br>  then the result will be as follows: <br><br><img src="https://habrastorage.org/files/788/fa2/f8f/788fa2f8f6104b2daea10e811eef171b.png"><br><br>  In normal form, the data can be obtained as follows: <br><br><pre> <code class="1c hljs">DECLARE @json NVARCHAR(MAX) = N' [ { "UserID" : 1, "UserName": "JC Denton", "IsActive": true, "RegDate": "<span class="hljs-number"><span class="hljs-number">2015-12-02</span></span>" }, { "UserID" : 2, "UserName": "Paul Denton", "IsActive": 0, "RegDate": "<span class="hljs-number"><span class="hljs-number">2015-11-02</span></span>" } ]'; SELECT * FROM OPENJSON(@json) WITH ( UserID INT, UserName VARCHAR(<span class="hljs-number"><span class="hljs-number">50</span></span>), IsActive BIT, [Date] DATE '$.RegDate' )</code> </pre><br><pre> <code class="1c hljs">UserID UserName IsActive Date ----------- --------------- -------- ---------- <span class="hljs-number"><span class="hljs-number">1</span></span> JC Denton <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> Paul Denton <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">11</span></span>-<span class="hljs-number"><span class="hljs-number">02</span></span></code> </pre><br>  If you need to get a scalar expression, you can use <a href="https://msdn.microsoft.com/en-us/library/dn921898.aspx"><i>JSON_VALUE</i></a> : <br><br><pre> <code class="1c hljs">DECLARE @json NVARCHAR(<span class="hljs-number"><span class="hljs-number">4000</span></span>) = N' { "UserID" : 1, "Detail": [ { "Year":<span class="hljs-number"><span class="hljs-number">2016</span></span> }, { "Year":<span class="hljs-number"><span class="hljs-number">2015</span></span>, "Options": [{ "Visible":true }] ] }' SELECT JSON_VALUE(@json, '$.UserID') , JSON_VALUE(@json, '$.Detail[0].Year') , JSON_VALUE(@json, '$.Detail[1].Year') , JSON_VALUE(@json, '$.Detail[1].Options[0].Visible')</code> </pre><br>  To get an array of objects from <i>JSON</i> , the <a href="https://msdn.microsoft.com/en-us/library/dn921884.aspx"><i>JSON_QUERY</i></a> function is <a href="https://msdn.microsoft.com/en-us/library/dn921884.aspx"><i>provided</i></a> : <br><br><pre> <code class="1c hljs">DECLARE @json NVARCHAR(<span class="hljs-number"><span class="hljs-number">4000</span></span>) = N' { "Main" :{ "Detail": { "Name":"color", "Value":"blue" } }' SELECT JSON_QUERY(@json, '$.Main.Detail')</code> </pre><br>  You can use the <a href="https://msdn.microsoft.com/en-us/library/dn921896.aspx"><i>ISJSON</i></a> function if you need to make sure that the text is <i>JSON</i> : <br><br><pre> <code class="1c hljs">DECLARE @json NVARCHAR(MAX) = N'{"ID" : 1}'; SELECT ISJSON(@json), ISJSON('')</code> </pre><br>  There are no special indexes for <i>JSON</i> , but it is possible to use <i>COMPUTED</i> columns: <br><br><pre> <code class="1c hljs">DROP TABLE IF EXISTS dbo.Users CREATE TABLE dbo.Users ( OrderID INT PRIMARY KEY, JSON NVARCHAR(<span class="hljs-number"><span class="hljs-number">4000</span></span>), CONSTRAINT CK_IsJSON CHECK (ISJSON(JSON)=<span class="hljs-number"><span class="hljs-number">1</span></span>), Age AS (CONVERT(INT, JSON_VALUE(JSON, '$.Age'))) ) CREATE INDEX IX_Age ON dbo.Users(Age)</code> </pre><br>  Now not for all <i>COMPUTED</i> columns based on <i>JSON,</i> you can create an index: <br><br><pre> <code class="1c hljs">ALTER TABLE dbo.Users ADD RegDate AS (CAST(JSON_VALUE(JSON, '$.Age') AS DATE)) GO CREATE INDEX IX_RegDate ON dbo.Users(RegDate)</code> </pre><br><pre> <code class="1c hljs">Msg <span class="hljs-number"><span class="hljs-number">2729</span></span>, Level <span class="hljs-number"><span class="hljs-number">16</span></span>, State <span class="hljs-number"><span class="hljs-number">1</span></span>, Line <span class="hljs-number"><span class="hljs-number">15</span></span> Column 'RegDate' in table 'dbo.Users' cannot be used in an index or statistics or as a partition key because it is non-deterministic.</code> </pre><br>  This bug should be fixed in the next version of <i>CTP</i> . <br><br><h4>  <b># 9 - ONLINE ALTER COLUMN</b> </h4><br>  The <i>ALTER COLUMN</i> command can now be carried out in the <i>ONLINE</i> mode.  When the command is executed, the data on the column will be available for reading, and the blocking of the <i>Sch-M</i> scheme is imposed only at the very end of the <i>ALTER</i> operation, when switching to new pages with data takes place (you can read more <a href="http://sqlperformance.com/2015/02/sql-performance/more-online-operations">here</a> ). <br><br><pre> <code class="1c hljs">DROP TABLE IF EXISTS dbo.tbl CREATE TABLE dbo.tbl (x VARCHAR(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) GO ALTER TABLE dbo.tbl ALTER COLUMN x VARCHAR(<span class="hljs-number"><span class="hljs-number">255</span></span>) NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> WITH (ONLINE = ON) GO ALTER TABLE dbo.tbl ALTER COLUMN x NVARCHAR(<span class="hljs-number"><span class="hljs-number">255</span></span>) COLLATE Cyrillic_General_100_CI_AS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> WITH (ONLINE = ON)</code> </pre><br><h4>  <b># 10 - TRUNCATE TABLE + PARTITIONS</b> </h4><br>  In version <i>CTP2.0,</i> for the <a href="https://msdn.microsoft.com/query/dev10.query%3FappId%3DDev10IDEF1%26l%3DEN-US%26k%3Dk%2528TRUNCATE_TSQL%2529%3Bk%2528SQL12.SWB.TSQLRESULTS.F1%2529%3Bk%2528SQL12.SWB.TSQLQUERY.F1%2529%3Bk%2528MISCELLANEOUSFILESPROJECT%2529%3Bk%2528DevLang-TSQL%2529%26rd%3Dtrue"><i>TRUNCATE TABLE</i></a> operation, the ability to work with individual sections, and not just over the entire table, was added.  In this case, you can specify not only a separate section, but a whole range of sections.  Create a test table: <br><br><pre> <code class="1c hljs">CREATE PARTITION FUNCTION PF (SMALLINT) AS RANGE RIGHT FOR VALUES (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>) GO CREATE PARTITION SCHEME PS AS PARTITION PF ALL TO ([PRIMARY]) GO DROP TABLE IF EXISTS dbo.tbl CREATE TABLE dbo.tbl (a SMALLINT PRIMARY KEY) ON PS (a) GO INSERT INTO dbo.tbl (a) VALUES (<span class="hljs-number"><span class="hljs-number">0</span></span>), (<span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>), (<span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">4</span></span>), (<span class="hljs-number"><span class="hljs-number">5</span></span>) SELECT partition_number, [rows] FROM sys.partitions WHERE [object_id] = OBJECT_ID('dbo.tbl') AND index_id &lt; <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br><pre> <code class="1c hljs">---------------- ------ <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br><pre> <code class="1c hljs">TRUNCATE TABLE dbo.tbl WITH (PARTITIONS (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span> TO <span class="hljs-number"><span class="hljs-number">5</span></span>))</code> </pre><br><pre> <code class="1c hljs">partition_number rows ---------------- ------ <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br><h4>  <b># 11 - CURRENT_TRANSACTION_ID</b> </h4><br>  In <i>CTP3.0</i> , a new function <i>CURRENT_TRANSACTION_ID</i> was added, which, based on the name, returns the current transaction ... Perhaps this function will be useful to someone, but for her, I could not think of a more illustrative example: <br><br><pre> <code class="1c hljs">BEGIN TRANSACTION UPDATE HumanResources.Employee SET SalariedFlag = <span class="hljs-number"><span class="hljs-number">0</span></span> WHERE BusinessEntityID = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br><pre> <code class="1c hljs">SELECT ec.session_id, s.[text] FROM sys.dm_tran_session_transactions t JOIN sys.dm_exec_connections ec ON t.session_id = ec.session_id CROSS APPLY sys.dm_exec_sql_text(ec.most_recent_sql_handle) s WHERE t.transaction_id != CURRENT_TRANSACTION_ID()</code> </pre><br><pre> <code class="1c hljs">session_id text ----------- --------------------------- <span class="hljs-number"><span class="hljs-number">67</span></span> BEGIN TRANSACTION UPDATE HumanResources.Employee SET SalariedFlag = <span class="hljs-number"><span class="hljs-number">0</span></span> WHERE BusinessEntityID = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  <b>A small afterword ...</b> <br><br>  From what I'm watching, the release of <i>SQL Server 2016</i> promises to be very interesting.  With each new <i>CTP</i> , a large number of chips are added, which are difficult to describe in one article.  To keep readability, I left <i>Temporal Tables</i> , <i>Dynamic Data Masking</i> and <i>In-Memory</i> enhancements, which I plan to add in the upcoming continuation, overboard. <br><br>  If you want to share this article with an English-speaking audience: <br>  <a href="http://blog.devart.com/sql-server-2016-ctp3-1-whats-new-for-developer.html">SQL Server 2016 CTP3.1 - What's New for Developer?</a> </div><p>Source: <a href="https://habr.com/ru/post/272211/">https://habr.com/ru/post/272211/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272201/index.html">The steady beauty of indecent models</a></li>
<li><a href="../272203/index.html">Where does IaaS work?</a></li>
<li><a href="../272205/index.html">10 attacks on web applications in action</a></li>
<li><a href="../272207/index.html">Kazakhstan introduces its CA to listen to all TLS traffic</a></li>
<li><a href="../272209/index.html">GDG DevFest Nizhny Novgorod 2015: photo report from the event</a></li>
<li><a href="../272213/index.html">Visual tests with the Galen Framework. Improving code readability</a></li>
<li><a href="../272215/index.html">I believe - I do not believe in indie development. Part 1</a></li>
<li><a href="../272223/index.html">Google Chrome web browser provided another security enhancement</a></li>
<li><a href="../272227/index.html">Java 9 will be postponed for half a year</a></li>
<li><a href="../272229/index.html">Why are our high-level languages ‚Äã‚Äãstill not so high-level?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>