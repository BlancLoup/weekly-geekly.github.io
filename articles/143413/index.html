<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Editing tree structures with SonataAdminBundle in Symfony2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Editing tree structures is a fairly frequent task in web development. This is very convenient for the user, as it allows him to create any hierarchy o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Editing tree structures with SonataAdminBundle in Symfony2</h1><div class="post__text post__text-html js-mediator-article">  Editing tree structures is a fairly frequent task in web development.  This is very convenient for the user, as it allows him to create any hierarchy on his site.  Naturally, after switching to Symfony2, one of the first tasks was to create such a hierarchical list of pages and write an admin to it.  And since I use <a href="https://github.com/sonata-project/SonataAdminBundle">SonataAdminBundle</a> as admin <a href="https://github.com/sonata-project/SonataAdminBundle">panel</a> , the task was to configure it for editing trees. <br><a name="habracut"></a><br>  It seemed that the problem was widespread, in demand, and I expected to get a ready-made solution out of the box.  However, this did not happen.  Moreover, the developers of Sonata never seemed to think that it would occur to someone to "admin" the trees through their bundle. <br><br>  Let's start with the tree itself.  From my very "programmer childhood" I was taught to never reinvent the wheel.  And even though I sometimes ‚Äúkicked‚Äù and retorted that the reinvented bike would be easier and go forward, not sideways: I always got my hands and ... had to use ready-made solutions.  For the tree structure of the pages, it was decided to use the <a href="http://www.gediminasm.org/article/tree-nestedset-behavior-extension-for-doctrine-2">Nested tree</a> from Doctrine Extensions. <br><br>  Creating a tree model using the Doctrine Extensions Tree is easy and is described in the manual.  I want to note that for convenient use of the Doctrine extensions inside Symfony2, you need to connect <a href="https://github.com/stof/StofDoctrineExtensionsBundle">StofDoctrineExtensionsBundle</a> , the installation and configuration of which, again, is well described in the <a href="">manual</a> .  Well, if someone has any problems with this, I will be happy to help in the comments. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, I have a ShtumiPravBundle model: Page, the full code of which I will not give in this article as unnecessary. <br><br>  Now I want to say a few words about the bad features of the Nested Tree, because of which I had to change everything a couple of times. <br><br><ol><li>  To store the tree structure, Doctrine Extensions uses not only the parent field, but also the root, lft, rgt, lvl fields, which are also stored in the database.  The purpose of the fields is clear: they determine the order of the children in the tree, and also allow you to create simpler SQL queries to get the elements in the "correct" order.  These fields are calculated and stored in the database automatically.  However, I could not understand the algorithm for calculating the value of the lft and rgt field (though I didn‚Äôt try hard).  So here.  It is worth the value of these fields in any element of the tree to become wrong - it will break the entire tree.  A breakdown that is practically impossible to fix, given the difficulty of calculating the above fields, multiplied by the number of tree elements. </li><li>  In the Doctrine Extensions Tree it is not possible to swap root elements using standard methods (moveUp, moveDown).  When you try to do this, "climbs" an exception with the appropriate message.  The behavior, the right to say, is strange and unexpected, but you have to put up. </li><li>  In Section 1, I talked about the root, lft, rgt fields, a failure in the values ‚Äã‚Äãof which leads to the breakdown of the entire tree.  Now pour oil on the fire.  Such situations occur in case of failure when deleting tree elements due to the presence of foreign keys.  In my case, these were additional elements, ‚Äúbolted‚Äù to each article.  The problem was revealed in all its glory after filling the site with content, and the restoration of the tree required a lot of nerves and labor costs. </li></ol><br><h5>  Output tree structure in admin panel </h5><br>  One of the first problems that had to be solved was the output of pages in the admin panel in the form of a tree, that is, add the number of spaces corresponding to the nesting level on the left before the article title.  The same problem was in select dropdown lists.  The solution was found very simple - add the __toString and getLaveledTitle methods to the model: <br><br><pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Page</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $prefix = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i=<span class="hljs-number"><span class="hljs-number">2</span></span>; $i&lt;= <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;lvl; $i++){ $prefix .= <span class="hljs-string"><span class="hljs-string">"&amp; nbsp;&amp; nbsp;&amp; nbsp;&amp; nbsp;"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $prefix . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;title; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLaveledTitle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (string)<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; } ... }</code> </pre> <br>  Now in the list settings, it became possible to use the laveled_title field generated on the fly. <br><br>  I agree that the solution is not the best, but there is no other here. <br><br><img src="https://habrastorage.org/storage2/f1c/1d1/925/f1c1d192538e003b14dfe956f0885ecb.png"><br><br>  Let us recall p. 2 of the problems about which I wrote above.  The easiest way to get around this problem is to create one root element and either not use it at all or use it as the text of the main page. <br>  I decided to give it a name "== Root element ==" and not to use it anywhere else.  That is, to forbid its editing / deleting in the admin panel.  All other articles must be either direct descendants of this root element, or descendants of descendants.  The root element was created by hand in the database, and in order for it not to be editable, the createQuery method was added to the PageAdmin class. <br><br>  Here I will give the full code of the PageAdmin class, and below I will describe what methods and what were used for. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Shtumi</span></span>\<span class="hljs-title"><span class="hljs-title">PravBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Admin</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Sonata</span></span>\<span class="hljs-title"><span class="hljs-title">AdminBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Admin</span></span>\<span class="hljs-title"><span class="hljs-title">Admin</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Sonata</span></span>\<span class="hljs-title"><span class="hljs-title">AdminBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Form</span></span>\<span class="hljs-title"><span class="hljs-title">FormMapper</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Sonata</span></span>\<span class="hljs-title"><span class="hljs-title">AdminBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Datagrid</span></span>\<span class="hljs-title"><span class="hljs-title">ListMapper</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Sonata</span></span>\<span class="hljs-title"><span class="hljs-title">DoctrineORMAdminBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Datagrid</span></span>\<span class="hljs-title"><span class="hljs-title">ProxyQuery</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PageAdmin</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Admin</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $maxPerPage = <span class="hljs-number"><span class="hljs-number">2500</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $maxPageLinks = <span class="hljs-number"><span class="hljs-number">2500</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $datagridValues = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'_sort_order'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ASC'</span></span>, <span class="hljs-string"><span class="hljs-string">'_sort_by'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'p.root, p.lft'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($context = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'list'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $em = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;modelManager-&gt;getEntityManager(<span class="hljs-string"><span class="hljs-string">'Shtumi\PravBundle\Entity\Page'</span></span>); $queryBuilder = $em -&gt;createQueryBuilder(<span class="hljs-string"><span class="hljs-string">'p'</span></span>) -&gt;select(<span class="hljs-string"><span class="hljs-string">'p'</span></span>) -&gt;from(<span class="hljs-string"><span class="hljs-string">'ShtumiPravBundle:Page'</span></span>, <span class="hljs-string"><span class="hljs-string">'p'</span></span>) -&gt;where(<span class="hljs-string"><span class="hljs-string">'p.parent IS NOT NULL'</span></span>); $query = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProxyQuery($queryBuilder); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $query; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configureListFields</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ListMapper $listMapper)</span></span></span><span class="hljs-function"> </span></span>{ $listMapper -&gt;add(<span class="hljs-string"><span class="hljs-string">'up'</span></span>, <span class="hljs-string"><span class="hljs-string">'text'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'template'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ShtumiPravBundle:admin:field_tree_up.html.twig'</span></span>, <span class="hljs-string"><span class="hljs-string">'label'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">' '</span></span>)) -&gt;add(<span class="hljs-string"><span class="hljs-string">'down'</span></span>, <span class="hljs-string"><span class="hljs-string">'text'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'template'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ShtumiPravBundle:admin:field_tree_down.html.twig'</span></span>, <span class="hljs-string"><span class="hljs-string">'label'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">' '</span></span>)) -&gt;add(<span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'sortable'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)) -&gt;addIdentifier(<span class="hljs-string"><span class="hljs-string">'laveled_title'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'sortable'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-string"><span class="hljs-string">'label'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">' '</span></span>)) -&gt;add(<span class="hljs-string"><span class="hljs-string">'_action'</span></span>, <span class="hljs-string"><span class="hljs-string">'actions'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'actions'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'edit'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(), <span class="hljs-string"><span class="hljs-string">'delete'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>() ), <span class="hljs-string"><span class="hljs-string">'label'</span></span>=&gt; <span class="hljs-string"><span class="hljs-string">''</span></span> )) ; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configureFormFields</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FormMapper $form)</span></span></span><span class="hljs-function"> </span></span>{ $subject = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getSubject(); $id = $subject-&gt;getId(); $form -&gt;with(<span class="hljs-string"><span class="hljs-string">''</span></span>) -&gt;add(<span class="hljs-string"><span class="hljs-string">'parent'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'label'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span> , <span class="hljs-string"><span class="hljs-string">'required'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">true</span></span> , <span class="hljs-string"><span class="hljs-string">'query_builder'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($er)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ $qb = $er-&gt;createQueryBuilder(<span class="hljs-string"><span class="hljs-string">'p'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($id){ $qb -&gt;where(<span class="hljs-string"><span class="hljs-string">'p.id &lt;&gt; :id'</span></span>) -&gt;setParameter(<span class="hljs-string"><span class="hljs-string">'id'</span></span>, $id); } $qb -&gt;orderBy(<span class="hljs-string"><span class="hljs-string">'p.root, p.lft'</span></span>, <span class="hljs-string"><span class="hljs-string">'ASC'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $qb; } )) -&gt;add(<span class="hljs-string"><span class="hljs-string">'title'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'label'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>)) -&gt;add(<span class="hljs-string"><span class="hljs-string">'text'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'label'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">' '</span></span>)) -&gt;end() ; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">preRemove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($object)</span></span></span><span class="hljs-function"> </span></span>{ $em = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;modelManager-&gt;getEntityManager($object); $repo = $em-&gt;getRepository(<span class="hljs-string"><span class="hljs-string">"ShtumiPravBundle:Page"</span></span>); $subtree = $repo-&gt;childrenHierarchy($object); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($subtree <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $el){ $menus = $em-&gt;getRepository(<span class="hljs-string"><span class="hljs-string">'ShtumiPravBundle:AdditionalMenu'</span></span>) -&gt;findBy(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'page'</span></span>=&gt; $el[<span class="hljs-string"><span class="hljs-string">'id'</span></span>])); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($menus <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $m){ $em-&gt;remove($m); } $services = $em-&gt;getRepository(<span class="hljs-string"><span class="hljs-string">'ShtumiPravBundle:Service'</span></span>) -&gt;findBy(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'page'</span></span>=&gt; $el[<span class="hljs-string"><span class="hljs-string">'id'</span></span>])); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($services <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $s){ $em-&gt;remove($s); } $em-&gt;flush(); } $repo-&gt;verify(); $repo-&gt;recover(); $em-&gt;flush(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postPersist</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($object)</span></span></span><span class="hljs-function"> </span></span>{ $em = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;modelManager-&gt;getEntityManager($object); $repo = $em-&gt;getRepository(<span class="hljs-string"><span class="hljs-string">"ShtumiPravBundle:Page"</span></span>); $repo-&gt;verify(); $repo-&gt;recover(); $em-&gt;flush(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($object)</span></span></span><span class="hljs-function"> </span></span>{ $em = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;modelManager-&gt;getEntityManager($object); $repo = $em-&gt;getRepository(<span class="hljs-string"><span class="hljs-string">"ShtumiPravBundle:Page"</span></span>); $repo-&gt;verify(); $repo-&gt;recover(); $em-&gt;flush(); } }</code> </pre><br>  In building a tree in Nested tree there is one feature.  In order to go around the entire tree from left to right in the correct sequence, it is necessary to sort its elements first by the root field and then by the lft field.  For this, the $ datagridValues ‚Äã‚Äãproperty has been added. <br><br>  When editing a tree, pagination is not needed in most cases.  Therefore, I increased the number of elements by one page from the standard 30 to 2500. <br><br><h5>  Add / Edit Items </h5><br>  Here the main problem was the output of a hierarchical drop-down list of parents in the form of editing the article.  This problem was solved by adding query_builder with closing the entity field parent.  Since we have a root element in the database "== Root element ==", the parent field must be mandatory. <br><br><img src="https://habrastorage.org/storage2/362/d55/21b/362d5521bcae15dae648f5e21a02e53c.png"><br><br>  As for the postPersist and postUpdate methods, they were added to call the verify and recover repository methods to make sure that after these actions the tree structure will not be damaged. <br><br><h5>  Sort items relative to their neighbors </h5><br>  It was also necessary to make buttons with the help of which the user could move the articles up / down relative to their neighbors.  SonataAdminBundle allows you to use your templates in the list fields of entries.  Therefore, it is necessary to create two templates: for the up and down buttons, respectively: <br><br>  <b>ShtumiPravBundle: admin: field_tree_up.html.twig</b> <br><br><pre> <code class="html hljs xml">{% extends 'SonataAdminBundle:CRUD:base_list_field.html.twig' %} {% block field %} {% spaceless %} {% if object.parent.children[0].id != object.id %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ path('page_tree_up', {'page_id': object.id}) }}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ asset('bundles/shtumiprav/images/admin/arrow_up.png') }}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{% trans %}{% endtrans %}"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> {% endif %} {% endspaceless %} {% endblock %}</code> </pre><br><br>  <b>ShtumiPravBundle: admin: field_tree_down.html.twig</b> <br><br><pre> <code class="html hljs xml">{% extends 'SonataAdminBundle:CRUD:base_list_field.html.twig' %} {% block field %} {% spaceless %} {% if object.parent.children[object.parent.children|length - 1].id != object.id %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ path('page_tree_down', {'page_id': object.id}) }}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ asset('bundles/shtumiprav/images/admin/arrow_down.png') }}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{% trans %}{% endtrans %}"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> {% endif %} {% endspaceless %} {% endblock %}</code> </pre><br>  These templates are included in the configureListFields method of the PageAdmin class. <br><br>  Two paths must be added to the routing.yml file: for the up and down buttons, respectively: <br><br><pre> <code class="php hljs">page_tree_up: pattern: /admin/page_tree_up/{page_id} defaults: { _controller: ShtumiPravBundle:PageTreeSort:up } page_tree_down: pattern: /admin/page_tree_down/{page_id} defaults: { _controller: ShtumiPravBundle:PageTreeSort:down }</code> </pre><br>  And of course, you need to create a PageTreeSortController controller that will perform the movement of the article: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Shtumi</span></span>\<span class="hljs-title"><span class="hljs-title">PravBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Bundle</span></span>\<span class="hljs-title"><span class="hljs-title">FrameworkBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>\<span class="hljs-title"><span class="hljs-title">Controller</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Sensio</span></span>\<span class="hljs-title"><span class="hljs-title">Bundle</span></span>\<span class="hljs-title"><span class="hljs-title">FrameworkExtraBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Configuration</span></span>\<span class="hljs-title"><span class="hljs-title">Route</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Sensio</span></span>\<span class="hljs-title"><span class="hljs-title">Bundle</span></span>\<span class="hljs-title"><span class="hljs-title">FrameworkExtraBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Configuration</span></span>\<span class="hljs-title"><span class="hljs-title">Template</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">JMS</span></span>\<span class="hljs-title"><span class="hljs-title">SecurityExtraBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Annotation</span></span>\<span class="hljs-title"><span class="hljs-title">Secure</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PageTreeSortController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Secure</span></span></span><span class="hljs-comment">(roles="ROLE_SUPER_ADMIN") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">upAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($page_id)</span></span></span><span class="hljs-function"> </span></span>{ $em = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getDoctrine()-&gt;getEntityManager(); $repo = $em-&gt;getRepository(<span class="hljs-string"><span class="hljs-string">'ShtumiPravBundle:Page'</span></span>); $page = $repo-&gt;findOneById($page_id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($page-&gt;getParent()){ $repo-&gt;moveUp($page); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;redirect(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRequest()-&gt;headers-&gt;get(<span class="hljs-string"><span class="hljs-string">'referer'</span></span>)); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Secure</span></span></span><span class="hljs-comment">(roles="ROLE_SUPER_ADMIN") */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($page_id)</span></span></span><span class="hljs-function"> </span></span>{ $em = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getDoctrine()-&gt;getEntityManager(); $repo = $em-&gt;getRepository(<span class="hljs-string"><span class="hljs-string">'ShtumiPravBundle:Page'</span></span>); $page = $repo-&gt;findOneById($page_id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($page-&gt;getParent()){ $repo-&gt;moveDown($page); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;redirect(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getRequest()-&gt;headers-&gt;get(<span class="hljs-string"><span class="hljs-string">'referer'</span></span>)); } }</code> </pre><br>  Only an administrator can access this controller, therefore a ROLE_SUPER_ADMIN role restriction is necessary. <br><br><h5>  Deleting items </h5><br>  The main subtlety of the removal of tree elements is that care must be taken to avoid conflicts due to the foreign key and failures in the tree.  I already spoke about this in paragraph 3 of the problems of the Nested tree. <br><br>  I deliberately did not remove the preRemove method from the PageAdmin class to show that before deleting an article you need to take care and delete all entries related to it from other models.  In my case, these were the AdditionalMenu and Service models. <br><br>  Separately, I want to note that the installation in the cascade delete model does not work in this case.  The fact is that the Doctrine Extensions Tree to remove descendants uses its own methods that do not pay attention to cascading.  True, for greater certainty, I still installed cascading deletion: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Page</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\OneToMany(targetEntity="Service", mappedBy="page", cascade={"all"}, orphanRemoval=true) * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@ORM</span></span></span><span class="hljs-comment">\OrderBy({"position"="ASC"}) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $services; ... }</code> </pre><br>  Removing the descendants of the Nested Tree automatically.  There was nothing to adjust. <br><br><h5>  Conclusion </h5><br>  It would seem that there is nothing difficult in the solution I described, but because of the sometimes not very transparent behavior of the Nested Tree, complicated by the features of creating admins in SonataAdminBundle, I had to tinker with this decision for some time.  I hope that this will help you save time, dear reader, in carrying out a similar task. <br><br>  What is missing this decision.  The first thing that comes to mind is hiding subtrees.  That is, "pluses" near each element, allowing to display its descendants.  Such a solution will be relevant for very large trees.  The second idea of ‚Äã‚Äãimprovements follows from the first - I would like the admin panel to remember this parent element by clicking on the ‚Äúplus sign‚Äù and automatically select it in the ‚Äúparent‚Äù field when creating a new article. <br><br>  The solution to both problems is not difficult.  It is necessary to create another template for the ‚Äúplus sign‚Äù and then save in the controller to the session which elements need to be displayed and which to hide.  Well, in the createQuery method, process data from this session. </div><p>Source: <a href="https://habr.com/ru/post/143413/">https://habr.com/ru/post/143413/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143406/index.html">We extort music from the contact. Geek way</a></li>
<li><a href="../143407/index.html">Differentiation of Google search for Russia, Ukraine and Belarus</a></li>
<li><a href="../143408/index.html">20 years of Wolfenstein 3D: shareware model in games</a></li>
<li><a href="../143410/index.html">Free we remove the limit of five people for closed BitBucket repositories</a></li>
<li><a href="../143411/index.html">Droider Show # 39. Galaxy S III and space miners</a></li>
<li><a href="../143416/index.html">Trend that changes everything</a></li>
<li><a href="../143417/index.html">May 7 in Tomsk or with the past Radio Day!</a></li>
<li><a href="../143418/index.html">Second Scala Conference in Petersburg</a></li>
<li><a href="../143419/index.html">UA Web Challenge 2012 Report</a></li>
<li><a href="../143420/index.html">Improved Youtube Stabilization</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>