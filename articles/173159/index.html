<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Network Virtualization in Hyper-V. Concept</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Windows Server 2012 , network virtualization technology (Network Virtualization, NV) has appeared, providing the possibility of virtualization at a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Network Virtualization in Hyper-V. Concept</h1><div class="post__text post__text-html js-mediator-article">  In <a href="http://technet.microsoft.com/ru-ru/evalcenter/hh670538.aspx">Windows Server 2012</a> , network virtualization technology (Network Virtualization, NV) has appeared, providing the possibility of virtualization at a fundamentally new level - the network segment level.  Unlike the usual server virtualization, NV will allow you to virtualize IP subnets and completely hide the real IP addressing used in your infrastructure from virtual machines (VMs) and applications inside the VM.  In this case, VMs can still interact with each other, with other physical hosts, with hosts on other subnets. <a name="habracut"></a><br><br>  From a technological point of view, network virtualization is a rather complicated mechanism, so it‚Äôs probably not possible to make a more or less complete overview of this technology in one post.  Today we will discuss the concept and architecture, in the next post I will focus on configuring NV, then we will talk separately about the organization of external access to VM running on a virtualized network. <br><br>  Let's start with the fundamental question: ‚ÄúWhat is network virtualization for?‚Äù 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  What is network virtualization for? </h1><br>  In the case of server virtualization with a few reservations, the OS inside the VM works as if it were installed on a physical server and was the only OS on this hardware.  Such an abstraction allows you to run several isolated instances of virtual servers on the same physical.  By analogy, network virtualization leads to the fact that a virtual network, or rather, in this context, a virtualized network, functions as if it were a physical network.  Accordingly, this level of virtualization allows you to create and use multiple virtual networks, possibly with overlapping or even completely coinciding IP address spaces, on the same physical network infrastructure.  And this network infrastructure, generally speaking, can include an arbitrary number of physical servers and network equipment (see the figure below). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/eb6/6ad/d29/eb66add29cac93126b76114c6861ae82.png" alt="image"><br><br>  In the above figure, virtual machines from the blue network and the red network belonging to different departments or organizations can use the same IP addresses, can be running on the same or different physical hosts, but on the one hand, they will be are completely isolated from each other, and, on the other hand, they will without any problems interact with other network objects (real or virtual) of their department or organization.  This implies the appointment of NV technology, the advantages and main scenarios of its application. <br><br>  <b>Greater flexibility in the placement of VMs within the data center</b> <br><br>  NV provides a certain freedom when deploying VMs within the data center.  In particular, VM placement involves setting up an IP address corresponding to the physical network segment, and setting up a VLAN to provide isolation.  Since NV allows coexistence on the same VM host with the same IP addresses, we are no longer bound by the IP addressing scheme used in the data center and do not rest on the restrictions imposed by the VLAN. <br><br>  <b>Simplified VM transfer to the cloud</b> <br><br>  Since when using network virtualization, the IP address and configuration of the VM remain unchanged, this greatly simplifies the process of transferring the VM to the neighboring organization's data center, to the hosting cloud or public cloud.  Both application clients and IT administrators continue to use their tools to interact with the VM / application without reconfiguration. <br><br>  <b>Live Migration out of subnet</b> <br><br>  VM dynamic migration is limited to the limits of an IP subnet (or VLAN).  If you migrate VMs to another subnet, you will need to reconfigure the IP inside the guest OS with all the ensuing consequences.  However, if live migration is performed between two hosts with Windows Server 2012 with NV enabled, then the hosts can be located in different segments of the physical network, while network virtualization will ensure the continuity of network communications of the roaming VM. <br><br>  <b>Increased utilization of physical hosts and networks</b> <br><br>  The lack of dependence on IP addressing and VLANs allows you to more evenly load physical hosts and more efficiently utilize available resources.  It should be noted that NV supports VLANs, and you can combine both isolation methods, for example, by isolating NV traffic in a dedicated VLAN for this purpose. <br><br><h1>  Hyper-V Network Virtualization Concept </h1><br>  When configuring NV, a pair of IP addresses is associated with each virtual network adapter (vNIC): <br><ul><li>  <b>Customer Address (Customer Address, CA)</b> .  The address configured by the customer inside the VM.  This address is visible for the VM and OS itself inside it, at this VM address is visible for the customer's infrastructure, this address does not change when the VM moves within the data center, or beyond it. <br></li><li>  <b>Provider Address (Provider Address, PA)</b> .  Address assigned by the data center administrator or hoster, based on the physical network infrastructure.  This address is used when sending packets over the network between Hyper-V hosts running VMs and NV technology configured.  This address is visible in the physical network segment, but not visible for the VM and the guest OS. <br></li></ul><br><br><img src="https://habrastorage.org/getpro/habr/post_images/95b/b1f/05c/95bb1f05c04954707dd4688781460119.png" alt="image"><br><br>  In the process of network interaction, the VM forms a packet with the sender and receiver addresses from the CA space.  Such a package leaves the VM and the Hyper-V host is packed into a package with the sender and recipient addresses from the PA space.  PA addresses are determined based on the virtualization policy table.  After that, the packet is transmitted over the physical network.  The Hyper-V host that received the packet, based on the same virtualization policy table, performs the reverse procedure: retrieves the source packet, determines the recipient VM, and redirects the source packet with the CA addresses of the desired VM. <br><br>  Thus, network virtualization ultimately boils down to virtualizing the addresses used by virtual machines.  In turn, address virtualization in Hyper-V Windows Server 2012 is possible using two mechanisms: Generic Routing Encapsulation and IP Rewrite.  Consider briefly each of them. <br><br><h3>  Generic Routing Encapsulation </h3><br>  In the first mechanism, the source packet with CA addresses is encapsulated into a GRE structure (Generic Routing Encapsulation, see <a href="http://tools.ietf.org/html/rfc2890">RFC 2890</a> ), which is packaged in an IP packet with the necessary PA addresses.  A unique virtual subnet identifier (Virtual Subnet ID, the ‚ÄúGRE key‚Äù field in the figure), which owns the source packet, and the MAC addresses of the sender's and recipient's virtual network adapters are also added to the GRE header. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/386/e6d/26b/386e6d26beb4a23f13b9dc729b69898f.png" alt="image"><br><br>  The subnet identifier allows the recipient host to correctly identify the VM for which the packet is intended, even if the CA addresses in the VM of different customers may coincide.  The second important feature of this mechanism is that, regardless of the number of VMs running on a VM host, one PA address is enough to transfer packets from any VMs.  This significantly affects the scalability of the solution when using the GRE mechanism of address virtualization.  Finally, it should be noted that the described scheme is fully compatible with the existing network equipment and does not require any updating of network adapters, switches or routers. <br><br>  However, in the future, it would not be superfluous that the switch or router could analyze the Virtual Subnet ID field of the packet, and the administrator could set the appropriate rules for switching or routing packets based on this field.  Or, for example, so that all tasks related to GRE unpacking take on the network adapter.  To this end, Microsoft, together with partners, developed the <a href="http://tools.ietf.org/html/draft-sridharan-virtualization-nvgre-00">NVGRE</a> standard ‚Äî Network Virtualization using Generic Routing Encapsulation, which is currently in the IETF Draft stage.  In particular, this standard regulates the 24-bit Tenant Network Identifier (TNI) field for storing the subnet identifier, protocol type 0x6558, indicating the NVGRE packet, and other nuances. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/57b/223/e71/57b223e71782ac6f213e4c2e064af117.png" alt="image"><br><br><h3>  IP Rewrite </h3><br>  The second mechanism is somewhat simpler in its ideology.  Each CA-address is assigned a unique PA-address.  When a packet leaves the VM, the Hyper-V host in the IP packet header replaces the CA addresses with PA addresses and sends the packet to the network.  The receiving host performs the return address replacement and delivers the VM packet.  As follows from the described algorithm, on each physical host with the Hyper-V role, it is necessary to configure as many PA addresses as the CA addresses are used in all virtual machines running on this host that use network virtualization. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b3b/e24/344/b3be243445af488bd69b908709042369.png" alt="image"><br><br>  Encapsulating packages with GRE requires additional overhead.  Therefore, for scenarios with high bandwidth requirements, for example, for VMs actively using a 10Gbps adapter, IP Rewrite is recommended as once.  For most other cases, the GRE mechanism is optimal.  Well, with the advent of equipment supporting NVGRE, this mechanism will not yield IP Rewrite in performance. <br><br><h3>  Customer Network and Virtual Subnet </h3><br>  In the terminology of Hyper-V Network Virtualization, the customer is the "owner" of the VM group deployed in the data center.  In practice, if we are talking about the data center of the hosting service provider, such a customer could be any company or organization.  If we are talking about a private cloud, then the customer, as a rule, is a department or division of the organization.  In any case, the customer can own one or several networks (Customer Network), and each such network consists of one or several virtual subnets (Virtual Subnet). <br><br>  <b>Customer Network</b> <br><ul><li>  The customer network defines the isolation boundary of the virtual machines.  In other words, VMs belonging to the same customer network can interact with each other.  As a result, virtual subnets belonging to the same customer network should not use intersecting IP address spaces. <br></li><li>  Each customer network is identified using a special Routing Domain ID (RDID), which is assigned by the data center administrator or management software, such as <a href="http://technet.microsoft.com/ru-ru/evalcenter/hh505660.aspx">System Center 2012 Virtual Machine Manager</a> .  RDID has a global identifier (GUID) format, for example {11111111-2222-3333-4444-000000000000}. <br></li></ul><br>  <b>Virtual subnet</b> <br><ul><li>  The virtual subnet uses the semantics of the IP subnet and thus defines the broadcast domain (broadcast domain) for the VM.  Virtual machines on the same virtual subnet must use the same IP perfix, that is, belong to the same IP subnet. <br></li><li>  Each virtual subnet belongs to one customer network (associated with one RDID) and is identified by the unique Virtual Subnet ID (VSID) already familiar to us.  VSID can take values ‚Äã‚Äãfrom 4096 to 2 ^ 24-2. <br></li></ul><br><br>  The use of these two concepts allows the customer to transfer their network topology to the cloud.  In fig.  Below are two Blue company networks - the R &amp; D network and the sales department network.  Initially, these networks are isolated and should not interact with each other.  Since these networks are assigned different RDIDs when migrating to Hyper-V Network Virtualization, the VMs of these networks cannot ‚Äúsee‚Äù each other.  In this case, for example, VMs from virtual subnets 1, 2, and 3 of the R &amp; D network can exchange packets. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0a7/75d/381/0a775d381f09663e183639df13b288ed.png" alt="image"><br><br><h1>  Hyper-V Network Virtualization Architecture </h1><br>  NV is only available in Windows Server 2012. <br><br>  On hosts with Hyper-V Network Virtualization, a virtualization policy must be maintained, which actually sets and stores information about CA and PA spaces, RDID and VSID, and the address virtualization mechanisms used.  Windows Server 2012 contains a set of software interfaces (APIs) with which the software can manage all aspects of NV.  In the simplest case, such control software can be PowerShell scripts; in an industrial scenario, System Center 2012 Virtual Machine Manager SP1 (VMM) performs this role.  I draw attention to the fact that it was with the release of SP1 in System Center 2012 appeared support for Windows Server 2012, and therefore NV. <br><br>  The settings specified in the virtualization policy are directly applied by the NDIS (Network Driver Interface Specification) filter driver, called Windows Network Virtualization (WNV).  The WNV filter is located below the Hyper-V Extensible Switch.  This means that the Hyper-V switch and all its extensions (if any) work with CA addresses and do not know anything about PA addresses.  However, VSIDs are available to the switch and extensions, so the Hyper-V Extensible Switch is able to distinguish, for example, CA addresses 10.0.0.5 belonging to different customers. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2df/7a9/1c6/2df7a91c69911420eb71a077dc93b3f4.png" alt="image"><br><br>  If network virtualization is enabled for the VM, then for the Hyper-V Extensible Switch ports to which the virtual network adapters of this VM are connected, the hypervisor includes access control lists (ACL).  Read more about ACL <a href="http://habrahabr.ru/company/microsoft/blog/159391/">here</a> .  The ACL indicates the VSID of the virtual subnet that owns the VM.  Any packets arriving at this switch port with a VSID other than the one specified in the ACL are ignored. <br><br>  Taking this logic into account, moving packages looks like this.  Outgoing from the VM packet through the port of Hyper-V Extensible Switch gets into the WNV filter, which analyzes the NV virtualization policy and applies the necessary operations to the packet (replacing the IP address or packing in GRE), after which the packet is sent to the network. <br><br>  On the receiving side, the incoming packet falls into the WNV filter, which analyzes the NV virtualization policy.  If the incoming packet is a GRE packet, the filter reads the VSID field from the GRE header, retrieves the original IP packet and sends it along with the VSID to that Hyper-V Extensible Switch port to which the vNIC of the virtual machine is connected with the CA address corresponding to the recipient in the header of the original IP packet.  If the transmitted VSID matches the VSID in the port's ACL, the switch sends the packet to the virtual machine.  If the virtualization mechanism used is IP rewrite, the filter changes the PA addresses in the packet to CA addresses based on the information from the virtualization policy, determines the VSID for the same pairs of PA and CA addresses and sends a packet with already CA addresses along with the VSID to the appropriate Hyper-V Extensible Switch port.  If the transmitted VSID matches the VSID in the port's ACL, the switch sends the packet to the virtual machine. <br><br>  The described logic applies when a packet is transferred between VMs located on the same or different hosts with Windows Server 2012 and the elevated Hyper-V role.  The situation is somewhat more complicated if a packet from a VM, in which, for example, a certain business application is running, must get to the workstation with the client part of this business application.  In this case, we will need to configure Hyper-V Network Virtualization Gateway, which we will discuss separately. <br><br>  In the next post I will explain how to configure NV using: 1) PowerShell scripts, 2) VMM. <br>  In the meantime, you can: <br><ul><li>  view network virtualization in action in the first module of the course " <a href="http://www.microsoftvirtualacademy.com/training-courses/windows-server-2012-part1-rus">New features of Windows Server 2012. Part 1. Virtualization, networks, storage</a> "; <br></li><li>  Learn more about Hyper-V Network Virtualization in the third module of the course ‚Äú <a href="http://www.microsoftvirtualacademy.com/training-courses/windows-server-2012-networking-rus">Windows Server 2012: Network Infrastructure</a> ‚Äù; <br></li><li>  Download the <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D34782">original presentation</a> (in English), the slides from which I used in this post, with a detailed description of the packet flow process in NV. <br></li></ul><br><br>  Hope the material was helpful. <br><br>  Thank! </div><p>Source: <a href="https://habr.com/ru/post/173159/">https://habr.com/ru/post/173159/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../173147/index.html">MapReduce for processing semistructured data in HDInsight</a></li>
<li><a href="../173149/index.html">IRIScan Mouse - mouse and scanner in one bottle</a></li>
<li><a href="../173151/index.html">Blocked by devblog.blackberry.com</a></li>
<li><a href="../173153/index.html">Simple configuration file editor for Yii</a></li>
<li><a href="../173157/index.html">Programming Arduino from the console, gentoo-way, nothing more</a></li>
<li><a href="../173161/index.html">Launcher 8 - WP8 Desktop on Android</a></li>
<li><a href="../173163/index.html">How I used Google Glass: the future, but with monthly updates (part 2)</a></li>
<li><a href="../173165/index.html">Spring replenishment of the Xperia line: Xperia SP and Xperia L smartphones</a></li>
<li><a href="../173167/index.html">Office of Kaspersky Lab in Novosibirsk</a></li>
<li><a href="../173171/index.html">Remove extra people from the video</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>