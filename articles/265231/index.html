<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use the official docker image of NGINX in InfoboxCloud: part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Over the past year, more than 100,000 images have become available in the Docker Hub, and images from the Docker Hub have been downloaded more than 30...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Use the official docker image of NGINX in InfoboxCloud: part 1</h1><div class="post__text post__text-html js-mediator-article">  Over the past year, more than 100,000 images have become available in the Docker Hub, and images from the Docker Hub have been downloaded more than 300 million times.  Of these, more than 20 million downloads occurred on 70 official Docker developer images, such as Oracle, CentOS, and NGINX. <br><br>  NGINX is used on more than 40% of the largest sites in the world, not only as a web server, but also as a reverse proxy server, load balancer and HTTP cache.  The official NGINX image has been downloaded 3.4 million times. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/367/5e3/329/3675e3329e95abf27fcf422ccbedc186.png" width="400">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article you will learn: <br><ul><li>  how to deploy and use a docker image with nginx. </li><li>  how to quickly deploy reverse proxy on NGINX and several sites in Docker </li><li>  how to deploy a geographically distributed installation consisting of several sites and reverse proxy in each of the 3 regions of InfoboxCloud. </li></ul><br>  If you have not used Docker before, it is recommended to read: <br>  <a href="https://infoboxcloud.ru/community/blog/iaas/149.html">We use Docker and do not worry about vendor-lock</a> <br>  <a href="https://infoboxcloud.ru/community/blog/iaas/200.html">Dive into Docker: Dockerfile and communication between containers</a> <br>  <a href="https://infoboxcloud.ru/community/blog/iaas/306.html">Overview of Docker Engine from 1.0 to 1.8.</a>  <a href="https://infoboxcloud.ru/community/blog/iaas/306.html">Introduction to Docker Compose</a> <br><br>  At the end of the article, we distribute trial versions of <a href="https://infoboxcloud.ru/">InfoboxCloud</a> for free. <br><a name="habracut"></a><br><h4>  <b>Environment preparation</b> </h4><br>  1. Create a server with CentOS 7 to install Docker in <a href="http://infoboxcloud.ru/">InfoboxCloud</a> .  A virtual machine is now needed for Docker to work, so when creating a server, be sure to check the <a href="https://infoboxcloud.ru/community/blog/iaas/220.html">‚ÄúAllow OS kernel management‚Äù</a> box. <br><br><div class="spoiler">  <b class="spoiler_title">How to create a server in InfoboxCloud for Docker</b> <div class="spoiler_text">  If you do not have access to InfoboxCloud - <a href="http://infoboxcloud.ru/">order it</a> . <br><br>  After registration, you will receive data to access the control panel by email.  Enter the control panel at: <a href="https://panel.infobox.ru/">https://panel.infobox.ru</a> <br><br>  In the ‚ÄúCloud Infrastructure‚Äù section of your subscription, click ‚ÄúNew Server‚Äù (if necessary, the subscription changes in the upper right corner in the drop-down menu). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/310/42e/72e/31042e72ee98602ef330beac537f88b6.jpg" width="700"><br><br>  Set the required server parameters.  Be sure to allocate a public IP address to the server and check the box <strong>‚ÄúAllow OS kernel management‚Äù</strong> , as shown in the screenshot below. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a6c/113/e13/a6c113e13c98ed44173c0bcced54ef59.jpg" width="700"><br><br>  In the list of available operating systems, select CentOS 7 and complete server creation. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/25f/e37/954/25fe379543a3934d634af1dc6d8c423c.jpg" width="400"><br><br>  After that, the data to access the server will come to your email. <br></div></div><br>  After creating a server with CentOS 7, connect to it <a href="https://infoboxcloud.ru/community/blog/linuxvps/304.html">via SSH</a> . <br><br>  We have prepared a script that will allow you to install Docker and useful utilities for working with Docker on such a server.  The necessary settings will be made automatically. <br><br>  Run the command to install Docker and Compose: <br><pre><code class="bash hljs">bash &lt;(curl -s http://repository.sandbox.infoboxcloud.ru/scripts/docker/centos7/install.sh)</code> </pre> <br>  After that, docker and compose will be installed.  You can create an image with the docker installed in <a href="https://panel.infobox.ru/">the control panel by</a> clicking on the server and then ‚ÄúCreate an image‚Äù. <br><br>  After that, it will be possible to create new servers from the Docker image and not to perform this step again. <br><br><h4>  <b>Creating a portable environment</b> </h4><br>  Our portable environment consists of: <br><ul><li>  <strong>Dockerfile</strong> - a file describing the process of building a container </li><li>  <strong>docker-compose.yml</strong> - a file describing the process of launching a container or set of containers </li><li>  <strong>site files in the html directory</strong> </li><li>  <strong>nginx configuration files</strong> in the conf directory </li></ul><br>  It is better to keep the portable environment in the repository for example on github, when updating the site or configuration files to rebuild the container.  This will ensure that, if necessary, you can redeploy a customized site in minutes.  You can also quickly raise the site in a separate container for development. <br><br>  To work with git, install it on the server. <br><pre> <code class="bash hljs">yum install -y git</code> </pre><br>  Copy our simple portable environment from github with the command: <br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/InfoboxHosting/DockerNginxSimpleStaticSite.git</code> </pre><br>  Go to the environment directory with the command: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> DockerNginxSimpleStaticSite/</code> </pre><br>  Build a Docker image with the command <br><pre> <code class="bash hljs">docker-compose build</code> </pre><br>  Deploy the image to the container with the command <br><pre> <code class="bash hljs">docker-compose up -d</code> </pre><br>  Try to access the server by IP.  The pre-configured static site was successfully deployed. <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/fbd2ab.jpg" width="400"><br><br>  If you run <pre> <code class="bash hljs">docker ps</code> </pre>  You can see the site in the list of containers. <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/5eac3d.jpg" width="800"><br><br>  Let's see what the portable environment consists of. <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/b61136.jpg" width="500"><br><br>  The nginx configuration is in the <strong>conf / nginx.conf</strong> file: <br><div class="spoiler">  <b class="spoiler_title">nginx.conf</b> <div class="spoiler_text"><pre> <code class="xml hljs">user www-data; worker_processes 1; pid /run/nginx.pid; events { worker_connections 4086; use epoll; multi_accept on; } http { sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; keepalive_requests 1000; types_hash_max_size 2048; include /etc/nginx/mime.types; default_type application/octet-stream; access_log /var/log/nginx/access.log; error_log /var/log/nginx/error.log; gzip on; gzip_min_length 10240; gzip_proxied expired no-cache no-store private auth; gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml; gzip_disable "msie6"; include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; server { listen 80; server_name domain.tld www.domain.tld; location / { root /usr/share/nginx/html; } } }</code> </pre><br></div></div><br>  where <strong>domain.tld</strong> needs to be replaced with the domain of your site. <br><br>  The web server configuration for the site is stored in a portable environment, so that during deployment you do not need to reconfigure the web server every time. <br><br>  At the root of the portable environment is the <strong>Dockerfile</strong> , which uses the official NGINX image and adds your website from the <strong>html</strong> folder and the NGINX configuration from the <strong>conf</strong> folder to it. <br><br><pre> <code class="xml hljs">FROM nginx MAINTAINER Yuri Trukhin "trukhinyuri@infoboxcloud.com" COPY conf/nginx.conf /etc/nginx/nginx.conf COPY html/ /usr/share/nginx/html</code> </pre><br><br>  More details about the <strong>Dockerfile</strong> were covered <a href="https://infoboxcloud.ru/community/blog/iaas/200.html">in this article</a> . <br><br>  Also in the root of the portable environment folder, create a file <strong>docker-compose.yml</strong> with the following contents: <br><pre> <code class="xml hljs">sitename: build: . ports: - 80:80 restart: always</code> </pre><br>  It says that you need to expand the <strong>sitename</strong> environment, first building it from a <strong>Dockerfile</strong> in the same directory.  Port 80 of the container must be forwarded to port 80 of the host.  If NGINX is dropped, restart it. <br><br>  More information about Compose was covered <a href="https://infoboxcloud.ru/community/blog/iaas/306.html">in this article</a> . <br>  If you change the site or nginx configuration file - just rebuild the image with the command <br><pre> <code class="bash hljs">docker-compose build</code> </pre><br>  And then expand the image into a container: <br><pre> <code class="bash hljs">docker-compose up -d</code> </pre><br><br>  We do not need to worry about server setup every time.  Once developed, a portable environment with Docker allows you to quickly deploy. <br><br>  To perform the recommendations in the following section, stop and remove the expanded container, since  it takes port 80 on the host we need. <br><br>  To do this, run: <br><pre> <code class="bash hljs">docker ps</code> </pre><br>  Copy to clipboard container_id. <br>  Stop the container with the command: <br><pre> <code class="bash hljs">docker stop bc88ee61a933</code> </pre><br>  where instead of bc88ee61a933 insert your container_id. <br>  Remove container: <br><pre> <code class="bash hljs">docker rm bc88ee61a933</code> </pre><br>  where instead of bc88ee61a933 insert your container_id. <br><br><h4>  <b>Deploy multiple sites with reverse proxy</b> </h4><br>  In this section, we will deploy several static sites with different domains and reverse proxy.  To complete this part of the article, you will need to send your DNS domains to the ip ‚Äì address of the server: <br><ul><li>  <strong>The domain1.tld</strong> must be sent to the dedicated public IP address of your server.  domain1.tld is the domain of the first site. </li><li>  <strong>And the domain2.tld record must</strong> be sent to the dedicated public IP address of your server.  domain2.tld is the domain of the second site. </li></ul><br>  The necessary ip ‚Äì addresses can be found in <a href="https://panel.infobox.ru/">the</a> InfoboxCloud <a href="https://panel.infobox.ru/">control</a> panel. <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/d6b7bb.jpg" width="800"><br><br><div class="spoiler">  <b class="spoiler_title">What if you do not have domains</b> <div class="spoiler_text"><h5>  <b>Option 1. Configure hosts</b> </h5><br>  This option is great for testing, but will only work from your computer. <br><br>  <strong>Add domain records to your computer‚Äôs hosts file</strong> . <br>  In OS X and Linux, you can add entries to the <strong>/ etc / hosts file</strong> . <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/662f23.jpg" width="300"><br><br>  On Windows, you need to run Notepad as an administrator.  To do this, enter Notepad or Notepad (in the Russian version of Windows) in the search field and select the launch item as an administrator. <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/716718.jpg" width="400"><br><br>  Open the file <strong>C: \ Windows \ System32 \ drivers \ etc \ hosts</strong> .  If it will not be visible in Notepad, select the ‚ÄúAll files‚Äù file type next to the ‚ÄúOpen‚Äù button. <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/e409ee.jpg" width="800"><br><br>  Add the necessary entries and save the changes.  Do not forget to use the addresses of your server from <a href="https://panel.infobox.ru/">the control panel</a> as ip-addresses. <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/2828da.jpg" width="800"><br><br>  After the tests, do not forget to remove these entries from the hosts file. <br><br><h5>  Option 2. Purchase the required domains </h5><br>  For example, this can be <a href="http://infobox.ru/domains/">done here</a> . <br></div></div><br><br>  Now connect to the server with Docker in InfoboxCloud over SSH. <br>  Clone a prepared repository for 2 sites with a load balancer. <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~</code> </pre><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/InfoboxHosting/DockerNginxSimpleBalancer.git</code> </pre><br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/1cda85.jpg" width="500"><br><br>  Go to the directory of the portable balancer environment: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/DockerNginxSimpleBalancer/balancer</code> </pre><br>  Run the build of balancer and dependent images with one command: <br><pre> <code class="bash hljs">docker-compose build</code> </pre><br>  Deploy the balancer and dependent images: <br><pre> <code class="bash hljs">docker-compose up -d</code> </pre><br>  <em>Note: docker-compose.yml files in the folders of each of the frontends in this example are not used.</em> <br><br>  Open in the browser the domain of the first site: <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/e56e42.jpg" width="400"><br><br>  Now check that the second site opens correctly: <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/4dc888.jpg" width="400"><br><br>  In order for sites to open not with the specified domain1.com and domain2.com in your <strong>/ etc / hosts</strong> , you need to correct the file <strong>~ / DockerNginxSimpleBalancer / balancer / conf / nginx.conf</strong> : <br><br><div class="spoiler">  <b class="spoiler_title">nginx.conf</b> <div class="spoiler_text"><pre> <code class="xml hljs">user www-data; worker_processes 1; pid /run/nginx.pid; events { worker_connections 4086; use epoll; multi_accept on; } http { sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; keepalive_requests 1000; types_hash_max_size 2048; include /etc/nginx/mime.types; default_type application/octet-stream; access_log /var/log/nginx/access.log; error_log /var/log/nginx/error.log; gzip on; gzip_min_length 10240; gzip_proxied expired no-cache no-store private auth; gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml; gzip_disable "msie6"; include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; server { listen 80; server_name domain1.com www.domain1.com; location / { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://frontend1:80; } } server { listen 80; server_name domain2.com www.domain2.com; location / { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://frontend2:80; } } }</code> </pre><br></div></div><br>  Replace domain1.com and domain2.com with the addresses of your sites, rebuild the image and re-expand the container: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/DockerNginxSimpleBalancer/balancer</code> </pre><br><pre> <code class="bash hljs">docker-compose build</code> </pre><br><pre> <code class="bash hljs">docker-compose up -d</code> </pre><br><br><h4>  <b>Deploy multiple geo-distributed sites</b> </h4><br>  Create a server with a docker in each of the InfoboxCloud regions: Moscow, St. Petersburg, Amsterdam as shown in the ‚ÄúPreparing the environment‚Äù section and install it with the git command: <br><pre> <code class="bash hljs">yum install -y git</code> </pre><br><div class="spoiler">  <b class="spoiler_title">How to connect additional regions of the cloud</b> <div class="spoiler_text">  In <a href="https://panel.infobox.ru/">the control panel</a> go to the main page and click "Order a new service." <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/630843.jpg" width="800"><br><br>  Select the "Cloud Servers" service. <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/ad7fd1.jpg" width="400"><br><br>  Select the desired region and complete the order process to the end. <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/c1fd00.jpg"><br><br>  Connection of additional regions is free, but it is required that the account be more than 500 rubles. <br></div></div><br>  You can switch between regions in the upper right corner of the control panel in the drop-down menu. <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/d6a861.jpg" width="800"><br><br>  To complete this part of the article, you will need to send your DNS domains to the ip ‚Äì address of the server: <br><ul><li>  <strong>3 A records for your domain of the first site</strong> , each of which will point to a server in Moscow, Amsterdam and St. Petersburg, respectively. </li><li>  <strong>3 A records for your second site domain</strong> , each of which will point to a server in Moscow, Amsterdam and St. Petersburg, respectively. </li><li>  A record type <strong>spb.</strong>  domain.com, <strong>pointing to a server in St. Petersburg</strong> .  Instead of domain.com you need to use your service domain. </li><li>  A record type <strong>msk.</strong>  domain.com, <strong>pointing to a server in Moscow</strong> .  Instead of domain.com you need to use your service domain. </li><li>  A record type <strong>ams.</strong>  domain.com <strong>pointing to a server in Amsterdam</strong> .  Instead of domain.com you need to use your service domain. </li></ul><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/0d67f2.jpg" width="800"><br><br>  The necessary ip ‚Äì addresses can be found in <a href="https://panel.infobox.ru/">the</a> InfoboxCloud <a href="https://panel.infobox.ru/">control</a> panel. <br><br>  Save the prepared portable environments to each of the servers: <br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/InfoboxHosting/DockerNginxGeoRedundantBalancer.git</code> </pre><br><br>  On each server, edit the file <strong>~ / DockerNginxGeoRedundantBalancer / balancer / conf / nginx.conf</strong> and replace <strong>domain1.com</strong> with the domain name of the first site, <strong>domain2.com</strong> with the domain name of the second site, <strong>domain.com</strong> with the service domain. <br><br>  Instead of manual renaming, you can run the command <strong>on each of the servers</strong> : <br><pre> <code class="bash hljs">bash ~/DockerNginxGeoRedundantBalancer/rename.sh domain.com domain1.com domain2.com</code> </pre><br>  in which instead of domain.com specify the name of the service domain, instead of domain1.com is the name of the first site, domain2.com is the name of the second site. <br><br><div class="spoiler">  <b class="spoiler_title">Original nginx.conf</b> <div class="spoiler_text"><pre> <code class="xml hljs">user www-data; worker_processes 1; pid /run/nginx.pid; events { worker_connections 4086; use epoll; multi_accept on; } http { sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; keepalive_requests 1000; types_hash_max_size 2048; include /etc/nginx/mime.types; default_type application/octet-stream; access_log /var/log/nginx/access.log; error_log /var/log/nginx/error.log; gzip on; gzip_min_length 10240; gzip_proxied expired no-cache no-store private auth; gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml; gzip_disable "msie6"; include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; upstream frontend1 { #!!!replace domain.com #!!!remove backup word in your location server spb.domain.com:8000 backup; server msk.domain.com:8000 backup; server ams.domain.com:8000 backup; } upstream frontend2 { #!!!replace domain.com #!!!remove backup word in your location server spb.domain.com:8001 backup; server msk.domain.com:8001 backup; server ams.domain.com:8001 backup; } server { listen 80; #!!!replace domain1.com server_name domain1.com www.domain1.com; location / { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://frontend1; } } server { listen 80; #!!!replace domain2.com server_name domain2.com www.domain2.com; location / { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://frontend2; } } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">nginx.conf after making changes for Amsterdam</b> <div class="spoiler_text"><pre> <code class="xml hljs">user www-data; worker_processes 1; pid /run/nginx.pid; events { worker_connections 4086; use epoll; multi_accept on; } http { sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; keepalive_requests 1000; types_hash_max_size 2048; include /etc/nginx/mime.types; default_type application/octet-stream; access_log /var/log/nginx/access.log; error_log /var/log/nginx/error.log; gzip on; gzip_min_length 10240; gzip_proxied expired no-cache no-store private auth; gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml; gzip_disable "msie6"; include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; upstream frontend1 { #!!!replace domain.com server spb.plugndo.com:8000 backup; server msk.plugndo.com:8000 backup; server ams.plugndo.com:8000; } upstream frontend2 { #!!!replace domain.com server spb.plugndo.com:8001 backup; server msk.plugndo.com:8001 backup; server ams.plugndo.com:8001; } server { listen 80; #!!!replace domain1.com server_name site1.plugndo.com www.site1.plugndo.com; location / { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://frontend1; } } server { listen 80; #!!!replace domain1.com server_name site2.plugndo.com www.site2.plugndo.com; location / { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://frontend2; } } }</code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">nginx.conf after making changes for St. Petersburg</b> <div class="spoiler_text"><pre> <code class="bash hljs">user www-data; worker_processes 1; pid /run/nginx.pid; events { worker_connections 4086; use epoll; multi_accept on; } http { sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; keepalive_requests 1000; types_hash_max_size 2048; include /etc/nginx/mime.types; default_type application/octet-stream; access_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/access.log; error_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/error.log; gzip on; gzip_min_length 10240; gzip_proxied expired no-cache no-store private auth; gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml; gzip_disable <span class="hljs-string"><span class="hljs-string">"msie6"</span></span>; include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; upstream frontend1 { <span class="hljs-comment"><span class="hljs-comment">#!!!replace domain.com server spb.plugndo.com:8000; server msk.plugndo.com:8000 backup; server ams.plugndo.com:8000 backup; } upstream frontend2 { #!!!replace domain.com server spb.plugndo.com:8001; server msk.plugndo.com:8001 backup; server ams.plugndo.com:8001 backup; } server { listen 80; #!!!replace domain1.com server_name site1.plugndo.com www.site1.plugndo.com; location / { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://frontend1; } } server { listen 80; #!!!replace domain1.com server_name site2.plugndo.com www.site2.plugndo.com; location / { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://frontend2; } } }</span></span></code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">nginx.conf after making changes for Moscow</b> <div class="spoiler_text"><pre> <code class="bash hljs">user www-data; worker_processes 1; pid /run/nginx.pid; events { worker_connections 4086; use epoll; multi_accept on; } http { sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; keepalive_requests 1000; types_hash_max_size 2048; include /etc/nginx/mime.types; default_type application/octet-stream; access_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/access.log; error_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx/error.log; gzip on; gzip_min_length 10240; gzip_proxied expired no-cache no-store private auth; gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml; gzip_disable <span class="hljs-string"><span class="hljs-string">"msie6"</span></span>; include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; upstream frontend1 { <span class="hljs-comment"><span class="hljs-comment">#!!!replace domain.com server spb.plugndo.com:8000 backup; server msk.plugndo.com:8000; server ams.plugndo.com:8000 backup; } upstream frontend2 { #!!!replace domain.com server spb.plugndo.com:8001 backup; server msk.plugndo.com:8001; server ams.plugndo.com:8001 backup; } server { listen 80; #!!!replace domain1.com server_name site1.plugndo.com www.site1.plugndo.com; location / { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://frontend1; } } server { listen 80; #!!!replace domain1.com server_name site2.plugndo.com www.site2.plugndo.com; location / { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://frontend2; } } }</span></span></code> </pre><br></div></div><br>  Now for Moscow, go to the appropriate folder: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> DockerNginxGeoRedundantBalancer/balancerMSK/</code> </pre><br>  For Amsterdam, browse to the appropriate folder: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> DockerNginxGeoRedundantBalancer/balancerAMS/</code> </pre><br>  For St. Petersburg: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> DockerNginxGeoRedundantBalancer/balancerSPB/</code> </pre><br><br>  On each of the servers, run the commands <br><pre> <code class="bash hljs">docker-compose build</code> </pre><br>  and <br><pre> <code class="bash hljs">docker-compose up -d</code> </pre><br><br>  Now you can go to each of the sites and check their availability: <br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/cf797b.jpg" width="400"><br><br><img src="https://infoboxcloud.ru/community/uploads/images/00/00/01/2015/08/21/65a827.jpg" width="400"><br><br>  Now from the control panel, turn off the server in any of the regions.  Sites are still available. <br>  Shut down the server in the second region.  Sites are still available. <br><br>  While at least one server is available, the sites will work.  If the request is on a server that is down, all modern browsers attempt to send a request to another server from DNS.  As a result, in a few seconds the site will open. <br><br>  You can make the process of deploying servers and sites in several regions fully automatic using Ansible. <br>  <a href="https://infoboxcloud.ru/community/blog/iaas/226.html">Part 1</a> . <br>  <a href="https://infoboxcloud.ru/community/blog/iaas/236.html">Part 2</a> . <br>  <a href="https://infoboxcloud.ru/community/blog/iaas/242.html">Part 3</a> <br>  <a href="https://infoboxcloud.ru/community/blog/iaas/244.html">Part 4</a> <br>  <a href="https://infoboxcloud.ru/community/blog/iaas/246.html">Part 5</a> . <br><br><h4>  <b>How to get a trial version of InfoboxCloud for free?</b> </h4><br>  <a href="">Send us</a> your email address and full name to <a href="http://trukhinyuri%40infoboxcloud.com/">trukhinyuri@infoboxcloud.com</a> , in response you will receive data to access the control panel.  You can test the new cloud region for 15 days, then you can go to the full version of the cloud.  You can request a free trial version before September 5, 2015. <br><br>  If you have questions or comments, <a href="">write to us</a> and we will be happy to answer. <br><br>  If you can not leave comments on Habr√©, write to us in the <a href="https://infoboxcloud.ru/community/blog/iaas/320.html">Community</a> . <br><br>  Successful use of NGINX and Docker in <a href="http://infoboxcloud.ru/">InfoboxCloud</a> ! </div><p>Source: <a href="https://habr.com/ru/post/265231/">https://habr.com/ru/post/265231/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265217/index.html">The development of dials for Android Wear - it's easier than it seems</a></li>
<li><a href="../265219/index.html">Security Week 34: Nobody Patches Colonel</a></li>
<li><a href="../265225/index.html">Local network organization with simultaneous connection to two Internet providers using MikroTik router</a></li>
<li><a href="../265227/index.html">Bypass authorization via social networks when connecting to public Wi-Fi</a></li>
<li><a href="../265229/index.html">What is ITIL and what does it eat?</a></li>
<li><a href="../265233/index.html">Study: Vulnerabilities of a cryptotransponder allow keyless entry of over 100 models of machines.</a></li>
<li><a href="../265235/index.html">Sony PlayStation 4 security analysis</a></li>
<li><a href="../265239/index.html">How to sue a captured domain if you are not a company</a></li>
<li><a href="../265243/index.html">Microconference UX-Environment ‚Ññ24: Long-reads and modern tools of publishing</a></li>
<li><a href="../265245/index.html">Creating shortcodes in WordPress CMS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>