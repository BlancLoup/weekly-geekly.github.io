<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New interface for getting process attributes in Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In developing CRIU, we realized that the current interface for obtaining information about processes is not perfect. In addition, a similar problem wa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New interface for getting process attributes in Linux</h1><div class="post__text post__text-html js-mediator-article">  In developing CRIU, we realized that the current interface for obtaining information about processes is not perfect.  In addition, a similar problem was successfully solved for sockets.  We tried to transfer these developments to the processes and got quite good results, which you will learn about by reading this article to the end. <br><br><h1>  Disadvantages of the current interface </h1><br>  After reading the title, the question arises: "And what did the old interface not please"?  Many of you know that now information about processes is collected on the <i>procfs</i> file system.  Here, each process corresponds to a directory that contains several dozen files. <br><br><pre><code class="hljs perl">$ ls /proc/self/ attr cwd loginuid numa_maps schedstat task autogroup environ map_files oom_adj sessionid timers auxv exe maps oom_score setgroups uid_map cgroup fd mem oom_score_adj smaps wchan clear_refs fdinfo mountinfo pagemap stack cmdline gid_map mounts personality <span class="hljs-keyword"><span class="hljs-keyword">stat</span></span> comm io mountstats projid_map statm coredump_filter latency net root status cpuset limits ns sched <span class="hljs-keyword"><span class="hljs-keyword">syscall</span></span></code> </pre> <br><a name="habracut"></a><br>  Each file contains a number of attributes.  The first problem is that we have to read at least one file for each process, i.e.  make three system calls.  If you need to collect data on hundreds of thousands of processes, it can take a long time even on a powerful machine.  Some people may recall that the ps or top utility runs slowly on loaded machines. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The second problem is related to how the properties of the processes are divided into files.  We have a good example that shows that the current partition is not very good.  In CRIU there is a task to obtain data on all regions of the process memory.  If we look in the / proc / PID / maps file, we will find that it does not contain the flags that are needed to recover the memory regions.  Fortunately, there is another file - / proc / PID / smaps, which contains the necessary information, as well as statistics on the spent physical memory (which we do not need).  A simple experiment shows that the formation of the first file takes an order of magnitude less time. <br><br><pre> <code class="hljs pgsql">$ <span class="hljs-type"><span class="hljs-type">time</span></span> cat /proc<span class="hljs-comment"><span class="hljs-comment">/*/maps &gt; /dev/null real 0m0.061s user 0m0.002s sys 0m0.059s $ time cat /proc/*/</span></span>smaps &gt; /dev/<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> <span class="hljs-type"><span class="hljs-type">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.253</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.004</span></span>s sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.247</span></span>s</code> </pre><br><br>  Probably, you already guessed that the statistics of memory consumption is to blame - it takes most of the time to collect it. <br><br>  The third problem can be seen in the file format.  Firstly, there is no uniform format.  Secondly, the format of some files cannot be expanded in principle (for this reason we cannot add a field with flags in / proc / PID / maps).  Thirdly, many text files that are easily readable by humans.  This is convenient when you want to look at one process.  However, when there is a task to analyze thousands of processes, then you will not view them with your eyes, but write some code.  Disassembling files of different formats is not the most pleasant pastime.  The binary format is usually more convenient for processing in the program code, and its generation often requires less resources. <br><br><h1>  Interface for obtaining information about sockets <i>socket-diag</i> </h1><br>  When we started doing CRIU, there was a problem with getting information about sockets.  For most types of sockets, as usual, the files in / proc (/ proc / net / unix, / proc / net / netlink, etc.) were used, which contain a rather limited set of parameters.  For INET sockets, there was a netlink interface, which presented information in binary form and in an easily expandable format.  This interface was able to generalize to all types of sockets. <br>  It works as follows.  First, a query is formed that specifies a set of parameter groups and a set of sockets for which they are required.  At the output we get the required data, divided into messages.  One message describes one socket.  All parameters are divided into groups, which can be quite small, as they bear the overhead of only the size of the message.  Each group is described by type and size.  At the same time, we have the opportunity to expand existing groups or add new ones. <br><br><h1>  New interface for getting process attributes task-diag </h1><br>  When we saw problems with obtaining data about processes, an analogy with sockets immediately came, and the idea arose to use the same interface for processes. <br><br>  All attributes must be divided into groups.  There is one important rule here: no attribute should have a noticeable effect on the time required to generate all attributes in a group.  Remember, I was talking about / proc / PID / smaps?  In the new interface, we brought this statistics into a separate group. <br><br>  At the first stage we did not set the task to cover all the attributes.  I wanted to understand how comfortable the new interface is.  Therefore, we decided to make the interface sufficient for the needs of CRIU.  The result is the following set of attribute groups: <br><pre> <code class="hljs objectivec"> TASK_DIAG_BASE <span class="hljs-comment"><span class="hljs-comment">/*   pid, tid, sig, pgid, comm */</span></span> TASK_DIAG_CRED, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> TASK_DIAG_STAT, <span class="hljs-comment"><span class="hljs-comment">/*  ,   taskstats  */</span></span> TASK_DIAG_VMA, <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> TASK_DIAG_VMA_STAT, <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> TASK_DIAG_PID = <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> TASK_DIAG_TGID, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span></code> </pre><br><br>  In fact, here is the current version of the division into groups.  In particular, we see here TASK_DIAG_STAT, which appeared in the second version as part of the integration of the interface with the already existing taskstats, built on the basis of netlink sockets.  The latter uses the netlink protocol and has a number of known issues that we will address in this article. <br><br>  And a couple of words about how a group of processes about which information is needed is defined. <br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TASK_DIAG_DUMP_ALL 0 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*     */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TASK_DIAG_DUMP_ALL_THREAD 1 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*      */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TASK_DIAG_DUMP_CHILDREN 2 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*      */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TASK_DIAG_DUMP_THREAD 3 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*      */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TASK_DIAG_DUMP_ONE 4 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*     */</span></span></span></span></code> </pre><br><br>  In the process of implementation, several questions arose.  The interface should be accessible to normal users, i.e.  we needed to save access rights somewhere.  The second question is where do you get the link to the process namespace (pidns)? <br><br>  Let's start with the second.  We use the netlink interface, which is based on sockets and is used primarily in the network subsystem.  The link to the network namespace is taken from the socket.  In our case, the link needs to be taken to the process namespace.  After reading a bit of the kernel code, it turned out that each message contains information about the sender (SCM_CREDENTIALS).  It contains the process ID, which allows us to take a link to the process namespace from the sender.  This goes against the network namespace, since  the socket is bound to the namespace in which it was created.  Taking the link to pidns from the process that requested the information is probably permissible, and we also have the opportunity to set the name we need, since  sender information can be set at the sending stage. <br><br>  The first problem turned out to be much more interesting, although we could not understand its details for a long time.  Linux file descriptors have one feature.  We can open the file and lower its privileges, while the file descriptor will remain fully functional.  The same is true for netlink sockets to some extent, but there is a problem that Andy Lutomirski has pointed out to me (Andy Lutomirski).  It lies in the fact that we are not able to specify exactly what this socket will be used for.  That is, if we have an application that creates a netlink socket and then lowers its privileges, then this application will be able to use the socket for any functionality that is available for netlink sockets.  In other words, lowering privileges does not affect the netlink socket.  When we add new functionality to netlink sockets, we open up new possibilities for applications that use them, which is a serious security problem. <br><br>  There were other suggestions about the interface.  In particular, the idea was to add a new system call.  But I didn't like it very much, because  There may be too much data to write them all in one buffer.  A file descriptor implies subtraction of data in chunks, which, in my opinion, looks more reasonable. <br><br>  There was also a proposal to make a transactional file in the procfs file system.  The idea is similar to what we did for netlink sockets.  Open the file, write the request, read the answer.  It is on this idea that we stopped, as in the working version for the next version. <br><br><h1>  A few words about performance </h1><br>  The first version did not cause much discussion, but it helped to find another group of people interested in a new, faster interface for obtaining process properties.  One evening I shared my work with Pavel Odintsov (@pavelodintsov), and he said that he recently had problems with the perf, and they were also connected with the speed of collecting the attributes of processes.  That's how he brought us together with David Ahern (David Ahern), who made a considerable contribution to the development of the interface.  He also proved by another example that this work is needed not only for us. <br><br>  Performance comparison can be started with a simple example.  Suppose that we need for all processes to get the session number, groups and other parameters from the files / proc / pid / stat. <br><br>  For a fair comparison, we will write a small program that will read out / proc / PID / status for each process.  Below we will see that it is faster than the ps utility. <br><br><pre> <code class="hljs perl"> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((de = <span class="hljs-keyword"><span class="hljs-keyword">readdir</span></span>(d))) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (de-&gt;d_name[<span class="hljs-number"><span class="hljs-number">0</span></span>] &lt; <span class="hljs-string"><span class="hljs-string">'0'</span></span> || de-&gt;d_name[<span class="hljs-number"><span class="hljs-number">0</span></span>] &gt; <span class="hljs-string"><span class="hljs-string">'9'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; snprintf(buf, sizeof(buf), <span class="hljs-string"><span class="hljs-string">"/proc/%s/stat"</span></span>, de-&gt;d_name); fd = <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(buf, O_RDONLY); <span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(fd, buf, sizeof(buf)); <span class="hljs-keyword"><span class="hljs-keyword">close</span></span>(fd); tasks++; }</code> </pre><br><br>  The program for task-diag is more voluminous.  It can be found in my repository in the tools / testing / selftests / task_diag / directory. <br><br><pre> <code class="hljs go">$ ps a -o pid,ppid,pgid,sid,comm | wc -l <span class="hljs-number"><span class="hljs-number">50006</span></span> $ time ps a -o pid,ppid,pgid,sid,comm &gt; /dev/null <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m1<span class="hljs-number"><span class="hljs-number">.256s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.367s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.871s</span></span> $ time ./task_proc_all a tasks: <span class="hljs-number"><span class="hljs-number">50085</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.279s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.013s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.255s</span></span> $ time ./task_diag_all a <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.051s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.001s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.049s</span></span></code> </pre><br><br>  Even on such a simple example, it is clear that task_diag runs several times faster.  The ps utility is slower as it reads more files per process. <br><br>  Let's see what the pref trace --summary shows for both options. <br><br><pre> <code class="hljs perl">$ perf trace --summary ./task_proc_all a tasks: <span class="hljs-number"><span class="hljs-number">50086</span></span> Summary of events: task_proc_all (<span class="hljs-number"><span class="hljs-number">72414</span></span>), <span class="hljs-number"><span class="hljs-number">300753</span></span> events, <span class="hljs-number"><span class="hljs-number">100.0</span></span>%, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">000</span></span> msec <span class="hljs-keyword"><span class="hljs-keyword">syscall</span></span> calls min avg max stddev (msec) (msec) (msec) (%) --------------- -------- --------- --------- --------- ------ <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-number"><span class="hljs-number">50091</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">005</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">925</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">40</span></span>% <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">011</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">011</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">011</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-number"><span class="hljs-number">50092</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">004</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">992</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">49</span></span>% <span class="hljs-keyword"><span class="hljs-keyword">close</span></span> <span class="hljs-number"><span class="hljs-number">50093</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">061</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">15</span></span>% fstat <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>8 <span class="hljs-number"><span class="hljs-number">25.95</span></span>% mmap <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">006</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">026</span></span> <span class="hljs-number"><span class="hljs-number">19.70</span></span>% mprotect <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">006</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">010</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">020</span></span> <span class="hljs-number"><span class="hljs-number">13.28</span></span>% munmap <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">012</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">020</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">02</span></span>8 <span class="hljs-number"><span class="hljs-number">40.18</span></span>% brk <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">007</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">010</span></span> <span class="hljs-number"><span class="hljs-number">30.28</span></span>% rt_sigaction <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">004</span></span> <span class="hljs-number"><span class="hljs-number">18.81</span></span>% rt_sigprocmask <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% access <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">005</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">005</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">005</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% getdents <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">940</span></span> <span class="hljs-number"><span class="hljs-number">2.023</span></span> <span class="hljs-number"><span class="hljs-number">4.51</span></span>% getrlimit <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% arch_prctl <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% set_tid_address <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% openat <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">022</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">022</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">022</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% set_robust_list <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>%</code> </pre><br><br><pre> <code class="hljs perl">$ perf trace --summary ./task_diag_all a Summary of events: task_diag_all (<span class="hljs-number"><span class="hljs-number">72481</span></span>), <span class="hljs-number"><span class="hljs-number">183</span></span> events, <span class="hljs-number"><span class="hljs-number">94.8</span></span>%, <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">000</span></span> msec <span class="hljs-keyword"><span class="hljs-keyword">syscall</span></span> calls min avg max stddev (msec) (msec) (msec) (%) --------------- -------- --------- --------- --------- ------ <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">1.471</span></span> <span class="hljs-number"><span class="hljs-number">6.364</span></span> <span class="hljs-number"><span class="hljs-number">14.43</span></span>% <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">005</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>8 <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">020</span></span> <span class="hljs-number"><span class="hljs-number">26.21</span></span>% <span class="hljs-keyword"><span class="hljs-keyword">close</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">3.96</span></span>% fstat <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">4.67</span></span>% mmap <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">006</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">030</span></span> <span class="hljs-number"><span class="hljs-number">25.38</span></span>% mprotect <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">005</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">007</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">010</span></span> <span class="hljs-number"><span class="hljs-number">6.33</span></span>% munmap <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">006</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">007</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>8 <span class="hljs-number"><span class="hljs-number">13.84</span></span>% brk <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">003</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">004</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">004</span></span> <span class="hljs-number"><span class="hljs-number">9.08</span></span>% rt_sigaction <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">9.57</span></span>% rt_sigprocmask <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% access <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">006</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">006</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">006</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% getrlimit <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% arch_prctl <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% set_tid_address <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% set_robust_list <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">002</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>%</code> </pre><br><br>  The number of system calls in the case of task_diag is seriously reduced. <br><br>  Results for the perf utility (cited from David Ahern's letter). <br><pre> <code class="hljs pgsql">&gt; <span class="hljs-keyword"><span class="hljs-keyword">Using</span></span> the fork test command: &gt; <span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">000</span></span> processes; <span class="hljs-number"><span class="hljs-number">10</span></span>k proc <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> threads = <span class="hljs-number"><span class="hljs-number">50</span></span>,<span class="hljs-number"><span class="hljs-number">000</span></span> tasks &gt; reading /proc: <span class="hljs-number"><span class="hljs-number">11.3</span></span> sec &gt; task_diag: <span class="hljs-number"><span class="hljs-number">2.2</span></span> sec &gt; &gt; @<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">440</span></span> tasks, reading /proc <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> at <span class="hljs-number"><span class="hljs-number">0.77</span></span> sec <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> task_diag at <span class="hljs-number"><span class="hljs-number">0.096</span></span> &gt; &gt; <span class="hljs-number"><span class="hljs-number">128</span></span> instances <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> sepcjbb, <span class="hljs-number"><span class="hljs-number">80</span></span>,<span class="hljs-number"><span class="hljs-number">000</span></span>+ tasks: &gt; reading /proc: <span class="hljs-number"><span class="hljs-number">32.1</span></span> sec &gt; task_diag: <span class="hljs-number"><span class="hljs-number">3.9</span></span> sec &gt; &gt; So overall much snappier startup times.</code> </pre><br><br>  Here we see an increase in productivity by an order of magnitude. <br><br><h1>  Conclusion </h1><br>  This project is under development and can still be changed many times.  But now we have two real projects, by the example of which one can see a serious increase in productivity.  I am almost certain that in one form or another this work will sooner or later fall into the main branch of the kernel. <br><br><h1>  Links </h1><br>  <a href="https://github.com/avagin/linux-task-diag">github.com/avagin/linux-task-diag</a> <br>  <a href="https://lkml.org/lkml/2015/7/6/142">lkml.org/lkml/2015/7/6/142</a> <br>  <a href="https://lwn.net/Articles/633622/">lwn.net/Articles/633622</a> <br>  <a href="http://www.slideshare.net/openvz/speeding-up-ps-and-top-57448025">www.slideshare.net/openvz/speeding-up-ps-and-top-57448025</a> </div><p>Source: <a href="https://habr.com/ru/post/275545/">https://habr.com/ru/post/275545/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275529/index.html">NEMA Encryption Machine</a></li>
<li><a href="../275531/index.html">Translation of "Simplified JavaScript Jargon"</a></li>
<li><a href="../275535/index.html">Monitoring uninterruptible power supply ippon winner 3000 using apcupsd + Zabbix in Ubuntu</a></li>
<li><a href="../275539/index.html">Why is HTTPS not commonly used yet?</a></li>
<li><a href="../275541/index.html">2 ^ 74207281-1 - a prime number</a></li>
<li><a href="../275547/index.html">Some interesting and useful for all</a></li>
<li><a href="../275549/index.html">Whitelisting with Windows Firewall</a></li>
<li><a href="../275551/index.html">Watchdog timer for 4G-modem on CentOS 7</a></li>
<li><a href="../275553/index.html">How IaaS provider to choose a data center to host the cloud: IT-GRAD Experience</a></li>
<li><a href="../275555/index.html">We do FTP for Windows Azure Pack</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>