<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Link Optimization Nginx, Apache, PHP, MySql</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suddenly, the task came to find out why a certain site does not work as quickly as you want. It is based on CakePHP, in conjunction with Apache and My...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Link Optimization Nginx, Apache, PHP, MySql</h1><div class="post__text post__text-html js-mediator-article">  Suddenly, the task came to find out why a certain site does not work as quickly as you want.  It is based on CakePHP, in conjunction with Apache and MySQL.  The article describes the process of finding bottlenecks and putting in order as much as possible. <br><br>  The name of the site will not shine - I think the programmers will find out for themselves.  Let me just say that this application is for a social network with a load of 70-150 thousand visitors in normal time.  Everything is complicated by the fact that advertising is periodically produced, which attracts about 200-300 thousand visitors in a couple of hours. <br><br>  So, under the cut description of the entire struggle for 4 days. <br><a name="habracut"></a><br>  This article is aimed at 2 groups of people.  The first is of course we, the admins, who have to rake such an outrage.  Sometimes pulling out almost by the ears of a dying server.  The second part of the audience, which I hope will also read all the material, is the programmers.  Friends, looking ahead, I‚Äôll say: there wouldn‚Äôt be such a disgrace if you designed your projects correctly, many incidents could be avoided.  Especially knowing what kind of audience you write your project. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At my disposal was the EX10 server located at the hetzner site.  For those who do not know - this is 64 GB of RAM and a 6-core processor.  Call it the core of the system.  There are 2 more servers, one with statics, the other with a backend base.  A small application, InnoDB 500MB database. <br><br>  With a constant load, as it turned out later, 70-100 online sessions, the situation is as follows: CPU load of 100% per core.  In the top, of course, MySQL and Apache are fighting for system resources. <br><br><h4>  Nginx </h4><br>  The first attempt was to reduce the server load by caching Apache output in order to remove static output from it. <br><br>  I installed it in a very simple configuration: he had to try to take all all the files by mask from a specific folder, if there is no file in it - pick it up from the proxied server, add it to this folder and give it to the client. <br><br><pre> http {
 proxy_cache_path / var / tmp / nginx_cache / levels = 1: 2 keys_zone = ok: 100m inactive = 1d max_size = 1024m;
 server {
         location ~ * \. (js | jpg | jpg | png | jpeg | gif | zip | tgz | gz | rar | doc | xls | exe | pdf | ppt | txt | wav | bmp | rtf) $ {
                 expires 1y;
                 open_file_cache_errors off;
                 error_page 404 = @fetch;
                 root / var / tmp / _fetch_ok;
                 }<font></font>
<font></font>
         location @fetch {
                 proxy_store_access user: rw group: rw all: r;
                 proxy_store on;
                 proxy_pass http://127.0.0.1:80;
                 proxy_temp_path / var / tmp / _fetch_ok_temp;
                 root / var / tmp / _fetch_ok;
                 }<font></font>
<font></font>
<font></font>
        location / {
                 proxy_cache ok;
                 proxy_pass http://127.0.0.1;
                 proxy_cache_valid any 10m;
                 proxy_buffer_size 8k;
                }
 }
 }
</pre><br>  The config is not fully given, but only necessary for this example blocks. <br><br>  Unfortunately, this did not lead to any results. <br>  There were only 3 advantages: <br><ul><li>  Apache stopped producing pictures, that is, it became a little less loaded </li><li>  Apache stopped communicating directly with the outside world, therefore it could turn off keep-alive and reduce the number of children. </li><li>  The first bottleneck was found - a PHP script manages all requests to the site to which .htaccess will redirect any request.  Including, you will not believe all the statics, and even css. </li></ul><br><br><h4>  Mysql </h4><br>  This is the hardest part, because at the moment I do not have much experience in SQL queries and optimization. <br>  I started by reading the MySQL documentation. <br><br>  Since we have InnoDB on hand - I took the configuration file from the standard delivery my-innodb-heavy-4G.cnf for the initial position <br><br>  Below I will describe the configuration parameters to which attention should be paid to high-load projects. <br><br>  <b>back_log</b> = 5000 <br>  <b>max_connections</b> = 1600 <br>  The first parameter is responsible for the number of connections that can be in the queue until the server stops responding to new requests.  The second is how many connections can be accepted by the server. <br>  I have these values ‚Äã‚Äãquite large, since there are on average up to 1,300 competitive sessions. It‚Äôs not worth putting more than you need, since each connection may require a certain amount of RAM.  More on that later. <br><br>  <b>max_connect_errors</b> = 50 <br>  It's simple - the number of errors that a client can make before receiving a disconnect.  It was necessary to increase, since the project is under development and there are many chances of incorrect requests. <br><br>  <b>table_cache</b> = 2048 <br>  Opening a table requires some resources, therefore this parameter is responsible for the number of open tables waiting for the next connection for some time after the last one. <br>  You can find out whether it can be changed by variable <br> <code>SHOW GLOBAL STATUS LIKE 'Opened_tables';</code> <br>  It should not be as small as possible. <br>  It is well written: <a href="http://www.mysql.ru/docs/man/Table_cache.html">http://www.mysql.ru/docs/man/Table_cache.html</a> <br><br>  <b>max_allowed_packet</b> = 16M <br>  Maximum packet size.  If we do not use large blobs, it does not make sense to change. <br><br>  <b>binlog_cache_size</b> = 1M <br>  Binary log cache size for a transaction.  The official documentation recommends increasing if we have large transactions. <br>  <a href="http://dev.mysql.com/doc/refman/5.5/en/replication-options-binary-log.html">dev.mysql.com/doc/refman/5.5/en/replication-options-binary-log.html#sysvar_binlog_cache_size</a> <br><br>  <b>max_heap_table_size</b> = 64M <br>  <b>tmp_table_size</b> = 64M <br>  As I understand it, the smaller one is taken into account.  The parameter is responsible for the maximum size of the temporary table that fits in memory.  If the table reaches it, it is placed on the disk.  Therefore it is necessary to try to create as few tables on the disk as possible.  See what relation of temporary tables to tables on the disk at the moment you can request <br> <code>show status like '%tmp%tables';</code> <br>  <a href="http://www.mysqlperformanceblog.com/2007/01/19/tmp_table_size-and-max_heap_table_size/">www.mysqlperformanceblog.com/2007/01/19/tmp_table_size-and-max_heap_table_size</a> <br><br>  <b>sort_buffer_size</b> = 8M <br>  In order not to deceive anyone, I will not undertake to translate.  I will only clarify that the documentation advises to look at this parameter only if <br>  show status like '% Sort_merge_passes%';  Above zero <br>  <a href="http://dev.mysql.com/doc/refman/5.5/en/server-system-variables.html">dev.mysql.com/doc/refman/5.5/en/server-system-variables.html#sysvar_sort_buffer_size</a> <br><br>  <b>join_buffer_size</b> = 2M <br>  As far as I understand, the maximum buffer size calculated for operations not using an index.  Did not touch yet. <br>  <a href="http://dev.mysql.com/doc/refman/5.5/en/server-system-variables.html">dev.mysql.com/doc/refman/5.5/en/server-system-variables.html#sysvar_join_buffer_size</a> <br><br>  <b>thread_cache_size</b> = 4096 <br>  The maximum number of threads that remain for reuse after the request.  It is useful to keep sufficient for MySQL to do as little as possible new threads and use old ones.  You can understand the effectiveness of this parameter with respect to the parameters of Threads_created / Connections; <br>  <a href="http://dev.mysql.com/doc/refman/5.5/en/server-system-variables.html">dev.mysql.com/doc/refman/5.5/en/server-system-variables.html#sysvar_thread_cache_size</a> <br><br>  <b>query_cache_size</b> = 256M <br>  <b>query_cache_limit</b> = 8M <br>  I think this is better than my colleague, the author of this translation, <a href="http://habrahabr.ru/post/41166/">habrahabr.ru/post/41166,</a> no one will say. <br>  This is probably the most important parameter, so it is better to re-read. <br><br>  <b>thread_stack</b> = 192K <br>  I will not undertake to describe the purpose of this parameter, I will only pay attention to the fact that it also affects the amount of RAM consumed, since it is also allocated to each connection.  Therefore again multiply by max connections <br><br>  <b>long_query_time</b> = 2 <br>  <b>log_long_format</b> <br>  <b>log-queries-not-using-indexes</b> <br>  MySQL server has a very handy tool for evaluating database performance.  This is a log file of long queries.  In my experience, these are most often ineffective queries or queries that do not use an index. <br>  I advise you to go to the programmers with this log file. <br><br>  <b>key_buffer_size</b> = 1G <br>  The parameter is responsible for caching indexes in memory. To optimize this value, look at Key_read_requests, Key_reads.  The second parameter is responsible for the number of reads from the disk and not their buffer. <br>  <a href="http://mysqltips.blogspot.com/2007/03/key-buffer.html">mysqltips.blogspot.com/2007/03/key-buffer.html</a> <br><br>  <b>read_buffer_size</b> = 1M <br>  <a href="http://boombick.org/blog/posts/3">boombick.org/blog/posts/3</a> - After reading this text, I would not risk adding anything, since I will not be sure that I was right. <br><br>  <b>read_rnd_buffer_size</b> = 24M <br>  The parameter affects the speed of sorting operations.  Unfortunately I did not find how to evaluate its effectiveness. <br>  <a href="http://dev.mysql.com/doc/refman/5.5/en/server-system-variables.html">dev.mysql.com/doc/refman/5.5/en/server-system-variables.html#sysvar_read_rnd_buffer_size</a> <br>  <a href="http://www.mysqlperformanceblog.com/2007/07/24/what-exactly-is-read_rnd_buffer_size/">www.mysqlperformanceblog.com/2007/07/24/what-exactly-is-read_rnd_buffer_size</a> <br><br>  <b>myisam_sort_buffer_size</b> = 128M <br>  <b>myisam_max_sort_file_size</b> = 10G <br>  <b>myisam_max_extra_sort_file_size</b> = 10G <br>  Parameters affect the sorting, just did not dare to change them.  Increased the first suggestion that it will increase the performance of complex queries. <br><br>  <b>sync_binlog</b> = 0 <br>  In our case it means not to synchronize binary logs to disk through system functions.  If the parameter is greater than zero, the server will synchronize data every n requests. <br>  <a href="http://dev.mysql.com/doc/refman/5.5/en/replication-options-binary-log.html">dev.mysql.com/doc/refman/5.5/en/replication-options-binary-log.html#sysvar_sync_binlog</a> <br><br>  <b>innodb_buffer_pool_size</b> = 4G <br>  Increasing this setting reduces the number of disk operations.  Unfortunately, I also did not find how to measure it.  Since the base is small, it decided not to increase it much.  Somewhere met advice, in the case of a large database, increase this parameter to 70% of RAM. <br>  <a href="http://dev.mysql.com/doc/refman/5.5/en/innodb-parameters.html">dev.mysql.com/doc/refman/5.5/en/innodb-parameters.html#sysvar_innodb_buffer_pool_size</a> <br><br>  <b>innodb_log_buffer_size</b> = 32M <br>  If you believe the description, reduces disk operations with heavy transactions. <br>  <a href="http://dev.mysql.com/doc/refman/5.5/en/innodb-parameters.html">dev.mysql.com/doc/refman/5.5/en/innodb-parameters.html#sysvar_innodb_log_buffer_size</a> <br><br>  <b>innodb_log_file_size</b> = 1024M <br>  If you believe the documentation, then increasing the log file reduces the workload of IO disk operations, but increases the recovery time in case of failures. <br>  <a href="http://dev.mysql.com/doc/refman/5.5/en/innodb-parameters.html">dev.mysql.com/doc/refman/5.5/en/innodb-parameters.html#sysvar_innodb_log_file_size</a> <br><br>  <b>innodb_flush_log_at_trx_commit</b> = 0 <br>  With a value of 0, buffers are flushed once a <s>minute a</s> second, and not after each insert. <br>  <a href="http://dev.mysql.com/doc/refman/5.1/en/innodb-parameters.html">dev.mysql.com/doc/refman/5.1/en/innodb-parameters.html#sysvar_innodb_flush_log_at_trx_commit</a> <br><br>  <b>innodb_thread_concurrency</b> = 14 <br>  Recommend to put a little more than the number of cores. <br><br>  <b>innodb_sync_spin_loops</b> = 10 <br>  As I understand it, it affects the number of attempts to access blocked data.  Increasing this value, we can lose processor time, and reducing - the reliability of writing to the database. <br>  <a href="http://www.mysqlperformanceblog.com/2006/09/07/internals-of-innodb-mutexes/">www.mysqlperformanceblog.com/2006/09/07/internals-of-innodb-mutexes</a> <br>  <a href="http://dev.mysql.com/doc/refman/5.0/en/innodb-parameters.html">dev.mysql.com/doc/refman/5.0/en/innodb-parameters.html#sysvar_innodb_sync_spin_loops</a> <br><br><h5>  DB and RAM </h5><br>  There is an excellent perl script which gives a basic understanding of what needs to be changed in the database.  <a href="http://mysqltuner.pl/mysqltuner.pl">mysqltuner.pl/mysqltuner.pl</a> <br>  Very often, this script swears at the maximum memory consumption by the mysql server. <br>  If you look at the source - this is how this program considers memory usage: <br><br>  per_thread_buffers = read_buffer_size + read_rnd_buffer_size + sort_buffer_size + thread_stack + join_buffer_size; <br>  total_per_thread_buffers = per_thread_buffers * max_connections; <br>  server_buffers = key_buffer_size + max_tmp_table_size; <br>  server_buffers + = innodb_buffer_pool_size; <br>  server_buffers + = innodb_additional_mem_pool_size; <br>  server_buffers + = innodb_log_buffer_size; <br>  server_buffers + = query_cache_size; <br>  total_possible_used_memory = server_buffers + total_per_thread_buffers; <br><br>  It was useful for me to understand where I did not correctly indicate the values. <br>  By the way, right away you can‚Äôt underestimate the parameters, if the script swears on a large consumption of RAM by the base, you shouldn‚Äôt.  Since many say that this is only a theoretical indicator and the database may never try to take so much memory. <br><br><h5>  Optimization of the database structure. </h5><br>  When we have done all the possible settings and still did not get a good result - it's time to turn to the slow-log file. <br>  In standard to mysql there is an application mysqldumpslow. <br>  By running <br>  mysqldumpslow -sc &lt;path to the Slow Log File&gt; sorted by the number of entries a list of database queries that were too long or did not use indexes.  Usually adding the right indexes fixes both problems. <br><br>  In most cases, when you see a large number of long queries in the output of this program (count variable), copy a piece of this query and look for an example of such a query in the text of the log file. <br>  Next, go to the database client and execute this query by adding the word explain first. <br>  About this you can also read more here: <br>  <a href="http://habrahabr.ru/post/31072/">habrahabr.ru/post/31072</a> <br><br>  So you can see if the query uses an index or not. <br>  If the table does not have enough indexes, you can safely add them, although you should not overdo it, either.  Indexes are needed for those columns that are used after where and order.  Start with a unique index for each hundred.  Otherwise, the index may not work. <br>  Here you can learn in more detail how these indexes work: <br>  <a href="http://dev.mysql.com/doc/refman/5.0/en/mysql-indexes.html">dev.mysql.com/doc/refman/5.0/en/mysql-indexes.html</a> <br><br>  Frankly, after optimizing about 5 key requests, the server was able to handle 500-700 connections instead of 50, and the issue time of the php page was reduced to 1s instead of 8s.  At maximum load, the page issue time was 5s instead of 50s.  (This refers to performance measurements using Apache Benchmark with approximately 1000 threads) <br><br><h4>  A little more about nginx. </h4><br>  After optimization, he noticed that at large loads, requests for more than a certain amount of nginx are discarded, and not apache.  At the same time, the memory and CPU are not loaded. <br>  Began to understand.  I saw in the logs that the nginx server is trying to open more files than it should be. <br>  In Suse OS, with which I had to face, the file is responsible for this limitation <br>  /etc/security/limits.conf <br>  I added there such lines: <br><pre> nginx soft nofile 300000
 nginx hard nofile 300000
</pre><br>  Restart server is not needed. <br><br><h4>  Apache2 </h4><br>  I haven't changed the configuration much yet.  The only thing I did was turn off keep-alive.  So that the Apache could calmly give an answer and take up the next request at the moment when nginx is still giving the client a page via a slow channel. <br><br><h5>  eAccelerator </h5><br>  Do not forget that this optimizer also has a number of parameters that can be changed. <br><br>  Here is what I changed: <br>  <b>eaccelerator.shm_size</b> = "2096" <br>  The size of virtual memory in megabytes that can be used <br><br>  <b>eaccelerator.shm_only</b> = "1" - use only RAM and not use a disk, in the fight for io on a software raid of 2 sat disks decided to do so. <br><br><h4>  Here's something that will be useful to read: </h4><br>  <a href="http://habrahabr.ru/post/41166/">habrahabr.ru/post/41166</a> <br>  <a href="http://habrahabr.ru/post/108418/">habrahabr.ru/post/108418</a> <br>  <a href="http://dev.mysql.com/doc/refman/5.5/en/server-system-variables.html">dev.mysql.com/doc/refman/5.5/en/server-system-variables.html</a> <br><br>  Special thanks to my friend who helped to read the article and correct a whole lot of grammatical and stylistic mistakes. <br><br><h4>  Instead of epilogue </h4><br>  Friends, I understand that the mistakes and errors in the conclusions given in this article are a whole bunch. <br>  A big request to the guru, with your comments, to help make the article better. <br><br><h4>  UPD.  Summary of comments </h4><br>  Thank you for so much interest.  Not expected. <br><br>  A good link, I recommend reading: <a href="http://www.percona.com/files/presentations/percona-live/dc-2012/PLDC2012-optimizing-mysql-configuration.pdf">www.percona.com/files/presentations/percona-live/dc-2012/PLDC2012-optimizing-mysql-configuration.pdf</a> <br>  Thank you <a href="https://habrahabr.ru/users/albertum/" class="user_link">albertum</a> <br><br>  Regarding php caching systems: <br>  Yes indeed, eAccelerator is not the only option. <br>  There is also APC, and yes indeed they are going to embed it in PHP. <br>  What is better to judge I will not undertake, since I did not do a sufficient number of tests. <br><br>  MySQL alternatives are also present and many of them. <br>  Key of course: <br>  mAriadb <br>  percona <br><br>  I myself personally chose the perkona and so far satisfied. <br><br>  With regard to the fact that this is not the final light result and we must move on - those who have read carefully will see that this is only patching up the holes. </div><p>Source: <a href="https://habr.com/ru/post/146179/">https://habr.com/ru/post/146179/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../146174/index.html">A small set of installed programs for Windows Phone</a></li>
<li><a href="../146175/index.html">Attack visualization</a></li>
<li><a href="../146176/index.html">What tasks can be solved using the corporate portal</a></li>
<li><a href="../146177/index.html">Where to get a programmer</a></li>
<li><a href="../146178/index.html">Synology¬Æ unveiled DiskStation DS112 +</a></li>
<li><a href="../146181/index.html">Stop motion review of MSI Z77A-GD65 board</a></li>
<li><a href="../146182/index.html">Our principles</a></li>
<li><a href="../146183/index.html">Web developer and designer Chris Koyer collected $ 25,000 in 24 hours on Kickstarter</a></li>
<li><a href="../146185/index.html">Lego Turing Machine</a></li>
<li><a href="../146188/index.html">Napartner.ru: $ 2,450,000 investment in startups over 2 years</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>