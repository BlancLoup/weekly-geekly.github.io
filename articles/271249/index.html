<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Modular ASP.NET 5 Application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For quite a long time, when developing websites for my clients, I used my own simple CMS (Platform). It was written on ASP.NET + MVC and had closed so...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Modular ASP.NET 5 Application</h1><div class="post__text post__text-html js-mediator-article">  For quite a long time, when developing websites for my clients, I used my own simple CMS (Platform).  It was written on ASP.NET + MVC and had closed source code.  With the advent of the first beta of the new ASP.NET 5, I decided to rewrite my system on this technology to make it cross-platform and, ultimately, put it on GitHub.  Since the technology is very new, there was practically no information on this issue, so the solution of some problems was found either by chance or in the process of studying the source codes of ASP.NET 5 itself. <br><br>  To simplify, I prepared and also posted on GitHub a special test solution - <a href="https://github.com/DmitrySikorsky/AspNet5ModularApp">AspNet5ModularApp</a> .  Basically, I will rely on him in this article, but I will also touch on some of the techniques and ideas that I used in Platformus (partly in the hope of getting any comments on them). <br><br><img src="https://habrastorage.org/files/aaf/827/2b7/aaf8272b78d14bca9ecb247ea98bd884.png"><br><a name="habracut"></a><br><h2>  Solving the main tasks </h2><br>  If we omit specific questions specifically for developing CMS, the main task for me was (and still remains, by the way) a competent modular architecture of the project. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I decided that the main web application should not have any controllers, views or resources (scripts, styles, images, etc.), should not know about the data or how to store them, but should know about the directory with extensions (assembly set ).  In this case, his only task is to find, load and initialize all extensions. <br><br>  Extensions, in turn, must implement some common interface and may contain, in fact, anything.  (But, since almost every extension in my case will work with data, I introduced an additional level of abstraction describing this mechanism. Thanks to this, all extensions can work with data unified and in a single context, which is quite important. I will describe in detail it's lower.) <br><br>  In most cases, extensions should contain controllers and views, so first of all I tried to make the controller and view work from a dynamically loaded assembly (i.e., from an assembly that is not explicitly referenced in the project.json main web application and which loaded from the directory with extensions after it starts). <br><br>  There were no problems with controllers.  Simply implement the IAssemblyProvider interface, copy the assemblies from DefaultAssemblyProvider and add those assemblies that are dynamically loaded from the directory with extensions (see <a href="">AspNet5ModularApp.ExtensionAssemblyProvider</a> ), and then simply register the new implementation in ConfigureServices (see <a href="">AspNet5ModularApp.Startup</a> ).  The only point: by default, MVC is looking for controllers in assemblies that refer to something like Microsoft.AspNet.Mvc.  Since in my case almost all projects refer to this build (this is bad, but I described below why so far this is the case), the search takes place in all of them, which probably negatively affects the speed, therefore, in any case, it is necessary to fix it (although, of course, in our test solution there are no performance problems). <br><br>  I had to tinker with the performances.  As far as I know now, you can either make representations resources (by adding, for example, the string ‚Äúresource‚Äù: ‚ÄúViews / **‚Äù in project.json), or use the preliminary compilation of views (by adding the RazorPreCompilation class inherited from RazorPreCompileModule).  I prefer the second option, because in this case, you can, first, use views typed by your own types (I mean types defined inside the assembly, which contains the view itself ‚Äî in the case of resource views, these types are not will be found at runtime during compilation, although, as far as I understand from the answer to my question on GitHub ASP.NET, this problem can also be solved), and secondly, they simply do not require runtime compilation and therefore load faster on the first access. .  Well, all the errors in views also become apparent at the compilation stage. <br><br>  The main web application of our AspNet5ModularApp test solution simultaneously supports both of these options, the corresponding behavior is set using the AddPrecompiledRazorViews and AddRazorOptions functions (see <a href="">Startup.cs</a> ). <br><br>  If it is enough to simply install assemblies containing them for precompiled views, you must implement the IFileProvider interface with resource representations (see <a href="">AspNet5ModularApp.CompositeFileProvider</a> ) and specify the main web application as the file sources (by default this is the case) and, in addition, all dynamically loaded assemblies containing views.  By the way, resources can be not only views, but also scripts, styles, images, and so on.  After the assemblies that contain them are added to the CompositeFileProvider, they will be available along the paths along which they are located in their assemblies. <br><br>  ExtensionA illustrates the first option (with resource views), and ExtensionB the second option (with precompiled views). <br><br>  Here it is also necessary to tell about a couple of problems that I have not found a solution to. <br><br>  First, different parts of ASP.NET 5 use different versions of the System. * Builds, so if you connect Microsoft.AspNet.Mvc in one project and try to connect System.Runtime in another project, you can get an error that is used different versions of the same library.  At the moment, AspNet5ModularApp is built on the basis of the 8th ASP.NET 5 beta, so I think that by the release this will be fixed.  In the meantime, I simply prescribed Microsoft.AspNet.Mvc in all projects (except those that work with the Entity Framework - the Entity Framework itself is enough) to get the same set of dependencies.  I agree, this is very bad, but it allowed us not to waste time on trifles. <br><br>  The second (more serious, perhaps) problem is that I copy the extension assemblies into a directory with extensions and, if the assembly uses something that the main web application does not use, I have to copy the corresponding dependencies there as well.  For example, I had to put it in the directory with the System.Reflection.dll and System.Reflection.TypeExtensions.dll extensions (otherwise I get an exception when I try to load assemblies that have the dependencies mentioned above).  But the worst thing is that I could not find such a set of assemblies, which would allow EntityFramework.Sqlite to earn.  Accordingly, I had to include an explicit link to EntityFramework.Sqlite in the project.json of the main application (and I wrote above that I don‚Äôt want it to know about the data at all, not to mention a specific implementation), which really annoys me.  (By the way, everything will be fine if you register the assemblies in .dnx in the GAC, but it seems to me that this is wrong.) <br><br>  Next, I began to deal with the data and its storage.  I wanted the extensions to work with different data sources, and for defining a specific implementation it was enough just to copy the necessary assemblies into the directory with the extensions. <br><br>  In the <a href="https://github.com/DmitrySikorsky/AspNet5ModularApp/tree/master/src/AspNet5ModularApp.Models.Abstractions">AspNet5ModularApp.Models.Abstractions</a> project <a href="https://github.com/DmitrySikorsky/AspNet5ModularApp/tree/master/src/AspNet5ModularApp.Models.Abstractions">,</a> I defined the base interface for the model - IEntity.  In the <a href="https://github.com/DmitrySikorsky/AspNet5ModularApp/tree/master/src/AspNet5ModularApp.Data.Abstractions">AspNet5ModularApp.Data.Abstractions</a> project <a href="https://github.com/DmitrySikorsky/AspNet5ModularApp/tree/master/src/AspNet5ModularApp.Data.Abstractions">,</a> I defined 3 basic interfaces - IStorageContext, IStorage and IRepository.  Their purpose is best illustrated by the <a href="https://github.com/DmitrySikorsky/AspNet5ModularApp/tree/master/src/AspNet5ModularApp.Data.EF.Sqlite">AspNet5ModularApp.Data.EF.Sqlite</a> project, which contains implementations of these interfaces for working with the Sqlite database using the Entity Framework 7. Also, this project defines the IModelRegistrar interface, which allows extensions to register their models in a single context (see <a href="">AspNet5ModularApp.Data.EF.Sqlite.StorageContext.OnModelCreating</a> ). <br><br>  The general principle of operation is as follows.  An extension can consist of several projects: a project with controllers and views, a project with models, a project with abstractions of repositories for working with a data source (one for each model) and a project with implementations of these abstractions (one project for each data source).  A project with controllers and views knows about repository models and abstractions, but does not know about their implementations for specific data sources.  Thus, in the controller's constructor, you can ask the built-in ASP.NET 5 DI to provide an accessible instance of IStorage and, further, request an available implementation of a certain repository from it via its interface.  (Of course, in order for the built-in DI to find an available IStorage implementation, it needs to be told about it, which is done in <a href="">AspNet5ModularApp.ExtensionB.ExtensionB.ConfigureServices</a> . In order not to do this in each extension, in Platformus I rendered the general functionality into a separate extension - Barebone. ) <br><br><h2>  Result </h2><br>  What happened as a result.  If you close your eyes to the problems with dependencies, about which I wrote and which, most likely, will be solved soon, then, in my opinion, I have found answers to all my questions.  I can extend the capabilities of an application by simply copying assemblies to a directory with extensions, extensions can have strongly typed representations and a single context for working with a data source.  It is not difficult to make it possible to add and remove extensions directly in the process of the application, if necessary.  You can also significantly improve performance by adding caching to the type search engines. <br><br>  I would be happy to comment and comment, I will also be happy to explain those points that I could not well describe in the article. <br><br><h2>  Links and thanks </h2><br>  <a href="https://github.com/DmitrySikorsky/AspNet5ModularApp">Link</a> to AspNet5ModularApp. <br><br>  I would like to thank the user GitHub <a href="https://github.com/leo9223/">github.com/leo9223</a> who really helped me by showing <a href="https://github.com/stuartleeks/ModularVNext">this project</a> .  This project, in turn, helped me deal with resource-ideas, although I could not get it to work.  Now I know why.  When creating EmbeddedFileProvider from assemblies with extensions, basic namespaces were not specified there, therefore no representations could be found.  I found a clue <a href="https://github.com/aspnet/Mvc/tree/dev/test/WebSites/RazorEmbeddedViewsWebSite">here</a> .  Also, the answers to my questions on GitHub were helped by the ASP.NET developers, thanks for their patience and attention. </div><p>Source: <a href="https://habr.com/ru/post/271249/">https://habr.com/ru/post/271249/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271237/index.html">Features of creating a turnkey web project from Startup Makers</a></li>
<li><a href="../271239/index.html">Testing a web service on Go</a></li>
<li><a href="../271241/index.html">Forecasting in the gaming industry. Part 3: Forecasts for the forecast industry</a></li>
<li><a href="../271243/index.html">ActiveRecord-based Ruby REST API for accessing tables in a database</a></li>
<li><a href="../271245/index.html">Risks and problems of password hashing</a></li>
<li><a href="../271255/index.html">Objective-C: how blocks work</a></li>
<li><a href="../271257/index.html">Classic cryptanalysis</a></li>
<li><a href="../271259/index.html">Two-factor authentication of Cisco AnyConnect clients. FreeRadius and Google Authenticator</a></li>
<li><a href="../271261/index.html">PBX in your pocket: set up IP telephony for remote work</a></li>
<li><a href="../271265/index.html">swirl: the rapid immersion in R (learning by doing)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>