<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Attributes system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will focus on the unification of working with attributes in projects written in C #. The article is intended for developers of medium and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Attributes system</h1><div class="post__text post__text-html js-mediator-article">  This article will focus on the unification of working with attributes in projects written in C #.  The article is intended for developers of medium and large projects, or those who are interested in the subject of system design.  All examples and implementations are conditional and are intended to reflect approaches or ideas. <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  With the growth of the project, the number of different types of attributes grows.  In each case, the developer chooses a convenient treatment option.  With a large number of developers, approaches can vary widely, which complicates the understanding of systems.  Typical examples of using attributes are: various types of serialization, cloning, binding, and the like. <br>  To begin, consider the various options for using attributes, write down their pros and cons, and then try to get rid of the minuses by implementing a kind of generalized system. <br><br><h2>  Typical examples </h2><br><h4>  Binding </h4><br>  Suppose we have a certain description of the user interface (UI, Form, Form) in an external source.  There is a base class of the form Form, which allows you to load a description and create all the necessary controls (widgets, controls, widgets).  Form users inherit from the Form class and mark up the required fields using attributes.  When the Initialise method is called, the Form class, the created widgets are bound to the fields of the inheritor class. <br><div class="spoiler">  <b class="spoiler_title">Source</b> <div class="spoiler_text">  Widget class description: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Widget</span></span> { }</code> </pre> <br>  Attribute class description: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; [AttributeUsage(AttributeTargets.Field, AllowMultiple = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WidgetNameAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">Attribute</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WidgetNameAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = name; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name; }</code> </pre><br>  Form class description: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Form</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialise</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { FieldInfo[] fields = GetType().GetFields( BindingFlags.FlattenHierarchy | BindingFlags.Instance | BindingFlags.Public | BindingFlags.NonPublic); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (FieldInfo field <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fields) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (WidgetNameAttribute item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> field.GetCustomAttributes( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(WidgetNameAttribute), <span class="hljs-literal"><span class="hljs-literal">false</span></span>)) { Widget widget = FindWidget(item.Name); field.SetValue(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, widget); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Widget </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindWidget</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Widget(); } }</code> </pre><br>  Custom form class description: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestForm1</span></span> : <span class="hljs-title"><span class="hljs-title">Form</span></span> { [WidgetName(<span class="hljs-string"><span class="hljs-string">"Test1"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Widget TestWidget1; [WidgetName(<span class="hljs-string"><span class="hljs-string">"Test2"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Widget TestWidget2; }</code> </pre><br>  Loading and form initialization: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ConsoleApplication1</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { TestForm1 form1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestForm1(); form1.Initialise(); } } }</code> </pre><br></div></div><br><h4>  Serialization </h4><br>  Suppose we have some description of the data in the xml file.  It can be both data and, for example, settings.  There is a base class Data, which allows you to search for values ‚Äã‚Äãand convert them to the required type.  The user is inherited from the Data class and marks the fields with attributes, where XPath indicates the path to a specific field value in xml.  When the Data class's InitialiseByXml method is called, the value is searched for and converted to the required type.  In the current example, for simplicity, the converter is built into the class and supports only a few types. <br><div class="spoiler">  <b class="spoiler_title">Source</b> <div class="spoiler_text">  Attribute class description: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; [AttributeUsage(AttributeTargets.Field, AllowMultiple = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DataValueAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">Attribute</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataValueAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> xPath</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xPath = xPath; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> XPath { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> xPath; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> xPath; }</code> </pre><br>  Data class description: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Xml; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DataObject</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { parsers[<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)] = <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.Parse(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); }; parsers[<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)] = <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitialiseByXml</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlNode node</span></span></span><span class="hljs-function">)</span></span> { FieldInfo[] fields = GetType().GetFields( BindingFlags.FlattenHierarchy | BindingFlags.Instance | BindingFlags.Public | BindingFlags.NonPublic); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (FieldInfo field <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fields) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (DataValueAttribute item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> field.GetCustomAttributes( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(DataValueAttribute), <span class="hljs-literal"><span class="hljs-literal">false</span></span>)) { XmlNode tergetNode = node.SelectSingleNode(item.XPath); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = parsers[field.FieldType](tergetNode.InnerText); field.SetValue(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParseHandle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Dictionary&lt;Type, ParseHandle&gt; parsers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Type, ParseHandle&gt;(); }</code> </pre><br>  Custom class description: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestDataObject1</span></span> : <span class="hljs-title"><span class="hljs-title">DataObject</span></span> { [DataValue(<span class="hljs-string"><span class="hljs-string">"Root/IntValue"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Value1; [DataValue(<span class="hljs-string"><span class="hljs-string">"Root/StringValue"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value2; }</code> </pre><br>  Usage example: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Xml; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ConsoleApplication1</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { XmlDocument doc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XmlDocument(); doc.LoadXml( <span class="hljs-string"><span class="hljs-string">"&lt;Root&gt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"&lt;IntValue&gt;42&lt;/IntValue&gt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"&lt;StringValue&gt;Douglas Adams&lt;/StringValue&gt;"</span></span> + <span class="hljs-string"><span class="hljs-string">"&lt;/Root&gt;"</span></span>); TestDataObject1 test = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestDataObject1(); test.InitialiseByXml(doc); } } }</code> </pre><br></div></div><br><h4>  Cloning </h4><br>  Suppose we have a class CloneableObject that allows you to clone yourself and all of your heirs.  Cloning can be both normal and deep.  The user inherits from CloneableObject and marks the fields that need to be cloned, and also indicates whether to use deep field cloning. <br><div class="spoiler">  <b class="spoiler_title">Source</b> <div class="spoiler_text">  Attribute class description: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; [AttributeUsage(AttributeTargets.Field, AllowMultiple = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CloneAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">Attribute</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Deep { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> deep; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { deep = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> deep; }</code> </pre><br>  CloneableObject class description: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CloneableObject</span></span> : <span class="hljs-title"><span class="hljs-title">ICloneable</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clone</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> clone = Activator.CreateInstance(GetType()); FieldInfo[] fields = GetType().GetFields( BindingFlags.FlattenHierarchy | BindingFlags.Instance | BindingFlags.Public | BindingFlags.NonPublic); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (FieldInfo field <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fields) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (CloneAttribute item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> field.GetCustomAttributes( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CloneAttribute), <span class="hljs-literal"><span class="hljs-literal">false</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = field.GetValue(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (item.Deep) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (field.FieldType.IsArray) { Array oldArray = (Array)<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; Array newArray = (Array)oldArray.Clone(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index = <span class="hljs-number"><span class="hljs-number">0</span></span>; index &lt; oldArray.Length; index++) newArray.SetValue(((ICloneable)oldArray.GetValue(index)). Clone(), index); <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = newArray; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = ((ICloneable)<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>).Clone(); } } field.SetValue(clone, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> clone; } }</code> </pre><br>  Custom class description: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestCloneableObject1</span></span> : <span class="hljs-title"><span class="hljs-title">CloneableObject</span></span> { [Clone] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CloneableObject Value1; [Clone] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CloneableObject[] ValueArray2; [Clone(Deep = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CloneableObject Value3; [Clone(Deep = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CloneableObject[] ValueArray4; }</code> </pre><br>  Usage example: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ConsoleApplication1</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { TestCloneableObject1 test = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestCloneableObject1(); test.Value1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CloneableObject(); test.ValueArray2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CloneableObject[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CloneableObject() }; test.Value3 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CloneableObject(); test.ValueArray4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CloneableObject[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CloneableObject() }; TestCloneableObject1 test2 = (TestCloneableObject1)test.Clone(); } } }</code> </pre><br></div></div><br>  All examples have similar features and show the classic use of attributes. <br>  Pros: <br><ul><li>  Simplicity </li></ul><br>  Minuses: <br><ul><li>  At each initialization, we request all fields. </li><li>  At each initialization, we create instances of attributes. </li><li>  With each initialization, we do a branch by field type, although its type never changes </li></ul><br><h2>  Unification </h2><br>  The main idea of ‚Äã‚Äãunification is the generation of initializers for a specific type of object and a specific set of attributes.  To initialize an object, we request the necessary initializer and pass an object instance and data to it, the initializer does the rest.  The initializer can be generated by code generation, or it can be passed on to the compiler using anonymous delegates. <br><br>  Test class: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestObject1</span></span> { [Clone, DataValue(<span class="hljs-string"><span class="hljs-string">"Root/IntValue"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Value1; [DataValue(<span class="hljs-string"><span class="hljs-string">"Root/StringValue"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value2; [Clone, WidgetName(<span class="hljs-string"><span class="hljs-string">"Test1"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Widget Widget3; }</code> </pre><br>  A container will be created for the test class, inside which there are 3 initializers: <br><ul><li>  Two delegate cloning initializer for Value1 and Widget3 fields </li><li>  Serializer initializer with two delegates for fields Value1 and Value2 </li><li>  Bind initializer with one delegate to the Widget3 field </li></ul><br>  Test class and container created with initializers: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/9f7/870/dcb/9f7870dcbe089de5254ab4f462db2994.png"><br><br><h2>  Implementation </h2><br>  The current implementation is a demonstration, does not adhere to any principles, does not handle errors and is not thread-safe.  The main task of the implementation is to demonstrate the operation of the system. <br><br><h4>  Base Attribute Class </h4><br>  The delegates for the field are generated within attributes.  All custom attributes are inherited from the FieldSetterAttribute attribute and override the Generate method, where the delegate is generated and added to the initializer list. <br><div class="spoiler">  <b class="spoiler_title">Source</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; [AttributeUsage(AttributeTargets.Field, AllowMultiple = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">FieldSetterAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">Attribute</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Initialiser initialiser, FieldInfo info</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br></div></div><br><h4>  Initializer </h4><br>  The task of the initializer is to keep in itself a list of delegates of a specific set of initialization and execute it on demand. <br><div class="spoiler">  <b class="spoiler_title">Source</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitialiseHandle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> target, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Initialiser</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">InitialiseHandle handle</span></span></span><span class="hljs-function">)</span></span> { handlers.Add(handle); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialise</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> target, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (InitialiseHandle handler <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> handlers) handler(target, data); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;InitialiseHandle&gt; handlers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;InitialiseHandle&gt;(); }</code> </pre><br></div></div><br><h4>  Container </h4><br>  The container contains all initializers for the same user-defined class type.  Access to the initializer occurs by the type of attribute. <br><div class="spoiler">  <b class="spoiler_title">Source</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Container</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Initialiser </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetInitialiser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type type</span></span></span><span class="hljs-function">)</span></span> { Initialiser result; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!initialisers.TryGetValue(type, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> result)) { result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Initialiser(); initialisers.Add(type, result); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Dictionary&lt;Type, Initialiser&gt; initialisers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Type, Initialiser&gt;(); }</code> </pre><br></div></div><br><h4>  Type manager </h4><br>  The type manager contains the created containers for the custom types being processed.  The generation of containers occurs upon request and is performed only once. <br><div class="spoiler">  <b class="spoiler_title">Source</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TypeManager</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Container </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetContainer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type type</span></span></span><span class="hljs-function">)</span></span> { Container result; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!containers.TryGetValue(type, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> result)) { result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Container(); containers.Add(type, result); InitialiseContainer(type, result); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitialiseContainer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type type, Container container</span></span></span><span class="hljs-function">)</span></span> { FieldInfo[] fields = type.GetFields( BindingFlags.FlattenHierarchy | BindingFlags.Instance | BindingFlags.Public | BindingFlags.NonPublic); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (FieldInfo field <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fields) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (FieldSetterAttribute item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> field.GetCustomAttributes( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(FieldSetterAttribute), <span class="hljs-literal"><span class="hljs-literal">false</span></span>)) { Initialiser initialiser = container.GetInitialiser(item.GetType()); item.Generate(initialiser, field); } } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Dictionary&lt;Type, Container&gt; containers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Type, Container&gt;(); }</code> </pre><br></div></div><br><h4>  Principle of operation </h4><br>  The system user creates his attribute, inheriting it from the FieldSetterAttribute and overrides the Generate method.  The Initialiser initializer associated with the user attribute type and fieldInfo information is passed to the Generate method.  Inside the method, the user must create an anonymous delegate that performs the necessary operations on the field and adds it to the initializer. <br>  When a container is requested for a user type, it is searched and, if it is not found, the generation of the container and all initializers for the user type is started.  To do this, all fields are bypassed and if they have an attribute derived from FieldSetterAttribute, then the Generate method is called.  After that, information about initializers is stored in the container, and the container is stored in the manager. <br>  To use an initializer, it is necessary to query it by attribute type from the container and call the Initialise method, passing an instance of the class and the necessary data to it.  After that, all delegates created for this initializer will be called. <br><br><h4>  Example of custom attribute implementation </h4><br>  After understanding the principles of the system, we can implement custom attributes for our test type TestObject1.  The new test type is called TestObject2. <br><div class="spoiler">  <b class="spoiler_title">Source</b> <div class="spoiler_text">  Test class implementation: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestObject2</span></span> : <span class="hljs-title"><span class="hljs-title">Form</span></span>, <span class="hljs-title"><span class="hljs-title">ICloneable</span></span> { [Clone, DataValue(<span class="hljs-string"><span class="hljs-string">"Root/IntValue"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Value1; [DataValue(<span class="hljs-string"><span class="hljs-string">"Root/StringValue"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value2; [Clone(Deep = <span class="hljs-literal"><span class="hljs-literal">true</span></span>), WidgetName(<span class="hljs-string"><span class="hljs-string">"Test1"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Widget Widget3; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clone</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> clone = Activator.CreateInstance(GetType()); TypeManager.GetContainer(GetType()). GetInitialiser(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CloneAttribute)).Initialise(clone, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> clone; } }</code> </pre><br>  Implementing a cloning-enabled widget: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Widget</span></span> : <span class="hljs-title"><span class="hljs-title">ICloneable</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clone</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Widget(); } }</code> </pre><br>  Form implementation: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Form</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialise</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { TypeManager.GetContainer(GetType()). GetInitialiser(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(WidgetNameAttribute)).Initialise(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Widget </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindWidget</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Widget(); } }</code> </pre><br>  The implementation of the attribute to bind: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; [AttributeUsage(AttributeTargets.Field, AllowMultiple = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WidgetNameAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">FieldSetterAttribute</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WidgetNameAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Initialiser initialiser, FieldInfo info</span></span></span><span class="hljs-function">)</span></span> { initialiser.Add( <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> target, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> data) { Form targetForm = (Form)target; Widget widget = targetForm.FindWidget(name); info.SetValue(targetForm, widget); } ); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name; }</code> </pre><br>  The implementation of the attribute for serialization: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Xml; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; [AttributeUsage(AttributeTargets.Field, AllowMultiple = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DataValueAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">FieldSetterAttribute</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataValueAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { parsers[<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)] = <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.Parse(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); }; parsers[<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)] = <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataValueAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> xPath</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.xPath = xPath; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Initialiser initialiser, FieldInfo info</span></span></span><span class="hljs-function">)</span></span> { ParseHandle parser = parsers[info.FieldType]; initialiser.Add( <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> target, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> data) { XmlNode node = ((XmlNode)data).SelectSingleNode(xPath); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = parser(node.InnerText); info.SetValue(target, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } ); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> xPath; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParseHandle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Dictionary&lt;Type, ParseHandle&gt; parsers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Type, ParseHandle&gt;(); }</code> </pre><br>  Implementing an attribute for cloning: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; [AttributeUsage(AttributeTargets.Field, AllowMultiple = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CloneAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">FieldSetterAttribute</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Initialiser initialiser, FieldInfo info</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (deep) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info.FieldType.IsArray) { initialiser.Add( <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> target, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> data) { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = info.GetValue(data); Array oldArray = (Array)<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; Array newArray = (Array)oldArray.Clone(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index = <span class="hljs-number"><span class="hljs-number">0</span></span>; index &lt; oldArray.Length; index++) newArray.SetValue(((ICloneable)oldArray.GetValue(index)). Clone(), index); <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = newArray; info.SetValue(target, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { initialiser.Add( <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> target, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> data) { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = info.GetValue(data); <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = ((ICloneable)<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>).Clone(); info.SetValue(target, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } ); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { initialiser.Add( <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> target, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> data) { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = info.GetValue(data); info.SetValue(target, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } ); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Deep { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> deep; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { deep = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> deep; }</code> </pre><br></div></div><br><h2>  Total </h2><br>  As you can see from the examples, initializers can be called both inside the classes and outside.  Complex assignments can be broken down into simple ones, since we know all the field parameters before we create the delegate.  The request for fields and attributes occurs once.  All work with attributes is monotonous. <br>  The system can be extended to support properties, methods, events, and classes. </div><p>Source: <a href="https://habr.com/ru/post/168477/">https://habr.com/ru/post/168477/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../168463/index.html">Explanation of the situation with the forbidden registry. About the meeting in Roskomnadzor</a></li>
<li><a href="../168467/index.html">Cackle - Affiliate Program</a></li>
<li><a href="../168471/index.html">Correct transition from the old domain to the new one</a></li>
<li><a href="../168473/index.html">The impact of data bus loading on application scalability</a></li>
<li><a href="../168475/index.html">Marketing from Blizzard Entertainment</a></li>
<li><a href="../168483/index.html">5 Practical Tips for Using Lithium-Ion Batteries</a></li>
<li><a href="../168485/index.html">The dark side of the code</a></li>
<li><a href="../168487/index.html">Ordinary screen user: who is he?</a></li>
<li><a href="../168491/index.html">How to use the Instruments utility in Xcode</a></li>
<li><a href="../168493/index.html">7 steps to successfully migrate the SharePoint 2007 portal to SharePoint 2010</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>