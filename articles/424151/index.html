<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Labeling machine for labels - unwrap cylindrical distortion programmatically</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In our application, there is a feature, like vivino 's mother‚Äôs son‚Äôs mother‚Äôs son - the definition of wine from a photo. Under the hood - the use of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Labeling machine for labels - unwrap cylindrical distortion programmatically</h1><div class="post__text post__text-html js-mediator-article">  In our application, there is a feature, like vivino <s>'s mother‚Äôs son‚Äôs mother‚Äôs</s> son - the definition of wine from a photo.  Under the hood - the use of third-party services, Tineye - to determine the most appropriate label, Google Vision - to read the text on it.  The latter is necessary in order to clarify the correct product, because  Image search does not take into account the importance of some regions, as a rule - this is text information - the year and type of wine. <br><br>  However, the accuracy of both services is markedly reduced due to the fact that the label is distorted by a cylindrical surface. <br><br>  This is especially noticeable in Google Vision - any text outside the center of the label is practically unreadable, although a person easily recognizes it.  In this article I will describe how to reverse the distortion and increase the accuracy of product recognition. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/hk/-j/2p/hk-j2p_wkudj1asrh2yllwxcsxc.png"><br><a name="habracut"></a><br>  First of all, consider what distortion is. <br><br><img src="https://habrastorage.org/webt/uz/gv/n4/uzgvn4oircmh2r_suij8ofrlrh0.png"><br><br>  The rectangular label, when pasted on the cylinder, has a characteristic barrel shape (b in the diagram above).  The ABC curve in this case, in a rather good approximation, is an ellipse, since  we see a circle (section of the cylinder) at an angle.  The set of horizontal lines of the label is similarly transformed into a set of ellipses in the photo. <br><br>  The most interesting thing is that to expand the label, it is enough to specify 6 markers (ABCDEF): <br><br><img src="https://habrastorage.org/webt/t2/la/hy/t2lahys1qkcr3-la-6ox-bc0cte.jpeg"><br><br>  And using them, build a complete surface mesh: <br><br><img src="https://habrastorage.org/webt/b_/om/cc/b_omcchhgmjdtfrxahvm9po67wq.jpeg"><br><br>  Having a mesh surface, we can expand each tile separately, and get the original surface: <br><br><img src="https://habrastorage.org/webt/up/j8/th/upj8thigpw-fwm_i1a8xmfxx2hg.jpeg"><br><br>  <a href="https://github.com/Nepherhotep/unwrap_labels">The library code is available on github</a> .  The convenience of this method is that the input parameters for the inverse transformation are the visually definable characteristics of the label (corners and upper, lower points), which allows you to fully automate the process. <br><br>  The next part is devoted to the definition of markers.  The working code is available only partially in the <a href="https://github.com/Nepherhotep/unwrap_labels/tree/detect_ellipses">branch on the github</a> , since  A really working solution is covered with hacks and shamanism, so putting such tin into a githab simply does not allow conscience. <br><br>  Stage one - we convert the image into a black and white version. <br><br>  Then you need to get the contours of the bottle with the label.  For this we use the <a href="https://en.wikipedia.org/wiki/Sobel_operator">transformation sobel</a> .  In short, this filter first blurs the image and then subtracts it from the original one.  As a result, the uniform areas remain dark, and the edges (changes) are bright. <br><br><img src="https://habrastorage.org/webt/jb/cm/rx/jbcmrxypeavsjx7e4f_hkto_c1s.jpeg"><br><br>  The next thing to do is to identify the two most visible vertical lines that, if lucky, are the edges of the bottle.  In this case, this is the case, but if you photograph a bottle standing next to other bottles, then this is no longer the case. <br><br>  To define these lines, use <a href="https://en.wikipedia.org/wiki/Hough_transform">the Hough transform</a> .  The essence of the technique is that we take a lot of lines going across the entire screen, and count the average value of the pixels (for example, we take the lines going from the top of the picture to the bottom).  We transfer these values ‚Äã‚Äãto a new coordinate plane and get something like a heat map.  On this heat map we are looking for two extremums - they are the side lines. <br><br>  The diagram below shows how the left line goes to a point on the new coordinate plane: <br><br><img src="https://habrastorage.org/webt/d2/1b/qz/d21bqzk-hlfbfg7n43esn0_x2ey.png"><br><br>  With ellipses it is a bit more complicated, but knowing that the Hough transform can be applied to any mathematically defined curves, we will use this method again, but this time we will look for a set of elliptical curves. <br><br>  But first you need to bring the problem to a two-dimensional form.  Knowing that the bottle is centrally symmetric, we take the central axis for the Y coordinate, and one of the sides for the X. As the values ‚Äã‚Äãon the new coordinate plane, we take the set of ellipses built between the central axis and the side.  This is possible due to the fact that an arbitrary point of the side and the central axis have only one connection method.  Perhaps this is not very obvious at first glance, but much easier to understand if we turn to the parametric formula of an ellipse: <br><br>  x = a * cos (t) <br>  y = b * sin (t) <br><br><img src="https://habrastorage.org/webt/kk/st/pk/kkstpkiy3-opp98_zabantk4lmc.jpeg"><br><br>  In exactly the same way, we find two sought extremums that define two ellipse labels (curves AB, FE).  Now that we have all the necessary label parameters (side curves, as well as upper and lower ellipses), we can apply the algorithm from the first part of the article and perform the inverse transformation. <br><br>  What can be improved.  First, the algorithm does not take into account the distortion of the perspective of the ellipse itself, as a result, the side label fragments stretch a little more than they should.  To make a correction, you need to know the real angle of the camera, or, at least, use the most typical for the phone (you can choose empirically). <br><br>  Secondly, the Hough transformation is rather unstable working in difficult conditions ‚Äî for example, when bottles are placed next to the frame, and the edges of the bottle of interest can be determined incorrectly. <br><br>  Third, if the label is not rectangular (for example, elliptical), then the markers will be defined incorrectly, and the transformation will only distort the image more. <br><br>  In practice, it is much more interesting to use a neural network to define markers, since  it can be trained using complex examples, so that, at a minimum, the algorithm does not perform the transformation, if the markers cannot be determined.  But so far I have not tried to use neuron for this task, so maybe this will be the topic of a separate article :) </div><p>Source: <a href="https://habr.com/ru/post/424151/">https://habr.com/ru/post/424151/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424139/index.html">The most common mistakes and misconceptions when configuring DFSR</a></li>
<li><a href="../424141/index.html">Game design in life. Game Economics (Part I)</a></li>
<li><a href="../424143/index.html">The digest of interesting materials for the mobile developer # 271 (September 17 - 23)</a></li>
<li><a href="../424147/index.html">Telltale everything. It's a pity</a></li>
<li><a href="../424149/index.html">‚ÄúWatercolor‚Äù frequency 96 fps: revolution or format revolt in cinematography</a></li>
<li><a href="../424153/index.html">(Un) moving to Moldova</a></li>
<li><a href="../424155/index.html">The series "First": The Dark Side of Cosmonautics</a></li>
<li><a href="../424157/index.html">SDKMAN - Dead, Long Live SDKMAN</a></li>
<li><a href="../424159/index.html">Descent stations of the Hayabusa 2 mission successfully landed on the surface of the asteroid 1999 JU3</a></li>
<li><a href="../424161/index.html">Forensic resistance 1 or Last ActivityView. Data on user activity in Windows 10 and how to remove them</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>