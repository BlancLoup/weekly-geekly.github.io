<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Organization of interaction architecture Activity and Service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings 

 Today I decided to tell you my way of organizing the activity-service interaction in Android applications. The topic is motivated by the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Organization of interaction architecture Activity and Service</h1><div class="post__text post__text-html js-mediator-article">  Greetings <br><br>  Today I decided to tell you my way of organizing the activity-service interaction in Android applications.  The topic is motivated by the fact that quite often you can find applications in which, say, a hike to a server is organized inside an AsyncTask activity.  In this case, the correct idea is often encountered that it should be done in services, but nowhere in the office.  There is not a word about the documentation about the organization of the correct architecture of bilateral interaction between them. <br><br>  Therefore, by trial and error, I came to an architecture that, for me personally, covers all the necessary questions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will discuss this method further. <br><a name="habracut"></a><br><h4>  Bird's-eye </h4><br>  Let's first look at the high-level picture of the proposed architecture. <br><img src="https://habrastorage.org/storage2/b71/cfe/358/b71cfe358beac820c2059404c6cd9d57.png"><br>  Further in the article I will use two terms - controlled and uncontrolled feedback.  These are informal terms, but I will use them, because I like them.  Managed - these are notifications implemented by the Android platform for us (ContentProvider + ContentObserver system).  In order for the UI to receive managed notifications, we do not need anything, except for a correctly implemented provider. <br><br>  Much more interesting is how uncontrollable notifications are implemented, that is, those implemented using our system of events.  After all, it is not always that some operation in the service is associated with writing to the provider, so we need our own mechanism for notifying the client that the service has completed. <br><br>  So, this architecture implies the presence of four main components of the system: <br><ul><li>  An activity that performs the standard interface mapping role. </li><li>  Service - a service that performs heavy work in the background thread. </li><li>  ServiceHelper is our component that will stick together our activites and services and provide unmanaged notifications. </li><li>  ContentProvider is optional, depending on your UI component, which will help implement managed notifications. </li></ul><br><br><h4>  Service </h4><br>  Our service serves as a command processor. <br><br>  Each incoming intent carries in extras: <br><ul><li>  Action to be performed </li><li>  Team-defined arguments </li><li>  ResultReceiver </li></ul><br>  The service looks at the passed action, assigns to it the command to be executed, and passes the arguments and the ResultReceiver to the command. <br><br>  The easiest way to implement the service: <br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onHandleIntent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ String action = intent.getAction(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!TextUtils.isEmpty(action)) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ResultReceiver receiver = intent.getParcelableExtra(EXTRA_STATUS_RECEIVER); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (AwesomeHandler.ACTION_AWESOME_ACTION.equals(action)) { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AwesomeHandler().execute(intent, getApplicationContext(), receiver); } <span class="hljs-comment"><span class="hljs-comment">// ..... } }</span></span></code> </pre> <br>  Here, in the large if block, the desired command is simply searched.  It is clear, here you can be bent as you please to avoid ifa: keep the Map action-handler, make a factory, use IoC, etc., but this is beyond the scope of the article. <br><br><h5>  Handler </h5><br>  Handlers encapsulate the procedure being executed.  In my case, they form a certain hierarchy, where the base class looks like: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseIntentHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SUCCESS_RESPONSE = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> FAILURE_RESPONSE = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent intent, Context context, ResultReceiver callback)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.callback = callback; doExecute(intent, context, callback); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doExecute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent intent, Context context, ResultReceiver callback)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ResultReceiver callback; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resultCode, Bundle data)</span></span></span><span class="hljs-function"> </span></span>{ result = resultCode; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (callback != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { callback.send(resultCode, data); } } }</code> </pre><br>  the next level of hierarchy I implemented a basic command that performs the preparation of the http request, but this, again, is beyond the scope of the article.  In general, you inherit from the base command and implement doExecute, in which, if necessary, call the sendUpdate method, pass the code (success / error) and Bundle with the data. <br><br><h4>  Servicehelper </h4><br>  ServiceHelper is an intermediate layer between the UI and the service, simplifying calls to the service for the UI, and performing routine intent packaging tasks.  It also coordinates coordinates from the service and contains information about the commands that are currently running. <br><br>  So, how it works: <br><ul><li>  UI invokes the helper method, the helper returns the request ID </li><li>  Helper remembers request ID </li><li>  Collects an intent into which the ResultReceiver inserts and sends it to the service. </li><li>  when the service completes the operation, all listening UI components are notified in onReceiveResult </li></ul><br><br>  Let's look at the code: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceHelper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayList&lt;ServiceCallbackListener&gt; currentListeners = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;ServiceCallbackListener&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AtomicInteger idCounter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AtomicInteger(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SparseArray&lt;Intent&gt; pendingActivities = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SparseArray&lt;Intent&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Application application; ServiceHelper(Application app) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.application = app; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServiceCallbackListener currentListener)</span></span></span><span class="hljs-function"> </span></span>{ currentListeners.add(currentListener); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServiceCallbackListener currentListener)</span></span></span><span class="hljs-function"> </span></span>{ currentListeners.remove(currentListener); } <span class="hljs-comment"><span class="hljs-comment">// .....</span></span></code> </pre><br>  Service helper keeps a list of subscribers in an array, it is on this list will be sent notifications on the work of teams. <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Intent </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createIntent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Context context, String actionLogin, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestId)</span></span></span><span class="hljs-function"> </span></span>{ Intent i = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(context, WorkerService.class); i.setAction(actionLogin); i.putExtra(WorkerService.EXTRA_STATUS_RECEIVER, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ResultReceiver(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Handler()) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceiveResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resultCode, Bundle resultData)</span></span></span><span class="hljs-function"> </span></span>{ Intent originalIntent = pendingActivities.get(requestId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isPending(requestId)) { pendingActivities.remove(requestId); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (ServiceCallbackListener currentListener : currentListeners) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentListener != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { currentListener.onServiceCallback(requestId, originalIntent, resultCode, resultData); } } } } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i; }</code> </pre><br>  This is a general method for creating our intent, which we will send to the service. <br>  A more interesting place is pendingActivities - this is the register of all currently running tasks on the service.  Because when we call the ServiceHelper method, we get an id, we can always find out if the command is running or not.  More on this - later in the article. <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isPending</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pendingActivities.get(requestId) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> idCounter.getAndIncrement(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestId, Intent i)</span></span></span><span class="hljs-function"> </span></span>{ pendingActivities.append(requestId, i); application.startService(i); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> requestId; }</code> </pre><br>  Now an example of a public method that will perform some action on our service: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doAwesomeAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> personId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> requestId = createId(); Intent i = createIntent(application, AwesomeHandler.ACTION_AWESOME_ACTION, requestId); i.putExtra(AwesomeHandler.EXTRA_PERSON_ID, personId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> runRequest(requestId, i); }</code> </pre><br>  and there will be exactly as many such methods sticking out, as many commands are supported by your service. <br><br><h4>  Activity </h4><br>  So, as I said, we have an interface: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceCallbackListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onServiceCallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestId, Intent requestIntent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resultCode, Bundle data)</span></span></span></span>; }</code> </pre><br>  I believe that it is convenient to implement this interface in the base abstract activit.  Then in specific activations you only need to override the onServiceCallback method to receive notifications, which is very similar to the standard callback methods in the activity, i.e., it fits gracefully into your client code. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AwesomeBaseActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FragmentActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceCallbackListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ServiceHelper serviceHelper; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> AwesomeApplication </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getApp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (AwesomeApplication ) getApplication(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); serviceHelper = getApp().getServiceHelper(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResume</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onResume(); serviceHelper.addListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPause</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onPause(); serviceHelper.removeListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ServiceHelper </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getServiceHelper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> serviceHelper; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onServiceCallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestId, Intent requestIntent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resultCode, Bundle resultData)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre><br>  Notice how the activation subscribes and unsubscribes from ServiceHelper in its onResume / onPause methods.  This allows you to avoid problems when recreating the activation, for example, when you rotate the screen, or minimize the application. <br><br>  Let's consider what comes to the onServiceCallback method: <br><ul><li>  requestId - a unique identifier generated when sending a request </li><li>  requestIntent - the original intent we sent </li><li>  resultCode - the result code of the execution </li><li>  resultData - data </li></ul><br>  Now, we have everything we need so that in our activity we can always receive a notification from our service without a heap of boilerplate code. <br>  Moreover, it seems to me very useful - we can identify both a specific request by ID and all requests of the same type by action, which gives us tremendous flexibility. <br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AwesomeActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AwesomeBaseActivity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> superRequestId; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ superRequestId = getServiceHelper().doAwesomeAction(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onServiceCallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestId, Intent requestIntent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resultCode, Bundle resultData)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (AwesomeHandler.ACTION_AWESOME_ACTION.equals(requestIntent.getAction()) { <span class="hljs-comment"><span class="hljs-comment">//   } if (requestId == superRequestId) { //   } } }</span></span></code> </pre><br>  Also, having a request ID, we can perform a pending check.  Imagine the sequence: <br><ul><li>  user started the action, started the spinner </li><li>  closed the application for 2 minutes </li><li>  the action has already been completed </li><li>  user opened again </li><li>  here we check in onResume whether the operation was completed, and remove the twist </li></ul><br>  that is, just call getServiceHelper (). isPending (requestId) if we need it. <br><br><h4>  Conclusion </h4><br>  Here, perhaps, that's all. <br><br>  I must say at once that I do not claim for the universality of this architecture or for some of its uniqueness.  She was slowly derived by me through trial and error, views of various materials, etc. But for now, she covers 100% of all my needs in real commercial projects. <br><br>  Moreover, if something is missing, it can be easily expanded.  From the obvious: <br><ul><li>  In addition to the success and failure code, add progress code, then from the service it will be possible to transfer information about the progress of the task and display it in, say, ProgressBar </li><li>  fasten code to interrupt the task in progress </li><li>  etc. </li></ul><br>  One more detail, my ServiceHelper code is not synchronized, since it is assumed that its methods will always be called in UI thread.  If this is not the case for you, then <b>it is necessary to add synchronization in case of any change in the state of ServiceHelper</b> . <br><br>  In general, thank you for your attention, I hope someone will help.  Ready to answer your questions and comments in the comments. <br><br>  <b>UPD</b> : Laid out a small sandbox example illustrating the architecture on GitHub: <a href="https://github.com/TheHiddenDuck/android-service-arch">https://github.com/TheHiddenDuck/android-service-arch</a> <br><br>  <b>UPD 2</b> : Added an example implementation of a service running on a thread pool </div><p>Source: <a href="https://habr.com/ru/post/144275/">https://habr.com/ru/post/144275/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144267/index.html">Sudden May Update</a></li>
<li><a href="../144268/index.html">Node.js on Fidonet: read javascript echomail headers stored in JAM format</a></li>
<li><a href="../144270/index.html">Photo report about connecting the most powerful switch in the world Black Diamond X8</a></li>
<li><a href="../144271/index.html">Earn on your hobby!</a></li>
<li><a href="../144274/index.html">Your main desktop environment in linux</a></li>
<li><a href="../144277/index.html">We write REST application on Sinatra and we fasten Redactor. Part 1</a></li>
<li><a href="../144278/index.html">Secret Room at Pixar Animation Studio</a></li>
<li><a href="../144280/index.html">Augmented Reality is Easy</a></li>
<li><a href="../144281/index.html">A look into the future</a></li>
<li><a href="../144282/index.html">Secure authentication between client and server without entering username and password</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>