<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Math on the fingers: linear-quadratic controller</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A couple of hours from the life of a mathematician programmer or read Wikipedia 
 To begin with, I quote rocknrollnerd as an epigraph: 
 - Hello, my n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Math on the fingers: linear-quadratic controller</h1><div class="post__text post__text-html js-mediator-article"><h1>  A couple of hours from the life of a mathematician programmer or read Wikipedia </h1><br>  To begin with, <a href="https://habrahabr.ru/post/277275/">I quote</a> <a href="https://habrahabr.ru/users/rocknrollnerd/" class="user_link">rocknrollnerd</a> as an epigraph: <br><blockquote>  - Hello, my name is% username%, and secretly open the amount of sigma notation on a piece of paper to understand what is happening there. <br>  - Hi% username%! <br></blockquote><br><br>  So, as I said in my last article, I have students who are afraid of mathematics in <b>panic</b> , but as a hobby, they pick at a soldering iron and now they want to assemble a segway cart.  They collected something, but she does not want to keep balance.  They thought to use the <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%2598%25D0%2594-%25D1%2580%25D0%25B5%25D0%25B3%25D1%2583%25D0%25BB%25D1%258F%25D1%2582%25D0%25BE%25D1%2580">PID controller</a> , but they just did not manage to pick up the coefficients to make it work well.  They came to me for advice.  And I have never been a boom boom at all in control theory, I have never come close.  But once on Habr√©, I saw <a href="https://habrahabr.ru/post/220989/">an article</a> that said that the linear-quadratic regulator helped the author, but did not help. <br><br>  If I still imagine the FID on my fingers ( <a href="https://geektimes.ru/post/255598/">here‚Äôs my article</a> , which I transferred from some kind of fright to hypertext), then I didn‚Äôt even hear about other control methods.  So, my task is to imagine (and explain to students, and at the same time to you) what a linear-quadratic regulator is.  So far, there will be no work with iron, I‚Äôll just show you how I work with literature, because this is exactly the lion‚Äôs share of my work. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since exhibitionism about my work has gone, here is my workplace (clickable): <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/ee8/3aa/1c9/ee83aa1c90a86a6a0ecc672c4af5d1de.jpg"></a> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/eb8/b66/71b/eb8b6671bc0fc4cda673e207071553ea.jpg"></a> <br><a name="habracut"></a><br><h1>  Sources used </h1><br>  So, the first thing I do is go to <a href="https://en.wikipedia.org/wiki/Linear-quadratic_regulator">Wikipedia</a> .  Russian Wikipedia is cruel and merciless, therefore we read only English text.  He, too, is disgusting, but still not so much.  So, we read.  Of all the introductory bricks of the text, only one phrase interested me: <br><blockquote>  Operating system of the system.  The problem is that the system is called the LQ problem. </blockquote><br><br>  Translated into Russian, they say that they model a certain dynamic system with differential equations (oh, horror), and they choose control directly, minimizing some kind of quadratic function (oh, I feel the approximation of least squares).  So good.  We are trying to read further: <br><br><blockquote>  Finite-horizon, continuous-time LQR, <br>  [a series of horrible formulas] </blockquote><br><br>  We skip it, well, it‚Äôs like reading into a swamp, besides, it‚Äôs obviously disgusting to use hands to count continuous functions. <br><br><blockquote>  Infinite-horizon, continuous-time LQR, <br>  [a series of even more awful formulas] </blockquote><br><br>  Hour of the hour is not easier, more and improper integrals have gone, we skip, all of a sudden we will find something interesting. <br><br><blockquote>  Finite-horizon, discrete-time LQR </blockquote><br><br>  Oh, I love it.  We have a discrete system, we look at its state at certain intervals (some intervals in the first reading are always equal to one second) of time.  Derivatives of the equation are gone, because  they can now be approximated as (x_ {k + 1} -x_ {l}) / 1 second.  Now it would be nice to understand what x_k is. <br><br><h1>  One dimensional example </h1><br>  Feynman wrote exactly how he read all the equations, that he accounted for: <br><blockquote>  Actually, there was a certain amount.  I had a scheme, which I am today <br>  something that i'm trying to understand: i keep making up examples.  For instance, the mathematicians would come in with a terrific theorem, and they're all excited.  I construct something which fits all the conditions.  You know, you have a set (one ball) - disjoint (two balls).  There are more conditions on.  Finally, I‚Äôm saying, ‚ÄúFalse!‚Äù </blockquote><br><br>  Well, what are we, steeper than Feynman?  Personally, I do not.  So let's do it.  There is a car traveling with a certain initial speed.  The task to accelerate it to a certain final speed, while the only thing we can influence is the gas pedal, that is, to accelerate the car. <br><br>  Let's imagine a car is perfect and moves according to this law: <br><img src="https://habrastorage.org/getpro/habr/post_images/113/a11/ef1/113a11ef17abaa67799fa919286d352b.png"><br><br>  x_k is the speed of the car per second k, u_k is the position of the gas pedal, which we want, we can interpret it as acceleration per second k.  So, we start with a certain speed x_0, and then we perform here such numerical integration (into which words we went).  Note that I do not add m / s and m / s ^ 2, u_k is multiplied by one second between the measurements.  By default, I have all the coefficients either zero or one. <br><br>  So, in order to understand what is going on, I write <a href="https://github.com/ssloy/tutorials/tree/2ac7a4d03f2dfb4ee4d26431d89f8e0dff81eaf5/tutorials/lqr">such code here</a> (I write <b>a</b> lot of one-time code that I throw out immediately after writing).  I am listing here just in case, as usual, I use <a href="http://alice.loria.fr/index.php/software/4-library/23-opennl.html">OpenNL</a> to solve large sparse linear systems of equations. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre><code class="hljs lua">#include &lt;iostream&gt; #include <span class="hljs-string"><span class="hljs-string">"OpenNL_psm.h"</span></span> int main() { const int N = <span class="hljs-number"><span class="hljs-number">60</span></span>; const double xN = <span class="hljs-number"><span class="hljs-number">2.3</span></span>; const double x0 = <span class="hljs-number"><span class="hljs-number">.5</span></span>; const double hard_penalty = <span class="hljs-number"><span class="hljs-number">100.</span></span>; nlNewContext(); nlSolverParameteri(NL_NB_VARIABLES, N*<span class="hljs-number"><span class="hljs-number">2</span></span>); nlSolverParameteri(NL_LEAST_SQUARES, NL_TRUE); nlBegin(NL_SYSTEM); nlBegin(NL_MATRIX); nlBegin(NL_ROW); // x0 = x0 nlCoefficient(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); nlRightHandSide(x0); nlScaleRow(hard_penalty); nlEnd(NL_ROW); nlBegin(NL_ROW); // xN = xN nlCoefficient((N<span class="hljs-number"><span class="hljs-number">-1</span></span>)*<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); nlRightHandSide(xN); nlScaleRow(hard_penalty); nlEnd(NL_ROW); nlBegin(NL_ROW); // uN = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> convenience, normally uN is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> defined nlCoefficient((N<span class="hljs-number"><span class="hljs-number">-1</span></span>)*<span class="hljs-number"><span class="hljs-number">2</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); nlScaleRow(hard_penalty); nlEnd(NL_ROW); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;N<span class="hljs-number"><span class="hljs-number">-1</span></span>; i++) { nlBegin(NL_ROW); // x{i+<span class="hljs-number"><span class="hljs-number">1</span></span>} = xi + ui nlCoefficient((i+<span class="hljs-number"><span class="hljs-number">1</span></span>)*<span class="hljs-number"><span class="hljs-number">2</span></span> , <span class="hljs-number"><span class="hljs-number">-1</span></span>); nlCoefficient((i )*<span class="hljs-number"><span class="hljs-number">2</span></span> , <span class="hljs-number"><span class="hljs-number">1</span></span>); nlCoefficient((i )*<span class="hljs-number"><span class="hljs-number">2</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); nlScaleRow(hard_penalty); nlEnd(NL_ROW); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;N; i++) { nlBegin(NL_ROW); // xi = xN, soft nlCoefficient(i*<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); nlRightHandSide(xN); nlEnd(NL_ROW); } nlEnd(NL_MATRIX); nlEnd(NL_SYSTEM); nlSolve(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;N; i++) { std::cout &lt;&lt; nlGetVariable(i*<span class="hljs-number"><span class="hljs-number">2</span></span>) &lt;&lt; <span class="hljs-string"><span class="hljs-string">" "</span></span> &lt;&lt; nlGetVariable(i*<span class="hljs-number"><span class="hljs-number">2</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;&lt; std::endl; } nlDeleteContext(nlGetCurrent()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> </div></div><br><br>  So let's figure out what I'm doing.  For a start, I say N = 60, I take 60 seconds to everything.  Then I say that the final speed should be 2.3 meters per second, and the initial half meter per second, it is set from the bald.  I will have 60 * 2 variable variables - 60 values ‚Äã‚Äãof speed and 60 values ‚Äã‚Äãof acceleration (strictly speaking, acceleration should be 59, but it's easier for me to say that there are 60 of them, and the latter should be strictly zero). <br><br>  So I have 2 * N variables (N = 60), even variables (I start counting from scratch, like any normal programmer) is speed, and odd ones are acceleration.  I set the initial and final speed with these lines: <br>  In fact, I said that I want the initial speed to be x0 (.5m / s), and the final speed - xN (2.3m / s). <br><pre> <code class="hljs lisp"> nlBegin(<span class="hljs-name"><span class="hljs-name">NL_ROW</span></span>)<span class="hljs-comment"><span class="hljs-comment">; // x0 = x0 nlCoefficient(0, 1); nlRightHandSide(x0); nlScaleRow(hard_penalty); nlEnd(NL_ROW); nlBegin(NL_ROW); // xN = xN nlCoefficient((N-1)*2, 1); nlRightHandSide(xN); nlScaleRow(hard_penalty); nlEnd(NL_ROW);</span></span></code> </pre><br><br>  We know that x {i + 1} = xi + ui, so let's add N-1 such equation to our system: <br><br><pre> <code class="hljs objectivec"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;N<span class="hljs-number"><span class="hljs-number">-1</span></span>; i++) { nlBegin(NL_ROW); <span class="hljs-comment"><span class="hljs-comment">// x{i+1} = xi + ui nlCoefficient((i+1)*2 , -1); nlCoefficient((i )*2 , 1); nlCoefficient((i )*2+1, 1); nlScaleRow(hard_penalty); nlEnd(NL_ROW); }</span></span></code> </pre><br><br>  So, we have added all the hard constraints to the system, but what exactly, in fact, can we want to optimize?  Let's just start by saying that we want x_i to reach the final speed xN as soon as possible: <br><br><pre> <code class="hljs objectivec"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;N; i++) { nlBegin(NL_ROW); <span class="hljs-comment"><span class="hljs-comment">// xi = xN, soft nlCoefficient(i*2, 1); nlRightHandSide(xN); nlEnd(NL_ROW); }</span></span></code> </pre><br><br>  Well, our system is ready, strict rules for the transition between states are given, the quadratic function of the system quality too, let's shake the box and see what the smallest squares give us x_i, u_i as a solution (the red line is speed, green is acceleration): <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/2ac7a4d03f2dfb4ee4d26431d89f8e0dff81eaf5/tutorials/lqr/res.png"><br><br>  Oookey, we really sped up from half a meter per second to two meters a decimal point of three per second, but our system produced a lot of acceleration (which is logical, because we demanded to converge as soon as possible). <br><br>  And let's change ( <a href="https://github.com/ssloy/tutorials/tree/35d1a19d05ae92985edab129feac8dc62bb47d20/tutorials/lqr">here‚Äôs a commit</a> ) the objective function, instead of the fastest convergence, ask for the least possible acceleration: <br><br><pre> <code class="hljs objectivec"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;N; i++) { nlBegin(NL_ROW); <span class="hljs-comment"><span class="hljs-comment">// ui = 0, soft nlCoefficient(i*2+1, 1); nlEnd(NL_ROW); }</span></span></code> </pre><br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/35d1a19d05ae92985edab129feac8dc62bb47d20/tutorials/lqr/res.png"><br><br>  Hmm, now the car accelerates two meters per second for a full minute.  Ok, let's take a quick convergence to the final speed, and try a small acceleration ( <a href="https://github.com/ssloy/tutorials/tree/a704594dc6694352e121276ecc594a2b37ab75d6">commit here</a> )? <br><br><pre> <code class="hljs objectivec"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;N; i++) { nlBegin(NL_ROW); <span class="hljs-comment"><span class="hljs-comment">// ui = 0, soft nlCoefficient(i*2+1, 1); nlEnd(NL_ROW); nlBegin(NL_ROW); // xi = xN, soft nlCoefficient(i*2, 1); nlRightHandSide(xN); nlEnd(NL_ROW); }</span></span></code> </pre><br><br>  Aha, super, now it becomes beautiful: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/a704594dc6694352e121276ecc594a2b37ab75d6/tutorials/lqr/res.png"><br><br>  So, fast convergence and limitation of the control value are competing goals, of course.  Pay attention, at the moment I stopped at the first line of a Wikipedia paragraph, scary formulas go further, I do not understand them.  Often, reading articles is reduced to searching for keywords and the complete conclusion of all the results, using the mathematical device that I personally own. <br><br>  So what do we have at the moment?  The fact that having the initial state of the system + having the final state of the system + number of seconds, we can find the perfect control u_i.  This is good, only applies to segway.  Damn, how are they doing something?  So, read the following text in Wikipedia: <br><br><blockquote>  with a performance index defined as <br><br><img src="https://upload.wikimedia.org/math/0/e/b/0eb00584e4d086f23c60d4e0740b0bf2.png"><br><br>  minimizing the performance index is given by <br><br><img src="https://upload.wikimedia.org/math/6/b/4/6b43b4938520cf4ec39399f1666980f7.png"><br><br>  where [AAA, WHAT IS THERE SUCH AS WELL?] <br></blockquote><br><br>  So.  I do not understand that after the sign is equal in the formula "J = ...", but this is clearly a quadratic function that we tried.  Type, the earliest convergence to the goal, plus the lowest cost, we will take a closer look later, for now my understanding is enough for me. <br><br>  u_k = -F x_k.  Op-pa.  They say that for our one-dimensional example at any moment the optimal acceleration is some constant -F multiplied by the current speed?  Come on, come on.  But the truth is, green and red graphics are suspiciously similar to each other! <br><br>  Let's try to write real equations for our 1D example. <br><br>  So, we have a quality management function: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/lqr/doc/f01.png"><br><br>  We want to minimize it, while respecting the restrictions on the connection between adjacent values ‚Äã‚Äãof the speed of our car: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/lqr/doc/f02.png"><br><br>  Stop-stop-stop, and what the fuck is it worth on wikipedia x_k ^ TQ x_k?  After all, this is a simple x_k ^ 2 in our case, but we have (x_k-x_N) ^ 2 ?!  Fir-trees, but because they assume that the final state we want to hit <b>is the zero vector !!!</b>  WHAT IS CENSORED ABOUT THIS ON THE WHOLE WIKIPEDIA PAGE NO WORD?! <br><br>  Okay, breathe deeply, calm down.  Now I express all x_i in the wording of J through u_i, so as not to have restrictions.  Now my variables will be only the control vector.  So, we want to minimize the function J, which is written like this: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/lqr/doc/f03.png"><br><br>  Be hurt.  Now let's open the brackets (see the epigraph): <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/lqr/doc/f04.png"><br><br>  Dots here means any turbidity, which does not depend on u_0.  Since we are looking for a minimum, in order to find it, we need to equate zero all partial derivatives, but first I am interested in the partial derivative with respect to u_0: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/lqr/doc/f05.png"><br><br>  Total we get that optimal control will be optimal only when u_0 has the following expression: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/master/tutorials/lqr/doc/f06.png"><br><br>  Please note that this expression includes other unknowns u_i, but there is one ‚Äúbut‚Äù.  The joke is that I don‚Äôt want the car to accelerate to just two meters per second all the time.  I gave her a minute just as obviously enough time.  And I can give an hour.  The term depending on u_i, if it is rough, then this is all the work on acceleration, it does not depend on N.  Therefore, if N is large enough, then the optimal u_0 <b>linearly</b> depends only on how far x0 is from the final position! <br><br>  <b>That is, the control should look like this: we model the system, find the magic coefficient linearly connecting u_i and x_i, write it down, and then in our robot we simply make a linear proportional controller using the magic coefficient found!</b> <b><br></b> <br><br>  To be extremely honest, I didn‚Äôt write the code, of course, until now I‚Äôve done all of the above in mind and a little bit on paper.  But this does not negate the fact that I write a lot of one-time code. <br><br><h1>  2D example </h1><br><br>  As an intuition, this is fine, but <a href="https://github.com/ssloy/tutorials/tree/720a410dc3233d0468f8399887aa2153ff999cc1/tutorials/lqr">the first code</a> I actually wrote: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml">#include </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">iostream</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> #include </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">vector</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> #include "OpenNL_psm.h" int main() { const int N = 60; const double x0 = 3.1; const double v0 = .5; const double hard_penalty = 100.; const double rho = 16.; nlNewContext(); nlSolverParameteri(NL_NB_VARIABLES, N*3); nlSolverParameteri(NL_LEAST_SQUARES, NL_TRUE); nlBegin(NL_SYSTEM); nlBegin(NL_MATRIX); nlBegin(NL_ROW); nlCoefficient(0, 1); // x0 = 3.1 nlRightHandSide(x0); nlScaleRow(hard_penalty); nlEnd(NL_ROW); nlBegin(NL_ROW); nlCoefficient(1, 1); // v0 = .5 nlRightHandSide(v0); nlScaleRow(hard_penalty); nlEnd(NL_ROW); nlBegin(NL_ROW); nlCoefficient((N-1)*3, 1); // xN = 0 nlScaleRow(hard_penalty); nlEnd(NL_ROW); nlBegin(NL_ROW); nlCoefficient((N-1)*3+1, 1); // vN = 0 nlScaleRow(hard_penalty); nlEnd(NL_ROW); nlBegin(NL_ROW); // uN = 0, for convenience, normally uN is not defined nlCoefficient((N-1)*3+2, 1); nlScaleRow(hard_penalty); nlEnd(NL_ROW); for (int i=0; i</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">N-1;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlBegin</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NL_ROW</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">x</span></span></span></span><span class="xml"><span class="hljs-tag">{</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">} = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">xN</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">vN</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlCoefficient</span></span></span></span><span class="xml"><span class="hljs-tag">((</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">)*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag"> , </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlCoefficient</span></span></span></span><span class="xml"><span class="hljs-tag">((</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> )*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag"> , </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlCoefficient</span></span></span></span><span class="xml"><span class="hljs-tag">((</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> )*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlScaleRow</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hard_penalty</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlEnd</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NL_ROW</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlBegin</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NL_ROW</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">v</span></span></span></span><span class="xml"><span class="hljs-tag">{</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">} = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">vN</span></span></span></span><span class="xml"><span class="hljs-tag"> + </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">uN</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlCoefficient</span></span></span></span><span class="xml"><span class="hljs-tag">((</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">)*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlCoefficient</span></span></span></span><span class="xml"><span class="hljs-tag">((</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> )*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlCoefficient</span></span></span></span><span class="xml"><span class="hljs-tag">((</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> )*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlScaleRow</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hard_penalty</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlEnd</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NL_ROW</span></span></span></span><span class="xml"><span class="hljs-tag">); } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlBegin</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NL_ROW</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xi</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">soft</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlCoefficient</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlEnd</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NL_ROW</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlBegin</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NL_ROW</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">vi</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">soft</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlCoefficient</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlEnd</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NL_ROW</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlBegin</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NL_ROW</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ui</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">soft</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlCoefficient</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlScaleRow</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rho</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlEnd</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NL_ROW</span></span></span></span><span class="xml"><span class="hljs-tag">); } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlEnd</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NL_MATRIX</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlEnd</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NL_SYSTEM</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlSolve</span></span></span></span><span class="xml"><span class="hljs-tag">(); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">std::vector</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">double</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> solution; for (int i=0; i</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">3*N;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">solution.push_back</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlGetVariable</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">)); } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlDeleteContext</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">nlGetCurrent</span></span></span></span><span class="xml"><span class="hljs-tag">()); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">N</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag">++) { </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">std::cout</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">solution</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span></span><span class="xml"><span class="hljs-tag">] &lt;&lt; " "; } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">std::cout</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">std::endl</span></span></span></span><span class="xml"><span class="hljs-tag">; } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">return</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">; }</span></span></span></span></code> </pre><br></div></div><br><br>  Here everything is the same, only the system variables are now two: not only the speed, but also the coordinate of the machine. <br>  So, given the initial position + initial velocity (x0, v0), I need to reach the final position (0,0), stop at the origin. <br>  The transition from one moment to the next is carried out as x_ {k + 1} = x_k + v_k, and v_ {k + 1} = v_k + u_k. <br><br>  I have commented enough on the previous code, this one should not cause difficulties.  Here is the result of the work: <br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/720a410dc3233d0468f8399887aa2153ff999cc1/tutorials/lqr/res.png"><br><br>  The red line is the coordinate, the green line is the speed, and the blue line is directly the position of the ‚Äúgas pedal‚Äù.  Based on the previous one, it is assumed that the blue curve is a weighted sum of red and green.  Hmm, is this true?  Let's try to count! <br>  That is, theoretically, we need to find two numbers a and b, such that u_i = a * x_i + b * v_i.  And this is nothing but a linear regression, as we did in the last article!  Here is the <a href="https://github.com/ssloy/tutorials/tree/715887cc2835ac8a779e35e1e72c750bca8c7309/tutorials/lqr">code</a> . <br><br>  In it, I first find the curves in the picture above, and then look for such a and b, that the blue curve = a * red + b * is green. <br><br>  Here is the difference between the real u_i and the ones I got by folding the green and red lines: <br><img src="https://raw.githubusercontent.com/ssloy/tutorials/715887cc2835ac8a779e35e1e72c750bca8c7309/tutorials/lqr/res.png"><br><br>  Deviation of the order of one hundredth of a meter per second per second!  Cool!!!  The commit I gave gives a = -0.0513868, b = -0.347324.  The deviation is really small, but this is normal, I did not change the initial data. <br><br>  Now let's <a href="https://github.com/ssloy/tutorials/tree/108ddde79895fe6b14ffb25401690c7ab8006d81/tutorials/lqr">drastically change the</a> starting position and speed of the car, leaving the magic numbers a and b from the previous calculations. <br><br>  Here is the difference between the present optimal solution and the fact that we get the most dumbest procedure, let's give it once again completely: <br><pre> <code class="hljs cpp"> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> xi = x0; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> vi = v0; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;N; i++) { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> ui = xi*a + vi*b; xi = xi + vi; vi = vi + ui; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; (ui-solution[i*<span class="hljs-number"><span class="hljs-number">3</span></span>+<span class="hljs-number"><span class="hljs-number">2</span></span>]) &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; }</code> </pre><br><br><img src="https://raw.githubusercontent.com/ssloy/tutorials/108ddde79895fe6b14ffb25401690c7ab8006d81/tutorials/lqr/res.png"><br><br>  And no differential Riccati equations that Wikipedia offered us.  It is possible that I will have to read about them, but it will be later, when it burns.  In the meantime, simple quadratic functions suit me more than completely. <br><br><h1>  Dry residue </h1><br><br>  Total: to use it, there will be two main difficulties: <br>  a) find good transition matrices A and B, it will need to write kinematic equations, because, of course, everything will depend on the mass of objects and other things <br>  b) to find good coefficients of a compromise between the goals of the fastest descent to the goal, but at the same time also without making super efforts. <br><br>  If a and b do, then the method looks promising.  The only thing is that it requires a complete knowledge of the state of the system, which is not always the case.  For example, we don‚Äôt know the position of the segway, we can only guess about it, based on data from sensors like a gyroscope and an accelerometer.  Well, that's about it, I'll tell my students next time. <br><br>  So, I wanted to achieve three goals: <br>  a) understand what lqr is <br>  b) explain what students and you understand. <br>  c) show you and my students that I (like most people) don‚Äôt understand shit in mathematical texts, which is sad, but not at all disastrous.  We are looking for keywords to cling to, throwing out unnecessary, unnecessary methods and abstractions, and try to shove this into the framework of our current knowledge. <br><br>  Hope I managed.  Once again, I am not at all an expert in control theory, I have never seen her, if you have something to supplement and correct, do not hesitate. <br><br>  Enjoy! </div><p>Source: <a href="https://habr.com/ru/post/277671/">https://habr.com/ru/post/277671/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277655/index.html">Access MySQL data from a UWP application without using services</a></li>
<li><a href="../277657/index.html">Your cloud hosting in 5 minutes. Part 0: Virtualization</a></li>
<li><a href="../277663/index.html">What we should build LVM (principle of operation, performance, Thin Provision)</a></li>
<li><a href="../277665/index.html">Alternative to native support module in JIRA</a></li>
<li><a href="../277669/index.html">Java.util.concurrent. * Synchronizer reference</a></li>
<li><a href="../277673/index.html">Free Photoshop Script: Export Vector Layers from PSD to SVG</a></li>
<li><a href="../277675/index.html">Linux Mint distributions have been compromised</a></li>
<li><a href="../277677/index.html">We authenticate requests in the microservice application using nginx and JWT</a></li>
<li><a href="../277679/index.html">We write shell scripts in Python and is it possible to replace them with Bash</a></li>
<li><a href="../277681/index.html">Strategies to speed up code on R, part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>