<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The illusion of space: how the new Spiderman renders spaces without geometry</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the recently released Marvel's Spider-Man game, many buildings outside the windows have interiors. They look great, but they seem to have been impl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The illusion of space: how the new Spiderman renders spaces without geometry</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ss/pw/49/sspw499wnlg2zjfkih9ofjhk8ge.png"></div><br>  In the recently released Marvel's Spider-Man game, many buildings outside the windows have interiors.  They look great, but they seem to have been implemented using clever rendering - the geometry of the interiors actually does not exist and it is generated by the shader.  I did not see any official statements by Insomniac about how they did it, but based on what the effect looks like, the <em>interior mapping</em> technique that I came up with in 2007 while working on my dissertation is likely to be implemented.  Previously, I did not write about it in a blog, so now is the right time to explain the curious little shader that I came up with. <br><br>  Let's start by watching Marvel's Spider-Man gameplay.  The game looks just awesome.  Site Kotaku recorded a separate video dedicated to the windows: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/YQVHtlVEirs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  As you can see at about 40 seconds of video, in fact, the rooms are not part of the geometry: where there should obviously be a window, there is a door.  In addition, looking in one room from different angles of the building, we see a different interior.  In some cases, there is even a wall around the corner of the building.  All this makes us realize that the rooms are simulated.  However, in terms of perspective, they are displayed correctly and have real depth. <a name="habracut"></a>  I think the drawbacks of such rooms when playing are not very important, because players usually do not study rooms so closely: interiors are just the background, and not the subject of careful research.  I believe that this way of creating rooms adds depth and life to a city without spending too much resources. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b77/b8d/bc9/b77b8dbc9c2a8f05cb6e547c626ffd0b.jpg"></div><br>  <i>To save resources, buildings in games often do not have interiors, as can be seen in the screenshot of GTA V</i> <br><br>  First of all, I want to explain that my post is not a complaint: I am delighted with the fact that my technique was used in such a large-scale game and in no case accuse Insomniac of stealing.  As I said in the first publication on interior mapping, it would be an honor for me if someone uses this technique.  If Insomniac really took advantage of my idea in my technique, then I think that's great.  If not used, then it seems she came up with something strangely similar.  Then I would be interested in how this was done. <br><br>  So how does interior mapping work?  The idea is that the building itself does not contain any additional geometry.  Interiors exist only in the shader.  This shader performs raycasting with walls, ceilings and floors to calculate what the player should see in the interior. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/af4/7e7/b8f/af47e7b8ff8b0237682a9e6573b42183.jpg"></div><br>  <i>From left to right: only windows with reflections, windows with Interior Mapping, frame model - Interior Mapping does not add any polygons.</i> <br><br>  A raycast used for raycast is simply a ray from a camera to a pixel.  The pixel we are rendering is located on the outside of the building, so we only use part of the beam by pixel, because this is exactly the part that is actually inside the building. <br><br>  Raycasting may seem like a complicated and costly operation, but in this particular case it is actually very simple and fast.  The trick is that you can add a simple limitation: with interior mapping, the ceilings and floors are at a constant distance.  Knowing this, we can easily figure out which room we are in and where the floor and ceiling are located in this room.  Ceilings and floors themselves are infinite geometric planes.  The calculation of the intersection between the infinite plane and the ray takes only a few steps and spends few resources. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/99a/36a/cc3/99a36acc3fb2962935e9d0b76c4512d0.gif"></div><br>  The room has 6 planes: ceiling, floor and 4 walls.  However, we need to take into account only three of them, because we know in which direction we are looking.  For example, if we look up, we do not need to check the floor below, because we will see the ceiling above.  Similarly, instead of 4 walls, we need to consider only two in the direction in which we are looking. <br><br>  To determine what we see, we need to calculate the intersection of the beam with each of these three planes.  The intersection with the beam nearest to the camera tells us which of the planes we see in this pixel.  Then we use the intersection point as the coordinate of the texture to find the color of the pixel.  For example, if the ray intersects at the (x, y, z) position with the ceiling, then we use the (x, y) textures as coordinates and ignore z. <br><br>  Here I added a good optimization: a part of the intersection calculations for each of the three planes can be performed simultaneously.  The shaders used worked with float4 at the same speed as with float, so thanks to the clever packaging of variables, all three rays could be intersected with the planes at the same time.  This saved me some resources and helped me achieve a high frame rate with interior mapping even in 2007.  I was told that modern video cards with float work faster than with float4;  This means that this optimization does not work on the current hardware. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d5d/1f5/751/d5d1f57518f274783ab5b797d861a4d0.jpg"></div><br>  <i>Interior Mapping without windows textures shows that rooms are rendered with the correct perspective and textures, although additional geometry is not required.</i> <br><br>  More details about the work of interior mapping can be found in <a href="http://www.proun-game.com/Oogst3D/CODING/InteriorMapping/InteriorMapping.pdf">my article</a> .  This article was published at the Computer Graphics International Conference in 2008. The presence of this peer-reviewed publication is my first (and only) application for the proud title of a scientist.  This article also describes additional experiments on adding details, for example, changing the distance between walls for rooms of unequal size and randomly choosing textures from a texture atlas for greater variability of rooms.  It also describes in detail the two variations shown in the images below. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ed8/17a/28a/ed817a28adbc6f0dd9ea44ce6f61294b.jpg"></div><br>  <i>The lighting in the rooms can be dynamically turned on and off to simulate the change of day and night.</i>  <i>This is done using the noise texture from which we read, using the room index as the coordinates of the texture.</i> <br><br>  Since we just emit rays in the plane, all rooms are simple squares with textures.  All the furniture in the room will be on the texture, and therefore remain flat.  In Spiderman, this is noticeable in the case of approaching the camera: the tables in the rooms are in fact flat textures on the walls.  As can be seen in the image below, you can supplement our technique with one or more additional layers of textures per room, but this is due to the additional cost of performance. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ea2/e0d/2dc/ea2e0d2dc5b8b6783928931e15e612a5.jpg"></div><br>  <i>By performing raytracing on another plane parallel to the outer surface of the building, you can add furniture and people to the room.</i>  <i>However, they will still remain flat.</i> <br><br>  After the publication of this post, one of the programmers at Simcity (2013) told me that the interior mapping technique was also used in this game.  In her, she looks very cool, and the developers recorded a great video about it.  They perfected my original idea, retaining all the textures in one texture and adding rooms of different depths.  The interior mapping part starts at 1:00: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/_x88tvkAGuo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  If you want to explore this technique more deeply, you can download <a href="">my interior mapping demo</a> with the source code.  If you work in Unreal Engine 4, you can find interior mapping as a standard engine function as a function of InteriorCubeMap. <br><br>  After so many years it is very cool to finally see that my interior mapping technique is used in the production of large-scale video games!  If you are familiar with games that use something similar, then write about it to me. </div><p>Source: <a href="https://habr.com/ru/post/424827/">https://habr.com/ru/post/424827/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424817/index.html">Design of digital products. Purpose, role, method</a></li>
<li><a href="../424819/index.html">Data Verification - Java & Spring Validation</a></li>
<li><a href="../424821/index.html">About demons and teleportation: two technologies that bring the ‚Äúquantum future‚Äù closer</a></li>
<li><a href="../424823/index.html">How low-calorie food affects aging</a></li>
<li><a href="../424825/index.html">Robots and communism</a></li>
<li><a href="../424831/index.html">What to invest in the digital economy</a></li>
<li><a href="../424835/index.html">How to reduce the risk of investment on the stock exchange: 3 factors diversification</a></li>
<li><a href="../424841/index.html">Image archive storage for a site in Azure Blob storage</a></li>
<li><a href="../424843/index.html">And in your iOS applications, IBOutlet is already private?</a></li>
<li><a href="../424845/index.html">We calculate the "magic squares" using the GPU</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>