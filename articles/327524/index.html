<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Troubleshooting using WinDbg, Sos and Sosex</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Image: Julien Dumont , Flickr 


 Unfortunately, sometimes there are situations when the system stops working or starts to consume resources uncontrol...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Troubleshooting using WinDbg, Sos and Sosex</h1><div class="post__text post__text-html js-mediator-article"><p> <a href="https://habrahabr.ru/company/pt/blog/327524/"><img src="https://habrastorage.org/files/591/303/c39/591303c39ec845568c47a1ac6f87e5e4.jpg"></a> </p><br><p>  <i>Image: <a href="https://www.flickr.com/photos/julesdphotographie/">Julien Dumont</a> , Flickr</i> </p><br><p>  Unfortunately, sometimes there are situations when the system stops working or starts to consume resources uncontrollably, and logs and system metrics cannot help.  The situation is further aggravated by the fact that there is no Visual Studio or any debugger on the system in production, it is impossible to remotely debug.  More often than not even the ability to access this machine.  In this case, the only solution is to analyze the memory dump of the process.  I want to describe a few common scenarios of finding problems on such dumps.  This is a search for deadlocks, memory leaks and high consumption of processor resources. </p><a name="habracut"></a><br><p>  The peculiarity of such problems is that they are extremely rarely reproduced on developers' computers, are difficultly covered by automated testing, and they require large resources.  Therefore, an important step in the development of the system is to conduct a series of stress tests on iron, close to the one in which it will work for the customer.  In the event of such problems, immediately analyze and correct. </p><br><p>  A process memory dump can be taken in various ways.  For example, in the Task Manager, you can select the process of interest and call the Create Dump File item in the context menu.  <a href="https://technet.microsoft.com/en-us/sysinternals/dd996900.aspx">ProcDump</a> utility from Mark Russinovich helps me a <a href="https://technet.microsoft.com/en-us/sysinternals/dd996900.aspx">lot</a> .  With its help, you can shoot different types of dumps for different events.  For example, you can take a complete memory dump of a process at a time when the process consumes more than 30% of the CPU within 10 seconds.  In general, a very useful utility. </p><br><p>  You can analyze dumps using various tools, for example, in Visual Studio or using the <a href="https://github.com/Microsoft/clrmd">ClrMD</a> library.  I will use WinDbg and Sos.  No special advantages, it's just convenient for me to work with them.  Also an indispensable assistant for me was the plugin <a href="http://www.stevestechspot.com/">Sosex</a> , which greatly simplifies life in the search for problems and analysis. </p><br><p>  Before we begin our research, I‚Äôll note that for convenience in WinDbg you should set up debugging symbols.  This process has already been described many times on the Internet, so I will not repeat, but just give a <a href="http://www.graymatterdeveloper.com/2016/04/01/configuring-windbg/">link</a> . </p><br><p>  Let us consider the real scenarios.  Almost all of the scenarios described arose in actual practice, and I or my colleagues had to deal with them in due time.  But, in order not to violate trade secrets, I prepared several demonstration examples that illustrate the problems that have arisen.  Examples can be found <a href="https://github.com/lomomike/DebugExamples">here</a> .  For plausibility, we will analyze not a workflow, but its dump.  To do this, remove the full memory dump of the process with the command <strong>procdump.exe -ma PID</strong> .  So, let's begin. </p><br><h2 id="poisk-vzaimoblokirovok-primer-1-y-prostoy">  Search for deadlocks (example 1st, simple) </h2><br><p>  <em>(Example <a href="https://github.com/lomomike/DebugExamples/tree/master/01-MonitorDeadlock">01-MonitorDeadlock</a> )</em> </p><br><p>  When looking for deadlocks, Sosex can help very well.  Suppose we noticed that our application does not respond to any commands.  It hung.  What to do? <br>  Run WinDbg (importantly, the same bit depth as the application) and load the captured dump (press Ctrl + D and select the dump file in the dialog).  We load the necessary extensions </p><br><pre><code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.loadby</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sos</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">clr</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.load</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">D</span></span>:\<span class="hljs-selector-tag"><span class="hljs-selector-tag">utils</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">sosex</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.dll</span></span> (   )</code> </pre> <br><p>  Sosex has a great dlk command that can look for deadlocks between sync blocks and / or ReaderWriterLock objects.  Run it and look at the result. </p><br><pre> <code class="hljs delphi"><span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">011</span></span>&gt; !dlk Examining SyncBlocks... Scanning <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ReaderWriterLock(Slim) instances... Scanning <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> holders <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> ReaderWriterLock locks... Scanning <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> holders <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> ReaderWriterLockSlim locks... Examining CriticalSections... Scanning <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> threads waiting <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> SyncBlocks... Scanning <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> threads waiting <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ReaderWriterLock locks... Scanning <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> threads waiting <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ReaderWriterLocksSlim locks... Scanning <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> threads waiting <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CriticalSections... *DEADLOCK DETECTED* CLR thread <span class="hljs-number"><span class="hljs-number">0</span></span>x4 holds the lock <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> SyncBlock <span class="hljs-number"><span class="hljs-number">000000</span></span>e2a8343ae8 OBJ:<span class="hljs-number"><span class="hljs-number">000000</span></span>e2aa064348[System.<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>] ...<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the lock <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> SyncBlock <span class="hljs-number"><span class="hljs-number">000000</span></span>e2a8343a98 OBJ:<span class="hljs-number"><span class="hljs-number">000000</span></span>e2aa064330[System.<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>] CLR thread <span class="hljs-number"><span class="hljs-number">0</span></span>x3 holds the lock <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> SyncBlock <span class="hljs-number"><span class="hljs-number">000000</span></span>e2a8343a98 OBJ:<span class="hljs-number"><span class="hljs-number">000000</span></span>e2aa064330[System.<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>] ...<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the lock <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> SyncBlock <span class="hljs-number"><span class="hljs-number">000000</span></span>e2a8343ae8 OBJ:<span class="hljs-number"><span class="hljs-number">000000</span></span>e2aa064348[System.<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>] CLR Thread <span class="hljs-number"><span class="hljs-number">0</span></span>x4 <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> waiting at MonitorDeadlock.<span class="hljs-keyword"><span class="hljs-keyword">Program</span></span>.Thread2()(+<span class="hljs-number"><span class="hljs-number">0</span></span>x2e IL,+<span class="hljs-number"><span class="hljs-number">0</span></span>x8f Native) [D:\Projects\DebugExamples\MonitorDeadlock\<span class="hljs-keyword"><span class="hljs-keyword">Program</span></span>.cs @ <span class="hljs-number"><span class="hljs-number">45</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>] CLR Thread <span class="hljs-number"><span class="hljs-number">0</span></span>x3 <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> waiting at MonitorDeadlock.<span class="hljs-keyword"><span class="hljs-keyword">Program</span></span>.Thread1()(+<span class="hljs-number"><span class="hljs-number">0</span></span>x2e IL,+<span class="hljs-number"><span class="hljs-number">0</span></span>x8f Native) [D:\Projects\DebugExamples\MonitorDeadlock\<span class="hljs-keyword"><span class="hljs-keyword">Program</span></span>.cs @ <span class="hljs-number"><span class="hljs-number">33</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>] <span class="hljs-number"><span class="hljs-number">1</span></span> deadlock detected.</code> </pre> <br><p>  We were lucky!  Sosex immediately showed us that we have a deadlock, on what objects it arose and in which flows.  Using the threads command, we get a complete list of managed threads and match the managed stream ID with the internal WinDbg ID. </p><br><pre> <code class="hljs css">0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:011</span></span>&gt; !<span class="hljs-selector-tag"><span class="hljs-selector-tag">threads</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Lock</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ID</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OSID</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ThreadOBJ</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">State</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">GC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mode</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">GC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Alloc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Context</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Domain</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Count</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Apt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Exception</span></span> 0 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">db8</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2a82929e0</span></span> 202<span class="hljs-selector-tag"><span class="hljs-selector-tag">a020</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Preemptive</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">E2AA06C0A0</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000E2AA06DFD0</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2a82860e0</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTA</span></span> 5 2 5<span class="hljs-selector-tag"><span class="hljs-selector-tag">d0</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2a830f9d0</span></span> 2<span class="hljs-selector-tag"><span class="hljs-selector-tag">b220</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Preemptive</span></span> 0000000000000000<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0000000000000000</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2a82860e0</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTA</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">Finalizer</span></span>) 9 3 27<span class="hljs-selector-tag"><span class="hljs-selector-tag">bc</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2a835c210</span></span> 202<span class="hljs-selector-tag"><span class="hljs-selector-tag">b220</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Preemptive</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">E2AA06A0D8</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000E2AA06BFD0</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2a82860e0</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTA</span></span> 10 4 27<span class="hljs-selector-tag"><span class="hljs-selector-tag">ac</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2a835e5e0</span></span> 202<span class="hljs-selector-tag"><span class="hljs-selector-tag">b220</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Preemptive</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">E2AA06EB50</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000E2AA06FFD0</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2a82860e0</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTA</span></span></code> </pre> <br><p>  We see that threads 3 and 4 of interest to us have captured locks (Lock Count column c 1).  Now, look at the stacks of these threads to see where the lock occurred.  To do this, we call the ~ N *! Clrstack command, where N is the internal thread identifier in the debugger (9 and 10).  Part of the output is hidden for brevity. </p><br><pre> <code class="hljs css">0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:011</span></span>&gt; ~9<span class="hljs-selector-tag"><span class="hljs-selector-tag">e</span></span>!<span class="hljs-selector-tag"><span class="hljs-selector-tag">clrstack</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OS</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Thread</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Id</span></span>: 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x27bc</span></span> (9) <span class="hljs-selector-tag"><span class="hljs-selector-tag">Child</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Site</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2c2d4ee58</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffeb0de3dda</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[GCFrame: 000000e2c2d4ee58]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2c2d4efc8</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffeb0de3dda</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[GCFrame: 000000e2c2d4efc8]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2c2d4f008</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffeb0de3dda</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[HelperMethodFrame_1OBJ: 000000e2c2d4f008]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Monitor</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Enter</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Object</span></span>) 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2c2d4f100</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffe2a46088f</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MonitorDeadlock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Program</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Thread1</span></span>() <span class="hljs-selector-attr"><span class="hljs-selector-attr">[D:\Projects\DebugExamples\MonitorDeadlock\Program.cs @ 33]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2c2d4f160</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffe88b1af17</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Tasks</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Task</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Execute</span></span>() 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:011</span></span>&gt; ~10<span class="hljs-selector-tag"><span class="hljs-selector-tag">e</span></span>!<span class="hljs-selector-tag"><span class="hljs-selector-tag">clrstack</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OS</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Thread</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Id</span></span>: 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x27ac</span></span> (10) <span class="hljs-selector-tag"><span class="hljs-selector-tag">Child</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Site</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2c2f4eaf8</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffeb0de3dda</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[GCFrame: 000000e2c2f4eaf8]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2c2f4ec68</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffeb0de3dda</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[GCFrame: 000000e2c2f4ec68]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2c2f4eca8</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffeb0de3dda</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[HelperMethodFrame_1OBJ: 000000e2c2f4eca8]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Monitor</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Enter</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Object</span></span>) 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2c2f4eda0</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffe2a4609df</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MonitorDeadlock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Program</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Thread2</span></span>() <span class="hljs-selector-attr"><span class="hljs-selector-attr">[D:\Projects\DebugExamples\MonitorDeadlock\Program.cs @ 45]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">e2c2f4ee00</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffe88b1af17</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Tasks</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Task</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Execute</span></span>()</code> </pre> <br><p>  Perfectly!  Now we see the methods that caused the deadlock.  We have a classic example of locking on two locks. </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Thread1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Lock1) <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Lock2) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Thread2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Lock2) <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (Lock1) }</code> </pre><br><h2 id="poisk-vzaimoblokirovok-primer-2-y-ne-takoy-prostoy">  Search for deadlocks (example 2, not so simple) </h2><br><p>  <em>(Example <a href="https://github.com/lomomike/DebugExamples/tree/master/02-RwlDeadlock">02-RwlDeadlock</a> )</em> </p><br><p>  But sometimes there are situations where the dlk command does not work. </p><br><pre> <code class="hljs javascript"><span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">016</span></span>&gt; !dlk Examining SyncBlocks... Scanning <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ReaderWriterLock(Slim) instances... Scanning <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> holders <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> ReaderWriterLock locks... Scanning <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> holders <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> ReaderWriterLockSlim locks... Examining CriticalSections... No deadlocks detected.</code> </pre> <br><p>  What to do in this case?  We still suspect that there is a deadlock.  First, let's look at what synchronization blocks the process has and by whom they are captured. </p><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">016</span></span>&gt; !SyncBlk -<span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> SyncBlock MonitorHeld Recursion Owning Thread <span class="hljs-keyword"><span class="hljs-keyword">Info</span></span> SyncBlock <span class="hljs-keyword"><span class="hljs-keyword">Owner</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">00000082</span></span>dde314a8 <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-number"><span class="hljs-number">00000082</span></span>dfc6ac88 Microsoft.Win32.UnsafeNativeMethods+ManifestEtw+EtwEnableCallback <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">00000082</span></span>dde314f8 <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-number"><span class="hljs-number">00000082</span></span>dfc6b340 <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.__ComObject <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">00000082</span></span>dde31548 <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-number"><span class="hljs-number">00000082</span></span>dfc6b360 <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.EventHandler`<span class="hljs-number"><span class="hljs-number">1</span></span>[[Windows.Foundation.<span class="hljs-keyword"><span class="hljs-keyword">Diagnostics</span></span>.TracingStatusChangedEventArgs, mscorlib]] <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> Free <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">00000082</span></span>dde315e8 <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-number"><span class="hljs-number">00000082</span></span>dfc6bf40 Microsoft.Win32.UnsafeNativeMethods+ManifestEtw+EtwEnableCallback</code> </pre> <br><p>  No results.  No synchronization block is captured in the system.  The lock may be on the ReaderWriterLock object.  You can verify this with the Sosex rwlock command. </p><br><pre> <code class="hljs go"><span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">016</span></span>&gt; !rwlock ReaderWriterLock instances... Address ReaderCount WaitingReaderCount WriterThread WaitingWriterCount ----------------------------------------------------------------------------------------- <span class="hljs-number"><span class="hljs-number">000000d</span></span>380002b38 <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> -- <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">000000d</span></span>380008fc8 <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> -- <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">016</span></span>&gt; !rwlock <span class="hljs-number"><span class="hljs-number">000000d</span></span>380008fc8 WriterThread: <span class="hljs-number"><span class="hljs-number">0x0</span></span> WriterLevel: <span class="hljs-number"><span class="hljs-number">0</span></span> WaitingWriterCount: <span class="hljs-number"><span class="hljs-number">3</span></span> WriterEvent: <span class="hljs-number"><span class="hljs-number">3d</span></span>8 WaitingWriterThreadIds: <span class="hljs-number"><span class="hljs-number">0x1</span></span>,<span class="hljs-number"><span class="hljs-number">0x3</span></span>,<span class="hljs-number"><span class="hljs-number">0x6</span></span> ReaderCount: <span class="hljs-number"><span class="hljs-number">0</span></span> CurrentReaderThreadIds: None WaitingReaderCount: <span class="hljs-number"><span class="hljs-number">0</span></span> ReaderEvent: <span class="hljs-number"><span class="hljs-number">384</span></span> WaitingReaderThreadIds: None</code> </pre> <br><p>  Fine!  We see that there is a ReaderWriteerLock object, which has 3 threads waiting to be locked for writing.  Let's look at the stacks of these threads (don't forget to map the CLR identifiers to the internal debugger identifiers using the threads command). </p><br><pre> <code class="hljs css">0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:016</span></span>&gt; ~0<span class="hljs-selector-tag"><span class="hljs-selector-tag">e</span></span>!<span class="hljs-selector-tag"><span class="hljs-selector-tag">clrstack</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OS</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Thread</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Id</span></span>: 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1ea0</span></span> (0) <span class="hljs-selector-tag"><span class="hljs-selector-tag">Child</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Site</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">d3f69ae388</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffeb0de3dda</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[GCFrame: 000000d3f69ae388]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">d3f69ae3c8</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffeb0de3dda</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[HelperMethodFrame_1OBJ: 000000d3f69ae3c8]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ReaderWriterLock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.FCallUpgradeToWriterLock</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.LockCookie</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ByRef</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Int32</span></span>) 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">d3f69ae4d0</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffe89376fcd</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ReaderWriterLock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.UpgradeToWriterLock</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">Int32</span></span>) 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">d3f69ae510</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffe2a440c4f</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RwlDeadlock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.UpgradableRwlDeadlock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.GetExpensiveObject</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.String</span></span>) <span class="hljs-selector-attr"><span class="hljs-selector-attr">[D:\Projects\DebugExamples\RwlDeadlock\UpgradableRwlDeadlock.cs @ 34]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">d3f69ae5a0</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffe2a440b6c</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RwlDeadlock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.UpgradableRwlDeadlock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.b__2_0</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">Int32</span></span>) <span class="hljs-selector-attr"><span class="hljs-selector-attr">[D:\Projects\DebugExamples\RwlDeadlock\UpgradableRwlDeadlock.cs @ 15]</span></span> ‚Ä¶ 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:016</span></span>&gt; ~9<span class="hljs-selector-tag"><span class="hljs-selector-tag">e</span></span>!<span class="hljs-selector-tag"><span class="hljs-selector-tag">clrstack</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OS</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Thread</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Id</span></span>: 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x310c</span></span> (9) <span class="hljs-selector-tag"><span class="hljs-selector-tag">Child</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Site</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">d3f969e8d8</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffeb0de3dda</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[GCFrame: 000000d3f969e8d8]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">d3f969e918</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffeb0de3dda</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[HelperMethodFrame_1OBJ: 000000d3f969e918]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ReaderWriterLock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.FCallUpgradeToWriterLock</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.LockCookie</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ByRef</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Int32</span></span>) 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">d3f969ea20</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffe89376fcd</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ReaderWriterLock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.UpgradeToWriterLock</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">Int32</span></span>) 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">d3f969ea60</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffe2a440c4f</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RwlDeadlock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.UpgradableRwlDeadlock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.GetExpensiveObject</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.String</span></span>) <span class="hljs-selector-attr"><span class="hljs-selector-attr">[D:\Projects\DebugExamples\RwlDeadlock\UpgradableRwlDeadlock.cs @ 34]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">d3f969eaf0</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffe2a440b6c</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RwlDeadlock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.UpgradableRwlDeadlock</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.b__2_0</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">Int32</span></span>) <span class="hljs-selector-attr"><span class="hljs-selector-attr">[D:\Projects\DebugExamples\RwlDeadlock\UpgradableRwlDeadlock.cs @ 15]</span></span></code> </pre> <br><p>  We have found an example of incorrect use of the UpaderToWriterLock method of the ReaderWriterLock class. </p><br><p>  From these examples, you can try to describe an algorithm with which you can analyze deadlocks: </p><br><ol><li>  We are looking for deadlocks using the dlk command. </li><li>  If deadlocks are not found, analyze the synchronization objects using the syncblk and rwlock commands. </li><li>  Analyze the stacks of threads that are pending.  We are looking for calling blocking methods on the stack.  Such methods can be Monitor.Enter, Task.WaitAll, ReaderWriterLock.UpgradeToWriterLock, etc. </li><li>  You can also analyze the unmanaged thread by calling the k command and looking for a call to the ntdll function! NtWaitForMultipleObjects or ntdll! NtWaitForSingleObject. </li></ol><br><p>  This algorithm helps me in solving probably 80% of problems.  The remaining 20% ‚Äã‚Äãrequire more non-trivial actions. </p><br><h2 id="poisk-utechki-pamyati">  Memory leak search </h2><br><p>  <em>(Example <a href="https://github.com/lomomike/DebugExamples/tree/master/03-MemoryLeak">03-MemoryLeak</a> )</em> </p><br><p>  Sometimes a situation may arise when an application begins to allocate more and more memory without releasing it.  In this case, it is necessary to analyze the allocated memory for leaks.  In .Net applications, leaks can occur when the garbage collector cannot release the roots of this object.  Sources of roots can be: </p><br><ul><li>  Static objects; </li><li>  CPU registers; </li><li>  Stack; </li><li>  Objects to be finalized; </li><li>  Unmanaged objects </li><li>  Pinned objects (selected, for example, using the fixed keyword or using the GCHandle.Alloc method). </li></ul><br><p>  A memory leak can be seen on the process memory allocation graph.  It can be obtained using performance counters, looking at the Process \ Private bytes, .Net CLT Memory # Bytes in All Heaps counters, etc. But it‚Äôs more convenient for me to monitor the Private Bytes schedule in the <a href="https://technet.microsoft.com/en-us/sysinternals/bb896653">Process Explorer</a> program.  If on the graph we see that more and more memory is constantly being allocated, which is not being released, and that the size of the second generation is growing.  This makes it an unequivocal hint that we have a memory leak.  We remove the memory dump of the process and analyze it. </p><br><p>  Load the captured dump into WinDbg and connect sos and sosex as described above.  Sosex has a great opportunity to build a heap index for later use (the bhi command).  This index helps to significantly speed up the execution of heap analysis commands.  For example, on a 5 GB dump, the GcRoot command took me about 20 minutes, and its counterpart from sosex mroot on the constructed index was completed in a couple of seconds. </p><br><p>  First, let's look at the general heap memory allocation statistics. </p><br><pre> <code class="hljs erlang-repl"><span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">004</span></span>&gt; !HeapStat Heap Gen0 Gen1 Gen2 LOH Heap0 <span class="hljs-number"><span class="hljs-number">1204664</span></span> <span class="hljs-number"><span class="hljs-number">6409008</span></span> <span class="hljs-number"><span class="hljs-number">1421466144</span></span> <span class="hljs-number"><span class="hljs-number">166272</span></span> Free space: Percentage Heap0 <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">3204400</span></span> <span class="hljs-number"><span class="hljs-number">153752240</span></span> <span class="hljs-number"><span class="hljs-number">184</span></span>SOH: <span class="hljs-number"><span class="hljs-number">10</span></span><span class="hljs-comment"><span class="hljs-comment">% LOH: 0%</span></span></code> </pre> <br><p>  As expected, the second generation has grown to incredible size.  Let's look at the statistics of selected objects in the heap using the sosex dumpgen command.  The latest version of sosex allows you to specify all as the desired generation and thus analyze the entire heap. </p><br><pre> <code class="hljs css">0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:004</span></span>&gt; !<span class="hljs-selector-tag"><span class="hljs-selector-tag">dumpgen</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">-stat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Count</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Total</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Size</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Type</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-------------------------------------------------</span></span>       9 648 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Int32</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[]</span></span> 4 760 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Char</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[]</span></span> 2 1,072 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Globalization</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.CultureData</span></span> 18 1,216 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.String</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[]</span></span> 58 3,248 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.RuntimeType</span></span> 180 7,486 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.String</span></span> 15,825 379,800 <span class="hljs-selector-tag"><span class="hljs-selector-tag">MemoryLeak</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Worker</span></span> 15,824 1,012,736 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.EventHandler</span></span>`1<span class="hljs-selector-attr"><span class="hljs-selector-attr">[[System.EventArgs, mscorlib]</span></span>] 15,719 153,720,802 **** <span class="hljs-selector-tag"><span class="hljs-selector-tag">FREE</span></span> **** 15,824 1,266,299,776 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Int64</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[]</span></span> 63,545 <span class="hljs-selector-tag"><span class="hljs-selector-tag">objects</span></span>, 1,421,434,137 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bytes</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Total</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">GEN</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">size</span></span>: 1,421,466,144 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bytes</span></span></code> </pre> <br><p>  It can be seen that more than 15 thousand EventHandler objects are allocated in the heap. <br></p><pre> <code class="hljs css">0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:004</span></span>&gt; !<span class="hljs-selector-tag"><span class="hljs-selector-tag">dumpgen</span></span> 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">-type</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.EventHandler</span></span>`1<span class="hljs-selector-attr"><span class="hljs-selector-attr">[[System.EventArgs, mscorlib]</span></span>] <span class="hljs-selector-tag"><span class="hljs-selector-tag">Object</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Size</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-------------------------------------------------------------------</span></span>       000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">b304b7de38</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">FFC2C1FA880</span></span> 64 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.EventHandler</span></span>`1<span class="hljs-selector-attr"><span class="hljs-selector-attr">[[System.EventArgs, mscorlib]</span></span>] 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">b304ba5018</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">FFC2C1FA880</span></span> 64 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.EventHandler</span></span>`1<span class="hljs-selector-attr"><span class="hljs-selector-attr">[[System.EventArgs, mscorlib]</span></span>] 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">b304bcc1f8</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">FFC2C1FA880</span></span> 64 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.EventHandler</span></span>`1<span class="hljs-selector-attr"><span class="hljs-selector-attr">[[System.EventArgs, mscorlib]</span></span>]</code> </pre> <br><p>  Let's look at the fields of one of them (the last).  The sos.do or sosex.mdt commands will help. </p><br><pre> <code class="hljs css">0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:004</span></span>&gt; !<span class="hljs-selector-tag"><span class="hljs-selector-tag">mdt</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">b304bcc1f8</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">b304bcc1f8</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.EventHandler</span></span>`1<span class="hljs-selector-attr"><span class="hljs-selector-attr">[[System.EventArgs, mscorlib]</span></span>]) _<span class="hljs-selector-tag"><span class="hljs-selector-tag">target</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000b304bb8948</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">MemoryLeak</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Worker</span></span>) _<span class="hljs-selector-tag"><span class="hljs-selector-tag">methodBase</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:NULL</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Object</span></span>) _<span class="hljs-selector-tag"><span class="hljs-selector-tag">methodPtr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00007ffbd0a500c0</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.IntPtr</span></span>) _<span class="hljs-selector-tag"><span class="hljs-selector-tag">methodPtrAux</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0000000000000000</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.IntPtr</span></span>) _<span class="hljs-selector-tag"><span class="hljs-selector-tag">invocationList</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:NULL</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Object</span></span>) _<span class="hljs-selector-tag"><span class="hljs-selector-tag">invocationCount</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0000000000000000</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.IntPtr</span></span>)</code> </pre> <br><p>  The event handler points to the Worker class object.  Select several specific EventHandler objects and take a look at their roots. </p><br><pre> <code class="hljs lua"><span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">004</span></span>&gt; !mroot <span class="hljs-number"><span class="hljs-number">000000</span></span>b304bcc1f8 AppDomain <span class="hljs-number"><span class="hljs-number">000000</span></span>b31b3fd720: GCHandle(Pinned) @ <span class="hljs-number"><span class="hljs-number">000000</span></span>b31b5317d8 <span class="hljs-number"><span class="hljs-number">000000</span></span>b32cfa5970[System.Object[]] <span class="hljs-number"><span class="hljs-number">000000</span></span>b31cfa35e8[MemoryLeak.GlobalNotifier] <span class="hljs-number"><span class="hljs-number">000000</span></span>b3052faaa0[System.EventHandler`<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">[[System.EventArgs, mscorlib]]</span></span>] <span class="hljs-number"><span class="hljs-number">000000</span></span>b32cfa9968[System.Object[]] <span class="hljs-number"><span class="hljs-number">000000</span></span>b304bcc1f8[System.EventHandler`<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">[[System.EventArgs, mscorlib]]</span></span>] <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">004</span></span>&gt; !mroot <span class="hljs-number"><span class="hljs-number">000000</span></span>b304ba5018 AppDomain <span class="hljs-number"><span class="hljs-number">000000</span></span>b31b3fd720: GCHandle(Pinned) @ <span class="hljs-number"><span class="hljs-number">000000</span></span>b31b5317d8 <span class="hljs-number"><span class="hljs-number">000000</span></span>b32cfa5970[System.Object[]] <span class="hljs-number"><span class="hljs-number">000000</span></span>b31cfa35e8[MemoryLeak.GlobalNotifier] <span class="hljs-number"><span class="hljs-number">000000</span></span>b3052faaa0[System.EventHandler`<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">[[System.EventArgs, mscorlib]]</span></span>] <span class="hljs-number"><span class="hljs-number">000000</span></span>b32cfa9968[System.Object[]] <span class="hljs-number"><span class="hljs-number">000000</span></span>b304ba5018[System.EventHandler`<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">[[System.EventArgs, mscorlib]]</span></span>]</code> </pre> <br><p>  It can be seen that both objects caught on the same instance of the GlobalNotifier class. </p><br><pre> <code class="hljs css">0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:004</span></span>&gt; !<span class="hljs-selector-tag"><span class="hljs-selector-tag">gch</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">b31b5317d8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">HandleObj</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">HandleType</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Object</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Size</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Data</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Type</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--------------------------------------------------------------------------------------</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">b31b5317d8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Pinned</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">b32cfa5970</span></span> 16344 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Object</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--------------------------------------------------------------------------------------</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Handle</span></span> 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:004</span></span>&gt; !<span class="hljs-selector-tag"><span class="hljs-selector-tag">mdt</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">b31cfa35e8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">b31cfa35e8</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">MemoryLeak</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.GlobalNotifier</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">SomethingHappened</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000b3052faaa0</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.EventHandler</span></span>`1<span class="hljs-selector-attr"><span class="hljs-selector-attr">[[System.EventArgs, mscorlib]</span></span>]) _<span class="hljs-selector-tag"><span class="hljs-selector-tag">target</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000b3052faaa0</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.EventHandler</span></span>`1<span class="hljs-selector-attr"><span class="hljs-selector-attr">[[System.EventArgs, mscorlib]</span></span>]) &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">RECURSIVE</span></span>&gt; _<span class="hljs-selector-tag"><span class="hljs-selector-tag">methodBase</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:NULL</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Object</span></span>) _<span class="hljs-selector-tag"><span class="hljs-selector-tag">methodPtr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00007ffbd093e5e0</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.IntPtr</span></span>) _<span class="hljs-selector-tag"><span class="hljs-selector-tag">methodPtrAux</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00007ffc2c2d84a8</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.IntPtr</span></span>) _<span class="hljs-selector-tag"><span class="hljs-selector-tag">invocationList</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000b32cfa9968</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Object</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Elements</span></span>: 16384) _<span class="hljs-selector-tag"><span class="hljs-selector-tag">invocationCount</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0000000000003dff</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.IntPtr</span></span>)</code> </pre> <br><p>  We can say that this is a static object to which events are subscribed to by Worker objects.  Analyze threads and their stacks. </p><br><pre> <code class="hljs css">0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:004</span></span>&gt; ~0<span class="hljs-selector-tag"><span class="hljs-selector-tag">e</span></span>!<span class="hljs-selector-tag"><span class="hljs-selector-tag">clrstack</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OS</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Thread</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Id</span></span>: 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x9700</span></span> (0) <span class="hljs-selector-tag"><span class="hljs-selector-tag">Child</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Site</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">b31b2ee7a8</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffc2fe8f833</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[HelperMethodFrame: 000000b31b2ee7a8]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">b31b2ee910</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffbd0a50614</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MemoryLeak</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Program</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Main</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.String</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[]</span></span>) <span class="hljs-selector-attr"><span class="hljs-selector-attr">[D:\Projects\DebugExamples\MemoryLeak\Program.cs @ 19]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">b31b2eebc0</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffc30094073</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[GCFrame: 000000b31b2eebc0]</span></span>.</code> </pre> <br><p>  What happens in the Main method?  Disassemble it.  Sosex has a muf command that displays an aggregated listing of the IL code and the generated assembler code.  Sometimes, when there is no access to the sources, it can be very convenient.  (The output is limited) </p><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">004</span></span>&gt; !muf <span class="hljs-number"><span class="hljs-number">00007</span></span>ffbd0a50614 MemoryLeak.Program.Main(string[]): <span class="hljs-type"><span class="hljs-type">void</span></span> obj:MemoryLeak.Worker Notifier.SomethingHappened += obj.SomethingHappened; IL_003d: ldsfld MemoryLeak.Program::Notifier IL_0042: ldloc<span class="hljs-number"><span class="hljs-number">.0</span></span> (obj) IL_0043: ldftn MemoryLeak.Worker::SomethingHappened(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.EventArgs) IL_0049: newobj <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.EventHandler&lt;<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.EventArgs&gt;::.ctor IL_004e:callvirt MemoryLeak.GlobalNotifier::add_SomethingHappened(<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.EventHandler&lt;<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.EventArgs&gt;) <span class="hljs-number"><span class="hljs-number">00007</span></span>ffb`d0a50659 <span class="hljs-number"><span class="hljs-number">488</span></span>bcb mov rcx,rbx <span class="hljs-number"><span class="hljs-number">00007</span></span>ffb`d0a5065c <span class="hljs-number"><span class="hljs-number">488</span></span>bd7 mov rdx,rdi <span class="hljs-number"><span class="hljs-number">00007</span></span>ffb`d0a5065f <span class="hljs-number"><span class="hljs-number">3909</span></span> cmp dword ptr [rcx],ecx <span class="hljs-number"><span class="hljs-number">00007</span></span>ffb`d0a50661 e892faffff <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-number"><span class="hljs-number">00007</span></span>ffb`d0a500f8 obj.<span class="hljs-keyword"><span class="hljs-keyword">Work</span></span>(); Thread.Sleep(<span class="hljs-number"><span class="hljs-number">50</span></span>); IL_0063: ldc.i4.s <span class="hljs-number"><span class="hljs-number">50</span></span>(<span class="hljs-number"><span class="hljs-number">0x32</span></span>) IL_0065: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Threading.Thread::Sleep IL_006a: br.s IL_0037 <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)</code> </pre> <br><p>  We have a classic example of a memory leak on C # events.  In an infinite loop, new Worker objects are created that subscribe to the GlobalNotifier.SomethingHappened event.  Unsubscribe does not occur anywhere, and therefore the garbage collector cannot free allocated memory. </p><br><p>  Let's try to create an approximate algorithm for analyzing memory leaks: </p><br><ol><li>  Using the HeapStat command, we get the heap memory statistics.  Analyzing the size of generations. </li><li>  The dumpheap ‚Äìstat or dumpgen all -stat commands analyze the statistics of selected objects.  We are looking for a large number of application-specific objects. </li><li>  Using the dumpgen ‚Äì type TYPE command, we get a list of addresses of the objects of interest. </li><li>  Team mroot ObjAddress get the roots for which these objects are hooked. </li><li>  We analyze the roots.  For completeness, analyze the application thread stacks.  It is important to understand that the accumulation of unallocated memory can take a long time, and threads can be terminated and / or reused from the pool.  In this case, the analysis of the stacks will not give results.  The main tool is root analysis. </li></ol><br><h2 id="analiz-vysokogo-potrebleniya-processora">  High CPU consumption analysis </h2><br><p>  <em>(Example <a href="https://github.com/lomomike/DebugExamples/tree/master/04-CpuUtilization">04-CpuUtilization</a> . Run the example and wait 10-15 minutes.)</em> </p><br><p>  Lastly, it remains to consider the case when our system begins to eagerly consume processor resources.  Usually, a high consumption of processor resources may indicate that our application could get into an infinite loop and the only way to reduce it is to restart the application. </p><br><p>  Remove the process dump and analyze it.  Using the .time command, let's see how much time our application spent in user mode, and how much in kernel mode. </p><br><pre> <code class="hljs css">0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:008</span></span>&gt; <span class="hljs-selector-class"><span class="hljs-selector-class">.time</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Debug</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">session</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">time</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Apr</span></span> 3 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:51</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:18.733</span></span> 2017 (<span class="hljs-selector-tag"><span class="hljs-selector-tag">UTC</span></span> + 3<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Uptime</span></span>: 11 <span class="hljs-selector-tag"><span class="hljs-selector-tag">days</span></span> 10<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:29</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:22.677</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Process</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Uptime</span></span>: 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">days</span></span> 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:08</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:52.766</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Kernel</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">time</span></span>: 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">days</span></span> 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:13.562</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">User</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">time</span></span>: 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">days</span></span> 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:14</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:06.968</span></span></code> </pre> <br><p>  In my example, the program spent 13 seconds in kernel mode, and 14 minutes in user mode.  This means that the threads constantly do some work and almost never fall asleep.  This is quite strange.  In WinDbg, there is a runaway command that can show the distribution of runtime by threads. </p><br><pre> <code class="hljs css">0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:008</span></span>&gt; !<span class="hljs-selector-tag"><span class="hljs-selector-tag">runaway</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">User</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mode</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Time</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Thread</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Time</span></span> 4<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:6598</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">days</span></span> 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:02</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:57.687</span></span> 3<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:47b4</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">days</span></span> 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:02</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:52.421</span></span> 5<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:3370</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">days</span></span> 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:02</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:49.390</span></span> 6<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:6b1c</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">days</span></span> 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:02</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:45.921</span></span> 7<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:bb58</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">days</span></span> 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:02</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:19.687</span></span> 2<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:b478</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">days</span></span> 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:17.062</span></span> 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8e10</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">days</span></span> 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00.015</span></span> 8<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:6474</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">days</span></span> 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00.000</span></span> 1<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:97f0</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">days</span></span> 0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00.000</span></span></code> </pre> <br><p>  With the default settings, runaway displays only time in user mode.  We can see that 4 streams are threshing something for about 3 minutes each.  Shows the system thread IDs.  Using the threads command, we will get the internal debugger identifiers and at the same time we will see if there are any exceptions. </p><br><pre> <code class="hljs css">0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:008</span></span>&gt; !<span class="hljs-selector-tag"><span class="hljs-selector-tag">threads</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Lock</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ID</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OSID</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ThreadOBJ</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">State</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">GC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mode</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">GC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Alloc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Context</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Domain</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Count</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Apt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Exception</span></span> 0 1 8<span class="hljs-selector-tag"><span class="hljs-selector-tag">e10</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eab2ad3690</span></span> 202<span class="hljs-selector-tag"><span class="hljs-selector-tag">a020</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Preemptive</span></span> 0000000000000000<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0000000000000000</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eab2aaa950</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTA</span></span> 2 2 <span class="hljs-selector-tag"><span class="hljs-selector-tag">b478</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eab2afb6f0</span></span> 2<span class="hljs-selector-tag"><span class="hljs-selector-tag">b220</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Preemptive</span></span> 0000000000000000<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0000000000000000</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eab2aaa950</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTA</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">Finalizer</span></span>) 3 3 47<span class="hljs-selector-tag"><span class="hljs-selector-tag">b4</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eab2b491a0</span></span> 202<span class="hljs-selector-tag"><span class="hljs-selector-tag">b220</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Preemptive</span></span> 0000000000000000<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0000000000000000</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eab2aaa950</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTA</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Collections</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Generic</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.KeyNotFoundException</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eb4ff8f848</span></span> 4 4 6598 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eab2b4a750</span></span> 2<span class="hljs-selector-tag"><span class="hljs-selector-tag">b220</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Preemptive</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">EBD8F91930</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000000EBD8F91948</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eab2aaa950</span></span> 1024 <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTA</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Collections</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Generic</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.KeyNotFoundException</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eb4ff8fd60</span></span> 5 5 3370 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eab2b53a20</span></span> 202<span class="hljs-selector-tag"><span class="hljs-selector-tag">b220</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Preemptive</span></span> 0000000000000000<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0000000000000000</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eab2aaa950</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTA</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Collections</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Generic</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.KeyNotFoundException</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eb4ff5d698</span></span> 6 6 6<span class="hljs-selector-tag"><span class="hljs-selector-tag">b1c</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eab2b5a3d0</span></span> 202<span class="hljs-selector-tag"><span class="hljs-selector-tag">b220</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Preemptive</span></span> 0000000000000000<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0000000000000000</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eab2aaa950</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTA</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Collections</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Generic</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.KeyNotFoundException</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eb4ff8fba8</span></span> 7 7 <span class="hljs-selector-tag"><span class="hljs-selector-tag">bb58</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eab2b66680</span></span> 21220 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Cooperative</span></span> 0000000000000000<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0000000000000000</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eab2aaa950</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Ukn</span></span></code> </pre> <br><p>  It can be seen that KeyNotFoundException exceptions occurred in all threads of interest to us. </p><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">008</span></span>&gt; ~<span class="hljs-number"><span class="hljs-number">3</span></span>e!pe <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>: <span class="hljs-number"><span class="hljs-number">000000</span></span>eb4ff8f848 <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Collections.Generic.KeyNotFoundException Message:     . InnerException: &lt;<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>&gt; StackTrace (<span class="hljs-keyword"><span class="hljs-keyword">generated</span></span>): SP IP <span class="hljs-keyword"><span class="hljs-keyword">Function</span></span> <span class="hljs-number"><span class="hljs-number">000000</span></span>EACD15EF40 <span class="hljs-number"><span class="hljs-number">00007</span></span>FFC2D46AF6F mscorlib_ni!<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Collections.Concurrent.ConcurrentDictionary`<span class="hljs-number"><span class="hljs-number">2</span></span>[[<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Guid, mscorlib],[<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.__Canon, mscorlib]].get_Item(<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Guid)+<span class="hljs-number"><span class="hljs-number">0x48720f</span></span> <span class="hljs-number"><span class="hljs-number">000000</span></span>EACD15EF80 <span class="hljs-number"><span class="hljs-number">00007</span></span>FFBD0A4074A CpuUtilization!CpuUtilization.Program.ResolveAsset(<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Guid)+<span class="hljs-number"><span class="hljs-number">0x3a</span></span> StackTraceString: &lt;<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>&gt; HResult: <span class="hljs-number"><span class="hljs-number">80131577</span></span></code> </pre> <br><p>  Let's look at the stacks of threads (the output for one thread is given, the stacks of the others are similar). </p><br><pre> <code class="hljs css">0<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:008</span></span>&gt; ~3<span class="hljs-selector-tag"><span class="hljs-selector-tag">e</span></span>!<span class="hljs-selector-tag"><span class="hljs-selector-tag">clrstack</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OS</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Thread</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Id</span></span>: 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x47b4</span></span> (3) <span class="hljs-selector-tag"><span class="hljs-selector-tag">Child</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Site</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eacd15c968</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffc42d00c6a</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[GCFrame: 000000eacd15c968]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eacd15caa8</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffc42d00c6a</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[GCFrame: 000000eacd15caa8]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eacd15cae8</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffc42d00c6a</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[HelperMethodFrame_1OBJ: 000000eacd15cae8]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Monitor</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Enter</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Object</span></span>) 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eacd15cbe0</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffc2cfe3e9d</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Collections</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Concurrent</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConcurrentDictionary</span></span>`2<span class="hljs-selector-attr"><span class="hljs-selector-attr">[[System.Guid, mscorlib]</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[System.__Canon, mscorlib]</span></span>]<span class="hljs-selector-class"><span class="hljs-selector-class">.TryAddInternal</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Guid</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.__Canon</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Boolean</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Boolean</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.__Canon</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ByRef</span></span>) 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eacd15ccd0</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffc2cfe5235</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Collections</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Concurrent</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConcurrentDictionary</span></span>`2<span class="hljs-selector-attr"><span class="hljs-selector-attr">[[System.Guid, mscorlib]</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[System.__Canon, mscorlib]</span></span>]<span class="hljs-selector-class"><span class="hljs-selector-class">.TryAdd</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Guid</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.__Canon</span></span>) 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eacd15cd10</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffbd0a40811</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">CpuUtilization</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Program</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Init</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Guid</span></span>) <span class="hljs-selector-attr"><span class="hljs-selector-attr">[D:\Projects\DebugExamples\CpuUtilization\Program.cs @ 64]</span></span> 000000<span class="hljs-selector-tag"><span class="hljs-selector-tag">eacd15cd40</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">ffbd0a407aa</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">CpuUtilization</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Program</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ResolveAsset</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Guid</span></span>) <span class="hljs-selector-attr"><span class="hljs-selector-attr">[D:\Projects\DebugExamples\CpuUtilization\Program.cs @ 55]</span></span> ...</code> </pre> <br><p>  Now we know the place in the source where to look for the problem.  If you look at the source code of the example, you can see an infinite loop, in which there is always an error in receiving data from ConcurrentDictionary. </p><br><p>  The general search algorithm is quite simple: </p><br><ol><li>  Using the runaway command, we find the most ‚Äúvoracious‚Äù streams. </li><li>  Analyze the stacks of these threads. </li></ol><br><p>  In real life, everything is much more complicated: tens or hundreds of threads are spinning in the application, and millions of objects are allocated in the heap.  This greatly complicates the analysis, but the described steps have repeatedly helped me in analyzing problems with systems.  I hope that the examples I have given using WinDbg, Sos and Sosex help you make your life easier and save some nerve cells. </p><br><p>  All source code examples to study can be found <a href="https://github.com/lomomike/DebugExamples/">here.</a> </p><p></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/327524/">https://habr.com/ru/post/327524/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327514/index.html">DevConf 2017 will be held in Moscow on June 17</a></li>
<li><a href="../327516/index.html">"Now there is a shortage of" native "developers": Mikhail Samarin on mobile development in a European company</a></li>
<li><a href="../327518/index.html">Let's talk about Teams</a></li>
<li><a href="../327520/index.html">UE4 for Unity developers</a></li>
<li><a href="../327522/index.html">Functional JavaScript programming with practical examples</a></li>
<li><a href="../327526/index.html">‚ÄúCubes‚Äù for stores: why hyper-convergence is really needed, and why it is not just a buzzword</a></li>
<li><a href="../327528/index.html">School data: is it possible to influence the election with the help of Big Data</a></li>
<li><a href="../327530/index.html">Bash scripts, part 7: sed and word processing</a></li>
<li><a href="../327532/index.html">ITMO University Digest: business projects, initiatives and advice to entrepreneurs</a></li>
<li><a href="../327534/index.html">‚ÄúFriday format‚Äù: demotivation, or love [for work] cannot be bought for money</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>