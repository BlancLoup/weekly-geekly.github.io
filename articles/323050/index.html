<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>All the ‚Äújoys‚Äù of CallKit or how we did the caller ID on iOS 10</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="2GIS has long wanted to share with users of iPhones their knowledge of the telephone numbers of companies from the directory. The Android platform pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>All the ‚Äújoys‚Äù of CallKit or how we did the caller ID on iOS 10</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d42/3c3/5d7/d423c35d74e4460ca937c4f7d7591734.jpg"><br><br>  2GIS has long wanted to share with users of iPhones their knowledge of the telephone numbers of companies from the directory.  The Android platform provided such an <a href="https://apps.2gis.ru/dialer">opportunity</a> , but under iOS there was no suitable tool for a long time. <br><br>  In June, we went to WWDC 2016, and at <a href="https://developer.apple.com/videos/play/wwdc2016/230/">one of the sessions, the</a> guys from Apple let it slip that we could finally do a ‚Äúgorgeous astonishment‚Äù - the number identifier for iOS 10. Our joy knew no bounds, but for the time being: how Apple likes , she provided a feature with a number of restrictions. <br><a name="habracut"></a><br><h3>  Prototype </h3><br>  The first ‚Äújoy‚Äù we encountered is ‚Äúrich‚Äù documentation, namely: <br>  ‚Üí CXCallDirectoryExtensionContext 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@interface</span></span> CXCallDirectoryExtensionContext : NSExtensionContext <span class="hljs-meta"><span class="hljs-meta">@property</span></span> (nonatomic, weak, nullable) id&lt;CXCallDirectoryExtensionContextDelegate&gt; delegate; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)addBlockingEntryWithNextSequentialPhoneNumber:(CXCallDirectoryPhoneNumber)phoneNumber; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)addIdentificationEntryWithNextSequentialPhoneNumber:(CXCallDirectoryPhoneNumber)phoneNumber label:(NSString *)label; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)completeRequestWithCompletionHandler:(<span class="hljs-function"><span class="hljs-function">nullable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(^)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BOOL expired)</span></span></span><span class="hljs-function">)completion</span></span>; <span class="hljs-meta"><span class="hljs-meta">@end</span></span></code> </pre> <br>  ‚Üí CXCallDirectoryManager <br><br><pre> <code class="hljs java"> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> CXCallDirectoryManager : NSObject <span class="hljs-meta"><span class="hljs-meta">@property</span></span> (readonly, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CXCallDirectoryManager</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sharedInstance</span></span></span></span>; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)reloadExtensionWithIdentifier:(NSString *)identifier completionHandler:(<span class="hljs-function"><span class="hljs-function">nullable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(^)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NSError *_Nullable error)</span></span></span><span class="hljs-function">)completion</span></span>; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)getEnabledStatusForExtensionWithIdentifier:(NSString *)identifier completionHandler:(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (^)(CXCallDirectoryEnabledStatus enabledStatus, NSError *_Nullable error))completion; <span class="hljs-meta"><span class="hljs-meta">@end</span></span></code> </pre><br>  And that's all.  Well, it could be worse. <br><br>  From this we see that the dialer for iOS is an extension of the application that is spinning as a separate process, it can be overloaded and its status can be obtained.  It looks like what we need. <br>  In the extension itself, you can add numbers in the form of "phone / name" and add numbers to block. <br><br>  The first prototype was ready in 30 minutes.  One personal phone, wired into an extension, one test phone added to the lock, everything started up the first time, there was no limit to joy.  The future looked extremely bright - we already imagined how it all gets into the next release the next day. <br><br>  Not yet faced with the second "joy": we can not turn on the dialer from the main application.  You need to send the user deep into the settings, which is clearly not going to increase the conversion of this feature. <br><br>  Then they began to add a pack of numbers and the third ‚Äújoy‚Äù turned out: all the numbers needed to be written into the database before they were determined (this is Apple‚Äôs famous security - so that we don‚Äôt get access to the incoming callerID).  And our base is about 4 000 000 numbers with a signature.  That is, 140 MB of textual information, or 40 MB, if you shake on the tin, and all this must somehow be delivered to the extension. <br><br>  Armed with this knowledge, we prepared the data in the form of "phone / name" and began to saw a more real prototype. <br><br><h3>  Database </h3><br>  At first, they decided to stupidly add all the numbers, and again a surprise - the numbers should be added not anyhow, but in ascending order: 01, 02, 911, etc.  Otherwise, the extension falls.  In the first beta of 8, xcode extension crashed without any errors at all. <br><br>  Then it turned out that we are limited to 1,999,999 numbers.  Yes, it is 1,999,999, not 2,000,000, which is also not quite equal to our 4,000,000 rooms.  At first, they wanted to make three extensions, to fill up to 1,999,999 rooms each and not to blow.  Then they decided to divide by regions: Moscow + Peter, the rest of Russia, abroad.  But they refused this decision, because it was necessary to come up with a more complex delivery and make the feature even less stable, and the work of several simultaneously working extensions was also not stable.  Yes, and force the user to include all three extensions also did not want.  In the end, we decided to leave only the numbers of the cities set by the user <br><br>  At first, we wanted to deliver data via SQLite.  We collected a simple database of 100,000 numbers from Novosibirsk, wrote the logic of working with the base, launched a demo project, and ... nothing.  There are no errors, everything is OK, but the numbers are not determined. <br><br>  Having dug this case, we found out that when trying to pull data from SQLite into an ascending order, the database creates a cache of 30 MB and the extension falls out of memory.  Digging the Apple forums, they realized that it was better not to get out of 5 MB of RAM.  As a result, with a combined base for Moscow, St. Petersburg and a few more cities, it will be necessary to greatly complicate the database queries, build well-optimized memory and fetch speeds, and complicate the testing process.  There was no time to do all this, reluctance, and besides, my competences in the assigned technologies were clearly not enough. <br><br>  We wrote down our stupid, like a log, data format in the form of a bit sequence: <br><br>  [uint16_t: Block Size] [unsigned long long int: Phone] [String: Name] <br><br><div class="spoiler">  <b class="spoiler_title">and a very simple parser without problems:</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> @interface DGSPhonesDataReader : NSObject <span class="hljs-comment"><span class="hljs-comment">/**   ,    next,  0 */</span></span> @property (nonatomic, assign, readonly) unsigned long long <span class="hljs-type"><span class="hljs-type">int</span></span> phone; <span class="hljs-comment"><span class="hljs-comment">/**   ,    next,  nil */</span></span> @property (nonatomic, <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>, readonly, nullable) NSString *<span class="hljs-type"><span class="hljs-type">name</span></span>; - (instancetype)initWithFilePath:(NSString *)<span class="hljs-type"><span class="hljs-type">path</span></span>; - (<span class="hljs-type"><span class="hljs-type">BOOL</span></span>)next; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><pre> <code class="hljs pgsql"> #<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "DGSPhonesDataReader.h" @interface DGSPhonesDataReader () @property (nonatomic, strong, readonly) NSData *data; @property (nonatomic, assign) NSUInteger <span class="hljs-keyword"><span class="hljs-keyword">location</span></span>; @property (nonatomic, assign, readwrite) unsigned long long <span class="hljs-type"><span class="hljs-type">int</span></span> phone; @property (nonatomic, <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>, readwrite, nullable) NSString *<span class="hljs-type"><span class="hljs-type">name</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @implementation DGSPhonesDataReader - (instancetype)initWithFilePath:(NSString *)<span class="hljs-type"><span class="hljs-type">path</span></span> { self = [super init]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self == nil) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nil; NSError *error = nil; _data = [NSData dataWithContentsOfFile:<span class="hljs-type"><span class="hljs-type">path</span></span> <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>:NSDataReadingMappedIfSafe error:&amp;error]; _location = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_data == nil) { NSLog(@"DGSPhonesDataReader data create error: %@", error); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self; } - (<span class="hljs-type"><span class="hljs-type">BOOL</span></span>)next { uint16_t blockLength; [self.data getBytes:&amp;blockLength range:NSMakeRange(self.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span>, sizeof(blockLength))]; self.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span> += sizeof(blockLength); unsigned long long <span class="hljs-type"><span class="hljs-type">int</span></span> phone; NSUInteger textLength = blockLength - sizeof(phone); [self.data getBytes:&amp;phone range:NSMakeRange(self.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span>, sizeof(phone))]; self.phone = phone; self.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span> += sizeof(phone); uint8_t buffer[textLength]; [self.data getBytes:buffer range:NSMakeRange(self.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span>, textLength)]; self.name = [[NSString alloc] initWithBytes:buffer length:textLength <span class="hljs-keyword"><span class="hljs-keyword">encoding</span></span>:NSUTF8StringEncoding]; self.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span> += textLength; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.<span class="hljs-keyword"><span class="hljs-keyword">location</span></span> &lt; self.data.length; } @<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></div></div><br>  Yes, in theory, you need to use the cache, read in 8 KB block and all such cases.  But such an algorithm runs through the base of 2,000,000 numbers in 10 seconds in a separate system process, without affecting the main application in any way, and this happens once per update, so they decided not to bother much with optimization. <br><br>  Hooray!  Now we are able to safely parse phone numbers from the database, quietly fitting in the limit of 5 MB of memory.  But time passes, and the feature is still not ready. <br><br><h3>  Data delivery </h3><br>  Next, it was necessary to understand how to deliver this data to extension, that is, in fact, in a separate application.  Sew them there will not work, as the user downloads new regions, deletes the old ones, and we also want to update everything, the data becomes outdated, new ones are added, and we are a company about accuracy and relevance. <br><br>  It turned out that everything was invented for us and there is a <a href="https://developer.apple.com/library/content/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html">wonderful</a> App Groups feature that allows you to fumble data between two applications from one developer. <br><br>  You can put the file in the main application along the path: <br><br><pre> <code class="hljs lua"> + (NSString *)extensionDataPath { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">[[[NSFileManager defaultManager] containerURLForSecurityApplicationGroupIdentifier:[self extensionGroupName]]</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">path</span></span> stringByAppendingPathComponent:@<span class="hljs-string"><span class="hljs-string">"Dialer"</span></span>]; }</code> </pre><br>  and in extensions get it through: <br><br><pre> <code class="hljs objectivec"> <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *databasePath = [[DGSCallKitExtensionModel extensionDataPath] stringByAppendingPathComponent:manifest.databaseName];</code> </pre><br>  Although there were no delivery problems, and thanks for that. <br><br>  Then we prepared the data in the right format.  If you don‚Äôt go deep, a 500 MB file in .tsv format should be scattered across 108 regions, overtaken into a binary format, archived and created Jobs on jenkins, so as not to do all this with your hands and have a ready-made data wrapper for each release without much pain.  In short, we also spent a decent amount of time on this - about 90% of the entire development. <br><br>  The challenge was to deliver this data to the phone (the second 90% of the development). <br><br>  First, we decided to use the ‚ÄúOn demand resources‚Äù technology, and at the same time to find out why we need a third, always empty tab in xcode - Resource Tags. <br><br><img src="https://habrastorage.org/files/d54/e6c/853/d54e6c853cc744e282edfc6ad5a93b2e.png"><br><br>  These guys will tell better: <br><br><ul><li>  <a href="https://developer.apple.com/library/content/documentation/FileManagement/Conceptual/On_Demand_Resources_Guide/Tagging.html">Documentation</a> ; </li><li>  <a href="https://developer.apple.com/videos/play/wwdc2015/214/">Video from WWDC 2015</a> ; </li><li>  <a href="https://developer.apple.com/videos/play/wwdc2016/221/">Video from WWDC 2016</a> ; </li></ul><br>  In short, Resource Tags for us is just manna from heaven (namely Download Only On Demand).  It allows you to tag some application resources with tags, specify their type, and when you fill the application into the store, it will not include them in the binary.  Then they can be downloaded using NSBundleResourceRequest and obtained through the [NSBundle mainBundle].  That is, you don‚Äôt need to kick other teams at all, figure out how to store them and how to deliver them to the user.  And Apple itself stores all the data + provides a very adequate API for obtaining them.  What promised quick integration at least here. <br><br>  But not everything turned out so rosy: in the first release, this technology proved to be extremely lousy, and about 20% of users stupidly could not download.  After digging the Apple forums, we found out that we are not the only ones having such a problem, but they haven‚Äôt been fixing it for a long time and don‚Äôt react to it. <br><br>  Resource Tags had to cut and deliver data in another way.  As a result, we sewed the data into the city update database.  Now, along with the upgrade of the city, users receive new database of numbers. <br><br><h3>  All ahead </h3><br>  At the very least, the dialer got into the AppStore, and then the fourth ‚Äújoy‚Äù was waiting for us. <br><br>  After a successful installation, we deleted the bases, because why keep what is already in the phone memory.  It turned out that everything is not so simple: if the user enters the settings, turns the extensions off and on, then instead of simply turning on, the extensions follow the full update script.  My bad, we did not take this into account, and all those who did so lost bases without the possibility of updating them.  In the next version, we quickly corrected it and now we leave the data on the phone while it is still relevant. <br><br>  We constantly receive complaints that the determinant is not working, or questions about how to turn it on.  So far, as an intermediate option, we have made a separate item about the determinant in the 2GIS settings. <br><br>  With iOS 10.3, Apple threw up more problems: if you upgrade to this version, the determinant disappears in the settings until the user either reinstalls the application or rolls in the update.  The extension generally behaves unstably.  Periodically (for unknown reasons and laws) it turns off or disappears completely from the settings when updating.  Sometimes, in the process of updating numbers, the system silently nails extension with error codes: <br><br>  ‚Üí CXErrorCodeCallDirectoryManagerErrorLoadingInterrupted; <br>  ‚Üí CXErrorCodeCallDirectoryManagerErrorUnknown. <br><br>  Back in October, we created a couple of radars at Apple with a request to give us a handle to allow users to turn on the dialer from the application itself, and about bugs from 10.3.  The first Apple ticket is ignored since October, and the second is in a sooo long queue. <br><br><img src="https://habrastorage.org/files/05c/02c/de8/05c02cde813943b293b1f5f5a0937c06.png"><br><br>  So in the near future we can hardly make the product better for the user. <br><br>  <b>How it all works in the end:</b> <br><br><ol><li>  User downloads city / cities; </li><li>  From the city gets the base numbers in our format; </li><li>  We look at all the databases that are installed by the user (we store them in the general UserDefaults between the extension and the main application); </li><li>  Each base has a hash.  If at least one hash does not match or a new one has appeared, we write all new databases to the common storage and mark them as ready to install.  This is necessary in case the user did not activate extension, but turned off the application and turn it on later; </li><li>  If the extension is active, reboot it after: <br><br><pre> <code class="hljs css"> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[[CXCallDirectoryManager sharedInstance]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">reloadExtensionWithIdentifier</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:bundleID</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">completionHandler</span></span>:^(<span class="hljs-selector-tag"><span class="hljs-selector-tag">NSError</span></span> * _<span class="hljs-selector-tag"><span class="hljs-selector-tag">Nullable</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">error</span></span>) {}];</code> </pre><br></li><li>  In the extension itself, when it receives: <br><br><pre> <code class="hljs objectivec"> - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)beginRequestWithExtensionContext:(CXCallDirectoryExtensionContext *)context</code> </pre><br>  we are looking to see if there are databases ready for installation.  If there is, we run through everything and add numbers through: <br><br><pre> <code class="hljs vhdl"> [<span class="hljs-keyword"><span class="hljs-keyword">context</span></span> addIdentificationEntryWithNextSequentialPhoneNumber:phone <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>:name];</code> </pre><br></li><li>  Mark the bases as installed; </li><li>  Repeat the process for each update; </li></ol><br><div class="spoiler">  <b class="spoiler_title">In code, it looks like this:</b> <div class="spoiler_text"><pre> <code class="hljs ruby"> - (RACSignal *)reloadExtensionsIfNeeded { @weakify(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (![DGSCallKitFetchModel isExtensionAvailable] <span class="hljs-params"><span class="hljs-params">||</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.manifests.count == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [RACSignal empty]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [[[[[[[[[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> fetchCanBeInstalledExtensionsRegionCodes] <span class="hljs-symbol"><span class="hljs-symbol">filter:</span></span>^BOOL(NSSet *regionCodes) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> regionCodes.count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; }] <span class="hljs-symbol"><span class="hljs-symbol">deliverOn:</span></span>[RACScheduler scheduler]] <span class="hljs-symbol"><span class="hljs-symbol">flattenMap:</span></span>^RACStream *(NSSet *regionCodes) { @strongify(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [RACSignal <span class="hljs-symbol"><span class="hljs-symbol">combineLatest:</span></span>@[ [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-symbol"><span class="hljs-symbol">downloadDatabasesWithRegionCodesIfNeeded:</span></span>regionCodes], [DGSCallKitFetchModel fetchExtensionEnabled] ]]; }] <span class="hljs-symbol"><span class="hljs-symbol">flattenMap:</span></span>^RACStream *(RACTuple *t) { @strongify(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); RACTupleUnpack(NSSet *regionCodes, NSNumber *extensionEnabled) = t; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!extensionEnabled.boolValue) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [RACSignal empty]; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    ,     , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>            , <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-symbol"><span class="hljs-symbol">shouldInstallDatabasesWithRegionCodes:</span></span>regionCodes]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [RACSignal <span class="hljs-symbol"><span class="hljs-symbol">return:</span></span>regionCodes]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-symbol"><span class="hljs-symbol">dialerEnabledWithRegionCodes:</span></span>regionCodes]) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-symbol"><span class="hljs-symbol">trackDialerInstalledEventWithRegionCodes:</span></span>regionCodes]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [RACSignal empty]; }] <span class="hljs-symbol"><span class="hljs-symbol">flattenMap:</span></span>^RACStream *(NSSet *regionCodes) { @strongify(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-symbol"><span class="hljs-symbol">updateExtensionWithRegionCodes:</span></span>regionCodes]; }] <span class="hljs-symbol"><span class="hljs-symbol">doNext:</span></span>^(NSSet *regionCodes) { @strongify(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); ULogInfo(@<span class="hljs-string"><span class="hljs-string">"Dialer extension installed with region codes: %@"</span></span>, regionCodes); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-symbol"><span class="hljs-symbol">trackDialerInstalledEventWithRegionCodes:</span></span>regionCodes]; }] <span class="hljs-symbol"><span class="hljs-symbol">doError:</span></span>^(NSError *error) { @strongify(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>); ULogError(@<span class="hljs-string"><span class="hljs-string">"Dialer extension error: %@"</span></span>, error); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.analyticsSender <span class="hljs-symbol"><span class="hljs-symbol">trackEventWithCategory:</span></span>kDGSCategoryDialer <span class="hljs-symbol"><span class="hljs-symbol">action:</span></span>kDGSActionDialerFailed <span class="hljs-symbol"><span class="hljs-symbol">label:</span></span>error.localizedDescription <span class="hljs-symbol"><span class="hljs-symbol">value:</span></span><span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; }] <span class="hljs-symbol"><span class="hljs-symbol">doCompleted:</span></span>^{ ULogInfo(@<span class="hljs-string"><span class="hljs-string">"Dialer extension reload completed signal"</span></span>); }]; } + (RACSignal *)fetchExtensionEnabled { NSString *bundleID = [DGSCallKitExtensionModel extensionBundleID]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [RACSignal <span class="hljs-symbol"><span class="hljs-symbol">createSignal:</span></span>^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) { [[CXCallDirectoryManager sharedInstance] <span class="hljs-symbol"><span class="hljs-symbol">getEnabledStatusForExtensionWithIdentifier:</span></span>bundleID <span class="hljs-symbol"><span class="hljs-symbol">completionHandler:</span></span>^(CXCallDirectoryEnabledStatus enabledStatus, NSError * _Nullable error) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enabledStatus == CXCallDirectoryEnabledStatusEnabled) { [subscriber <span class="hljs-symbol"><span class="hljs-symbol">sendNext:</span></span>@YES]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { [subscriber <span class="hljs-symbol"><span class="hljs-symbol">sendNext:</span></span>@NO]; } [subscriber sendCompleted]; }]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; }]; } - (RACSignal *)<span class="hljs-symbol"><span class="hljs-symbol">updateExtensionWithRegionCodes:</span></span>(NSSet&lt;NSString *&gt; *)regionCodes { ULogInfo(@<span class="hljs-string"><span class="hljs-string">"Reload dialer extension with tag: %@"</span></span>, regionCodes); NSString *bundleID = [DGSCallKitExtensionModel extensionBundleID]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [RACSignal <span class="hljs-symbol"><span class="hljs-symbol">createSignal:</span></span>^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) { [[CXCallDirectoryManager sharedInstance] <span class="hljs-symbol"><span class="hljs-symbol">reloadExtensionWithIdentifier:</span></span>bundleID <span class="hljs-symbol"><span class="hljs-symbol">completionHandler:</span></span>^(NSError * _Nullable error) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error) { [subscriber <span class="hljs-symbol"><span class="hljs-symbol">sendError:</span></span>error]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { [subscriber <span class="hljs-symbol"><span class="hljs-symbol">sendNext:</span></span>regionCodes]; [subscriber sendCompleted]; } }]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; }]; }</code> </pre><br></div></div><br>  The main problem with the implementation of this feature was the preparation of data and their delivery to the application.  If you sew in extensions about 100,000 phones, then the feature can be done in an hour (provided that you have them). <br><br>  If there is no data in a ready-made format and they need to be delivered and updated in a tricky way, then the integration of this feature will take a lot of time, and because of the complexity of its inclusion, users, unfortunately, will not tell you "many thanks".  In the majority of reviews there will be something like ‚Äúit doesn‚Äôt work for me‚Äù, ‚ÄúI downloaded the application, but it doesn‚Äôt determine anything‚Äù and stuff like that. <br><br><h3>  Instead of conclusion </h3><br>  At the moment, the feature is completed, in the near future there are no plans to finalize it.  But I still want to make a selection of the most identifiable numbers - somewhere in the region of 100,000 numbers - and sew them immediately into extension, so that users immediately get the minimum functionality without having to download regions.  We also have quite a lot of data on ‚Äútoxic‚Äù numbers: collection agencies, various kinds of polls, various financial pyramids and other objectionable numbers that the Dialer users on Android complained about.  We can also deliver them as a separate package to everyone. <br><br><img src="https://habrastorage.org/files/978/b0e/c8d/978b0ec8d677493293c899e3e0f857cd.jpg"><br><br>  In general, I wanted something more stable and more user-friendly, so that even my mother herself could turn it on.  In any case, at least 20,000 users turned on extension, and this is a real benefit and a feeling that everything was not in vain. </div><p>Source: <a href="https://habr.com/ru/post/323050/">https://habr.com/ru/post/323050/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323040/index.html">JPoint 2017 Java Conference: Moscow, April 7-8 - Review reports</a></li>
<li><a href="../323042/index.html">Zabbix 3.X: monitoring Adaptec controllers on Windows Server (Hyper-V Core)</a></li>
<li><a href="../323044/index.html">How we reconstructed the courthouse in Smolensk: from laser scans of stucco molding under mold to release</a></li>
<li><a href="../323046/index.html">SharePoint 2013/2016 database maintenance</a></li>
<li><a href="../323048/index.html">1,500,000 installations in 3 months - Tap Tap Builder development history</a></li>
<li><a href="../323052/index.html">Safe Builder on Scala and Java</a></li>
<li><a href="../323056/index.html">News of our online courses: updated course "Web-technologies" and added "Statement of tasks for software development"</a></li>
<li><a href="../323058/index.html">Superjob Data Science Meetup. Live broadcast</a></li>
<li><a href="../323060/index.html">How my friends and I pumped our third-party project to a business with an income of $ 17,000 per month</a></li>
<li><a href="../323066/index.html">Promises on the example of a burger party</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>