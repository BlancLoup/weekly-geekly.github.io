<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We deal with Zabbix API in C #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Zabbiks has an open API for accessing monitoring server functions. Unfortunately, the implementation of the library for accessing the API exists only ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We deal with Zabbix API in C #</h1><div class="post__text post__text-html js-mediator-article">  Zabbiks has an open API for accessing monitoring server functions.  Unfortunately, the implementation of the library for accessing the API exists only for Ruby, PHP and Python.  I had to reinvent the wheel by myself.  Access to all functions is via <a href="http://en.wikipedia.org/wiki/JSON-RPC">JSONRPC</a> .  For example, the request, the response of the function to get the <em>Zabbix API</em> version looks like this: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">{ <font color="#A31515">"jsonrpc"</font> : <font color="#A31515">"2.0"</font> , <font color="#A31515">"method"</font> : <font color="#A31515">"apiinfo.version"</font> , <font color="#A31515">"params"</font> :[], <font color="#A31515">"auth"</font> : <font color="#A31515">"a6e895b98fde40f4f7badf112fd983bf"</font> , <font color="#A31515">"id"</font> :2 } &lt;br&gt;{ <font color="#A31515">"jsonrpc"</font> : <font color="#A31515">"2.0"</font> , <font color="#A31515">"result"</font> : <font color="#A31515">"1.3"</font> , <font color="#A31515">"id"</font> :2 }</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><a name="habracut"></a><br>  A detailed description of the protocol JSON-RPC is not included in the purpose of the article, proceed to the implementation: <br><blockquote><ol><li> <code><font color="black"><font color="#0000ff">private</font> <font color="#0000ff">string</font> GetWebRequest( <font color="#0000ff">string</font> body)</font></code> </li> <li> <code><font color="black">{</font></code> </li> <li> <code><font color="black">WebRequest wb = WebRequest.Create(url);</font></code> </li> <li> <code><font color="black">wb.ContentType = <font color="#A31515">@"application/json-rpc"</font> ;</font></code> </li> <li> <code><font color="black">wb.Credentials = CredentialCache.DefaultCredentials;</font></code> </li> <li> <code><font color="black">ASCIIEncoding encoding = <font color="#0000ff">new</font> ASCIIEncoding();</font></code> </li> <li> <code><font color="black"><font color="#0000ff">string</font> postData = body;</font></code> </li> <li> <code><font color="black"><font color="#0000ff">byte</font> [] data = encoding.GetBytes(postData);</font></code> </li> <li> <code><font color="black">wb.Method = <font color="#A31515">"POST"</font> ;</font></code> </li> <li> <code><font color="black">wb.ContentLength = data.Length;</font></code> </li> <li> <code><font color="black"><font color="#2B91AF">Stream</font> newStream = wb.GetRequestStream();</font></code> </li> <li> <code><font color="black">newStream.Write(data, 0, data.Length);</font></code> </li> <li> <code><font color="black">newStream.Close();</font></code> </li> <li> <code><font color="black">HttpWebResponse response = (HttpWebResponse)wb.GetResponse();</font></code> </li> <li> <code><font color="black"><font color="#2B91AF">Stream</font> dataStream = response.GetResponseStream();</font></code> </li> <li> <code><font color="black">StreamReader reader = <font color="#0000ff">new</font> StreamReader(dataStream);</font></code> </li> <li> <code><font color="black"><font color="#0000ff">return</font> reader.ReadToEnd();</font></code> </li> <li> <code><font color="black">}</font></code> </li> <li> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">string</font> obj2json( <font color="#0000ff">object</font> obj)</font></code> </li> <li> <code><font color="black">{</font></code> </li> <li> <code><font color="black">JavaScriptSerializer serializer = <font color="#0000ff">new</font> JavaScriptSerializer();</font></code> </li> <li> <code><font color="black"><font color="#0000ff">return</font> serializer.Serialize(obj);</font></code> </li> <li> <code><font color="black">}</font></code> </li> <li> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">string</font> CallApi( <font color="#0000ff">string</font> method, <font color="#0000ff">object</font> param)</font></code> </li> <li> <code><font color="black">{</font></code> </li> <li> <code><font color="black"><font color="#0000ff">object</font> Query = <font color="#0000ff">new</font></font></code> </li> <li> <code><font color="black">{</font></code> </li> <li> <code><font color="black">jsonrpc = <font color="#A31515">"2.0"</font> ,</font></code> </li> <li> <code><font color="black">auth = auth_hash,</font></code> </li> <li> <code><font color="black">id = id.ToString(),</font></code> </li> <li> <code><font color="black">method = method,</font></code> </li> <li> <code><font color="black">Params = param</font></code> </li> <li> <code><font color="black">};</font></code> </li> <li> <code><font color="black"><font color="#2B91AF">String</font> qr = obj2json(Query);</font></code> </li> <li> <code><font color="black">qr=qr.Replace( <font color="#A31515">"Params"</font> , <font color="#A31515">"params"</font> );</font></code> </li> <li> <code><font color="black">id++;</font></code> </li> <li> <code><font color="black"><font color="#0000ff">string</font> result = GetWebRequest(qr);</font></code> </li> <li> <code><font color="black"><font color="#0000ff">return</font> result;</font></code> </li> <li> <code><font color="black">}</font></code> </li> </ol><br> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The <strong>CallAPI</strong> function makes an API call to the function.  Accepts a method and its parameters (in the form of an object according to the documentation of the Zabbix API).  Examples of use will be slightly lower.  The purpose of <strong>obj2json</strong> , and <strong>GetWebRequest</strong> I think obviously, I will add only that the request is sent by the POST method.  Consider the use of this function on the example of authorization on the server.  For authorization, we need to send a request for the ‚Äúuser.authenticate‚Äù method with user and password parameters.  The result will be auth_hash, which is the field of each subsequent query.  The finished function for authorization with the foregoing will look like this: <br><blockquote><ol><li> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">bool</font> login()</font></code> </li> <li> <code><font color="black">{</font></code> </li> <li> <code><font color="black"><font color="#0000ff">bool</font> res;</font></code> </li> <li> <code><font color="black">Update( <font color="#0000ff">new</font> UpdateInfoMessage( <font color="#0000ff">this</font> ) { message = <font color="#A31515">" "</font> , status = <font color="#A31515">"LOGIN"</font> });</font></code> </li> <li> <code><font color="black"><font color="#0000ff">try</font></font></code> </li> <li> <code><font color="black">{</font></code> </li> <li> <code><font color="black"><font color="#0000ff">var</font> userinfo = <font color="#0000ff">new</font> { user = _user, password = _password };</font></code> </li> <li> <code><font color="black"><font color="#0000ff">string</font> result = CallApi( <font color="#A31515">"user.authenticate"</font> , userinfo);</font></code> </li> <li> <code><font color="black">auth_hash = (serializer.Deserialize&lt; <font color="#0000ff">string</font> &gt;(result)).result;</font></code> </li> <li> <code><font color="black">res= <font color="#0000ff">true</font> ;</font></code> </li> <li> <code><font color="black">Update( <font color="#0000ff">new</font> UpdateInfoMessage( <font color="#0000ff">this</font> ) { message = <font color="#A31515">"  "</font> , status = <font color="#A31515">"LOGIN"</font> });</font></code> </li> <li> <code><font color="black">}</font></code> </li> <li> <code><font color="black"><font color="#0000ff">catch</font> (Exception ex)</font></code> </li> <li> <code><font color="black">{</font></code> </li> <li> <code><font color="black">Update( <font color="#0000ff">new</font> UpdateInfoMessage( <font color="#0000ff">this</font> ) { message = <font color="#A31515">" :"</font> + ex.Message, status = <font color="#A31515">"LOGIN"</font> });</font></code> </li> <li> <code><font color="black">res= <font color="#0000ff">false</font> ;</font></code> </li> <li> <code><font color="black">}</font></code> </li> <li> <code><font color="black"><font color="#0000ff">return</font> res;</font></code> </li> <li> <code><font color="black">}</font></code> </li> </ol><br> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  As you can see, the logic to the disgrace is simple, we describe the parameters, set the name of the method, call the function.  If everything went well and there is an <em>auth_hash</em> , then we save it in the global class field and return a positive result.  If something went wrong, we catch the error and return a lie.  It is also worth mentioning the <strong>Update</strong> function - it is used to notify the main application about changes in our class.  So, we learned to fulfill the request and receive simple answers from the server.  But most of the responses from the server are arrays of completely different elements.  To simplify the addition of a new functional, the following generalized class was created: <br><blockquote><ol><li> <code><code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> Result: <font color="#2B91AF">IEnumerable</font></font> <br> <font color="black">{</font></code> <br> <code><font color="black"><font color="#008000">//      </font></font></code> <br> <code><font color="black"><font color="#0000ff">public</font> T[] result;</font></code> <br> <code><font color="black">&nbsp;</font></code> <br> <code><font color="black"><font color="#008000">///    </font></font></code> <br> <code><font color="black"><font color="#0000ff">public</font> ZabbixConnection server;</font></code> <br> <code><font color="black">&nbsp;</font></code> <br> <code><font color="black"><font color="#008000">//   Zabbix API,  maps.get, triggers.update  .</font></font></code> <br> <code><font color="black"><font color="#0000ff">protected</font> <font color="#0000ff">string</font> method;</font></code> <br> <code><font color="black">&nbsp;</font></code> <br> <code><font color="black"><font color="#008000">//      </font></font></code> <br> <code><font color="black"><font color="#0000ff">protected</font> <font color="#0000ff">object</font> Params;</font></code> <br> <code><font color="black">&nbsp;</font></code> <br> <code><font color="black"><font color="#008000">//    ,     </font></font></code> <br> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">string</font> stringResult;</font></code> <br> <code><font color="black">&nbsp;</font></code> <br> <code><font color="black"><font color="#008000">//       .</font></font></code> <br> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">object</font> SyncRoot;</font></code> <br> <code><font color="black">&nbsp;</font></code> <br> <code><font color="black">&nbsp;</font></code> <br> <code><font color="black"><font color="#008000">//      ,      "method"  "Params"</font></font></code> <br> <code><font color="black"><font color="#0000ff">protected</font> <font color="#0000ff">virtual</font> <font color="#0000ff">void</font> init() { }</font></code> <br> <code><font color="black">&nbsp;</font></code> <br> <code><font color="black"><font color="#0000ff">public</font> Result(ZabbixConnection Server)</font></code> <br> <code><font color="black">{</font></code> <br> <code><font color="black">init();</font></code> <br> <code><font color="black">server = Server;</font></code> <br> <code><font color="black">SyncRoot = <font color="#0000ff">new</font> <font color="#0000ff">object</font> ();</font></code> <br> <code><font color="black">}</font></code> <br> <code><font color="black"><font color="#0000ff">public</font> Result()</font></code> <br> <code><font color="black">{</font></code> <br> <code><font color="black">init();</font></code> <br> <code><font color="black">}</font></code> <br> <code><font color="black">&nbsp;</font></code> <br> <code><font color="black"><font color="#008000">//    ,     result  collection</font></font></code> <br> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">virtual</font> <font color="#0000ff">void</font> <font color="#0000ff">get</font> ()</font></code> <br> <code><font color="black">{</font></code> <br> <code><font color="black">JavaScriptSerializer serializer = <font color="#0000ff">new</font> JavaScriptSerializer();</font></code> <br> <code><font color="black"><font color="#0000ff">lock</font> (SyncRoot)</font></code> <br> <code><font color="black">{</font></code> <br> <code><font color="black">stringResult = (server.CallApi(method, Params));</font></code> <br> <code><font color="black">result = serializer.Deserialize&lt;Result&gt;(stringResult).result;</font></code> <br> <code><font color="black"><font color="#0000ff">if</font> (result== <font color="#0000ff">null</font> ){result= <font color="#0000ff">new</font> T[1];}</font></code> <br> <code><font color="black">}</font></code> <br> <code><font color="black">}</font></code> <br> <code><font color="black">&nbsp;</font></code> <br> <code><font color="black"><font color="#0000ff">public</font> T <font color="#0000ff">this</font> [ <font color="#0000ff">int</font> index]</font></code> <br> <code><font color="black">{</font></code> <br> <code><font color="black"><font color="#0000ff">get</font></font></code> <br> <code><font color="black">{</font></code> <br> <code><font color="black"><font color="#0000ff">return</font> result[index];</font></code> <br> <code><font color="black">}</font></code> <br> <code><font color="black">}</font></code> <br> <code><font color="black">&nbsp;</font></code> <br> <code><font color="black"><font color="#0000ff">public</font> IEnumerator GetEnumerator()</font></code> <br> <code><font color="black">{</font></code> <br> <code><font color="black"><font color="#0000ff">foreach</font> (T item <font color="#0000ff">in</font> result)</font></code> <br> <code><font color="black">{</font></code> <br> <code><font color="black"><font color="#0000ff">yield</font> <font color="#0000ff">return</font> item;</font></code> <br> <code><font color="black">}</font></code> <br> <code><font color="black">}</font></code> <br> <code><font color="black">IEnumerator <font color="#2B91AF">IEnumerable</font> .GetEnumerator()</font></code> <br> <code><font color="black">{</font></code> <br> <code><font color="black"><font color="#0000ff">return</font> GetEnumerator();</font></code> <br> <code><font color="black">}</font></code> <br> <code><font color="black">}</font></code> <br> <br> <br> <br>   ,          <em>Zabbix API</em> .       ,   <strong>Init</strong> ,          .   : <br></code> <blockquote><ol><li> <code><font color="black"><font color="#0000ff">using</font> System;</font></code> </li> <li> <code><font color="black"><font color="#0000ff">using</font> System.Collections. <font color="#2B91AF">Generic</font> ;</font></code> </li> <li> <code><font color="black"><font color="#0000ff">using</font> System.Collections.ObjectModel;</font></code> </li> <li> <code><font color="black"><font color="#0000ff">using</font> System.Linq;</font></code> </li> <li> <code><font color="black"><font color="#0000ff">using</font> System.Text;</font></code> </li> <li> <code><font color="black">&nbsp;</font></code> </li><li> <code><font color="black"><font color="#0000ff">namespace</font> Zabbix</font></code> </li> <li> <code><font color="black">{</font></code> </li> <li> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> Hosts:Result</font></code> <br> <code><font color="black">{</font></code> <br> <code><font color="black"><font color="#0000ff">protected</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> init()</font></code> <br> <code><font color="black">{</font></code> <br> <code><font color="black">method = <font color="#A31515">"host.get"</font> ;</font></code> <br> <code><font color="black">Params = <font color="#0000ff">new</font> { output = <font color="#A31515">"extend"</font> };</font></code> <br> <code><font color="black">}</font></code> <br> <code><font color="black">&nbsp;</font></code> <br> <code><font color="black"><font color="#0000ff">public</font> Hosts(ZabbixConnection Server) : <font color="#0000ff">base</font> (Server) { }</font></code> <br> <code><font color="black">&nbsp;</font></code> <br> <code><font color="black">}</font></code> <br> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> Host</font></code> <br> <code><font color="black">{</font></code> <br> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">string</font> host;</font></code> <br> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">string</font> hostid;</font></code> <br> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">string</font> ip;</font></code> <br> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">string</font> ToString()</font></code> <br> <code><font color="black">{</font></code> <br> <code><font color="black"><font color="#0000ff">return</font> host;</font></code> <br> <code><font color="black">}</font></code> <br> <code><font color="black">}</font></code> <br> <code><font color="black">}</font></code> <br> </li></ol><br>  I think everything here is also quite simple, in the same way you can get any data, be it triggers, host groups, events, or graph data.  Descriptions of all methods and parameters can be found in the documentation section of the <em>Zabbix API</em> .  I feel the topic and so it turned out not small, and it's time to wrap up.  I described the way to use <em>Zabbix API</em> in .NET applications as short as possible.  A more complete library code, as well as a sample client on WPF, can be downloaded here: <a href="https://github.com/p1nger/odzl">https://github.com/p1nger/odzl</a> </blockquote></li></ol></blockquote></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/111641/">https://habr.com/ru/post/111641/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111635/index.html">All new!</a></li>
<li><a href="../111636/index.html">Infographics: Censorship on the Internet. It seems to you that the Internet is independent</a></li>
<li><a href="../111637/index.html">6-week Google Chrome update cycle</a></li>
<li><a href="../111638/index.html">Laziness (Mechanism, Part 2): Objectives</a></li>
<li><a href="../111640/index.html">Manage IT-projects - how to play rugby</a></li>
<li><a href="../111642/index.html">How not to trample the tracks in the park</a></li>
<li><a href="../111643/index.html">Cross Domain Data Exchange</a></li>
<li><a href="../111646/index.html">Deserialization of huge and erroneous xml-files</a></li>
<li><a href="../111647/index.html">Google docs viewer</a></li>
<li><a href="../111649/index.html">Selenium: waiting for all AJAX requests to complete</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>