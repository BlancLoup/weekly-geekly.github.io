<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WhatsApp architecture Facebook bought for $ 19 billion</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once again, I want to offer my translation of the article, this time by Todd Hoff, and his article is devoted to WhatsApp architecture at the time of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WhatsApp architecture Facebook bought for $ 19 billion</h1><div class="post__text post__text-html js-mediator-article"><p>  <em>Once again, I want to offer my translation of the article, this time by Todd Hoff, and his article is devoted to WhatsApp architecture at the time of his purchase of Facebook.</em> </p><br><p>  <em>Remark: the beginning of the article contains the reasoning of the author of the original about why Facebook bought WhatsApp for a fabulous 19 billion.</em>  <em>If this is not interesting to you - just scroll through, the description of the architecture will be below.</em> </p><br><p>  <a href="https://www.linkedin.com/in/rick-reed-4271862">Rick Reed</a> in his upcoming March report entitled <a href="http://lanyrd.com/2014/erlangfactory/scwqrt/">"A Billion with a Big 'M': The Next Level of Scaling in WhatsApp"</a> reveals the stunning WhatsApp statistics: </p><br><blockquote>  What has hundreds of nodes, thousands of cores, hundreds of terabytes of RAM and hopes to serve billions of smartphones that will soon become a reality around the world?  Erlang and FreeBSD-based WhatsApp architecture.  We encountered many difficulties in meeting the ever-growing demand for our messaging service, but we continue to expand our system in terms of size (&gt; 8000 cores) and in terms of speed (&gt; 70M Erlang messages per second). </blockquote><a name="habracut"></a><br><p>  But since we do not yet have this report, let's look at the report that Rick Reed made two years ago: <a href="https://vimeo.com/44312354">"Scaling to millions of simultaneous connections</a> . <a href="https://vimeo.com/44312354">"</a> </p><br><p>  With experience in developing high-performance messaging bus in C ++ at Yahoo, Rick Reed is no stranger to the world of scalable architectures.  The founders of WhatsApp are also former Yahoo employees with considerable experience in scaling systems.  So whatsapp works due to their scaling skills.  And since their Big Bold goal is to be on every smartphone in the world, of which there will be about 5 billion in a few years, they will need all this experience. </p><br><p>  Before we get to the facts, let's digress to this astounding riddle: how could WhatsApp ever be valued by Facebook at $ 19 billion? </p><br><p>  If you ask me, as a programmer, if WhatsApp is worth such money, I will answer that, of course, no!  It's just sending data over the network!  Well really.  True, I am one of those who believe that the blog platform is not needed, because there is nothing difficult in connecting remotely to the server, opening index.html using vi and writing your post in HTML.  It took me a while to understand that development is not writing stupid code, it is a way to make all those users love your product, which is the most difficult.  Love can not buy. </p><br><p>  So what makes WhatsApp so valuable?  Technology?  Do not pay attention to those who say that in a week they will be able to write WhatsApp in PHP.  This is simply not true.  As we will see, this is a very cool technology.  But, of course, Facebook has enough resources to develop WhatsApp, if they wanted. </p><br><p>  Let's look at the features.  We all know that WhatsApp is a product <a href="http://sequoiacapital.tumblr.com/post/77211282835/four-numbers-that-explain-why-facebook-acquired">without tricks</a> (no ads, games, tricks) with dedicated <a href="http://www.wired.com/2014/02/whatsapp-rules-rest-world/">users all over the world</a> .  He offers free messages in a harsh world where SMS bills can be terrible.  As a visiting American, I was very surprised at how many real people use WhatsApp to really stay in touch with their family and friends.  So when you take WhatsApp, it‚Äôs likely that the people you know are already there, since everyone has a phone that eliminates the problem of an empty social network.  It is aggressively cross-platform, so that everyone you know can use it and it will just work.  The phrase he "just works" is often used.  It has all the features (you can share location, sound, video, pictures, push-to-talk, voice messages and photos, delivery notification, group chats, sending messages via WiFi, and all this can be done regardless of addressee or not).  It also supports the display of national writing systems.  And the use of a mobile phone number as an identifier and contacts as a social graph is devilishly simple.  No confirmation by email, username and password, no credit card number required.  It just works. </p><br><p>  It's all cool, but it's not worth $ 19 billion.  Other products can compete with them in terms of features. </p><br><p>  The possible reason is that <a href="https://www.theinformation.com/Google-Was-Willing-to-Beat-Facebook-s-19-Billion-Offer-for-WhatsApp">Google wanted to buy WhatsApp</a> , offering 99 cents per user.  This is a <a href="http://www.forbes.com/sites/parmyolson/2013/12/19/watch-out-facebook-whatsapp-climbs-past-400-million-active-users/">threat</a> to Facebook, they are <a href="http://www.foxbusiness.com/features/2014/02/21/facebook-buying-whatsapp-is-desperate-move.html">just desperate</a> .  This money is offered for your <a href="http://www.theregister.co.uk/2014/02/20/facebook_whatsapp_19bn_buy_also_45_for_your_phonebook/">phone book</a> and for metadata (even considering that WhatsApp does not store them). </p><br><p>  This is over <a href="http://sequoiacapital.tumblr.com/post/77211282835/four-numbers-that-explain-why-facebook-acquired">450 million active users</a> with a million growth every day and a potential of a billion users.  Facebook needs WhatsApp to get the next billion users.  But if so, then this is only a part.  And the price of about $ 40 per user does not look inadequate, especially when paying for shares.  Facebook bought Instagram for <a href="http://fortune.com/2012/04/10/why-instagram-is-worth-1b-to-facebook/">$ 30 per user</a> .  Twitter user costs <a href="http://www.forbes.com/sites/georgeanders/2013/11/07/a-twitter-user-is-worth-110-facebooks-98-linkedins-93/">$ 110</a> . </p><br><p>  Benedict Evans <a href="https://www.youtube.com/watch%3Fv%3DVnhbvS0MBXE">claims</a> that the mobile market is over a trillion dollars, and WhatsApp is undermining the SMS industry, which generates $ 100 billion in revenue by sending 18 billion messages a day, while only 20 billion SMS are sent globally.  With the fundamental transition from personal computers to almost universal smartphones, the size of opportunities is much larger than the target market than the one that is familiar to Facebook. </p><br><p>  But Facebook promised that there would be no advertising, no association of services, so what's the benefit? </p><br><p>  There is an interesting <a href="http://www.happymarketer.com/singapore-is-progressively-doing-business-over-whatsapp-are-you">business</a> development <a href="http://www.happymarketer.com/singapore-is-progressively-doing-business-over-whatsapp-are-you">through the use of mobile technologies</a> .  WhatsApp is used to create group discussions with project teams, and investors discuss the progress of transactions through WhatsApp. </p><br><p>  Instagram is used in Kuwait for the <a href="http://storify.com/cbccommunity/kuwait-entrepreneurs-use-instagram-to-sell-sheep">sheep trade</a> . </p><br><p>  WeChat, a competitor to WhatsApp, launched a taxi hire service in January, for the first month <a href="http://www.techinasia.com/wechat-21-million-taxi-rides-booked/">21 million cars</a> were hired. </p><br><p>  With the future of e-commerce sent by mobile apps to send messages, is it worth playing this field? </p><br><p> Not only business uses WhatsApp for tasks that were once solved by desktop or web applications.  Spanish police use WhatsApp to catch criminals, Italians organize basketball teams with his help. </p><br><p>  Commercial and other applications are moving to mobile phones for obvious reasons.  Everyone has a phone, and these instant messengers are full of features, free and cheap to use.  You no longer need a desktop computer to do business.  Many functions can be overridden by the mobile application. </p><br><p>  Thus, instant messaging is a threat to Google and Facebook.  Desktop computers are dead.  The web is dying.  Instant messaging + mobile technology <a href="https://news.ycombinator.com/item%3Fid%3D7282876">is an ecosystem that can replace them</a> .  Instant messaging has become the <a href="http://cubed.fm/2014/02/cubed-episode-18-the-paradigm-shift-of-mobile-engagement-models/">focus of interaction</a> in mobile technology, rather than search, by changing the search and nature of which applications will conquer the future.  We are not just anticipating PageRank, we are anticipating the web. </p><br><p>  Facebook should get into this market, or become useless. </p><br><p>  With the transition to the mobile, we see the deportalization of Facebook.  Its desktop interface is a portal that provides access to all features of the backend.  He is big, tangled and squeaky.  Who likes the Facebook interface at all? </p><br><p>  When Facebook came to mobile devices, they tried the portal approach and it did not work.  So they moved to the strategy of small, more focused <a href="http://www.theverge.com/2014/1/16/5269664/facebook-plans-suite-of-standalone-mobile-apps-for-2014">applications for a single task</a> .  Mobile first!  Not much can be done on the small screen.  On a mobile phone, it is easier to find a separate application than a menu buried deep in the depths of a confusing portal application. </p><br><p>  But Facebook goes one step further.  Not only do they develop individual applications for specific tasks, they provide several competing applications that provide similar functionality, and these applications do not necessarily have a common backend.  We see this in the example of WhatsApp and Messenger, and Instagram competes with photos on Facebook.  Paper is an alternative Facebook interface that provides limited functionality, but what it does, it does well. </p><br><p>  Conway‚Äôs law may apply here.  The idea is that "organizations, design systems ... usually generate an architecture that replicates the communication structure of these organizations."  With a monolithic backend infrastructure, we get a portal design similar to <a href="https://ru.wikipedia.org/wiki/%25D0%2591%25D0%25BE%25D1%2580%25D0%25B3_(%25D0%2597%25D0%25B2%25D1%2591%25D0%25B7%25D0%25B4%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BF%25D1%2583%25D1%2582%25D1%258C)">Borg</a> .  The transition to mobile technology frees organizations from such thinking.  If applications that use only part of the Facebook infrastructure can be developed, then applications that do not use the Facebook infrastructure at all can be developed.  And if they do not use the Facebook infrastructure, then they may not be developed on Facebook.  What then is Facebook? </p><br><p>  Facebook CEO Mark Zuckerberg has his own point of view, voiced at the <a href="http://techcrunch.com/2014/02/24/whatsapp-is-actually-worth-more-than-19b-says-facebooks-zuckerberg/">Mobile World Congress</a> conference, that the WhatsApp takeover is closely related to Internet.org: </p><br><blockquote>  The idea is to develop a set of basic free Internet services - "911 Internet".  It could be a social network, like Facebook, an instant messenger, maybe a search, and other things, like the weather.  The set of these free services will work as a kind of drug - users who can afford data services and phones simply do not see the point in paying for these services.  This will give them some context that will show them why services are important and this will encourage them to pay for other similar services - there is such hope. </blockquote><br><p>  It is a long game, but it contains enough values ‚Äã‚Äãto make sense to play it. </p><br><p>  Have we come to an agreement?  I do not think.  This is an amazing amount of dollars, the short-term benefits of which are not obvious, so the explanation of how long-term play makes some sense.  We are still at the dawn of mobile technology.  No one knows what the future will look like, so it‚Äôs better not to try to make the future look like the past.  Facebook seems to be doing just that. </p><br><p>  But enough of that.  How would you serve 450 million active users with just 32 engineers?  Let's get a look... </p><br><h2>  Sources </h2><br><p>  Warning: we know not so much about whatsapp architecture as a whole.  Just fragments and scraps collected from various sources.  Rick Reed's talk is about optimization, which allowed to process 2 million connections on a single server using Erlang, rather than a review of the entire architecture. </p><br><ul><li>  2012 <a href="https://vimeo.com/44312354">Scaling to Millions of Simultaneous Connections</a> ( <a href="http://www.erlang-factory.com/upload/presentations/558/efsf2012-whatsapp-scaling.pdf">slides</a> ) from Rick Reed </li><li>  <a href="http://mirkobonadei.com/interview-with-rick-reed/">Erlang Factory Interview</a> with Rick Reed </li><li>  <a href="https://pdincau.wordpress.com/2013/03/27/an-interview-with-eugene-fooksman-erlang/">Interview with Eugene Fooksman from WhatsApp</a> about Erlang </li><li>  <a href="https://www.youtube.com/watch%3Fv%3DWgAtBTpm6Xk%26feature%3Dyoutu.be">DLD14 - What's Up WhatsApp?</a>  <a href="https://www.youtube.com/watch%3Fv%3DWgAtBTpm6Xk%26feature%3Dyoutu.be">(Jan Koum, David Rowan)</a> </li><li>  <a href="https://github.com/tgalal/yowsup/wiki/Yowsup-Library-Documentation">yowsup</a> was an open source <a href="https://github.com/tgalal/yowsup/wiki/Yowsup-Library-Documentation">resource</a> for the WhatsApp API.  The repository is now unavailable due to a complaint <a href="http://openwhatsapp.org/blog/2014/02/13/mass-dmca-takedowns-whatsapp/">under the DMCA</a> , but they have documented some of the insides of WhatsApp.  Variety is everywhere. </li><li>  Some sources listed in <em>Related Works</em> </li></ul><br><h2>  Statistics </h2><br><p>  These statistics are mainly for the current system, and not for the system about which we have a report.  A report on the current system will include more hack information for data storage, messaging, meta-clustering, and more patches for BEAM / OTP. </p><br><ul><li>  450 million active users have reached this figure faster than any other company in the world. </li><li>  32 engineers, one developer accounts for 14 million active users. </li><li>  50 billion messages every day on seven platforms (incoming and outgoing). </li><li>  More than a million new users are registered every day. </li><li>  $ 0 spent on advertising. </li><li>  $ 60 million investment from <a href="http://techcrunch.com/2011/04/08/sequoia-whatsapp-funding/">Sequoia Capital</a> ;  $ 3.4 billion Sequoia will earn. </li><li>  Facebook spent 35% of the cash on the deal. </li><li>  Hundreds of knots. </li><li>  More than 8000 processor cores. </li><li>  Hundreds of terabytes of RAM. </li><li>  Over 70 million messages of Erlang per second. </li><li>  In 2011, WhatsApp reached a <a href="http://blog.whatsapp.com/index.php/2011/09/one-million/">million active TCP connections</a> on a single server with free memory and CPU resources.  In 2012 reached <a href="http://blog.whatsapp.com/index.php/2012/01/1-million-is-so-2011/">2 million compounds</a> .  In 2013, they tweeted: "On December 31, we set a new record: 7 billion incoming messages, 11 billion outgoing messages = 18 billion messages processed in one day! With the New, 2013!" </li></ul><br><h2>  Platform </h2><br><h3>  Backend </h3><br><ul><li>  Erlang </li><li>  Freebsd </li><li>  Yaws, lighttpd </li><li>  Php </li><li>  Its patches for <a href="http://www.erlang-factory.com/upload/presentations/708/HitchhikersTouroftheBEAM.pdf">BEAM</a> (BEAM this as JVM for Java, but for Erlang) </li><li>  Own XMPP </li><li>  Hosting, possibly from <a href="">Softlayer</a> <br><h3>  Frontend </h3></li><li>  Seven client platforms: iPhone, Android, Blackberry, Nokia Symbian S60, Nokia S40, Windows Phone,? </li><li>  Sqlite <br><h3>  Hardware </h3></li><li>  Standard server working with users: <br><ul><li>  Two 6-core processors architecture Westmere (24 logical processors); </li><li>  100GB RAM, SSD; </li><li>  Two network interfaces (public interface for communication with users, internal for backend) </li></ul></li></ul><br><h2>  Product </h2><br><ul><li>  <strong>Focus on messaging</strong> .  Connecting people around the world, no matter where they are, without having to pay a lot of money.  Founder Yang Kum remembers how difficult it was in 1992 to contact family around the world. </li><li>  <strong>Privacy</strong>  Formed by the memories of Jan Kuma from growing up in Ukraine, where there was nothing private.  Messages are not stored on servers;  chat history is not stored;  the goal is to know as little about the user as possible;  Your name and gender are unknown, chat history is stored only on your phone. </li></ul><br><h2>  General </h2><br><ul><li>  WhatsApp server is almost completely written in Erlang. <br><ul><li>  Server systems that route messages are written in Erlang. </li><li>  The big achievement is that so many users are served by a small number of servers.  The team agrees that, in many respects, it is thanks to Erlang. </li><li>  It is worth noting that Facebook Chat was written in 2009 on Erlang, but was later abandoned from this language, since it was difficult to find qualified programmers. </li></ul></li><li>  WhatsApp server grew from ejabberd <br><ul><li>  Ejabberd is the famous open source Jabber server written in Erlang. </li><li>  Initially, it was chosen because it is open, it has excellent developer reviews, it‚Äôs easy to get started with and there is a guarantee that Erlang is suitable for large communication systems in the long run. </li><li>  The next few years were spent rewriting and modifying a small number of ejabberd parts, including switching from XMPP to their protocol, restructuring the codebase, redesigning several key components, and making many important changes to the Erlang virtual machine to optimize performance. </li></ul></li><li>  To process 50 billion messages per day, you need to focus on building a reliable system that works.  You should think about monetization later, it is much ahead along the way. </li><li>  The main indicator of the health of the system is the length of the message queue.  The length of the message queue of all processes on one node is constantly monitored and an alert is sent when it becomes longer than the allowed value.  If one or more processes lags behind the others, and a warning has been sent for it, then this is a sign of another bottleneck. </li><li>  When sending a multimedia message, an image, audio or video is sent to the HTTPS server, and then the link to the content is sent to the addressee, along with the thumbnail encoded in Base64. </li><li>  A certain amount of code is laid out every day.  Usually, this occurs several times a day, but the calculation does not occur during normal peak loads.  Erlang allows you to aggressively approach the display of fixes or new opportunities for production.  Hot swap code means that updates are laid out without restarting or redirecting traffic.  Errors can usually be fixed very quickly, also with the help of hot swapping.  Such systems tend to be loosely coupled, which facilitates the incremental calculation of changes. </li><li>  What protocol is used in the WhatsApp application?  SSL socket is shared between server pool.  All messages are queued on the server until the client connects to receive them.  Notification of the successful receipt of the message is sent to the WhatsApp North, which forwards it to the original sender (who will see it as a checkmark next to the message).  Messages are deleted from server memory as soon as the client has accepted it. </li><li>  How is the registration process implemented inside WhatsApp?  WhatsApp used the phone's IMEI to create a username and password.  Recently changed it.  Now WhatsApp uses the usual request from the application to send a unique 5-character PIN.  WhatsApp then sends an SMS with this code to the specified phone number (this means that the WhatsApp client should no longer be running on the same phone).  Based on the PIN code, the application requests a unique key from WhatsApp.  This key is used as a password for subsequent calls (this "permanent" key is stored on the device).  It also means that registering a new device invalidates the key on the old device. </li><li>  On Android, Google's push notification service is used. </li><li>  Android users more.  Working with Andoid is more fun.  Developers can make a prototype and instantly send out to hundreds of millions of users, if there is any problem, it can be quickly fixed.  With iOS, things are not so simple. </li></ul><br><h2>  The challenge of 2+ million connections per server </h2><br><ul><li>  They are faced with a large influx of users, which is a positive problem, but also means the need to spend money on the purchase of additional hardware and the increased complexity of managing all these machines. </li><li>  You need to plan for traffic surges.  Examples are football matches and earthquakes in Spain and Mexico.  This happens at practically peak loads, so there should be enough free capacity to cope with peaks and spikes.  A recent football game led to a 35% jump in the number of outgoing messages, exactly during the daily peak. </li></ul><br><h2>  Tools and technologies used to increase scalability </h2><br><ul><li>  Developed a system state tracking tool (wsar): <br><ul><li>  Records characteristics of the entire system, including the characteristics of the OS, hardware, BEAM.  It was designed such that it is easy to connect metrics from other systems, such as virtual memory measurements.  The system tracks CPU consumption, total load, user time, system time, interrupt processing time (interrupt time), context switches, exceptions, received / sent packets, total number of messages in process queues, events with busy ports, traffic, transmitted / received bytes , scheduler statistics, garbage collector statistics and so on. </li><li>  Initially, the collection of information was run once a minute.  With the growth of the system load, it was necessary to shorten the polling period to one second, since the events that occurred within one minute were invisible.  This is a really well-detailed statistics, allowing you to see how everything works. </li></ul></li><li>  CPU hardware counters (pmcstat): <br><ul><li>  Watch the CPU load in time.  This allows you to find out how much time is spent on executing a virtual machine.  In their case, this is 16%, which means that only 16% of the time is spent on executing the code for the virtual machine, so even if they could remove all the time during which the Erlang code is executed, it would save only 16% of the total system operation time.  This implies that you need to focus on other areas in order to increase the efficiency of the system. </li></ul></li><li>  dtrace, kernel lock-counting, fprof <br><ul><li>  Dtrace was used primarily for debugging, not for performance monitoring. </li><li>  They patched BEAM under FreeBSD to get the CPU time stamp. </li><li>  We wrote scripts to get an aggregated overview of all processes, to understand what time is spent on. </li><li>  The greatest achievement was the compilation of the emulator with the lock count enabled. </li></ul></li><li>  Some problems <br><ul><li>  It was previously noted that a lot of time is spent on garbage collection procedures; this has been fixed. </li><li>  Noticed some problems with the network stack, but decided to configure them. </li><li>  Most of the problems were caused by the race for blocking, which is seriously reflected in the output from the lock counter. </li></ul></li><li>  Measurements: <br><ul><li>  Synthetic workloads, that is, traffic generation by your scripts, make little sense to configure huge systems working with users. </li><li>  It worked well for simple interfaces, such as a table of users, generating inserts and reads as quickly as possible. </li><li>  If the server can handle a million connections, it will take 30 hosts to open the required number of IP ports to generate enough connections for the server.  For a server holding two million connections, 60 hosts are required.  It is difficult to create such a scale. </li><li>  It is difficult to generate traffic, as in real use.  You can assume a normal load, but in reality network events, world events will appear, and due to multi-platform, there will be differences in customer behavior and differences across countries. </li><li>  Combined load: <br><ul><li>  Take the normal traffic from the production and direct it to a separate system. </li><li>  This is very convenient for systems where side effects can be limited.  You do not want to redirect traffic and do something that may affect the constant state of users or result in multiple copies of the message sent to users. </li><li>  Erlang supports hot swapping of the code, so that you can come up with something under full load, compile, load the change while the program is running, and instantly see if it has become better or worse. </li><li>  They added switches to dynamically change the load from the production and see how this affects performance.  They will read the output from sar, looking at the CPU load, memory consumption, track the queue overflows, and then toggle switches to see how the system responds. </li></ul></li><li>  Real loads <br><ul><li>  Absolute test.  Perform both input and output tasks. </li><li>  Bring the server to DNS a couple of times, so that it will receive twice or three times more traffic than usual.  This creates problems with TTL, as clients ignore TTL from DNS, which creates a delay, and you cannot quickly respond to getting more traffic that needs to be processed. </li><li>  IPFW.  Redirect traffic from one server to another to get the required number of client connections.  There is a bug that causes the kernel panic, so it does not work very well. </li></ul></li></ul></li><li>  Results: <br><ul><li>  We started with 200 thousand simultaneous connections to the server. </li><li>  The first bottleneck was found at 425 thousand.  The system has entered a state of multiple locks.  Work has stopped.  Turned to the scheduler to measure how much useful work is being performed, how many processes are waiting, how many are in locks.  Under load, the pending ones increased, so that 35-45% of the CPU was used, 95% of which were consumed by the schedulers. </li><li>  The first stage of corrections allowed reaching a million connections. <br><ul><li>  Memory consumption was 76%, the processor was loaded at 73%.  BEAM consumed 45% of resources, which is close to the value of resource consumption from user space, which is good, since BEAM works on behalf of the user. </li><li>  Usually, CPU consumption is not the most successful metric, since the scheduler also consumes CPU. </li></ul></li><li>  A month later, after correcting the bottlenecks, reached two million compounds. <br><ul><li>  BEAM consumes 80% of memory, close to the rate when FreeBSD starts to unload pages from memory.  The CPU consumption is about the same, but with a double increase in the number of connections.  The scheduler encounters locks, but it works pretty well. </li></ul></li><li>  It looked like a good moment to stop, so they started to profile the code on Erlang. <br><ul><li>  Initially there were two processes per connection.  Cut to one. </li><li>  Small changes to work with timers. </li></ul></li><li>    2.8     <br><ul><li> 571    ,  200    . </li><li>      .      70%. </li></ul></li><li>  3  ,   . <br><ul><li>    ,   .   ,   . </li><li>    BEAM          . ,      ,  . </li><li>    10 ,  ,       600  ,   15      40  ,       41 . </li></ul></li></ul></li><li>  Findings: <br><ul><li> Erlang + BEAM +   ‚Äî    <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25BC%25D0%25BC%25D0%25B5%25D1%2582%25D1%2580%25D0%25B8%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BC%25D1%2583%25D0%25BB%25D1%258C%25D1%2582%25D0%25B8%25D0%25BF%25D1%2580%25D0%25BE%25D1%2586%25D0%25B5%25D1%2581%25D1%2581%25D0%25BE%25D1%2580%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">SMP</a> .   . .   ,  85% CPU        .       . <br><ul><li>    Erlang. </li><li>    ,      ,         ,        ,       ,  . </li></ul></li><li>  ‚Äî   <br><ul><li>     ,      BEAM. </li><li>  BEAM. </li><li>    ,        . </li><li>  ,     ,  ,    ,        . </li><li>   .      (BIF, build-in-function). </li><li>      ,     ,  ,      -. </li><li>  mseg ‚Äî      .      . </li><li>        .  ,        . </li><li>     ,     .        ,    . </li></ul></li><li>    . <br><ul><li>  TSE   FreeBSD 9  8.    .    ,     ,     . </li><li>     . </li><li> Pmcstat ,      c PCB   .   -,    . </li></ul></li><li>  BEAM <br><ul><li>    .  ,      ,   ,  "" ,   ,  ,   .      Erlang, c  procinfo,       . </li><li>    ,       . </li><li>      : 1, 10  100 .      . </li><li>        . </li><li>      . </li></ul></li><li>  Customization <br><ul><li>     ,        ""   . </li><li>  mseg,   malloc. </li><li>    FreeBSD,       .   FreeBSD  -.   TLB     CPU. </li><li>      . </li><li>  BEAM  real-time ,    ,   cron   .      . </li><li>  ,     . </li></ul></li><li> Mnesia <br><ul><li>   os:timestamp,   erlang:now. </li><li>   ,    .     ,    . </li></ul></li><li>       . </li></ul></li></ul><br><h2>  Lessons </h2><br><ul><li> <strong>    ,      .</strong>    ,   ,       ,      .      ,     ,  ,  ,         ,  ,  ,      ,    .   ,     ,        . </li><li> <strong> ,   .  .  .  .</strong>     ,   ,   ,         ,      .  ,  . </li><li> <strong>.   . . .</strong> ,   . </li><li> <strong>Erlang rocks!</strong> Erlang      , ,  . ,            . </li><li> <strong>    .</strong>    ,       ,      . </li><li> <strong>         .</strong>    ,    .       WhatsApp .   WhatsApp     ,    -   ,    .              .                 . </li><li> <strong>      - .</strong> WhatsApp   ,       ,    ,         .    .        ,    ,        ,       . </li><li> <strong>    ‚Äî  .</strong>       ,      ,    .   -.       . </li><li> <strong>   .</strong>   ,  WhatsApp,    Twitter  Facebook  2009 -  ,   , , . </li><li> <strong>  ,  .</strong>    ,     ejabberd.       ,        Erlang. ,    Erlang           . </li><li> <strong>   .</strong>    ,      ,     ,    .          ,     . </li><li> <strong>   .</strong>  ,         ,      ,       ,   . </li><li> <strong> ,    .</strong>    ,  WhatsApp  , 10000    .      ,    1000  .   ,    ,       ,     . </li><li> <strong>     .</strong>        Skype,     ,   . </li></ul><br><h2>   </h2><br><ul><li> <a href="https://news.ycombinator.com/item%3Fid%3D7306066">On Hacker News</a> </li><li> <a href="https://www.youtube.com/watch%3Fv%3DVnhbvS0MBXE">Keynote: Benedict Evans ‚Äî InContext 2014</a> , <a href="http://ben-evans.com/presentations/2013/11/5/mobile-is-eating-the-world-autumn-2013-edition"></a> </li><li> <a href="http://ben-evans.com/benedictevans/2014/2/19/whatsapp-and-19bn">Whatsapp and $19bn</a>    </li><li> <a href="http://www.slideshare.net/socialmarketingfella/the-diary-of-a-16-billion-startup-31457350">WhatsApp's blog: The telling diary of a 16 billion dollar startup</a> ‚Äî      </li><li>    <a href="https://github.com/reedr">Erlang  Github</a> </li><li> <a href="http://blog.whatsapp.com/"> WhatsApp</a> : <br><ul><li> <a href="http://blog.whatsapp.com/index.php/2011/09/one-million/">ONE MILLION!</a> ( <a href="https://news.ycombinator.com/item%3Fid%3D3028547">Hacker News</a> ) </li><li> <a href="http://blog.whatsapp.com/index.php/2012/01/1-million-is-so-2011/">1 million is so 2011</a> </li><li> <a href="http://blog.whatsapp.com/index.php/2013/12/400-million-stories/">400 Million Stories</a> </li></ul></li><li> <a href="http://www.wired.co.uk/news/archive/2014-02/19/whatsapp-exclusive">WhatsApp: The inside story</a> </li><li> <a href="http://www.whatsapp.com/opensource/">The Open Source projects used at WhatsApp</a> </li><li> <a href="http://blog.process-one.net/whatsapp-facebook-erlang-and-realtime-messaging-it-all-started-with-ejabberd/">Whatsapp, Facebook, Erlang and realtime messaging: It all started with ejabberd</a> </li><li> Quora: <a href="http://www.quora.com/How-does-WhatsApp-work-1">How does WhatsApp Work?</a> , <a href="http://www.quora.com/How-does-WhatsApp-work-out-of-mobile-network">How does WhatsApp work out of mobile network?</a> , <a href="http://www.quora.com/WhatsApp-Messenger/How-did-WhatsApp-grow-so-big">How did WhatsApp grow so big?</a> </li><li> <a href="http://fileperms.org/whatsapp-is-broken-really-broken/">WhatsApp is broken, really broken</a> ‚Äî      </li><li> <a href="http://allthingsd.com/20130510/whatsapp-ceo-jan-koum-hates-advertising-and-the-tech-rumor-mill-full-dive-video/">WhatsApp CEO Jan Koum Hates Advertising and the Tech Rumor Mill (Full Dive Video)</a> </li><li> <a href="http://www.happymarketer.com/singapore-is-progressively-doing-business-over-whatsapp-are-you">Singapore is progressively doing business over WhatsApp. Are You?</a> </li><li> <a href="http://sequoiacapital.tumblr.com/post/77211282835/four-numbers-that-explain-why-facebook-acquired">Four Numbers That Explain Why Facebook Acquired WhatsApp</a> </li><li> <a href="https://www.facebook.com/zuck/posts/10101272463589561%3Fstream_ref%3D10">Announcement from Mark Zuckerberg</a> </li><li> <a href="http://www.metabrew.com/article/a-million-user-comet-application-with-mochiweb-part-3">A Million-user Comet Application with Mochiweb, Part 3</a> </li><li> <a href="http://www.fastcolabs.com/3026758/inside-erlang-the-rare-programming-language-behind-whatsapps-success">Inside Erlang, The Rare Programming Language Behind WhatsApp's Success</a> </li><li> <a href="http://techcrunch.com/2014/02/24/whatsapp-is-actually-worth-more-than-19b-says-facebooks-zuckerberg/">WhatsApp Is Actually Worth More Than $19B, Says Facebook's Zuckerberg, And It Was Internet.org That Sealed The Deal</a> </li><li> <a href="http://aswathdamodaran.blogspot.in/2014/02/facebook-buys-whatsapp-for-19-billion.html">Facebook buys Whatsapp for $19 billion: Value and Pricing Perspectives</a> </li><li> <a href="http://www.forbes.com/sites/georgeanders/2014/02/19/facebook-justifies-19-billion-by-awe-at-whatsapp-growth/">Facebook's $19 Billion Craving, Explained By Mark Zuckerberg</a> </li><li> <a href="http://blog.mindcrime-ilab.de/2012/12/16/imho-lessons-learned-from-whatsapp/">IMHO: Lessons learned from WhatsApp</a> </li><li> <a href="http://www.wired.com/wiredenterprise/2014/02/whatsapp-rules-rest-world/">You May Not Use WhatsApp, But the Rest of the World Sure Does</a> </li><li> <a href="http://techcrunch.com/2014/02/23/the-whatsapp-story-challenges-the-valleys-conventional-wisdom/">The WhatsApp Story Challenges Some Of The Valley's Conventional Wisdom</a> </li><li> <a href="http://recode.net/2014/02/20/what-whatsapp-did-right-according-to-jan-koum-video/">What WhatsApp Did Right, According to Jan Koum (Video)</a> </li><li> <a href="http://kottke.org/14/02/why-did-facebook-buy-whatsapp">Why did Facebook buy WhatsApp?</a> </li><li> <a href="http://www.linkedin.com/today/post/article/20140220134541-79695780-can-someone-explain-whatsapp-s-valuation-to-me">Can Someone Explain WhatsApp's Valuation To Me?</a> </li><li> <a href="https://www.theinformation.com/Google-s-Unusual-Offer-to-WhatsApp">Google's Unusual Offer to WhatsApp</a> </li></ul><br><p> <em>             .</em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/276951/">https://habr.com/ru/post/276951/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276939/index.html">DUMP-2016 Developer Conference: Ekaterinburg, April 8</a></li>
<li><a href="../276941/index.html">Deploying Linux distribution with SCCM 2012</a></li>
<li><a href="../276943/index.html">GPU vs CPU: Why are GPUs used to analyze financial data</a></li>
<li><a href="../276945/index.html">How we ported the good old Russian quest</a></li>
<li><a href="../276949/index.html">Decryption of updates of one popular cellular modem: Dmitry Sklyarov method</a></li>
<li><a href="../276953/index.html">We are looking for Mega developers: turn on the idea generator</a></li>
<li><a href="../276955/index.html">Rumors confirmed - Opera Software is sold to China</a></li>
<li><a href="../276957/index.html">Carefully about counting single bits</a></li>
<li><a href="../276961/index.html">Nginx 1.9.11 released with support for dynamic modules</a></li>
<li><a href="../276967/index.html">Hardware password manager or how to stop entering passwords and start living</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>