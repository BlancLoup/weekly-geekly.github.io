<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Found a formula for a painless transition to .Net Core</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For everything about everything enough 50 cups of coffee. 


 In addition to the rule of thumb outlined above, we publish a brief note about points th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Found a formula for a painless transition to .Net Core</h1><div class="post__text post__text-html js-mediator-article"><p>  For everything about everything enough 50 cups of coffee. </p><br><p>  In addition to the rule of thumb outlined above, we publish a brief note about points that need to be paid close attention so that nothing breaks in battle and in the process.  A note was made hot on the heels of the release of the mobile service that had completely migrated to .Net Core (the beginning was made <a href="https://habr.com/company/eastbanctech/blog/348590/">here</a> ).  We managed to perform this operation imperceptibly for the customer, almost without stopping the main development process. </p><br><p>  Below will be a ready action plan, there will be a very capacious test list, there will be this picture for the mood: </p><br><p><img src="https://habrastorage.org/webt/pt/yp/6s/ptyp6szarkzymkgf34tz0ide3r8.jpeg"></p><a name="habracut"></a><br><h3 id="itak-po-shagam">  So, in steps: </h3><br><h4 id="1-zaplanirovat-dlinnyy-sprint-s-bolshimi-fichami-iili-regressom">  1. Plan a long sprint with big features and / or regression </h4><br><p>  With fundamental rewriting of the code, the service will need time to infuse as long as possible in order to have time to fix all the flaws on the test environment. </p><br><h4 id="2-v-akkurat-k-sprintu-perepisat-kod-na-net-core">  2. In order to sprint to rewrite the code on .Net Core </h4><br><p>  Why is it important not to start this business ahead of time?  Because you have to pull two branches of the code with the new and old .net, because at any moment the bird can fly urgent or need to hold a demo of new features, and then you need to make changes to the old stable branch.  To experience minimal concern about this, it is better to shorten the transition state. </p><br><p>  By the way, when working with code, we quickly came to the conclusion that it is more convenient to keep two copies of the repository locally.  It is easier and more convenient than switching two massive branches. </p><br><ul><li>  If possible, in the services used to rewrite WCF interfaces on webapi </li></ul><br><p>  The implementation of the .Net Core WCF client is still far from ideal.  Despite the fact that the old <a href="https://habr.com/company/eastbanctech/blog/350054/">sores are</a> in some sense fixed, newer versions still have to use workaround ( <a href="https://github.com/dotnet/wcf/issues/2641">1</a> , <a href="https://github.com/dotnet/wcf/issues/2923">2</a> ). </p><br><blockquote>  For history: on .Net Core 2.0, the stable working version of WCF is 4.4.2 from myget repository.  She, for example, has no problems with early timeout </blockquote><p>  At the time of the start of the migration, we used the .Net Core 2.0 version.  Meanwhile, Microsoft relies .Net Core 2.1.  Who cares to admire the success of the Redmond guys in optimizing the platform, please read what progress the <a href="https://blogs.msdn.microsoft.com/dotnet/2018/08/20/bing-com-runs-on-net-core-2-1/%3Futm_source%3Dvs_developer_news%26utm_medium%3Dreferral">Bing</a> search engine made when upgrading to the new version (spoiler: latency fell 34%!) </p><br><p>  We also upgraded to .Net Core 2.1 and WCF 4.5.3.  And they didn‚Äôt forget to specify a fresh microsoft / dotnet base image in Dockerfile: 2.1-aspnetcore-runtime.  What a surprise it was when instead of 1.4GB we saw an image size of 0.5GB (we are talking about a Windows image, all of a sudden). </p><br><h4 id="3-zadeploit-na-test-i-demo">  3. Apply for test and demo </h4><br><p>  We have two environments at our disposal.  We left the demo with the old version as a reference.  On the test environment, a new service has been laid out - run in on developers and testers. </p><br><p>  There was some confusion due to the fact that usually developers work with dough, and testers mostly with demo.  In case it was necessary to refresh the old service, the situation was exactly the opposite of normal.  Therefore, the discussion and the crib are useful, where and what to look for. </p><br><ul><li>  Configure IIS </li></ul><br><p>  To run the .Net Core service in IIS, you need to install a <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/iis/%3Ftabs%3Daspnetcore2x%26view%3Daspnetcore-2.1">module</a> that comes with runtime. </p><br><p>  AppPool switch to CLR Runtime = No Managed Code. </p><br><p>  In a solution in a standard <a href="https://docs.microsoft.com/ru-ru/aspnet/core/host-and-deploy/iis/%3Fview%3Daspnetcore-2.1%26tabs%3Daspnetcore2x">web.config,</a> it is important not to forget to set the desired requestTimeout and disable the WebDAV module if there are DELETE methods. </p><br><p>  Further, there are two options for publishing a service in IIS: </p><br><ul><li>  you do MSDeploy sync - it means additionally you need <a href="https://docs.microsoft.com/en-us/iis/publish/deploying-application-packages/taking-an-application-offline-before-publishing">the</a> -enableRule <a href="https://docs.microsoft.com/en-us/iis/publish/deploying-application-packages/taking-an-application-offline-before-publishing">key</a> : AppOffline </li><li>  you are doing file publish - it means that just before publishing, you need to put the app_offline.htm file in the service directory, and after publication, delete it </li></ul><br><p>  Both that, and another allows to stop working process and to unlock the executed files.  Otherwise, an error will appear that the files are not available for rewriting. </p><br><blockquote>  We refused to log in via Nlog in favor of Serilog, and lost automatic log compression - there is simply no such feature in Serilog.  In this case, you can be saved by regular Windows tools and set NTFS compression in the properties of the directory. </blockquote><br><h4 id="4-protestirovat">  4. Test </h4><br><p>  Here is the most compressed checklist for the most fragile places: </p><br><ul><li>  check status return Bad request, Unauthorized, Not modified, Not found - everything that the API can give </li><li>  check query logging for all status codes </li><li>  chart external dependencies;  As a rule, all the necessary information is in appsettings <br><ul><li>  drive away methods that affect their work </li><li>  check external requests logging </li></ul></li><li>  check the functioning of the settings for the appsettings parameters;  try to change them for hot </li><li>  check http caching for positive and negative status codes <br><ul><li>  Header ETag </li><li>  Header ache-ontrol </li></ul></li><li>  check long requests and timeouts </li><li>  check requests with an empty answer </li><li>  check DELETE methods (WebDAV is disabled or not) </li><li>  check raw content <br><ul><li>  upload and download single / multiple files </li><li>  fill files with a size above the limit </li><li>  Content-Disposition header </li></ul></li><li>  check all other heders;  it‚Äôs pretty easy to put them all together by code </li><li> check conditional code execution when switching environments <code>if (env.IsDevelopment())</code> </li><li>  check disconnection from client and server </li><li>  compare with the standard swagger.json - helps to detect the difference in the transmitted fields <br><blockquote>  In our mobile application, a code generator is used to work with API based on the description of swagger.json, so it was important that the difference from the original description was minimal.  The latest version of Swashbuckle.AspNetCore greatly changed the interface and the generated swagger.json.  I had to roll back to the old version of Swashbuckle.AspNetCore 1.2.0 and add a couple of filters. <br></blockquote></li></ul><br><h4 id="5-zadeploit-na-boy-popivaya-kofeek">  5. Seize the fight while drinking coffee. </h4><br><p>  In our case, the combat environment consists of two nodes: active and passive. <br>  In order to switch to a new service unnoticed, we duplicated the pool and site on each node, and wrote a script to switch the binding between the old and the new site. </p><br><p>  Thus, in the case of an emergency, we were able to quickly switch to the old version. </p><br><p>  Further, after deploying to the battle, during the week we were convinced of the viability of the service and lit the green light for the release of the mobile application.  Life on the project safely returned to its former course. </p><br><h3 id="promezhutochnyy-itog">  Subtotal </h3><br><p>  Now our service is completely ready to acquire a docker-container for delivery to the cluster.  We are ready to deploy to Kubernetes and to the Service Fabric. </p><br><p>  Now the preparation for the presentation of the new infrastructure to the customer is in full swing.  We will tell about your achievements in the next series, keep abreast;) </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/422441/">https://habr.com/ru/post/422441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../422431/index.html">Japanese fairies show the work of a master-slave trigger in a new manga for digital electronics</a></li>
<li><a href="../422433/index.html">Solar panels and asphalt roads. Symbiosis of technology</a></li>
<li><a href="../422435/index.html">Timer - start</a></li>
<li><a href="../422437/index.html">User Perception Games and Website and Application Speed</a></li>
<li><a href="../422439/index.html">Struggle with Yandex: how I spent more than a year to bring the site to the top</a></li>
<li><a href="../422443/index.html">Corona SDK exact timer</a></li>
<li><a href="../422445/index.html">BottomAppBar implementation. Part 3: Behaviors for Android</a></li>
<li><a href="../422447/index.html">bytes.Buffer in Go: optimizations that don't work</a></li>
<li><a href="../422449/index.html">Senators vs. Amazon: what an online store is wrong for</a></li>
<li><a href="../422451/index.html">Listen to the marketing of games and the place of script writer in the gaming industry 26.09 at VSBI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>