<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Kolab Groupware (Part 2 - Installation)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you still do not know what Kolab is, then you probably want to read the first article , where I did a detailed review of this rather functional and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Kolab Groupware (Part 2 - Installation)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/ee8/922/938/ee892293882e4e2487c48354109305bb.png"><br><br>  If you still do not know what Kolab is, then you probably want to read the <a href="http://habrahabr.ru/post/260469/">first article</a> , where I did a detailed review of this rather functional and completely free mail server with a beautiful web-muzzle. <br>  This time we will install it. <br><a name="habracut"></a><br>  <a href="http://habrahabr.ru/post/260469/">Kolab Groupware (Part 1 - Overview)</a> <br>  <a href="http://habrahabr.ru/post/260527/">Kolab Groupware (Part 2 - Installation)</a> <br><br>  If you do not want to bother with all that is described in this article or just want to try Kolab, you can use a ready <a href="https://habr.com/ru/post/260527/">docker image</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Package installation </h2><br>  Packages exist for all popular distributions: <a href="https://docs.kolab.org/">Red Hat Enterprise Linux</a> , <a href="https://docs.kolab.org/installation-guide/centos-community.html">CentOS</a> , <a href="https://docs.kolab.org/installation-guide/fedora.html">Fedora</a> , <a href="https://docs.kolab.org/installation-guide/debian.html">Debian</a> , there are also experimental packages for <a href="https://kolab.org/news/2015/04/17/kolab-3-rc1-released-planned-packaged-opensuse">OpenSUSE</a> and <a href="https://docs.kolab.org/installation-guide/ubuntu.html">Ubuntu</a> , and in <a href="https://wiki.archlinux.org/index.php/Kolab">ArchLinux</a> Kolab you can build from <a href="https://aur.archlinux.org/packages/kolab/">AUR</a> . <br>  I will install it on Centos 7, but it is not necessary to be guided by me at all, the installation will differ little from other distributions. <br><br>  So let's start <br><br>  Install repositories <br><pre><code class="bash hljs">yum -y update yum -y install wget epel-release <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/yum.repos.d wget http://obs.kolabsys.com/repositories/Kolab:/3.4/CentOS_7/Kolab:3.4.repo wget http://obs.kolabsys.com/repositories/Kolab:/3.4:/Updates/CentOS_7/Kolab:3.4:Updates.repo</code> </pre> <br>  Install the keys <br><pre> <code class="bash hljs">gpg --keyserver pgp.mit.edu --recv-key 0x446D5A45 gpg --<span class="hljs-built_in"><span class="hljs-built_in">export</span></span> --armor devel@lists.kolab.org &gt; devel.asc rpm --import devel.asc rm devel.asc</code> </pre><br>  Now the packages themselves <br><pre> <code class="bash hljs">yum -y install kolab</code> </pre><br><br><h2>  Kolab installation </h2><br>  First of all, the host name must be set to the full FQDN, for example: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"mail.example.org"</span></span> &gt; /etc/hostname</code> </pre><br>  In addition, the installation of dirsrv requires that the name of your machine be resolved to its IP address, so do not forget to add the corresponding entry to the DNS and / or to the / etc / hosts file. <br><br>  Now it's time to find out that if you want to install Kolab and use <font color="brown"><i>some Active Directory</i></font> instead of the standard 389 Directory Server (hereinafter referred to as dirsrv), then you need to edit the /etc/kolab/kolab.conf file and fix the parameters responsible for LDAP. <br>  In this case, the installation will need to run with the parameter - with-ad <br><br>  Also in the centos-systems, before installation, you should create a user dirsrv, when installing packages, it is not created for some reason, in debian this is all right. <br><pre> <code class="bash hljs">adduser dirsrv</code> </pre><br>  Ok, now everything is ready, we start the installation: <br><pre> <code class="bash hljs">setup-kolab</code> </pre><br>  The entire installation boils down to answering questions that an interactive script asks you <br><div class="spoiler">  <b class="spoiler_title">Listing</b> <div class="spoiler_text"><pre> <code class="bash hljs">Please supply a password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the LDAP administrator user <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, used to login to the graphical console of 389 Directory server. Administrator password [sQnPqqaKInB2ObB]: Please supply a password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the LDAP Directory Manager user, <span class="hljs-built_in"><span class="hljs-built_in">which</span></span> is the administrator user you will be using to at least initially <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> to the Web Admin, and that Kolab uses to perform administrative tasks. Directory Manager password [ohLY9kxxinHGOGE]: Please choose the system user and group the service should use to run under. These should be existing, unprivileged, <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> system POSIX accounts with no shell. User [dirsrv]: Group [dirsrv]: This setup procedure plans to <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> up Kolab Groupware <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the following domain name space. This domain name is obtained from the reverse DNS entry on your network interface. Please confirm this is the appropriate domain name space. example.org [Y/n]: y The standard root dn we composed <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> you follows. Please confirm this is the root dn you wish to use. dc=example,dc=org [Y/n]: y Setup is now going to <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> up the 389 Directory Server. This may take a little <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (during <span class="hljs-built_in"><span class="hljs-built_in">which</span></span> period there is no output and no progress indication). Shutting down dirsrv: mail... [ OK ] Starting dirsrv: mail... [ OK ] Please supply a Cyrus Administrator password. This password is used by Kolab to execute administrative tasks <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Cyrus IMAP. You may also need the password yourself to troubleshoot Cyrus IMAP and/or perform other administrative tasks against Cyrus IMAP directly. Cyrus Administrator password [0DIMW-CLUKmsNEU]: Please supply a Kolab Service account password. This account is used by various services such as Postfix, and Roundcube, as anonymous binds to the LDAP server will not be allowed. Kolab Service password [dDGgUZAue2Y-LTW]: Shutting down postfix: [FAILED] Starting postfix: [ OK ] Shutting down amavisd: The amavisd daemon is apparently not running, no PID file /var/run/amavisd/amavisd.pid [FAILED] Starting amavisd: [ OK ] Stopping clamd.amavisd: [FAILED] Starting clamd.amavisd: LibClamAV Warning: ************************************************** LibClamAV Warning: *** The virus database is older than 7 days! *** LibClamAV Warning: *** Please update it as soon as possible. *** LibClamAV Warning: ************************************************** [ OK ] Stopping wallaced: [FAILED] Starting wallaced: [ OK ] Stopping mysqld: [ OK ] Initializing MySQL database: Installing MySQL system tables... OK Filling <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> tables... OK To start mysqld at boot time you have to copy support-files/mysql.server to the right place <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> your system PLEASE REMEMBER TO SET A PASSWORD FOR THE MySQL root USER ! To <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> so, start the server, <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> issue the following commands: /usr/bin/mysqladmin -u root password <span class="hljs-string"><span class="hljs-string">'new-password'</span></span> /usr/bin/mysqladmin -u root -h mail.example.org password <span class="hljs-string"><span class="hljs-string">'new-password'</span></span> Alternatively you can run: /usr/bin/mysql_secure_installation <span class="hljs-built_in"><span class="hljs-built_in">which</span></span> will also give you the option of removing the <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> databases and anonymous user created by default. This is strongly recommended <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> production servers. See the manual <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> more instructions. You can start the MySQL daemon with: <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr ; /usr/bin/mysqld_safe &amp; You can <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> the MySQL daemon with mysql-test-run.pl <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/mysql-test ; perl mysql-test-run.pl Please report any problems with the /usr/bin/mysqlbug script! [ OK ] Starting mysqld: [ OK ] What MySQL server are we setting up? - 1: Existing MySQL server (with root password already <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>). - 2: New MySQL server (needs to be initialized). Choice: 2 Please supply a root password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> MySQL. This password will be the administrative user <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> this MySQL server, and it should be kept a secret. After this setup process has completed, Kolab is going to discard and forget about this password, but you will need it <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> administrative tasks <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> MySQL. MySQL root password [lhBkALCvQpocaiT]: Please supply a password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the MySQL user <span class="hljs-string"><span class="hljs-string">'kolab'</span></span>. This password will be used by Kolab services, such as the Web Administration Panel. MySQL kolab password [47rxdTc-vIk3WJ8]: Please supply the timezone PHP should be using. You have to use a Continent or Country / City locality name like <span class="hljs-string"><span class="hljs-string">'Europe/Berlin'</span></span>, but not just <span class="hljs-string"><span class="hljs-string">'CEST'</span></span>. Timezone ID [UTC]: Europe/Moscow Please supply a password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the MySQL user <span class="hljs-string"><span class="hljs-string">'roundcube'</span></span>. This password will be used by the Roundcube webmail interface. MySQL roundcube password [o_yUViK4oRy7SX2]: Stopping httpd: [FAILED] Starting httpd: [ OK ] Stopping httpd: [ OK ] Starting httpd: [ OK ] Stopping kolab-saslauthd: [FAILED] Starting kolab-saslauthd: [ OK ] Shutting down cyrus-imapd: [FAILED] Starting cyrus-imapd: [ OK ] Stopping kolabd: [FAILED] Starting kolabd: [ OK ]</code> </pre><br></div></div><br><br>  After installation, you already have a completely working installation of Kolab, for a test run, this is quite enough, but for production release you will have to work a little more with a file :) <br><br><h2>  Editing config </h2><br>  The config is here <b>/etc/kolab/kolab.conf</b> <br>  Here, there is something to twist, here are some useful options: <br><br><h4>  Locale </h4><br>  The default locale for Russian is en_RU <br><pre> <code class="bash hljs">default_locale = en_US</code> </pre><br><h4>  Generating uid and box names </h4><br>  Here is the rule that generates the primary mailbox. <br><pre> <code class="bash hljs">primary_mail = %(surname)s@%(domain)s</code> </pre><br>  And these are the rules by which additional mailboxes are generated, as you can see, they can be more flexible than for the main <br><pre> <code class="bash hljs">secondary_mail = { 0: { <span class="hljs-string"><span class="hljs-string">"{0}.{1}@{2}"</span></span>: <span class="hljs-string"><span class="hljs-string">"format('%(givenname)s'[0:1].capitalize(), '%(surname)s', '%(domain)s')"</span></span> }, 1: { <span class="hljs-string"><span class="hljs-string">"{0}@{1}"</span></span>: <span class="hljs-string"><span class="hljs-string">"format('%(uid)s', '%(domain)s')"</span></span> }, 2: { <span class="hljs-string"><span class="hljs-string">"{0}@{1}"</span></span>: <span class="hljs-string"><span class="hljs-string">"format('%(givenname)s.%(surname)s', '%(domain)s')"</span></span> } }</code> </pre><br>  By default in Kolab it is forbidden to change through the admin email primary email and uid, i.e.  they must always be generated by themselves based on these rules. <br>  I personally do not like this scheme, I prefer to specify the username and mail-addresses manually, well, or at least that it could be edited.  I'll tell you how to do it: <br><br>  Disable mailbox name checking <br><pre> <code class="bash hljs">daemon_rcpt_policy = False</code> </pre><br>  Go to the Kolab admin panel, go to <b>Settings,</b> and for the <b>Kolab User</b> type <b>uid</b> and <b>mail</b> attribute, change the value from ‚ÄúGenerated (read-only)‚Äù to ‚ÄúGenerated‚Äù. <br>  Now we can edit uids and mail addresses for our users manually. <br><br><h4>  Mail storage </h4><br>  We continue to parse the config, here it is indicated which folders should be created by default for the new user <br><pre> <code class="bash hljs">autocreate_folders = { <span class="hljs-string"><span class="hljs-string">'Archive'</span></span>: { <span class="hljs-string"><span class="hljs-string">'quota'</span></span>: 0, }, <span class="hljs-string"><span class="hljs-string">'Calendar'</span></span>: { <span class="hljs-string"><span class="hljs-string">'annotations'</span></span>: { <span class="hljs-string"><span class="hljs-string">'/private/vendor/kolab/folder-type'</span></span>: <span class="hljs-string"><span class="hljs-string">"event.default"</span></span>, <span class="hljs-string"><span class="hljs-string">'/shared/vendor/kolab/folder-type'</span></span>: <span class="hljs-string"><span class="hljs-string">"event"</span></span>, }, ...</code> </pre><br>  If you wish, you can move different folders to different storages, for example, so that all folders are on fast storage, and the archive folder is slow. <br>  To do this, in the cyrus config you should specify where to look for these storages. <br><pre> <code class="cs hljs">echo <span class="hljs-string"><span class="hljs-string">"partition-default: /var/spool/imap"</span></span> &gt;&gt; /etc/imapd.conf echo <span class="hljs-string"><span class="hljs-string">"partition-archive: /var/spool/imap-archive"</span></span> &gt;&gt; /etc/imapd.conf</code> </pre><br>  And add the partition parameter to the Archive folder, like this: <br><pre> <code class="bash hljs">... <span class="hljs-string"><span class="hljs-string">'Archive'</span></span>: { <span class="hljs-string"><span class="hljs-string">'quota'</span></span>: 0, <span class="hljs-string"><span class="hljs-string">'partition'</span></span>: <span class="hljs-string"><span class="hljs-string">'archive'</span></span> }, ...</code> </pre><br><br><h2>  Multidomain configuration </h2><br>  Kolab out of the box does not quite support multiple domains.  Or rather, there is everything in the admin panel, but all other services, such as postfix, cyrus-imap, amavis, roundcube, are all configured by default to support only one domain. <br>  If you still need to set up multiple domains, the official wiki has a <a href="https://docs.kolab.org/howtos/multi-domain.html">very detailed guide</a> on how to set up this whole zoo to work with multiple domains. <br>  It should be noted that after the described actions, your logins will be changed from a simple username to username@example.org <br>  If you do not need this function, simply skip this item. <br><br><h2>  SSL setup </h2><br>  We secure our server, <a href="http://habrahabr.ru/post/127643/">get a certificate</a> for your domain, if you have not already done so. <br>  You will also need a certificate from a certification authority (in the case of StartSSL, <a href="">sub.class1.server.ca.pem</a> ) <br><br>  Install mod_ssl for apache <br><pre> <code class="bash hljs">yum -y install mod_ssl</code> </pre><br><br>  Now we copy our keys in the following ways: <br>  /etc/pki/tls/private/mail.example.org.key <br>  /etc/pki/tls/certs/mail.example.org.crt <br>  /etc/pki/tls/certs/sub.class1.server.ca.pem <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># C     cat /etc/pki/tls/certs/mail.example.org.crt /etc/pki/tls/private/mail.example.org.key /etc/pki/tls/certs/sub.class1.server.ca.pem &gt; /etc/pki/tls/private/mail.example.org.bundle.pem cat /etc/pki/tls/certs/mail.example.org.crt /etc/pki/tls/certs/sub.class1.server.ca.pem &gt; /etc/pki/tls/certs/mail.example.org.bundle.pem cat /etc/pki/tls/certs/sub.class1.server.ca.pem &gt; /etc/pki/tls/certs/mail.example.org.ca-chain.pem #   chown -R root:mail /etc/pki/tls/private chmod 600 /etc/pki/tls/private/mail.example.org.key chmod 750 /etc/pki/tls/private chmod 640 /etc/pki/tls/private/* #        cat /etc/pki/tls/certs/sub.class1.server.ca.pem &gt;&gt; /etc/pki/tls/certs/ca-bundle.crt #    apache sed -i -e '/SSLCertificateFile \/etc\/pki/c\SSLCertificateFile /etc/pki/tls/certs/mail.example.org.crt' /etc/httpd/conf.d/ssl.conf sed -i -e '/SSLCertificateKeyFile \/etc\/pki/c\SSLCertificateKeyFile /etc/pki/tls/private/mail.example.org.key' /etc/httpd/conf.d/ssl.conf sed -i -e '/SSLCertificateChainFile \/etc\/pki/c\SSLCertificateChainFile /etc/pki/tls/certs/mail.example.org.ca-chain.pem' /etc/httpd/conf.d/ssl.conf #    HTTPS   cat &gt;&gt; /etc/httpd/conf/httpd.conf &lt;&lt; EOF &lt;VirtualHost _default_:80&gt; RewriteEngine On RewriteRule ^(.*)$ https://%{HTTP_HOST}\$1 [R=301,L] &lt;/VirtualHost&gt; EOF #    cyrus-imap sed -r -i \ -e 's|^tls_server_cert:.*|tls_server_cert: /etc/pki/tls/certs/mail.example.org.crt|g' \ -e 's|^tls_server_key:.*|tls_server_key: /etc/pki/tls/private/mail.example.org.key|g' \ -e 's|^tls_server_ca_file:.*|tls_server_ca_file: /etc/pki/tls/certs/mail.example.org.ca-chain.pem|g' \ /etc/imapd.conf #    Postfix postconf -e smtpd_tls_key_file=/etc/pki/tls/private/mail.example.org.key postconf -e smtpd_tls_cert_file=/etc/pki/tls/certs/mail.example.org.crt postconf -e smtpd_tls_CAfile=/etc/pki/tls/certs/mail.example.org.ca-chain.pem #  kolab-cli    api sed -r -i \ -e '/api_url/d' \ -e "s#\[kolab_wap\]#[kolab_wap]\napi_url = https://$(hostname -f)/kolab-webadmin/api#g" \ /etc/kolab/kolab.conf #  Roundcube sed -i -e 's/http:/https:/' /etc/roundcubemail/libkolab.inc.php sed -i -e 's/http:/https:/' /etc/roundcubemail/kolab_files.inc.php sed -i -e '/^?&gt;/d' /etc/roundcubemail/config.inc.php #  iRony     DAV- cat &gt;&gt; /etc/roundcubemail/config.inc.php &lt;&lt; EOF # caldav/webdav \$config['calendar_caldav_url'] = "https://%h/iRony/calendars/%u/%i"; \$config['kolab_addressbook_carddav_url'] = 'https://%h/iRony/addressbooks/%u/%i'; EOF #  Rouncdcube    HTTPS cat &gt;&gt; /etc/roundcubemail/config.inc.php &lt;&lt; EOF # Force https redirect for http requests \$config['force_https'] = true; EOF</span></span></code> </pre><br>  On this setting SSL can be considered complete. <br><br><h2>  DKIM and SPF </h2><br>  In order for Gmail and other mail servers not to spam our emails, it is recommended to set up SPF and DKIM records on our server. <br>  As a server part for DKIM, I suggest using OpenDKIM, for setting up which on Habr√© there was already a <a href="http://habrahabr.ru/post/151904/">wonderful article</a> <br><br><h2>  Configure spam delivery </h2><br>  By default, amavis simply removes all spam.  Personally, I think that it is not entirely correct and that spam should be delivered to users' personal spam folders. <br><br>  Actually there are two options for how this can be done: <br><br><h3>  Option with a separator </h3><br>  Cyrus-imap allows you to deliver mail immediately to the desired folder using a special separator in the email address. <br><br>  Set up amavis <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   ***spam***    sed -i '/^[^#]*$sa_spam_subject_tag/s/^/#/' /etc/amavisd/amavisd.conf #    spam+    sed -i '/^# $recipient_delimiter/s/^# //' /etc/amavisd/amavisd.conf #    sed -i 's/^\($final_spam_destiny.*= \).*/\1D_PASS;/' /etc/amavisd/amavisd.conf</span></span></code> </pre><br>  One more thing, so that mail could be delivered immediately to the spam folder, for this folder, the anyone user must have p permission (that is, put letters into this folder), otherwise everything will be dumped into INBOX. <br>  By the way, this concerns Shared Folders, if you want to receive letters to them, you should set similar permissions for them. <br><br>  Unfortunately, I didn‚Äôt find in cyrus-imap a regular way to determine secret rights for anyone. <br>  But I have this solution, we add this line to the crontab, and every 4 hours kolab will pull cyrus-imap so that each user in your domain will have ‚Äúanyone p‚Äù for the spam folder. <br><pre> <code class="bash hljs">0 4 * * * kolab sam user/%/Spam@example.org anyone p</code> </pre><br><br><h3>  Option with global sieve script </h3><br>  Set up amavis <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   ***spam***    sed -i '/^[^#]*$sa_spam_subject_tag/s/^/#/' /etc/amavisd/amavisd.conf #    sed -i 's/^\($final_spam_destiny.*= \).*/\1D_PASS;/' /etc/amavisd/amavisd.conf</span></span></code> </pre><br><br>  Create a global cyrus script: <br><pre> <code class="bash hljs">mkdir -p /var/lib/imap/sieve/global/ cat &gt; /var/lib/imap/sieve/global/default.script &lt;&lt; EOF require <span class="hljs-string"><span class="hljs-string">"fileinto"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> header :contains <span class="hljs-string"><span class="hljs-string">"X-Spam-Flag"</span></span> <span class="hljs-string"><span class="hljs-string">"YES"</span></span> { fileinto <span class="hljs-string"><span class="hljs-string">"Spam"</span></span>; } EOF</code> </pre><br>  Compile it: <br><pre> <code class="bash hljs">/usr/lib/cyrus-imapd/sievec /var/lib/imap/sieve/global/default.script /var/lib/imap/sieve/global/default.bc</code> </pre><br>  Now we will make a script that will connect it to all new users: <br><br><div class="spoiler">  <b class="spoiler_title">/bin/set_spam_sieve.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash imap_stor=/var/spool/imap/ sieve_stor=/var/lib/imap/sieve/ user_sieve_folders=($(find $imap_stor -name Spam -type d -print | sed 's|'$imap_stor'|'$sieve_stor'|' | sed 's|/user||' | sed 's|/Spam|/|')) for folder in ${user_sieve_folders[@]} ; do if [ -f $folder'USER.script' ] ; then cd $folder if [ "$(grep -c 'require.*include' 'USER.script')" -eq 0 ]; then echo 'Inject require "include"; '$folder'USER.script' sed -i '1i require "include";' 'USER.script' /usr/lib/cyrus-imapd/sievec 'USER.script' 'USER.bc' chown -R cyrus:mail $folder fi if [ "$(grep -c "include.*:global.*default" 'USER.script')" -eq 0 ]; then echo 'Inject include :global "default"; '$folder'USER.script' echo 'include :global "default";' &gt;&gt; $folder'USER.script' /usr/lib/cyrus-imapd/sievec 'USER.script' 'USER.bc' chown -R cyrus:mail $folder fi echo -e $folder'USER.script' else echo Creating new $folder'USER.script' mkdir -p $folder cd $folder echo -e 'require ["include"];\ninclude :global "default";' &gt; 'USER.script' /usr/lib/cyrus-imapd/sievec 'USER.script' 'USER.bc' ln -s 'USER.bc' 'defaultbc' chown -R cyrus:mail $folder fi done</span></span></code> </pre></div></div><br><br>  Do not forget to make it executable: <br><pre> <code class="bash hljs">chmod +x /bin/set_spam_sieve.sh</code> </pre><br><br>  Now add a task to cron that will run the set_spam_sieve.sh script every 4 hours: <br><pre> <code class="bash hljs">0 4 * * * /bin/set_spam_sieve.sh</code> </pre><br><br><h2>  Protection against brute force with Fail2ban </h2><br>  Fail2ban is a service that monitors the logs of other services for repeating incorrect login attempts too often. <br>  For example, if you try too often to log in with the wrong password from the same IP, then this IP gets banned for a few minutes. <br><br>  Install Fail2ban from official repositories <br><pre> <code class="bash hljs">yum -y install fail2ban</code> </pre><br><br>  Create filters for Fail2ban <br><pre> <code class="bash hljs">cat &gt; /etc/fail2ban/filter.d/kolab-cyrus.conf &lt;&lt; EOF [Definition] failregex = (imaps|pop3s)\[[0-9]*\]: badlogin: \[&lt;HOST&gt;\] (plain|PLAIN|login|plaintext) .* ignoreregex = EOF cat &gt; /etc/fail2ban/filter.d/kolab-postfix.conf &lt;&lt; EOF [Definition] failregex = postfix\/submission\/smtpd\[[0-9]*\]: warning: unknown\[&lt;HOST&gt;\]: SASL (PLAIN|LOGIN) authentication failed: authentication failure ignoreregex = EOF cat &gt; /etc/fail2ban/filter.d/kolab-roundcube.conf &lt;&lt; EOF [Definition] failregex = &lt;.*&gt; Failed login <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> .* from &lt;HOST&gt; <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> session .* ignoreregex = EOF cat &gt; /etc/fail2ban/filter.d/kolab-irony.conf &lt;&lt; EOF [Definition] failregex = &lt;.*&gt; Failed login <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> .* from &lt;HOST&gt; <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> session .* ignoreregex = EOF cat &gt; /etc/fail2ban/filter.d/kolab-chwala.conf &lt;&lt; EOF [Definition] failregex = &lt;.*&gt; Failed login <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> .* from &lt;HOST&gt; <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> session .* ignoreregex = EOF cat &gt; /etc/fail2ban/filter.d/kolab-syncroton.conf &lt;&lt; EOF [Definition] failregex = &lt;.*&gt; Failed login <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> .* from &lt;HOST&gt; <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> session .* ignoreregex = EOF</code> </pre><br>  Now let's set Fail2ban on them <br><pre> <code class="bash hljs">cat &gt;&gt; /etc/fail2ban/jail.conf &lt;&lt; EOF [kolab-cyrus] enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> filter = kolab-cyrus action = iptables-multiport[name=cyrus-imap,port=<span class="hljs-string"><span class="hljs-string">"143,993,110,995,4190"</span></span>] logpath = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/maillog maxretry = 5 [kolab-postfix] enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> filter = kolab-postfix action = iptables-multiport[name=kolab-postfix,port=<span class="hljs-string"><span class="hljs-string">"25,587"</span></span>] logpath = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/maillog maxretry = 5 [kolab-roundcube] enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> filter = kolab-roundcube action = iptables-multiport[name=kolab-roundcube, port=<span class="hljs-string"><span class="hljs-string">"http,https"</span></span>] logpath = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/roundcubemail/userlogins maxretry = 5 [kolab-irony] enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> filter = kolab-irony action = iptables-multiport[name=kolab-irony,port=<span class="hljs-string"><span class="hljs-string">"http,https"</span></span>] logpath = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/iRony/userlogins maxretry = 5 [kolab-chwala] enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> filter = kolab-chwala action = iptables-multiport[name=kolab-chwala,port=<span class="hljs-string"><span class="hljs-string">"http,https"</span></span>] logpath = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/chwala/userlogins maxretry = 5 [kolab-syncroton] enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> filter = kolab-syncroton action = iptables-multiport[name=kolab-syncroton,port=<span class="hljs-string"><span class="hljs-string">"http,https"</span></span>] logpath = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/kolab-syncroton/userlogins maxretry = 5 EOF</code> </pre><br><br><h2>  Configure Roundcube </h2><br><br><h4>  Default theme </h4><br>  As I wrote in the <a href="http://habrahabr.ru/post/260469/">previous article</a> , if you don‚Äôt like the default theme of Chameleon, you can easily replace it with Larry <br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">"s/\$config\['skin'\] = '.*';/\$config\['skin'\] = 'larry';/g"</span></span> /etc/roundcubemail/config.inc.php</code> </pre><br><br><h4>  Zipdownload plugin </h4><br>  Some users complain that there is no such opportunity to download all attachments to the letter immediately. <br>  So, this feature is in the zipdownload plugin for Roundcube <br><br>  Download the roundcube repository, and copy the plugin to the folder with our Roundcube plugins <br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/roundcube/roundcubemail/ --depth 1 /tmp/roundcube mv /tmp/roundcube/plugins/zipdownload/ /usr/share/roundcubemail/plugins/ rm -rf /tmp/roundcube/</code> </pre><br>  Now it only remains to activate it by adding it to the $ config ['plugins'] array in the /etc/roundcubemail/config.inc.php file. <br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">"/'contextmenu',/a \ 'zipdownload',"</span></span> /etc/roundcubemail/config.inc.php</code> </pre><br>  Another point: in the php_zlib module, in the versions supplied with distributions there is a bug, as a result of which, if the letter contains files with Cyrillic names, then when packed into a zip-file, their names turn into a cracked. <br>  To solve this, collect a new php_zlib: <br><pre> <code class="bash hljs">yum -y install php-devel zlib-devel pcre-devel gcc pecl install zip</code> </pre><br><br><h2>  Kolab ActiveSync Server </h2><br>  A couple more words about synchronization: the kolab-synroton service ( <a href="https://z-push.org/">z-push</a> fork) by default has 2 modes of operation: folder-mode and flat-mode. <br><br>  In the case of folder-mode, all folders that you mark in the sync settings in Roundcube are transferred as is. <br>  In the case of flat-mode, all the same folders are combined into one for mail, one for contacts, one for the calendar ... <br><br>  Apple and Windows technology works by default in folder-mode, but for Android, due to poor support for folder-mode (as developers say), flat-mode is enabled by default. <br>  If you wish, you can try and if your device still supports folder-mode, you can add its name to the $ ext_devices array in the /usr/share/kolab-syncroton/lib/kolab_sync_data.php file <br><br><h2>  Conclusion </h2><br>  At this point, the installation can be considered complete, once again we restart all the services and check whether they start automatically when the system starts. <br><br>  The mail client is available at the link: <a href="https://mail.example.org/webmail">mail.example.org/webmail</a> <br>  Admin: <a href="https://mail.example.org/kolab-webadmin">mail.example.org/kolab-webadmin</a> <br><br>  You can also set up an automatic redirect from <a href="https://mail.example.org/">mail.example.org</a> to <a href="https://mail.example.org/webmail">mail.example.org/webmail</a> <br><pre> <code class="bash hljs">sed -i -e <span class="hljs-string"><span class="hljs-string">'s/&lt;Directory \/&gt;/&lt;Directory \/&gt;\n RedirectMatch \^\/$ \/webmail\//g'</span></span> /etc/httpd/conf/httpd.conf</code> </pre><br><br>  <b>UPD:</b> Recently, <a href="https://habrahabr.ru/users/sattellite/" class="user_link">sattellite</a> addressed me with the problem that the sieve-rules do not work if the folder to which the letter should be delivered has a Cyrillic name. <br><br>  The solution turned out to be quite simple: <pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'sieve_utf8fileinto: 1'</span></span> &gt;&gt; /opt/kolab-crosslab.ru/etc/imapd.conf</code> </pre>  <i>thank!</i> <br><br><a name="docker"></a><h2>  Docker image </h2><br>  As a bonus, I attach my image of Kolab to Docker to the article, where everything described above and nginx in addition is automatically configured: <b><a href="https://github.com/kvaps/docker-kolab">GitHub</a> , <a href="https://registry.hub.docker.com/u/kvaps/kolab/">DockerHub</a></b> <br><br>  <b>Official site of the project: <a href="https://kolab.org/">kolab.org</a></b> </div><p>Source: <a href="https://habr.com/ru/post/260527/">https://habr.com/ru/post/260527/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260509/index.html">Access to shared atomic objects from a signal handler in C</a></li>
<li><a href="../260513/index.html">Gadgets are getting closer to the body. Five facts that information security experts want to warn you about</a></li>
<li><a href="../260515/index.html">How to evaluate the benefits of moving to the cloud</a></li>
<li><a href="../260519/index.html">Beat chart is the gamer's best friend.</a></li>
<li><a href="../260523/index.html">How our IaaS provider API works</a></li>
<li><a href="../260531/index.html">Passing Parameters in Reporting Services Reports</a></li>
<li><a href="../260533/index.html">Search for quadrangle documents on mobile devices</a></li>
<li><a href="../260535/index.html">Vulnerability in Samsung phones allows eavesdropping</a></li>
<li><a href="../260539/index.html">Web application development on Golang</a></li>
<li><a href="../260541/index.html">Zabbix Moscow Meetup in Badoo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>