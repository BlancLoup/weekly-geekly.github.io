<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Universal React + Express Applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article, we looked at the Next.js library, which allows you to develop universal applications out of the box. In the discussion of the art...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Universal React + Express Applications</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="https://habrahabr.ru/post/346960/">last article,</a> we looked at the Next.js library, which allows you to develop universal applications out of the box.  In the discussion of the article, significant shortcomings of this library were voiced.  Judging by the fact that <a href="https://github.com/zeit/next.js/issues/88">https://github.com/zeit/next.js/issues/88 has</a> been actively discussed since October 2016, there will be no solution to the problem in the near future. <br><br>  Therefore, I propose to get acquainted with the current state of the ‚Äúecosystem‚Äù React.js, because  today everything that Next.js does, and even more, can be done with the help of relatively simple tricks.  There are, of course, finished projects.  For example, I really like the <a href="https://github.com/erikras/react-redux-universal-hot-example">project</a> , which, unfortunately, is based on the irrelevant version of the router.  And very relevant, although not such a ‚Äúdeserved‚Äù <a href="https://github.com/wellyshen/react-cool-starter">project</a> . <br><br>  Using ready-made projects with a mass of poorly documented features is a bit scary, because  you do not know where you will stumble, and most importantly - how to develop the project.  Therefore, for those who want to understand the current state of the issue (and for themselves), I made a draft of the project with explanations.  It will not be some kind of my personal exclusive code.  Just a compilation of examples of documentation and a large number of articles. <br><a name="habracut"></a><br>  In the <a href="https://habrahabr.ru/post/346960/">last article</a> , the tasks that the universal application should solve were listed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1. Asynchronous preloading of data on the server (React.js, like most of these libraries, implements only synchronous rendering) and the formation of the state of the component. <br>  2. Server rendering component. <br>  3. Transfer the status of the component to the client. <br>  4. Recreation of the component on the client with the status transmitted from the server. <br>  5. "Attaching" the component (hydrarte (...)) to the markup received from the server (analog of render (...)). <br>  6. Code splitting into the optimal number of fragments (code splitting). <br><br>  And, of course, there should be no differences in the code of the server part and the client part of the application frontend.  The same component should work the same in both server and client rendering. <br><br>  Let's start with the routing.  In the React documentation for the implementation of universal routing, it is proposed to form routes based on a simple object.  For example: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.js module.exports = [ { path: '/', exact: true, // component: Home, componentName: 'home' }, { path: '/users', exact: true, // component: UsersList, componentName: 'components/usersList', }, { path: '/users/:id', exact: true, // component: User, componentName: 'components/user', }, ];</span></span></code> </pre> <br>  This route description form allows you to: <br><br>  1) create a server and client router based on a single source; <br>  2) on the server to preload data before creating an instance of the component; <br>  3) organize code splitting into the optimal number of fragments (code splitting). <br><br>  The server router code is very simple: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Switch, Route } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-router'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> routes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./routes'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Layout <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./components/layout'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> (data) =&gt; ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Layout</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Switch</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> { routes.map(props =&gt; { props.component = require('./' + props.componentName); if (props.component.default) { props.component = props.component.default; } return </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Route</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">props.path</span></span></span></span><span class="xml"><span class="hljs-tag"> } {</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">...props</span></span></span></span><span class="xml"><span class="hljs-tag">}/&gt;</span></span></span><span class="xml"> }) } </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Switch</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Layout</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> );</span></span></code> </pre><br>  The lack of the ability to use the full-fledged overall <code>&lt;Layout/&gt;</code> in Next.js was the starting point for writing this article. <br><br>  The client router code is a bit more complicated: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Router, Route, Switch} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-router'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> routes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./routes'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Loadable <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-loadable'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Layout <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./components/layout'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> (data) =&gt; <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;Layout&gt; &lt;Switch&gt; { routes.map(props =&gt; { props.component = Loadable({ loader: (</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span>(<span class="hljs-string"><span class="hljs-string">'./'</span></span> + props.componentName), <span class="hljs-attr"><span class="hljs-attr">loading</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">delay</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">timeout</span></span>: <span class="hljs-number"><span class="hljs-number">10000</span></span>, }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Route</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">props.path</span></span></span></span><span class="xml"><span class="hljs-tag"> } {</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">...props</span></span></span></span><span class="xml"><span class="hljs-tag">}/&gt;</span></span></span><span class="xml">; }) } </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Switch</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;<span class="hljs-regexp"><span class="hljs-regexp">/Layout&gt; );</span></span></code> </pre><br>  The most interesting part is the code snippet <code>() =&gt; import('./' + props.componentName)</code> .  The import () function gives the webpack command to implement code splitting.  If the page had the usual import or require () construction, then the webpack would include the component code in one resulting file.  And so the code will be loaded when switching to a route from a separate code fragment. <br><br>  Consider the main entry point of the front end of the client: <br><br><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { hydrate } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-dom'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Provider } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-redux'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BrowserRouter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-router-dom'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Layout <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./react/components/layout'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> AppRouter <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./react/clientRouter'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> routes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./react/routes'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> createStore <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./redux/store'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> preloadedState = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__PRELOADED_STATE__; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__PRELOADED_STATE__; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = createStore(preloadedState); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> component = hydrate( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Provider</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">store</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{store}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">BrowserRouter</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">AppRouter</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">BrowserRouter</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Provider</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>, <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'app'</span></span>) );</code> </pre><br>  Everything is fairly common and is described in the React documentation.  The state of the component from the server is recreated and the component ‚Äújoins‚Äù to the ready markup.  I draw your attention to the fact that not all libraries allow you to do such an operation in one line of code, as can be done in React.js. <br><br>  The same component in the server version: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { matchPath } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-router-dom'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> routes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./react/routes'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> AppRouter <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./react/serverRouter'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> stats <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../dist/stats.generated'</span></span>; ... app.use(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = createStore(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> promises = []; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> componentNames = []; routes.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> match = matchPath(req.path, route); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (match) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> component = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./react/'</span></span> + route.componentName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (component.default) { component = component.default; } componentNames.push(route.componentName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> component.getInitialProps == <span class="hljs-string"><span class="hljs-string">'function'</span></span>) { promises.push(component.getInitialProps({req, res, next, match, store})); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> match; }) <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all(promises).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> context = {data}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> html = ReactDOMServer.renderToString( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Provider</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">store</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{store}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">StaticRouter</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">location</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{req.url}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">context</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{context}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">AppRouter</span></span></span></span><span class="xml"><span class="hljs-tag">/&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">StaticRouter</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Provider</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context.url) { res.writeHead(<span class="hljs-number"><span class="hljs-number">301</span></span>, { <span class="hljs-attr"><span class="hljs-attr">Location</span></span>: context.url }) res.end() } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { res.write(<span class="hljs-string"><span class="hljs-string">` &lt;!doctype html&gt; &lt;script&gt; // WARNING: See the following for security issues around embedding JSON in HTML: // http://redux.js.org/docs/recipes/ServerRendering.html#security-considerations window.__PRELOADED_STATE__ = </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">JSON</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.stringify(store.getState()).replace(</span></span><span class="hljs-regexp"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-regexp">/&lt;/g</span></span></span></span><span class="hljs-string"><span class="hljs-subst">, </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'\\u003c'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string"> &lt;/script&gt; &lt;div id="app"&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${html}</span></span></span><span class="hljs-string">&lt;/div&gt; &lt;script src='</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${assets(stats.common)}</span></span></span><span class="hljs-string">'&gt;&lt;/script&gt; </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${componentNames.map(componentName =&gt; </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">`&lt;script src='</span></span></span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${assets(stats[componentName])}</span></span></span></span></span><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'&gt;&lt;/script&gt;`</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> )}</span></span></span><span class="hljs-string"> `</span></span>) res.end() } }) });</code> </pre><br>  The most significant part is the determination by route of the necessary component: <br><br><pre> <code class="javascript hljs"> routes.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> match = matchPath(req.path, route); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (match) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> component = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./react/'</span></span> + route.componentName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (component.default) { component = component.default; } componentNames.push(route.componentName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> component.getInitialProps == <span class="hljs-string"><span class="hljs-string">'function'</span></span>) { promises.push(component.getInitialProps({req, res, next, match, store})); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> match; })</code> </pre><br>  After we find a component, we call its asynchronous static method <code>component.getInitialProps({req, res, next, match, store})</code> .  Static - because a component instance on the server has not yet been created.  This method is named by analogy with Next.js.  Here is how this method might look like in a component: <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Home</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> getInitialProps({ req, match, store, dispatch }) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> userAgent = req ? req.headers[<span class="hljs-string"><span class="hljs-string">'user-agent'</span></span>] : navigator.userAgent <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> action = userActions.login({<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'John'</span></span>, userAgent}); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (req) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> store.dispatch(action); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dispatch(action); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre><br>  To store the state of the object, redux is used, which in this case greatly facilitates access to the state on the server Without redux, this would be not only difficult but very difficult. <br><br>  For ease of development, you need to ensure that the client and server code of the components are compiled on the fly and the browser is updated.  I plan to talk about this as well as the webpack configurations for the project in the next article. <br>  <a href="https://github.com/apapacy/uni-react">https://github.com/apapacy/uni-react</a> <br><br>  apapacy@gmail.com <br>  February 14, 2018 </div><p>Source: <a href="https://habr.com/ru/post/349064/">https://habr.com/ru/post/349064/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349054/index.html">LL (*) parser using Rust macro</a></li>
<li><a href="../349056/index.html">Open lesson "UML Diagrams"</a></li>
<li><a href="../349058/index.html">Remember everything</a></li>
<li><a href="../349060/index.html">Flask Mega-Tutorial, Part XI: Bare Cosmetics (Edition 2018)</a></li>
<li><a href="../349062/index.html">AgileDays'18: content - all over the head</a></li>
<li><a href="../349066/index.html">Mobile devices from the inside. Unlocking the tablet loader</a></li>
<li><a href="../349068/index.html">From satellite images to graphs (the competition of the SpaceNet Road Detector) - hit the top 10 and code (translation)</a></li>
<li><a href="../349072/index.html">Dynamic Systems Modeling: Introduction</a></li>
<li><a href="../349076/index.html">We write macros for TODO and FIXME in Sublime Text, or how a bit of code saves a lot of time</a></li>
<li><a href="../349078/index.html">Should I be afraid of class imbalances?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>