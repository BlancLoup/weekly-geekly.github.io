<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android application integration with fiscal printer and card reader</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Today we want to share our experience with peripheral devices on the Android platform. 
 Imagine ... 


 You have come to the ski rental for sk...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android application integration with fiscal printer and card reader</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello!  Today we want to share our experience with peripheral devices on the Android platform. </p><br><h4 id="predstavim-sebe">  Imagine ... </h4><br><p>  You have come to the ski rental for skis and you need to pay with a card and get an offer agreement for the provision of services and a check.  It would seem, what could be easier? <br><img src="https://habrastorage.org/files/3e6/951/c40/3e6951c408594f068237096698dc6e6c.png" alt="image"></p><br><a name="habracut"></a><br><ol><li>  We do it once.  We chose equipment (skis, poles, boots, a helmet and a mask). </li><li>  The employee cleverly pulls out a smartphone and scans their barcodes on the inventory. </li><li>  Immediately gets the reader of plastic cards, withdraws funds and freezes the deposit. </li><li>  But the check and the contract-offer, which printed the printer attached to the belt. </li></ol><br><p><img src="https://habrastorage.org/files/47d/149/841/47d149841fd84c8ba113aa209025011d.png" alt="image"></p><br><h4 id="eh-mechty-mechty">  Oh, dreams, dreams ... </h4><br><p>  In reality, everything is much longer, and you yourself know very well why. </p><br><p>  In one place you choose the inventory, then go to the cashier, where all the racks from all rental racks flow, you pay for it, return to the distributor, get the inventory from him and are finally ready to meet the mountain! </p><br><p><img src="https://habrastorage.org/files/a9a/f3c/692/a9af3c692e8c4375b66a355ac296b94a.png" alt="image"><br>  And during peak hours, this story inevitably turns into hell. </p><br><ol><li>  We defended a long queue to the distributor, chose inventory. </li><li>  Now we will stand in the general queue at the cashier. </li><li>  Then go back to the distributor for legally paid.  And again, stand in line.  After all, you only ask (pick)?  But who cares. </li></ol><br><p>  This is how the speed of service from one and a half minutes stretched out to all 20, and at this time someone already cuts the morning velvet of the snow slope! </p><br><h3>  Who is to blame and what to do? </h3><br><p>  Why not to equip each rack cashier?  Yes, because such a problem is not constant.  Peak loads occur regularly, but by and large not so often - morning weekends and holidays, and this is only if the weather is catal.  Therefore, to invest in cash equipment from the point of view of the owners, the costs are clearly not super justified.  This task is solved by the appearance of an additional mobile employee who once, twice, and helped the queue to dissolve. </p><br><p>  In a case with a ski, it would be enough to buy a boxed solution for integrating a smartphone with a cash printer and a card reader, which is enough on the market.  They are used by couriers who deliver orders and girls who sell aeroexpress tickets. </p><br><p>  We could also enter the amount and get paid, <strong>but we do not have rental equipment!</strong> </p><br><p>  In the customer's system with which we worked, the letter of the law required the issuance of the client not just a check for a certain amount, but also a receipt with a detailed description of the service and a unique number assigned to it.  That is, we have to make a payment, register it on the server, get a unique transaction number, and then print the receipt, which displays this number, a full description of the service and a barcode with the coded information. </p><br><p>  The task is set, we proceed to the implementation. </p><br><h2>  Implementation </h2><br><h3>  1. Choose a printer and card reader </h3><br><p>  To begin with, we decided that we need to use the complex with a smartphone, which allows the user to configure the service parameters and interact with the server.  The question of choosing smartphones for the system was solved by itself.  The customer chose "workhorses" - smartphones based on Android.  They were Huawei Honor 5C.  Convenient inexpensive devices from the Chinese manufacturer.  The main thing is that Bluetooth is and works.  But then it was necessary to solve the problem more difficult.  So that all operations with the sale of services were carried out legally, we needed a fiscal registrar.  This is a printer with a memory, which records the history of operations on sales. </p><br><p>  Mobile fiscal printers (and we remember that our solution must be mobile!) Are produced by a number of Russian companies Atol, Incotex, Accountsmash, Shtrikh-M.  We studied their proposals, but in our solution the printer had to print on a wide ribbon (3 ‚Äùinstead of 2‚Äù), since we needed to place on the check detailed data about the service provided.  The wide ribbon was found only in one of the mobile barcode printer <a href="http://www.shtrih-m.ru/catalog/programmno-tekhnicheskie-kompleksy-fr-i-aspd/shtrikh-mobile-ptk/">MTRILE-PTK</a> included in the state register. </p><br><p>  We need to take not only cash payments from customers, but also to debit money from the card.  So, we need a card reader and provider of such a solution in order to make payments and take into account all the funds spent in this way.  And there are enough such solutions in our market.  They differ, perhaps, in the types of reader models, the percentage of the commission for acquiring, and ... integrations with fiscal printers!  It was then that we came <a href="http://iboxmpos.com/russia/ru">across a</a> solution from <a href="http://iboxmpos.com/russia/ru">iBox Pro</a> , using a chip-n-pin model card reader with a keyboard, and, fortunately, integrated with the SHTRIH-MOBILE-PTK mobile fiscal recorder. </p><br><p>  The company provided us with test devices, and we set to work ... </p><br><h3>  2. We withdraw money </h3><br><p>  With the iBox Pro payment system, the mobile application can be integrated in a simple way (via an intent-call) and in a complicated way (through the SDK).  We have chosen a difficult path, but not at all because we like to overcome difficulties.  And for another important reason.  There will need a lyrical digression. </p><br><p>  In the case of an intent call, the algorithm is as follows: <br><img src="https://habrastorage.org/files/6f8/efc/ff5/6f8efcff5f5847e2bb99e61a3c1dd3f9.png" alt="image"><br>  Our algorithm looks different.  We can not just take, drive in the amount for the service and print the check.  We need to send data to the server, get the cost of the service, then receive payment from the client, and then contact the server and get a unique code and then be sure to reflect this code in the check. </p><br><p>  Therefore, we have developed such an algorithm: <br><img src="https://habrastorage.org/files/eac/75d/e13/eac75de1311f49b489cb2cb9bebbf4d0.png" alt="image"><br>  As a result, using the iBox SDK (the latest version of their evolving SDK can be downloaded from <a href="">GitHUB</a> ) we have embedded calls to the iBox in our mobile application.  With the bonus, we got a more user-friendly single interface - at the payment stage, a person does not have to switch to a third-party iBox interface, all processes occur only within our mobile application. </p><br><div class="spoiler">  <b class="spoiler_title">An example of working with iBox SDK</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//     PaymentController-    : //   . PaymentController.getInstance().setSingleStepEMV(true); //           PaymentController.getInstance().setCredentials(loginInfo.userName, loginInfo.userPassword); //       , //      . //     PaymentCotroller-. ReaderBluetoothInfo readerBluetoothInfo = settingsService.getReaderBluetoothInfo(); List&lt;BluetoothDevice&gt; devices = PaymentController.getInstance().getBluetoothDevices(getView().getContext()); for (int i = 0; i &lt; devices.size(); ++i) { if (devices.get(i).getAddress().equals(readerBluetoothInfo.readerAddres) &amp;&amp; devices.get(i).getName().equals(readerBluetoothInfo.readerName)) { PaymentController.getInstance().setReaderType( getView().getContext(), PaymentController.ReaderType.WISEPAD, i, null); } } } ... PaymentDialog paymentDialog = new PaymentDialog(); //    : //    ,          ibox.     ,    . PaymentController.getInstance().setPaymentControllerListener(paymentDialog); PaymentController.getInstance().enable(); //     PaymentController.getInstance().startPayment(getContext(), mPaymentContext); ... //    PaymentController    . public void onReaderEvent(PaymentController.ReaderEvent event) { switch (event) { case CONNECTED : case START_INIT : lblState.setText(R.string.reader_state_init); break; case DISCONNECTED : stopProgress(); lblState.setText(R.string.reader_state_disconnected); break; case SWIPE_CARD : case TRANSACTION_STARTED : startProgress(); break; ... case EJECT_CARD : stopProgress(); lblState.setText(R.string.reader_state_eject); break; case BAD_SWIPE : Toast.makeText(mActivity, R.string.reader_bad_swipe, Toast.LENGTH_LONG).show(); break; case LOW_BATTERY : Toast.makeText(mActivity, R.string.reader_low_battery, Toast.LENGTH_LONG).show(); break; default : break; } }</span></span></code> </pre> </div></div><br><h3>  3. We print documents </h3><br><p>  After fixing the fact of sale, it is necessary to issue a check to the client, and sometimes additional documents - an offer contract, order form or letter of guarantee.  The question ‚Äúwhat are we going to print on?‚Äù - if the user has a mobile printer on his belt - let him print on it.  Therefore, we forced the printer to print other documents besides fiscal checks. </p><br><p>  You can work with the printer through the official <a href="https://github.com/shtrih-m/javapos_shtrih">library from Shtrikh-M</a> with the documentation they created for the convenience of working with <a href="http://www.jpos.org/">JPOS</a> , as well as using a <a href="https://github.com/ilya-t/shtrih-m_printer_controller">small example library</a> from enthusiasts. </p><br><h4>  Careful, raking forest! </h4><br><p>  When printing documents on a mobile printer, we are faced with two cases where the matrix failed: </p><br><ul><li><p>  In combination with some smartphones that we used for testing, the printer‚Äôs speed dropped dramatically.  It was very disturbing to us, because according to the standard of service, the customer required us to meet 1.5 minutes with the whole process from the registration of the service to the issuance of the check.  Fortunately, the target device printed via Bluetooth without problems, and we decided to leave this mystery unsolved. </p><br></li><li>  During combat testing, exactly the same fiscal printers behaved differently: due to internal settings, some of them, when printing a barcode, shifted the barcode on the document to the right, cutting off some of the information.  It was possible to solve only by applying the magic workaround :) - reduced some elements of the check and barcode without loss of quality of reading by the scanner. </li></ul><br><div class="spoiler">  <b class="spoiler_title">As a result, this is the barcode print code, if anyone is interested.</b> <div class="spoiler_text"><pre> <code class="java hljs">ShtrihFiscalPrinter printer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ShtrihFiscalPrinter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FiscalPrinter()); PrinterBarcode printerBarcode = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PrinterBarcode(); printerBarcode.setText(boardingPass.barcodeText); <span class="hljs-comment"><span class="hljs-comment">//,   . printerBarcode.setLabel(""); //  ,     . //    - .   . printerBarcode.setBarWidth(2); // 2 - small width printerBarcode.setType(PrinterBarcode.SM_BARCODE_PDF417); Map&lt;EncodeHintType, Object&gt; parameters = new HashMap&lt;&gt;(); //                 . //       . parameters.put(EncodeHintType.PDF417_DIMENSIONS, new Dimensions(5, 5, 2, 60)); printerBarcode.addParameter(parameters); printer.printBarcode(printerBarcode);</span></span></code> </pre></div></div><br><ul><li>  Another weird problem surfaced when working with iBox.  When working with our smartphones, the device could go into sleep mode and did not leave it.  It manifested itself only with Huawei and was cured by installing the latest firmware version of the card reader. </li></ul><br><h3>  4. We print a fiscal receipt </h3><br><p>  By default, the fiscal printer issues a receipt from the payment system with a minimum of information.  It did not suit us.  First, we needed a beautifully designed check that would look similar to checks approved in other customer systems.  Secondly, we needed to combine the receipt with a receipt for the service and detailed information about it.  Total - with the help of the printer SDK, we made a beautiful check-receipt document.  And then, long and painfully, one after another, the checks were printed on tests, changing the parameters, until finally the real piece of paper did not look the same on all printers and as needed. </p><br><div class="spoiler">  <b class="spoiler_title">Here is the code to print the fiscal receipt:</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printTicket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PrinterInfo printerInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isRefund, String agentId)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ ShtrihFiscalPrinter printer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ShtrihFiscalPrinter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FiscalPrinter()); <span class="hljs-comment"><span class="hljs-comment">//      final String NO_TAX = "0"; final String TEN_PERCENT_TAX = "1000"; printer.setVatValue(1, NO_TAX); printer.setVatValue(2, TEN_PERCENT_TAX); // 10% printer.setVatValue(3, NO_TAX); printer.setVatValue(4, NO_TAX); printer.setVatTable(); printer.setHeaderLine(1, StringTools.appendStrings("", "*", LINE_LENGTH), false); printer.setHeaderLine(2, getHeader(" \" \""), false); printer.setHeaderLine(3, getHeader(" "), false); printer.setHeaderLine(4, getHeader(" , \n "), false); printer.setHeaderLine(5, getHeader("+7(XXX)XXX-XX-XX"), false); printer.setHeaderLine(6, StringTools.appendStrings("", "*", LINE_LENGTH), false); if (isRefund) { printer.setFiscalReceiptType(jpos.FiscalPrinterConst.FPTR_RT_REFUND); } else { printer.setFiscalReceiptType(jpos.FiscalPrinterConst.FPTR_RT_SALES); } printer.beginFiscalReceipt(true); printLine(); double priceSum = 0; //PrinterEmdData      . for (PrinterEmdData printerEmdData : printerInfo.getPrinterEmdDatas()) { String description = getDescription(printerEmdData, printerInfo.isCashierFormat()); int tax = 0; final int TEN_PERCENT_NDS = 10; final int SECOND_TAX_SLOT = 2; if (printerEmdData.taxValue == TEN_PERCENT_TAX) { tax = SECOND_TAX_SLOT; //  ,     10% (     2-   ) } priceSum += printerEmdData.price; if (isRefund) { printer.printRecItemRefund(description, 0, 0, tax, (long) printerEmdData.price, ""); } else { printer.printRecItem(description, 0, 0, tax, (long) printerEmdData.price, ""); } } printLine(); if (printerInfo.isCard()) { printer.printRecTotal((long) priceSum, (long) priceSum, "1"); } else { long cashIn = (long) priceSum; if (printerInfo.getCashIn() &gt; 0) { cashIn = (long) printerInfo.getCashIn(); } printer.printRecTotal((long) priceSum, cashIn, ""); } printer.endFiscalReceipt(true); }</span></span></code> </pre> </div></div><br><h3>  5. We provide fault tolerance system </h3><br><p>  Of course, it is not enough just to make integration into the system; it is important to make this system reliable.  For us it was important to provide mechanisms for rolling back from any stage.  For example, the payment service confirmed the withdrawal to the application, the application requested a unique service number from the service reservation service, and then the connection with the server was lost.  And at this stage you need to make a Fallback mechanism that will allow you to repeat the request to the server or return the money to the card. </p><br><p>  There were many variants of such mistakes: when withdrawing money, they pulled out the card early, entered the pin-code incorrectly, the cash register tape ran out while trying to print the check, the printer was dead and so on.  The boundaries of required resiliency at each stage were determined during test sessions with the participation of experienced tellers.  As a result, the necessary Fallback mechanisms were developed for each error. <br></p><br><h4>  Possible errors in the process of receiving money and printing a check </h4><br><p><img src="https://habrastorage.org/files/3a2/b54/7a6/3a2b547a64a049969b021e627903a9e4.png" alt="image"></p><br><h2>  Total: </h2><br><ul><li>  Made a fail-safe integration smartphone + card reader + fiscal printer. </li><li>  We tested it in combat conditions and re-established all the Fallback mechanisms. </li><li>  The solution is implemented, it works and pleases the users of the application and their clients. </li></ul><br><p>  We were convinced by our own example that it is possible to solve the problem of accepting payments using mobile devices, even if on the server side it is necessary to keep strict records of each operation.  Maybe, after reading the article, someone will see an opportunity to save people from losing time in queues and in some other area. </p><br><p>  Give more comfort to customers that we can be with you! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/325950/">https://habr.com/ru/post/325950/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325936/index.html">Development for Sailfish OS: Testing QML code dependent on C ++ in Sailfish OS</a></li>
<li><a href="../325938/index.html">How to survive the scaling and synchronize all the same between data centers</a></li>
<li><a href="../325942/index.html">Real-time Web application for simple devices</a></li>
<li><a href="../325944/index.html">We invite you to the Imagine Cup: April 15, 2017 will be the Russian final of the competition</a></li>
<li><a href="../325946/index.html">The evolution of CRM-systems</a></li>
<li><a href="../325952/index.html">These mysterious capacitors</a></li>
<li><a href="../325954/index.html">.NET Managed + C unmanaged: what is the price?</a></li>
<li><a href="../325956/index.html">From Root CA to User Authorization in nginx + apache. Part 1. Create a Root & Intermediate Certificate Authority</a></li>
<li><a href="../325958/index.html">It is no exaggeration to say that this is a hyperbole</a></li>
<li><a href="../325960/index.html">Free plugins, tools and services for the development of a game on a unit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>